#include "stdafx.h"
#include "FMServicePaidSummarybyDept_2024.h"
#include "HMSMainFrame.h"
#include "SearchPopup.h"
#include "StringToken.h"
/*static void _OnYearChangeFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnYearChange();
} */
/*static void _OnYearSetfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnYearSetfocus();} */ 
/*static void _OnYearKillfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnYearKillfocus();
} */
static int _OnYearCheckValueFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnYearCheckValue();
} 
static void _OnReportPeriodSelectChangeFnc(CWnd *pWnd, int nOldItemSel, int nNewItemSel){
	((CFMServicePaidSummaryByDept_2024* )pWnd)->OnReportPeriodSelectChange(nOldItemSel, nNewItemSel);
} 
static void _OnReportPeriodSelendokFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnReportPeriodSelendok();
}
/*static void _OnReportPeriodSetfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnReportPeriodKillfocus();
}*/
/*static void _OnReportPeriodKillfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnReportPeriodKillfocus();
}*/
static long _OnReportPeriodLoadDataFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnReportPeriodLoadData();
}
/*static void _OnReportPeriodAddNewFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnReportPeriodAddNew();
}*/
/*static void _OnFromDateChangeFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnFromDateChange();
} */
/*static void _OnFromDateSetfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnFromDateSetfocus();} */ 
/*static void _OnFromDateKillfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnFromDateKillfocus();
} */
static int _OnFromDateCheckValueFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnFromDateCheckValue();
} 
/*static void _OnToDateChangeFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnToDateChange();
} */
/*static void _OnToDateSetfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnToDateSetfocus();} */ 
/*static void _OnToDateKillfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnToDateKillfocus();
} */
static int _OnToDateCheckValueFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnToDateCheckValue();
} 
static void _OnClerkSelectChangeFnc(CWnd *pWnd, int nOldItemSel, int nNewItemSel){
	((CFMServicePaidSummaryByDept_2024* )pWnd)->OnClerkSelectChange(nOldItemSel, nNewItemSel);
} 
static void _OnClerkSelendokFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnClerkSelendok();
}
/*static void _OnClerkSetfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnClerkKillfocus();
}*/
/*static void _OnClerkKillfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnClerkKillfocus();
}*/
static long _OnClerkLoadDataFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnClerkLoadData();
}
/*static void _OnClerkAddNewFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnClerkAddNew();
}*/
static void _OnStatusSelectChangeFnc(CWnd *pWnd, int nOldItemSel, int nNewItemSel){
	((CFMServicePaidSummaryByDept_2024* )pWnd)->OnStatusSelectChange(nOldItemSel, nNewItemSel);
} 
static void _OnStatusSelendokFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnStatusSelendok();
}
/*static void _OnStatusSetfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnStatusKillfocus();
}*/
/*static void _OnStatusKillfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnStatusKillfocus();
}*/
static long _OnStatusLoadDataFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnStatusLoadData();
}
/*static void _OnStatusAddNewFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnStatusAddNew();
}*/
static void _OnOrderBySelectChangeFnc(CWnd *pWnd, int nOldItemSel, int nNewItemSel){
	((CFMServicePaidSummaryByDept_2024* )pWnd)->OnOrderBySelectChange(nOldItemSel, nNewItemSel);
} 
static void _OnOrderBySelendokFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnOrderBySelendok();
}
/*static void _OnOrderBySetfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnOrderByKillfocus();
}*/
/*static void _OnOrderByKillfocusFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnOrderByKillfocus();
}*/
static long _OnOrderByLoadDataFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnOrderByLoadData();
}
/*static void _OnOrderByAddNewFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnOrderByAddNew();
}*/
static long _OnhtttLoadDataFnc(CWnd *pWnd)
{
	return ((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnHtttLoadData();
}

static void _OnhtttSelendokFnc(CWnd *pWnd)
{
	((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnhtttSelendok();
}

static void _OnWithoutGeneralSelectFnc(CWnd *pWnd){
	 ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnWithoutGeneralSelect();
}
static long _OnListLoadDataFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListLoadData();
} 
static void _OnListDblClickFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListDblClick();
} 
static void _OnListSelectChangeFnc(CWnd *pWnd, int nOldItem, int nNewItem){
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListSelectChange(nOldItem, nNewItem);
} 
static int _OnListDeleteItemFnc(CWnd *pWnd){
	 return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListDeleteItem();
} 
static void _OnMarkAllSelectFnc(CWnd *pWnd){
	CFMServicePaidSummaryByDept_2024 *pVw = (CFMServicePaidSummaryByDept_2024 *)pWnd;
	pVw->OnMarkAllSelect();
} 
static void _OnUnMarkSelectFnc(CWnd *pWnd){
	CFMServicePaidSummaryByDept_2024 *pVw = (CFMServicePaidSummaryByDept_2024 *)pWnd;
	pVw->OnUnMarkSelect();
} 
static void _OnPrintSelectFnc(CWnd *pWnd){
	CFMServicePaidSummaryByDept_2024 *pVw = (CFMServicePaidSummaryByDept_2024 *)pWnd;
	pVw->OnPrintSelect();
} 
static void _OnExportSelectFnc(CWnd *pWnd){
	CFMServicePaidSummaryByDept_2024 *pVw = (CFMServicePaidSummaryByDept_2024 *)pWnd;
	pVw->OnExportSelect();
} 
static void _OnInpatientSelectFnc(CWnd *pWnd){
	  ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnInpatientSelect();
}
static void _OnOutpatientSelectFnc(CWnd *pWnd){
	  ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnOutpatientSelect();
}
static void _OnDepositSelectFnc(CWnd *pWnd){
	  ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnDepositSelect();
}
static void _OnAllSelectFnc(CWnd *pWnd){
	  ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnAllSelect();
}
static int _OnAddFMInsuranceReceiptSummaryFnc(CWnd *pWnd){
	 return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnAddFMInsuranceReceiptSummary();
} 
static int _OnEditFMInsuranceReceiptSummaryFnc(CWnd *pWnd){
	 return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnEditFMInsuranceReceiptSummary();
} 
static int _OnDeleteFMInsuranceReceiptSummaryFnc(CWnd *pWnd){
	 return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnDeleteFMInsuranceReceiptSummary();
} 
static int _OnSaveFMInsuranceReceiptSummaryFnc(CWnd *pWnd){
	 return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnSaveFMInsuranceReceiptSummary();
} 
static int _OnCancelFMInsuranceReceiptSummaryFnc(CWnd *pWnd){
	 return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnCancelFMInsuranceReceiptSummary();
}
static int _OnListSearchItemFnc(CWnd *pWnd){
	 ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListSearchItem();
	 return 0;
} 
static int _OnListCheckAllPTTYCFnc(CWnd *pWnd)
{
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllPTTYC();
	return 0;
}

static int _OnListCheckAllDVPTTYCFnc(CWnd *pWnd)
{
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllDVPTTYC();
	return 0;
}

static int _OnListCheckAllTYCFnc(CWnd *pWnd)
{
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllTYC();
	return 0;
}
static void _OnSODSelectFnc(CWnd *pWnd){
	  ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnSODSelect();
}
static void _OnCreateDataSelectFnc(CWnd *pWnd)
{
	CFMServicePaidSummaryByDept_2024 *pVw = (CFMServicePaidSummaryByDept_2024 *)pWnd;
	pVw->OnCreateDataSelect();
}
static void _OnATMSelectFnc(CWnd *pWnd)
{
	 ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnATMSelect();
}
static void _OnAllZoneSelectFnc(CWnd *pWnd)
{
	 ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnAllZoneSelect();
}
static void _OnABZoneSelectFnc(CWnd *pWnd)
{
	 ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnABZoneSelect();
}
static int _OnListCheckAllInvoiceFnc(CWnd *pWnd)
{
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllInvoice();
	return 0;
}
static int _OnListCheckAllRefundFnc(CWnd *pWnd)
{
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllRefund();
	return 0;
}
static void _OnBEDSelectFnc(CWnd *pWnd){
	 ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnBEDSelect();
}

static int _OnListCheckAllInvoiceTYCFnc(CWnd *pWnd)
{
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllInvoiceTYC();
	return 0;
}
static int _OnListCheckAllRefundTYCFnc(CWnd *pWnd)
{
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllRefundTYC();
	return 0;
}

static int _OnListCheckAllInvoiceBHTYCFnc(CWnd *pWnd)
{
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllInvoiceBHTYC();
	return 0;
}
static int _OnListCheckAllRefundBHTYCFnc(CWnd *pWnd)
{
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllRefundBHTYC();
	return 0;
}

static void _OnCLCzoneSelectFnc(CWnd *pWnd)
{
	 ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnCLCzoneSelect();
}

static void _OnQrOnlineSelectFnc(CWnd *pWnd){
	 ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnQrOnlineSelect();
}


static int _OnDeptListCheckAllFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnDeptListCheckAll();
}
static int _OnDeptListUnCheckAllFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnDeptListUnCheckAll();
}

static int _OnDeptListCheckAllTYCFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnDeptListCheckAllTYC();
}

static int _OnDeptListCheckAllDVFnc(CWnd *pWnd){
	return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnDeptListCheckAllDV();
}

static long _OnDeptListLoadDataFnc(CWnd *pWnd)
{
	return ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnDeptListLoadData();
}

static int _OnListUnCheckQRFnc(CWnd *pWnd)
{
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListUnCheckQR();
	return 0;
}

static void _OnAllObjSelectFnc(CWnd *pWnd){
	  ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnAllObjSelect();
}
static void _OnInsuranceSelectFnc(CWnd *pWnd){
	  ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnInsuranceSelect();
}
static void _OnServiceSelectFnc(CWnd *pWnd){
	  ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnServiceSelect();
}
static void _OnOtherObjSelectFnc(CWnd *pWnd){
	  ((CFMServicePaidSummaryByDept_2024*)pWnd)->OnOtherObjSelect();
}

static long _OnPhanloaiLoadDataFnc(CWnd *pWnd)
{
	return ((CFMServicePaidSummaryByDept_2024 *)pWnd)->OnPhanloaiLoadData();
}

static int _OnListCheckAllPTTYCTYCFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllPTTYCTYC();
	return 0;
}

static int _OnListCheckAllTTTMFnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllTTTM();
	return 0;
}

static int _OnListCheckAllKBA16Fnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListCheckAllKBA16();
	return 0;
}

static int _OnListUnCheckAllTYC_PTTYC_KBA16Fnc(CWnd *pWnd){
	((CFMServicePaidSummaryByDept_2024*)pWnd)->OnListUnCheckAllTYC_PTTYC_KBA16();
	return 0;
}



CFMServicePaidSummaryByDept_2024::CFMServicePaidSummaryByDept_2024(CWnd *pParent)
{
	m_nDlgWidth = 435;
	m_nDlgHeight = 570;
	SetDefaultValues();
}
CFMServicePaidSummaryByDept_2024::~CFMServicePaidSummaryByDept_2024()
{

}
void CFMServicePaidSummaryByDept_2024::OnCreateComponents()
{
	m_wndReportCondition.Create(this, _T("Report Condition"), 5, 5, 480, 535);
	m_wndYearLabel.Create(this, _T("Year"), 10, 30, 90, 55);
	m_wndYear.Create(this,95, 30, 225, 55); 
	m_wndReportPeriodLabel.Create(this, _T("Report Period"), 240, 30, 331, 55);
	m_wndReportPeriod.Create(this,346, 30, 476, 55); 
	m_wndFromDateLabel.Create(this, _T("From Date"), 10, 60, 90, 85);
	m_wndFromDate.Create(this,95, 60, 225, 85); 
	m_wndToDate.Create(this,346, 60, 476, 85); 
	m_wndToDateLabel.Create(this, _T("To Date"), 240, 60, 331, 85);
	m_wndClerkLabel.Create(this, _T("Clerk"), 10, 90, 90, 115);
	m_wndClerk.Create(this,95, 90, 225, 115); 
	m_wndOrderByLabel.Create(this, _T("Order By"), 10, 120, 90, 145);
	m_wndOrderBy.Create(this,95, 119, 225, 144); 
	m_wndHtttLabel.Create(this, _T("HTTT***"), 241, 120, 332, 145);
	m_wndhttt.Create(this,346, 120, 476, 145); 
	m_wndStatusLabel.Create(this, _T("Status"), 240, 90, 331, 115);
	m_wndStatus.Create(this,346, 90, 476, 115); 
	m_wndList.Create(this,10, 182, 476, 325); 
	m_wndWithoutGeneral.Create(this, _T("Without General"), 0, 0, 0, 0);
	m_wndMarkAll.Create(this, _T("Mark All"), 5, 540, 85, 565);
	m_wndUnMark.Create(this, _T("UnMark"), 90, 540, 170, 565);
	m_wndPrint.Create(this, _T("&Print"), 232, 540, 312, 565);
	m_wndExport.Create(this, _T("Export XLS"), 317, 540, 397, 565);

	m_wndInpatient.Create(this, _T("Inpatient"), 0, 0, 0, 0);
	m_wndOutpatient.Create(this, _T("Outpatient"), 0, 0, 0, 0);
	m_wndDeposit.Create(this, _T("Deposit"), 0, 0, 0, 0);
	m_wndAll.Create(this, _T("All"), 0, 0, 0, 0);

	m_wndSOD.Create(this, _T("SOD"), 300, 505, 373, 530);
	m_wndCreateData.Create(this, _T("Create Data"), 401, 540, 481, 565);	
	m_wndBED.Create(this, _T("BED>0"), 379, 505, 476, 530);	
	m_wndATM.Create(this, _T("ATM Card"), 8, 150, 96, 175);
	m_wndABZone.Create(this, _T("AB Zone"), 101, 150, 189, 175);
	m_wndAllZone.Create(this, _T("All Zone"), 196, 150, 284, 175);
	m_wndCLCzone.Create(this, _T("CLC Zone"), 290, 150, 378, 175);
	m_wndQrOnline.Create(this, _T("QrOnline"), 384, 150, 476, 175);
	m_wndDeptList.Create(this,10, 330, 476, 473); 
	m_wndAllObj.Create(this, _T("Tất cả"), 10, 474, 110, 499);
	m_wndInsurance.Create(this, _T("Bảo hiểm"), 116, 474, 216, 499);
	m_wndService.Create(this, _T("Dịch vụ"), 222, 474, 325, 499);
	m_wndOtherObj.Create(this, _T("Khác"), 331, 474, 434, 499);
	m_wndPhanloaiLabel.Create(this, _T("Phân loại"), 10, 505, 110, 530);
	m_wndPhanloai.Create(this,115, 505, 295, 530); 

	m_wndCreateData.EnableWindow(FALSE);

}
void CFMServicePaidSummaryByDept_2024::OnInitializeComponents(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	m_wndYear.SetLimitText(16);
	//m_wndYear.SetCheckValue(true);

	//m_wndReportPeriod.SetCheckValue(true);
	m_wndReportPeriod.LimitText(35);
	//m_wndFromDate.SetMax(CDateTime(pMF->GetSysDateTime()));
	m_wndFromDate.SetCheckValue(true);
	//m_wndToDate.SetMax(CDateTime(pMF->GetSysDateTime()));
	m_wndToDate.SetCheckValue(true);
	m_wndClerk.SetCheckValue(true);
	m_wndClerk.LimitText(1024);
	m_wndStatus.SetCheckValue(true);
	m_wndStatus.LimitText(1024);
	m_wndOrderBy.SetCheckValue(true);
	m_wndOrderBy.LimitText(1024);

	m_wndReportPeriod.InsertColumn(0, _T("ID"), CFMT_TEXT, 50);
	m_wndReportPeriod.InsertColumn(1, _T("Description"), CFMT_TEXT, 150);



	m_wndList.InsertColumn(0, _T("ID"), CFMT_TEXT, 80);
	m_wndList.InsertColumn(1, _T("Receipt No"), CFMT_TEXT, 130);
	m_wndList.InsertColumn(2, _T("Posted"), CFMT_TEXT, 40);
	m_wndList.InsertColumn(3, _T("Date"), CFMT_DATETIME, 120);
	m_wndList.InsertColumn(4, _T("Staff"), CFMT_TEXT, 150);
	m_wndList.InsertColumn(5, _T("cashbook_id"), CFMT_TEXT, 100);
	m_wndList.SetCheckBox(true);

	m_wndDeptList.InsertColumn(0, _T("ID"), CFMT_TEXT, 90);
	m_wndDeptList.InsertColumn(1, _T("Name"), CFMT_TEXT, 300);
	m_wndDeptList.SetCheckBox(TRUE);

	m_wndClerk.InsertColumn(0, _T("ID"), CFMT_TEXT, 80);
	m_wndClerk.InsertColumn(1, _T("Name"), CFMT_TEXT, 200);


	m_wndOrderBy.InsertColumn(0, _T("ID"), CFMT_TEXT, 80);
	m_wndOrderBy.InsertColumn(1, _T("Name"), CFMT_TEXT, 200);

	m_wndhttt.InsertColumn(0, _T("ID"), CFMT_TEXT, 80);
	m_wndhttt.InsertColumn(1, _T("Name"), CFMT_TEXT, 200);

	m_wndStatus.InsertColumn(0, _T("ID"), CFMT_TEXT, 80);
	m_wndStatus.InsertColumn(1, _T("Name"), CFMT_TEXT, 200);


	m_wndPhanloai.InsertColumn(0, _T("ID"), CFMT_TEXT, 80);
	m_wndPhanloai.InsertColumn(1, _T("Name"), CFMT_TEXT, 200);


	m_wndMarkAll.ModifyStyle(WS_TABSTOP, 0);
	m_wndUnMark.ModifyStyle(WS_TABSTOP, 0);
}

void CFMServicePaidSummaryByDept_2024::OnSetWindowEvents(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	//m_wndYear.SetEvent(WE_CHANGE, _OnYearChangeFnc);
	//m_wndYear.SetEvent(WE_SETFOCUS, _OnYearSetfocusFnc);
	//m_wndYear.SetEvent(WE_KILLFOCUS, _OnYearKillfocusFnc);
	m_wndYear.SetEvent(WE_CHECKVALUE, _OnYearCheckValueFnc);
	m_wndReportPeriod.SetEvent(WE_SELENDOK, _OnReportPeriodSelendokFnc);
	//m_wndReportPeriod.SetEvent(WE_SETFOCUS, _OnReportPeriodSetfocusFnc);
	//m_wndReportPeriod.SetEvent(WE_KILLFOCUS, _OnReportPeriodKillfocusFnc);
	m_wndReportPeriod.SetEvent(WE_SELCHANGE, _OnReportPeriodSelectChangeFnc);
	m_wndReportPeriod.SetEvent(WE_LOADDATA, _OnReportPeriodLoadDataFnc);
	//m_wndReportPeriod.SetEvent(WE_ADDNEW, _OnReportPeriodAddNewFnc);
	//m_wndFromDate.SetEvent(WE_CHANGE, _OnFromDateChangeFnc);
	//m_wndFromDate.SetEvent(WE_SETFOCUS, _OnFromDateSetfocusFnc);
	//m_wndFromDate.SetEvent(WE_KILLFOCUS, _OnFromDateKillfocusFnc);
	m_wndFromDate.SetEvent(WE_CHECKVALUE, _OnFromDateCheckValueFnc);
	//m_wndToDate.SetEvent(WE_CHANGE, _OnToDateChangeFnc);
	//m_wndToDate.SetEvent(WE_SETFOCUS, _OnToDateSetfocusFnc);
	//m_wndToDate.SetEvent(WE_KILLFOCUS, _OnToDateKillfocusFnc);
	m_wndToDate.SetEvent(WE_CHECKVALUE, _OnToDateCheckValueFnc);
	m_wndClerk.SetEvent(WE_SELENDOK, _OnClerkSelendokFnc);
	//m_wndClerk.SetEvent(WE_SETFOCUS, _OnClerkSetfocusFnc);
	//m_wndClerk.SetEvent(WE_KILLFOCUS, _OnClerkKillfocusFnc);
	m_wndClerk.SetEvent(WE_SELCHANGE, _OnClerkSelectChangeFnc);
	m_wndClerk.SetEvent(WE_LOADDATA, _OnClerkLoadDataFnc);
	//m_wndClerk.SetEvent(WE_ADDNEW, _OnClerkAddNewFnc);
	m_wndStatus.SetEvent(WE_SELENDOK, _OnStatusSelendokFnc);
	//m_wndStatus.SetEvent(WE_SETFOCUS, _OnStatusSetfocusFnc);
	//m_wndStatus.SetEvent(WE_KILLFOCUS, _OnStatusKillfocusFnc);
	m_wndStatus.SetEvent(WE_SELCHANGE, _OnStatusSelectChangeFnc);
	m_wndStatus.SetEvent(WE_LOADDATA, _OnStatusLoadDataFnc);
	//m_wndStatus.SetEvent(WE_ADDNEW, _OnStatusAddNewFnc);
	m_wndOrderBy.SetEvent(WE_SELENDOK, _OnOrderBySelendokFnc);
	//m_wndOrderBy.SetEvent(WE_SETFOCUS, _OnOrderBySetfocusFnc);
	//m_wndOrderBy.SetEvent(WE_KILLFOCUS, _OnOrderByKillfocusFnc);
	m_wndOrderBy.SetEvent(WE_SELCHANGE, _OnOrderBySelectChangeFnc);
	m_wndOrderBy.SetEvent(WE_LOADDATA, _OnOrderByLoadDataFnc);
	//m_wndOrderBy.SetEvent(WE_ADDNEW, _OnOrderByAddNewFnc);
	m_wndhttt.SetEvent(WE_LOADDATA, _OnhtttLoadDataFnc);
	m_wndhttt.SetEvent(WE_SELENDOK, _OnhtttSelendokFnc);
	m_wndWithoutGeneral.SetEvent(WE_CLICK, _OnWithoutGeneralSelectFnc);
	m_wndList.SetEvent(WE_SELCHANGE, _OnListSelectChangeFnc);
	m_wndList.SetEvent(WE_LOADDATA, _OnListLoadDataFnc);
	m_wndList.SetEvent(WE_DBLCLICK, _OnListDblClickFnc);
//	m_wndList.AddEvent(1, _T("Delete"), _OnListDeleteItemFnc, 0, VK_DELETE, 0);
	m_wndList.AddEvent(1, _T("Check All TYC"), _OnListCheckAllTYCFnc);
	m_wndList.AddEvent(2, _T("Check All PTTYC"), _OnListCheckAllPTTYCFnc);
	m_wndList.AddEvent(3, _T("Check All DV-PTTYC"), _OnListCheckAllDVPTTYCFnc);
	m_wndList.AddEvent(4, _T("Check All Fee Invoice"), _OnListCheckAllInvoiceFnc);
	m_wndList.AddEvent(5, _T("Check All Fee Refund"), _OnListCheckAllRefundFnc);
    
	m_wndList.AddEvent(6, _T("Phiếu dịch vụ yêu cầu"), _OnListCheckAllInvoiceTYCFnc);
	//m_wndList.AddEvent(14, _T("Phiếu chi dịch vụ yêu cầu"), _OnListCheckAllRefundTYCFnc);

	m_wndList.AddEvent(7, _T("Phiếu bảo hiểm yêu cầu"), _OnListCheckAllInvoiceBHTYCFnc);
	//m_wndList.AddEvent(16, _T("Phiếu chi bảo hiểm yêu cầu"), _OnListCheckAllRefundBHTYCFnc);

	m_wndList.AddEvent(8, _T("Bỏ check phiếu QR"), _OnListUnCheckQRFnc);


	m_wndList.AddEvent(100, _T("Search"), _OnListSearchItemFnc);

	m_wndDeptList.SetEvent(WE_LOADDATA, _OnDeptListLoadDataFnc);

	m_wndDeptList.AddEvent(1, _T("Check All"), _OnDeptListCheckAllFnc);
	m_wndDeptList.AddEvent(2, _T("UnCheck All"), _OnDeptListUnCheckAllFnc);

	m_wndDeptList.AddEvent(3, _T("****"));
	m_wndDeptList.AddEvent(4, _T("Chọn khoa PTTYC + TYC + KSK"), _OnListCheckAllPTTYCTYCFnc);
	m_wndDeptList.AddEvent(5, _T("Chọn khoa KB_A16"), _OnListCheckAllKBA16Fnc);
	m_wndDeptList.AddEvent(6, _T("Chọn khoa TMNT + TTTM"), _OnListCheckAllTTTMFnc);
	m_wndDeptList.AddEvent(7, _T("Bỏ chọn khoa PTTYC + TYC + KB_A16 + TMNT + TTTM + KSK"), _OnListUnCheckAllTYC_PTTYC_KBA16Fnc);

	m_wndMarkAll.SetEvent(WE_CLICK, _OnMarkAllSelectFnc);
	m_wndUnMark.SetEvent(WE_CLICK, _OnUnMarkSelectFnc);
	m_wndPrint.SetEvent(WE_CLICK, _OnPrintSelectFnc);
	m_wndExport.SetEvent(WE_CLICK, _OnExportSelectFnc);
	m_wndInpatient.SetEvent(WE_CLICK, _OnInpatientSelectFnc);
	m_wndOutpatient.SetEvent(WE_CLICK, _OnOutpatientSelectFnc);
	m_wndDeposit.SetEvent(WE_CLICK, _OnDepositSelectFnc);
	m_wndAll.SetEvent(WE_CLICK, _OnAllSelectFnc);
	m_wndSOD.SetEvent(WE_CLICK, _OnSODSelectFnc);
	m_wndCreateData.SetEvent(WE_CLICK, _OnCreateDataSelectFnc);
	m_wndATM.SetEvent(WE_CLICK, _OnATMSelectFnc);
	m_wndAllZone.SetEvent(WE_CLICK, _OnAllZoneSelectFnc);
	m_wndABZone.SetEvent(WE_CLICK, _OnABZoneSelectFnc);
	m_wndBED.SetEvent(WE_CLICK, _OnBEDSelectFnc);
	m_wndCLCzone.SetEvent(WE_CLICK, _OnCLCzoneSelectFnc);
	m_wndQrOnline.SetEvent(WE_CLICK, _OnQrOnlineSelectFnc);


	m_wndAllObj.SetEvent(WE_CLICK, _OnAllObjSelectFnc);
	m_wndInsurance.SetEvent(WE_CLICK, _OnInsuranceSelectFnc);
	m_wndService.SetEvent(WE_CLICK, _OnServiceSelectFnc);
	m_wndOtherObj.SetEvent(WE_CLICK, _OnOtherObjSelectFnc);

	m_wndPhanloai.SetEvent(WE_LOADDATA, _OnPhanloaiLoadDataFnc);

	CString szSysDate = pMF->GetSysDate();
	m_nYear = ToInt(szSysDate.Left(4));
	m_szReportPeriodKey.Format(_T("%d"), ToInt(szSysDate.Mid(5, 2)));
	m_szFromDate = m_szToDate = pMF->GetSysDate();
	m_szFromDate += _T("00:00");
	m_szToDate += _T("23:59");
	//SetMode(VM_EDIT);
	OnDeptListLoadData();
	UpdateData(false);


}
void CFMServicePaidSummaryByDept_2024::OnDoDataExchange(CDataExchange* pDX){
	DDX_Text(pDX, m_wndYear.GetDlgCtrlID(), m_nYear);
	DDX_TextEx(pDX, m_wndReportPeriod.GetDlgCtrlID(), m_szReportPeriodKey);
	DDX_TextEx(pDX, m_wndFromDate.GetDlgCtrlID(), m_szFromDate);
	DDX_TextEx(pDX, m_wndToDate.GetDlgCtrlID(), m_szToDate);
	DDX_TextEx(pDX, m_wndClerk.GetDlgCtrlID(), m_szClerkKey);
	DDX_TextEx(pDX, m_wndStatus.GetDlgCtrlID(), m_szStatusKey);
	DDX_TextEx(pDX, m_wndOrderBy.GetDlgCtrlID(), m_szOrderByKey);
	DDX_TextEx(pDX, m_wndhttt.GetDlgCtrlID(), m_szhtttKey);
	DDX_Check(pDX, m_wndWithoutGeneral.GetDlgCtrlID(), m_bWithoutGeneral);
	DDX_Radio(pDX, m_wndInpatient.GetDlgCtrlID(), m_nPatientType);
	DDX_Check(pDX, m_wndSOD.GetDlgCtrlID(), m_bSOD);
	DDX_Check(pDX, m_wndATM.GetDlgCtrlID(), m_bATM);
	DDX_Check(pDX, m_wndAllZone.GetDlgCtrlID(), m_bAllZone);
	DDX_Check(pDX, m_wndABZone.GetDlgCtrlID(), m_bABZone);
	DDX_Check(pDX, m_wndBED.GetDlgCtrlID(), m_bBED);
	DDX_Check(pDX, m_wndCLCzone.GetDlgCtrlID(), m_bCLCzone);
	DDX_Check(pDX, m_wndQrOnline.GetDlgCtrlID(), m_bQrOnline);
	DDX_Radio(pDX, m_wndAllObj.GetDlgCtrlID(), m_nAllObj);
	DDX_Radio(pDX, m_wndInsurance.GetDlgCtrlID(), m_nInsurance);
	DDX_Radio(pDX, m_wndService.GetDlgCtrlID(), m_nService);
	DDX_Radio(pDX, m_wndOtherObj.GetDlgCtrlID(), m_nOtherObj);
	DDX_TextEx(pDX, m_wndPhanloai.GetDlgCtrlID(), m_szPhanloaiKey);

	
}
void CFMServicePaidSummaryByDept_2024::GetDataToScreen(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL;
	szSQL.Format(_T("SELECT * FROM "));
	rs.ExecSQL(szSQL);

}
void CFMServicePaidSummaryByDept_2024::GetScreenToData(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();

}
void CFMServicePaidSummaryByDept_2024::SetDefaultValues(){

	m_nYear=0;
	m_szReportPeriodKey.Empty();
	m_szFromDate.Empty();
	m_szToDate.Empty();
	m_bWithoutGeneral = FALSE;
	m_szStatusKey = _T("03");
	m_szOrderByKey = _T("04");
	m_nPatientType = 3;
	m_bSOD = FALSE;
	m_bATM=FALSE;
	m_bAllZone=FALSE;
	m_bABZone=FALSE;
	m_bBED=FALSE;
	m_bCLCzone=FALSE;
	m_bQrOnline=FALSE;
	m_nAllObj=0;
	m_nInsurance=1;
	m_nService=1;
	m_nOtherObj=1;
	m_szPhanloaiKey = _T("ALL");
}

int CFMServicePaidSummaryByDept_2024::SetMode(int nMode){
 		int nOldMode = GetMode();
 		CGuiView::SetMode(nMode);
 		CHMSMainFrame *pMF = (CHMSMainFrame *) AfxGetMainWnd();
 		CString szSQL;
 		CRecord rs(&pMF->m_db);
  		switch(nMode){
 		case VM_ADD: 
 			EnableControls(TRUE);
 			EnableButtons(TRUE, 3, 4, -1);
 			SetDefaultValues();
 			break;
 		case VM_EDIT: 
 			EnableControls(TRUE);
 			EnableButtons(TRUE, 0, 1, -1);
 			break;
 		case VM_VIEW: 
 			EnableControls(FALSE);
 			EnableButtons(FALSE, 3, 4, -1);
 			break;
 		case VM_NONE: 
 			EnableControls(FALSE);
 			EnableButtons(TRUE, 0, 6, -1);
 			SetDefaultValues();
 			break;
 		};
 		UpdateData(FALSE);
 		return nOldMode;
}

/*void CFMServicePaidSummaryByDept_2024::OnYearChange(){
	
} */
/*void CFMServicePaidSummaryByDept_2024::OnYearSetfocus(){
	
} */
/*void CFMServicePaidSummaryByDept_2024::OnYearKillfocus(){
	
} */
int CFMServicePaidSummaryByDept_2024::OnYearCheckValue(){
	UpdateData(TRUE);
	if (m_nYear > 0)
	{
		CDateTime dt;
		CDate date;
		CString szTemp;

		dt.ParseDateTime(m_szFromDate);
		date = dt.GetDate();
		if (date.GetYear() != 1752)
		{
			dt.SetDate(m_nYear, date.GetMonth(), date.GetDay());
			m_szFromDate = dt.GetDateTime();
			szTemp.Format(_T("%.2d/2d/4d %.2d:%.2d"), dt.GetDate().GetDay(), dt.GetDate().GetMonth(), 
						  dt.GetDate().GetYear(), dt.GetTime().GetHour(), dt.GetTime().GetMinute());
			m_wndFromDate.SetWindowText(szTemp);
		}
		dt.ParseDateTime(m_szToDate);
		date = dt.GetDate();
		if (date.GetYear() != 1752)
		{
			dt.SetDate(m_nYear, date.GetMonth(), date.GetDay());
			m_szToDate = dt.GetDateTime();
			szTemp.Format(_T("%.2d/2d/4d %.2d:%.2d"), dt.GetDate().GetDay(), dt.GetDate().GetMonth(), 
						  dt.GetDate().GetYear(), dt.GetTime().GetHour(), dt.GetTime().GetMinute());
			m_wndToDate.SetWindowText(szTemp);
		}
	}
	UpdateData(FALSE);
	return 0;
}
 
void CFMServicePaidSummaryByDept_2024::OnReportPeriodSelectChange(int nOldItemSel, int nNewItemSel){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
}

	void CFMServicePaidSummaryByDept_2024::OnCLCzoneSelect()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	OnListLoadData();
	
}

void CFMServicePaidSummaryByDept_2024::OnhtttSelendok()
{
	 OnListLoadData();
}
 
void CFMServicePaidSummaryByDept_2024::OnReportPeriodSelendok()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *) AfxGetMainWnd();
	CString tmpStr;
	CDate dte, date;

	UpdateData(true);

	date.ParseDate(pMF->GetSysDate());
	int nYear = date.GetYear();
	int nMonth = ToInt(m_szReportPeriodKey);

if (nMonth == 6) 
	{
    // Lấy ngày hiện tại
    time_t t = time(NULL);
    tm* now = localtime(&t);

    // Kiểm tra nếu 'now' là NULL
    if (now == NULL) {
        AfxMessageBox(_T("Lỗi: Không thể lấy thời gian hiện tại xyz"));
		
        return;
    }

    // Lấy ngày đầu tuần (Thứ Hai)
    tm fromDateTm = *now;
    fromDateTm.tm_mday -= (now->tm_wday == 0 ? 6 : now->tm_wday - 1);  // Nếu Chủ Nhật thì trừ 6 ngày, nếu không thì trừ (tm_wday - 1)
    mktime(&fromDateTm);

    // Lấy ngày cuối tuần (Chủ Nhật)
    tm toDateTm = *now;
    toDateTm.tm_mday += (now->tm_wday == 0 ? 0 : 7 - now->tm_wday);  // Nếu Chủ Nhật thì cộng 0 ngày, nếu không thì cộng (7 - tm_wday)
    mktime(&toDateTm);

    // Định dạng ngày tháng và lưu vào biến CString
    m_szFromDate.Format(_T("%.4d/%.2d/%.2d"), fromDateTm.tm_year + 1900, fromDateTm.tm_mon + 1, fromDateTm.tm_mday);
    m_szToDate.Format(_T("%.4d/%.2d/%.2d"), toDateTm.tm_year + 1900, toDateTm.tm_mon + 1, toDateTm.tm_mday);
}

// Các điều kiện khác vẫn giữ nguyên
if (nMonth > 0 && nMonth <= 12) {
		m_szFromDate.Format(_T("%.4d/%.2d/1 00:00"), nYear, nMonth);
		dte.ParseDate(m_szFromDate);
		m_szToDate.Format(_T("%.4d/%.2d/%.2d 23:59"), nYear, nMonth, dte.GetMonthLastDay());
	}

if (nMonth == 13) {
		m_szFromDate.Format(_T("%.4d/1/1 00:00"), nYear);
		tmpStr.Format(_T("%.4d/3/1"), nYear);
		dte.ParseDate(tmpStr);
		m_szToDate.Format(_T("%.4d/3/%.2d 23:59"), nYear, dte.GetMonthLastDay());
	}
if (nMonth == 14) {
		m_szFromDate.Format(_T("%.4d/4/1 00:00"), nYear);
		tmpStr.Format(_T("%.4d/6/1"), nYear);
		dte.ParseDate(tmpStr);
		m_szToDate.Format(_T("%.4d/6/%.2d 23:59"), nYear, dte.GetMonthLastDay());
	}
if (nMonth == 15) {
		m_szFromDate.Format(_T("%.4d/7/1 00:00"), nYear);
		tmpStr.Format(_T("%.4d/9/1"), nYear);
		dte.ParseDate(tmpStr);
		m_szToDate.Format(_T("%.4d/9/%.2d 23:59"), nYear, dte.GetMonthLastDay());
	}
if (nMonth == 16) {
		m_szFromDate.Format(_T("%.4d/10/1 00:00"), nYear);
		tmpStr.Format(_T("%.4d/10/1"), nYear);
		dte.ParseDate(tmpStr);
		m_szToDate.Format(_T("%.4d/12/%.2d 23:59"), nYear, dte.GetMonthLastDay());
	}
if (nMonth == 17) {
		m_szFromDate.Format(_T("%.4d/1/1 00:00"), nYear);
		tmpStr.Format(_T("%.4d/12/1"), nYear);
		dte.ParseDate(tmpStr);
		m_szToDate.Format(_T("%.4d/12/%.2d 23:59"), nYear, dte.GetMonthLastDay());
	}

	UpdateData(false); 

}

/*void CFMServicePaidSummaryByDept_2024::OnReportPeriodSetfocus(){
	
}*/
/*void CFMServicePaidSummaryByDept_2024::OnReportPeriodKillfocus(){
	
}*/
long CFMServicePaidSummaryByDept_2024::OnReportPeriodLoadData(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, szWhere;
	szWhere.Empty();

	if(m_wndReportPeriod.IsSearchKey() && ToInt(m_szReportPeriodKey) > 0)
	{
		szWhere.Format(_T(" WHERE hpr_idx=%d "), ToInt(m_szReportPeriodKey));
	}
	m_wndReportPeriod.DeleteAllItems();
	int nCount = 0;
	szSQL.Format(_T("SELECT * FROM hms_period_report %s ORDER BY hpr_idx "), szWhere);
	nCount = rs.ExecSQL(szSQL);
	while(!rs.IsEOF()){ 
		m_wndReportPeriod.AddItems(
			rs.GetValue(_T("hpr_idx")), 
			rs.GetValue(_T("hpr_name")),			
			NULL);
		rs.MoveNext();
	}
	return nCount;
}

/*void CFMServicePaidSummaryByDept_2024::OnReportPeriodAddNew(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
} */
/*void CFMServicePaidSummaryByDept_2024::OnFromDateChange(){
	
} */
/*void CFMServicePaidSummaryByDept_2024::OnFromDateSetfocus(){
	
} */
/*void CFMServicePaidSummaryByDept_2024::OnFromDateKillfocus(){
	
} */
int CFMServicePaidSummaryByDept_2024::OnFromDateCheckValue(){
	OnListLoadData();
	return 0;
}
void CFMServicePaidSummaryByDept_2024::OnBEDSelect(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
}
 
/*void CFMServicePaidSummaryByDept_2024::OnToDateChange(){
	
} */
/*void CFMServicePaidSummaryByDept_2024::OnToDateSetfocus(){
	
} */
/*void CFMServicePaidSummaryByDept_2024::OnToDateKillfocus(){
	
} */
int CFMServicePaidSummaryByDept_2024::OnToDateCheckValue(){
	OnListLoadData();
	return 0;
}
void CFMServicePaidSummaryByDept_2024::OnATMSelect()
	{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	OnListLoadData();
	
}
	void CFMServicePaidSummaryByDept_2024::OnAllZoneSelect()
	{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	OnListLoadData();
}
	void CFMServicePaidSummaryByDept_2024::OnABZoneSelect()
	{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	OnListLoadData();
}
 
void CFMServicePaidSummaryByDept_2024::OnClerkSelectChange(int nOldItemSel, int nNewItemSel){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
} 
void CFMServicePaidSummaryByDept_2024::OnClerkSelendok(){
	 
}
int CFMServicePaidSummaryByDept_2024::OnListCheckAllTYC()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;	
	int nCheck = 0;
	for (int i=0; i<m_wndList.GetItemCount(); i++)	
	{
		szItemText=m_wndList.GetItemText(i,5);
		if ((_T("DVYC"))==szItemText || (_T("THE-DV-YC"))==szItemText)
		{
			m_wndList.SetCheck(i, true);
			nCheck++;
		}
		else m_wndList.SetCheck(i, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;

}
int CFMServicePaidSummaryByDept_2024::OnListCheckAllPTTYC()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;	
	for (int i=0; i<m_wndList.GetItemCount(); i++)	
	{
		szItemText=m_wndList.GetItemText(i,1);
	if ((_T("PTTYC"))==szItemText.Right(5))
	{
		m_wndList.SetCheck(i, true);
	}
	else m_wndList.SetCheck(i, false);
	}
	return 0;
}

int CFMServicePaidSummaryByDept_2024::OnListCheckAllDVPTTYC()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;	
	for (int i=0; i<m_wndList.GetItemCount(); i++)	
	{
		szItemText=m_wndList.GetItemText(i,1);
	if ((_T("DV-PTTYC"))==szItemText.Right(8))
	{
		m_wndList.SetCheck(i, true);
	}
	else m_wndList.SetCheck(i, false);
	}
	return 0;
}

long CFMServicePaidSummaryByDept_2024::OnPhanloaiLoadData()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	m_wndPhanloai.AddItems(_T("ALL"), _T("Tất cả"), NULL);
	m_wndPhanloai.AddItems(_T("NGT"), _T("Ngoại trú"), NULL);
	m_wndPhanloai.AddItems(_T("NT"), _T("Nội trú"), NULL);
	return 0;
}


void CFMServicePaidSummaryByDept_2024::OnListSearchItem(){
	CSearchPopup *newPopup = new CSearchPopup(&m_wndList);
	newPopup->ShowPopup(&m_wndList);
}
void CFMServicePaidSummaryByDept_2024::OnSODSelect()
{
	OnListLoadData();
}
void CFMServicePaidSummaryByDept_2024::OnCreateDataSelect()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	UpdateData(true);
	CRecord rs(&pMF->m_db);
	CString szSQL, szSQL2, szWhere;	

	szWhere.Format(_T(" and FAC_LOCKED='Y' "));

	if(m_szStatusKey == _T("01"))
	{
		szWhere.AppendFormat(_T(" AND fac_invoicedate BETWEEN TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') and TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') "),m_szFromDate, m_szToDate);
		if(!m_szClerkKey.IsEmpty())
		{
			szWhere.AppendFormat(_T(" and fac_user_id='%s' "), m_szClerkKey);
		}

	}
	else if(m_szStatusKey == _T("02"))
	{
		szWhere.AppendFormat(_T(" and FAC_APPROVEDDATE between TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') and TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') "),m_szFromDate, m_szToDate);
		szWhere.AppendFormat(_T(" and FAC_APPROVED ='Y' "));
		if(!m_szClerkKey.IsEmpty())
		{
			szWhere.AppendFormat(_T(" and fac_user_id='%s' "), m_szClerkKey);
		}
	} 
	else if(m_szStatusKey == _T("03") || m_szStatusKey.IsEmpty())
	{
		szWhere.AppendFormat(_T(" and FAC_POSTEDDATE between TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') and TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') "),m_szFromDate, m_szToDate);
		szWhere.AppendFormat(_T(" and FAC_POSTED ='Y' "));
		if(!m_szClerkKey.IsEmpty())
			szWhere.AppendFormat(_T(" and fac_user_id='%s' "), m_szClerkKey);
	}

	if (m_bSOD)
		szWhere.AppendFormat(_T(" AND fac_cashbook_id  in ('DVYC','DV-PTTYC')"));
	else
	szWhere.AppendFormat(_T(" AND substr(fac_cashbook_id, 1, 2) = 'DV' AND fac_cashbook_id  not in ('DVYC','DV-PTTYC')"));
	//szWhere.AppendFormat(_T(" AND fac_cashbook_id %s 'DVYC'"), m_bSOD?_T("="):_T("<>"));
	
	szSQL.Format(_T("SELECT fac_cash_id as idx, fac_invoiceno descr, fac_user_id as user_id, fac_posted as  stt, fac_invoicedate, fac_approveddate, fac_posteddate ") \
		_T(" FROM fa_cash WHERE fac_invoicetype in('P','R') %s ORDER BY fac_cash_id"), szWhere);
	long nCount = rs.ExecSQL(szSQL);
	OnDeleteDataBeforeInsert();
	//_msg(_T("%s"), szSQL);
	
	szSQL2.Format(_T("Insert into tmp_fa_cash_C12 (SELECT fac_cash_id as idx, '%s' as userid FROM fa_cash WHERE fac_invoicetype IN ('P', 'R') %s)"), pMF->m_szUser, szWhere);	
	int ret = pMF->ExecSQL(szSQL2);
	_msg(_T("Đã thực hiện insert %ld bản tin"), ret);	
	
}
int CFMServicePaidSummaryByDept_2024::OnDeleteDataBeforeInsert()
{
 	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
 	CString szSQL; 	
	szSQL.Format(_T("Delete from tmp_fa_cash_C12 where userid='%s'"), pMF->m_szUser);
 	int ret = pMF->ExecSQL(szSQL);
	_msg(_T("Đã xóa %ld bản ghi"), ret);
	return 0;
}

/*void CFMServicePaidSummaryByDept_2024::OnClerkSetfocus(){
	
}*/
/*void CFMServicePaidSummaryByDept_2024::OnClerkKillfocus(){
	
}*/
long CFMServicePaidSummaryByDept_2024::OnClerkLoadData(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szFilter;
	szFilter.Format(_T(" AND su_deptid = 'PTC'"));
	return pMF->LoadUserList(&m_wndClerk, m_szClerkKey, szFilter);
}

/*void CFMServicePaidSummaryByDept_2024::OnClerkAddNew(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
} */
void CFMServicePaidSummaryByDept_2024::OnStatusSelectChange(int nOldItemSel, int nNewItemSel){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
} 
void CFMServicePaidSummaryByDept_2024::OnStatusSelendok(){
	 OnListLoadData();
}
/*void CFMServicePaidSummaryByDept_2024::OnStatusSetfocus(){
	
}*/
/*void CFMServicePaidSummaryByDept_2024::OnStatusKillfocus(){
	
}*/
long CFMServicePaidSummaryByDept_2024::OnStatusLoadData(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	m_wndStatus.AddItems(_T("01"), _T("Ng\xE0y kh\xF3\x61 s\x1ED5"), NULL);
	m_wndStatus.AddItems(_T("02"), _T("Ng\xE0y \x78\xE1\x63 nh\x1EADn"), NULL);
	m_wndStatus.AddItems(_T("03"), _T("Ng\xE0y ghi s\x1ED5(n\x1ED9p qu\x1EF9)"), NULL);
/*
	CRecord rs(&pMF->m_db);
	CString szSQL, szWhere;
	if(m_wndStatus.IsSearchKey() && !m_szStatusKey.IsEmpty()){
	 szWhere.Format(_T(" and id='%s' "), m_szStatusKey
};
	m_wndStatus.DeleteAllItems(); 
	int nCount = 0;
	szSQL.Format(_T("SELECT fld1 as id, fld2 as name FROM tbl WHERE 1=1 %s ORDER BY id "), szWhere
	nCount = rs.ExecSQL(szSQL);
	while(!rs.IsEOF()){ 
		m_wndStatus.AddItems(
			rs.GetValue(_T("id")), 
			rs.GetValue(_T("name")), NULL);
		rs.MoveNext();
	}
	return nCount;
*/
	return 0;
}
/*void CFMServicePaidSummaryByDept_2024::OnStatusAddNew(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
} */
void CFMServicePaidSummaryByDept_2024::OnOrderBySelectChange(int nOldItemSel, int nNewItemSel){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
} 
void CFMServicePaidSummaryByDept_2024::OnOrderBySelendok(){
	 
}
/*void CFMServicePaidSummaryByDept_2024::OnOrderBySetfocus(){
	
}*/
/*void CFMServicePaidSummaryByDept_2024::OnOrderByKillfocus(){
	
}*/
long CFMServicePaidSummaryByDept_2024::OnOrderByLoadData(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	//m_wndOrderBy.AddItems(_T("01"), _T("S\x1EAFp \x78\x1EBFp th\x65o t\xEAn \x62\x1EC7nh nh\xE2n"), NULL);
	m_wndOrderBy.AddItems(_T("02"), _T("S\x1EAFp \x78\x1EBFp th\x65o s\x1ED1 h\x1ED3 s\x1A1"), NULL);
	//m_wndOrderBy.AddItems(_T("03"), _T("S\x1EAFp \x78\x1EBFp th\x65o ng\xE0y th\x61nh to\xE1n"), NULL);
	m_wndOrderBy.AddItems(_T("04"), _T("S\x1EAFp \x78\x1EBFp th\x65o kho\x61"), NULL);
	//m_wndOrderBy.AddItems(_T("05"), _T("S\x1EAFp \x78\x1EBFp th\x65o phi\x1EBFu thu"), NULL);
/*
	CRecord rs(&pMF->m_db);
	CString szSQL, szWhere;
	if(m_wndOrderBy.IsSearchKey() && !m_szOrderByKey.IsEmpty()){
	 szWhere.Format(_T(" and id='%s' "), m_szOrderByKey
};
	m_wndOrderBy.DeleteAllItems(); 
	int nCount = 0;
	szSQL.Format(_T("SELECT fld1 as id, fld2 as name FROM tbl WHERE 1=1 %s ORDER BY id "), szWhere
	nCount = rs.ExecSQL(szSQL);
	while(!rs.IsEOF()){ 
		m_wndOrderBy.AddItems(
			rs.GetValue(_T("id")), 
			rs.GetValue(_T("name")), NULL);
		rs.MoveNext();
	}
	return nCount;
*/
	return 0;
}
/*void CFMServicePaidSummaryByDept_2024::OnOrderByAddNew(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
} */

long CFMServicePaidSummaryByDept_2024::OnHtttLoadData()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
	m_wndhttt.AddItems(_T("ALL"), _T("Tất cả"), NULL);
	m_wndhttt.AddItems(_T("TM1"), _T("Tiền mặt"), NULL);
	m_wndhttt.AddItems(_T("QR"), _T("Qrcode Online"), NULL);
	m_wndhttt.AddItems(_T("CK"), _T("Chuyển khoản"), NULL);
	m_wndhttt.AddItems(_T("ATM"), _T("Thẻ ATM"), NULL);
	return 0;	
}

void CFMServicePaidSummaryByDept_2024::OnWithoutGeneralSelect(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
}
void CFMServicePaidSummaryByDept_2024::OnListDblClick(){
	int nSel = m_wndList.GetCurSel();
	if(nSel < 0) return;
	BOOL bCheck = m_wndList.GetCheck(nSel);
	m_wndList.SetCheck(nSel, bCheck);
} 
void CFMServicePaidSummaryByDept_2024::OnListSelectChange(int nOldItem, int nNewItem){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	
} 
int CFMServicePaidSummaryByDept_2024::OnListDeleteItem(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	 return 0;
} 
long CFMServicePaidSummaryByDept_2024::OnListLoadData()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	UpdateData();
	CRecord rs(&pMF->m_db);
	CString szSQL, szWhere;

	szWhere.Format(_T(" and FAC_LOCKED='Y' "));

	if(m_szStatusKey == _T("01"))
	{
		szWhere.AppendFormat(_T(" AND fac_invoicedate BETWEEN TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') and TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') "),m_szFromDate, m_szToDate);
		if(!m_szClerkKey.IsEmpty())
		{
			szWhere.AppendFormat(_T(" and fac_user_id='%s' "), m_szClerkKey);
		}

	}
	else if(m_szStatusKey == _T("02"))
	{
		szWhere.AppendFormat(_T(" and FAC_APPROVEDDATE between TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') and TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') "),m_szFromDate, m_szToDate);
		szWhere.AppendFormat(_T(" and FAC_APPROVED ='Y' "));
		if(!m_szClerkKey.IsEmpty())
		{
			szWhere.AppendFormat(_T(" and fac_user_id='%s' "), m_szClerkKey);
		}
	} 
	else if(m_szStatusKey == _T("03") || m_szStatusKey.IsEmpty())
	{
		szWhere.AppendFormat(_T(" and FAC_POSTEDDATE between TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') and TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') "),m_szFromDate, m_szToDate);
		szWhere.AppendFormat(_T(" and FAC_POSTED ='Y' "));
		if(!m_szClerkKey.IsEmpty())
		{
			szWhere.AppendFormat(_T(" and fac_user_id='%s' "), m_szClerkKey);
		}
	}
	//szWhere.Format(_T(" AND fac_cashbook_id in ('QR')"));
	//if (m_bSOD)
	//	szWhere.AppendFormat(_T(" AND fac_cashbook_id  in ('DVYC','DV-PTTYC')"));

	if (m_bSOD)
		//szWhere.AppendFormat(_T(" AND fac_cashbook_id in ('DVYC','DV-PTTYC', 'THE-DV-YC', 'THE-DV-PTTYC','BHYC','BH-PTTYC','THE-BH-YC','THE-BH-PTTYC')"));
	    szWhere.AppendFormat(_T(" AND fac_cashbook_id in ('DVYC','DV-PTTYC','BH-PTTYC', 'THE-DV-YC','BHYC', 'THE-DV-PTTYC', 'THE-BH-YC', 'THE-BH-PTTYC', 'CK-DV-YC', 'CK-BH-YC','CK-DV-PTTYC', 'CK-BH-PTTYC', 'QR')"));
	
	else if (m_bABZone)
		szWhere.AppendFormat(_T(" AND fac_cashbook_id in ('DV-AB', 'QR')"));
	
	else if (m_bCLCzone)
		szWhere.AppendFormat(_T(" AND fac_cashbook_id in ('DVCLC', 'THE-DVCLC', 'CK-DVCLC', 'DVCLCA16', 'THE-DV-CLCA16', 'CK-DV-CLCA16', 'QR')"));


	else if (m_bATM)
		szWhere.AppendFormat(_T(" AND fac_cashbook_id in ('THE-DV', 'QR')"));

	else if (m_bAllZone)
		szWhere.AppendFormat(_T(" AND fac_cashbook_id in ('DV-AB','DV', 'THE-DV', 'CK-DV', 'THE-DVCLC', 'CK-DVCLC', 'DVCLC', 'THE-DV-CLCA16', 'CK-DV-CLCA16', 'DVCLCA16', 'QR')"));

	else if (m_bQrOnline)
		szWhere.AppendFormat(_T(" AND fac_cashbook_id in ('QR')"));

	else
		//szWhere.AppendFormat(_T(" AND fac_cashbook_id = 'DV'"));
		//szWhere.AppendFormat(_T(" AND (fac_cashbook_id IN ('THE-DV', 'CK-DV', 'DV-AB', 'DV', 'QR')) AND fac_cashbook_id  not in ('DVYC','DV-PTTYC', 'DVCLC', 'DVCLCA16')"));
		szWhere.AppendFormat(_T(" AND 1=1 "));

	if(m_szhtttKey == _T("TM1"))
	{
		szWhere.AppendFormat(_T(" AND fac_cashbook_id in ('CASH')"));
	}

	else if(m_szhtttKey == _T("QR"))
	{
		szWhere.AppendFormat(_T(" AND fac_cashbook_id in ('QR')"));
	}

	else if(m_szhtttKey == _T("CK"))
	{
		szWhere.AppendFormat(_T(" AND fac_cashbook_id in ('BANK')"));
	}

	else if(m_szhtttKey == _T("ATM"))
	{
		szWhere.AppendFormat(_T(" AND fac_cashbook_id in ('CARD')"));
	}
	else if (m_szhtttKey == _T("ALL"))
	{
		szWhere.AppendFormat(_T(" AND fac_cashbook_id IN ('CASH', 'QR', 'BANK', 'CARD') "));
	}

	//szWhere.Format(_T(" AND fac_cashbook_id in ('QR')"));
	//else	
	//szWhere.AppendFormat(_T(" AND (substr(fac_cashbook_id, 1, 2) = 'DV' OR fac_cashbook_id='THE-DV') AND fac_cashbook_id  not in ('DVYC','DV-PTTYC')"));
	szSQL.Format(_T("SELECT fac_cash_id as idx, fac_invoiceno descr, fac_user_id as user_id, fac_posted as  stt, fac_invoicedate, fac_approveddate, fac_posteddate,FAC_CASHBOOK_ID as cashbook_id ") \
		//_T("FROM fa_cash WHERE fac_invoicetype in('P','R') AND Fac_Cashbook_Id <> 'DVYC' %s ORDER BY fac_cash_id"), szWhere);
		  _T(" FROM fa_cash WHERE fac_invoicetype in('P','R') %s ORDER BY fac_cash_id"), szWhere);
	m_szCashQuery.Format(_T("SELECT fac_cash_id ") \
			_T(" FROM fa_cash WHERE fac_invoicetype in('P','R') %s ORDER BY fac_cash_id"), szWhere);
	long nCount = rs.ExecSQL(szSQL);
	_msg(_T("%ld"), nCount);
	//_msg(_T("%s"), szSQL);
	m_wndList.BeginLoad();
	CString szDate;
	while (!rs.IsEOF())
	{
		if(m_szStatusKey == _T("01"))
			rs.GetValue(_T("fac_invoicedate"), szDate);
		else if(m_szStatusKey == _T("02"))
		{
			rs.GetValue(_T("fac_approveddate"), szDate);
		}
		else
		{
			rs.GetValue(_T("fac_posteddate"), szDate);

		}

		m_wndList.AddItems(
			rs.GetValue(_T("idx")),
			rs.GetValue(_T("descr")),
			rs.GetValue(_T("stt")),
			szDate,
			rs.GetValue(_T("user_id")),
			rs.GetValue(_T("cashbook_id")),
			NULL);
		rs.MoveNext();
	}
	m_wndList.EndLoad();
	return nCount;	
}

void CFMServicePaidSummaryByDept_2024::OnMarkAllSelect()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	int i = 0;
	for(i = 0; i < m_wndList.GetItemCount(); i++)
	{
		m_wndList.SetCheck(i, TRUE);
	}
	_msg(_T("Tổng số phiếu thu chi = %d"), i);
} 
void CFMServicePaidSummaryByDept_2024::OnUnMarkSelect(){
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	for(int i = 0; i < m_wndList.GetItemCount(); i++)
	{
		m_wndList.SetCheck(i, FALSE);
	}
}

void CFMServicePaidSummaryByDept_2024::OnInpatientSelect(){
	
}
void CFMServicePaidSummaryByDept_2024::OnOutpatientSelect(){
	
}
void CFMServicePaidSummaryByDept_2024::OnDepositSelect(){
	
}
void CFMServicePaidSummaryByDept_2024::OnAllSelect(){
	
}
 
 
int CFMServicePaidSummaryByDept_2024::OnAddFMInsuranceReceiptSummary(){
 	if(GetMode() == VM_ADD || GetMode() == VM_EDIT)
 		return -1;
 	CHMSMainFrame *pMF = (CHMSMainFrame *) AfxGetMainWnd();
 	SetMode(VM_ADD);
	return 0;
}
int CFMServicePaidSummaryByDept_2024::OnEditFMInsuranceReceiptSummary(){
 	if(GetMode() != VM_VIEW)
 		return -1;
 	CHMSMainFrame *pMF = (CHMSMainFrame *) AfxGetMainWnd();
 	SetMode(VM_EDIT);
	return 0;  
}
int CFMServicePaidSummaryByDept_2024::OnDeleteFMInsuranceReceiptSummary(){
 	if(GetMode() != VM_VIEW)
 		return -1;
 	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
 	CString szSQL;
 	if(ShowMessage(1, MB_YESNO|MB_ICONQUESTION|MB_DEFBUTTON2) == IDNO)
 		return -1;
 	szSQL.Format(_T("DELETE FROM  WHERE  AND") );
 	int ret = pMF->ExecSQL(szSQL);
 	if(ret >= 0){
 		SetMode(VM_NONE);
 		OnCancelFMInsuranceReceiptSummary();
 	}
	return 0;
}
int CFMServicePaidSummaryByDept_2024::OnSaveFMInsuranceReceiptSummary(){
 	if(GetMode() != VM_ADD && GetMode() != VM_EDIT)
 		return -1;
 	if(!IsValidateData())
 		return -1;
 	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
 	CString szSQL;
 	if(GetMode() == VM_ADD){
 		//szSQL = m_tblTbl.GetInsertSQL();
 	}
 	else if(GetMode() == VM_EDIT){
 		CString szWhere;
 		szWhere.Format(_T(" WHERE"));
 		//szSQL = m_tblTbl.GetUpdateSQL(_T("createdby,createddate"));
 		szSQL += szWhere;
 	}
 //_fmsg(_T("%s"), szSQL);
 	int ret = pMF->ExecSQL(szSQL);
 	if(ret > 0)
 	{
 		//OnFMInsuranceReceiptSummaryListLoadData();
 		SetMode(VM_VIEW);
 	}
 	else
 	{
 	}
 	return ret;
 	return 0;
}
int CFMServicePaidSummaryByDept_2024::OnCancelFMInsuranceReceiptSummary(){
 	if(GetMode() == VM_EDIT)
 	{
 		SetMode(VM_VIEW);
 	} 
 	else 
 	{
 		SetMode(VM_NONE);
 	} 
 	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
 	return 0;
} 
int CFMServicePaidSummaryByDept_2024::OnFMInsuranceReceiptSummaryListLoadData(){
	return 0;
}


#include "FMInsurancePostedReceiptVoucherList.h"
void CFMServicePaidSummaryByDept_2024::OnPrintSelect()
{
	
}

void CFMServicePaidSummaryByDept_2024::OnPrint1stver()
{
	

}
void CFMServicePaidSummaryByDept_2024::OnPrint2ndver()
{
	
}
void CFMServicePaidSummaryByDept_2024::OnExportSelect()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CGuiMenu menu(this);
	CString tmpStr;
	CRect rect;
	int nPos = 0;
	m_wndPrint.GetWindowRect(&rect);
	_debug(_T("right: %d|top: %d"), rect.right, rect.top);
	menu.CreatePopupMenu();
	/*menu.AppendMenu(MF_BYPOSITION, 1, _T("Chi tiết"));
	menu.AppendMenu(MF_BYPOSITION, 5, _T("Chi tiết(phiên bản 2)"));
	menu.AppendMenu(MF_BYPOSITION, 2, _T("Tổng hợp"));
	menu.AppendMenu(MF_BYPOSITION, 6, _T("Tổng hợp(phiên bản 2)"));
	menu.AppendMenu(MF_BYPOSITION, 3, _T("Doanh thu C16"));
	menu.AppendMenu(MF_BYPOSITION, 4, _T("Doanh thu hậu cần"));
	
	menu.AppendMenu(MF_BYPOSITION, 7, _T("Chi tiết so sánh với bảng kê"));
	menu.AppendMenu(MF_BYPOSITION, 8, _T("Chi tiết theo từng bệnh nhân"));

	TranslateString(_T("**********"), tmpStr);
	menu.AppendMenu(MF_BYPOSITION, 9, tmpStr);

	TranslateString(_T("Phân tích số liệu thuốc, vật tư"), tmpStr);
	menu.AppendMenu(MF_BYPOSITION, 10, tmpStr);*/
	
	menu.AppendMenu(MF_BYPOSITION, 15, _T("1. Tổng hợp(phiên bản 3 - 2024)"));
	menu.AppendMenu(MF_SEPARATOR, 0, _T("-"));

	menu.AppendMenu(MF_BYPOSITION, 16, _T("2. Phân tích thuốc, vật tư B5"));
	menu.AppendMenu(MF_SEPARATOR, 0, _T("-"));

	menu.AppendMenu(MF_BYPOSITION, 17, _T("3. Phân tích chi tiết theo danh mục"));
	menu.AppendMenu(MF_SEPARATOR, 0, _T("-"));

	menu.AppendMenu(MF_BYPOSITION, 18, _T("4. Bồi dưỡng theo danh mục"));
	menu.AppendMenu(MF_SEPARATOR, 0, _T("-"));

	menu.AppendMenu(MF_BYPOSITION, 19, _T("5. Chi tiết so sánh với bảng kê"));
	menu.AppendMenu(MF_SEPARATOR, 0, _T("-"));

	menu.AppendMenu(MF_BYPOSITION, 20, _T("6. Chi tiết theo từng bệnh nhân"));
	menu.AppendMenu(MF_SEPARATOR, 0, _T("-"));

	menu.AppendMenu(MF_BYPOSITION, 21, _T("7. Phân tích số liệu thuốc, vật tư"));

	menu.AppendMenu(MF_SEPARATOR, 0, _T("-"));

	menu.AppendMenu(MF_BYPOSITION, 22, _T("8. Chi tiết theo từng bệnh nhân (1 dòng theo khoa thanh toán)"));	


	nPos = menu.TrackPopupMenu(TPM_RETURNCMD | TPM_BOTTOMALIGN | TPM_RIGHTALIGN, rect.right, rect.top, this);
	switch (nPos)
	{
	case 1:
		OnExport(1);
		break;
	case 2:
		OnExport2(1);
		break;
	case 3:
		OnExport3();
		break;
	case 4:
		OnExport4();
		break;
	case 5:
		OnExport(2);
		break;
	case 6:
		OnExport2(2);
		break;
	case 7:
		OnExport7();
		break;
	

	case 10:
		OnExportv2(2);
		break;

	case 15:
		OnExport15(2);
		break;

	case 16:
		OnExportv16(5);
		break;

	case 17:
		OnExport2xxx(2);
		break;

	case 18:
		OnExport3xxx(2);
		break;

	case 19:
		OnExport19();
		break;
	case 20:
		OnExportv20(2);
		break;

	case 21:
		OnExportv2(2);
		break;

	case 22:
		OnExportv22(2);
		break;
	}

}

void CFMServicePaidSummaryByDept_2024::OnExport(int nVersion)

{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1, i = 0;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
		{
			nTotal[i] = 0;
			nGroupTotal[i] = 0;
		}
	CExcel xls;
	if (!xls.Load(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetSheetName(_T("Sheet 0"));
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);

	if (nVersion == 1)
	{
		szSQL = GetQueryString();
	}
	else
	{
		szSQL = GetQueryString_v2();
	}
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	//AfxMessageBox(szSQL);
	
	nRow = 9;
	nCol = 0;
	
	while(!rs.IsEOF())
	{
		int i = 0;
		if(nRow == 65000)
		{
			i++;
			tmpStr.Format(_T("Sheet %d"), i);
			xls.AddSheet(tmpStr);
			xls.SetWorksheet(i);
			nRow = 1;
		}

		rs.GetValue(_T("dept_id"), szNewDept);
		if (!szNewDept.IsEmpty() && szOldDept != szNewDept)
		{
			if (nGroupTotal[26] > 0)
			{
				xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);

				for(int i = 7; i < 30; i++)
				{
					xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
					nTotal[i] += nGroupTotal[i];
					nGroupTotal[i] = 0;
				}
				nRow++;
			}
			xls.SetCellText(0, nRow, szNewDept, FMT_TEXT, true);
			szOldDept = szNewDept;
			nIdx = 1;
			nRow++;
		}
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("HO_TEN"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("docno"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_INTEGER);
		
		rs.GetValue(_T("dept_id"), tmpStr);
		xls.SetCellText(nCol+3, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("NGAY_VAO"), tmpStr);
		xls.SetCellText(nCol+4,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);

		rs.GetValue(_T("NGAY_RA"), tmpStr);
		xls.SetCellText(nCol+5,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);

		rs.GetValue(_T("posted_date"), tmpStr);
		xls.SetCellText(nCol+6, nRow, tmpStr, FMT_TEXT);
		//xls.SetCellText(nCol+6,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);		

		rs.GetValue(_T("SO_NGAY_DT"), nTemp);
		nGroupTotal[7] += nTemp;
		xls.SetCellText(nCol+7, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_KHAM"), nTemp);
		nGroupTotal[8] += nTemp;
		xls.SetCellText(nCol+8, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_GIUONG"), nTemp);
		nGroupTotal[9] += nTemp;
		xls.SetCellText(nCol+9, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_CLS"), nTemp);
		nGroupTotal[10] += nTemp;
		xls.SetCellText(nCol+10, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_PTTT"), nTemp);
		nGroupTotal[11] += nTemp;
		xls.SetCellText(nCol+11, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NGOAITRU"), nTemp);
		nGroupTotal[12] += nTemp;
		xls.SetCellText(nCol+12, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NOITRU"), nTemp);
		nGroupTotal[13] += nTemp;
		xls.SetCellText(nCol+13, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NGOAITRU"), nTemp);
		nGroupTotal[14] += nTemp;
		xls.SetCellText(nCol+14, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NOITRU"), nTemp);
		nGroupTotal[15] += nTemp;
		xls.SetCellText(nCol+15, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_PM"), nTemp);
		nGroupTotal[16] += nTemp;
		xls.SetCellText(nCol+16, nRow, double2str(nTemp), FMT_NUMBER1);
		
		rs.GetValue(_T("TIEN_VAT_TU_PM"), nTemp);
		nGroupTotal[17] += nTemp;
		xls.SetCellText(nCol+17, nRow, double2str(nTemp), FMT_NUMBER1);
		
		rs.GetValue(_T("TIEN_MAU"), nTemp);
		nGroupTotal[18] += nTemp;
		xls.SetCellText(nCol+18, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_KHAC"), nTemp);
		nGroupTotal[19] += nTemp;
		xls.SetCellText(nCol+19, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_GOI"), nTemp);
		nGroupTotal[20] += nTemp;
		xls.SetCellText(nCol+20, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TONG_THU"), nTemp);
		nGroupTotal[21] += nTemp;
		xls.SetCellText(nCol+21, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_AN"), nTemp);
		nGroupTotal[22] += nTemp;
		xls.SetCellText(nCol+22, nRow, double2str(nTemp), FMT_NUMBER1);	


		rs.GetValue(_T("TIEN_AN_HC"), nTemp);
		nGroupTotal[23] += nTemp;
		xls.SetCellText(nCol+23, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_THUOC_TG"), nTemp);
		nGroupTotal[24] += nTemp;
		xls.SetCellText(nCol+24, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_VAT_TU_TG"), nTemp);
		nGroupTotal[25] += nTemp;
		xls.SetCellText(nCol+25, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TONG_THU1"), nTemp);
		nGroupTotal[26] += nTemp;
		xls.SetCellText(nCol+26, nRow, double2str(nTemp), FMT_NUMBER1);	
			
		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[26] > 0)
	{
		xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
			nTotal[i] += nGroupTotal[i];
		}
		nRow++;
	}

	if (nTotal[26] > 0)
	{
		xls.SetCellText(6, nRow, _T("T\x1ED5ng \x63\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nTotal[i]), FMT_NUMBER1, true);
		}
		nRow++;
	}

	xls.SetActiveSheet(0);
	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV2.xls"));
}

void CFMServicePaidSummaryByDept_2024::OnExport2(int nVersion)
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
	{
		nTotal[i] = 0;
		nGroupTotal[i] = 0;
	}
	CExcel xls;
	if (!xls.Load(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_TH.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);
	if (nVersion == 1)
	{
		szSQL = GetQueryString2();
	}
	else
	{
		szSQL = GetQueryString2_v2();
		//AfxMessageBox(szSQL);
	}
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	//AfxMessageBox(szSQL);
	AfxMessageBox(_T("Bổ sung thêm cột miễn giảm của khoa ra viện (bao gồm nghiệp vụ miễn theo đề mục & miễn giảm tổng)"));	
	nRow = 9;
	nCol = 0;
	while(!rs.IsEOF())
	{
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("dept_id"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("TIEN_KHAM"), nTemp);
		nGroupTotal[2] += nTemp;
		xls.SetCellText(nCol+2, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_GIUONG"), nTemp);
		nGroupTotal[3] += nTemp;
		xls.SetCellText(nCol+3, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_CLS"), nTemp);
		nGroupTotal[4] += nTemp;
		xls.SetCellText(nCol+4, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_PTTT"), nTemp);
		nGroupTotal[5] += nTemp;
		xls.SetCellText(nCol+5, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NGOAITRU"), nTemp);
		nGroupTotal[6] += nTemp;
		xls.SetCellText(nCol+6, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NOITRU"), nTemp);
		nGroupTotal[7] += nTemp;
		xls.SetCellText(nCol+7, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NGOAITRU"), nTemp);
		nGroupTotal[8] += nTemp;
		xls.SetCellText(nCol+8, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NOITRU"), nTemp);
		nGroupTotal[9] += nTemp;
		xls.SetCellText(nCol+9, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_PM"), nTemp);
		nGroupTotal[10] += nTemp;
		xls.SetCellText(nCol+10, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_PM"), nTemp);
		nGroupTotal[11] += nTemp;
		xls.SetCellText(nCol+11, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_MAU"), nTemp);
		nGroupTotal[12] += nTemp;
		xls.SetCellText(nCol+12, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_KHAC"), nTemp);
		nGroupTotal[13] += nTemp;
		xls.SetCellText(nCol+13, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_GOI"), nTemp);
		nGroupTotal[14] += nTemp;
		xls.SetCellText(nCol+14, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TONG_THU"), nTemp);
		nGroupTotal[15] += nTemp;
		xls.SetCellText(nCol+15, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_AN"), nTemp);
		nGroupTotal[16] += nTemp;
		xls.SetCellText(nCol+16, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_AN_HC"), nTemp);
		nGroupTotal[17] += nTemp;
		xls.SetCellText(nCol+17, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_THUOC_TG"), nTemp);
		nGroupTotal[18] += nTemp;
		xls.SetCellText(nCol+18, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_VAT_TU_TG"), nTemp);
		nGroupTotal[19] += nTemp;
		xls.SetCellText(nCol+19, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TONG_THU1"), nTemp);
		nGroupTotal[20] += nTemp;
		xls.SetCellText(nCol+20, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("MIEN_GIAM"), nTemp);
		nGroupTotal[21] += nTemp;
		xls.SetCellText(nCol+21, nRow, double2str(nTemp), FMT_NUMBER1);	

		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[20] > 0)
	{
		xls.SetCellText(1, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 2; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
		}
		nRow++;
	}

	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_TH2.xls"));
}

void CFMServicePaidSummaryByDept_2024::OnExport3()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1, i = 0;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
		{
			nTotal[i] = 0;
			nGroupTotal[i] = 0;
		}
	CExcel xls;
	if (!xls.Load(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_C16.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetSheetName(_T("Sheet 0"));
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);

	szSQL = GetQueryString3();
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	
	nRow = 9;
	nCol = 0;
	
	while(!rs.IsEOF())
	{
		int i = 0;
		if(nRow == 65000)
		{
			i++;
			tmpStr.Format(_T("Sheet %d"), i);
			xls.AddSheet(tmpStr);
			xls.SetWorksheet(i);
			nRow = 1;
		}

		rs.GetValue(_T("dept_id"), szNewDept);
		if (!szNewDept.IsEmpty() && szOldDept != szNewDept)
		{
			if (nGroupTotal[25] > 0)
			{
				xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);

				for(int i = 7; i < 30; i++)
				{
					xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
					nTotal[i] += nGroupTotal[i];
					nGroupTotal[i] = 0;
				}
				nRow++;
			}
			xls.SetCellText(0, nRow, szNewDept, FMT_TEXT, true);
			szOldDept = szNewDept;
			nIdx = 1;
			nRow++;
		}
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("HO_TEN"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("docno"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_INTEGER);
		
		rs.GetValue(_T("dept_id"), tmpStr);
		xls.SetCellText(nCol+3, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("NGAY_VAO"), tmpStr);
		xls.SetCellText(nCol+4,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);

		rs.GetValue(_T("NGAY_RA"), tmpStr);
		xls.SetCellText(nCol+5,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);	

		rs.GetValue(_T("posted_date"), tmpStr);
		xls.SetCellText(nCol+6,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);		

		rs.GetValue(_T("TIEN_CLS"), nTemp);
		nGroupTotal[7] += nTemp;
		xls.SetCellText(nCol+7, nRow, double2str(nTemp), FMT_NUMBER1);
		
		rs.GetValue(_T("TIEN_MAU"), nTemp);
		nGroupTotal[8] += nTemp;
		xls.SetCellText(nCol+8, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_KHAC"), nTemp);
		nGroupTotal[9] += nTemp;
		xls.SetCellText(nCol+9, nRow, double2str(nTemp), FMT_NUMBER1);		

		rs.GetValue(_T("TONG_THU"), nTemp);
		nGroupTotal[10] += nTemp;
		xls.SetCellText(nCol+10, nRow, double2str(nTemp), FMT_NUMBER1);		
			
		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[10] > 0)
	{
		xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
			nTotal[i] += nGroupTotal[i];
		}
		nRow++;
	}

	if (nTotal[25] > 0)
	{
		xls.SetCellText(6, nRow, _T("T\x1ED5ng \x63\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nTotal[i]), FMT_NUMBER1, true);
		}
		nRow++;
	}

	xls.SetActiveSheet(0);
	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_C16_1.xls"));
}

CString CFMServicePaidSummaryByDept_2024::GetQueryString()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2;
	CString szSQL21,szSQL22,szSQL23,szSQL24, szOrderBy, szReceiptStr;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));

	//szWhere.Format(_T(" and iv.hfe_cash_id in(%s) "), szReceiptStr);
	
	if (nCount <1000)
		szWhere.Format(_T(" AND iv.hfe_cash_id in(%s) "), szReceiptStr);
	else
	{
		CStringToken tok_id(szReceiptStr);
		int nCount = 0;
		long nTemp = 0;
		CString szIds, tmpStr;
		bool bBreak = false;
		szIds.Empty();
		tmpStr.Empty();
		for (int i = 0; i < tok_id.GetSize(); i++)
		{
			if (nCount > 999)
			{
				bBreak = true;
			}
			if (bBreak)
			{
				if (!szIds.IsEmpty())
				{
					szIds += _T(" OR ");
				}
				szIds.AppendFormat(_T(" iv.hfe_cash_id IN (%s) "), tmpStr);
				tmpStr.Empty();
				nCount = 0;
				bBreak = false;
			}
			if (!tmpStr.IsEmpty())
			{
				tmpStr += _T(",");
			}
			tok_id.GetAt(i, nTemp);
			tmpStr.AppendFormat(_T("%ld"), nTemp);
			nCount++;
		}
		if (!szIds.IsEmpty())
		{
			szIds += _T(" OR ");
		}
		szIds.AppendFormat(_T(" iv.hfe_cash_id IN (%s) "), tmpStr);
		szWhere.Format(_T(" AND (%s)"), szIds);
	}
	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);

	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/

	if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	/*if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" and chindex='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" and chindex='II' "));
	}
	szSQL.Format(_T(" SELECT     Get_patientname(DOC_NO) HO_TEN, ") \
	_T("            DOC_NO docno, ") \
	_T("            NGAY_VAO, ") \
	_T("            NGAY_RA, ") \
	_T("            chindex, ") \
	_T("			invoice_date,") \
	_T("            trunc(fac_posteddate) posted_date, ") \
	_T("            dept_id, ") \
	_T("            SUM(SO_NGAY_DT) SO_NGAY_DT, ") \
	_T("            SUM(TIEN_KHAM) TIEN_KHAM, ") \
	_T("            SUM(TIEN_GIUONG) TIEN_GIUONG, ") \
	_T("            SUM(TIEN_PTTT) TIEN_PTTT, ") \
	_T("            SUM(TIEN_THUOC_CH) TIEN_THUOC_CH, ") \
	_T("            SUM(TIEN_VAT_TU_CH) TIEN_VAT_TU_CH, ") \
	_T("            SUM(TIEN_THUOC_MO) TIEN_THUOC_MO, ") \
	_T("            SUM(TIEN_VAT_TU_MO) TIEN_VAT_TU_MO, ") \
	_T("            SUM(TIEN_THUOC_PHONGMO) TIEN_THUOC_PHONGMO, ") \
	_T("            SUM(TIEN_VAT_TU_PHONGMO) TIEN_VAT_TU_PHONGMO, ") \
	_T("            SUM(TIEN_AN) TIEN_AN, ") \
	_T("            SUM(THU_KHAC) THU_KHAC, ") \
	_T("			SUM(TIEN_KHAM + TIEN_giuong + tien_pttt + tien_thuoc_ch + tien_vat_tu_ch + tien_thuoc_mo + tien_vat_tu_mo + thu_khac) TONG_THU_,") \
	_T("			SUM(tong_thu) tong_thu") \
	_T(" FROM       FA_CASH ") \
	_T(" INNER JOIN (SELECT    i.HFE_CASH_ID CASH_ID, ") \
	_T("                       CASE WHEN I.HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX, ") \
	_T("                       Trunc(i.hfe_date) invoice_date, ") \
	_T("                       CASE WHEN i.hfe_type = 'O' THEN i.hfe_deptid ELSE CASE WHEN f.hfe_type IN ('D', 'M') AND f.hfe_deptid = 'B5' THEN (SELECT ho_deptid FROM hms_operation WHERE ho_idx = f.hfe_rowid) ELSE f.hfe_deptid END END dept_id, ") \
	_T("                       i.HFE_DOCNO DOC_NO, ") \
	_T("                       CASE WHEN I.HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO, ") \
	_T("                       CASE WHEN I.HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA, ") \
	_T("                       CASE WHEN Nvl(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) AND F.HFE_TYPE = 'B' THEN f.hfe_quantity ELSE 0 END ") \
	_T("						SO_NGAY_DT, ") \
	_T("                       CASE WHEN NVL(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) AND F.HFE_TYPE = 'E' THEN f.hfe_cost ELSE 0 END ") \
	_T("                        TIEN_KHAM, ") \
	_T("                       CASE WHEN NVL(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) AND F.HFE_TYPE = 'B' THEN f.hfe_cost ELSE 0 END ") \
	_T("                        TIEN_GIUONG, ") \
	_T("                       CASE WHEN NVL(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) AND F.HFE_TYPE = 'O' THEN f.hfe_cost ELSE 0 END ") \
	_T("                        TIEN_PTTT, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') AND NVL(F.HFE_CATEGORY, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN (SELECT COALESCE(DECODE(mp_org_id, 'PM', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id <= 0) ELSE 0 END ") \
	_T("                        TIEN_THUOC_CH, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') AND NVL(F.HFE_CATEGORY, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN (SELECT COALESCE(DECODE(mp_org_id, 'MA', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id <= 0) ELSE 0 END ") \
	_T("                        TIEN_VAT_TU_CH, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') AND NVL(F.HFE_CATEGORY, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN (SELECT COALESCE(DECODE(mp_org_id, 'PM', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id > 0) ELSE 0 END ") \
	_T("                        TIEN_THUOC_MO, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') AND NVL(F.HFE_CATEGORY, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN (SELECT COALESCE(DECODE(mp_org_id, 'MA', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id > 0) ELSE 0 END ") \
	_T("                        TIEN_VAT_TU_MO, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') THEN (SELECT COALESCE(DECODE(mp_org_id, 'PM', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id > 0) ELSE 0 END ") \
	_T("                        TIEN_THUOC_PHONGMO, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') THEN (SELECT COALESCE(DECODE(mp_org_id, 'MA', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id > 0) ELSE 0 END ") \
	_T("                        TIEN_VAT_TU_PHONGMO, ") \
	_T("                       CASE WHEN Substr(f.hfe_group, 1, 2) = 'FF' AND NVL(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN f.hfe_cost ELSE 0 END ") \
	_T("                        TIEN_AN, ") \
	_T("                       CASE WHEN I.HFE_TYPE <> 'O' THEN (CASE WHEN F.HFE_TYPE IN( 'F', 'X' ) AND Substr(F.HFE_GROUP, 1, 2) <> 'FF' AND Nvl(F.HFE_CATEGORY, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN f.hfe_cost ELSE 0 END ) ELSE I.HFE_PAYMENT END ") \
	_T("                        THU_KHAC, ") \
	_T("					   CASE WHEN i.hfe_type = 'O' THEN i.hfe_amount ELSE CASE WHEN substr(f.hfe_group, 1, 2) <> 'FF' AND NVL(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN f.hfe_cost ELSE 0 END END tong_thu")
	_T("             FROM      HMS_FEE_INVOICE_VIEW_V2 I ") \
	_T("             LEFT JOIN HMS_FEE F ON ( I.HFE_DOCNO = F.HFE_DOCNO AND I.HFE_INVOICENO = F.HFE_INVOICENO ) ") \
	_T("             LEFT JOIN HMS_DOC ON ( I.HFE_DOCNO = HD_DOCNO ) ") \
	_T("             LEFT JOIN HMS_CLINICAL_RECORD ON ( I.HFE_DOCNO = HCR_DOCNO ) ") \
	_T("             WHERE     i.HFE_CASH_ID > 0 AND (i.hfe_type = 'O' OR (f.hfe_fee_id NOT IN (SELECT HFE_INVOICELINE_ID ") \
	_T("                                                FROM   HMS_FEE_DISCOUNTLINE d ") \
	_T("                                                WHERE  d.HFE_DOCNO = f.hfe_docno AND d.hfe_refidx NOT IN i.hfe_invoiceno) AND f.hfe_status IN ('P', 'R') AND f.hfe_type IN ('E', 'B', 'O', 'D', 'M', 'F')))") \
	_T("			) INVOICE_TBL ON ( FAC_CASH_ID = CASH_ID ) ") \
	_T(" WHERE      1 = 1 %s") \
	_T(" GROUP      BY DOC_NO,NGAY_VAO,NGAY_RA,chindex,trunc(fac_posteddate),dept_id, invoice_date ") \
	_T(" ORDER      BY trunc(fac_posteddate) %s "), szWhere, szOrderBy);*/
	//Case when like this very very...
	//Chi tiet theo bao cao tong hop khoa thuc hien//

	//1. Tien kham ne//
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,       ") \
				_T("       f.hfe_patpaid as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_itemid <> 'D0000006'") \
				_T("     AND f.hfe_patpaid       >0") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN (f.hfe_type ='B' OR f.hfe_itemid='D0000006')") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       f.hfe_patpaid as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND (F.Hfe_Group     IN ('C0000') OR f.hfe_itemid='D0000006')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND su_deptid       IS NOT NULL") \
				_T("         THEN Su_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND su_deptid       IS NOT NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				//_T("         AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,") \//
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T(" AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_patpaid as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       f.hfe_patpaid as TIEN_PTTT,") \//				
				_T("       CASE WHEN HFE_FEEGROUP='HITECH_A' AND HFE_TREAT_INPACKAGE='Y' THEN f.hfe_cost else f.hfe_patpaid end as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       f.hfe_patpaid as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND iv.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       f.hfe_patpaid as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND iv.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       f.hfe_patpaid as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND iv.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       f.hfe_patpaid as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND iv.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       f.hfe_patpaid AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno    = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno        = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       f.hfe_patpaid AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno    = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno        = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_patpaid as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_patpaid as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P', 'BN')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = fi.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = fi.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       f.hfe_patpaid as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);
    //Update ngay 03/06/2017//
	// Them vao 2 cot tinh tien thuoc trong goi & tien vat tu trong goi//
	//16. Phi tien thuoc trong goi//
 szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       f.hfe_patpaid as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//17.Phi tien vat tu trong goi//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_patpaid as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//18.Phi thuoc trong goi, dung cho truong hop thu phi PTTT truoc sau do moi nhap thuoc trong goi o phong kham//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv ON (ho_docno = iv.hfe_docno AND ho_INVOICENO = iv.hfe_invoiceno)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//19.Phi tien vat tu trong goi, dung cho truong hop thu phi PTTT truoc nhap vat tu sau//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv ON (ho_docno = iv.hfe_docno AND ho_INVOICENO = iv.hfe_invoiceno)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);

		//20. Phi thu goi, them vao ngay 13/11/2018//
szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);

rs.ExecSQL(szSQL);
				//_msg(_T("%s"), szSQL);
	/*_msg(_T("%s"), szSQL1);
	_msg(_T("%s"), szSQL2);	
	_msg(_T("%s"), szSQL3);	
	_msg(_T("%s"), szSQL4);	
	_msg(_T("%s"), szSQL5);	
	_msg(_T("%s"), szSQL6);	
	_msg(_T("%s"), szSQL7);	
	_msg(_T("%s"), szSQL8);	
	_msg(_T("%s"), szSQL9);	
	_msg(_T("%s"), szSQL10);	
	_msg(_T("%s"), szSQL11);
	_msg(_T("%s"), szSQL12);
	_msg(_T("%s"), szSQL13);
	_msg(_T("%s"), szSQL14);
	_msg(_T("%s"), szSQL15);
	_msg(_T("%s"), szSQL16);
	_msg(_T("%s"), szSQL17);
	_msg(_T("%s"), szSQL18);
	_msg(_T("%s"), szSQL19);
	_msg(_T("%s"), szWhere1);*/
   szSQL.Format(_T(" SELECT") \
				_T(" HO_TEN,") \
				_T(" docno,") \
				_T(" NGAY_VAO, ") \
				_T(" NGAY_RA,") \
				_T(" CHINDEX, ") \
				_T(" posted_date,") \
				_T(" dept_id,") \
				_T(" SUM(SO_NGAY_DT) as SO_NGAY_DT,") \
				_T(" SUM(TIEN_KHAM) as TIEN_KHAM,") \
				_T(" SUM(TIEN_GIUONG) as TIEN_GIUONG,") \
				_T(" SUM(TIEN_CLS) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT) as TIEN_PTTT,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_PM) AS TIEN_THUOC_PM,") \
				_T(" SUM(TIEN_VAT_TU_PM) AS TIEN_VAT_TU_PM,") \
				_T(" SUM(TIEN_MAU) as TIEN_MAU,") \
				_T(" SUM(THU_KHAC) as THU_KHAC,") \
				_T(" SUM(THU_GOI) as THU_GOI,") \
				_T(" SUM(TIEN_AN) as TIEN_AN,") \
				_T(" SUM(TIEN_THUOC_TG+TIEN_THUOC_TG_O) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG+TIEN_VAT_TU_TG_O) as TIEN_VAT_TU_TG,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI) as TONG_THU,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_THUOC_TG+TIEN_VAT_TU_TG) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(hfe_docno) as HO_TEN,") \
				_T("   hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    trunc(hfe_date) as invoice_date,") \
				_T("    trunc(FAC_POSTEDDATE) as posted_date,") \
				_T("    khoa_thuchien as dept_id,") \
				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     hfe_itemid") \
				_T("   FROM") \
				_T("     (") \
				_T("    %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s ") \
				//_T("    %s %s ") \//
				_T("   )tbl1") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=tbl1.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=tbl1.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=tbl1.HFE_DOCNO)") \
				_T("   WHERE 1=1 AND (TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_THUOC_TG+TIEN_VAT_TU_TG+TIEN_THUOC_TG_O+TIEN_VAT_TU_TG_O)>0 %s") \
				_T("   )") \
				_T(" GROUP BY ") \
				_T(" HO_TEN, docno, NGAY_VAO, NGAY_RA,CHINDEX, posted_date,dept_id") \
				_T(" ORDER BY dept_id"),szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24, szWhere1);

	return szSQL;
}

CString CFMServicePaidSummaryByDept_2024::GetQueryString_v2()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2;
	CString szSQL21,szSQL22,szSQL23,szSQL24,szSQL25, szOrderBy, szReceiptStr, szWherebed;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}
	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));
	if (nCount < m_wndList.GetItemCount() && nCount > 0)
	{
		if (nCount <1000)
		{
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND fac_cash_id in(%s)) "), szReceiptStr);
		}
		else
		{
			CStringToken tok_id(szReceiptStr);
			int nCount = 0;
			long nTemp = 0;
			CString szIds, tmpStr;
			bool bBreak = false;
			szIds.Empty();
			tmpStr.Empty();
			for (int i = 0; i < tok_id.GetSize(); i++)
			{
				if (nCount > 999)
				{
					bBreak = true;
				}
				if (bBreak)
				{
					if (!szIds.IsEmpty())
					{
						szIds += _T(" OR ");
					}
					szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
					//_tprintf(_T("\nszIds: %s\n"), szIds);
					tmpStr.Empty();
					nCount = 0;
					bBreak = false;
				}
				if (!tmpStr.IsEmpty())
				{
					tmpStr += _T(",");
				}
				tok_id.GetAt(i, nTemp);
				tmpStr.AppendFormat(_T("%ld"), nTemp);
				nCount++;
			}
			if (!szIds.IsEmpty())
			{
				szIds += _T(" OR ");
			}
			szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND (%s))"), szIds);
		}
	}
	else
	{
		szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl)"));
	}
	szWhere.Empty();
	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);

	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/

	if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	if (m_bBED)
	{
		szWherebed.AppendFormat(_T(" AND SUM(SO_NGAY_DT)>0 "));	
	}

	//1. Tien kham ne//
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_itemid <> 'D0000006'") \
				_T("     AND CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END       >0") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN (f.hfe_type ='B' OR f.hfe_itemid='D0000006')") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND (F.Hfe_Group     IN ('C0000') OR f.hfe_itemid='D0000006')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND HPC_PDEPTID IS NOT NULL ") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (f.hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND su_deptid       IS NOT NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T("       AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20', 'B1E00', 'C5') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       CASE WHEN HFE_FEEGROUP='HITECH_A' AND HFE_TREAT_INPACKAGE='Y' THEN f.hfe_cost else CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END end as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X' AND f.hfe_itemid not in ('F0000226')") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P', 'COV', 'BN')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND (F.Hfe_Group    IN ('FF000') OR (F.Hfe_Group = 'F0000' AND f.hfe_itemid='F0000226'))")
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'COV', 'BN')"), szWhere);

 //15.1 Phi an hau can//
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
    
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);

		//20. Phi thu goi, them vao ngay 13/11/2018//
szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P', 'COV', 'BN')"), szWhere);

rs.ExecSQL(szSQL);
   szSQL.Format(_T(" WITH tbl AS (%s)") \
				_T(" SELECT") \
				_T(" HO_TEN,") \
				_T(" docno,") \
				_T(" NGAY_VAO, ") \
				_T(" NGAY_RA,") \
				_T(" CHINDEX, ") \
				_T(" to_char (posted_date,'DD/MM/YYYY') as posted_date,") \
				_T(" dept_id,") \
				_T(" SUM(SO_NGAY_DT) as SO_NGAY_DT,") \
				_T(" SUM(TIEN_KHAM) as TIEN_KHAM,") \
				_T(" SUM(TIEN_GIUONG) as TIEN_GIUONG,") \
				_T(" SUM(TIEN_CLS) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT) as TIEN_PTTT,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_PM) AS TIEN_THUOC_PM,") \
				_T(" SUM(TIEN_VAT_TU_PM) AS TIEN_VAT_TU_PM,") \
				_T(" SUM(TIEN_MAU) as TIEN_MAU,") \
				_T(" SUM(THU_KHAC) as THU_KHAC,") \
				_T(" SUM(THU_GOI) as THU_GOI,") \
				_T(" SUM(TIEN_AN) as TIEN_AN,") \
				_T(" SUM(TIEN_AN_HC) as TIEN_AN_HC,") \
				_T(" SUM(TIEN_THUOC_TG+TIEN_THUOC_TG_O) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG+TIEN_VAT_TU_TG_O) as TIEN_VAT_TU_TG,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI) as TONG_THU,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(iv.hfe_docno) as HO_TEN,") \
				_T("   iv.hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    hfe_date as invoice_date,") \
				_T("    trunc(fc.FAC_POSTEDDATE) as posted_date,") \
				_T("    khoa_thuchien as dept_id,") \
				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_AN_HC,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     hfe_itemid") \
				_T("   FROM HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=iv.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN  (") \
				_T("    %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s ") \
				_T("   ) tbl1 ON (iv.hfe_invoiceno = tbl1.hfe_invoiceno AND iv.hfe_docno = tbl1.hfe_docno)") \
				_T("   WHERE 1=1  %s") \
				_T("   )") \
				_T(" GROUP BY ") \
				_T(" HO_TEN, docno, NGAY_VAO, NGAY_RA,CHINDEX, posted_date,dept_id") \
				_T(" HAVING SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+") \
				_T("	TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+") \
				_T("	THU_GOI+TIEN_AN+TIEN_THUOC_TG+TIEN_VAT_TU_TG+TIEN_THUOC_TG_O+TIEN_VAT_TU_TG_O+TIEN_AN_HC) >0 %s") \
				_T(" ORDER BY dept_id,posted_date"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,
				szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szWhere1, szWherebed);

	return szSQL;
}

CString CFMServicePaidSummaryByDept_2024::GetQueryString2()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2;
	CString szOrderBy, szReceiptStr, szSQL21,szSQL22, szSQL23, szSQL24;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));

	//szWhere.Format(_T(" and iv.hfe_cash_id in(%s) "), szReceiptStr);
	
	if (nCount <1000)
		szWhere.Format(_T(" AND iv.hfe_cash_id in(%s) "), szReceiptStr);
	else
	{
		CStringToken tok_id(szReceiptStr);
		int nCount = 0;
		long nTemp = 0;
		CString szIds, tmpStr;
		bool bBreak = false;
		szIds.Empty();
		tmpStr.Empty();
		for (int i = 0; i < tok_id.GetSize(); i++)
		{
			if (nCount > 999)
			{
				bBreak = true;
			}
			if (bBreak)
			{
				if (!szIds.IsEmpty())
				{
					szIds += _T(" OR ");
				}
				szIds.AppendFormat(_T(" iv.hfe_cash_id IN (%s) "), tmpStr);
				tmpStr.Empty();
				nCount = 0;
				bBreak = false;
			}
			if (!tmpStr.IsEmpty())
			{
				tmpStr += _T(",");
			}
			tok_id.GetAt(i, nTemp);
			tmpStr.AppendFormat(_T("%ld"), nTemp);
			nCount++;
		}
		if (!szIds.IsEmpty())
		{
			szIds += _T(" OR ");
		}
		szIds.AppendFormat(_T(" iv.hfe_cash_id IN (%s) "), tmpStr);
		szWhere.Format(_T(" AND (%s)"), szIds);
	}
	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);

	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/

	if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	/*if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" and chindex='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" and chindex='II' "));
	}
	szSQL.Format(_T(" SELECT     Get_patientname(DOC_NO) HO_TEN, ") \
	_T("            DOC_NO docno, ") \
	_T("            NGAY_VAO, ") \
	_T("            NGAY_RA, ") \
	_T("            chindex, ") \
	_T("			invoice_date,") \
	_T("            trunc(fac_posteddate) posted_date, ") \
	_T("            dept_id, ") \
	_T("            SUM(SO_NGAY_DT) SO_NGAY_DT, ") \
	_T("            SUM(TIEN_KHAM) TIEN_KHAM, ") \
	_T("            SUM(TIEN_GIUONG) TIEN_GIUONG, ") \
	_T("            SUM(TIEN_PTTT) TIEN_PTTT, ") \
	_T("            SUM(TIEN_THUOC_CH) TIEN_THUOC_CH, ") \
	_T("            SUM(TIEN_VAT_TU_CH) TIEN_VAT_TU_CH, ") \
	_T("            SUM(TIEN_THUOC_MO) TIEN_THUOC_MO, ") \
	_T("            SUM(TIEN_VAT_TU_MO) TIEN_VAT_TU_MO, ") \
	_T("            SUM(TIEN_THUOC_PHONGMO) TIEN_THUOC_PHONGMO, ") \
	_T("            SUM(TIEN_VAT_TU_PHONGMO) TIEN_VAT_TU_PHONGMO, ") \
	_T("            SUM(TIEN_AN) TIEN_AN, ") \
	_T("            SUM(THU_KHAC) THU_KHAC, ") \
	_T("			SUM(TIEN_KHAM + TIEN_giuong + tien_pttt + tien_thuoc_ch + tien_vat_tu_ch + tien_thuoc_mo + tien_vat_tu_mo + thu_khac) TONG_THU_,") \
	_T("			SUM(tong_thu) tong_thu") \
	_T(" FROM       FA_CASH ") \
	_T(" INNER JOIN (SELECT    i.HFE_CASH_ID CASH_ID, ") \
	_T("                       CASE WHEN I.HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX, ") \
	_T("                       Trunc(i.hfe_date) invoice_date, ") \
	_T("                       CASE WHEN i.hfe_type = 'O' THEN i.hfe_deptid ELSE CASE WHEN f.hfe_type IN ('D', 'M') AND f.hfe_deptid = 'B5' THEN (SELECT ho_deptid FROM hms_operation WHERE ho_idx = f.hfe_rowid) ELSE f.hfe_deptid END END dept_id, ") \
	_T("                       i.HFE_DOCNO DOC_NO, ") \
	_T("                       CASE WHEN I.HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO, ") \
	_T("                       CASE WHEN I.HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA, ") \
	_T("                       CASE WHEN Nvl(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) AND F.HFE_TYPE = 'B' THEN f.hfe_quantity ELSE 0 END ") \
	_T("						SO_NGAY_DT, ") \
	_T("                       CASE WHEN NVL(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) AND F.HFE_TYPE = 'E' THEN f.hfe_cost ELSE 0 END ") \
	_T("                        TIEN_KHAM, ") \
	_T("                       CASE WHEN NVL(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) AND F.HFE_TYPE = 'B' THEN f.hfe_cost ELSE 0 END ") \
	_T("                        TIEN_GIUONG, ") \
	_T("                       CASE WHEN NVL(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) AND F.HFE_TYPE = 'O' THEN f.hfe_cost ELSE 0 END ") \
	_T("                        TIEN_PTTT, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') AND NVL(F.HFE_CATEGORY, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN (SELECT COALESCE(DECODE(mp_org_id, 'PM', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id <= 0) ELSE 0 END ") \
	_T("                        TIEN_THUOC_CH, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') AND NVL(F.HFE_CATEGORY, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN (SELECT COALESCE(DECODE(mp_org_id, 'MA', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id <= 0) ELSE 0 END ") \
	_T("                        TIEN_VAT_TU_CH, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') AND NVL(F.HFE_CATEGORY, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN (SELECT COALESCE(DECODE(mp_org_id, 'PM', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id > 0) ELSE 0 END ") \
	_T("                        TIEN_THUOC_MO, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') AND NVL(F.HFE_CATEGORY, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN (SELECT COALESCE(DECODE(mp_org_id, 'MA', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id > 0) ELSE 0 END ") \
	_T("                        TIEN_VAT_TU_MO, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') THEN (SELECT COALESCE(DECODE(mp_org_id, 'PM', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id > 0) ELSE 0 END ") \
	_T("                        TIEN_THUOC_PHONGMO, ") \
	_T("                       CASE WHEN F.HFE_TYPE IN ('D', 'M') THEN (SELECT COALESCE(DECODE(mp_org_id, 'MA', f.hfe_cost), 0) FROM M_PRODUCT_ITEM, m_product, hms_pharmaorder_view WHERE CAST(hfe_itemid AS INTEGER) = mpi_product_item_id AND MPI_PRODUCT_ID = MP_PRODUCT_ID AND hpo_orderid = f.hfe_orderid AND f.hfe_docno = hpo_docno AND hpo_reference_id > 0) ELSE 0 END ") \
	_T("                        TIEN_VAT_TU_PHONGMO, ") \
	_T("                       CASE WHEN Substr(f.hfe_group, 1, 2) = 'FF' AND NVL(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN f.hfe_cost ELSE 0 END ") \
	_T("                        TIEN_AN, ") \
	_T("                       CASE WHEN I.HFE_TYPE <> 'O' THEN (CASE WHEN F.HFE_TYPE IN( 'F', 'X' ) AND Substr(F.HFE_GROUP, 1, 2) <> 'FF' AND Nvl(F.HFE_CATEGORY, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN f.hfe_cost ELSE 0 END ) ELSE I.HFE_PAYMENT END ") \
	_T("                        THU_KHAC, ") \
	_T("					   CASE WHEN i.hfe_type = 'O' THEN i.hfe_amount ELSE CASE WHEN substr(f.hfe_group, 1, 2) <> 'FF' AND NVL(f.hfe_category, 'N') NOT IN( 'Y', 'BQP','COV', 'BBV' ) THEN f.hfe_cost ELSE 0 END END tong_thu")
	_T("             FROM      HMS_FEE_INVOICE_VIEW_V2 I ") \
	_T("             LEFT JOIN HMS_FEE F ON ( I.HFE_DOCNO = F.HFE_DOCNO AND I.HFE_INVOICENO = F.HFE_INVOICENO ) ") \
	_T("             LEFT JOIN HMS_DOC ON ( I.HFE_DOCNO = HD_DOCNO ) ") \
	_T("             LEFT JOIN HMS_CLINICAL_RECORD ON ( I.HFE_DOCNO = HCR_DOCNO ) ") \
	_T("             WHERE     i.HFE_CASH_ID > 0 AND (i.hfe_type = 'O' OR (f.hfe_fee_id NOT IN (SELECT HFE_INVOICELINE_ID ") \
	_T("                                                FROM   HMS_FEE_DISCOUNTLINE d ") \
	_T("                                                WHERE  d.HFE_DOCNO = f.hfe_docno AND d.hfe_refidx NOT IN i.hfe_invoiceno) AND f.hfe_status IN ('P', 'R') AND f.hfe_type IN ('E', 'B', 'O', 'D', 'M', 'F')))") \
	_T("			) INVOICE_TBL ON ( FAC_CASH_ID = CASH_ID ) ") \
	_T(" WHERE      1 = 1 %s") \
	_T(" GROUP      BY DOC_NO,NGAY_VAO,NGAY_RA,chindex,trunc(fac_posteddate),dept_id, invoice_date ") \
	_T(" ORDER      BY trunc(fac_posteddate) %s "), szWhere, szOrderBy);*/
	//Case when like this very very...
	//Chi tiet theo bao cao tong hop khoa thuc hien//

	//1. Tien kham ne//
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,       ") \
				_T("       f.hfe_patpaid as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_itemid <> 'D0000006'") \
				_T("     AND f.hfe_patpaid       >0") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN (f.hfe_type ='B' OR f.hfe_itemid='D0000006')") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       f.hfe_patpaid as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND (F.Hfe_Group     IN ('C0000') OR f.hfe_itemid='D0000006')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND su_deptid       IS NOT NULL") \
				_T("         THEN Su_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND su_deptid       IS NOT NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				//_T("         AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,") \//
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T(" AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_patpaid as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       f.hfe_patpaid as TIEN_PTTT,") \//				
				_T("       CASE WHEN HFE_FEEGROUP='HITECH_A' AND HFE_TREAT_INPACKAGE='Y' THEN f.hfe_cost else f.hfe_patpaid end as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       f.hfe_patpaid as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND iv.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       f.hfe_patpaid as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND iv.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       f.hfe_patpaid as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND iv.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       f.hfe_patpaid as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND iv.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       f.hfe_patpaid AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno    = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno        = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       f.hfe_patpaid AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno    = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno        = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_patpaid as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_patpaid as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = fi.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = fi.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       f.hfe_patpaid as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);
    //Update ngay 03/06/2017//
	// Them vao 2 cot tinh tien thuoc trong goi & tien vat tu trong goi//
	//16. Phi tien thuoc trong goi//
 szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       f.hfe_patpaid as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//17.Phi tien vat tu trong goi//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_patpaid as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//18.Phi thuoc trong goi, dung cho truong hop thu phi PTTT truoc sau do moi nhap thuoc trong goi o phong kham//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv ON (ho_docno = iv.hfe_docno AND ho_INVOICENO = iv.hfe_invoiceno)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//19.Phi tien vat tu trong goi, dung cho truong hop thu phi PTTT truoc nhap vat tu sau//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv ON (ho_docno = iv.hfe_docno AND ho_INVOICENO = iv.hfe_invoiceno)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);

		//20. Phi thu goi, them vao ngay 13/11/2018//
szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       iv.hfe_cash_id,") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       iv.hfe_class,") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_patpaid as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
				_T("     AND iv.hfe_docno     = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);

rs.ExecSQL(szSQL);
				//_msg(_T("%s"), szSQL);
	/*_msg(_T("%s"), szSQL1);
	_msg(_T("%s"), szSQL2);	
	_msg(_T("%s"), szSQL3);	
	_msg(_T("%s"), szSQL4);	
	_msg(_T("%s"), szSQL5);	
	_msg(_T("%s"), szSQL6);	
	_msg(_T("%s"), szSQL7);	
	_msg(_T("%s"), szSQL8);	
	_msg(_T("%s"), szSQL9);	
	_msg(_T("%s"), szSQL10);	
	_msg(_T("%s"), szSQL11);
	_msg(_T("%s"), szSQL12);
	_msg(_T("%s"), szSQL13);
	_msg(_T("%s"), szSQL14);
	_msg(_T("%s"), szSQL15);
	_msg(_T("%s"), szSQL16);
	_msg(_T("%s"), szSQL17);
	_msg(_T("%s"), szSQL18);
	_msg(_T("%s"), szSQL19);
	_msg(_T("%s"), szWhere1);*/
   szSQL.Format(_T(" SELECT") \
				_T(" dept_id,") \
				_T(" SUM(TIEN_KHAM) as TIEN_KHAM,") \
				_T(" SUM(TIEN_GIUONG) as TIEN_GIUONG,") \
				_T(" SUM(TIEN_CLS) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT) as TIEN_PTTT,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_PM) AS TIEN_THUOC_PM,") \
				_T(" SUM(TIEN_VAT_TU_PM) AS TIEN_VAT_TU_PM,") \
				_T(" SUM(TIEN_MAU) as TIEN_MAU,") \
				_T(" SUM(THU_KHAC) as THU_KHAC,") \
				_T(" SUM(THU_GOI) as THU_GOI,") \
				_T(" SUM(TIEN_AN) as TIEN_AN,") \
				_T(" SUM(TIEN_THUOC_TG+TIEN_THUOC_TG_O) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG+TIEN_VAT_TU_TG_O) as TIEN_VAT_TU_TG,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI) as TONG_THU,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_THUOC_TG+TIEN_VAT_TU_TG) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(hfe_docno) as HO_TEN,") \
				_T("   hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    trunc(hfe_date) as invoice_date,") \
				_T("    trunc(FAC_POSTEDDATE) as posted_date,") \
				_T("    khoa_thuchien as dept_id,") \
				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     hfe_itemid") \
				_T("   FROM") \
				_T("     (") \
				_T("    %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s ") \
				//_T("    %s %s ") \//
				_T("   )tbl1") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=tbl1.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=tbl1.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=tbl1.HFE_DOCNO)") \
				_T("   WHERE 1=1 AND (TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_THUOC_TG+TIEN_VAT_TU_TG+TIEN_THUOC_TG_O+TIEN_VAT_TU_TG_O)>0 %s") \
				_T("   )") \
				_T(" GROUP BY ") \
				_T(" dept_id") \
				_T(" ORDER BY dept_id"),szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24, szWhere1);
	return szSQL;
}
CString CFMServicePaidSummaryByDept_2024::GetQueryString3()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2;
	CString szSQL21,szSQL22,szSQL23,szSQL24, szOrderBy, szReceiptStr;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));

	//szWhere.Format(_T(" and iv.hfe_cash_id in(%s) "), szReceiptStr);
	
	if (nCount <1000)
		szWhere.Format(_T(" AND iv.hfe_cash_id in(%s) "), szReceiptStr);
	else
	{
		CStringToken tok_id(szReceiptStr);
		int nCount = 0;
		long nTemp = 0;
		CString szIds, tmpStr;
		bool bBreak = false;
		szIds.Empty();
		tmpStr.Empty();
		for (int i = 0; i < tok_id.GetSize(); i++)
		{
			if (nCount > 999)
			{
				bBreak = true;
			}
			if (bBreak)
			{
				if (!szIds.IsEmpty())
				{
					szIds += _T(" OR ");
				}
				szIds.AppendFormat(_T(" iv.hfe_cash_id IN (%s) "), tmpStr);
				tmpStr.Empty();
				nCount = 0;
				bBreak = false;
			}
			if (!tmpStr.IsEmpty())
			{
				tmpStr += _T(",");
			}
			tok_id.GetAt(i, nTemp);
			tmpStr.AppendFormat(_T("%ld"), nTemp);
			nCount++;
		}
		if (!szIds.IsEmpty())
		{
			szIds += _T(" OR ");
		}
		szIds.AppendFormat(_T(" iv.hfe_cash_id IN (%s) "), tmpStr);
		szWhere.Format(_T(" AND (%s)"), szIds);
	}
	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);

	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/

	if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	
			szSQL.Format(_T(" SELECT HO_TEN,") \
			_T("   docno,") \
			_T("   NGAY_VAO,") \
			_T("   NGAY_RA,") \
			_T("   posted_date,") \
			_T("   CHINDEX,  ") \
			_T("   dept_id,") \
			_T("   SUM(TIEN_CLS)  AS TIEN_CLS,") \
			_T("   SUM(TIEN_MAU) AS TIEN_MAU,") \
			_T("   SUM(THU_KHAC) AS THU_KHAC, ") \
			_T("   SUM(TIEN_CLS+TIEN_MAU+THU_KHAC) AS TONG_THU") \
			_T("   FROM") \
			_T("   (SELECT Get_patientname(hfe_docno) AS HO_TEN,") \
			_T("     hfe_docno                        AS docno,") \
			_T("     CASE") \
			_T("       WHEN HFE_CLASS = 'I'") \
			_T("       THEN HCR_ADMITDATE") \
			_T("       ELSE HD_ADMITDATE") \
			_T("     END NGAY_VAO,") \
			_T("     CASE") \
			_T("       WHEN HFE_CLASS = 'I'") \
			_T("       THEN HCR_DISCHARGEDATE") \
			_T("       ELSE HD_ENDDATE") \
			_T("     END NGAY_RA,") \
			_T("     CASE") \
			_T("       WHEN HFE_CLASS = 'I'") \
			_T("       THEN 'I'") \
			_T("       ELSE 'II'") \
			_T("     END CHINDEX,") \
			_T("     TRUNC(hfe_date)       AS invoice_date,") \
			_T("     TRUNC(FAC_POSTEDDATE) AS posted_date,") \
			_T("     khoa_thuchien         AS dept_id,   ") \
			_T("     TIEN_CLS,   ") \
			_T("     TIEN_MAU,") \
			_T("     THU_KHAC,") \
			_T("     hfe_itemid") \
			_T("   FROM") \
			_T("     (") \
			_T("     SELECT f.hfe_docno,") \
			_T("       f.hfe_type,") \
			_T("       f.hfe_invoiceno,") \
			_T("       f.hfe_date,") \
			_T("       iv.hfe_cash_id,") \
			_T("       0 AS hfe_quantity,") \
			_T("       CASE") \
			_T("         WHEN f.hfe_type IN ('P','T')") \
			_T("         AND F.Hfe_Group IN ('B1G00','B1800')") \
			_T("         THEN CAST(DECODE(f.Hfe_Group,'B1G00', 'C16', 'B1800','C16') AS NVARCHAR2(3))") \
			_T("       END khoa_thuchien,") \
			_T("       f.hfe_itemid,") \
			_T("       iv.hfe_class,      ") \
			_T("       f.hfe_patpaid AS TIEN_CLS,      ") \
			_T("       0             AS TIEN_MAU,") \
			_T("       0             AS THU_KHAC, ") \
			_T("       f.hfe_category") \
			_T("     FROM hms_fee f") \
			_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
			_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
			_T("     AND iv.hfe_docno     = f.hfe_docno)") \
			_T("     WHERE 1              =1 %s") \
			_T("     AND f.hfe_status   IN ('P','R')") \
			_T("     AND F.Hfe_Group    IN ('B1B00','B1G00','B1800','B2500')") \
			_T("     AND f.hfe_type     <> 'X'") \
			_T("     AND f.hfe_category IN ('N','BQP','COV','XX')   ") \
			_T("     AND f.hfe_itemid NOT IN (SELECT NVL(mp_value,'XXX') FROM m_product WHERE mp_org_id='BB') ") \
			_T("     UNION ALL") \
			_T("     SELECT f.hfe_docno,") \
			_T("       f.hfe_type,") \
			_T("       f.hfe_invoiceno,") \
			_T("       f.hfe_date,") \
			_T("       iv.hfe_cash_id,") \
			_T("       0 AS hfe_quantity,") \
			_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
			_T("       f.hfe_itemid,") \
			_T("       iv.hfe_class,     ") \
			_T("       0             AS TIEN_CLS,     ") \
			_T("       f.hfe_patpaid AS TIEN_MAU,") \
			_T("       0             AS THU_KHAC,") \
			_T("       f.hfe_category") \
			_T("     FROM hms_fee f") \
			_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
			_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
			_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
			_T("     ON (hpo_orderid = f.hfe_orderid)") \
			_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
			_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
			_T("     AND iv.hfe_docno     = f.hfe_docno)") \
			_T("     WHERE 1              =1 %s") \
			_T("     AND f.hfe_status       IN ('P','R')") \
			_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
			_T("     AND product_org_id     IN ('BB')") \
			_T("     AND hfe_category       IN ('N','BQP','COV','XX')") \
			_T("     UNION ALL") \
			_T("     SELECT f.hfe_docno,") \
			_T("       f.hfe_type,") \
			_T("       f.hfe_invoiceno,") \
			_T("       f.hfe_date,") \
			_T("       iv.hfe_cash_id,") \
			_T("       0 AS hfe_quantity,") \
			_T("       CASE") \
			_T("         WHEN f.hfe_class IN ('X','I','E')") \
			_T("         AND f.hfe_type    ='X'") \
			_T("         AND f.HFE_DEPTID IS NOT NULL") \
			_T("         THEN f.HFE_DEPTID") \
			_T("         ELSE fl.HFL_DEPTID") \
			_T("       END khoa_thuchien,") \
			_T("       f.hfe_itemid,") \
			_T("       iv.hfe_class,     ") \
			_T("       0             AS TIEN_CLS,      ") \
			_T("       f.hfe_patpaid AS TIEN_MAU,") \
			_T("       0 AS THU_KHAC,     ") \
			_T("       f.hfe_category") \
			_T("     FROM hms_fee f") \
			_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
			_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
			_T("     AND iv.hfe_docno     = f.hfe_docno)") \
			_T("     LEFT JOIN Hms_Fee_List fl") \
			_T("     ON (F.Hfe_Itemid    =fl.hfl_feeid)") \
			_T("     WHERE 1             =1 %s") \
			_T("     AND f.hfe_status     IN ('P','R')") \
			_T("     AND f.hfe_class      IN ('X','I','E')") \
			_T("     AND f.hfe_type        ='X'") \
			_T("     AND fl.hfl_deptid='C16'") \
			_T("     AND f.hfe_category IN ('N','BQP','COV','XX','P')") \
			_T("     AND f.hfe_itemid <> 'F0000063'") \

			_T("     UNION ALL") \
			_T("     SELECT f.hfe_docno,") \
			_T("       f.hfe_type,") \
			_T("       f.hfe_invoiceno,") \
			_T("       f.hfe_date,") \
			_T("       iv.hfe_cash_id,") \
			_T("       0 AS hfe_quantity,") \
			_T("       CASE") \
			_T("         WHEN f.hfe_class IN ('X','I','E')") \
			_T("         AND f.hfe_type    ='X'") \
			_T("         AND f.HFE_DEPTID IS NOT NULL") \
			_T("         THEN f.HFE_DEPTID") \
			_T("         ELSE fl.HFL_DEPTID") \
			_T("       END khoa_thuchien,") \
			_T("       f.hfe_itemid,") \
			_T("       iv.hfe_class,     ") \
			_T("       f.hfe_patpaid AS TIEN_CLS, ") \
			_T("       0 AS TIEN_MAU,") \
			_T("       0 AS THU_KHAC,     ") \
			_T("       f.hfe_category") \
			_T("     FROM hms_fee f") \
			_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
			_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
			_T("     AND iv.hfe_docno     = f.hfe_docno)") \
			_T("     LEFT JOIN Hms_Fee_List fl") \
			_T("     ON (F.Hfe_Itemid    =fl.hfl_feeid)") \
			_T("     WHERE 1             =1 %s") \
			_T("     AND f.hfe_status     IN ('P','R')") \
			_T("     AND f.hfe_class      IN ('X','I','E')") \
			_T("     AND f.hfe_type        ='X'") \
			_T("     AND fl.hfl_deptid='C16'") \
			_T("     AND f.hfe_category IN ('N','BQP','COV','XX','P')") \
			_T("     AND f.hfe_itemid = 'F0000063'") \



			_T("     UNION ALL") \
			_T("     SELECT f.hfe_docno,") \
			_T("       f.hfe_type,") \
			_T("       f.hfe_invoiceno,") \
			_T("       f.hfe_date,") \
			_T("       iv.hfe_cash_id,") \
			_T("       0 AS hfe_quantity,") \
			_T("       CASE") \
			_T("         WHEN f.hfe_type IN ('P','T')") \
			_T("         AND F.Hfe_Group IN ('B1G00','B1800')") \
			_T("         THEN CAST(DECODE(f.Hfe_Group,'B1G00', 'C16', 'B1800','C16') AS NVARCHAR2(3))") \
			_T("       END khoa_thuchien,") \
			_T("       f.hfe_itemid,") \
			_T("       iv.hfe_class,      ") \
			_T("       0             AS TIEN_CLS,      ") \
			_T("       f.hfe_patpaid AS TIEN_MAU,") \
			_T("       0             AS THU_KHAC, ") \
			_T("       f.hfe_category") \
			_T("     FROM hms_fee f") \
			_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
			_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
			_T("     AND iv.hfe_docno     = f.hfe_docno)") \
			_T("     WHERE 1              =1 %s") \
			_T("     AND f.hfe_status   IN ('P','R')") \
			_T("     AND F.Hfe_Group    IN ('B1B00','B1G00','B1800','B2500')") \
			_T("     AND f.hfe_type     <> 'X'") \
			_T("     AND f.hfe_category IN ('N','BQP','COV','XX')   ") \
			_T("     AND f.hfe_itemid IN (SELECT NVL(mp_value,'XXX') FROM m_product WHERE mp_org_id='BB') ") \
			_T("     )tbl1") \
			_T(" LEFT JOIN FA_CASH fc") \
			_T("   ON (fc.FAC_CASH_ID=tbl1.hfe_cash_id)") \
			_T("   LEFT JOIN HMS_DOC d") \
			_T("   ON ( d.HD_DOCNO=tbl1.HFE_DOCNO)") \
			_T("   LEFT JOIN HMS_CLINICAL_RECORD cr") \
			_T("   ON ( cr.HCR_DOCNO                                                                                                                                                                                                                                                    =tbl1.HFE_DOCNO)") \
			_T("   WHERE 1                                                                                                                                                                                                                                                              =1") \
			_T("   AND (TIEN_MAU + THU_KHAC + TIEN_CLS)>0") \
			_T("   AND khoa_thuchien='C16'") \
			_T("   )") \
			_T(" GROUP BY HO_TEN,") \
			_T("   docno,") \
			_T("   NGAY_VAO,") \
			_T("   NGAY_RA,") \
			_T("   CHINDEX,") \
			_T("   posted_date,") \
			_T("   dept_id") \
			_T(" ORDER BY dept_id, posted_date"), szWhere,szWhere,szWhere,szWhere, szWhere);
	return szSQL;
}
int CFMServicePaidSummaryByDept_2024::OnListCheckAllInvoice()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;	
	int nCheck = 0;
	for (int k=0; k<m_wndList.GetItemCount(); k++)	
	{
		szItemText=m_wndList.GetItemText(k,1);
		if ((_T("PT"))==szItemText.Left(2))
		{
			m_wndList.SetCheck(k, true);
			nCheck++;
		}	
	else m_wndList.SetCheck(k, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}
int CFMServicePaidSummaryByDept_2024::OnListCheckAllRefund()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;	
	int nCheck = 0;
	for (int j=0; j<m_wndList.GetItemCount(); j++)	
	{
		szItemText=m_wndList.GetItemText(j,1);
	if ((_T("PC"))==szItemText.Left(2))
	{
		m_wndList.SetCheck(j, true);
		nCheck++;
	}	
	else m_wndList.SetCheck(j, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}

void CFMServicePaidSummaryByDept_2024::OnExport4()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1, i = 0;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
		{
			nTotal[i] = 0;
			nGroupTotal[i] = 0;
		}
	CExcel xls;
	if (!xls.Load(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_HAUCAN.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetSheetName(_T("Sheet 0"));
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);

	szSQL = GetQueryString4();
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	
	nRow = 9;
	nCol = 0;
	
	while(!rs.IsEOF())
	{
		int i = 0;
		if(nRow == 65000)
		{
			i++;
			tmpStr.Format(_T("Sheet %d"), i);
			xls.AddSheet(tmpStr);
			xls.SetWorksheet(i);
			nRow = 1;
		}

		rs.GetValue(_T("dept_id"), szNewDept);
		if (!szNewDept.IsEmpty() && szOldDept != szNewDept)
		{
			if (nGroupTotal[10] > 0)
			{
				xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);

				for(int i = 7; i < 30; i++)
				{
					xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
					nTotal[i] += nGroupTotal[i];
					nGroupTotal[i] = 0;
				}
				nRow++;
			}
			xls.SetCellText(0, nRow, szNewDept, FMT_TEXT, true);
			szOldDept = szNewDept;
			nIdx = 1;
			nRow++;
		}
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("HO_TEN"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("docno"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_INTEGER);
		
		rs.GetValue(_T("dept_id"), tmpStr);
		xls.SetCellText(nCol+3, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("NGAY_VAO"), tmpStr);
		xls.SetCellText(nCol+4,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);

		rs.GetValue(_T("NGAY_RA"), tmpStr);
		xls.SetCellText(nCol+5,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);	

		rs.GetValue(_T("posted_date"), tmpStr);
		xls.SetCellText(nCol+6,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);		

		rs.GetValue(_T("TIEN_GOI"), nTemp);
		nGroupTotal[7] += nTemp;
		xls.SetCellText(nCol+7, nRow, double2str(nTemp), FMT_NUMBER1);
		
		rs.GetValue(_T("TIEN_VTHC"), nTemp);
		nGroupTotal[8] += nTemp;
		xls.SetCellText(nCol+8, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIENAN_HC"), nTemp);
		nGroupTotal[9] += nTemp;
		xls.SetCellText(nCol+9, nRow, double2str(nTemp), FMT_NUMBER1);		

		rs.GetValue(_T("TONG_THU"), nTemp);
		nGroupTotal[10] += nTemp;
		xls.SetCellText(nCol+10, nRow, double2str(nTemp), FMT_NUMBER1);		
			
		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[10] > 0)
	{
		xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
			nTotal[i] += nGroupTotal[i];
		}
		nRow++;
	}

	if (nTotal[10] > 0)
	{
		xls.SetCellText(6, nRow, _T("T\x1ED5ng \x63\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nTotal[i]), FMT_NUMBER1, true);
		}
		nRow++;
	}

	xls.SetActiveSheet(0);
	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_HAUCAN_1.xls"));
}
CString CFMServicePaidSummaryByDept_2024::GetQueryString4()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2;
	CString szSQL21,szSQL22,szSQL23,szSQL24, szOrderBy, szReceiptStr;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));

	//szWhere.Format(_T(" and iv.hfe_cash_id in(%s) "), szReceiptStr);
	
	if (nCount <1000)
		szWhere.Format(_T(" AND iv.hfe_cash_id in(%s) "), szReceiptStr);
	else
	{
		CStringToken tok_id(szReceiptStr);
		int nCount = 0;
		long nTemp = 0;
		CString szIds, tmpStr;
		bool bBreak = false;
		szIds.Empty();
		tmpStr.Empty();
		for (int i = 0; i < tok_id.GetSize(); i++)
		{
			if (nCount > 999)
			{
				bBreak = true;
			}
			if (bBreak)
			{
				if (!szIds.IsEmpty())
				{
					szIds += _T(" OR ");
				}
				szIds.AppendFormat(_T(" iv.hfe_cash_id IN (%s) "), tmpStr);
				tmpStr.Empty();
				nCount = 0;
				bBreak = false;
			}
			if (!tmpStr.IsEmpty())
			{
				tmpStr += _T(",");
			}
			tok_id.GetAt(i, nTemp);
			tmpStr.AppendFormat(_T("%ld"), nTemp);
			nCount++;
		}
		if (!szIds.IsEmpty())
		{
			szIds += _T(" OR ");
		}
		szIds.AppendFormat(_T(" iv.hfe_cash_id IN (%s) "), tmpStr);
		szWhere.Format(_T(" AND (%s)"), szIds);
	}
	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);

	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/

	if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	
			szSQL.Format(_T(" SELECT HO_TEN,") \
						_T("   docno,") \
						_T("   NGAY_VAO,") \
						_T("   NGAY_RA,") \
						_T("   posted_date,") \
						_T("   CHINDEX,") \
						_T("   dept_id,") \
						_T("   SUM(TIEN_GOI)                   AS TIEN_GOI,") \
						_T("   SUM(TIEN_VTHC)                   AS TIEN_VTHC,") \
						_T("   SUM(TIENAN_HC)                   AS TIENAN_HC,") \
						_T("   SUM(TIEN_GOI+TIEN_VTHC+TIENAN_HC) AS TONG_THU") \
						_T(" FROM") \
						_T("   (SELECT Get_patientname(hfe_docno) AS HO_TEN,") \
						_T("     hfe_docno                        AS docno,") \
						_T("     CASE") \
						_T("       WHEN HFE_CLASS = 'I'") \
						_T("       THEN HCR_ADMITDATE") \
						_T("       ELSE HD_ADMITDATE") \
						_T("     END NGAY_VAO,") \
						_T("     CASE") \
						_T("       WHEN HFE_CLASS = 'I'") \
						_T("       THEN HCR_DISCHARGEDATE") \
						_T("       ELSE HD_ENDDATE") \
						_T("     END NGAY_RA,") \
						_T("     CASE") \
						_T("       WHEN HFE_CLASS = 'I'") \
						_T("       THEN 'I'") \
						_T("       ELSE 'II'") \
						_T("     END CHINDEX,") \
						_T("     TRUNC(hfe_date)       AS invoice_date,") \
						_T("     TRUNC(FAC_POSTEDDATE) AS posted_date,") \
						_T("     khoa_thuchien         AS dept_id,") \
						_T("     TIEN_GOI,") \
						_T("     TIEN_VTHC,") \
						_T("     TIENAN_HC,  ") \
						_T("     hfe_itemid") \
						_T("   FROM") \
						_T("     (SELECT f.hfe_docno,") \
						_T("       f.hfe_type,") \
						_T("       f.hfe_invoiceno,") \
						_T("       f.hfe_date,") \
						_T("       iv.hfe_cash_id,") \
						_T("       0 AS hfe_quantity,") \
						_T("        CASE") \
						_T("         WHEN f.hfe_class IN ('X','I','E')") \
						_T("         AND f.hfe_type    ='X'") \
						_T("         AND f.HFE_DEPTID IS NOT NULL") \
						_T("         THEN f.HFE_DEPTID") \
						_T("         ELSE fl.HFL_DEPTID") \
						_T("       END khoa_thuchien,") \
						_T("       f.hfe_itemid,") \
						_T("       iv.hfe_class,") \
						_T("       f.hfe_patpaid AS TIEN_GOI,") \
						_T("       0             AS TIEN_VTHC,") \
						_T("       0             AS TIENAN_HC,") \
						_T("       f.hfe_category") \
						_T("     FROM hms_fee f") \
						_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
						_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
						_T("     AND iv.hfe_docno     = f.hfe_docno)") \
						_T("     LEFT JOIN Hms_Fee_List fl") \
						_T("     ON (F.Hfe_Itemid    =fl.hfl_feeid)") \
						_T("     WHERE 1              =1 %s") \
						_T("     AND f.hfe_status   IN ('P','R')") \
						_T("     AND f.hfe_class    IN ('X','I','E')") \
						_T("     AND f.hfe_type      ='X'") \
						_T("     AND f.hfe_itemid   IN") \
						_T("       (SELECT ss_code FROM sys_sel WHERE ss_id='HMS_SERVICE_PACKAGE'") \
						_T("       )") \
						_T("     AND f.hfe_category NOT IN ('Y')") \
						_T(" UNION ALL") \
						_T("     SELECT f.hfe_docno,") \
						_T("       f.hfe_type,") \
						_T("       f.hfe_invoiceno,") \
						_T("       f.hfe_date,") \
						_T("       iv.hfe_cash_id,") \
						_T("       0 AS hfe_quantity,") \
						//_T("       CAST(DECODE(product_org_id, 'HC', 'KTHC') AS NVARCHAR2(15)) khoa_thuchien,") \//
						_T("       f.hfe_deptid as khoa_thuchien,") \
						_T("       f.hfe_itemid,") \
						_T("       iv.hfe_class,") \
						_T("       0             AS TIEN_GOI,") \
						_T("       f.hfe_patpaid AS TIEN_VTHC,") \
						_T("       0             AS TIENAN_HC,") \
						_T("       f.hfe_category") \
						_T("     FROM hms_fee f") \
						_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
						_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
						_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
						_T("     ON (hpo_orderid = f.hfe_orderid)") \
						_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
						_T("     ON (iv.hfe_invoiceno    = f.hfe_invoiceno") \
						_T("     AND iv.hfe_docno        = f.hfe_docno)") \
						_T("     WHERE 1                 =1 %s") \
						_T("     AND f.hfe_status       IN ('P','R')") \
						_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
						_T("     AND product_org_id     IN ('HC')") \
						_T("     AND hfe_category       IN ('Y')") \
						_T("     UNION ALL") \
						_T("     SELECT f.hfe_docno,") \
						_T("       f.hfe_type,") \
						_T("       f.hfe_invoiceno,") \
						_T("       f.hfe_date,") \
						_T("       iv.hfe_cash_id,") \
						_T("       0 AS hfe_quantity,") \
						_T("       CASE") \
						_T("         WHEN f.hfe_deptid IN ('C1.1', 'C1.2','C1.3', 'AB')") \
						_T("         THEN HCR_ADMITDEPT") \
						_T("         ELSE f.hfe_deptid") \
						_T("       END AS khoa_thuchien,") \
						_T("       f.hfe_itemid,") \
						_T("       iv.hfe_class,") \
						_T("       0             AS TIEN_GOI,") \
						_T("       0             AS TIEN_VTHC,") \
						_T("       f.hfe_patpaid AS TIENAN_HC,") \
						_T("       f.hfe_category") \
						_T("     FROM hms_fee f") \
						_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_SERVICE iv") \
						_T("     ON (iv.hfe_invoiceno = f.hfe_invoiceno") \
						_T("     AND iv.hfe_docno     = f.hfe_docno)") \
						_T("     LEFT JOIN HMS_CLINICAL_RECORD") \
						_T("     ON (f.hfe_docno     =hcr_docno)") \
						_T("     WHERE 1             =1 %s") \
						_T("     AND f.hfe_status   IN ('P','R')") \
						_T("     AND F.Hfe_Group    IN ('FF000')") \
						_T("     AND f.hfe_category IN ('Y')") \
						_T("  )tbl1") \
						_T("   LEFT JOIN FA_CASH fc") \
						_T("   ON (fc.FAC_CASH_ID=tbl1.hfe_cash_id)") \
						_T("   LEFT JOIN HMS_DOC d") \
						_T("   ON ( d.HD_DOCNO=tbl1.HFE_DOCNO)") \
						_T("   LEFT JOIN HMS_CLINICAL_RECORD cr") \
						_T("   ON ( cr.HCR_DOCNO                   =tbl1.HFE_DOCNO)") \
						_T("   WHERE 1                             =1") \
						_T("   AND (TIEN_GOI + TIEN_VTHC + TIENAN_HC)>0  ") \
						_T("   )") \
						_T(" GROUP BY HO_TEN,") \
						_T("   docno,") \
						_T("   NGAY_VAO,") \
						_T("   NGAY_RA,") \
						_T("   CHINDEX,") \
						_T("   posted_date,") \
						_T("   dept_id") \
						_T(" ORDER BY dept_id,") \
						_T("   posted_date"), szWhere,szWhere,szWhere);			
	return szSQL;
}

CString CFMServicePaidSummaryByDept_2024::GetQueryString2_v2()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2;
	CString szOrderBy, szReceiptStr, szSQL21,szSQL22, szSQL23, szSQL24, szSQL25, szSQL26;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	/*
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));

	//szWhere.Format(_T(" and iv.hfe_cash_id in(%s) "), szReceiptStr);
	
	if (nCount <1000)
	{
		szWhere1.Format(_T(" AND fac_cash_id in(%s) "), szReceiptStr);
	}
	else
	{
		szWhere1.AppendFormat(_T(" and fac_cash_id in (select fac_cash_id from tbl)"));
	}
	*/
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}
	//szReceiptStr2.Format(_T(" fac_cash_id IN (%s)"), szReceiptStr);

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));
	if (nCount < m_wndList.GetItemCount() && nCount > 0)
	{
		if (nCount <1000)
		{
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND fac_cash_id in(%s)) "), szReceiptStr);
		}
		else
		{
			CStringToken tok_id(szReceiptStr);
			int nCount = 0;
			long nTemp = 0;
			CString szIds, tmpStr;
			bool bBreak = false;
			szIds.Empty();
			tmpStr.Empty();
			for (int i = 0; i < tok_id.GetSize(); i++)
			{
				if (nCount > 999)
				{
					bBreak = true;
				}
				if (bBreak)
				{
					if (!szIds.IsEmpty())
					{
						szIds += _T(" OR ");
					}
					szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
					//_tprintf(_T("\nszIds: %s\n"), szIds);
					tmpStr.Empty();
					nCount = 0;
					bBreak = false;
				}
				if (!tmpStr.IsEmpty())
				{
					tmpStr += _T(",");
				}
				tok_id.GetAt(i, nTemp);
				tmpStr.AppendFormat(_T("%ld"), nTemp);
				nCount++;
			}
			if (!szIds.IsEmpty())
			{
				szIds += _T(" OR ");
			}
			szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND (%s))"), szIds);
		}
	}
	else
	{
		szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl)"));
	}


	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);
	szWhere.Empty();
	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/

	if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}	
	
	//Case when like this very very...
	//Chi tiet theo bao cao tong hop khoa thuc hien//
	if (m_bSOD)
	//if (0>1)
{
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				_T("       f.hfe_cost as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_itemid <> 'D0000006'") \
				_T("     AND f.hfe_cost>0") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN (f.hfe_type ='B' OR f.hfe_itemid='D0000006')") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       f.hfe_cost as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND (F.Hfe_Group     IN ('C0000') OR f.hfe_itemid='D0000006')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				/*_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND su_deptid       IS NOT NULL") \
				_T("         THEN Su_Deptid") \
				_T("       END khoa_thuchien,") \*/

				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND su_deptid is not NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				//_T("         AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,") \//
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T("       AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20', 'B1E00', 'C5') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				//_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \//
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				//_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \//
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       f.hfe_cost AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       f.hfe_cost AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P', 'COV', 'BN')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       f.hfe_cost as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
 //25. Miễn giảm tính vào khoa thanh toán cuối cùng//
 szSQL26.Format(_T(" UNION ALL") \
				_T("     SELECT hfd.hfe_docno,") \
				_T("       hfd.hfe_type,") \
				_T("       ivf.hfe_invoiceno,") \
				_T("       ivf.hfe_date,") \
				_T("       0 AS hfe_quantity,     ") \
				_T("       hfd.HFE_DEPTID AS khoa_thuchien,") \
				_T("       NULL,") \
				_T("       0             AS TIEN_KHAM,") \
				_T("       0             AS TIEN_GIUONG,") \
				_T("       0             AS TIEN_CLS,") \
				_T("       0             AS TIEN_PTTT,") \
				_T("       0             AS TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0             AS TIEN_THUOC_CH_NOITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0             AS TIEN_THUOC_PM,") \
				_T("       0             AS TIEN_VAT_TU_PM,") \
				_T("       0             AS TIEN_MAU,") \
				_T("       0             AS THU_KHAC,") \
				_T("       0             AS THU_GOI,") \
				_T("       0             AS TIEN_AN,") \
				_T("       0             AS TIEN_AN_HC,") \
				_T("       0             AS TIEN_THUOC_TG,") \
				_T("       0             AS TIEN_VAT_TU_TG,") \
				_T("       0             AS TIEN_THUOC_TG_O,") \
				_T("       0             AS TIEN_VAT_TU_TG_O,") \
				_T("       hfd.hfe_amount             AS MIEN_GIAM,") \
				_T("       NULL") \
				_T("     FROM hms_fee_discount hfd") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_DISCOUNT ivf") \
				_T("     ON (hfd.hfe_docno =ivf.hfe_docno") \
				_T("     AND hfd.hfe_refidx=ivf.hfe_invoiceno)") \
				_T("     WHERE 1             =1 %s") \
				_T("     AND hfd.hfe_status  IN ('P')") \
				_T("     AND hfd.hfe_type    IN ('D') "), szWhere);
    //Update ngay 03/06/2017//
	// Them vao 2 cot tinh tien thuoc trong goi & tien vat tu trong goi//
	//16. Phi tien thuoc trong goi//
 //16. Phi tien thuoc trong goi PTTT//
 //Ngày 06/05/2020 Comment lại szSQL18 / szSQL19 / szSQL20 / szSQL21
 //Sửa sang tiêu chí mới để phục vụ cho TTDTHM toàn thu tiền trước nhập vật tư sau // 

 /*szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//17.Phi tien vat tu trong goi//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				//_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \//
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (coalesce(ho_group, hpc_groupid) = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//18.Phi thuoc trong goi, dung cho truong hop thu phi PTTT truoc sau do moi nhap thuoc trong goi o phong kham//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//19.Phi tien vat tu trong goi, dung cho truong hop thu phi PTTT truoc nhap vat tu sau//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);*/

		//20. Phi thu goi, them vao ngay 13/11/2018//
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				//_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \//
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);

szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
}
else
//Chuẩn từ đây
{
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_itemid <> 'D0000006'") \
				_T("     AND CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END       >0") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN (f.hfe_type ='B' OR f.hfe_itemid='D0000006')") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND (F.Hfe_Group     IN ('C0000') OR f.hfe_itemid='D0000006')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				/*_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND su_deptid       IS NOT NULL") \
				_T("         THEN Su_Deptid") \
				_T("       END khoa_thuchien,") \*/

				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND su_deptid is not NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				//_T("         AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,") \//
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T("       AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20', 'B1E00', 'C5') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       CASE WHEN HFE_FEEGROUP='HITECH_A' AND HFE_TREAT_INPACKAGE='Y' THEN f.hfe_cost else CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END end as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				//_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \//
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				//_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \//
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P', 'COV', 'BN')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
 //25. Miễn giảm tính vào khoa thanh toán cuối cùng//
 szSQL26.Format(_T(" UNION ALL") \
				_T("     SELECT hfd.hfe_docno,") \
				_T("       hfd.hfe_type,") \
				_T("       ivf.hfe_invoiceno,") \
				_T("       ivf.hfe_date,") \
				_T("       0 AS hfe_quantity,     ") \
				_T("       hfd.HFE_DEPTID AS khoa_thuchien,") \
				_T("       NULL,") \
				_T("       0             AS TIEN_KHAM,") \
				_T("       0             AS TIEN_GIUONG,") \
				_T("       0             AS TIEN_CLS,") \
				_T("       0             AS TIEN_PTTT,") \
				_T("       0             AS TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0             AS TIEN_THUOC_CH_NOITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0             AS TIEN_THUOC_PM,") \
				_T("       0             AS TIEN_VAT_TU_PM,") \
				_T("       0             AS TIEN_MAU,") \
				_T("       0             AS THU_KHAC,") \
				_T("       0             AS THU_GOI,") \
				_T("       0             AS TIEN_AN,") \
				_T("       0             AS TIEN_AN_HC,") \
				_T("       0             AS TIEN_THUOC_TG,") \
				_T("       0             AS TIEN_VAT_TU_TG,") \
				_T("       0             AS TIEN_THUOC_TG_O,") \
				_T("       0             AS TIEN_VAT_TU_TG_O,") \
				_T("       hfd.hfe_amount             AS MIEN_GIAM,") \
				_T("       NULL") \
				_T("     FROM hms_fee_discount hfd") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_DISCOUNT ivf") \
				_T("     ON (hfd.hfe_docno =ivf.hfe_docno") \
				_T("     AND hfd.hfe_refidx=ivf.hfe_invoiceno)") \
				_T("     WHERE 1             =1 %s") \
				_T("     AND hfd.hfe_status  IN ('P')") \
				_T("     AND hfd.hfe_type    IN ('D') "), szWhere);
    //Update ngay 03/06/2017//
	// Them vao 2 cot tinh tien thuoc trong goi & tien vat tu trong goi//
	//16. Phi tien thuoc trong goi//
 //16. Phi tien thuoc trong goi PTTT//
 //Ngày 06/05/2020 Comment lại szSQL18 / szSQL19 / szSQL20 / szSQL21
 //Sửa sang tiêu chí mới để phục vụ cho TTDTHM toàn thu tiền trước nhập vật tư sau // 

 /*szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//17.Phi tien vat tu trong goi//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				//_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \//
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (coalesce(ho_group, hpc_groupid) = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//18.Phi thuoc trong goi, dung cho truong hop thu phi PTTT truoc sau do moi nhap thuoc trong goi o phong kham//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//19.Phi tien vat tu trong goi, dung cho truong hop thu phi PTTT truoc nhap vat tu sau//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);*/

		//20. Phi thu goi, them vao ngay 13/11/2018//
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				//_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \//
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);

szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS MIEN_GIAM,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);

}
rs.ExecSQL(szSQL);
	
   szSQL.Format(_T(" WITH tbl AS (%s)") \
				_T(" SELECT") \
				_T(" dept_id,") \
				_T(" SUM(TIEN_KHAM) as TIEN_KHAM,") \
				_T(" SUM(TIEN_GIUONG) as TIEN_GIUONG,") \
				_T(" SUM(TIEN_CLS) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT) as TIEN_PTTT,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_PM) AS TIEN_THUOC_PM,") \
				_T(" SUM(TIEN_VAT_TU_PM) AS TIEN_VAT_TU_PM,") \
				_T(" SUM(TIEN_MAU) as TIEN_MAU,") \
				_T(" SUM(THU_KHAC) as THU_KHAC,") \
				_T(" SUM(THU_GOI) as THU_GOI,") \
				_T(" SUM(TIEN_AN) as TIEN_AN,") \
				_T(" SUM(TIEN_AN_HC) as TIEN_AN_HC,") \
				_T(" SUM(TIEN_THUOC_TG+TIEN_THUOC_TG_O) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG+TIEN_VAT_TU_TG_O) as TIEN_VAT_TU_TG,") \
				_T(" SUM(MIEN_GIAM) AS MIEN_GIAM,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI) as TONG_THU,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(iv.hfe_docno) as HO_TEN,") \
				_T("   iv.hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    trunc(hfe_date) as invoice_date,") \
				_T("    trunc(FAC_POSTEDDATE) as posted_date,") \
				_T("    khoa_thuchien as dept_id,") \
				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_AN_HC,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     MIEN_GIAM,") \
				_T("     hfe_itemid") \
				_T("   FROM HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=iv.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN  (") \
				_T("    %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s ") \
				//_T("    %s %s ") \//
				_T("   )tbl1 ON (iv.hfe_invoiceno = tbl1.hfe_invoiceno and iv.hfe_docno = tbl1.hfe_docno)") \
				_T("   WHERE 1=1 %s") \
				_T("   )") \
				_T(" GROUP BY ") \
				_T(" dept_id") \
				_T(" HAVING SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+") \
				_T("	TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+") \
				_T("	TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+TIEN_THUOC_TG_O+TIEN_VAT_TU_TG_O)>0") \
				_T(" ORDER BY dept_id"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szSQL26, szWhere1);
				//_T(" ORDER BY dept_id"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szWhere1);
	return szSQL;
}
void CFMServicePaidSummaryByDept_2024::OnExport7()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1, i = 0;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
		{
			nTotal[i] = 0;
			nGroupTotal[i] = 0;
		}
	CExcel xls;
	if (!xls.Load(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_EX.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetSheetName(_T("Sheet 0"));
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);

	
	szSQL = GetQueryString_v7();
	
	rs.ExecSQL(szSQL);
	//AfxMessageBox(szSQL);
	
	nRow = 9;
	nCol = 0;
	
	while(!rs.IsEOF())
	{
		int i = 0;
		if(nRow == 65000)
		{
			i++;
			tmpStr.Format(_T("Sheet %d"), i);
			xls.AddSheet(tmpStr);
			xls.SetWorksheet(i);
			nRow = 1;
		}

		rs.GetValue(_T("dept_id"), szNewDept);
		if (!szNewDept.IsEmpty() && szOldDept != szNewDept)
		{
			if (nGroupTotal[26] > 0)
			{
				xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);

				for(int i = 7; i < 30; i++)
				{
					xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
					nTotal[i] += nGroupTotal[i];
					nGroupTotal[i] = 0;
				}
				nRow++;
			}
			xls.SetCellText(0, nRow, szNewDept, FMT_TEXT, true);
			szOldDept = szNewDept;
			nIdx = 1;
			nRow++;
		}
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("HO_TEN"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("docno"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_INTEGER);		

		rs.GetValue(_T("total"), nTemp);
		nGroupTotal[3] += nTemp;
		xls.SetCellText(nCol+3, nRow, double2str(nTemp), FMT_NUMBER1);		
			
		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[3] > 0)
	{
		xls.SetCellText(2, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 3; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
			nTotal[i] += nGroupTotal[i];
		}
		nRow++;
	}

	if (nTotal[3] > 0)
	{
		xls.SetCellText(2, nRow, _T("T\x1ED5ng \x63\x1ED9ng"), FMT_TEXT, true);
		for(int i = 3; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nTotal[i]), FMT_NUMBER1, true);
		}
		nRow++;
	}

	xls.SetActiveSheet(0);
	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV2_EX.xls"));
}
CString CFMServicePaidSummaryByDept_2024::GetQueryString_v7()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2;
	CString szSQL21,szSQL22,szSQL23,szSQL24,szSQL25, szOrderBy, szReceiptStr, szWherebed;
	CRecord rs(&pMF->m_db);
	int nCount = 0;
	
	szReceiptStr = _T("-1");
	UpdateData(true);

	/*for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));

	//szWhere.Format(_T(" and iv.hfe_cash_id in(%s) "), szReceiptStr);
	
	if (nCount <1000)
		szWhere1.Format(_T(" AND iv.hfe_cash_id in(%s) "), szReceiptStr);
	else
	{
		CStringToken tok_id(szReceiptStr);
		int nCount = 0;
		long nTemp = 0;
		CString szIds, tmpStr;
		bool bBreak = false;
		szIds.Empty();
		tmpStr.Empty();
		for (int i = 0; i < tok_id.GetSize(); i++)
		{
			if (nCount > 999)
			{
				bBreak = true;
			}
			if (bBreak)
			{
				if (!szIds.IsEmpty())
				{
					szIds += _T(" OR ");
				}
				szIds.AppendFormat(_T(" iv.hfe_cash_id IN (%s) "), tmpStr);
				tmpStr.Empty();
				nCount = 0;
				bBreak = false;
			}
			if (!tmpStr.IsEmpty())
			{
				tmpStr += _T(",");
			}
			tok_id.GetAt(i, nTemp);
			tmpStr.AppendFormat(_T("%ld"), nTemp);
			nCount++;
		}
		if (!szIds.IsEmpty())
		{
			szIds += _T(" OR ");
		}
		szIds.AppendFormat(_T(" iv.hfe_cash_id IN (%s) "), tmpStr);
		szWhere1.Format(_T(" AND (%s)"), szIds);
	}*/

	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}
	//szReceiptStr2.Format(_T(" fac_cash_id IN (%s)"), szReceiptStr);

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));
	if (nCount < m_wndList.GetItemCount() && nCount > 0)
	{
		if (nCount <1000)
		{
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND fac_cash_id in(%s)) "), szReceiptStr);
		}
		else
		{
			CStringToken tok_id(szReceiptStr);
			int nCount = 0;
			long nTemp = 0;
			CString szIds, tmpStr;
			bool bBreak = false;
			szIds.Empty();
			tmpStr.Empty();
			for (int i = 0; i < tok_id.GetSize(); i++)
			{
				if (nCount > 999)
				{
					bBreak = true;
				}
				if (bBreak)
				{
					if (!szIds.IsEmpty())
					{
						szIds += _T(" OR ");
					}
					szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
					//_tprintf(_T("\nszIds: %s\n"), szIds);
					tmpStr.Empty();
					nCount = 0;
					bBreak = false;
				}
				if (!tmpStr.IsEmpty())
				{
					tmpStr += _T(",");
				}
				tok_id.GetAt(i, nTemp);
				tmpStr.AppendFormat(_T("%ld"), nTemp);
				nCount++;
			}
			if (!szIds.IsEmpty())
			{
				szIds += _T(" OR ");
			}
			szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND (%s))"), szIds);
		}
	}
	else
	{
		szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl)"));
	}

	szWhere.Empty();
	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);

	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/

	if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	if (m_bBED)
	{
		szWherebed.AppendFormat(_T(" AND SUM(SO_NGAY_DT)>0 "));	
	}

	//1. Tien kham ne//
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_itemid <> 'D0000006'") \
				_T("     AND CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END       >0") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN (f.hfe_type ='B' OR f.hfe_itemid='D0000006')") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND (F.Hfe_Group     IN ('C0000') OR f.hfe_itemid='D0000006')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				/*_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND su_deptid       IS NOT NULL") \
				_T("         THEN Su_Deptid") \
				_T("       END khoa_thuchien,") \*/

				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND su_deptid       IS NOT NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P','COV', 'BN')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				//_T("         AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,") \//
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P','COV', 'BN')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T("       AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20', 'B1E00', 'C5') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P','COV', 'BN')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       CASE WHEN HFE_FEEGROUP='HITECH_A' AND HFE_TREAT_INPACKAGE='Y' THEN f.hfe_cost else CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END end as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'P', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'P', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'P', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'P', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P', 'COV', 'BN')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);

 //15.1 Phi an hau can//
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
    // Update ngay 03/06/2017//
	// Them vao 2 cot tinh tien thuoc trong goi & tien vat tu trong goi//
	//16. Phi tien thuoc trong goi PTTT//
 //Ngày 06/05/2020 Comment lại szSQL18 / szSQL19 / szSQL20 / szSQL21
 //Sửa sang tiêu chí mới để phục vụ cho TTDTHM toàn thu tiền trước nhập vật tư sau // 
 /*szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//17.Phi tien vat tu trong goi//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (coalesce(ho_group, hpc_groupid) = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				//_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \//
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//18.Phi thuoc trong goi, dung cho truong hop thu phi PTTT truoc sau do moi nhap thuoc trong goi o phong kham//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//19.Phi tien vat tu trong goi, dung cho truong hop thu phi PTTT truoc nhap vat tu sau//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);*/
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				//_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \//
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);


		//20. Phi thu goi, them vao ngay 13/11/2018//
szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"),szWhere);

rs.ExecSQL(szSQL);
				//_msg(_T("%s"), szSQL);
	/*_msg(_T("%s"), szSQL1);
	_msg(_T("%s"), szSQL2);	
	_msg(_T("%s"), szSQL3);	
	_msg(_T("%s"), szSQL4);	
	_msg(_T("%s"), szSQL5);	
	_msg(_T("%s"), szSQL6);	
	_msg(_T("%s"), szSQL7);	
	_msg(_T("%s"), szSQL8);	
	_msg(_T("%s"), szSQL9);	
	_msg(_T("%s"), szSQL10);	
	_msg(_T("%s"), szSQL11);
	_msg(_T("%s"), szSQL12);
	_msg(_T("%s"), szSQL13);
	_msg(_T("%s"), szSQL14);
	_msg(_T("%s"), szSQL15);
	_msg(_T("%s"), szSQL16);
	_msg(_T("%s"), szSQL17);
	_msg(_T("%s"), szSQL18);
	_msg(_T("%s"), szSQL19);
	_msg(_T("%s"), szWhere1);*/

	szSQL.Format(_T(" SELECT ") \
				_T(" HO_TEN, docno,") \
				_T(" ROUND(SUM(TONG_THU)) as total") \
				_T(" FROM") \
				_T(" (") \
				_T(" WITH tbl AS (%s)") \
				_T(" SELECT") \
				_T(" HO_TEN,") \
				_T(" docno,") \
				_T(" NGAY_VAO, ") \
				_T(" NGAY_RA,") \
				_T(" CHINDEX, ") \
				_T(" to_char (posted_date,'DD/MM/YYYY') as posted_date,") \
				_T(" dept_id,") \
				_T(" SUM(SO_NGAY_DT) as SO_NGAY_DT,") \
				_T(" SUM(TIEN_KHAM) as TIEN_KHAM,") \
				_T(" SUM(TIEN_GIUONG) as TIEN_GIUONG,") \
				_T(" SUM(TIEN_CLS) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT) as TIEN_PTTT,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_PM) AS TIEN_THUOC_PM,") \
				_T(" SUM(TIEN_VAT_TU_PM) AS TIEN_VAT_TU_PM,") \
				_T(" SUM(TIEN_MAU) as TIEN_MAU,") \
				_T(" SUM(THU_KHAC) as THU_KHAC,") \
				_T(" SUM(THU_GOI) as THU_GOI,") \
				_T(" SUM(TIEN_AN) as TIEN_AN,") \
				_T(" SUM(TIEN_AN_HC) as TIEN_AN_HC,") \
				_T(" SUM(TIEN_THUOC_TG+TIEN_THUOC_TG_O) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG+TIEN_VAT_TU_TG_O) as TIEN_VAT_TU_TG,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN) as TONG_THU,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(iv.hfe_docno) as HO_TEN,") \
				_T("   iv.hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    hfe_date as invoice_date,") \
				_T("    trunc(fc.FAC_POSTEDDATE) as posted_date,") \
				_T("    khoa_thuchien as dept_id,") \
				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_AN_HC,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     hfe_itemid") \
				_T("   FROM HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=iv.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN  (") \
				_T("    %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s ") \
				//_T("    %s %s ") \//
				_T("   ) tbl1 ON (iv.hfe_invoiceno = tbl1.hfe_invoiceno AND iv.hfe_docno = tbl1.hfe_docno)") \
				_T("   WHERE 1=1  %s") \
				_T("   )") \
				_T(" GROUP BY ") \
				_T(" HO_TEN, docno, NGAY_VAO, NGAY_RA,CHINDEX, posted_date,dept_id") \
				_T(" HAVING SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+") \
				_T("	TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+") \
				_T("	THU_GOI+TIEN_AN+TIEN_THUOC_TG+TIEN_VAT_TU_TG+TIEN_THUOC_TG_O+TIEN_VAT_TU_TG_O+TIEN_AN_HC) >0 %s") \
				_T(" ORDER BY dept_id,posted_date")
				_T(" )") \
				_T(" GROUP BY HO_TEN, docno") \
				_T(" ORDER BY docno"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,
				szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szWhere1, szWherebed);

	return szSQL;
}
void CFMServicePaidSummaryByDept_2024::OnExportv20(int nVersion)
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1, i = 0;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
		{
			nTotal[i] = 0;
			nGroupTotal[i] = 0;
		}
	CExcel xls;
	if (!xls.Load(_T("Exports\\Template\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_TH_CHITIET_BN.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetSheetName(_T("Sheet 0"));
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);

	if (nVersion == 1)
	{
		szSQL = GetQueryString();
	}
	else
	{
		szSQL = GetQueryString_v20();
		//AfxMessageBox(szSQL);
	}
	rs.ExecSQL(szSQL);
	//AfxMessageBox(szSQL);

	
	nRow = 9;
	nCol = 0;

	while(!rs.IsEOF())
	{
		int i = 0;
		if(nRow == 65000)
		{
			i++;
			tmpStr.Format(_T("Sheet %d"), i);
			xls.AddSheet(tmpStr);
			xls.SetWorksheet(i);
			nRow = 1;
		}

		rs.GetValue(_T("dept_id"), szNewDept);
		if (!szNewDept.IsEmpty() && szOldDept != szNewDept)
		{
			if (nGroupTotal[27] > 0)
			{
				xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);

				for(int i = 7; i < 30; i++)
				{
					xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
					nTotal[i] += nGroupTotal[i];
					nGroupTotal[i] = 0;
				}
				nRow++;
			}
			xls.SetCellText(0, nRow, szNewDept, FMT_TEXT, true);
			szOldDept = szNewDept;
			nIdx = 1;
			nRow++;
		}
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("HO_TEN"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("docno"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_INTEGER);
		
		rs.GetValue(_T("dept_id"), tmpStr);
		xls.SetCellText(nCol+3, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("NGAY_VAO"), tmpStr);
		xls.SetCellText(nCol+4,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);

		rs.GetValue(_T("NGAY_RA"), tmpStr);
		xls.SetCellText(nCol+5,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);

		rs.GetValue(_T("posted_date"), tmpStr);
		xls.SetCellText(nCol+6, nRow, tmpStr, FMT_TEXT);
		//xls.SetCellText(nCol+6,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);		

		rs.GetValue(_T("SO_NGAY_DT"), nTemp);
		nGroupTotal[7] += nTemp;
		xls.SetCellText(nCol+7, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_KHAM"), nTemp);
		nGroupTotal[8] += nTemp;
		xls.SetCellText(nCol+8, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_GIUONG"), nTemp);
		nGroupTotal[9] += nTemp;
		xls.SetCellText(nCol+9, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_CLS"), nTemp);
		nGroupTotal[10] += nTemp;
		xls.SetCellText(nCol+10, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_PTTT"), nTemp);
		nGroupTotal[11] += nTemp;
		xls.SetCellText(nCol+11, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NGOAITRU"), nTemp);
		nGroupTotal[12] += nTemp;
		xls.SetCellText(nCol+12, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NOITRU"), nTemp);
		nGroupTotal[13] += nTemp;
		xls.SetCellText(nCol+13, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NGOAITRU"), nTemp);
		nGroupTotal[14] += nTemp;
		xls.SetCellText(nCol+14, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NOITRU"), nTemp);
		nGroupTotal[15] += nTemp;
		xls.SetCellText(nCol+15, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_PM"), nTemp);
		nGroupTotal[16] += nTemp;
		xls.SetCellText(nCol+16, nRow, double2str(nTemp), FMT_NUMBER1);
		
		rs.GetValue(_T("TIEN_VAT_TU_PM"), nTemp);
		nGroupTotal[17] += nTemp;
		xls.SetCellText(nCol+17, nRow, double2str(nTemp), FMT_NUMBER1);
		
		rs.GetValue(_T("TIEN_MAU"), nTemp);
		nGroupTotal[18] += nTemp;
		xls.SetCellText(nCol+18, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_KHAC"), nTemp);
		nGroupTotal[19] += nTemp;
		xls.SetCellText(nCol+19, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_GOI"), nTemp);
		nGroupTotal[20] += nTemp;
		xls.SetCellText(nCol+20, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("CHON_BS"), nTemp);
		nGroupTotal[21] += nTemp;
		xls.SetCellText(nCol+21, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TONG_THU"), nTemp);
		nGroupTotal[22] += nTemp;
		xls.SetCellText(nCol+22, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_AN"), nTemp);
		nGroupTotal[23] += nTemp;
		xls.SetCellText(nCol+23, nRow, double2str(nTemp), FMT_NUMBER1);	


		rs.GetValue(_T("TIEN_AN_HC"), nTemp);
		nGroupTotal[24] += nTemp;
		xls.SetCellText(nCol+24, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_THUOC_TG"), nTemp);
		nGroupTotal[25] += nTemp;
		xls.SetCellText(nCol+25, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_VAT_TU_TG"), nTemp);
		nGroupTotal[26] += nTemp;
		xls.SetCellText(nCol+26, nRow, double2str(nTemp), FMT_NUMBER1);	
			
		rs.GetValue(_T("TONG_THU1"), nTemp);
		nGroupTotal[27] += nTemp;
		xls.SetCellText(nCol+27, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("MIEN_GIAM"), nTemp);
		nGroupTotal[28] += nTemp;
		xls.SetCellText(nCol+28, nRow, double2str(nTemp), FMT_NUMBER1);	
			
		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[27] > 0)
	{
		xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
			nTotal[i] += nGroupTotal[i];
		}
		nRow++;
	}

	if (nTotal[27] > 0)
	{
		xls.SetCellText(6, nRow, _T("T\x1ED5ng \x63\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nTotal[i]), FMT_NUMBER1, true);
		}
		nRow++;
	}

	xls.SetActiveSheet(0);
	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_TH_CHITIET_BN2.xls"));
}
CString CFMServicePaidSummaryByDept_2024::GetQueryString_v2_A11()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2;
	CString szSQL21,szSQL22,szSQL23,szSQL24,szSQL25, szOrderBy, szReceiptStr, szWherebed;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));

	//szWhere.Format(_T(" and iv.hfe_cash_id in(%s) "), szReceiptStr);
	
	if (nCount <1000)
	{
		szWhere1.Format(_T(" AND fac_cash_id in(%s) "), szReceiptStr);
	}
	else
	{
		szWhere1.Format(_T(" AND fac_cash_id in (select fac_cash_id from tbl)"));
	}
	szWhere.Empty();
	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);

	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/
	if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	if (m_bBED)
	{
		szWherebed.AppendFormat(_T(" AND SUM(SO_NGAY_DT)>0 "));	
	}
	if (m_bSOD)
	{
	//1. Tien kham ne//
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				_T("       f.hfe_cost as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_itemid <> 'D0000006'") \
				_T("     AND f.hfe_cost       >0") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN (f.hfe_type ='B' OR f.hfe_itemid='D0000006')") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       f.hfe_cost as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND (F.Hfe_Group     IN ('C0000') OR f.hfe_itemid='D0000006')") \
				//_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND su_deptid       IS NOT NULL") \
				_T("         THEN Su_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND su_deptid       IS NOT NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				//_T("         AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,") \//
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T(" AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       f.hfe_patpaid as TIEN_PTTT,") \//				
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       f.hfe_cost AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       f.hfe_cost AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'HC', 'PĐD')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'COV', 'BN')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P', 'BN')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       f.hfe_cost as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);

 //15.1 Phi an hau can//
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
    // Update ngay 03/06/2017//
	// Them vao 2 cot tinh tien thuoc trong goi & tien vat tu trong goi//
	//16. Phi tien thuoc trong goi PTTT//
 //Ngày 06/05/2020 Comment lại szSQL18 / szSQL19 / szSQL20 / szSQL21
 //Sửa sang tiêu chí mới để phục vụ cho TTDTHM toàn thu tiền trước nhập vật tư sau // 
 /*szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_patpaid as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//17.Phi tien vat tu trong goi//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_patpaid as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (coalesce(ho_group, hpc_groupid) = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				//_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \//
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//18.Phi thuoc trong goi, dung cho truong hop thu phi PTTT truoc sau do moi nhap thuoc trong goi o phong kham//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//19.Phi tien vat tu trong goi, dung cho truong hop thu phi PTTT truoc nhap vat tu sau//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);*/
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				//_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \//
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);


		//20. Phi thu goi, them vao ngay 13/11/2018//
szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       f.hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P','COV', 'BN')"), szWhere);
}
else
{
		//1. Tien kham ne//
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				//_T("       f.hfe_patpaid as TIEN_KHAM,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_itemid <> 'D0000006'") \
				_T("     AND f.hfe_patpaid       >0") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN (f.hfe_type ='B' OR f.hfe_itemid='D0000006')") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				//_T("       f.hfe_patpaid as TIEN_GIUONG,     ") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_GIUONG,") \

				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND (F.Hfe_Group     IN ('C0000') OR f.hfe_itemid='D0000006')") \
				//_T("     AND f.hfe_category  IN ('N','BQP','COV','XX')"), szWhere);
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND su_deptid       IS NOT NULL") \
				_T("         THEN Su_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				//_T("       f.hfe_patpaid as TIEN_CLS,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND su_deptid       IS NOT NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				//_T("       f.hfe_patpaid as TIEN_CLS,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				//_T("         AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,") \//
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				//_T("       f.hfe_patpaid as TIEN_CLS,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T(" AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				//_T("       f.hfe_patpaid as TIEN_CLS,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       f.hfe_patpaid as TIEN_PTTT,") \//				
				//_T("       CASE WHEN HFE_FEEGROUP='HITECH_A' AND HFE_TREAT_INPACKAGE='Y' THEN f.hfe_cost else f.hfe_patpaid end as TIEN_PTTT,") \//
				_T("       CASE WHEN HFE_FEEGROUP='HITECH_A' AND HFE_TREAT_INPACKAGE='Y' THEN f.hfe_cost else CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END end as TIEN_PTTT,") \

				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				//_T("       f.hfe_patpaid as TIEN_THUOC_CH_NGOAITRU,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				//_T("       f.hfe_patpaid as TIEN_THUOC_CH_NOITRU,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				//_T("       f.hfe_patpaid as TIEN_VAT_TU_CH_NGOAITRU,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_CH_NGOAITRU,") \

				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				//_T("       f.hfe_patpaid as TIEN_VAT_TU_CH_NOITRU,") \//

				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				//_T("       f.hfe_patpaid AS TIEN_THUOC_PM,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				//_T("       f.hfe_patpaid AS TIEN_VAT_TU_PM,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_PM,") \

				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				//_T("       f.hfe_patpaid as TIEN_MAU,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_MAU,") \

				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'HC', 'PĐD')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'COV', 'BN')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				//_T("       f.hfe_patpaid as THU_KHAC,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P', 'BN')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				//_T("       f.hfe_patpaid as TIEN_AN,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'BN')"), szWhere);

 //15.1 Phi an hau can//
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
    // Update ngay 03/06/2017//
	// Them vao 2 cot tinh tien thuoc trong goi & tien vat tu trong goi//
	//16. Phi tien thuoc trong goi PTTT//
 //Ngày 06/05/2020 Comment lại szSQL18 / szSQL19 / szSQL20 / szSQL21
 //Sửa sang tiêu chí mới để phục vụ cho TTDTHM toàn thu tiền trước nhập vật tư sau // 
 /*szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_patpaid as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//17.Phi tien vat tu trong goi//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_patpaid as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (coalesce(ho_group, hpc_groupid) = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				//_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \//
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//18.Phi thuoc trong goi, dung cho truong hop thu phi PTTT truoc sau do moi nhap thuoc trong goi o phong kham//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//19.Phi tien vat tu trong goi, dung cho truong hop thu phi PTTT truoc nhap vat tu sau//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 AND NVL(ho_deptid,NULL)<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);*/
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				//_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \//
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);


		//20. Phi thu goi, them vao ngay 13/11/2018//
szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				//_T("       f.hfe_patpaid as TIEN_CLS,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				//_T("       f.hfe_patpaid as TIEN_CLS,") \//
				_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P','COV', 'BN')"), szWhere);
	
}

rs.ExecSQL(szSQL);
				//_msg(_T("%s"), szSQL);
	/*_msg(_T("%s"), szSQL1);
	_msg(_T("%s"), szSQL2);	
	_msg(_T("%s"), szSQL3);	
	_msg(_T("%s"), szSQL4);	
	_msg(_T("%s"), szSQL5);	
	_msg(_T("%s"), szSQL6);	
	_msg(_T("%s"), szSQL7);	
	_msg(_T("%s"), szSQL8);	
	_msg(_T("%s"), szSQL9);	
	_msg(_T("%s"), szSQL10);	
	_msg(_T("%s"), szSQL11);
	_msg(_T("%s"), szSQL12);
	_msg(_T("%s"), szSQL13);
	_msg(_T("%s"), szSQL14);
	_msg(_T("%s"), szSQL15);
	_msg(_T("%s"), szSQL16);
	_msg(_T("%s"), szSQL17);
	_msg(_T("%s"), szSQL18);
	_msg(_T("%s"), szSQL19);
	_msg(_T("%s"), szWhere1);*/
   szSQL.Format(_T(" WITH tbl AS (%s)") \
				_T(" SELECT") \
				_T(" HO_TEN,") \
				_T(" docno,") \
				_T(" NGAY_VAO, ") \
				_T(" NGAY_RA,") \
				_T(" CHINDEX, ") \
				_T(" to_char (posted_date,'DD/MM/YYYY') as posted_date,") \
				_T(" dept_id,") \
				_T(" SUM(SO_NGAY_DT) as SO_NGAY_DT,") \
				_T(" SUM(TIEN_KHAM) as TIEN_KHAM,") \
				_T(" SUM(TIEN_GIUONG) as TIEN_GIUONG,") \
				_T(" SUM(TIEN_CLS) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT) as TIEN_PTTT,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_PM) AS TIEN_THUOC_PM,") \
				_T(" SUM(TIEN_VAT_TU_PM) AS TIEN_VAT_TU_PM,") \
				_T(" SUM(TIEN_MAU) as TIEN_MAU,") \
				_T(" SUM(THU_KHAC) as THU_KHAC,") \
				_T(" SUM(THU_GOI) as THU_GOI,") \
				_T(" SUM(TIEN_AN) as TIEN_AN,") \
				_T(" SUM(TIEN_AN_HC) as TIEN_AN_HC,") \
				_T(" SUM(TIEN_THUOC_TG+TIEN_THUOC_TG_O) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG+TIEN_VAT_TU_TG_O) as TIEN_VAT_TU_TG,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI) as TONG_THU,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(iv.hfe_docno) as HO_TEN,") \
				_T("   iv.hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    hfe_date as invoice_date,") \
				_T("    trunc(fc.FAC_POSTEDDATE) as posted_date,") \
				_T("    iv.hfe_deptid as dept_id,") \
				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_AN_HC,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     hfe_itemid") \
				_T("   FROM HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=iv.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN  (") \
				_T("    %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s ") \
				//_T("    %s %s ") \//
				_T("   ) tbl1 ON (iv.hfe_invoiceno = tbl1.hfe_invoiceno AND iv.hfe_docno = tbl1.hfe_docno)") \
				_T("   WHERE 1=1  %s") \
				_T("   )") \
				_T(" GROUP BY ") \
				_T(" HO_TEN, docno, NGAY_VAO, NGAY_RA,CHINDEX, posted_date,dept_id") \
				_T(" HAVING SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+") \
				_T("	TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+") \
				_T("	THU_GOI+TIEN_AN+TIEN_THUOC_TG+TIEN_VAT_TU_TG+TIEN_THUOC_TG_O+TIEN_VAT_TU_TG_O+TIEN_AN_HC) >0 %s") \
				_T(" ORDER BY dept_id,posted_date"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,
				szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szWhere1, szWherebed);

	return szSQL;
}

int CFMServicePaidSummaryByDept_2024::OnListCheckAllInvoiceTYC()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText, szItemTextEX;
	int nCheck = 0;
	for (int i=0; i<m_wndList.GetItemCount(); i++)	
	{
		szItemText=m_wndList.GetItemText(i,1);
		szItemTextEX = m_wndList.GetItemText(i,5);

	if (((_T("THE-DV-YC"))==szItemTextEX || (_T("THE-DV-PTTYC"))==szItemTextEX 
		|| (_T("CK-DV-PTTYC"))==szItemTextEX ||(_T("CK-DV-YC"))==szItemTextEX 
		|| (_T("DV-PTTYC"))==szItemTextEX || (_T("DVYC"))==szItemTextEX)) 
	{
		m_wndList.SetCheck(i, true);
			nCheck++;
	}
	else m_wndList.SetCheck(i, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}
int CFMServicePaidSummaryByDept_2024::OnListCheckAllRefundTYC()
{
	CString szItemText, szItemTextEX;
	int nCheck = 0;
	for (int i=0; i<m_wndList.GetItemCount(); i++)	
	{
		szItemText=m_wndList.GetItemText(i,1);
		szItemTextEX = m_wndList.GetItemText(i,5);

	if (((_T("THE-DV-YC"))==szItemTextEX || (_T("THE-DV-PTTYC"))==szItemTextEX 
		|| (_T("CK-DV-PTTYC"))==szItemTextEX ||(_T("CK-DV"))==szItemTextEX 
		|| (_T("DV-PTTYC"))==szItemTextEX || (_T("DVYC"))==szItemTextEX)) 
	{
		m_wndList.SetCheck(i, true);
			nCheck++;
	}
	else m_wndList.SetCheck(i, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}

int CFMServicePaidSummaryByDept_2024::OnListCheckAllInvoiceBHTYC()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText, szItemTextEX;
	int nCheck = 0;
	for (int i=0; i<m_wndList.GetItemCount(); i++)	
	{
		szItemText=m_wndList.GetItemText(i,1);
		szItemTextEX = m_wndList.GetItemText(i,5);

	if (((_T("THE-BH-YC"))==szItemTextEX || (_T("THE-BH-PTTYC"))==szItemTextEX 
		|| (_T("CK-BH-PTTYC"))==szItemTextEX ||(_T("CK-BH"))==szItemTextEX || (_T("CK-BH-YC"))==szItemTextEX 
		|| (_T("BH-PTTYC"))==szItemTextEX || (_T("BHYC"))==szItemTextEX)) 
	{
		m_wndList.SetCheck(i, true);
			nCheck++;
	}
	else m_wndList.SetCheck(i, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}

int CFMServicePaidSummaryByDept_2024::OnListCheckAllRefundBHTYC()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText, szItemTextEX;
	int nCheck = 0;
	for (int i=0; i<m_wndList.GetItemCount(); i++)	
	{
		szItemText=m_wndList.GetItemText(i,1);
		szItemTextEX = m_wndList.GetItemText(i,5);

	if (((_T("THE-BH-YC"))==szItemTextEX || (_T("THE-BH-PTTYC"))==szItemTextEX || (_T("CK-BH-PTTYC"))==szItemTextEX ||(_T("CK-BH"))==szItemTextEX || (_T("BH-PTTYC"))==szItemTextEX || (_T("BHYC"))==szItemTextEX)) 
	{
		m_wndList.SetCheck(i, true);
			nCheck++;
	}
	else m_wndList.SetCheck(i, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}

void CFMServicePaidSummaryByDept_2024::OnExportv2(int nVersion)

{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1, i = 0;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
		{
			nTotal[i] = 0;
			nGroupTotal[i] = 0;
		}
	CExcel xls;
	if (!xls.Load(_T("Exports\\Template\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_THUOC_VATTU.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetSheetName(_T("Sheet 0"));
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);

	
	szSQL = GetQueryString_v10();
	//AfxMessageBox(szSQL);

	rs.ExecSQL(szSQL);

	
	
	nRow = 9;
	nCol = 0;
	
	while(!rs.IsEOF())
	{
		int i = 0;
		if(nRow == 65000)
		{
			i++;
			tmpStr.Format(_T("Sheet %d"), i);
			xls.AddSheet(tmpStr);
			xls.SetWorksheet(i);
			nRow = 1;
		}

		rs.GetValue(_T("dept_id"), szNewDept);
		if (!szNewDept.IsEmpty() && szOldDept != szNewDept)
		{
			if (nGroupTotal[20] > 0)
			{
				xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);

				for(int i = 7; i < 30; i++)
				{
					xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
					nTotal[i] += nGroupTotal[i];
					nGroupTotal[i] = 0;
				}
				nRow++;
			}
			xls.SetCellText(0, nRow, szNewDept, FMT_TEXT, true);
			szOldDept = szNewDept;
			nIdx = 1;
			nRow++;
		}
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("HO_TEN"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("docno"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_INTEGER);
		
		rs.GetValue(_T("dept_id"), tmpStr);
		xls.SetCellText(nCol+3, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("SD_MAKHOA_TAICHINH"), tmpStr);
		xls.SetCellText(nCol+4, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("NGAY_VAO"), tmpStr);
		xls.SetCellText(nCol+5,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);

		rs.GetValue(_T("NGAY_RA"), tmpStr);
		xls.SetCellText(nCol+6,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);

		rs.GetValue(_T("posted_date"), tmpStr);
		xls.SetCellText(nCol+7, nRow, tmpStr, FMT_TEXT);
		

		rs.GetValue(_T("SO_NGAY_DT"), nTemp);
		nGroupTotal[8] += nTemp;
		xls.SetCellText(nCol+8, nRow, double2str(nTemp), FMT_NUMBER1);		

		rs.GetValue(_T("TIEN_THUOC_CH_NGOAITRU"), nTemp);
		nGroupTotal[9] += nTemp;
		xls.SetCellText(nCol+9, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_TPCN_CH_NGOAITRU"), nTemp);
		nGroupTotal[10] += nTemp;
		xls.SetCellText(nCol+10, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NGOAITRU_KHO"), nTemp);
		nGroupTotal[11] += nTemp;
		xls.SetCellText(nCol+11, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NGOAITRU_TT"), nTemp);
		nGroupTotal[12] += nTemp;
		xls.SetCellText(nCol+12, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NOITRU"), nTemp);
		nGroupTotal[13] += nTemp;
		xls.SetCellText(nCol+13, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_TPCN_CH_NOITRU"), nTemp);
		nGroupTotal[14] += nTemp;
		xls.SetCellText(nCol+14, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NOITRU_KHO"), nTemp);
		nGroupTotal[15] += nTemp;
		xls.SetCellText(nCol+15, nRow, double2str(nTemp), FMT_NUMBER1);		

		rs.GetValue(_T("TIEN_THUOC_CH_NOITRU_TT"), nTemp);
		nGroupTotal[16] += nTemp;
		xls.SetCellText(nCol+16, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NGOAITRU"), nTemp);
		nGroupTotal[17] += nTemp;
		xls.SetCellText(nCol+17, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NGOAITRU_KHO"), nTemp);
		nGroupTotal[18] += nTemp;
		xls.SetCellText(nCol+18, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NGOAITRU_TT"), nTemp);
		nGroupTotal[19] += nTemp;
		xls.SetCellText(nCol+19, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NOITRU"), nTemp);
		nGroupTotal[20] += nTemp;
		xls.SetCellText(nCol+20, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NOITRU_KHO"), nTemp);
		nGroupTotal[21] += nTemp;
		xls.SetCellText(nCol+21, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NOITRU_TT"), nTemp);
		nGroupTotal[22] += nTemp;
		xls.SetCellText(nCol+22, nRow, double2str(nTemp), FMT_NUMBER1);		

		rs.GetValue(_T("TONG_THU"), nTemp);
		nGroupTotal[23] += nTemp;
		xls.SetCellText(nCol+23, nRow, double2str(nTemp), FMT_NUMBER1);		
			
		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[23] > 0)
	{
		xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
			nTotal[i] += nGroupTotal[i];
		}
		nRow++;
	}

	if (nTotal[23] > 0)
	{
		xls.SetCellText(6, nRow, _T("T\x1ED5ng \x63\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nTotal[i]), FMT_NUMBER1, true);
		}
		nRow++;
	}

	xls.SetActiveSheet(0);
	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_THUOC_VATTU2.xls"));
}

CString CFMServicePaidSummaryByDept_2024::GetQueryString_v10()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2;
	CString szSQL21,szSQL22,szSQL23,szSQL24,szSQL25, szOrderBy, szReceiptStr, szWherebed, szDepts, szWhere5;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}
	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));
	if (nCount < m_wndList.GetItemCount() && nCount > 0)
	{
		if (nCount <1000)
		{
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND fac_cash_id in(%s)) "), szReceiptStr);
		}
		else
		{
			CStringToken tok_id(szReceiptStr);
			int nCount = 0;
			long nTemp = 0;
			CString szIds, tmpStr;
			bool bBreak = false;
			szIds.Empty();
			tmpStr.Empty();
			for (int i = 0; i < tok_id.GetSize(); i++)
			{
				if (nCount > 999)
				{
					bBreak = true;
				}
				if (bBreak)
				{
					if (!szIds.IsEmpty())
					{
						szIds += _T(" OR ");
					}
					szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
					//_tprintf(_T("\nszIds: %s\n"), szIds);
					tmpStr.Empty();
					nCount = 0;
					bBreak = false;
				}
				if (!tmpStr.IsEmpty())
				{
					tmpStr += _T(",");
				}
				tok_id.GetAt(i, nTemp);
				tmpStr.AppendFormat(_T("%ld"), nTemp);
				nCount++;
			}
			if (!szIds.IsEmpty())
			{
				szIds += _T(" OR ");
			}
			szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND (%s))"), szIds);
		}
	}
	else
	{
		szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl)"));
	}
	szWhere.Empty();
	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);

	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/
	if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	if (m_bBED)
	{
		szWherebed.AppendFormat(_T(" AND SUM(SO_NGAY_DT)>0 "));	
	}

	for (int i = 0; i < m_wndDeptList.GetItemCount(); i++)
	{
		if (m_wndDeptList.GetCheck(i))
		{
			if (!szDepts.IsEmpty())
				szDepts += _T(",");
			szDepts.AppendFormat(_T("'%s'"), m_wndDeptList.GetItemText(i, 0));
		}
	}

	if (!szDepts.IsEmpty())
	{
		szWhere5.AppendFormat(_T(" khoatt in(%s) "), szDepts);
	}

	if (m_nAllObj == 0)
	{
		szWhere5.AppendFormat(_T(" and 1=1 "));
	}
	else if (m_nService == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong = 7 "));
	}
	else if (m_nOtherObj == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong IN (1, 3, 8, 13) "));
	}

	else if (m_nInsurance == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong not in  (1, 3, 7, 8, 13) "));
	}
	else
	{
		szWhere5.AppendFormat(_T(" and 0>1 "));
	}

	//1.Phi thuoc ngoai tru//
	{
  szSQL1.Format(_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       CASE WHEN f.hfe_group<>'A1700' THEN f.hfe_cost else 0 END as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       case when f.hfe_group='A1700' then f.hfe_cost else 0 end as TIEN_TPCN_CH_NGOAITRU,") \
				_T("       case when f.hfe_group<>'A1700' and msl_type <> 'C' then f.hfe_cost else 0 end as TIEN_THUOC_CH_NGOAITRU_KHO,") \
				_T("       case when f.hfe_group<>'A1700' and msl_type = 'C' then f.hfe_cost else 0 end as TIEN_THUOC_CH_NGOAITRU_TT,") \

				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_TPCN_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU_KHO,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU_TT,") \

				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU_KHO,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU_TT,") \

				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU_KHO,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU_TT,") \

				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP2") \
				_T("     ON (hpo_docno = f.hfe_docno and hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN m_storagelist ON (HPO_STORAGE_ID = msl_storage_id )") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
  
	//2 Phi thuoc noi tru	
  szSQL2.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_TPCN_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU_KHO,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU_TT,") \

				_T("       CASE WHEN f.hfe_group<>'A1700' THEN f.hfe_cost ELSE 0 END as TIEN_THUOC_CH_NOITRU,") \
				_T("       case when f.hfe_group='A1700' then f.hfe_cost else 0 end as TIEN_TPCN_CH_NOITRU,") \
				_T("       case when f.hfe_group<>'A1700' and msl_type <> 'C' then f.hfe_cost else 0 end as TIEN_THUOC_CH_NOITRU_KHO,") \
				_T("       case when f.hfe_group<>'A1700' and msl_type = 'C' then f.hfe_cost else 0 end as TIEN_THUOC_CH_NOITRU_TT,") \

				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU_KHO,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU_TT,") \

				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU_KHO,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU_TT,") \
				
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP2") \
				_T("     ON (hpo_docno = f.hfe_docno and hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN m_storagelist ON (HPO_STORAGE_ID = msl_storage_id )") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND (hfe_category   not IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//3.Phi khoa trang bi ngoai tru//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_TPCN_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU_KHO,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU_TT,") \

				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_TPCN_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU_KHO,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU_TT,") \

				_T("       CASE WHEN f.hfe_cost>0 THEN f.hfe_cost ELSE 0 END as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       case when msl_type <> 'C' then f.hfe_cost else 0 end as TIEN_VAT_TU_CH_NGOAITRU_KHO,") \
				_T("       case when msl_type = 'C' then f.hfe_cost else 0 end as TIEN_VAT_TU_CH_NGOAITRU_TT,") \


				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU_KHO,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU_TT,") \

				
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP2") \
				_T("     ON (hpo_docno = f.hfe_docno and hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN m_storagelist ON (HPO_STORAGE_ID = msl_storage_id )") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB','PĐD','HC')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//4 Phi vat tu noi tru
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_TPCN_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU_KHO,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU_TT,") \

				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_TPCN_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU_KHO,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU_TT,") \

				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU_KHO,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU_TT,") \

				_T("       CASE WHEN f.hfe_cost>0 THEN f.hfe_cost ELSE 0 END as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       case when msl_type <> 'C' then f.hfe_cost else 0 end as TIEN_VAT_TU_CH_NOITRU_KHO,") \
				_T("       case when msl_type = 'C' then f.hfe_cost else 0 end as TIEN_VAT_TU_CH_NOITRU_TT,") \
				
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP2") \
				_T("     ON (hpo_docno = f.hfe_docno and hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN m_storagelist ON (HPO_STORAGE_ID = msl_storage_id )") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_docno = i.hfe_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	}

rs.ExecSQL(szSQL);
   szSQL.Format(_T(" WITH tbl AS (%s)") \
				_T(" SELECT") \
				_T(" HO_TEN,") \
				_T(" docno,") \
				_T(" NGAY_VAO, ") \
				_T(" NGAY_RA,") \
				_T(" CHINDEX, ") \
				_T(" to_char (posted_date,'DD/MM/YYYY') as posted_date,") \
				_T(" dept_id, SD_MAKHOA_TAICHINH, khoatt, doituong, ") \
				_T(" SUM(SO_NGAY_DT) as SO_NGAY_DT,") \

				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_TPCN_CH_NGOAITRU) as TIEN_TPCN_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU_KHO) as TIEN_THUOC_CH_NGOAITRU_KHO,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU_TT) as TIEN_THUOC_CH_NGOAITRU_TT,") \

				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_TPCN_CH_NOITRU) as TIEN_TPCN_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU_KHO) as TIEN_THUOC_CH_NOITRU_KHO,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU_TT) as TIEN_THUOC_CH_NOITRU_TT,") \

				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU_KHO) as TIEN_VAT_TU_CH_NGOAITRU_KHO,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU_TT) as TIEN_VAT_TU_CH_NGOAITRU_TT,") \

				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU_KHO) as TIEN_VAT_TU_CH_NOITRU_KHO,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU_TT) as TIEN_VAT_TU_CH_NOITRU_TT,") \

				_T(" SUM(TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_TPCN_CH_NGOAITRU+TIEN_TPCN_CH_NOITRU) as TONG_THU") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(iv.hfe_docno) as HO_TEN,") \
				_T("   iv.hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    hfe_date as invoice_date,") \
				_T("    trunc(fc.FAC_POSTEDDATE) as posted_date,") \
				_T("    khoa_thuchien as dept_id,") \

				_T("    CASE") \
				_T("         WHEN NVL(iv.hfe_org_id, 'XX' )= 'EM'") \
				_T("         AND iv.hfe_deptid              = 'A3-D'") \
				_T("         THEN hd_admitdept") \
				_T("         ELSE iv.hfe_deptid") \
				_T("       END AS khoatt, iv.doituong AS doituong,") \


				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_TPCN_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NGOAITRU_KHO,") \
				_T("     TIEN_THUOC_CH_NGOAITRU_TT,") \

				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_TPCN_CH_NOITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU_KHO,") \
				_T("     TIEN_THUOC_CH_NOITRU_TT,") \

				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU_KHO,    ") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU_TT,    ") \


				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU_KHO,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU_TT,    ") \

				_T("     hfe_itemid") \
				_T("   FROM HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=iv.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN  (") \
				_T("    %s %s %s %s  ") \
				_T("   ) tbl1 ON (iv.hfe_invoiceno = tbl1.hfe_invoiceno AND iv.hfe_docno = tbl1.hfe_docno)") \
				_T("   WHERE 1=1  %s") \
				_T("   )") \
				_T(" left join sys_dept on (sd_id = dept_id) where %s ") \
				_T(" GROUP BY ") \
				_T(" HO_TEN, docno, NGAY_VAO, NGAY_RA,CHINDEX, posted_date,dept_id, SD_MAKHOA_TAICHINH, khoatt, doituong") \
				_T(" HAVING SUM(TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+") \
				_T(" TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+ TIEN_TPCN_CH_NGOAITRU+TIEN_TPCN_CH_NOITRU) > 0 ") \
				_T(" %s") \
				_T(" ORDER BY dept_id,posted_date"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4, szWhere1, szWhere5, szWherebed);			

   //_msg(_T("%s"), szSQL);

	return szSQL;
}

void CFMServicePaidSummaryByDept_2024::OnExport15(int nVersion)
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
	{
		nTotal[i] = 0;
		nGroupTotal[i] = 0;
	}
	CExcel xls;
	if (!xls.Load(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_THV2.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);
	if (nVersion == 1)
	{
		szSQL = GetQueryString2();
	}
	else
	{
		szSQL = GetQueryString2_v15();
		AfxMessageBox(_T("Bỏ tiền vòng đeo tay...ra khỏi cột vật tư của khoa yêu cầu !! "));
		//AfxMessageBox(szSQL);
	}
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	
	AfxMessageBox(_T("Thay đổi cách tính miễn giảm từ khoa ra viện -> khoa thực hiện (bao gồm nghiệp vụ miễn theo đề mục & miễn giảm tổng)"));	
	nRow = 9;
	nCol = 0;
	while(!rs.IsEOF())
	{
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("dept_id"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("SD_MAKHOA_TAICHINH"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("TIEN_KHAM"), nTemp);
		nGroupTotal[3] += nTemp;
		xls.SetCellText(nCol+3, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_GIUONG"), nTemp);
		nGroupTotal[4] += nTemp;
		xls.SetCellText(nCol+4, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_CLS"), nTemp);
		nGroupTotal[5] += nTemp;
		xls.SetCellText(nCol+5, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_PTTT"), nTemp);
		nGroupTotal[6] += nTemp;
		xls.SetCellText(nCol+6, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NGOAITRU"), nTemp);
		nGroupTotal[7] += nTemp;
		xls.SetCellText(nCol+7, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NOITRU"), nTemp);
		nGroupTotal[8] += nTemp;
		xls.SetCellText(nCol+8, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NGOAITRU"), nTemp);
		nGroupTotal[9] += nTemp;
		xls.SetCellText(nCol+9, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NOITRU"), nTemp);
		nGroupTotal[10] += nTemp;
		xls.SetCellText(nCol+10, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_PM"), nTemp);
		nGroupTotal[11] += nTemp;
		xls.SetCellText(nCol+11, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_PM"), nTemp);
		nGroupTotal[12] += nTemp;
		xls.SetCellText(nCol+12, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_MAU"), nTemp);
		nGroupTotal[13] += nTemp;
		xls.SetCellText(nCol+13, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_KHAC"), nTemp);
		nGroupTotal[14] += nTemp;
		xls.SetCellText(nCol+14, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_GOI"), nTemp);
		nGroupTotal[15] += nTemp;
		xls.SetCellText(nCol+15, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("CHON_BS"), nTemp);
		nGroupTotal[16] += nTemp;
		xls.SetCellText(nCol+16, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TONG_THU"), nTemp);
		nGroupTotal[17] += nTemp;
		xls.SetCellText(nCol+17, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_AN"), nTemp);
		nGroupTotal[18] += nTemp;
		xls.SetCellText(nCol+18, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_AN_HC"), nTemp);
		nGroupTotal[19] += nTemp;
		xls.SetCellText(nCol+19, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_THUOC_TG"), nTemp);
		nGroupTotal[20] += nTemp;
		xls.SetCellText(nCol+20, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_VAT_TU_TG"), nTemp);
		nGroupTotal[21] += nTemp;
		xls.SetCellText(nCol+21, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TONG_THU1"), nTemp);
		nGroupTotal[22] += nTemp;
		xls.SetCellText(nCol+22, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("MIEN_GIAM"), nTemp);
		nGroupTotal[23] += nTemp;
		xls.SetCellText(nCol+23, nRow, double2str(nTemp), FMT_NUMBER1);	

		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[22] > 0)
	{
		xls.SetCellText(1, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 2; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
		}
		nRow++;
	}

	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_THV22.xls"));
}
CString CFMServicePaidSummaryByDept_2024::GetQueryString2_v15()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2, szWhere5;
	CString szOrderBy, szReceiptStr, szSQL21,szSQL22, szSQL23, szSQL24, szSQL25, szSQL26, szSQL27, szSQL28, szSQL29;
	CString szDepts;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}
	//szReceiptStr2.Format(_T(" fac_cash_id IN (%s)"), szReceiptStr);

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));
	if (nCount < m_wndList.GetItemCount() && nCount > 0)
	{
		if (nCount <1000)
		{
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND fac_cash_id in(%s)) "), szReceiptStr);
		}
		else
		{
			CStringToken tok_id(szReceiptStr);
			int nCount = 0;
			long nTemp = 0;
			CString szIds, tmpStr;
			bool bBreak = false;
			szIds.Empty();
			tmpStr.Empty();
			for (int i = 0; i < tok_id.GetSize(); i++)
			{
				if (nCount > 999)
				{
					bBreak = true;
				}
				if (bBreak)
				{
					if (!szIds.IsEmpty())
					{
						szIds += _T(" OR ");
					}
					szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
					//_tprintf(_T("\nszIds: %s\n"), szIds);
					tmpStr.Empty();
					nCount = 0;
					bBreak = false;
				}
				if (!tmpStr.IsEmpty())
				{
					tmpStr += _T(",");
				}
				tok_id.GetAt(i, nTemp);
				tmpStr.AppendFormat(_T("%ld"), nTemp);
				nCount++;
			}
			if (!szIds.IsEmpty())
			{
				szIds += _T(" OR ");
			}
			szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND (%s))"), szIds);
		}
	}
	else
	{
		szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl)"));
	}


	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);
	szWhere.Empty();
	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	
	/*if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}*/


	if (m_szPhanloaiKey == _T("NGT"))
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	else if (m_szPhanloaiKey == _T("NT"))
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else
	{
		szWhere1.AppendFormat(_T(" AND 1=1 "));
	}


	for (int i = 0; i < m_wndDeptList.GetItemCount(); i++)
	{
		if (m_wndDeptList.GetCheck(i))
		{
			if (!szDepts.IsEmpty())
				szDepts += _T(",");
			szDepts.AppendFormat(_T("'%s'"), m_wndDeptList.GetItemText(i, 0));
		}
	}

	if (!szDepts.IsEmpty())
	{
		szWhere5.AppendFormat(_T(" and khoatt in(%s) "), szDepts);
	}


	if (m_nAllObj == 0)
	{
		szWhere5.AppendFormat(_T(" and 1=1 "));
	}
	else if (m_nService == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong = 7 "));
	}
	else if (m_nOtherObj == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong IN (1, 3, 8, 13) "));
	}

	else if (m_nInsurance == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong not in  (1, 3, 7, 8, 13) "));
	}
	else
	{
		szWhere5.AppendFormat(_T(" and 0>1 "));
	}
	
	//Case when like this very very...
	//Chi tiet theo bao cao tong hop khoa thuc hien//
	//if (m_bSOD)
//Chuẩn từ đây
{
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				_T("       f.hfe_cost as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type ='B'") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       f.hfe_cost as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('C0000')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND HPC_PDEPTID is not NULL") \
				_T("     ") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T("       AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20', 'B1E00', 'C5') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     ") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       f.hfe_cost AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       f.hfe_cost AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'PĐD', 'HC')") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("	   0 AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       f.hfe_cost as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
 //25. Miễn giảm tính vào khoa thanh toán cuối cùng//
 szSQL26.Format(_T(" UNION ALL") \
				_T("     SELECT hfd.hfe_docno,") \
				_T("       hfd.hfe_type,") \
				_T("       ivf.hfe_invoiceno,") \
				_T("       ivf.hfe_date,") \
				_T("       0 AS hfe_quantity,     ") \
				_T("       hfd.HFE_DEPTID AS khoa_thuchien,") \
				_T("       NULL,") \
				_T("       0             AS TIEN_KHAM,") \
				_T("       0             AS TIEN_GIUONG,") \
				_T("       0             AS TIEN_CLS,") \
				_T("       0             AS TIEN_PTTT,") \
				_T("       0             AS TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0             AS TIEN_THUOC_CH_NOITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0             AS TIEN_THUOC_PM,") \
				_T("       0             AS TIEN_VAT_TU_PM,") \
				_T("       0             AS TIEN_MAU,") \
				_T("       0             AS THU_KHAC,") \
				_T("       0             AS THU_GOI,") \
				_T("       0             AS TIEN_AN,") \
				_T("       0             AS TIEN_AN_HC,") \
				_T("       0             AS TIEN_THUOC_TG,") \
				_T("       0             AS TIEN_VAT_TU_TG,") \
				_T("       0             AS TIEN_THUOC_TG_O,") \
				_T("       0             AS TIEN_VAT_TU_TG_O,") \
				_T("       hfd.hfe_amount             AS MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_discount hfd") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_DISCOUNT ivf") \
				_T("     ON (hfd.hfe_docno =ivf.hfe_docno") \
				_T("     AND hfd.hfe_refidx=ivf.hfe_invoiceno)") \
				_T("     WHERE 1             =1 %s") \
				_T("     AND hfd.hfe_status  IN ('P')") \
				_T("     AND hfd.hfe_type    IN ('D') "), szWhere); 

		//20. Phi thu goi, them vao ngay 13/11/2018//
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				//_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \//
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);

szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);

//Tách phí máu lưu trong cận lâm sàng ra
 szSQL27.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("    )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   = 'Y'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
//Tách vòng đeo tay ra
				szSQL28.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id IN ('PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//Tách phần chọn BS ra
				szSQL29.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       f.hfe_cost AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   = '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
}
rs.ExecSQL(szSQL);
	
   szSQL.Format(_T(" WITH tbl AS (%s)") \
				_T(" SELECT") \
				_T(" dept_id, SD_MAKHOA_TAICHINH, doituong, ") \
				_T(" SUM(TIEN_KHAM) as TIEN_KHAM,") \
				_T(" SUM(TIEN_GIUONG) as TIEN_GIUONG,") \
				_T(" SUM(TIEN_CLS) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT) as TIEN_PTTT,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_PM) AS TIEN_THUOC_PM,") \
				_T(" SUM(TIEN_VAT_TU_PM) AS TIEN_VAT_TU_PM,") \
				_T(" SUM(TIEN_MAU) as TIEN_MAU,") \
				_T(" SUM(THU_KHAC) as THU_KHAC,") \
				_T(" SUM(THU_GOI) as THU_GOI,") \
				_T(" SUM(TIEN_AN) as TIEN_AN,") \
				_T(" SUM(TIEN_AN_HC) as TIEN_AN_HC,") \
				_T(" SUM(TIEN_THUOC_TG+TIEN_THUOC_TG_O) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG+TIEN_VAT_TU_TG_O) as TIEN_VAT_TU_TG,") \
				_T(" SUM(MIEN_GIAM) AS MIEN_GIAM,") \
				_T(" SUM(CHON_BS) AS CHON_BS,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+CHON_BS) as TONG_THU,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+CHON_BS) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(iv.hfe_docno) as HO_TEN,") \
				_T("   iv.hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    trunc(hfe_date) as invoice_date,") \
				_T("    trunc(FAC_POSTEDDATE) as posted_date,") \
				_T("    khoa_thuchien as dept_id,iv.doituong as doituong,") \

				_T("    CASE") \
				_T("         WHEN NVL(iv.hfe_org_id, 'XX' )= 'EM'") \
				_T("         AND iv.hfe_deptid              = 'A3-D'") \
				_T("         THEN hd_admitdept") \
				_T("         ELSE iv.hfe_deptid") \
				_T("       END AS khoatt,") \

				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_AN_HC,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     MIEN_GIAM,") \
				_T("     CHON_BS,") \
				_T("     hfe_itemid") \
				_T("   FROM HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=iv.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN  (") \
				_T("    %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s") \
				//_T("    %s %s ") \//
				_T("   )tbl1 ON (iv.hfe_invoiceno = tbl1.hfe_invoiceno and iv.hfe_docno = tbl1.hfe_docno)") \
				_T("   WHERE 1=1 %s") \
				_T("   )") \
				_T(" left join sys_dept on (sd_id = dept_id) where 1=1 %s ") \
				_T(" GROUP BY ") \
				_T(" dept_id, SD_MAKHOA_TAICHINH, doituong ") \
				_T(" HAVING SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+") \
				_T("	TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+") \
				_T("	TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+TIEN_THUOC_TG_O+TIEN_VAT_TU_TG_O+CHON_BS)>0") \
				_T(" ORDER BY dept_id"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szSQL26, szSQL27, szSQL28, szSQL29, szWhere1, szWhere5);
				//_T(" ORDER BY dept_id"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szWhere1);
	return szSQL;
}

void CFMServicePaidSummaryByDept_2024::OnExportv16(int nVersion)

{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	AfxMessageBox(_T("Phân tích thuốc nhập tại B5, lấy theo thời gian cấp phát, khoa là khoa chỉ định phẫu thuật. Lấy theo từ ngày đến ngày, ko theo số phiếu thu chi"));	
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1, i = 0;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
		{
			nTotal[i] = 0;
			nGroupTotal[i] = 0;
		}
	CExcel xls;
	if (!xls.Load(_T("Exports\\Template\\TONGHOP_THUOC_VATTU_B5.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetSheetName(_T("Sheet 0"));
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);

	
	szSQL = GetQueryString_v16();
	//AfxMessageBox(szSQL);

	rs.ExecSQL(szSQL);
	
	
	nRow = 9;
	nCol = 0;

	while(!rs.IsEOF())
	{	
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("patname"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("docno"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_INTEGER);
		
		rs.GetValue(_T("khoa"), tmpStr);
		xls.SetCellText(nCol+3, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("ma_khoa_tc"), tmpStr);
		xls.SetCellText(nCol+4, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("tenthuoc"), tmpStr);
		xls.SetCellText(nCol+5, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("thanhtienthuoc"), nTemp);
		nGroupTotal[6] += nTemp;
		xls.SetCellText(nCol+6, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("tenvattu"), tmpStr);
		xls.SetCellText(nCol+7, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("thanhtienvattu"), nTemp);
		nGroupTotal[8] += nTemp;
		xls.SetCellText(nCol+8, nRow, double2str(nTemp), FMT_NUMBER1);		

		rs.GetValue(_T("thanhtien"), nTemp);
		nGroupTotal[9] += nTemp;
		xls.SetCellText(nCol+9, nRow, double2str(nTemp), FMT_NUMBER1);
			
		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[9] > 0)
	{
		xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 6; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
			nTotal[i] += nGroupTotal[i];
		}
		nRow++;
	}	

	xls.SetActiveSheet(0);
	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_THUOC_VATTU_B52.xls"));
}
CString CFMServicePaidSummaryByDept_2024::GetQueryString_v16()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd(); 
	CRecord rs(&pMF->m_db);
	CString szSQL;
	CString tmpStr, szTemp, szWhere, szWhere1, szWhere2;
	long nDocumentNo;
	
	UpdateData(TRUE);

				szSQL.Format(_T(" SELECT hpol_docno as docno,") \
				_T(" GET_PATIENTNAME(hpol_docno) as patname,") \
				_T(" ho_deptid as khoa,") \
				_T(" SD_MAKHOA_TAICHINH as ma_khoa_tc,") \
				_T(" mp_name as ten,") \
				_T(" case when NVL(MP_ORG_ID, 'XX') ='PM' then mp_name else NULL end AS tenthuoc,") \
				_T("   case when NVL(MP_ORG_ID, 'XX') <>'PM' then mp_name else NULL end AS tenvattu,") \
				_T("   case when NVL(MP_ORG_ID, 'XX') ='PM' then hpol_qtyissue * hpol_unitprice else 0 end AS thanhtienthuoc,") \
				_T("   case when NVL(MP_ORG_ID, 'XX') <>'PM' then hpol_qtyissue * hpol_unitprice else 0 end AS thanhtienvattu,") \
				_T("   hpol_qtyissue * hpol_unitprice as thanhtien") \
				_T(" FROM HMS_PHARMAORDERLINE_VIEW_PMV2") \
				_T(" LEFT JOIN HMS_PHARMAORDER_VIEW_B5_V2") \
				_T(" ON (hpol_docno = hpo_docno and hpol_orderid = hpo_orderid)") \
				_T(" LEFT JOIN m_product ON (hpol_product_id = mp_product_id)") \
				_T(" LEFT JOIN hms_operation ON (ho_docno = hpo_docno and ho_idx = hpo_reference_id)") \
				_T(" LEFT JOIN sys_dept ON (ho_deptid = sd_id)") \
				_T(" WHERE hpo_approvedate BETWEEN TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS') ") \
				_T(" AND TO_TIMESTAMP('%s', 'YYYY-MM-DD HH24:MI:SS')") \
				_T(" and hpo_org_id = 'SMM'") \
				_T(" and HPO_ORDERSTATUS ='A'") \
				_T(" order by hpol_docno, mp_name"), m_szFromDate, m_szToDate);

			rs.ExecSQL(szSQL);	
			return szSQL;
}

void CFMServicePaidSummaryByDept_2024::OnExport2xxx(int nVersion)
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1, i=0;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
	{
		nTotal[i] = 0;
		nGroupTotal[i] = 0;
	}
	CExcel xls;
	if (!xls.Load(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_THxxx.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);
	if (nVersion == 1)
	{
		szSQL = GetQueryString2();
	}
	else
	{
		szSQL = GetQueryString2_v2xxx();
		AfxMessageBox(_T("Bỏ tiền vòng đeo tay...ra khỏi cột vật tư của khoa yêu cầu! "));
		//AfxMessageBox(szSQL);
	}
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	//AfxMessageBox(szSQL);
	AfxMessageBox(_T("Thay đổi cách tính miễn giảm từ khoa ra viện -> khoa thực hiện (bao gồm nghiệp vụ miễn theo đề mục & miễn giảm tổng)"));	
	nRow = 9;
	nCol = 0;
	while(!rs.IsEOF())
	{
		
		int i = 0;
		if(nRow == 65000)
		{
			i++;
			tmpStr.Format(_T("Sheet %d"), i);
			xls.AddSheet(tmpStr);
			xls.SetWorksheet(i);
			nRow = 1;
		}

		rs.GetValue(_T("dept_id"), szNewDept);
		if (!szNewDept.IsEmpty() && szOldDept != szNewDept)
		{
			if (nGroupTotal[25] > 0)
			{
				xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);

				for(int i = 6; i < 30; i++)
				{
					xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
					nTotal[i] += nGroupTotal[i];
					nGroupTotal[i] = 0;
				}
				nRow++;
			}
			xls.SetCellText(0, nRow, szNewDept, FMT_TEXT, true);
			szOldDept = szNewDept;
			nIdx = 1;
			nRow++;
		}	
		
		
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("dept_id"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("SD_MAKHOA_TAICHINH"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("tenmucphi"), tmpStr);
		xls.SetCellText(nCol+3, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("soluong"), tmpStr);
		xls.SetCellText(nCol+4, nRow, tmpStr, FMT_NUMBER1);

		rs.GetValue(_T("dongia"), tmpStr);
		xls.SetCellText(nCol+5, nRow, tmpStr, FMT_NUMBER1);
		

		rs.GetValue(_T("TIEN_KHAM"), nTemp);
		nGroupTotal[6] += nTemp;
		xls.SetCellText(nCol+6, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_GIUONG"), nTemp);
		nGroupTotal[7] += nTemp;
		xls.SetCellText(nCol+7, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_CLS"), nTemp);
		nGroupTotal[8] += nTemp;
		xls.SetCellText(nCol+8, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_PTTT"), nTemp);
		nGroupTotal[9] += nTemp;
		xls.SetCellText(nCol+9, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NGOAITRU"), nTemp);
		nGroupTotal[10] += nTemp;
		xls.SetCellText(nCol+10, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NOITRU"), nTemp);
		nGroupTotal[11] += nTemp;
		xls.SetCellText(nCol+11, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NGOAITRU"), nTemp);
		nGroupTotal[12] += nTemp;
		xls.SetCellText(nCol+12, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NOITRU"), nTemp);
		nGroupTotal[13] += nTemp;
		xls.SetCellText(nCol+13, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_PM"), nTemp);
		nGroupTotal[14] += nTemp;
		xls.SetCellText(nCol+14, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_PM"), nTemp);
		nGroupTotal[15] += nTemp;
		xls.SetCellText(nCol+15, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_MAU"), nTemp);
		nGroupTotal[16] += nTemp;
		xls.SetCellText(nCol+16, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_KHAC"), nTemp);
		nGroupTotal[17] += nTemp;
		xls.SetCellText(nCol+17, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_GOI"), nTemp);
		nGroupTotal[18] += nTemp;
		xls.SetCellText(nCol+18, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("CHON_BS"), nTemp);
		nGroupTotal[19] += nTemp;
		xls.SetCellText(nCol+19, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TONG_THU"), nTemp);
		nGroupTotal[20] += nTemp;
		xls.SetCellText(nCol+20, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_AN"), nTemp);
		nGroupTotal[21] += nTemp;
		xls.SetCellText(nCol+21, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_AN_HC"), nTemp);
		nGroupTotal[22] += nTemp;
		xls.SetCellText(nCol+22, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_THUOC_TG"), nTemp);
		nGroupTotal[23] += nTemp;
		xls.SetCellText(nCol+23, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_VAT_TU_TG"), nTemp);
		nGroupTotal[24] += nTemp;
		xls.SetCellText(nCol+24, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TONG_THU1"), nTemp);
		nGroupTotal[25] += nTemp;
		xls.SetCellText(nCol+25, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("MIEN_GIAM"), nTemp);
		nGroupTotal[26] += nTemp;
		xls.SetCellText(nCol+26, nRow, double2str(nTemp), FMT_NUMBER1);	

		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[25] > 0)
	{
		xls.SetCellText(2, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 6; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
			nTotal[i] += nGroupTotal[i];
		}
		nRow++;
	}

	if (nTotal[25] >0)
	{
		xls.SetCellText(2, nRow, _T("Tổng cộng"), FMT_TEXT, true);
		for(int i = 6; i < 30; i++)
		{
			if (nTotal[i] > 0)
			{
				xls.SetCellText(i, nRow, double2str(nTotal[i]), FMT_NUMBER1, true);
			}
		}
		nRow++;
	}
	xls.SetActiveSheet(0);
	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_TH2xxx.xls"));
}

CString CFMServicePaidSummaryByDept_2024::GetQueryString2_v2xxx()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2;
	CString szOrderBy, szReceiptStr, szSQL21,szSQL22, szSQL23, szSQL24, szSQL25, szSQL26, szSQL27, szSQL28, szSQL29;
	CString szDepts, szWhere5;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}
	//szReceiptStr2.Format(_T(" fac_cash_id IN (%s)"), szReceiptStr);

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));
	if (nCount < m_wndList.GetItemCount() && nCount > 0)
	{
		if (nCount <1000)
		{
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND fac_cash_id in(%s)) "), szReceiptStr);
		}
		else
		{
			CStringToken tok_id(szReceiptStr);
			int nCount = 0;
			long nTemp = 0;
			CString szIds, tmpStr;
			bool bBreak = false;
			szIds.Empty();
			tmpStr.Empty();
			for (int i = 0; i < tok_id.GetSize(); i++)
			{
				if (nCount > 999)
				{
					bBreak = true;
				}
				if (bBreak)
				{
					if (!szIds.IsEmpty())
					{
						szIds += _T(" OR ");
					}
					szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
					//_tprintf(_T("\nszIds: %s\n"), szIds);
					tmpStr.Empty();
					nCount = 0;
					bBreak = false;
				}
				if (!tmpStr.IsEmpty())
				{
					tmpStr += _T(",");
				}
				tok_id.GetAt(i, nTemp);
				tmpStr.AppendFormat(_T("%ld"), nTemp);
				nCount++;
			}
			if (!szIds.IsEmpty())
			{
				szIds += _T(" OR ");
			}
			szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND (%s))"), szIds);
		}
	}
	else
	{
		szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl)"));
	}


	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);
	szWhere.Empty();
	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	if (m_szPhanloaiKey == _T("NGT"))
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	else if (m_szPhanloaiKey == _T("NT"))
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else
	{
		szWhere1.AppendFormat(_T(" AND 1=1 "));
	}


	for (int i = 0; i < m_wndDeptList.GetItemCount(); i++)
	{
		if (m_wndDeptList.GetCheck(i))
		{
			if (!szDepts.IsEmpty())
				szDepts += _T(",");
			szDepts.AppendFormat(_T("'%s'"), m_wndDeptList.GetItemText(i, 0));
		}
	}

	if (!szDepts.IsEmpty())
	{
		szWhere5.AppendFormat(_T(" and khoatt in(%s) "), szDepts);
	}


	if (m_nAllObj == 0)
	{
		szWhere5.AppendFormat(_T(" and 1=1 "));
	}
	else if (m_nService == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong = 7 "));
	}
	else if (m_nOtherObj == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong IN (1, 3, 8, 13) "));
	}

	else if (m_nInsurance == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong not in  (1, 3, 7, 8, 13) "));
	}
	else
	{
		szWhere5.AppendFormat(_T(" and 0>1 "));
	}
	
	//Case when like this very very...
	//Chi tiet theo bao cao tong hop khoa thuc hien//
	if (m_bSOD)
	//if (0>1)
{
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				_T("       f.hfe_cost as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				//_T("     AND f.hfe_itemid <> 'D0000006'") \//
				_T("     AND f.hfe_cost>0") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN (f.hfe_type ='B' OR f.hfe_itemid='D0000006')") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       f.hfe_cost as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND (F.Hfe_Group     IN ('C0000'))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND HPC_PDEPTID is not NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				//_T("         AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,") \//
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P', 'T'))") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T("       AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20', 'B1E00', 'C5') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type IN ('O'))") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				//_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \//
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				//_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \//
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       f.hfe_cost AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       f.hfe_cost AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P', 'COV', 'BN')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T(" 0,0, NULL, NULL,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       f.hfe_cost as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
 //25. Miễn giảm tính vào khoa thanh toán cuối cùng, trong trường hợp TC miễn//
 szSQL26.Format(_T(" UNION ALL") \
				_T("     SELECT hfd.hfe_docno,") \
				_T("       hfd.hfe_type,") \
				_T("       ivf.hfe_invoiceno,") \
				_T("       ivf.hfe_date,") \
				_T(" 0,0, NULL, NULL,") \
				_T("       hfd.HFE_DEPTID AS khoa_thuchien,") \
				_T("       NULL,") \
				_T("       0             AS TIEN_KHAM,") \
				_T("       0             AS TIEN_GIUONG,") \
				_T("       0             AS TIEN_CLS,") \
				_T("       0             AS TIEN_PTTT,") \
				_T("       0             AS TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0             AS TIEN_THUOC_CH_NOITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0             AS TIEN_THUOC_PM,") \
				_T("       0             AS TIEN_VAT_TU_PM,") \
				_T("       0             AS TIEN_MAU,") \
				_T("       0             AS THU_KHAC,") \
				_T("       0             AS THU_GOI,") \
				_T("       0             AS TIEN_AN,") \
				_T("       0             AS TIEN_AN_HC,") \
				_T("       0             AS TIEN_THUOC_TG,") \
				_T("       0             AS TIEN_VAT_TU_TG,") \
				_T("       0             AS TIEN_THUOC_TG_O,") \
				_T("       0             AS TIEN_VAT_TU_TG_O,") \
				_T("       hfd.hfe_amount             AS MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_discount hfd") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_DISCOUNT ivf") \
				_T("     ON (hfd.hfe_docno =ivf.hfe_docno") \
				_T("     AND hfd.hfe_refidx=ivf.hfe_invoiceno)") \
				_T("     WHERE 1             =1 %s") \
				_T("     AND hfd.hfe_status  IN ('P')") \
				_T(" AND (SELECT COUNT(*)") \
				_T(" FROM hms_fee_discountline fdl") \
				_T(" WHERE hfd.hfe_docno   = fdl.hfe_docno") \
				_T(" AND hfd.hfe_invoiceno = fdl.hfe_invoiceno )= 0") \
				_T("     AND hfd.hfe_type    IN ('D') "), szWhere);
   
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				//_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \//
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);

szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid AND f.hfe_type   IN ('P'))") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid    AND f.hfe_type  IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//Tách phí máu lưu trong cận lâm sàng ra
 szSQL27.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     AND f.hfe_type   IN ('P', 'T'))") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   = 'Y'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
 //Tách vòng đeo tay ra
				szSQL28.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id IN ('PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//Tách phí chọn bác sĩ
			szSQL29.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       f.hfe_cost AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   = '501'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);

}
else
//Chuẩn từ đây
{
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				_T("       f.hfe_cost as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type ='B'") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       f.hfe_cost as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('C0000')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				/*_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500')") \
				_T("         AND su_deptid       IS NOT NULL") \
				_T("         THEN Su_Deptid") \
				_T("       END khoa_thuchien,") \*/

				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND HPC_PDEPTID is not NULL") \
				_T("     ") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				//_T("         AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,") \//
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T("       AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20', 'B1E00', 'C5') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     ") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				//_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \//
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				//_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \//
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       f.hfe_cost AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       f.hfe_cost AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   IN ('N','BQP','COV','XX', 'BN') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'PĐD', 'HC')") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX','P', 'COV', 'BN')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity, 0, null, null,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("	   0 AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       f.hfe_cost as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
 //25. Miễn giảm tính vào khoa thanh toán cuối cùng//
 szSQL26.Format(_T(" UNION ALL") \
				_T("     SELECT hfd.hfe_docno,") \
				_T("       hfd.hfe_type,") \
				_T("       ivf.hfe_invoiceno,") \
				_T("       ivf.hfe_date,") \
				_T(" 0,0, NULL, NULL,") \
				_T("       hfd.HFE_DEPTID AS khoa_thuchien,") \
				_T("       NULL,") \
				_T("       0             AS TIEN_KHAM,") \
				_T("       0             AS TIEN_GIUONG,") \
				_T("       0             AS TIEN_CLS,") \
				_T("       0             AS TIEN_PTTT,") \
				_T("       0             AS TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0             AS TIEN_THUOC_CH_NOITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0             AS TIEN_THUOC_PM,") \
				_T("       0             AS TIEN_VAT_TU_PM,") \
				_T("       0             AS TIEN_MAU,") \
				_T("       0             AS THU_KHAC,") \
				_T("       0             AS THU_GOI,") \
				_T("       0             AS TIEN_AN,") \
				_T("       0             AS TIEN_AN_HC,") \
				_T("       0             AS TIEN_THUOC_TG,") \
				_T("       0             AS TIEN_VAT_TU_TG,") \
				_T("       0             AS TIEN_THUOC_TG_O,") \
				_T("       0             AS TIEN_VAT_TU_TG_O,") \
				_T("       hfd.hfe_amount             AS MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_discount hfd") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_DISCOUNT ivf") \
				_T("     ON (hfd.hfe_docno =ivf.hfe_docno") \
				_T("     AND hfd.hfe_refidx=ivf.hfe_invoiceno)") \
				_T("     WHERE 1             =1 %s") \
				_T("     AND hfd.hfe_status  IN ('P')") \
				_T("     AND hfd.hfe_type    IN ('D') "), szWhere); 

		//20. Phi thu goi, them vao ngay 13/11/2018//
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				//_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \//
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);

szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);

//Tách phí máu lưu trong cận lâm sàng ra
 szSQL27.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("    )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   = 'Y'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//Tách vòng đeo tay ra
				szSQL28.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id IN ('PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    IN ('N','BQP','COV','XX', 'BN')"), szWhere);
//Tách phần chọn BS ra
				szSQL29.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       f.hfe_cost AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   = '501'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
}
rs.ExecSQL(szSQL);
	
   szSQL.Format(_T(" WITH tbl AS (%s)") \
				_T(" SELECT") \
				_T(" dept_id, SD_MAKHOA_TAICHINH, nhomphi,tenmucphi, sum(soluong) as soluong, dongia, ") \
				_T(" SUM(TIEN_KHAM) as TIEN_KHAM,") \
				_T(" SUM(TIEN_GIUONG) as TIEN_GIUONG,") \
				_T(" SUM(TIEN_CLS) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT) as TIEN_PTTT,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_PM) AS TIEN_THUOC_PM,") \
				_T(" SUM(TIEN_VAT_TU_PM) AS TIEN_VAT_TU_PM,") \
				_T(" SUM(TIEN_MAU) as TIEN_MAU,") \
				_T(" SUM(THU_KHAC) as THU_KHAC,") \
				_T(" SUM(THU_GOI) as THU_GOI,") \
				_T(" SUM(TIEN_AN) as TIEN_AN,") \
				_T(" SUM(TIEN_AN_HC) as TIEN_AN_HC,") \
				_T(" SUM(TIEN_THUOC_TG+TIEN_THUOC_TG_O) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG+TIEN_VAT_TU_TG_O) as TIEN_VAT_TU_TG,") \
				_T(" SUM(MIEN_GIAM) AS MIEN_GIAM,") \
				_T(" SUM(CHON_BS) AS CHON_BS,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+CHON_BS) as TONG_THU,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+CHON_BS) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(iv.hfe_docno) as HO_TEN,") \
				_T("   iv.hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    trunc(hfe_date) as invoice_date,") \
				_T("    trunc(FAC_POSTEDDATE) as posted_date,") \
				_T("    khoa_thuchien as dept_id,iv.doituong as doituong,") \

				_T("    CASE") \
				_T("         WHEN NVL(iv.hfe_org_id, 'XX' )= 'EM'") \
				_T("         AND iv.hfe_deptid              = 'A3-D'") \
				_T("         THEN hd_admitdept") \
				_T("         ELSE iv.hfe_deptid") \
				_T("       END AS khoatt,") \

				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_AN_HC,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     MIEN_GIAM,") \
				_T("     CHON_BS,") \
				_T("     hfe_itemid,") \
				_T("     hfg_type_id as nhomphi,") \
				_T("     hfe_desc as tenmucphi,") \
				_T("     hfe_quantity as soluong,") \
				_T("     hfe_unitprice as dongia") \
				_T("   FROM HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=iv.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN  (") \
				_T("    %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s") \
				//_T("    %s %s ") \//
				_T("   )tbl1 ON (iv.hfe_invoiceno = tbl1.hfe_invoiceno and iv.hfe_docno = tbl1.hfe_docno)") \
				_T("  LEFT JOIN hms_fee_group ON (hfg_id=tbl1.hfe_group)") \
				_T("   WHERE 1=1 %s") \
				_T("   )") \
				_T(" left join sys_dept on (sd_id = dept_id) where 1=1 %s ") \
				_T(" GROUP BY ") \
				_T(" dept_id, SD_MAKHOA_TAICHINH, doituong, nhomphi, tenmucphi, dongia ") \
				_T(" HAVING SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+") \
				_T("	TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+") \
				_T("	TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+TIEN_THUOC_TG_O+TIEN_VAT_TU_TG_O+CHON_BS)>0") \
				_T(" ORDER BY dept_id"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szSQL26, szSQL27, szSQL28, szSQL29, szWhere1, szWhere5);
				//_T(" ORDER BY dept_id"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szWhere1);
	return szSQL;
}

void CFMServicePaidSummaryByDept_2024::OnExport3xxx(int nVersion)
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1;
	double nTemp = 0, nTemp1=0;
	double nTotal[31], nGroupTotal[31];
	for(int i = 0; i < 31; i++)
		{
			nTotal[i] = 0;
			nGroupTotal[i] = 0;
		}
	CExcel xls;
	if (!xls.Load(_T("Exports\\TONGHOP_CHIPHI_BOIDUONG_TOANVIEN.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);
	if (nVersion == 1)
	{
		szSQL = GetQueryString2();
	}
	else
	{
		szSQL = GetQueryString3_v2xxx();
		AfxMessageBox(_T("Thống kê chi phí phẫu thuật thủ thuật để tính công. Khối xét nghiệm đang ko lấy vào! "));
	//AfxMessageBox(szSQL);
	}
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	//AfxMessageBox(szSQL);
	//AfxMessageBox(_T("Thay đổi cách tính miễn giảm từ khoa ra viện -> khoa thực hiện (bao gồm nghiệp vụ miễn theo đề mục & miễn giảm tổng)"));	
	nRow = 9;
	nCol = 0;
	while(!rs.IsEOF())
	{
	
		int i = 0;
		if(nRow == 65000)
		{
			i++;
			tmpStr.Format(_T("Sheet %d"), i);
			xls.AddSheet(tmpStr);
			xls.SetWorksheet(i);
			nRow = 1;
		}
	
		rs.GetValue(_T("dept_id"), szNewDept);
		if (szOldDept != szNewDept)
		{
			if (nGroupTotal[25] > 0)
			{
				xls.SetCellText(2, nRow, _T("Cộng"), FMT_TEXT, true);

				for(int i = 3; i < 31; i++)
				{
					if (nGroupTotal[i] > 0)
	{	
						xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_CURRENCY1, true);
						nTotal[i] += nGroupTotal[i];
					}
					nGroupTotal[i] = 0;
				}
				nRow++;
			}
			xls.SetCellText(0, nRow, szNewDept, FMT_TEXT, true);
			szOldDept = szNewDept;
			nIdx = 1;
			nRow++;
		}
		
		
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("dept_id"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("SD_MAKHOA_TAICHINH"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("tenmucphi"), tmpStr);
		xls.SetCellText(nCol+3, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("soluong"), tmpStr);
		xls.SetCellText(nCol+4, nRow, tmpStr, FMT_NUMBER1);

		rs.GetValue(_T("dongia"), tmpStr);
		xls.SetCellText(nCol+5, nRow, tmpStr, FMT_NUMBER1);		
		
		rs.GetValue(_T("TIEN_CLS"), nTemp);
		nGroupTotal[6] += nTemp;
		xls.SetCellText(nCol+6, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_PTTT"), nTemp);
		nGroupTotal[7] += nTemp;
		xls.SetCellText(nCol+7, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_TG"), nTemp);
		nGroupTotal[8] += nTemp;
		xls.SetCellText(nCol+8, nRow, double2str(nTemp), FMT_NUMBER1);		

		rs.GetValue(_T("TIEN_VAT_TU_TG"), nTemp);
		nGroupTotal[9] += nTemp;
		xls.SetCellText(nCol+9, nRow, double2str(nTemp), FMT_NUMBER1);
			
		rs.GetValue(_T("tgthuchien"), tmpStr);
		xls.SetCellText(nCol+10, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("bsphauthuat"), tmpStr);
		xls.SetCellText(nCol+11, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("bsphu"), tmpStr);
		xls.SetCellText(nCol+12, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("bsgayme"), tmpStr);
		xls.SetCellText(nCol+13, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("phume"), tmpStr);
		xls.SetCellText(nCol+14, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("votrung"), tmpStr);
		xls.SetCellText(nCol+15, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("huutrung"), tmpStr);
		xls.SetCellText(nCol+16, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("vocam"), tmpStr);
		xls.SetCellText(nCol + 17, nRow, tmpStr, FMT_TEXT);
		
		rs.GetValue(_T("khoayeucau"), tmpStr);
		xls.SetCellText(nCol+18, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("phongyeucau"), tmpStr);
		xls.SetCellText(nCol+19, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("docno"), tmpStr);
		xls.SetCellText(nCol+20, nRow, tmpStr, FMT_INTEGER);

		rs.GetValue(_T("HO_TEN"), tmpStr);
		xls.SetCellText(nCol+21, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("trangthaiphi"), tmpStr);
		xls.SetCellText(nCol+22, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("trangthaithuchien"), tmpStr);
		xls.SetCellText(nCol+23, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("TONG_THU"), nTemp);
		nGroupTotal[24] += nTemp;
		xls.SetCellText(nCol+24, nRow, double2str(nTemp), FMT_NUMBER1);		

		rs.GetValue(_T("TONG_THU1"), nTemp);
		nGroupTotal[25] += nTemp;
		xls.SetCellText(nCol+25, nRow, double2str(nTemp), FMT_NUMBER1);	

		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[25] > 0)
	{
		xls.SetCellText(1, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 2; i < 31; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
		}
		nRow++;
	}	

	if (nTotal[25] > 0)
	{
		xls.SetCellText(1, nRow, _T("Tổng cộng"), FMT_TEXT, true);
		for(int i = 2; i < 31; i++)
		{
			if (nTotal[i] > 0)
			{
				xls.SetCellText(i, nRow, double2str(nTotal[i]), FMT_CURRENCY1, true);
			}
		}
		nRow++;
	}
	xls.SetActiveSheet(0);
	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_BOIDUONG_TOANVIEN2.xls"));
}

CString CFMServicePaidSummaryByDept_2024::GetQueryString3_v2xxx()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd(); 
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2;
	CString szOrderBy, szReceiptStr, szSQL21,szSQL22, szSQL23, szSQL24, szSQL25, szSQL26, szSQL27, szSQL28, szSQL29;
	CString szDepts, szWhere5;
	CRecord rs(&pMF->m_db);
	int nCount = 0;
	
	szReceiptStr = _T("-1");
	UpdateData(TRUE);

	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}
	//szReceiptStr2.Format(_T(" fac_cash_id IN (%s)"), szReceiptStr);

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));
	if (nCount < m_wndList.GetItemCount() && nCount > 0)
	{
		if (nCount <1000)
		{
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND fac_cash_id in(%s)) "), szReceiptStr);
		}
		else
		{
			CStringToken tok_id(szReceiptStr);
			int nCount = 0;
			long nTemp = 0;
			CString szIds, tmpStr;
			bool bBreak = false;
			szIds.Empty();
			tmpStr.Empty();
			for (int i = 0; i < tok_id.GetSize(); i++)
			{
				if (nCount > 999)
				{
					bBreak = true;
				}
				if (bBreak)
				{
					if (!szIds.IsEmpty())
					{
						szIds += _T(" OR ");
					}
					szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
					//_tprintf(_T("\nszIds: %s\n"), szIds);
					tmpStr.Empty();
					nCount = 0;
					bBreak = false;
				}
				if (!tmpStr.IsEmpty())
				{
					tmpStr += _T(",");
				}
				tok_id.GetAt(i, nTemp);
				tmpStr.AppendFormat(_T("%ld"), nTemp);
				nCount++;
			}
			if (!szIds.IsEmpty())
			{
				szIds += _T(" OR ");
			}
			szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND (%s))"), szIds);
		}
	}
	else
	{
		szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl)"));
	}


	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);
	szWhere.Empty();
	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	if (m_szPhanloaiKey == _T("NGT"))
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	else if (m_szPhanloaiKey == _T("NT"))
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else
	{
		szWhere1.AppendFormat(_T(" AND 1=1 "));
	}


	for (int i = 0; i < m_wndDeptList.GetItemCount(); i++)
	{
		if (m_wndDeptList.GetCheck(i))
		{
			if (!szDepts.IsEmpty())
				szDepts += _T(",");
			szDepts.AppendFormat(_T("'%s'"), m_wndDeptList.GetItemText(i, 0));
		}
	}

	if (!szDepts.IsEmpty())
	{
		szWhere5.AppendFormat(_T(" and khoatt in(%s) "), szDepts);
	}


	if (m_nAllObj == 0)
	{
		szWhere5.AppendFormat(_T(" and 1=1 "));
	}
	else if (m_nService == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong = 7 "));
	}
	else if (m_nOtherObj == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong IN (1, 3, 8, 13) "));
	}

	else if (m_nInsurance == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong not in  (1, 3, 7, 8, 13) "));
	}
	else
	{
		szWhere5.AppendFormat(_T(" and 0>1 "));
	}
	
	
	//Case when like this very very...
	//Chi tiet theo bao cao tong hop khoa thuc hien//
	if (1==1)	
{
  //3. Tien can lam sang cho cac khoa thuc hien//
  szSQL1.Format(_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \

				_T(" GET_DRUG_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)  AS TIEN_THUOC_TG,    ") \
				_T(" GET_MAT_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)   AS TIEN_VAT_TU_TG,") \

				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category, ") \

				_T(" hpc_performdate  AS tgthuchien,") \

				_T(" (select HPCL_PRACTITIONER from hms_pacsorderline") \
				_T("       where hpcl_docno = f.hfe_docno") \
				_T("       and hpcl_orderid = f.hfe_orderid") \
				_T("       and hpcl_itemid = f.hfe_itemid") \
				_T(" and rownum <=1") \

				_T("       union all") \
				_T("       select HPC_PRACTITIONER from hms_testorder") \
				_T("       where hpc_docno = f.hfe_docno") \
				_T("       and hpc_orderid = f.hfe_orderid      ") \
				_T(" and rownum <=1") \

				_T("       ) AS bsphauthuat,") \

				_T("       NULL             AS bsphu,") \
				_T("       NULL bsgayme,") \
				_T("       NULL                                AS phume,") \
				_T("       NULL                                AS votrung,") \
				_T("       NULL                                AS huutrung,") \
				_T("       NULL                                AS vocam,") \
				_T("       HPC_DEPTID                          AS khoayeucau,") \
				_T("       get_roomname(HPC_DEPTID,hpc_roomid) AS phongyeucau,") \
				_T("       f.hfe_status                        AS trangthaiphi,") \
				_T("       hpc_status                          AS trangthaithuchien") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND HPC_PDEPTID is not NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \

				_T(" GET_DRUG_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)  AS TIEN_THUOC_TG,    ") \
				_T(" GET_MAT_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)   AS TIEN_VAT_TU_TG,") \

				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category, ") \

				_T(" hpc_performdate  AS tgthuchien,") \

				_T(" (select HPCL_PRACTITIONER from hms_pacsorderline") \
				_T(" where hpcl_docno = f.hfe_docno") \
				_T(" and hpcl_orderid = f.hfe_orderid") \
				_T(" and hpcl_itemid = f.hfe_itemid and rownum <= 1) AS bsphauthuat,") \

				_T("       NULL             AS bsphu,") \
				_T("       NULL bsgayme,") \
				_T("       NULL                                AS phume,") \
				_T("       NULL                                AS votrung,") \
				_T("       NULL                                AS huutrung,") \
				_T("       NULL                                AS vocam,") \
				_T("       HPC_DEPTID                          AS khoayeucau,") \
				_T("       get_roomname(HPC_DEPTID,hpc_roomid) AS phongyeucau,") \
				_T("       f.hfe_status                        AS trangthaiphi,") \
				_T("       hpc_status                          AS trangthaithuchien") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				//_T("         AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,") \//
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \

				_T(" GET_DRUG_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)  AS TIEN_THUOC_TG,    ") \
				_T(" GET_MAT_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)   AS TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category, ") \
				
								_T(" hpc_performdate  AS tgthuchien,") \
				_T("       HPC_PRACTITIONER AS bsphauthuat,") \
				_T("       NULL             AS bsphu,") \
				_T("       NULL bsgayme,") \
				_T("       NULL                                AS phume,") \
				_T("       NULL                                AS votrung,") \
				_T("       NULL                                AS huutrung,") \
				_T("       NULL                                AS vocam,") \
				_T("       HPC_DEPTID                          AS khoayeucau,") \
				_T("       get_roomname(HPC_DEPTID,hpc_roomid) AS phongyeucau,") \
				_T("       f.hfe_status                        AS trangthaiphi,") \
				_T("       hpc_status                          AS trangthaithuchien") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
 szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T("       AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20', 'B1E00', 'C5') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \

				_T(" GET_DRUG_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)  AS TIEN_THUOC_TG,    ") \
				_T(" GET_MAT_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)   AS TIEN_VAT_TU_TG,") \


				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category, ") \
								_T(" hpc_performdate  AS tgthuchien,") \

				_T(" (select HPCL_PRACTITIONER from hms_pacsorderline") \
				_T("       where hpcl_docno = f.hfe_docno") \
				_T("       and hpcl_orderid = f.hfe_orderid") \
				_T("       and hpcl_itemid = f.hfe_itemid") \
				_T("		and rownum <=1") \
				_T("       union all") \
				_T("       select HPC_PRACTITIONER from hms_testorder") \
				_T("       where hpc_docno = f.hfe_docno") \
				_T("       and hpc_orderid = f.hfe_orderid      ") \
				_T("		and rownum <=1") \
				_T("       ) AS bsphauthuat,") \

				_T("       NULL             AS bsphu,") \
				_T("       NULL bsgayme,") \
				_T("       NULL                                AS phume,") \
				_T("       NULL                                AS votrung,") \
				_T("       NULL                                AS huutrung,") \
				_T("       NULL                                AS vocam,") \
				_T("       HPC_DEPTID                          AS khoayeucau,") \
				_T("       get_roomname(HPC_DEPTID,hpc_roomid) AS phongyeucau,") \
				_T("       f.hfe_status                        AS trangthaiphi,") \
				_T("       hpc_status                          AS trangthaithuchien") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("  LEFT JOIN hmsv_pdept_paraclinicdv_55") \
				_T("     ON(f.hfe_docno                  = hpc_docno") \
				_T("     AND f.hfe_orderid               = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T(" GET_DRUG_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)  AS TIEN_THUOC_TG,    ") \
				_T(" GET_MAT_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)   AS TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category, ") \
				_T("  ho_performdate  AS tgthuchien,") \
				_T("       HO_PRACTITIONER AS bsphauthuat,") \
				_T("       ho_assistant    AS bsphu,") \
				_T("       ho_anaes_method bsgayme,") \
				_T("       ho_anesthetist                    AS phume,") \
				_T("       ho_user5                                AS votrung,") \
				_T("       ho_user7                                AS huutrung,") \
				_T("       ho_anes_method                                AS vocam,") \
				_T("       HO_DEPTID                         AS khoayeucau,") \
				_T("       get_roomname(HO_DEPTID,ho_roomid) AS phongyeucau,") \
				_T("       f.hfe_status                      AS trangthaiphi,") \
				_T("       ho_status                         AS trangthaithuchien") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
  else
  {
  szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T(" GET_DRUG_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)  AS TIEN_THUOC_TG,    ") \
				_T(" GET_MAT_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)   AS TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category, ") \
				_T("  ho_performdate  AS tgthuchien,") \
				_T("       HO_PRACTITIONER AS bsphauthuat,") \
				_T("       ho_assistant    AS bsphu,") \
				_T("       ho_anaes_method bsgayme,") \
				_T("       ho_anesthetist                    AS phume,") \
				_T("       ho_user5                                AS votrung,") \
				_T("       ho_user7                                AS huutrung,") \
				_T("       ho_anes_method                                AS vocam,") \
				_T("       HO_DEPTID                         AS khoayeucau,") \
				_T("       get_roomname(HO_DEPTID,ho_roomid) AS phongyeucau,") \
				_T("       f.hfe_status                      AS trangthaiphi,") \
				_T("       ho_status                        AS trangthaithuchien") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     AND f.hfe_type   = 'O')") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);
  }
 szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T(" GET_DRUG_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)  AS TIEN_THUOC_TG,    ") \
				_T(" GET_MAT_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)   AS TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category, ") \
				_T(" hpc_performdate  AS tgthuchien,") \

				_T(" (select HPCL_PRACTITIONER from hms_pacsorderline") \
				_T(" where hpcl_docno = f.hfe_docno") \
				_T(" and hpcl_orderid = f.hfe_orderid") \
				_T(" and hpcl_itemid = f.hfe_itemid and rownum <=1) AS bsphauthuat,") \


				_T("       NULL             AS bsphu,") \
				_T("       NULL bsgayme,") \
				_T("       NULL                                AS phume,") \
				_T("       NULL                                AS votrung,") \
				_T("       NULL                                AS huutrung,") \
				_T("       NULL                                AS vocam,") \
				_T("       HPC_DEPTID                          AS khoayeucau,") \
				_T("       get_roomname(HPC_DEPTID,hpc_roomid) AS phongyeucau,") \
				_T("       f.hfe_status                        AS trangthaiphi,") \
				_T("       hpc_status                          AS trangthaithuchien") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T(" GET_DRUG_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)  AS TIEN_THUOC_TG,    ") \
				_T(" GET_MAT_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)   AS TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category, ") \

				_T(" hpc_performdate  AS tgthuchien,") \
				_T(" (select HPCL_PRACTITIONER from hms_pacsorderline") \
				_T(" where hpcl_docno = f.hfe_docno") \
				_T(" and hpcl_orderid = f.hfe_orderid") \
				_T(" and hpcl_itemid = f.hfe_itemid and rownum<=1) AS bsphauthuat,") \
				_T("       NULL             AS bsphu,") \
				_T("       NULL bsgayme,") \
				_T("       NULL                                AS phume,") \
				_T("       NULL                                AS votrung,") \
				_T("       NULL                                AS huutrung,") \
				_T("       NULL                                AS vocam,") \
				_T("       HPC_DEPTID                          AS khoayeucau,") \
				_T("       get_roomname(HPC_DEPTID,hpc_roomid) AS phongyeucau,") \
				_T("       f.hfe_status                        AS trangthaiphi,") \
				_T("       hpc_status                          AS trangthaithuchien") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
//Tách phí máu lưu trong cận lâm sàng ra
 szSQL12.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T(" GET_DRUG_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)  AS TIEN_THUOC_TG,    ") \
				_T(" GET_MAT_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)   AS TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category, ") \
				_T(" hpc_performdate  AS tgthuchien,") \

				_T(" (select HPCL_PRACTITIONER from hms_pacsorderline") \
				_T("       where hpcl_docno = f.hfe_docno") \
				_T("       and hpcl_orderid = f.hfe_orderid") \
				_T("       and hpcl_itemid = f.hfe_itemid") \
				_T(" and rownum <=1") \
				_T("       union all") \
				_T("       select HPC_PRACTITIONER from hms_testorder") \
				_T("       where hpc_docno = f.hfe_docno") \
				_T("       and hpc_orderid = f.hfe_orderid      ") \
				_T(" and rownum <=1") \
				_T("       ) AS bsphauthuat,") \

				_T("       NULL             AS bsphu,") \
				_T("       NULL bsgayme,") \
				_T("       NULL                                AS phume,") \
				_T("       NULL                                AS votrung,") \
				_T("       NULL                                AS huutrung,") \
				_T("	   NULL									AS vocam,") \
				_T("       HPC_DEPTID                          AS khoayeucau,") \
				_T("       get_roomname(HPC_DEPTID,hpc_roomid) AS phongyeucau,") \
				_T("       f.hfe_status                        AS trangthaiphi,") \
				_T("       hpc_status                          AS trangthaithuchien") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   = 'Y'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'COV', 'BN')"), szWhere);
 
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T(" f.hfe_quantity,f.hfe_unitprice, f.hfe_group, f.hfe_desc,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T(" GET_DRUG_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)  AS TIEN_THUOC_TG,    ") \
				_T(" GET_MAT_INPACKAGE_AMOUNT(f.hfe_docno, f.hfe_orderid, f.hfe_itemid)   AS TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       f.hfe_cost AS CHON_BS,") \
				_T("       f.hfe_category, ") \
				_T("  ho_performdate  AS tgthuchien,") \
				_T("       HO_PRACTITIONER AS bsphauthuat,") \
				_T("       ho_assistant    AS bsphu,") \
				_T("       ho_anaes_method bsgayme,") \
				_T("       ho_anesthetist                    AS phume,") \
				_T("       ho_user5                                AS votrung,") \
				_T("       ho_user7                                AS huutrung,") \
				_T("       ho_anes_method                                AS vocam,") \
				_T("       HO_DEPTID                         AS khoayeucau,") \
				_T("       get_roomname(HO_DEPTID,ho_roomid) AS phongyeucau,") \
				_T("       f.hfe_status                      AS trangthaiphi,") \
				_T("       ho_status                         AS trangthaithuchien") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   = '501'") \
				_T("     AND f.hfe_category  IN ('N','BQP','COV','XX', 'P', 'BN')"), szWhere);

}
			rs.ExecSQL(szSQL);	
	
   szSQL.Format(_T(" WITH tbl AS (%s)") \
				_T(" SELECT") \
				_T(" dept_id, SD_MAKHOA_TAICHINH, doituong, nhomphi,tenmucphi, sum(soluong) as soluong, dongia,  ") \
				_T("  to_char(tgthuchien, 'DD/MM/YYYY') as tgthuchien, ") \
				_T("   GET_USERNAME(bsphauthuat) as bsphauthuat, ") \
				_T("   GET_USERNAME(bsphu) as bsphu, ") \
				_T("   GET_USERNAME(bsgayme) as bsgayme, ") \
				_T("   GET_USERNAME(phume) as phume, ") \
				_T("   GET_USERNAME(votrung) as votrung, ") \
				_T("   GET_USERNAME(huutrung) as huutrung, ") \
				_T("   (SELECT ham_name from hms_anesthesia_method WHERE ham_idx = vocam) AS vocam, ") \
				_T("   khoayeucau,") \
				_T("   CAST('Báo cáo danh mục' AS nvarchar2(64)) as reportname,") \
				_T("   phongyeucau,") \
				_T("   trangthaiphi, trangthaithuchien,docno,  HO_TEN, ") \
				_T(" SUM(TIEN_CLS+TIEN_MAU) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT+CHON_BS) as TIEN_PTTT,") \
				
				
				_T(" SUM(TIEN_THUOC_TG) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG) as TIEN_VAT_TU_TG,") \
				_T(" SUM(MIEN_GIAM) AS MIEN_GIAM,") \
				_T(" SUM(CHON_BS) AS CHON_BS,") \
				_T(" SUM(TIEN_CLS+TIEN_PTTT+TIEN_MAU+CHON_BS) as TONG_THU,") \
				_T(" SUM(TIEN_CLS+TIEN_PTTT+TIEN_MAU+TIEN_THUOC_TG+TIEN_VAT_TU_TG+CHON_BS) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(iv.hfe_docno) as HO_TEN,") \
				_T("   iv.hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    trunc(hfe_date) as invoice_date,") \
				_T("    trunc(FAC_POSTEDDATE) as posted_date,") \
				_T("    khoa_thuchien as dept_id, iv.doituong           AS doituong,") \
				
				 _T("    CASE") \
				_T("         WHEN NVL(iv.hfe_org_id, 'XX' )= 'EM'") \
				_T("         AND iv.hfe_deptid              = 'A3-D'") \
				_T("         THEN hd_admitdept") \
				_T("         ELSE iv.hfe_deptid") \
				_T("       END AS khoatt,") \

				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_AN_HC,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     MIEN_GIAM,") \
				_T("     CHON_BS,") \
				_T("     hfe_itemid,") \
				_T("     hfg_type_id as nhomphi,") \
				_T("     hfe_desc as tenmucphi,") \
				_T("     hfe_quantity as soluong,") \
				_T("     hfe_unitprice as dongia,") \
				_T("   tgthuchien,") \
				_T("   bsphauthuat,") \
				_T("   bsphu,") \
				_T("   bsgayme,") \
				_T("   phume, votrung, huutrung, vocam,") \
				_T("   khoayeucau,") \
				_T("   phongyeucau,") \
				_T("   trangthaiphi, trangthaithuchien") \
				_T("   FROM HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=iv.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN  (") \
				_T("    %s %s %s %s %s %s %s %s %s ") \
				//_T("    %s %s ") \//
				_T("   )tbl1 ON (iv.hfe_invoiceno = tbl1.hfe_invoiceno and iv.hfe_docno = tbl1.hfe_docno)") \
				_T("  LEFT JOIN hms_fee_group ON (hfg_id=tbl1.hfe_group)") \
				_T("   WHERE 1=1 %s") \
				_T("   )") \
				_T(" left join sys_dept on (sd_id = dept_id) ") \
				_T(" WHERE NVL(sd_type, 'CHUA_THUC_HIEN') NOT IN ('XN') %s ") \
				_T(" GROUP BY ") \
				_T(" dept_id, SD_MAKHOA_TAICHINH, doituong, nhomphi, tenmucphi, dongia, ") \
				_T("  tgthuchien,") \
				_T("   bsphauthuat,") \
				_T("   bsphu,") \
				_T("   bsgayme,") \
				_T("   phume, votrung, huutrung, vocam,") \
				_T("   khoayeucau,") \
				_T("   phongyeucau,") \
				_T("   trangthaiphi, trangthaithuchien,docno, HO_TEN") \
				_T(" HAVING SUM(TIEN_CLS+TIEN_PTTT+TIEN_MAU+THU_KHAC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+CHON_BS)>0 ") \
				_T(" ORDER BY dept_id"), m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL10,szSQL11,szSQL12,szSQL13,szWhere1, szWhere5);
				//_T(" ORDER BY dept_id"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szWhere1);
			return szSQL;
}

void CFMServicePaidSummaryByDept_2024::OnQrOnlineSelect()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	OnListLoadData();	
}
int CFMServicePaidSummaryByDept_2024::OnDeptListCheckAll()
{
	for (int i = 0; i < m_wndDeptList.GetItemCount(); i++)
	{
		if (!m_wndDeptList.GetCheck(i))
		{
			m_wndDeptList.SetCheck(i, TRUE);
		}
	}
	return 0;
}

int CFMServicePaidSummaryByDept_2024::OnDeptListUnCheckAll()
{
	for (int i = 0; i < m_wndDeptList.GetItemCount(); i++)
	{
		if (m_wndDeptList.GetCheck(i))
		{
			m_wndDeptList.SetCheck(i, FALSE);
		}
	}
	return 0;
}
int CFMServicePaidSummaryByDept_2024::OnDeptListCheckAllTYC()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;
	int nCheck = 0;
	for (int i=0; i<m_wndDeptList.GetItemCount(); i++)	
	{
		szItemText=m_wndDeptList.GetItemText(i,0);

		if ((szItemText == _T("TYC")) || (szItemText == _T("PTTYC")) || (szItemText == _T("KSK")))
	{
		m_wndDeptList.SetCheck(i, true);
		nCheck ++;
	}
	else m_wndDeptList.SetCheck(i, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}
int CFMServicePaidSummaryByDept_2024::OnDeptListCheckAllDV()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;
	int nCheck = 0;
	for (int i=0; i<m_wndDeptList.GetItemCount(); i++)	
	{
		szItemText=m_wndDeptList.GetItemText(i,0);

		if ((szItemText != _T("TYC")) && (szItemText != _T("PTTYC")) && (szItemText != _T("KSK")))
	{
		m_wndDeptList.SetCheck(i, true);
		nCheck ++;
	}
	else m_wndDeptList.SetCheck(i, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}

int CFMServicePaidSummaryByDept_2024::OnDeptListLoadData()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL;

	m_wndDeptList.BeginLoad();
	int nCount = 0;

	szSQL.Format(_T("SELECT sd_id as id, sd_name as name ") \
		         _T("FROM sys_dept ") \
				 _T("WHERE 1=1 ORDER BY id "));

	nCount = rs.ExecSQL(szSQL);
	while(!rs.IsEOF()){ 
		m_wndDeptList.AddItems(
			rs.GetValue(_T("id")), 
			rs.GetValue(_T("name")), NULL);
		rs.MoveNext();
	}
	m_wndDeptList.EndLoad();
	return nCount;

}
int CFMServicePaidSummaryByDept_2024::OnListUnCheckQR()

{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;
	int nCheck = 0;
	for (int i=0; i<m_wndList.GetItemCount(); i++)	
	{
		szItemText=m_wndList.GetItemText(i,1);
	if ((_T("QR"))==szItemText.Right(2))
	{
		m_wndList.SetCheck(i, false);
	}
	else m_wndList.SetCheck(i, true);
	}
	//AfxMessageBox(int2str(nCheck));
	return 0;
}

void CFMServicePaidSummaryByDept_2024::OnAllObjSelect(){
	
}
void CFMServicePaidSummaryByDept_2024::OnInsuranceSelect(){
	
}
void CFMServicePaidSummaryByDept_2024::OnServiceSelect(){
	
}
void CFMServicePaidSummaryByDept_2024::OnOtherObjSelect(){
	
}

void CFMServicePaidSummaryByDept_2024::OnExport19()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1, i = 0;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
	{
		nTotal[i] = 0;
		nGroupTotal[i] = 0;
	}
	CExcel xls;
	if (!xls.Load(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_EX.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetSheetName(_T("Sheet 0"));
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);

	
	szSQL = GetQueryString_v19();
	
	rs.ExecSQL(szSQL);
	//AfxMessageBox(szSQL);
	
	nRow = 9;
	nCol = 0;
	while(!rs.IsEOF())
	{
		int i = 0;
		if(nRow == 65000)
		{
			i++;
			tmpStr.Format(_T("Sheet %d"), i);
			xls.AddSheet(tmpStr);
			xls.SetWorksheet(i);
			nRow = 1;
		}
		
		rs.GetValue(_T("dept_id"), szNewDept);
		if (!szNewDept.IsEmpty() && szOldDept != szNewDept)
		{
			if (nGroupTotal[26] > 0)
			{
				xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);

				for(int i = 7; i < 30; i++)
				{
					xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
						nTotal[i] += nGroupTotal[i];
					nGroupTotal[i] = 0;
				}
				nRow++;
			}
			xls.SetCellText(0, nRow, szNewDept, FMT_TEXT, true);
			szOldDept = szNewDept;
			nIdx = 1;
			nRow++;
		}
		
		
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("HO_TEN"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("docno"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_INTEGER);		

		rs.GetValue(_T("total"), nTemp);
		nGroupTotal[3] += nTemp;
		xls.SetCellText(nCol+3, nRow, double2str(nTemp), FMT_NUMBER1);		

		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[3] > 0)
	{
		xls.SetCellText(2, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 3; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
			nTotal[i] += nGroupTotal[i];
		}
		nRow++;
	}

	if (nTotal[3] > 0)
	{
		xls.SetCellText(2, nRow, _T("T\x1ED5ng \x63\x1ED9ng"), FMT_TEXT, true);
		for(int i = 3; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nTotal[i]), FMT_NUMBER1, true);
		}
		nRow++;
	}

	xls.SetActiveSheet(0);
	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV2_EX.xls"));
}
CString CFMServicePaidSummaryByDept_2024::GetQueryString_v19()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2, szWhere5;
	CString szOrderBy, szReceiptStr, szSQL21,szSQL22, szSQL23, szSQL24, szSQL25, szSQL26, szSQL27, szSQL28, szSQL29;
	CString szDepts;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}
	//szReceiptStr2.Format(_T(" fac_cash_id IN (%s)"), szReceiptStr);

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));
	if (nCount < m_wndList.GetItemCount() && nCount > 0)
	{
		if (nCount <1000)
		{
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND fac_cash_id in(%s)) "), szReceiptStr);
		}
		else
		{
			CStringToken tok_id(szReceiptStr);
			int nCount = 0;
			long nTemp = 0;
			CString szIds, tmpStr;
			bool bBreak = false;
			szIds.Empty();
			tmpStr.Empty();
			for (int i = 0; i < tok_id.GetSize(); i++)
			{
				if (nCount > 999)
				{
					bBreak = true;
				}
				if (bBreak)
				{
					if (!szIds.IsEmpty())
					{
						szIds += _T(" OR ");
					}
					szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
					//_tprintf(_T("\nszIds: %s\n"), szIds);
					tmpStr.Empty();
					nCount = 0;
					bBreak = false;
				}
				if (!tmpStr.IsEmpty())
				{
					tmpStr += _T(",");
				}
				tok_id.GetAt(i, nTemp);
				tmpStr.AppendFormat(_T("%ld"), nTemp);
				nCount++;
			}
			if (!szIds.IsEmpty())
			{
				szIds += _T(" OR ");
			}
			szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND (%s))"), szIds);
		}
	}
	else
	{
		szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl)"));
	}


	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);
	szWhere.Empty();
	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/
	if (m_szPhanloaiKey == _T("NGT"))
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}
	else if (m_szPhanloaiKey == _T("NT"))
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else
	{
		szWhere1.AppendFormat(_T(" AND 1=1 "));
	}

	for (int i = 0; i < m_wndDeptList.GetItemCount(); i++)
	{
		if (m_wndDeptList.GetCheck(i))
		{
			if (!szDepts.IsEmpty())
				szDepts += _T(",");
			szDepts.AppendFormat(_T("'%s'"), m_wndDeptList.GetItemText(i, 0));
		}
	}

	if (!szDepts.IsEmpty())
	{
		szWhere5.AppendFormat(_T(" and khoatt in(%s) "), szDepts);
	}


	if (m_nAllObj == 0)
	{
		szWhere5.AppendFormat(_T(" and 1=1 "));
	}
	else if (m_nService == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong = 7 "));
	}
	else if (m_nOtherObj == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong IN (1, 3, 8, 13) "));
	}

	else if (m_nInsurance == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong not in  (1, 3, 7, 8, 13) "));
	}
	else
	{
		szWhere5.AppendFormat(_T(" and 0>1 "));
	}	
	
	//Case when like this very very...
	//Chi tiet theo bao cao tong hop khoa thuc hien//
	//if (m_bSOD)
//Chuẩn từ đây
{
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				_T("       f.hfe_cost as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type ='B'") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       f.hfe_cost as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('C0000')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND HPC_PDEPTID is not NULL") \
				_T("     ") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL and HPC_PDEPTID is null THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL and HPC_PDEPTID is null") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND Hpc_Practitioner IS NULL and HPC_PDEPTID is null THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL and HPC_PDEPTID is null") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T("       AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20', 'B1E00', 'C5') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     ") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       f.hfe_cost AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       f.hfe_cost AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'PĐD', 'HC')") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("       0 AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       f.hfe_cost as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
 //25. Miễn giảm tính vào khoa thanh toán cuối cùng//
 szSQL26.Format(_T(" UNION ALL") \
				_T("     SELECT hfd.hfe_docno,") \
				_T("       hfd.hfe_type,") \
				_T("       ivf.hfe_invoiceno,") \
				_T("       ivf.hfe_date,") \
				_T("       0 AS hfe_quantity,     ") \
				_T("       hfd.HFE_DEPTID AS khoa_thuchien,") \
				_T("       NULL,") \
				_T("       0             AS TIEN_KHAM,") \
				_T("       0             AS TIEN_GIUONG,") \
				_T("       0             AS TIEN_CLS,") \
				_T("       0             AS TIEN_PTTT,") \
				_T("       0             AS TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0             AS TIEN_THUOC_CH_NOITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0             AS TIEN_THUOC_PM,") \
				_T("       0             AS TIEN_VAT_TU_PM,") \
				_T("       0             AS TIEN_MAU,") \
				_T("       0             AS THU_KHAC,") \
				_T("       0             AS THU_GOI,") \
				_T("       0             AS TIEN_AN,") \
				_T("       0             AS TIEN_AN_HC,") \
				_T("       0             AS TIEN_THUOC_TG,") \
				_T("       0             AS TIEN_VAT_TU_TG,") \
				_T("       0             AS TIEN_THUOC_TG_O,") \
				_T("       0             AS TIEN_VAT_TU_TG_O,") \
				_T("       hfd.hfe_amount             AS MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_discount hfd") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_DISCOUNT ivf") \
				_T("     ON (hfd.hfe_docno =ivf.hfe_docno") \
				_T("     AND hfd.hfe_refidx=ivf.hfe_invoiceno)") \
				_T("     WHERE 1             =1 %s") \
				_T("     AND hfd.hfe_status  IN ('P')") \
				_T("     AND hfd.hfe_type    IN ('D') "), szWhere);
   
		//20. Phi thu goi, them vao ngay 13/11/2018//
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				//_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \//
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);

szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);

//Tách phí máu lưu trong cận lâm sàng ra
 szSQL27.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("    )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   = 'Y'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 //Tách vòng đeo tay ra
				szSQL28.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id IN ('PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//Tách phần chọn BS ra
			szSQL29.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       f.hfe_cost AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   = '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
}
rs.ExecSQL(szSQL);
	
				szSQL.Format(_T(" SELECT ") \
				_T(" HO_TEN, docno,") \
				_T(" ROUND(SUM(TONG_THU)) as total") \
				_T(" FROM") \
				_T(" (") \
				_T(" WITH tbl AS (%s)") \
				_T(" SELECT") \
				_T(" dept_id, SD_MAKHOA_TAICHINH, doituong, HO_TEN, docno, ") \
				_T(" SUM(TIEN_KHAM) as TIEN_KHAM,") \
				_T(" SUM(TIEN_GIUONG) as TIEN_GIUONG,") \
				_T(" SUM(TIEN_CLS) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT) as TIEN_PTTT,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_PM) AS TIEN_THUOC_PM,") \
				_T(" SUM(TIEN_VAT_TU_PM) AS TIEN_VAT_TU_PM,") \
				_T(" SUM(TIEN_MAU) as TIEN_MAU,") \
				_T(" SUM(THU_KHAC) as THU_KHAC,") \
				_T(" SUM(THU_GOI) as THU_GOI,") \
				_T(" SUM(TIEN_AN) as TIEN_AN,") \
				_T(" SUM(TIEN_AN_HC) as TIEN_AN_HC,") \
				_T(" SUM(TIEN_THUOC_TG+TIEN_THUOC_TG_O) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG+TIEN_VAT_TU_TG_O) as TIEN_VAT_TU_TG,") \
				_T(" SUM(MIEN_GIAM) AS MIEN_GIAM,") \
				_T(" SUM(CHON_BS) AS CHON_BS,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+CHON_BS) as TONG_THU,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+CHON_BS) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(iv.hfe_docno) as HO_TEN,") \
				_T("   iv.hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    trunc(hfe_date) as invoice_date,") \
				_T("    trunc(FAC_POSTEDDATE) as posted_date,") \
				_T("    khoa_thuchien as dept_id,iv.doituong as doituong,") \

				_T("    CASE") \
				_T("         WHEN NVL(iv.hfe_org_id, 'XX' )= 'EM'") \
				_T("         AND iv.hfe_deptid              = 'A3-D'") \
				_T("         THEN hd_admitdept") \
				_T("         ELSE iv.hfe_deptid") \
				_T("       END AS khoatt,") \

				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_AN_HC,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     MIEN_GIAM,") \
				_T("     CHON_BS,") \
				_T("     hfe_itemid") \
				_T("   FROM HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=iv.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN  (") \
				_T("    %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s") \
				//_T("    %s %s ") \//
				_T("   )tbl1 ON (iv.hfe_invoiceno = tbl1.hfe_invoiceno and iv.hfe_docno = tbl1.hfe_docno)") \
				_T("   WHERE 1=1 %s") \
				_T("   )") \
				_T(" left join sys_dept on (sd_id = dept_id) where 1=1 %s ") \
				_T(" GROUP BY ") \
				_T(" dept_id, SD_MAKHOA_TAICHINH, doituong, HO_TEN, docno ") \
				_T(" HAVING SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+") \
				_T("	TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+") \
				_T("	TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+TIEN_THUOC_TG_O+TIEN_VAT_TU_TG_O+CHON_BS)>0") \
				_T(" )") \
				_T(" GROUP BY HO_TEN, docno") \
				_T(" ORDER BY docno"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szSQL26, szSQL27, szSQL28, szSQL29, szWhere1, szWhere5);
				//_T(" ORDER BY dept_id"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szSQL26, szSQL27, szSQL28, szSQL29, szWhere1, szWhere5);
				
	return szSQL;
}

CString CFMServicePaidSummaryByDept_2024::GetQueryString_v20()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2, szWhere5;
	CString szOrderBy, szReceiptStr, szSQL21,szSQL22, szSQL23, szSQL24, szSQL25, szSQL26, szSQL27, szSQL28, szSQL29;
	CString szDepts;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}
	//szReceiptStr2.Format(_T(" fac_cash_id IN (%s)"), szReceiptStr);

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));
	if (nCount < m_wndList.GetItemCount() && nCount > 0)
	{
		if (nCount <1000)
		{
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND fac_cash_id in(%s)) "), szReceiptStr);
		}
		else
		{
			CStringToken tok_id(szReceiptStr);
			int nCount = 0;
			long nTemp = 0;
			CString szIds, tmpStr;
			bool bBreak = false;
			szIds.Empty();
			tmpStr.Empty();
			for (int i = 0; i < tok_id.GetSize(); i++)
			{
				if (nCount > 999)
				{
					bBreak = true;
				}
				if (bBreak)
				{
					if (!szIds.IsEmpty())
					{
						szIds += _T(" OR ");
					}
					szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
					//_tprintf(_T("\nszIds: %s\n"), szIds);
					tmpStr.Empty();
					nCount = 0;
					bBreak = false;
				}
				if (!tmpStr.IsEmpty())
				{
					tmpStr += _T(",");
				}
				tok_id.GetAt(i, nTemp);
				tmpStr.AppendFormat(_T("%ld"), nTemp);
				nCount++;
			}
			if (!szIds.IsEmpty())
			{
				szIds += _T(" OR ");
			}
			szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND (%s))"), szIds);
		}
	}
	else
	{
		szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl)"));
	}


	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);
	szWhere.Empty();
	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/
	if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}

	for (int i = 0; i < m_wndDeptList.GetItemCount(); i++)
	{
		if (m_wndDeptList.GetCheck(i))
		{
			if (!szDepts.IsEmpty())
				szDepts += _T(",");
			szDepts.AppendFormat(_T("'%s'"), m_wndDeptList.GetItemText(i, 0));
		}
	}

	if (!szDepts.IsEmpty())
	{
		szWhere5.AppendFormat(_T(" and khoatt in(%s) "), szDepts);
	}


	if (m_nAllObj == 0)
	{
		szWhere5.AppendFormat(_T(" and 1=1 "));
	}
	else if (m_nService == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong = 7 "));
	}
	else if (m_nOtherObj == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong IN (1, 3, 8, 13) "));
	}

	else if (m_nInsurance == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong not in  (1, 3, 7, 8, 13) "));
}
else
	{
		szWhere5.AppendFormat(_T(" and 0>1 "));
	}
	
	//Case when like this very very...
	//Chi tiet theo bao cao tong hop khoa thuc hien//
	//if (m_bSOD)
//Chuẩn từ đây
{
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				_T("       f.hfe_cost as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type ='B'") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       f.hfe_cost as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('C0000')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND HPC_PDEPTID is not NULL") \
				_T("     ") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T("       AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20', 'B1E00', 'C5') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     ") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
  szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       f.hfe_cost AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       f.hfe_cost AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'PĐD', 'HC')") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("	   0 AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       f.hfe_cost as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
 //25. Miễn giảm tính vào khoa thanh toán cuối cùng//
 szSQL26.Format(_T(" UNION ALL") \
				_T("     SELECT hfd.hfe_docno,") \
				_T("       hfd.hfe_type,") \
				_T("       ivf.hfe_invoiceno,") \
				_T("       ivf.hfe_date,") \
				_T("       0 AS hfe_quantity,     ") \
				_T("       hfd.HFE_DEPTID AS khoa_thuchien,") \
				_T("       NULL,") \
				_T("       0             AS TIEN_KHAM,") \
				_T("       0             AS TIEN_GIUONG,") \
				_T("       0             AS TIEN_CLS,") \
				_T("       0             AS TIEN_PTTT,") \
				_T("       0             AS TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0             AS TIEN_THUOC_CH_NOITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0             AS TIEN_THUOC_PM,") \
				_T("       0             AS TIEN_VAT_TU_PM,") \
				_T("       0             AS TIEN_MAU,") \
				_T("       0             AS THU_KHAC,") \
				_T("       0             AS THU_GOI,") \
				_T("       0             AS TIEN_AN,") \
				_T("       0             AS TIEN_AN_HC,") \
				_T("       0             AS TIEN_THUOC_TG,") \
				_T("       0             AS TIEN_VAT_TU_TG,") \
				_T("       0             AS TIEN_THUOC_TG_O,") \
				_T("       0             AS TIEN_VAT_TU_TG_O,") \
				_T("       hfd.hfe_amount             AS MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_discount hfd") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_DISCOUNT ivf") \
				_T("     ON (hfd.hfe_docno =ivf.hfe_docno") \
				_T("     AND hfd.hfe_refidx=ivf.hfe_invoiceno)") \
				_T("     WHERE 1             =1 %s") \
				_T("     AND hfd.hfe_status  IN ('P')") \
				_T("     AND hfd.hfe_type    IN ('D') "), szWhere); 

		//20. Phi thu goi, them vao ngay 13/11/2018//
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				//_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \//
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);

szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);

//Tách phí máu lưu trong cận lâm sàng ra
 szSQL27.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("    )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   = 'Y'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
//Tách vòng đeo tay ra
				szSQL28.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id IN ('PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//Tách phần chọn BS ra
				szSQL29.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       f.hfe_cost AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   = '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
}
rs.ExecSQL(szSQL);
	
   szSQL.Format(_T(" WITH tbl AS (%s)") \
				_T(" SELECT") \
				_T(" dept_id, SD_MAKHOA_TAICHINH, doituong, HO_TEN, docno, NGAY_VAO, NGAY_RA, posted_date, SO_NGAY_DT, ") \
				_T(" SUM(TIEN_KHAM) as TIEN_KHAM,") \
				_T(" SUM(TIEN_GIUONG) as TIEN_GIUONG,") \
				_T(" SUM(TIEN_CLS) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT) as TIEN_PTTT,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_PM) AS TIEN_THUOC_PM,") \
				_T(" SUM(TIEN_VAT_TU_PM) AS TIEN_VAT_TU_PM,") \
				_T(" SUM(TIEN_MAU) as TIEN_MAU,") \
				_T(" SUM(THU_KHAC) as THU_KHAC,") \
				_T(" SUM(THU_GOI) as THU_GOI,") \
				_T(" SUM(TIEN_AN) as TIEN_AN,") \
				_T(" SUM(TIEN_AN_HC) as TIEN_AN_HC,") \
				_T(" SUM(TIEN_THUOC_TG+TIEN_THUOC_TG_O) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG+TIEN_VAT_TU_TG_O) as TIEN_VAT_TU_TG,") \
				_T(" SUM(MIEN_GIAM) AS MIEN_GIAM,") \
				_T(" SUM(CHON_BS) AS CHON_BS,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+CHON_BS) as TONG_THU,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+CHON_BS) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(iv.hfe_docno) as HO_TEN,") \
				_T("   iv.hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    trunc(hfe_date) as invoice_date,") \
				_T("    trunc(FAC_POSTEDDATE) as posted_date,") \
				_T("    khoa_thuchien as dept_id,iv.doituong as doituong,") \

				_T("    CASE") \
				_T("         WHEN NVL(iv.hfe_org_id, 'XX' )= 'EM'") \
				_T("         AND iv.hfe_deptid              = 'A3-D'") \
				_T("         THEN hd_admitdept") \
				_T("         ELSE iv.hfe_deptid") \
				_T("       END AS khoatt,") \

				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_AN_HC,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     MIEN_GIAM,") \
				_T("     CHON_BS,") \
				_T("     hfe_itemid") \
				_T("   FROM HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=iv.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN  (") \
				_T("    %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s") \
				//_T("    %s %s ") \//
				_T("   )tbl1 ON (iv.hfe_invoiceno = tbl1.hfe_invoiceno and iv.hfe_docno = tbl1.hfe_docno)") \
				_T("   WHERE 1=1 %s") \
				_T("   )") \
				_T(" left join sys_dept on (sd_id = dept_id) where 1=1 %s ") \
				_T(" GROUP BY ") \
				_T(" CHINDEX, dept_id, SD_MAKHOA_TAICHINH, doituong, HO_TEN, docno, NGAY_VAO, NGAY_RA, posted_date, SO_NGAY_DT ") \
				_T(" HAVING SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+") \
				_T("	TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+") \
				_T("	TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+TIEN_THUOC_TG_O+TIEN_VAT_TU_TG_O+CHON_BS)>0") \
				_T(" ORDER BY CHINDEX, docno"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szSQL26, szSQL27, szSQL28, szSQL29, szWhere1, szWhere5);				
	return szSQL;
}

int CFMServicePaidSummaryByDept_2024::OnListCheckAllPTTYCTYC()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;
	int nCheck = 0;
	for (int i=0; i<m_wndDeptList.GetItemCount(); i++)	
	{
		szItemText=m_wndDeptList.GetItemText(i,0);
	if ((_T("PTTYC"))==szItemText || (_T("TYC"))==szItemText || (_T("KSK"))==szItemText)
	{
		m_wndDeptList.SetCheck(i, true);
		nCheck++;		
	}	
	else m_wndDeptList.SetCheck(i, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}

int CFMServicePaidSummaryByDept_2024::OnListCheckAllTTTM()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;
	int nCheck = 0;
	for (int i=0; i<m_wndDeptList.GetItemCount(); i++)	
	{
		szItemText=m_wndDeptList.GetItemText(i,0);
	if ((_T("TTTM"))==szItemText || (_T("TMNT"))==szItemText)
	{
		m_wndDeptList.SetCheck(i, true);
		nCheck++;		
	}	
	else m_wndDeptList.SetCheck(i, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}

int CFMServicePaidSummaryByDept_2024::OnListCheckAllKBA16()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;
	int nCheck = 0;
	for (int i=0; i<m_wndDeptList.GetItemCount(); i++)	
	{
		szItemText=m_wndDeptList.GetItemText(i,0);
	if ((_T("KB_A16"))==szItemText)
	{
		m_wndDeptList.SetCheck(i, true);
		nCheck++;		
	}	
	else m_wndDeptList.SetCheck(i, false);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}

int CFMServicePaidSummaryByDept_2024::OnListUnCheckAllTYC_PTTYC_KBA16()
{
	CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
	CString szItemText;
	int nCheck = 0;
	for (int i=0; i<m_wndDeptList.GetItemCount(); i++)	
	{
		szItemText=m_wndDeptList.GetItemText(i,0);
	if ((_T("KB_A16"))==szItemText || (_T("PTTYC"))==szItemText || (_T("TYC"))==szItemText || (_T("TMNT"))==szItemText 
		|| (_T("TTTM"))==szItemText || (_T("KSK"))==szItemText)
	{
		m_wndDeptList.SetCheck(i, false);
		nCheck++;		
	}	
	else m_wndDeptList.SetCheck(i, true);
	}
	AfxMessageBox(int2str(nCheck));
	return 0;
}

void CFMServicePaidSummaryByDept_2024::OnExportv22(int nVersion)
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szOldDept, szNewDept;
	UpdateData(TRUE);
	BeginWaitCursor();
	szWhere.Empty();
	int nRow = 0, nCol = 0, nIdx = 1, i = 0;
	double nTemp = 0, nTemp1=0;
	double nTotal[30], nGroupTotal[30];
	for(int i = 0; i < 30; i++)
	{
		nTotal[i] = 0;
		nGroupTotal[i] = 0;
	}
	CExcel xls;
	if (!xls.Load(_T("Exports\\Template\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_TH_CHITIET_BN.xls"))) AfxMessageBox(_T("Load fail!"));

	xls.SetWorksheet(0);
	xls.SetSheetName(_T("Sheet 0"));
	xls.SetCellText(0, 0, pMF->m_szHealthService, FMT_TEXT | FMT_CENTER, true, 10);
	xls.SetCellText(0, 1, pMF->m_szHospitalName, FMT_TEXT | FMT_CENTER, true, 10);

	tmpStr.Format(_T("T\x1EEB %s \x110\x1EBFn %s"), CDateTime::Convert(m_szFromDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss), CDateTime::Convert(m_szToDate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss));
	xls.SetCellText(0, 5, tmpStr, FMT_TEXT | FMT_CENTER, true, 11);
	if (nVersion == 1)
	{
		szSQL = GetQueryString();
	}
	else
	{
		szSQL = GetQueryString_v22();
		//AfxMessageBox(szSQL);
	}
	rs.ExecSQL(szSQL);
	//AfxMessageBox(szSQL);

	
	nRow = 9;
	nCol = 0;
	while(!rs.IsEOF())
	{
		
		int i = 0;
		if(nRow == 65000)
		{
			i++;
			tmpStr.Format(_T("Sheet %d"), i);
			xls.AddSheet(tmpStr);
			xls.SetWorksheet(i);
			nRow = 1;
		}
		
		
		xls.SetCellText(nCol+0, nRow, int2str(nIdx++), FMT_INTEGER);

		rs.GetValue(_T("HO_TEN"), tmpStr);
		xls.SetCellText(nCol+1, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("docno"), tmpStr);
		xls.SetCellText(nCol+2, nRow, tmpStr, FMT_INTEGER);

		rs.GetValue(_T("dept_id"), tmpStr);
		xls.SetCellText(nCol+3, nRow, tmpStr, FMT_TEXT);

		rs.GetValue(_T("NGAY_VAO"), tmpStr);
		xls.SetCellText(nCol+4,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);

		rs.GetValue(_T("NGAY_RA"), tmpStr);
		xls.SetCellText(nCol+5,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);

		rs.GetValue(_T("posted_date"), tmpStr);
		xls.SetCellText(nCol+6, nRow, tmpStr, FMT_TEXT);
		//xls.SetCellText(nCol+6,nRow,CDate::Convert(tmpStr,yyyymmdd, ddmmyyyy), FMT_TEXT);		

		rs.GetValue(_T("SO_NGAY_DT"), nTemp);
		nGroupTotal[7] += nTemp;
		xls.SetCellText(nCol+7, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_KHAM"), nTemp);
		nGroupTotal[8] += nTemp;
		xls.SetCellText(nCol+8, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_GIUONG"), nTemp);
		nGroupTotal[9] += nTemp;
		xls.SetCellText(nCol+9, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_CLS"), nTemp);
		nGroupTotal[10] += nTemp;
		xls.SetCellText(nCol+10, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_PTTT"), nTemp);
		nGroupTotal[11] += nTemp;
		xls.SetCellText(nCol+11, nRow, double2str(nTemp), FMT_NUMBER1);
		
		rs.GetValue(_T("TIEN_THUOC_CH_NGOAITRU"), nTemp);
		nGroupTotal[12] += nTemp;
		xls.SetCellText(nCol+12, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_CH_NOITRU"), nTemp);
		nGroupTotal[13] += nTemp;
		xls.SetCellText(nCol+13, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NGOAITRU"), nTemp);
		nGroupTotal[14] += nTemp;
		xls.SetCellText(nCol+14, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_VAT_TU_CH_NOITRU"), nTemp);
		nGroupTotal[15] += nTemp;
		xls.SetCellText(nCol+15, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_THUOC_PM"), nTemp);
		nGroupTotal[16] += nTemp;
		xls.SetCellText(nCol+16, nRow, double2str(nTemp), FMT_NUMBER1);
		
		rs.GetValue(_T("TIEN_VAT_TU_PM"), nTemp);
		nGroupTotal[17] += nTemp;
		xls.SetCellText(nCol+17, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_MAU"), nTemp);
		nGroupTotal[18] += nTemp;
		xls.SetCellText(nCol+18, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_KHAC"), nTemp);
		nGroupTotal[19] += nTemp;
		xls.SetCellText(nCol+19, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("THU_GOI"), nTemp);
		nGroupTotal[20] += nTemp;
		xls.SetCellText(nCol+20, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("CHON_BS"), nTemp);
		nGroupTotal[21] += nTemp;
		xls.SetCellText(nCol+21, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TONG_THU"), nTemp);
		nGroupTotal[22] += nTemp;
		xls.SetCellText(nCol+22, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("TIEN_AN"), nTemp);
		nGroupTotal[23] += nTemp;
		xls.SetCellText(nCol+23, nRow, double2str(nTemp), FMT_NUMBER1);		


		rs.GetValue(_T("TIEN_AN_HC"), nTemp);
		nGroupTotal[24] += nTemp;
		xls.SetCellText(nCol+24, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_THUOC_TG"), nTemp);
		nGroupTotal[25] += nTemp;
		xls.SetCellText(nCol+25, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TIEN_VAT_TU_TG"), nTemp);
		nGroupTotal[26] += nTemp;
		xls.SetCellText(nCol+26, nRow, double2str(nTemp), FMT_NUMBER1);	

		rs.GetValue(_T("TONG_THU1"), nTemp);
		nGroupTotal[27] += nTemp;
		xls.SetCellText(nCol+27, nRow, double2str(nTemp), FMT_NUMBER1);

		rs.GetValue(_T("MIEN_GIAM"), nTemp);
		nGroupTotal[28] += nTemp;
		xls.SetCellText(nCol+28, nRow, double2str(nTemp), FMT_NUMBER1);	
			
		nRow++;
		rs.MoveNext();
	}

	if (nGroupTotal[27] > 0)
	{
		xls.SetCellText(6, nRow, _T("C\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nGroupTotal[i]), FMT_NUMBER1, true);
			nTotal[i] += nGroupTotal[i];
		}
		nRow++;
	}

	if (nTotal[27] > 0)
	{
		xls.SetCellText(6, nRow, _T("T\x1ED5ng \x63\x1ED9ng"), FMT_TEXT, true);
		for(int i = 7; i < 30; i++)
		{
			xls.SetCellText(i, nRow, double2str(nTotal[i]), FMT_NUMBER1, true);
		}
		nRow++;
	}
	xls.SetActiveSheet(0);
	EndWaitCursor();
	xls.Save(_T("Exports\\TONGHOP_CHIPHI_NGOAITRU_NOITRU_THEOKHOA_DV_TH_CHITIET_BN2.xls"));
}

CString CFMServicePaidSummaryByDept_2024::GetQueryString_v22()
{
	CHMSMainFrame *pMF = (CHMSMainFrame*) AfxGetMainWnd();
	CString szSQL,szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20, szWhere, szWhere1, szWhere2, szWhere5;
	CString szOrderBy, szReceiptStr, szSQL21,szSQL22, szSQL23, szSQL24, szSQL25, szSQL26, szSQL27, szSQL28, szSQL29;
	CString szDepts;
	CRecord rs(&pMF->m_db);
	int nCount = 0;

	szReceiptStr = _T("-1");
	UpdateData(true);
	
	for (int i =0; i < m_wndList.GetItemCount(); i++)
	{
		if(m_wndList.GetCheck(i))
		{
			if(!szReceiptStr.IsEmpty())
				szReceiptStr.AppendFormat(_T(","));
			szReceiptStr.AppendFormat(_T("%ld"), str2long(m_wndList.GetItemText(i,0)));
			nCount++;
		}
	}
	//szReceiptStr2.Format(_T(" fac_cash_id IN (%s)"), szReceiptStr);

	m_szCashIDS = szReceiptStr;
	m_szCashIDS.Replace(_T("-1,"), _T(""));
	if (nCount < m_wndList.GetItemCount() && nCount > 0)
	{
		if (nCount <1000)
		{
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND fac_cash_id in(%s)) "), szReceiptStr);
		}
		else
		{
			CStringToken tok_id(szReceiptStr);
			int nCount = 0;
			long nTemp = 0;
			CString szIds, tmpStr;
			bool bBreak = false;
			szIds.Empty();
			tmpStr.Empty();
			for (int i = 0; i < tok_id.GetSize(); i++)
			{
				if (nCount > 999)
				{
					bBreak = true;
				}
				if (bBreak)
				{
					if (!szIds.IsEmpty())
					{
						szIds += _T(" OR ");
					}
					szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
					//_tprintf(_T("\nszIds: %s\n"), szIds);
					tmpStr.Empty();
					nCount = 0;
					bBreak = false;
				}
				if (!tmpStr.IsEmpty())
				{
					tmpStr += _T(",");
				}
				tok_id.GetAt(i, nTemp);
				tmpStr.AppendFormat(_T("%ld"), nTemp);
				nCount++;
			}
			if (!szIds.IsEmpty())
			{
				szIds += _T(" OR ");
			}
			szIds.AppendFormat(_T(" fac_cash_id IN (%s) "), tmpStr);
			szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl where 1=1 AND (%s))"), szIds);
		}
	}
	else
	{
		szWhere1.Format(_T(" AND fac_cash_id IN (select fac_cash_id from tbl)"));
	}


	//szWhere4 = m_szWhere;	
	//szWhere.AppendFormat(_T(" AND iv.hfe_cash_id in(select IDX from tmp_fa_cash_C12 WHERE userid = '%s') "), pMF->m_szUser);
	szWhere.Empty();
	if(m_szOrderByKey == _T("01"))
	{
		szOrderBy.Format(_T(" , firstname, docno, posted_date "));
	}
	else if(m_szOrderByKey == _T("02"))
	{
		szOrderBy.Format(_T(" , docno "));
	}
	else if(m_szOrderByKey == _T("03"))
	{
		szOrderBy.Format(_T(" ,posted_date, firstname "));
	}
	else if(m_szOrderByKey == _T("04"))
	{
		//szOrderBy.Format(_T(" , dept_id, firstname 

		szOrderBy.Format(_T(" , dept_id "));
	}
	else
		szOrderBy.Format(_T(" , firstname, posted_date "));	
	
	/*if (!m_szDeptKey.IsEmpty())
		szWhere1.AppendFormat(_T(" AND khoa_thuchien = '%s'"), m_szDeptKey);*/

	if(m_nPatientType == 0)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='I' "));
	}
	else if(m_nPatientType == 1)
	{
		szWhere1.AppendFormat(_T(" AND HFE_CLASS='E' "));
	}	
	
	for (int i = 0; i < m_wndDeptList.GetItemCount(); i++)
	{
		if (m_wndDeptList.GetCheck(i))
		{
			if (!szDepts.IsEmpty())
				szDepts += _T(",");
			szDepts.AppendFormat(_T("'%s'"), m_wndDeptList.GetItemText(i, 0));
		}
	}

	if (!szDepts.IsEmpty())
	{
		szWhere5.AppendFormat(_T(" and dept_id in(%s) "), szDepts);
	}


	if (m_nAllObj == 0)
	{
		szWhere5.AppendFormat(_T(" and 1=1 "));
	}
	else if (m_nService == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong = 7 "));
	}
	else if (m_nOtherObj == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong IN (1, 3, 8, 13) "));
	}

	else if (m_nInsurance == 0)
	{
		szWhere5.AppendFormat(_T(" and doituong not in  (1, 3, 7, 8, 13) "));
	}
	else
	{
		szWhere5.AppendFormat(_T(" and 0>1 "));
	}
	
	//Case when like this very very...
	//Chi tiet theo bao cao tong hop khoa thuc hien//
	//if (m_bSOD)
//Chuẩn từ đây
{
	szSQL1.Format(_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN he_roomid IN ( 50, 54 )") \
				_T("         THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3))") \
				_T("         ELSE f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("              ") \
				_T("       f.hfe_cost as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_exam ex") \
				_T("     ON (f.hfe_docno   = ex.he_docno") \
				_T("     AND f.hfe_orderid = ex.he_receptidx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_group      ='D0000'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);

	//2. Tien giuong ne//
	szSQL2.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       F.Hfe_Quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type ='B'") \
				_T("         THEN f.hfe_deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       f.hfe_cost as TIEN_GIUONG,") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T(" f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('C0000')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
  //3. Tien can lam sang cho cac khoa thuc hien//
  szSQL3.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND HPC_PDEPTID is not NULL") \
				_T("     ") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//4. Cacs khoa CLS khoi hinh anh chua thuc hien//
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL4.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B3100')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Pacsorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500','B3100')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//5. Cac khoa CLS khoi xet nghiem chua thuc hien
	//Update 11/04/2017, neu khoa khong nhap ket qua thi lay trong danh muc phi ra//
	szSQL5.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P','T')") \
				_T("         AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Testorder") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND Hpc_Practitioner IS NULL AND HPC_PDEPTID is NULL") \
				_T("     AND f.hfe_type      IN ('T','P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group NOT IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND (hpc_status       <> 'T' OR (hpc_status       = 'T' AND Hpc_Practitioner IS NULL))") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//6. Chi dinh khoa thuc hien C16, A20//
  szSQL6.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type IN ('P','T')") \
				_T("       AND F.Hfe_Group IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("         THEN CAST(DECODE(f.Hfe_Group, 'B1B00', 'C17', 'B1G00', 'C16', 'B1800','C16','B2500','A20', 'B1E00', 'C5') AS NVARCHAR2(3))") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND F.Hfe_Group     IN ('B1B00','B1G00','B1800','B2500', 'B1E00')") \
				_T("     AND f.hfe_type <> 'X'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
	//7. Phi PTTT ne//
  if (m_bSOD)
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN HO_DEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  not in ('B5','PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  in ('PTTYC') AND HO_PDEPTID is not null AND HO_DEPTID is not null AND FL.HFL_PERFORMPLACE is not null THEN FL.HFL_PERFORMPLACE") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  IN ('PTTYC') AND FL.HFL_PERFORMPLACE IS NULL  AND Fl.Hfl_Deptid is null  THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     ") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
  }
  else
  {
  szSQL7.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       f.hfe_cost as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   <> '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
  }
	//8.Phi thuoc ngoai tru//
  szSQL8.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND (i.hfe_class='E' OR (i.hfe_class='I' AND i.hfe_deptid='TTDTHM') )") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
	//8.1 Phi thuoc noi tru
	//8.Phi thuoc ngoai tru//
  szSQL9.Format(_T("     UNION ALL     ") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 AND f.hfe_cost > 0 %s") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I' AND i.hfe_deptid<>'TTDTHM'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//9.Phi khoa trang bi ngoai tru//
 szSQL10.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='E'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//9.1 Phi vat tu noi tru
	szSQL11.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R') AND i.hfe_class='I'") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB', 'PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//10. Thuoc phong mo//
 szSQL12.Format(_T("     UNION ALL") \
				_T(" SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       f.hfe_cost AS TIEN_THUOC_PM,") \
				_T("       0          AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'PĐD', 'HC')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
//11. Vat tu phong mo//
szSQL13.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 AS hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0          AS TIEN_KHAM,") \
				_T("       0          AS TIEN_GIUONG,") \
				_T("       0          AS TIEN_CLS,") \
				_T("       0          AS TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0          AS TIEN_THUOC_PM,") \
				_T("       f.hfe_cost AS TIEN_VAT_TU_PM,") \
				_T("       0          AS TIEN_MAU,") \
				_T("       0          AS THU_KHAC,") \
				_T("       0		  as THU_GOI,") \
				_T("       0          AS TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0		  as TIEN_THUOC_TG,") \
				_T("       0		  as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status       IN ('P','R')") \
				_T("     AND f.hfe_type         IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND f.hfe_deptid = 'B5'") \
				_T("     AND (hfe_category   NOT IN ('Y') OR (hfe_category='Y' AND HFE_TREAT_INPACKAGE='Y'))"), szWhere);
	//12.Phi mau tach rieng ra cho khoa C16//
 szSQL14.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'BB', 'C16') AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','PM', 'PĐD', 'HC')") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//13. Phi khac PTC nhap o tab phi khac//
 szSQL15.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND f.hfe_itemid NOT IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
//14. Phi khac go so tien vao//
szSQL16.Format(_T("     UNION ALL") \
				_T("     SELECT fi.hfe_docno,") \
				_T(" fi.hfe_type,") \
				_T("       fi.hfe_invoiceno,") \
				_T("       fi.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN fi.hfe_type  IN ('O','S')") \
				_T("         AND fi.Hfe_Serialno='PC'") \
				_T("         THEN fi.HFE_DEPTID") \
				_T("       END khoa_thuchien,") \
				_T("       NULL,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,      ") \
				_T("       fi.hfe_amount as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T("	   0 AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_invoice fi") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND fi.hfe_status   IN ('P','R')") \
				_T("     AND fi.hfe_type     IN ('O','S')") \
				_T("     AND fi.Hfe_Serialno  ='PC'"), szWhere);
//15. Phi an khoa dinh duong ne//
 szSQL17.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       f.hfe_cost as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL25.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_deptid in ('C1.1', 'C1.2','C1.3', 'AB') THEN HCR_ADMITDEPT ELSE f.hfe_deptid END AS khoa_thuchien,") \
				_T("      f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       HFE_QUANTITY*HFE_UNITPRICE as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN HMS_CLINICAL_RECORD ON (f.hfe_docno=hcr_docno)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_Group     IN ('FF000', 'NN000')") \
				_T("     AND f.hfe_category  IN ('Y')"), szWhere);
 //25. Miễn giảm tính vào khoa thanh toán cuối cùng//
 szSQL26.Format(_T(" UNION ALL") \
				_T("     SELECT hfd.hfe_docno,") \
				_T("       hfd.hfe_type,") \
				_T("       ivf.hfe_invoiceno,") \
				_T("       ivf.hfe_date,") \
				_T("       0 AS hfe_quantity,     ") \
				_T("       hfd.HFE_DEPTID AS khoa_thuchien,") \
				_T("       NULL,") \
				_T("       0             AS TIEN_KHAM,") \
				_T("       0             AS TIEN_GIUONG,") \
				_T("       0             AS TIEN_CLS,") \
				_T("       0             AS TIEN_PTTT,") \
				_T("       0             AS TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0             AS TIEN_THUOC_CH_NOITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0             AS TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0             AS TIEN_THUOC_PM,") \
				_T("       0             AS TIEN_VAT_TU_PM,") \
				_T("       0             AS TIEN_MAU,") \
				_T("       0             AS THU_KHAC,") \
				_T("       0             AS THU_GOI,") \
				_T("       0             AS TIEN_AN,") \
				_T("       0             AS TIEN_AN_HC,") \
				_T("       0             AS TIEN_THUOC_TG,") \
				_T("       0             AS TIEN_VAT_TU_TG,") \
				_T("       0             AS TIEN_THUOC_TG_O,") \
				_T("       0             AS TIEN_VAT_TU_TG_O,") \
				_T("       hfd.hfe_amount             AS MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       NULL") \
				_T("     FROM hms_fee_discount hfd") \
				_T("     LEFT JOIN HMS_FEE_INVOICE_VIEW_DISCOUNT ivf") \
				_T("     ON (hfd.hfe_docno =ivf.hfe_docno") \
				_T("     AND hfd.hfe_refidx=ivf.hfe_invoiceno)") \
				_T("     WHERE 1             =1 %s") \
				_T("     AND hfd.hfe_status  IN ('P')") \
				_T("     AND hfd.hfe_type    IN ('D') "), szWhere); 

		//20. Phi thu goi, them vao ngay 13/11/2018//
//Tách thành 4 cột gồm:
// - Thuốc trong gói ở phẫu thuật thủ thuật//
// - Phí vật tư trong gói của cận lâm sàng//
// - Thuốc trong gói ở cận lâm sàng//
// - Phí vật tư trong gói ở phẫu thuật thủ thuật//

//Thuốc trong gói ở phẫu thuật thủ thuật//
szSQL18.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				//_T("       CAST(DECODE(product_org_id, 'PM', ho_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \//
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       f.hfe_cost as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói của cận lâm sàng//
szSQL19.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       f.hfe_cost as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R', 'O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);
//Phí thuốc trong gói ở cận lâm sàng//
 szSQL20.Format(_T("     UNION ALL     ") \
				_T("       SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       hpc_invoiceno as hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'PM', coalesce(hpc_pdeptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       hfe_cost as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN HMSV_PARACLINIC_VLOC ON (hpc_docno = f.hfe_docno AND HPO_REFERENCE_ID = hpc_orderid)") \
				_T("	 LEFT JOIN hms_fee_group ON (hpc_groupid = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(hpc_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('O','P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('MA','BB', 'HC', 'PĐD')") \
				_T("     AND hfe_category ='Y'"), szWhere);
//Phí vật tư trong gói ở phẫu thuật thủ thuật//
szSQL21.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       ho_invoiceno as hfe_invoiceno,") \
				_T("	   f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', coalesce(ho_deptid, hfg_deptid)) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       hfe_cost as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW") \
				_T("     ON (f.hfe_docno= hpo_docno AND f.hfe_orderid=hpo_orderid)") \
				_T("     LEFT JOIN hms_operation ON (HPO_REFITEM_ID=ho_itemid AND HPO_REFERENCE_ID=ho_idx)") \
				_T("	 LEFT JOIN hms_fee_group ON (ho_group = hfg_id)") \
				_T("     WHERE 1              =1 AND coalesce(ho_deptid, cast('N' as nvarchar2(1)))<>'N' %s") \
				_T("     AND f.hfe_status    IN ('P','R','O')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id NOT IN ('PM','BB')") \
				_T("     AND hfe_category     ='Y'"), szWhere);

szSQL22.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_class in ('X','I','E') AND f.hfe_type ='X' AND f.HFE_DEPTID is NOT NULL THEN  f.HFE_DEPTID ELSE fl.HFL_DEPTID  END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       hfe_cost as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN Hms_Fee_List fl ON (F.Hfe_Itemid=fl.hfl_feeid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_class     IN ('X','I','E')") \
				_T("     AND f.hfe_type       ='X'") \
				_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
 szSQL23.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type in ('P') AND F.hfe_status='R'") \
				_T("         AND Hpc_Practitioner IS NULL THEN Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('R')") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status is NULL") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
//_T("   --4. Phí nội soi của khoa A3 & C8-D bị lẫn, nên khi chưa thực hiện thì để là chưa thực hiện") \//") \//
szSQL24.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE WHEN f.hfe_type IN ('P','T') AND F.Hfe_Group IN ('B3100') AND Hpc_Practitioner IS NULL THEN CAST(('CHUA_THUC_HIEN') AS NVARCHAR2(20)) END khoa_thuchien,      ") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       f.hfe_cost as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN Hms_Pacsorder ON ( f.hfe_docno = hpc_docno  AND f.hfe_orderid  = hpc_orderid)") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND Hpc_Practitioner IS NULL") \
				_T("     AND f.hfe_type      IN ('P','T')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   <> 'Y'") \
				_T("     AND hpc_status <> 'T'") \
				_T("     AND F.Hfe_Group IN ('B3100')") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);

//Tách phí máu lưu trong cận lâm sàng ra
 szSQL27.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CASE") \
				_T("         WHEN f.hfe_type     IN ('P','T')") \
				_T("         AND HPC_PDEPTID       IS NOT NULL") \
				_T("         THEN HPC_PDEPTID ELSE Fl.Hfl_Deptid") \
				_T("       END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       f.hfe_cost as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid )") \
				_T("     LEFT JOIN HMSV_PDEPT_PARACLINICDV_55") \
				_T("     ON ( f.hfe_docno  = hpc_docno") \
				_T("     AND f.hfe_orderid = hpc_orderid") \
				_T("    )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND NVL( fl.hfl_bloodfee, 'X' )   = 'Y'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
//Tách vòng đeo tay ra
				szSQL28.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("  f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("       CAST(DECODE(product_org_id, 'MA', f.hfe_deptid, 'PĐD', f.hfe_deptid) AS NVARCHAR2(15)) khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       f.hfe_cost as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       0 AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN M_PRODUCTITEM_VIEW_VP") \
				_T("     ON ( CAST(hfe_itemid AS NVARCHAR2(15)) = product_item_id )") \
				_T("     LEFT JOIN HMS_PHARMAORDER_VIEW_VP") \
				_T("     ON (hpo_orderid = f.hfe_orderid)") \
				_T("	 LEFT JOIN hms_fee_invoice i ON (i.hfe_invoiceno = f.hfe_invoiceno and i.hfe_docno = f.hfe_docno)") \
				_T("     WHERE 1              =1 %s AND f.hfe_cost > 0") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND f.hfe_type      IN ('D', 'M', 'R')") \
				_T("     AND product_org_id IN ('PĐD')") \
				_T("     AND f.hfe_deptid <> 'B5'") \
				_T("     AND hfe_category    NOT IN ('Y')"), szWhere);
//Tách phần chọn BS ra
				szSQL29.Format(_T("     UNION ALL") \
				_T("     SELECT f.hfe_docno,") \
				_T("       f.hfe_type,") \
				_T("       f.hfe_invoiceno,") \
				_T("       f.hfe_date,") \
				_T("       ") \
				_T("       0 as hfe_quantity,") \
				_T("     CASE WHEN f.hfe_type ='O' AND HO_PDEPTID='B5' AND HO_DEPTID is not null THEN  HO_DEPTID ") \
				_T("     WHEN f.hfe_type='O' AND HO_PDEPTID  <>'B5' AND HO_PDEPTID is not null AND HO_DEPTID is not null THEN HO_PDEPTID") \
				_T("     WHEN HO_DEPTID is null then f.hfe_deptid else Fl.Hfl_Deptid END khoa_thuchien,") \
				_T("       f.hfe_itemid,") \
				_T("       ") \
				_T("       0 as TIEN_KHAM,") \
				_T("       0 as TIEN_GIUONG,     ") \
				_T("       0 as TIEN_CLS,") \
				//_T("       CASE WHEN f.hfe_patpaid>0 THEN f.hfe_patpaid ELSE NVL(f.hfe_otherpaid, 0) END as TIEN_PTTT,") \//				
				_T("       0 as TIEN_PTTT,") \
				_T("       0 as TIEN_THUOC_CH_NGOAITRU,") \
				_T("       0 as TIEN_THUOC_CH_NOITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T("       0 as TIEN_VAT_TU_CH_NOITRU,") \
				_T("       0 as TIEN_THUOC_PM,") \
				_T("       0 as TIEN_VAT_TU_PM,") \
				_T("       0 as TIEN_MAU,") \
				_T("       0 as THU_KHAC,") \
				_T("       0 as THU_GOI,") \
				_T("       0 as TIEN_AN,") \
				_T("       0 as TIEN_AN_HC,") \
				_T("       0 as TIEN_THUOC_TG,") \
				_T("       0 as TIEN_VAT_TU_TG,") \
				_T("       0 as TIEN_THUOC_TG_O,") \
				_T("       0 as TIEN_VAT_TU_TG_O,") \
				_T(" (SELECT coalesce(SUM(fd.hfe_amount),0) FROM hms_fee_discountline fd WHERE fd.hfe_docno = f.hfe_docno AND fd.HFE_INVOICELINE_ID = f.hfe_fee_id) AS  MIEN_GIAM,") \
				_T("       f.hfe_cost AS CHON_BS,") \
				_T("       f.hfe_category") \
				_T("     FROM hms_fee f") \
				_T("     LEFT JOIN hms_fee_list fl ON (hfe_itemid=fl.hfl_feeid)") \
				_T("     LEFT JOIN hms_operation") \
				_T("     ON ( f.hfe_docno = ho_docno") \
				_T("     AND hfe_orderid  = ho_idx") \
				_T("     )") \
				_T("     WHERE 1              =1 %s") \
				_T("     AND f.hfe_status    IN ('P','R')") \
				_T("     AND F.Hfe_type       ='O'") \
				_T("     AND NVL( hfl_categoryid, 0 )   = '501'") \
				_T("     AND f.hfe_category  NOT IN ('Y')"), szWhere);
}
rs.ExecSQL(szSQL);
	
   szSQL.Format(_T(" WITH tbl AS (%s)") \
				_T(" SELECT") \
				_T(" dept_id, SD_MAKHOA_TAICHINH, doituong, HO_TEN, docno, NGAY_VAO, NGAY_RA, posted_date, SUM(SO_NGAY_DT) as SO_NGAY_DT, ") \
				_T(" SUM(TIEN_KHAM) as TIEN_KHAM,") \
				_T(" SUM(TIEN_GIUONG) as TIEN_GIUONG,") \
				_T(" SUM(TIEN_CLS) as TIEN_CLS,") \
				_T(" SUM(TIEN_PTTT) as TIEN_PTTT,") \
				_T(" SUM(TIEN_THUOC_CH_NGOAITRU) as TIEN_THUOC_CH_NGOAITRU,") \
				_T(" SUM(TIEN_THUOC_CH_NOITRU) as TIEN_THUOC_CH_NOITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NGOAITRU) as TIEN_VAT_TU_CH_NGOAITRU,") \
				_T(" SUM(TIEN_VAT_TU_CH_NOITRU) as TIEN_VAT_TU_CH_NOITRU,") \
				_T(" SUM(TIEN_THUOC_PM) AS TIEN_THUOC_PM,") \
				_T(" SUM(TIEN_VAT_TU_PM) AS TIEN_VAT_TU_PM,") \
				_T(" SUM(TIEN_MAU) as TIEN_MAU,") \
				_T(" SUM(THU_KHAC) as THU_KHAC,") \
				_T(" SUM(THU_GOI) as THU_GOI,") \
				_T(" SUM(TIEN_AN) as TIEN_AN,") \
				_T(" SUM(TIEN_AN_HC) as TIEN_AN_HC,") \
				_T(" SUM(TIEN_THUOC_TG+TIEN_THUOC_TG_O) as TIEN_THUOC_TG,") \
				_T(" SUM(TIEN_VAT_TU_TG+TIEN_VAT_TU_TG_O) as TIEN_VAT_TU_TG,") \
				_T(" SUM(MIEN_GIAM) AS MIEN_GIAM,") \
				_T(" SUM(CHON_BS) AS CHON_BS,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+CHON_BS) as TONG_THU,") \
				_T(" SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+CHON_BS) as TONG_THU1") \
				_T(" FROM") \
				_T(" (") \
				_T(" SELECT") \
				_T("   Get_patientname(iv.hfe_docno) as HO_TEN,") \
				_T("   iv.hfe_docno as docno,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_ADMITDATE ELSE HD_ADMITDATE END NGAY_VAO,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN HCR_DISCHARGEDATE ELSE HD_ENDDATE END NGAY_RA,") \
				_T("    CASE WHEN HFE_CLASS = 'I' THEN 'I' ELSE 'II' END CHINDEX,") \
				_T("    trunc(hfe_date) as invoice_date,") \
				_T("    trunc(FAC_POSTEDDATE) as posted_date,") \
				_T("    iv.doituong as doituong,") \
				_T("    CASE") \
				_T("         WHEN NVL(iv.hfe_org_id, 'XX' )= 'EM'") \
				_T("         AND iv.hfe_deptid              = 'A3-D'") \
				_T("         THEN hd_admitdept") \
				_T("         ELSE iv.hfe_deptid") \
				_T("       END AS dept_id,") \

				_T("    hfe_quantity as SO_NGAY_DT,") \
				_T("     TIEN_KHAM,") \
				_T("     TIEN_GIUONG,") \
				_T("     TIEN_CLS,    ") \
				_T("     TIEN_PTTT,") \
				_T("     TIEN_THUOC_CH_NGOAITRU,") \
				_T("     TIEN_THUOC_CH_NOITRU,") \
				_T("     TIEN_VAT_TU_CH_NGOAITRU,    ") \
				_T("     TIEN_VAT_TU_CH_NOITRU,    ") \
				_T("     TIEN_THUOC_PM,") \
				_T("     TIEN_VAT_TU_PM,") \
				_T("     TIEN_MAU,    ") \
				_T("     THU_KHAC,") \
				_T("     THU_GOI,") \
				_T("     TIEN_AN,") \
				_T("     TIEN_AN_HC,") \
				_T("     TIEN_THUOC_TG,") \
				_T("     TIEN_VAT_TU_TG,") \
				_T("     TIEN_THUOC_TG_O,") \
				_T("     TIEN_VAT_TU_TG_O,") \
				_T("     MIEN_GIAM,") \
				_T("     CHON_BS,") \
				_T("     hfe_itemid") \
				_T("   FROM HMS_FEE_INVOICE_VIEW_SERVICE iv") \
				_T("   LEFT JOIN FA_CASH fc ON (fc.FAC_CASH_ID=iv.hfe_cash_id)") \
				_T("   LEFT JOIN HMS_DOC d  ON ( d.HD_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN HMS_CLINICAL_RECORD cr   ON ( cr.HCR_DOCNO=iv.HFE_DOCNO)") \
				_T("   LEFT JOIN  (") \
				_T("    %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s") \
				//_T("    %s %s ") \//
				_T("   )tbl1 ON (iv.hfe_invoiceno = tbl1.hfe_invoiceno and iv.hfe_docno = tbl1.hfe_docno)") \
				_T("   WHERE 1=1 %s") \
				_T("   )") \
				_T(" left join sys_dept on (sd_id = dept_id) where 1=1 %s ") \
				_T(" GROUP BY ") \
				_T(" CHINDEX, dept_id, SD_MAKHOA_TAICHINH, doituong, HO_TEN, docno, NGAY_VAO, NGAY_RA, posted_date ") \
				_T(" HAVING SUM(TIEN_KHAM+TIEN_GIUONG+TIEN_CLS+TIEN_PTTT+TIEN_THUOC_CH_NGOAITRU+TIEN_THUOC_CH_NOITRU+") \
				_T("	TIEN_VAT_TU_CH_NGOAITRU+TIEN_VAT_TU_CH_NOITRU+TIEN_THUOC_PM+TIEN_VAT_TU_PM+TIEN_MAU+THU_KHAC+THU_GOI+") \
				_T("	TIEN_AN+TIEN_AN_HC+TIEN_THUOC_TG+TIEN_VAT_TU_TG+TIEN_THUOC_TG_O+TIEN_VAT_TU_TG_O+CHON_BS)>0") \
				_T(" ORDER BY CHINDEX, docno"),m_szCashQuery, szSQL1,szSQL2,szSQL3,szSQL4,szSQL5,szSQL6,szSQL7,szSQL8,szSQL9,szSQL10,szSQL11,szSQL12,szSQL13,szSQL14,szSQL15,szSQL16,szSQL17,szSQL18,szSQL19,szSQL20,szSQL21,szSQL22,szSQL23, szSQL24,szSQL25, szSQL26, szSQL27, szSQL28, szSQL29, szWhere1, szWhere5);				
	return szSQL;
}

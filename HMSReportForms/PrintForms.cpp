#include "stdafx.h"
#include "PrintForms.h"
#include "MainFrame_E10.h"
#include "ReportDocument.h"
#include "afxtempl.h"
#include "HMSMainFrame.h"
#include "GuiMainFrame.h"
#include "StringToken.h"
#include "./Printer/E10_TrackItem.h"
#include "./Treatment/TMChoosePrintDateDlg.h"
#include "./Treatment/TMChooseCareDateDlg.h"
#include "./Examination/EMChooseCareDateDlg.h"
#include "ARReportOptionDlg.h"
#include "./LIMS/LIMSCancelledOrderDlg.h"
static CImage img;

#pragma comment(lib, "../lib/HMSExt.lib")
#pragma comment(lib, "../lib/HMSCore.lib")

static void SplitParagraph(CReport* pRpt, CReportSection* pDetail, CString szData, CString szField)
{
	CStringToken tokData(szData, _T("\r\n"));
	CString tmpStr;
	for (int i = 0; i < tokData.GetSize(); i++)
	{
		tokData.GetAt(i, tmpStr);
		pRpt->AddDetail(pDetail)->SetValue(szField, tmpStr);
	}
}

static void SplitParagraph(CReport* pRpt, CReportSection* pDetail, JSONVALUE& jData, CString szKey, CString szField)
{
	JSONVALUE jTitle;
	CString szData, tmpStr, szTitle;
	jTitle[_T("tuan_hoan")] = _T("Tuần hoàn");
	jTitle[_T("ho_hap")] = _T("Hô hấp");
	jTitle[_T("tieu_hoa")] = _T("Tiêu hóa");
	jTitle[_T("tiet_nieu")] = _T("Tiết niệu - Sinh dục");
	jTitle[_T("than_kinh")] = _T("Tâm - Thần kinh");
	jTitle[_T("co_xuong_khop")] = _T("Cơ - Xương - Khớp");
	jTitle[_T("chuyen_khoa_khac")] = _T("Các chuyên khoa khác: Tai - Mũi - Họng - Hàm - Mặt - Mắt - Nội tiết");
	jData[szKey].GetValue(szData);
	jTitle[szKey].GetValue(szTitle);

	szData.Format(_T("+ %s: %s"), szTitle, szData);
	CStringToken tokData(szData, _T("\r\n"));
	for (int i = 0; i < tokData.GetSize(); i++)
	{
		tokData.GetAt(i, tmpStr);
		pRpt->AddDetail(pDetail)->SetValue(szField, tmpStr);
	}
}
static CString SetNumberDelim(CString szNumber)
{
	CString szRet;
	szRet = szNumber;
	int nPeriodPos = 0, nDecimalPos = szRet.Find(_T("."));
	if (nDecimalPos == -1)
	{
		nDecimalPos = szRet.GetLength();
	}
	else
	{
		szRet.Replace(_T("."), _T(","));
	}
	for (int i = nDecimalPos; i >= 1; i--)
	{
		if (nPeriodPos > 0 && nPeriodPos % 3 == 0)
		{
			szRet.Insert(i, _T("."));
		}
		nPeriodPos++;
	}
	return szRet;
}
static HBITMAP GetPatientImage(long nPatientNo)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CString szFileName, szDir, szFilePath;
	CFileFind ff;
	TCHAR dir[MAX_PATH];
	szFileName.Format(L"%ld_image.jpg", nPatientNo);
	::GetTempPath(MAX_PATH, dir);
	szFilePath.Format(L"%s\\%s", dir, szFileName);
	printf("\nszFilePath:%s|find:%d\n", szFilePath, ff.FindFile(szFilePath));
	if (!ff.FindFile(szFilePath))
	{
		bool bRes = pMF->lo_export(szFileName, szFilePath);
		printf("\nexport:%d\n", bRes);
		if (!bRes)
		{
			return NULL;
		}
	}
	//CImage img;
	HRESULT hr = img.Load(szFilePath);
	if (hr == S_OK)
	{
		return HBITMAP(img);
	}
	else
	{
		printf("\nhr:%u\n", hr);
	}
	return NULL;

}

const int m_nMaxCol = 20;

typedef struct tagDrugInfo
{
	CString szItemID;
	CString szName;
	int nIndex;
}COLDRUGINFO;

typedef struct tagRECEIPTINFO {
	CString deptid;
	CString admitdate;
	CString dischargedate;
	CString mainicd;
	CString maindisease;
}RECEIPTINFO;

CPrintForms::CPrintForms(void)
{

}

CPrintForms::~CPrintForms(void)
{

}
void CPrintForms::PrintCashSheet(CString szVoucherNo, CString szVoucherType) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString szSQL, tmpStr, szSysDate;
	CRecord rs(&pMF->m_db);
	CReportSection* rptDetail = NULL;
	if (szVoucherType == _T("R"))
		tmpStr.Format(_T("Reports\\FA\\CashReceipt.RPT"));
	else if (szVoucherType == _T("P"))
		tmpStr.Format(_T("Reports\\FA\\CashPayment.RPT"));
	if (!rpt.Init(tmpStr))
		return;
	szSysDate = pMF->GetSysDate();
	szSQL = GetQueryString(_T("INVOICE"), szVoucherNo);
	rs.ExecSQL(szSQL);
	//rptDetail->SetValue(_T("COMPANYNAME"), rs.GetValue(_T("org")));
	//rptDetail->SetValue(_T("DEPARTMENT"), rs.GetValue(_T("client")));
	rpt.GetReportHeader()->SetValue(_T("COMPANYNAME"), _T("COMPANY NAME"));
	rpt.GetReportHeader()->SetValue(_T("DEPARTMENT"), _T("DEPARTMENT"));
	if (!rs.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("BookNo"), _T("..."));
		rpt.GetReportHeader()->SetValue(_T("SerialNo"), rs.GetValue(_T("invoiceno")));
		if (szVoucherType == _T("R"))
			rpt.GetReportHeader()->SetValue(_T("debitaccount"), rs.GetValue(_T("debit")));
		else if (szVoucherType == _T("P"))
			rpt.GetReportHeader()->SetValue(_T("account"), rs.GetValue(_T("credit")));
		rs.GetValue(_T("transactor"), tmpStr);
		tmpStr.MakeUpper();
		rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Address"), _T("Address"));
		rpt.GetReportHeader()->SetValue(_T("Reason"), rs.GetValue(_T("reason")));

		rpt.GetReportHeader()->SetValue(_T("TotalAmount"), rs.GetValue(_T("totalamount")));
		CString szXyz;
		MoneyToString(rs.GetValue(_T("totalamount")), szXyz);
		rpt.GetReportHeader()->SetValue(_T("SumInWord"), szXyz);
		tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
		rpt.GetReportHeader()->SetValue(_T("PrintDate"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("SumInWord1"), szXyz);
		szXyz.Empty();
		while (!rs.IsEOF())
		{
			if (!szXyz.IsEmpty())
				szXyz.Append(_T(", "));
			if (szVoucherType == _T("R"))
				szXyz.Append(rs.GetValue(_T("credit")));
			else if (szVoucherType == _T("P"))
				szXyz.Append(rs.GetValue(_T("debit")));
			rs.MoveNext();
		}
		if (szVoucherType == _T("R"))
			rpt.GetReportHeader()->SetValue(_T("account"), szXyz);
		else if (szVoucherType == _T("P"))
			rpt.GetReportHeader()->SetValue(_T("debitaccount"), szXyz);

	}
	rpt.PrintPreview();
}

void CPrintForms::PrintSheetList() {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString szSQL, tmpStr, szSysDate = pMF->GetSysDate();
	CRecord rs(&pMF->m_db);
	CReportSection* rptDetail = NULL;
	if (m_szType == _T("R"))
		tmpStr.Format(_T("Reports\\FA\\ReceiptList.RPT"));
	else if (m_szType == _T("P"))
		tmpStr.Format(_T("Reports\\FA\\PaymentList.RPT"));
	if (!rpt.Init(tmpStr))
		return;
	szSQL = GetQueryString(_T("SHEET_LIST"), m_szID);
	int nRes = rs.ExecSQL(szSQL);
	if (nRes <= 0)
	{
		//		_msg(_T("%s"), szSQL);
		return;
	}
	tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy), CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
	rpt.GetReportHeader()->SetValue(_T("ReportDate"), tmpStr);
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), CDate::Convert(rs.GetValue(_T("accdate")), yyyymmdd, ddmmyyyy));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("invno")));
		rptDetail->SetValue(_T("3"), CDate::Convert(rs.GetValue(_T("invdate")), yyyymmdd, ddmmyyyy));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("partner")));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("transactor")));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("Reason")));
		rptDetail->SetValue(_T("7"), rs.GetValue(_T("totalamt")));
		//rptDetail->SetValue(_T("8"), rs.GetValue(_T("accdate")));			
		rs.MoveNext();
	}
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::PrintBankReceipts(CString szVoucherNo, CString szVoucherType) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString szSQL, tmpStr, szSysDate;
	CRecord rs(&pMF->m_db);
	CReportSection* rptDetail = NULL;
	if (szVoucherType == _T("R"))
		tmpStr.Format(_T("Reports\\FA\\CashReceipt.RPT"));
	else if (szVoucherType == _T("P"))
		tmpStr.Format(_T("Reports\\FA\\CashPayment.RPT"));
	if (!rpt.Init(tmpStr))
		return;
	szSysDate = pMF->GetSysDate();
	rptDetail = rpt.AddDetail();
	szSQL = GetQueryString(_T("Bank"), szVoucherNo);
	rs.ExecSQL(szSQL);
	//Rare
	/*for (int i = 0; i < rs.GetFieldCount(); i++){
		CString szVn;
		szVn = rs.GetFieldName(i);
		_msg(_T("%s-%s"), szVn, rs.GetValue(szVn));
	}*/
	rptDetail->SetValue(_T("COMPANYNAME"), rs.GetValue(_T("org")));
	rptDetail->SetValue(_T("DEPARTMENT"), rs.GetValue(_T("client")));
	if (!rs.IsEOF())
	{
		rptDetail->SetValue(_T("BookNo"), _T("..."));
		rptDetail->SetValue(_T("SerialNo"), rs.GetValue(_T("invoiceno")));
		if (szVoucherType == _T("R"))
			rptDetail->SetValue(_T("debitaccount"), rs.GetValue(_T("debit")));
		else if (szVoucherType == _T("P"))
			rptDetail->SetValue(_T("account"), rs.GetValue(_T("credit")));
		rptDetail->SetValue(_T("PATIENTNAME"), rs.GetValue(_T("transactor")));
		rptDetail->SetValue(_T("Address"), _T("Address"));
		rptDetail->SetValue(_T("Reason"), rs.GetValue(_T("reason")));

		rptDetail->SetValue(_T("TotalAmount"), rs.GetValue(_T("totalamount")));
		CString szXyz;
		MoneyToString(rs.GetValue(_T("totalamount")), szXyz);
		rptDetail->SetValue(_T("SumInWord"), szXyz);
		tmpStr.Format(rptDetail->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
		rptDetail->SetValue(_T("PrintDate"), tmpStr);
		rptDetail->SetValue(_T("SumInWord1"), szXyz);
		szXyz.Empty();
		while (!rs.IsEOF())
		{
			if (!szXyz.IsEmpty())
				szXyz.Append(_T(", "));
			if (szVoucherType == _T("R"))
				szXyz.Append(rs.GetValue(_T("credit")));
			else if (szVoucherType == _T("P"))
				szXyz.Append(rs.GetValue(_T("debit")));
			rs.MoveNext();
		}
		if (szVoucherType == _T("R"))
			rptDetail->SetValue(_T("account"), szXyz);
		else if (szVoucherType == _T("P"))
			rptDetail->SetValue(_T("debitaccount"), szXyz);

	}
	rpt.PrintPreview();
}
void CPrintForms::PrintVoucher(CString szVoucherNo, CString szVoucherType) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString szSQL, tmpStr, szAmt, szID;
	int nID = 1;
	CRecord rs(&pMF->m_db);
	CReportSection* rptDetail = NULL;
	if (!rpt.Init(_T("Reports\\FA\\Voucher.RPT")))
		return;
	szSQL = GetQueryString(_T("CASH_VOUCHER"), szVoucherNo);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"), MB_OK);
		return;
	}
	rpt.GetReportHeader()->SetValue(_T("CompanyName"), rs.GetValue(_T("org")));
	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("department")));
	rpt.GetReportHeader()->SetValue(_T("PatientName"), rs.GetValue(_T("obj")));
	rpt.GetReportHeader()->SetValue(_T("Address"), rs.GetValue(_T("Addr")));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), CDate::Convert(rs.GetValue(_T("invoicedate")), yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("No"), rs.GetValue(_T("invoiceno")));
	rs.GetValue(_T("amt"), szAmt);
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		szID.Format(_T("%d"), nID++);
		rptDetail->SetValue(_T("1"), szID);
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("descr")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("debit")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("credit")));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("base")));
		rs.GetValue(_T("tax"), tmpStr);
		if (!tmpStr.IsEmpty())
		{
			rptDetail = rpt.AddDetail();
			szID.Format(_T("%d"), nID++);
			rptDetail->SetValue(_T("1"), szID);
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("desrc")));
			if (szVoucherType == _T("R"))
			{
				rptDetail->SetValue(_T("3"), rs.GetValue(_T("debit")));
				rptDetail->SetValue(_T("4"), rs.GetValue(_T("tax")));
			}
			else if (szVoucherType == _T("P"))
			{
				rptDetail->SetValue(_T("3"), rs.GetValue(_T("tax")));
				rptDetail->SetValue(_T("4"), rs.GetValue(_T("credit")));
			}
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("taxamt")));
		}
		rs.MoveNext();
	}
	CString szXyz;
	MoneyToString(szAmt, szXyz);
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), szXyz);
	rpt.PrintPreview();
}

void CPrintForms::PrintBankVoucher(CString szVoucherNo, CString szVoucherType) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString szSQL, tmpStr, szAmt, szID;
	int nID = 1;
	CRecord rs(&pMF->m_db);
	CReportSection* rptDetail = NULL;
	if (!rpt.Init(_T("Reports\\FA\\Voucher.RPT")))
		return;

	szSQL = GetQueryString(_T("BANK_VOUCHER"), szVoucherNo);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"), MB_OK);
		return;
	}
	rpt.GetReportHeader()->SetValue(_T("CompanyName"), rs.GetValue(_T("org")));
	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("department")));
	rpt.GetReportHeader()->SetValue(_T("PatientName"), rs.GetValue(_T("obj")));
	rpt.GetReportHeader()->SetValue(_T("Address"), rs.GetValue(_T("Addr")));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), CDate::Convert(rs.GetValue(_T("invoicedate")), yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("No"), rs.GetValue(_T("invoiceno")));
	rs.GetValue(_T("amt"), szAmt);
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		szID.Format(_T("%d"), nID++);
		rptDetail->SetValue(_T("1"), szID);
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("descr")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("debit")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("credit")));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("base")));
		rs.GetValue(_T("tax"), tmpStr);
		if (!tmpStr.IsEmpty())
		{
			rptDetail = rpt.AddDetail();
			szID.Format(_T("%d"), nID++);
			rptDetail->SetValue(_T("1"), szID);
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("descr")));
			if (szVoucherType == _T("C"))
			{
				rptDetail->SetValue(_T("3"), rs.GetValue(_T("debit")));
				rptDetail->SetValue(_T("4"), rs.GetValue(_T("tax")));
			}
			else if (szVoucherType == _T("D"))
			{
				rptDetail->SetValue(_T("3"), rs.GetValue(_T("tax")));
				rptDetail->SetValue(_T("4"), rs.GetValue(_T("credit")));
			}
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("taxamt")));
		}
		rs.MoveNext();
	}
	CString szXyz;
	MoneyToString(szAmt, szXyz);
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), szXyz);
	rpt.PrintPreview();
}
void CPrintForms::PrintPaymentOrder(CString szInvoiceNo) {

	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString szSQL, tmpStr, szAmt, szID;
	CRecord rs(&pMF->m_db);
	if (!rpt.Init(_T("Reports\\FA\\Uy Nhiem Chi.RPT")))
		return;
	szSQL = GetQueryString(_T("PAYMENT_ORDER"), szInvoiceNo);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		ShowMessageBox(_T("No Data"), MB_OK);
		return;
	}
	//Lien 1
	rpt.GetReportHeader()->SetValue(_T("SerialNo"), rs.GetValue(_T("SerialNo")));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), rs.GetValue(_T("PrintDate")));
	rpt.GetReportHeader()->SetValue(_T("Payer"), rs.GetValue(_T("Payer")));
	rpt.GetReportHeader()->SetValue(_T("AccNo"), rs.GetValue(_T("AccNo")));
	rpt.GetReportHeader()->SetValue(_T("Bank"), rs.GetValue(_T("Bank")));
	rpt.GetReportHeader()->SetValue(_T("Receiver"), rs.GetValue(_T("Receiver")));
	rpt.GetReportHeader()->SetValue(_T("AccNo0"), rs.GetValue(_T("AccNo0")));
	rpt.GetReportHeader()->SetValue(_T("Bank0"), rs.GetValue(_T("Bank0")));
	rpt.GetReportHeader()->SetValue(_T("TotalAmount"), rs.GetValue(_T("TotalAmount")));
	rpt.GetReportHeader()->SetValue(_T("SumInWord"), rs.GetValue(_T("SumInWord")));
	rpt.GetReportHeader()->SetValue(_T("Reason"), rs.GetValue(_T("Reason")));
	//Lien 2
	rpt.GetReportHeader()->SetValue(_T("SerialNo0"), rs.GetValue(_T("SerialNo")));
	rpt.GetReportHeader()->SetValue(_T("PrintDate0"), rs.GetValue(_T("PrintDate")));
	rpt.GetReportHeader()->SetValue(_T("Payer0"), rs.GetValue(_T("Payer")));
	rpt.GetReportHeader()->SetValue(_T("AccNo00"), rs.GetValue(_T("AccNo")));
	rpt.GetReportHeader()->SetValue(_T("Bank1"), rs.GetValue(_T("Bank")));
	rpt.GetReportHeader()->SetValue(_T("Receiver0"), rs.GetValue(_T("Receiver")));
	rpt.GetReportHeader()->SetValue(_T("AccNo01"), rs.GetValue(_T("AccNo0")));
	rpt.GetReportHeader()->SetValue(_T("Bank2"), rs.GetValue(_T("Bank0")));
	rpt.GetReportHeader()->SetValue(_T("TotalAmount0"), rs.GetValue(_T("TotalAmount")));
	rpt.GetReportHeader()->SetValue(_T("SumInWord0"), rs.GetValue(_T("SumInWord")));
	rpt.GetReportHeader()->SetValue(_T("Reason0"), rs.GetValue(_T("Reason")));

	rpt.PrintPreview();

}

void CPrintForms::PrintCreditNote(CString szNoteID, CString szVoucherType) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail;
	CString szReportName, szSQL;
	if (szVoucherType == _T("C"))
		szReportName.Format(_T("Reports\\FA\\CreditNote.RPT"));
	else
		szReportName.Format(_T("Reports\\FA\\DebitNote.RPT"));
	if (!rpt.Init(szReportName))
		return;
	szSQL = GetQueryString(_T("CREDIT_NOTE"), szNoteID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		//		_msg(_T("%s"), szSQL);
		ShowMessageBox(_T("No Data"), MB_OK);
		return;
	}
	rpt.GetReportHeader()->SetValue(_T("Funder"), rs.GetValue(_T("Funder")));
	rpt.GetReportHeader()->SetValue(_T("Address"), rs.GetValue(_T("Address")));
	rpt.GetReportHeader()->SetValue(_T("Reason"), rs.GetValue(_T("Reason")));
	rpt.GetReportHeader()->SetValue(_T("Currency"), rs.GetValue(_T("Currency")));
	rpt.GetReportHeader()->SetValue(_T("Amount"), rs.GetValue(_T("Amount")));
	rpt.GetReportHeader()->SetValue(_T("AmountInWord"), rs.GetValue(_T("AmountInWord")));
	rpt.GetReportHeader()->SetValue(_T("No"), rs.GetValue(_T("No")));
	rpt.GetReportHeader()->SetValue(_T("Date"), rs.GetValue(_T("dte")));
	rpt.GetReportHeader()->SetValue(_T("AccNo"), rs.GetValue(_T("AccNo")));
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), rs.GetValue(_T("c1")));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("c2")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("c3")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("c4")));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("c5")));
		rs.MoveNext();
	}
	rpt.PrintPreview();
}

void CPrintForms::PrintIESheet(CString szOrderNo, CString szOrderType, CString szOrderDate) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail;
	CString szReportName, szSQL, tmpStr, szDate;
	bool bImport = false, bExport = false;
	double nTotal = 0, nAmt = 0;
	int nIdx = 1;
	if (szOrderType == _T("I"))
	{
		bImport = true;
		szReportName.Format(_T("Reports\\FA\\ImportOrder.RPT"));
		szSQL = GetQueryString(_T("PURCHASE_ORDER"), szOrderNo);
	}
	else
	{
		bExport = true;
		szReportName.Format(_T("Reports\\FA\\ExportOrder.RPT"));
		szSQL = GetQueryString(_T("EXPORT_ORDER"), _T(""));
	}
	if (!rpt.Init(szReportName))
		return;
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"), MB_OK);
		return;
	}
	//rpt.GetReportHeader()->SetValue(_T("CompanyName"), );
	//rpt.GetReportHeader()->SetValue(_T("Department"), );
	_debug(_T("%s"), szOrderDate);
	tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("SheetDate")), szOrderDate.Right(2), szOrderDate.Mid(5, 2), szOrderDate.Left(4));
	rpt.GetReportHeader()->SetValue(_T("SheetDate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("SheetNo"), rs.GetValue(_T("ShtNo")));
	rpt.GetReportHeader()->SetValue(_T("DebitAccount"), rs.GetValue(_T("DebAcc")));
	rpt.GetReportHeader()->SetValue(_T("CreditAccount"), rs.GetValue(_T("CreAcc")));
	rpt.GetReportHeader()->SetValue(_T("SupplierName"), rs.GetValue(_T("SupNme")));
	rpt.GetReportHeader()->SetValue(_T("StockName"), rs.GetValue(_T("StkNme")));
	rpt.GetReportHeader()->SetValue(_T("Address"), rs.GetValue(_T("Ads")));
	if (bExport)
		rpt.GetReportHeader()->SetValue(_T("Unit"), rs.GetValue(_T("Unt")));
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		CString szFld, szCol;
		tmpStr.Format(_T("%d"), nIdx++);
		rptDetail->SetValue(_T("1"), tmpStr);
		for (int i = 1; i < 8; i++)
		{
			szCol.Format(_T("%d"), i + 1);
			szFld.Format(_T("c%d"), i + 1);
			rs.GetValue(szFld, tmpStr);
			if (i == 7)
			{
				rs.GetValue(szFld, nAmt);
				nTotal += nAmt;
			}
			rptDetail->SetValue(szCol, tmpStr);
		}
		rs.MoveNext();
	}
	tmpStr.Format(_T("%.2f"), nTotal);
	rpt.GetReportFooter()->SetValue(_T("SubTotal"), tmpStr);
	MoneyToString(ToString(nTotal), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
	szDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Right(2), szDate.Mid(5, 2), szDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::PrintTestReport() {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail;
	CReportSection* rptHeader;
	CString szReportName, szSQL, tmpStr, szMem, szTit, szDate;
	if (!rpt.Init(_T("Reports\\FA\\FA_TestReport.RPT")))
		return;
	//Step to undercover field name
	//for (int i = 0; i < 50; i++)
	//{
	//	_debug(_T("%s"), rpt.GetDetail()->GetItem(i)->GetName());
	//}
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("companyname"), _T("COMPNAY NAME"));
	rptHeader->SetValue(_T("department"), _T("DEPARTMENT"));
	tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), _T("05/08/2013"), _T("05/08/2013"));
	rptHeader->SetValue(_T("ReportDate"), tmpStr);
	for (int i = 1; i <= 10; i++)
	{
		szMem.Format(_T("Member%d"), i);
		szTit.Format(_T("Title%d"), i);
		rptHeader->SetValue(szMem, szMem);
		rptHeader->SetValue(szTit, szTit);
	}
	rptDetail = rpt.AddDetail(rpt.GetGroupHeader(0));
	rptDetail->SetValue(_T("GroupName"), _T("GroupName"));
	rptDetail = rpt.AddDetail();
	for (int i = 1; i <= 9; i++)
		rptDetail->SetValue(i, i);
	szDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Right(2), szDate.Mid(5, 2), szDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::PrintPurchaseList() {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail;
	CReportSection* rptHeader;
	CString szReportName, szSQL, tmpStr, szDate;
	if (!rpt.Init(_T("Reports\\FA\\FA_PurchaseList.RPT")))
		return;
	//Step to undercover field name
	//for (int i = 0; i < 50; i++)
	//{
	//	_debug(_T("%s"), rpt.GetDetail()->GetItem(i)->GetName());
	//}
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("companyname"), _T("COMPNAY NAME"));
	rptHeader->SetValue(_T("department"), _T("DEPARTMENT"));
	tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), _T("05/08/2013"), _T("05/08/2013"));
	rptHeader->SetValue(_T("ReportDate"), tmpStr);
	rptDetail = rpt.AddDetail(rpt.GetGroupHeader(0));
	rptDetail->SetValue(_T("GroupName"), _T("GroupName"));
	rptDetail = rpt.AddDetail();
	for (int i = 1; i <= 9; i++)
		rptDetail->SetValue(i, i);
	szDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Right(2), szDate.Mid(5, 2), szDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::PrintMaterialReport() {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail;
	CReportSection* rptHeader;
	CString szReportName, szSQL, tmpStr, szMem, szTit, szDate;
	if (!rpt.Init(_T("Reports\\FA\\FA_MaterialReport.RPT")))
		return;
	//Step to undercover field name
	//for (int i = 0; i < 50; i++)
	//{
	//	_debug(_T("%s"), rpt.GetDetail()->GetItem(i)->GetName());
	//}
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("companyname"), _T("COMPNAY NAME"));
	rptHeader->SetValue(_T("department"), _T("DEPARTMENT"));
	tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), _T("05/08/2013"), _T("05/08/2013"));
	rptHeader->SetValue(_T("ReportDate"), tmpStr);
	for (int i = 1; i <= 10; i++)
	{
		szMem.Format(_T("Member%d"), i);
		szTit.Format(_T("Title%d"), i);
		rptHeader->SetValue(szMem, szMem);
		rptHeader->SetValue(szTit, szTit);
	}
	rptDetail = rpt.AddDetail(rpt.GetGroupHeader(0));
	rptDetail->SetValue(_T("GroupName"), _T("GroupName"));
	rptDetail = rpt.AddDetail();
	for (int i = 1; i <= 16; i++)
		rptDetail->SetValue(i, i);
	szDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Right(2), szDate.Mid(5, 2), szDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::PrintMaterialRemain() {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail;
	CReportSection* rptHeader;
	CString szReportName, szSQL, tmpStr;
	if (!rpt.Init(_T("Reports\\FA\\FA_MaterialRemain.RPT")))
		return;
	//Step to undercover field name
	//for (int i = 0; i < 50; i++)
	//{
	//	_debug(_T("%s"), rpt.GetDetail()->GetItem(i)->GetName());
	//}
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("companyname"), _T("COMPANY NAME"));
	rptHeader->SetValue(_T("department"), _T("DEPARTMENT"));
	tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), _T("05/08/2013"), _T("05/08/2013"));
	rptHeader->SetValue(_T("ReportDate"), tmpStr);
	rptDetail = rpt.AddDetail(rpt.GetGroupHeader(0));
	rptDetail->SetValue(_T("GroupName"), _T("GroupName"));
	rptDetail = rpt.AddDetail();
	for (int i = 1; i <= 6; i++)
		rptDetail->SetValue(i, i);
	rpt.PrintPreview();
}

void CPrintForms::PrintDistribution() {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail;
	CReportSection* rptHeader;
	CString szReportName, szSQL, tmpStr, szDate;
	if (!rpt.Init(_T("Reports\\FA\\FA_Distribution.RPT")))
		return;
	//Step to undercover field name
	//for (int i = 0; i < 50; i++)
	//{
	//	_debug(_T("%s"), rpt.GetDetail()->GetItem(i)->GetName());
	//}
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("companyname"), _T("COMPANY NAME"));
	rptHeader->SetValue(_T("department"), _T("DEPARTMENT"));
	tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), _T("05/08/2013"), _T("05/08/2013"));
	rptHeader->SetValue(_T("ReportDate"), tmpStr);
	rptDetail = rpt.AddDetail(rpt.GetGroupHeader(0));
	rptDetail->SetValue(_T("GroupName"), _T("GroupName"));
	rptDetail = rpt.AddDetail();
	for (int i = 1; i <= 8; i++)
		rptDetail->SetValue(i, i);
	szDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Right(2), szDate.Mid(5, 2), szDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::PrintPurchaseOrder(long nOrderID)
{
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CString szSQL, szOrderDate, szstringex;
	CString tmpStr, tmpStr2;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	//if(!pMF->CheckPermission(_T("01.05")))
	//{
	//	ShowMessageBox(_T("Permission denined"), MB_OK);
	//	return;
	//}


	szSQL.Format(_T(" SELECT po_orderno as orderno, ") \
		_T("	po_invoiceno as invoiceno,") \
		_T("	Get_Taxrate(po_tax_id)*100 as vat, ") \
		_T(" 	po_invoicedate as invoicedate,") \
		_T("	(po_approveddate) as importdate,") \
		_T("	(po_orderdate) as orderdate,") \
		_T(" 	po_status as status,") \
		_T(" 	GET_PARTNERNAME(po_partner_id) as suppliername,") \
		_T(" 	coalesce(get_username(po_deliveryby), po_deliveryby) as deliverby,") \
		_T(" 	coalesce(get_username(po_receivedby), po_receivedby) as receiveby,") \
		_T(" 	po_debitacct as debitaccount,") \
		_T(" 	po_creditacct as creditaccount,") \
		_T("	GET_PRODUCTRESOURCE_DESC(po_resource_id) as original , ") \
		_T("	GET_USERNAME(po_createdby) as createdby, ") \
		_T("	po_description as description,") \
		_T("	po_reference as voucher,") \
		_T("	(select msl_category from m_storagelist where msl_storage_id = po_storage_id) storage_category,") \
		_T(" 	GET_STORAGENAME(po_storage_id) as storagename,	") \
		_T(" 	case when po_storage_id in (7, 50, 53) then 'Y' else 'N' end as storageid,	") \
		_T("	po_documentno as documentno, ADP_CONTRACT_NO as so_hopdong, ") \
		_T("	(select NVL(msl_sub_org_id, 'N') from m_storagelist where msl_storage_id = po_storage_id) storage_sub_org_id,") \

		_T("  adp_taxcode as ma_so_thue,") \
		_T("   po_kyhieu as kyhieu,") \
		_T("   (select ADC_CONTRACT_NO from ad_contract WHERE adc_contract_id=po_contract_id)") \
		_T("   as so_hopdong_moi,") \
		_T(" po_contractpkg_id as goi_thau_so") \
		_T(" FROM purchase_order LEFT JOIN ad_partner ON (PO_PARTNER_ID=adp_partner_id)") \
		_T(" WHERE po_purchase_order_id=%ld "), nOrderID);
	//_msg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		ShowMessageBox(_T("No Data"));
		return;
	}

	CReport rpt;
	CString szDate, szSysDate, szstorage_sub_org_id, szstorageid;

	rs.GetValue(_T("status"), tmpStr);
	rs.GetValue(_T("storageid"), szstorageid);
	rs.GetValue(_T("storage_sub_org_id"), szstorage_sub_org_id);

	if (tmpStr != _T("A"))
	{
		return;
	}

	CString szReportTitle, szPath;
	if (pMF->GetModuleID() == _T("MA"))
	{
		szReportTitle = _T("PM_PHIEUNHAPKHO_MA");
	}
	else if (pMF->GetModuleID() == _T("BB"))
	{
		szReportTitle = _T("PM_PHIEUNHAPKHO");
	}

	else if (pMF->GetModuleID() == _T("PCNMT") && szstorage_sub_org_id != _T("N"))
	{
		szReportTitle.Format(_T("%s_%s_PHIEUNHAPKHO"), pMF->GetModuleID(), szstorage_sub_org_id);
	}

	else
	{
		szReportTitle.Format(_T("%s_PHIEUNHAPKHO"), pMF->GetModuleID());
	}
	szPath.Format(_T("Reports/HMS/%s.RPT"), szReportTitle);
	if (!rpt.Init(szPath))
	{
		return;
	}
	//Step to undercover field name
	//for (int i = 0; i < 50; i++)
	//{
	//	_debug(_T("%s"), rpt.GetReportHeader()->GetItem(i)->GetName());
	//}
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rpt.GetReportHeader()->SetValue(_T("Department"), pMF->GetDepartmentName(pMF->GetDepartmentID()));
	rs.GetValue(_T("orderdate"), szOrderDate);
	szDate = CDateTime::Convert(szOrderDate, yyyymmdd | hhmmss, ddmmyyyy | hhmmss);
	rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);

	rpt.GetReportHeader()->SetValue(_T("ID"), nOrderID);
	rs.GetValue(_T("Invoiceno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Orderno"), rs.GetValue(_T("orderno")));
	rpt.GetReportHeader()->SetValue(_T("goi_thau_so"), rs.GetValue(_T("goi_thau_so")));

	szSQL.Format(_T(" select stringex from") \
		_T(" (") \
		_T(" SELECT") \
		_T("   case when TO_CHAR(mpei_cong_bo,'DD/MM/YYYY') ='14/09/1752' then  ") \
		_T("   mpei_so_hop_dong") \
		_T("     ||'['") \
		_T("     ||TO_CHAR(adcp_date,'DD/MM/YYYY')") \
		_T("     ||']'") \
		_T("     ||mpei_quyet_dinh") \
		_T("     ||''    ") \
		_T("   else  ") \
		_T("   mpei_so_hop_dong") \
		_T("     ||'['") \
		_T("     ||TO_CHAR(adcp_date,'DD/MM/YYYY')") \
		_T("     ||']'") \
		_T("     ||mpei_quyet_dinh") \
		_T("     ||'['") \
		_T("     ||TO_CHAR(mpei_cong_bo,'DD/MM/YYYY')") \
		_T("     ||']' end AS stringex") \
		_T("   FROM m_product_extra_info") \
		_T("   LEFT JOIN ad_contract_package") \
		_T("   ON (mpei_quyet_dinh=adcp_contract_package_id)") \
		_T("   LEFT JOIN purchase_orderline") \
		_T("   ON (MPEI_PRODUCT_ID        =pol_product_id)") \
		_T("   WHERE pol_purchase_order_id=%ld") \
		_T("   ORDER BY ADCP_YEAR DESC") \
		_T(" )") \
		_T(" where rownum=1"), nOrderID);
	rsl.ExecSQL(szSQL);
	rsl.GetValue(_T("stringex"), szstringex);


	if (!szstringex.IsEmpty() && pMF->GetModuleID() == _T("PM"))
	{
		rpt.GetReportHeader()->SetValue(_T("so_hopdong"), szstringex);
	}
	else
		rpt.GetReportHeader()->SetValue(_T("so_hopdong"), rs.GetValue(_T("so_hopdong")));


	rs.GetValue(_T("invoicedate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InvoiceDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs.GetValue(_T("Status"), tmpStr);
	if (tmpStr == _T("A"))
		TranslateString(_T("Approved"), tmpStr);
	else
		TranslateString(_T("Openning"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
	rs.GetValue(_T("suppliername"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("suppliername"), tmpStr);
	/*rs.GetValue(_T("deliverby"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("deliverby"), tmpStr);
	rs.GetValue(_T("ReceiveBy"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("receiveby"), tmpStr);*/
	rs.GetValue(_T("DebitAccount"), tmpStr);
	if (tmpStr == _T("0"))
		tmpStr.Empty();
	rpt.GetReportHeader()->SetValue(_T("DebitAccount"), tmpStr);
	rs.GetValue(_T("CreditAccount"), tmpStr);
	if (tmpStr == _T("0"))
		tmpStr.Empty();
	rpt.GetReportHeader()->SetValue(_T("CreditAccount"), tmpStr);
	rs.GetValue(_T("StorageName"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName"), tmpStr);
	rs.GetValue(_T("Importdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ImportDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs.GetValue(_T("voucher"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("voucher"), tmpStr);

	if (pMF->GetModuleID() == _T("MA"))
	{
		rs.GetValue(_T("documentno"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("ReferenceNo"), tmpStr);
	}

	rs.GetValue(_T("description"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Reason"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Source"), rs.GetValue(_T("original")));

	rpt.GetReportHeader()->SetValue(_T("ma_so_thue"), rs.GetValue(_T("ma_so_thue")));
	rpt.GetReportHeader()->SetValue(_T("kyhieu"), rs.GetValue(_T("kyhieu")));
	rpt.GetReportHeader()->SetValue(_T("so_hopdong_moi"), rs.GetValue(_T("so_hopdong_moi")));
	//Page Header
	//Report Detail

	int nCount = 0;
	int nVAT;
	double nTotalAmount = 0;
	double nTotalVatAmount = 0;
	CString szMoney, szExprDate, szItemType;
	rs.GetValue(_T("vat"), nVAT);

	tmpStr.Format(_T("%d %s"), nVAT, _T("%"));

	rpt.GetReportHeader()->SetValue(_T("VAT"), tmpStr);

	if (pMF->GetModuleID() == _T("PM") && szstorageid == _T("Y"))
	{
		szSQL.Format(_T(" SELECT ") \
			_T(" product_id as id, ") \
			_T(" product_name as name,") \
			_T(" 	GET_UOMNAME(product_purchase_uomid) as unit,") \
			_T(" 	pol_expdate as expdate,") \
			_T(" 	pol_lotno as lotno,") \
			_T("	product_countryname as madein,") \
			_T("	product_manufacturename as mfgname,") \
			_T(" 	pol_qtyorder as qty,") \
			_T(" 	pol_unitprice as price,") \
			_T("	product_groupname,") \
			_T(" 	PRODUCT_VATPRICE as vatprice,") \
			_T("	PRODUCT_VATPRICE*pol_qtyorder vatamount,") \
			_T(" 	pol_qtyorder*pol_unitprice as amount ") \
			_T(" FROM purchase_orderline") \
			_T(" lEFT JOIN purchase_order ON (po_purchase_order_id = pol_purchase_order_id)") \
			_T(" LEFT JOIN m_productitem_view3") \
			_T(" on(product_item_id              =pol_product_item_id) ") \
			_T(" WHERE pol_purchase_order_id=%ld ORDER BY pol_line "), nOrderID);
	}
	else
	{
		szSQL.Format(_T(" SELECT ") \
			_T(" product_id as id, ") \
			_T(" product_name as name,") \
			_T(" 	GET_UOMNAME(product_purchase_uomid) as unit,") \
			_T(" 	pol_expdate as expdate,") \
			_T(" 	pol_lotno as lotno,") \
			_T("	product_countryname as madein,") \
			_T("	product_manufacturename as mfgname,") \
			_T(" 	pol_qtyorder as qty,") \
			_T(" 	pol_unitprice as price,") \
			_T("	product_groupname,") \
			_T(" 	pol_unitprice+pol_unitprice*pol_taxrate/100.0 as vatprice,") \
			_T("	(pol_unitprice+pol_unitprice*pol_taxrate/100.0)*pol_qtyorder vatamount,") \
			_T(" 	pol_qtyorder*pol_unitprice as amount ") \
			_T(" FROM purchase_orderline") \
			_T(" LEFT JOIN m_productitem_view3") \
			_T(" on(product_item_id              =pol_product_item_id) ") \
			_T(" WHERE pol_purchase_order_id=%ld ORDER BY pol_line "), nOrderID);
	}
	rs2.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);	
	CReportSection* rptDetail;
	while (!rs2.IsEOF()) {
		rptDetail = rpt.AddDetail();
		rs2.GetValue(_T("expdate"), tmpStr);
		if (CDate::IsValid(tmpStr))
			szExprDate = CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy);
		else
			szExprDate.Empty();
		nTotalAmount += ToDouble(rs2.GetValue(_T("amount")));
		nTotalVatAmount += ToDouble(rs2.GetValue(_T("vatamount")));
		nCount++;
		rs2.GetValue(_T("product_groupname"), tmpStr);
		if (szItemType.Find(tmpStr) == -1)
		{
			if (!szItemType.IsEmpty())
				szItemType += _T(", ");
			szItemType.AppendFormat(_T("%s"), tmpStr);
		}

		tmpStr.Format(_T("%d"), nCount);
		rptDetail->SetValue(_T("1"), tmpStr);
		rs2.GetValue(_T("name"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rs2.GetValue(_T("unit"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rptDetail->SetValue(_T("4"), szExprDate);
		rs2.GetValue(_T("lotno"), tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		tmpStr = SetNumberDelim(rs2.GetValue(_T("qty")));
		rptDetail->SetValue(_T("6"), tmpStr);
		tmpStr = SetNumberDelim(rs2.GetValue(_T("price")));
		rptDetail->SetValue(_T("7"), tmpStr);
		tmpStr = SetNumberDelim(rs2.GetValue(_T("vatprice")));
		rptDetail->SetValue(_T("8"), tmpStr);

		tmpStr = SetNumberDelim(rs2.GetValue(_T("amount")));
		rptDetail->SetValue(_T("9"), tmpStr);
		rs2.GetValue(_T("madein"), tmpStr);
		rptDetail->SetValue(_T("10"), tmpStr);
		rs2.GetValue(_T("mfgname"), tmpStr);
		rptDetail->SetValue(_T("11"), tmpStr);
		tmpStr = SetNumberDelim(rs2.GetValue(_T("vatamount")));
		rptDetail->SetValue(_T("12"), tmpStr);
		rs2.MoveNext();
	}
	CStringToken token(szItemType);
	int nTokenSize = token.GetSize();
	switch (nTokenSize)
	{
	case 0:
		break;
	case 1:
		token.GetAt(0, tmpStr2);
		TranslateString(tmpStr2, tmpStr);
		break;
	case 6:
		tmpStr = _T("To\xE0n \x62\x1ED9");
		break;
	default:
		tmpStr = _T("\x110\x61 lo\x1EA1i");
		break;
	}
	rpt.GetReportHeader()->SetValue(_T("ItemType"), tmpStr);
	//	rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
	double nVatAmt = (double)(nTotalAmount * nVAT) / 100.0;
	//	FormatCurrency(nTotalAmount, tmpStr);
	//	rptDetail->SetValue(_T("s8"), tmpStr);
		//Page Footer
		//Report Footer
	rs.GetValue(_T("createdby"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("CreatedBy"), tmpStr);

	tmpStr.Format(_T("%d"), nCount);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(nTotalAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SubTotal"), tmpStr);
	FormatCurrency(nVatAmt, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalVAT"), tmpStr);
	//FormatCurrency(floor(nTotalAmount + nVatAmt + 0.5), tmpStr);
	FormatCurrency(nTotalVatAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	FormatCurrency(nTotalVatAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalPrice"), tmpStr);
	//szMoney.Format(_T("%.2f"), floor(nTotalAmount + nVatAmt + 0.5));
	szMoney.Format(_T("%.2f"), nTotalVatAmount);
	MoneyToString(szMoney, tmpStr);
#ifdef UNICODE
	if (!tmpStr.IsEmpty()
		)
		tmpStr += _T(" \x111\x1ED3ng.");
#else
	if (!tmpStr.IsEmpty())
		tmpStr += _T(" ®ång.");
#endif
	CReportSection* rptFooter = rpt.GetReportFooter();
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
	szSysDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate"))
		, szOrderDate.Mid(8, 2), szOrderDate.Mid(5, 2), szOrderDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate2"))
		, szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate2"), tmpStr);
	OnPrintFooterUser(rptFooter, rs.GetValue(_T("storage_category")) == _T("S") ? _T("DV") : _T("BH"), _T("'ng_giao', 'ng_nhan'"));
	rptFooter->SetValue(_T("ng_giao"), rs.GetValue(_T("deliverby")));
	rptFooter->SetValue(_T("ng_nhan"), rs.GetValue(_T("ReceiveBy")));
	rptFooter->SetValue(_T("createdby1"), pMF->GetUserName(pMF->GetCurrentUser()));
	rpt.PrintPreview();
}

void CPrintForms::PrintCheckinPurchaseOrder(long nOrderID) {

	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CString szSQL;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord mrs(&pMF->m_db);
	//CPMSMemberDialog dlg(pMF);
	//
	//if(dlg.DoModal() != IDOK)
	//	return;


	szSQL.Format(_T(" SELECT po_orderno as invoiceno, ") \
		_T(" GET_TAXRATE(po_tax_id)*100 as vat, ") \
		_T(" 	po_orderdate as invoicedate,") \
		_T(" 	po_status as status,") \
		_T(" 	GET_PARTNERNAME(po_partner_id) as suppliername,") \
		_T(" 	coalesce(get_username(po_deliveryby), po_deliveryby) as deliverby,") \
		_T(" 	coalesce(get_username(po_receivedby), po_receivedby) as receiveby,") \
		_T(" 	po_debitacct as deibtaccount,") \
		_T(" 	po_creditacct as creditaccount,") \
		_T("	po_description as description,") \
		_T(" 	GET_STORAGENAME(po_storage_id) as stockname	") \
		_T(" FROM purchase_order") \
		_T(" WHERE po_purchase_order_id=%ld "), nOrderID);
	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
		return;

	szSQL.Format(_T("SELECT * FROM m_member ORDER BY mm_id"));
	mrs.ExecSQL(szSQL);

	CReport rpt;
	CString tmpStr;
	CString szDate, szSysDate, szName;
	if (pMF->GetModuleID() == _T("MA"))
	{
		if (!rpt.Init(_T("Reports/HMS/PMS_CHECKINPURCHASEINVOICE_MA.RPT")))
			return;
	}
	else
	{
		if (!rpt.Init(_T("Reports/HMS/PMS_CHECKINPURCHASEINVOICE.RPT")))
			return;
	}


	//Step to undercover field name
	//for (int i = 0; i < 50; i++)
	//{
	//	_debug(_T("%s"), rpt.GetReportHeader()->GetItem(i)->GetName());
	//}
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);

	szSysDate = pMF->GetSysDate();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);


	while (!mrs.IsEOF()) {
		int n;
		mrs.GetValue(_T("mm_id"), n);
		szName.Format(_T("Member%d"), n);
		mrs.GetValue(_T("mm_name"), tmpStr);
		rpt.GetReportHeader()->SetValue(szName, tmpStr);
		szName.Format(_T("Title%d"), n);
		mrs.GetValue(_T("mm_title"), tmpStr);
		rpt.GetReportHeader()->SetValue(szName, tmpStr);
		mrs.MoveNext();
	}
	rpt.GetReportHeader()->SetValue(_T("ID"), nOrderID);
	rs.GetValue(_T("InvoiceNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);
	rs.GetValue(_T("Invoicedate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InvoiceDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs.GetValue(_T("Status"), tmpStr);
	if (tmpStr == _T("A"))
		TranslateString(_T("Approved"), tmpStr);
	else
		TranslateString(_T("Openning"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);

	rs.GetValue(_T("suppliername"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("suppliername"), tmpStr);
	rs.GetValue(_T("deliverby"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("deliverby"), tmpStr);
	rs.GetValue(_T("ReceiveBy"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("receiveby"), tmpStr);
	rs.GetValue(_T("DebitAccount"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DebitAccount"), tmpStr);
	rs.GetValue(_T("CreditAccount"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CreditAccount"), tmpStr);
	rs.GetValue(_T("StockName"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName"), tmpStr);
	rs.GetValue(_T("description"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Comment"), tmpStr);
	//Page Header
	//Report Detail

	int nCount = 0;
	int nVAT;
	double nTotalAmount = 0;
	double nTotalVatAmount = 0;
	CString szMoney, szExprDate;

	rs.GetValue(_T("vat"), nVAT);

	szSQL.Format(_T(" SELECT ") \
		_T(" product_id as id, ") \
		_T(" GET_FEEGROUPNAME(product_producttype)  as drugtype, ") \
		_T(" product_name as name,") \
		_T(" 	GET_UOMNAME(product_purchase_uomid) as unit,") \
		_T(" 	pol_expdate as expdate,") \
		_T(" 	pol_lotno as lotno,") \
		_T(" 	pol_qtyorder as qty,") \
		_T(" 	pol_unitprice as price,") \
		/*_T(" 	mpi_insprice as vatprice,") \*/
		_T(" 	pol_qtyorder*pol_unitprice as amount, ") \
		/*_T(" 	pol_order_qty*mpi_insprice as vatamt, ") \*/
		/*_T(" 	GET_COUNTRYNAME(mp_country_id) as orgcountry, ") \*/
		_T("	GET_MANUFACTURENAME(pol_manufacture_id) as mfgcountry ") \
		_T(" FROM purchase_orderline") \
		_T(" LEFT JOIN m_product_view") \
		_T(" on(product_id              =pol_product_id)") \
		_T(" WHERE pol_purchase_order_id=%ld ORDER BY pol_line "), nOrderID);

	rs2.ExecSQL(szSQL);
	if (rs2.IsEOF())
		return;

	CReportSection* rptDetail = rpt.GetDetail(0);
	while (!rs2.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		rs2.GetValue(_T("expdate"), tmpStr);
		if (CDate::IsValid(tmpStr))
			szExprDate = CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy);
		else
			szExprDate.Empty();
		nTotalAmount += ToDouble(rs2.GetValue(_T("amount")));
		nTotalVatAmount += ToDouble(rs2.GetValue(_T("vatamt")));
		nCount++;


		tmpStr.Format(_T("%d"), nCount);
		rptDetail->SetValue(_T("1"), tmpStr);
		rs2.GetValue(_T("drugtype"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		//	rs2.GetValue(_T("id"), tmpStr);
		rs2.GetValue(_T("name"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rs2.GetValue(_T("unit"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);

		rptDetail->SetValue(_T("5"), szExprDate);

		rs2.GetValue(_T("lotno"), tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		FormatCurrencyStr(rs2.GetValue(_T("qty")), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		FormatCurrencyStr(rs2.GetValue(_T("price")), tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);
		FormatCurrencyStr(rs2.GetValue(_T("amount")), tmpStr);
		rptDetail->SetValue(_T("10"), tmpStr);
		rs2.GetValue(_T("orgcountry"), tmpStr);
		rptDetail->SetValue(_T("11"), tmpStr);
		FormatCurrencyStr(rs2.GetValue(_T("vatprice")), tmpStr);
		rptDetail->SetValue(_T("12"), tmpStr);
		FormatCurrencyStr(rs2.GetValue(_T("vatamt")), tmpStr);
		rptDetail->SetValue(_T("13"), tmpStr);
		rs2.GetValue(_T("mfgcountry"), tmpStr);
		rptDetail->SetValue(_T("14"), tmpStr);
		rs2.MoveNext();
	}
	//Page Footer
	//Report Footer
	tmpStr.Format(_T("%d"), nCount);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(nTotalAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SubTotal"), tmpStr);
	double nVatAmt = (double)(nTotalAmount * nVAT) / 100.0;
	FormatCurrency(nVatAmt, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalVAT"), tmpStr);
	FormatCurrency(nTotalAmount + nVatAmt, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	FormatCurrency(nTotalVatAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Total4Price"), tmpStr);
	szMoney.Format(_T("%.2f"), nTotalAmount + nVatAmt);
	MoneyToString(szMoney, tmpStr);
	if (!tmpStr.IsEmpty())
		tmpStr += _T(" \x111\x1ED3ng.");
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);

	mrs.MoveFirst();
	while (!mrs.IsEOF()) {
		int n;
		mrs.GetValue(_T("mm_id"), n);
		szName.Format(_T("UserName%d"), n);
		mrs.GetValue(_T("mm_name"), tmpStr);
		rpt.GetReportFooter()->SetValue(szName, tmpStr);
		szName.Format(_T("Office%d"), n);
		mrs.GetValue(_T("mm_title"), tmpStr);
		rpt.GetReportFooter()->SetValue(szName, tmpStr);
		mrs.MoveNext();
	}

	szSysDate = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);


	rpt.PrintPreview();
}

void CPrintForms::PrintStorageMovementOrder(long nOrderID)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CString szSQL, szOrderBy;
	CRecord rs(&pMF->m_db);
	szSQL.Format(
		_T(" SELECT  mt_transaction_id as invoiceid,") \
		_T("	mt_orderno as invoiceno,") \
		_T("  	mt_posteddate as issuedate ,") \
		_T("  	mt_orderdate as invoicedate,") \
		_T(" 	GET_STORAGENAME(mt_storage_id) as storagename,	") \
		_T("  	GET_STORAGENAME(mt_storage_to_id) as storagename_to,") \
		_T("  	GET_PARTNERNAME(mt_partner_id) as partnername,") \
		_T("  	GET_SYSSEL_DESC('pms_export_type', mt_exptype) as exptype,") \
		_T("  	GET_USERNAME(mt_deliveryby) as deliverer,") \
		_T("  	GET_USERNAME(mt_receiveby) as receiver, ") \
		_T("	mt_description as note, ") \
		_T("	mt_status as status, ") \
		_T("	mt_doctype as doctype ") \
		_T(" FROM m_transaction") \
		_T(" WHERE mt_transaction_id=%ld  "), nOrderID);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;

	CReport rpt;
	CString tmpStr, szAmount, szDate, szSysDate, szDocType, szPath, szReportTitle;
	if (pMF->GetModuleID() == _T("PM")
		|| pMF->GetModuleID() == _T("MA")
		|| pMF->GetModuleID() == _T("BB"))
	{
		szReportTitle.Format(_T("PMS_STOCKTRANSFER"));
	}
	else
	{
		szReportTitle.Format(_T("HC_STOCKTRANSFER"));
	}
	szPath.Format(_T("Reports/HMS/%s.RPT"), szReportTitle);
	if (!rpt.Init(szPath))
		return;

	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rs.GetValue(_T("InvoiceNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);

	rs.GetValue(_T("invoicedate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("IssueDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	szSysDate = pMF->GetSysDate();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);
	rs.GetValue(_T("doctype"), szDocType);
	tmpStr.Empty();
	if (szDocType == _T("SMO") || szDocType == _T("SRO"))
		rs.GetValue(_T("storagename_to"), tmpStr);
	else if (szDocType == _T("SPO"))
		rs.GetValue(_T("partnername"), tmpStr);
	else if (szDocType == _T("SOO"))
		rs.GetValue(_T("exptype"), tmpStr);
	rs.GetValue(_T("storagename"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName"), tmpStr);
	rs.GetValue(_T("storagename_to"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName1"), tmpStr);
	rs.GetValue(_T("note"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Comment"), tmpStr);
	CString szDeliver, szReceiver;
	rs.GetValue(_T("deliverer"), tmpStr);
	szDeliver = tmpStr;
	rpt.GetReportHeader()->SetValue(_T("deliverer"), tmpStr);
	rs.GetValue(_T("receiver"), tmpStr);
	szReceiver = tmpStr;
	rpt.GetReportHeader()->SetValue(_T("receiver"), tmpStr);

	tmpStr.Empty();
	//pMF->GetStatusString(rs.GetValue(_T("status")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);

	//Page Header
	//Report Detail

	int nCount = 0;
	double dMoney = 0;
	double nTotalAmount = 0;
	CString szMoney, szExprDate;
	szSQL.Format(_T(" SELECT product_uomindex,") \
		_T("   product_id                          AS id,") \
		_T("   product_name                        AS name,") \
		_T("   product_uomname                     AS unit,") \
		_T("   product_expdate                     AS expdate,") \
		_T("   product_lotno                       AS lotno,") \
		_T("   Sum(mtl_qtyorder)                   AS qty,") \
		_T("   product_taxprice                   AS price,") \
		_T("   Sum(mtl_qtyorder*product_taxprice) AS amount") \
		_T(" FROM   m_transactionline") \
		_T(" LEFT JOIN m_productitem_view ON(mtl_product_item_id=product_item_id)") \
		_T(" WHERE mtl_transaction_id = %ld") \
		_T(" GROUP BY product_uomindex, product_id, product_uomname, product_name, product_expdate, product_lotno, product_taxprice") \
		_T(" ORDER BY product_uomindex,") \
		_T("		   product_uomname,") \
		_T("           product_name"), nOrderID);

	rs.ExecSQL(szSQL);
	CReportSection* rptDetail = rpt.GetDetail(0);
	while (!rs.IsEOF()) {
		rptDetail = rpt.AddDetail();
		rs.GetValue(_T("expdate"), tmpStr);
		szExprDate = CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy);

		dMoney = ToDouble(rs.GetValue(_T("amount")));
		nTotalAmount += dMoney;
		szMoney.Format(_T("%.2f"), dMoney);
		nCount++;
		tmpStr.Format(_T("%d"), nCount);
		rptDetail->SetValue(_T("1"), tmpStr);
		rs.GetValue(_T("name"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rs.GetValue(_T("id"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rs.GetValue(_T("unit"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);

		rptDetail->SetValue(_T("5"), szExprDate);
		rs.GetValue(_T("lotno"), tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		FormatCurrencyStr(rs.GetValue(_T("qty")), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		FormatCurrencyStr(rs.GetValue(_T("price")), tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		//thanhtien
		FormatCurrencyStr(rs.GetValue(_T("amount")), tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);
		rs.MoveNext();
	}
	//Page Footer

	//Report Footer
	tmpStr.Format(_T("%d"), nCount);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(nTotalAmount, szAmount);
	rpt.GetReportFooter()->SetValue(_T("SubTotal"), szAmount);
	szAmount.Format(_T("%.2f"), nTotalAmount);
	MoneyToString(szAmount, tmpStr);
#ifdef UNICODE
	tmpStr += _T(" \x111\x1ED3ng.");
#endif
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);

	rs.GetValue(_T("deliverer"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("deliverer1"), szDeliver);
	rs.GetValue(_T("receiver"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("receiver1"), szReceiver);
	rpt.GetReportFooter()->SetValue(_T("userid"), GetDoctorName(pMF->GetCurrentUser()));
	rpt.PrintPreview();
}

void CPrintForms::PrintStorageExportOrder(long nOrderID)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CString szSQL, szOrderBy, szStorageCategory;
	CRecord rs(&pMF->m_db);
	CRecord rst(&pMF->m_db), trs(&pMF->m_db);

	szSQL.Format(
		_T(" SELECT  mt_transaction_id as invoiceid,") \
		_T("	mt_orderno as invoiceno,") \
		_T("  	mt_posteddate as issuedate ,") \
		_T("  	mt_orderdate as invoicedate,") \
		_T(" 	GET_STORAGENAME(mt_storage_id) as storagename,	") \
		_T("  	GET_STORAGENAME(mt_storage_to_id) as storagename_to,") \
		_T("  	GET_DEPARTMENTNAME(mt_department_id) as department,") \
		_T("  	GET_DEPARTMENTNAME(mt_department_to_id) as department_to,") \
		_T("  	GET_SYSSEL_DESC('pms_export_type', mt_exptype) as exptype,") \
		_T("  	GET_USERNAME(mt_deliveryby) as deliverer,") \
		_T("  	GET_USERNAME(mt_receiveby) as receiver, ") \
		_T("	mt_description as note, ") \
		_T("	mt_status as status, ") \
		_T("	mt_doctype as doctype, ") \
		_T("	(select msl_category from m_storagelist where msl_storage_id = mt_storage_id) storage_category,") \
		_T("	mt_documentno documentno") \
		_T(" FROM m_transaction") \
		_T(" WHERE mt_transaction_id=%ld  "), nOrderID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;

	CReport rpt;
	CString tmpStr, szAmount;
	CString szDate, szSysDate;
	CString szDocType;
	CString szReportTitle, szPath;

	if (pMF->GetModuleID() == _T("PM") || pMF->GetModuleID() == _T("BB"))
	{
		szReportTitle.Format(_T("PMS_STORAGEEXPORT"));
	}
	else
	{
		szReportTitle.Format(_T("%s_STORAGEEXPORT"), pMF->GetModuleID());
	}
	szPath.Format(_T("Reports/HMS/%s.RPT"), szReportTitle);
	if (!rpt.Init(szPath))
		return;
	//_msg(_T("SE"));
	rs.GetValue(_T("storage_category"), szStorageCategory);
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rs.GetValue(_T("InvoiceNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);

	rs.GetValue(_T("invoicedate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("IssueDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	szSysDate = pMF->GetSysDate();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);
	rs.GetValue(_T("doctype"), szDocType);
	tmpStr.Empty();

	rs.GetValue(_T("storagename"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName"), tmpStr);
	rs.GetValue(_T("storagename_to"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName1"), tmpStr);

	rs.GetValue(_T("Department"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
	rs.GetValue(_T("Department_to"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department1"), tmpStr);

	rs.GetValue(_T("note"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Comment"), tmpStr);
	rs.GetValue(_T("deliverer"), tmpStr);
	CString szDeliverry, szReceiver;
	szDeliverry = tmpStr;
	rpt.GetReportHeader()->SetValue(_T("deliverer"), tmpStr);
	rs.GetValue(_T("receiver"), tmpStr);
	szReceiver = tmpStr;
	rpt.GetReportHeader()->SetValue(_T("receiver"), tmpStr);

	tmpStr.Empty();
	//pMF->GetStatusString(rs.GetValue(_T("status")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
	if (pMF->GetModuleID() == _T("MA"))
		rpt.GetReportHeader()->SetValue(_T("ReferenceNo"), rs.GetValue(_T("documentno")));
	//Page Header
	//Report Detail

	int nCount = 0;
	int nQty = 0;
	double dMoney = 0;
	double nTotalAmount = 0;

	CString szMoney, szExprDate;

	if (szDocType == _T("MOV"))
		szMoney.Format(_T("product_taxprice"));
	else
		szMoney.Format(_T("mtl_saleprice"));

	if (pMF->GetModuleID() == _T("MA"))
		szSQL.Format(_T(" SELECT product_uomindex, product_id as id,") \
			_T("		mtl_xproduct_id as xproduct_id, ") \
			_T("        product_name AS name,") \
			_T("        product_uomname AS unit,") \
			_T("        product_expdate AS expdate,") \
			_T("        product_lotno AS lotno,") \
			_T("        SUM(mtl_qtyorder) AS qtyorder,") \
			_T("        SUM(mtl_qtydelivery) AS qtyissue,") \
			_T("        %s AS price,") \
			_T("        SUM(mtl_qtyorder* %s) AS orderamount,") \
			_T("        SUM(mtl_qtydelivery* %s) AS issueamount,") \
			_T("		product_ma_hieu, product_manufacturename ") \
			_T(" FROM m_transactionline") \
			_T(" LEFT JOIN m_productitem_view ON(mtl_product_item_id=product_item_id)") \
			_T(" WHERE mtl_transaction_id=%ld and mtl_qtydelivery > 0 ") \
			_T(" GROUP BY product_uomindex, product_id, mtl_xproduct_id, product_uomname, product_name ,") \
			_T("          product_expdate, product_lotno, product_ma_hieu, product_manufacturename, %s") \
			_T(" ORDER BY product_uomindex, product_uomname, product_name"), szMoney, szMoney, szMoney, nOrderID, szMoney);
	else
		szSQL.Format(_T(" SELECT product_uomindex, product_id as id,") \
			_T("		mtl_xproduct_id as xproduct_id, ") \
			_T("        product_name AS name,") \
			_T("        product_uomname AS unit,") \
			_T("        product_expdate AS expdate,") \
			_T("        product_lotno AS lotno,") \
			_T("        SUM(mtl_qtyorder) AS qtyorder,") \
			_T("        SUM(mtl_qtydelivery) AS qtyissue,") \
			_T("        product_taxprice AS price,") \
			_T("        SUM(mtl_qtyorder*product_taxprice) AS orderamount,") \
			_T("        SUM(mtl_qtydelivery*product_taxprice) AS issueamount") \
			_T(" FROM m_transactionline") \
			_T(" LEFT JOIN m_productitem_view ON(mtl_product_item_id=product_item_id)") \
			_T(" WHERE mtl_transaction_id=%ld and mtl_qtydelivery > 0 ") \
			_T(" GROUP BY product_uomindex, product_id, mtl_xproduct_id, product_uomname, product_name ,") \
			_T("          product_expdate, product_lotno, product_taxprice") \
			_T(" ORDER BY product_uomindex, product_uomname, product_name"), nOrderID);

	rs.ExecSQL(szSQL);
	CReportSection* rptDetail = rpt.GetDetail(0);
	long nProductID, nXProductID;
	CString szName;
	CRecord rsx(&pMF->m_db);
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();

		nCount++;

		tmpStr.Format(_T("%d"), nCount);
		rptDetail->SetValue(_T("1"), tmpStr);
		rs.GetValue(_T("id"), nProductID);
		rs.GetValue(_T("xproduct_id"), nXProductID);
		szName.Empty();
		rs.GetValue(_T("name"), szName);
		if (nProductID != nXProductID)
		{
			CString szName2;
			tmpStr.Format(_T("SELECT mp_name FROM m_Product where mp_product_id = %ld"), nXProductID);
			rsx.ExecSQL(tmpStr);
			rsx.GetValue(_T("mp_name"), szName2);

			szName.AppendFormat(_T(" [%s]"), szName2);
		}

		rptDetail->SetValue(_T("2"), szName);

		rs.GetValue(_T("id"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);

		rs.GetValue(_T("unit"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);

		rs.GetValue(_T("product_ma_hieu"), tmpStr);
		rptDetail->SetValue(_T("4.1"), tmpStr);

		rs.GetValue(_T("product_manufacturename"), tmpStr);
		rptDetail->SetValue(_T("4.2"), tmpStr);

		rs.GetValue(_T("expdate"), tmpStr);
		szExprDate = CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy);
		rptDetail->SetValue(_T("5"), szExprDate);

		rs.GetValue(_T("lotno"), tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);

		rs.GetValue(_T("qtyorder"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);

		rs.GetValue(_T("qtyissue"), tmpStr);
		rptDetail->SetValue(_T("11"), tmpStr);

		rs.GetValue(_T("price"), dMoney);
		FormatCurrency(dMoney, tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);

		rs.GetValue(_T("issueamount"), dMoney);
		nTotalAmount += dMoney;
		FormatCurrency(dMoney, tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);


		rs.MoveNext();
	}
	//Page Footer

	//Report Footer
	tmpStr.Format(_T("%d"), nCount);
	CReportSection* rptFooter = rpt.GetReportFooter();
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(nTotalAmount, szAmount);
	rpt.GetReportFooter()->SetValue(_T("SubTotal"), szAmount);
	szAmount.Format(_T("%.1f"), nTotalAmount);
	MoneyToString(szAmount, tmpStr);
#ifdef UNICODE
	tmpStr += _T(" \x111\x1ED3ng.");
#endif
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);

	GetDoctorName(pMF->GetCurrentUser());
	OnPrintFooterUser(rptFooter, szStorageCategory == _T("S") ? _T("DV") : _T("BH"), _T("'ng_giao', 'ng_nhan'"));

	rs.GetValue(_T("deliverer"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("deliverer1"), szDeliverry);
	rs.GetValue(_T("receiver"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("receiver1"), szReceiver);

	rpt.GetReportFooter()->SetValue(_T("userid"), GetDoctorName(pMF->GetCurrentUser()));


	rpt.PrintPreview();


}

void CPrintForms::PrintStorageExportOrder_v2(long nOrderID) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CString szSQL, szStorageCategory;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptFooter = NULL;
	szSQL.Format(_T("select * from vp_transaction where ma_duy_nhat = %ld "), nOrderID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF()) return;
	CReport rpt;
	CString tmpStr, tmpStr2, szReportTitle, szPath;
	if (pMF->GetModuleID() == _T("PM") || pMF->GetModuleID() == _T("BB"))
	{
		szReportTitle = _T("PMS_STORAGEEXPORT");
	}
	else
	{
		szReportTitle.Format(_T("%s_STORAGEEXPORT"), pMF->GetModuleID());
	}
	szPath.Format(_T("Reports/HMS/%s.RPT"), szReportTitle);
	if (!rpt.Init(szPath))
		return;
	rs.GetValue(_T("kieu_kho"), szStorageCategory);
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	if (rptHeader) PrintDynamicField(rptHeader, &rs);
	rptFooter = rpt.GetReportFooter();
	if (rptFooter) PrintDynamicField(rptFooter, &rs);
	MoneyToString(rs.GetValue(_T("tong_tien")), tmpStr2);
	tmpStr.Format(_T("%s \x111\x1ED3ng."), tmpStr2);
	rptFooter->SetValue(_T("SumInWord"), tmpStr);
	OnPrintFooterUser(rptFooter, szStorageCategory == _T("S") ? _T("DV") : _T("BH"), _T("'ng_giao', 'ng_nhan'"));
	PrintSysDateTime(&rpt);
	//Line view
	szSQL.Format(_T("SELECT * FROM vp_transactionline where ma_lk = %ld"), nOrderID);
	rs.ExecSQL(szSQL);
	PrintDynamicDetail(&rpt, &rs);
	rpt.PrintPreview();
	return;

}

void CPrintForms::PrintDynamicField(CReportSection* pSect, CRecord* pRs) {
	if (!pSect) return;
	CString tmpStr, tmpStr2;
	for (int i = 0; i < pSect->GetItemCount(); i++) {
		tmpStr = pSect->GetItem(i)->GetName();
		pRs->GetValue(tmpStr, tmpStr2);
		if (!tmpStr2.IsEmpty()) pSect->SetValue(tmpStr, tmpStr2);
	}
}

void CPrintForms::PrintDynamicDetail(CReport* pRpt, CRecord* pRs) {
	if (!pRpt) return;
	CString tmpStr, tmpStr2;
	int nCount = 1;
	CReportSection* pDetail = NULL;
	while (!pRs->IsEOF()) {
		pDetail = pRpt->AddDetail();
		pDetail->SetValue(_T("stt"), int2str(nCount++));
		PrintDynamicField(pDetail, pRs);
		pRs->MoveNext();
	}
}

void CPrintForms::PrintSysDateTime(CReport* pRpt) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CString szFieldName = _T("PrintDate");
	CReportItem* newItem = NULL;
	newItem = pRpt->GetReportHeader()->GetItem(szFieldName);
	if (!newItem) newItem = pRpt->GetReportFooter()->GetItem(szFieldName);
	if (!newItem) return;
	CString szSysDate = pMF->GetSysDateTime(), szFieldCap, tmpStr;
	bool bHaveHour = false;
	szFieldCap = newItem->GetText();
	if (szFieldCap.Find(',') != -1) bHaveHour = true;
	if (bHaveHour) tmpStr.Format(szFieldCap, szSysDate.Mid(11, 5), szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	else tmpStr.Format(szFieldCap, szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	newItem->SetText(tmpStr);
}

void CPrintForms::PrintStorageExportOrder2(long nOrderID, bool bPreview, bool bDirect)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CString szSQL, szOrderBy;
	CRecord rs(&pMF->m_db);
	szSQL.Format(_T(" SELECT  mt_transaction_id as invoiceid,") \
		_T("	mt_orderno as invoiceno,") \
		_T("  	mt_posteddate as issuedate ,") \
		_T("  	mt_orderdate as invoicedate,") \
		_T(" 	GET_STORAGENAME(mt_storage_id) as storagename,	") \
		_T("  	GET_STORAGENAME(mt_storage_to_id) as storagename_to,") \
		_T("  	GET_DEPARTMENTNAME(mt_department_id) as department,") \
		_T("  	GET_SYSSEL_DESC('pms_export_type', mt_exptype) as exptype,") \
		_T("  	GET_USERNAME(mt_deliveryby) as deliverer,") \
		_T("  	GET_USERNAME(mt_receiveby) as receiver, ") \
		_T("	mt_description as note, ") \
		_T("	mt_status as status, ") \
		_T("	mt_doctype as doctype, ") \
		_T("	mt_documentno documentno") \
		_T(" FROM m_transaction") \
		_T(" WHERE mt_transaction_id=%ld  "), nOrderID);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;

	CReport rpt;
	CString tmpStr, szAmount;
	CString szDate, szSysDate;
	CString szDocType, szReportTitle, szPath;

	if (pMF->GetModuleID() == _T("PM") || pMF->GetModuleID() == _T("BB"))
	{
		szReportTitle = _T("PMS_STORAGEEXPORT");
	}
	else
	{
		szReportTitle.Format(_T("%s_STORAGEEXPORT"), pMF->GetModuleID());
	}
	szPath.Format(_T("Reports/HMS/%s.RPT"), szReportTitle);
	if (!rpt.Init(szPath))
		return;
	//_msg(_T("SE2"));
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rs.GetValue(_T("InvoiceNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);

	rs.GetValue(_T("invoicedate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("IssueDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	szSysDate = pMF->GetSysDate();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);
	rs.GetValue(_T("doctype"), szDocType);
	tmpStr.Empty();

	rs.GetValue(_T("storagename"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName"), tmpStr);
	rs.GetValue(_T("storagename_to"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName1"), tmpStr);

	rs.GetValue(_T("Department"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

	rs.GetValue(_T("note"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Comment"), tmpStr);
	rs.GetValue(_T("deliverer"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("deliverer"), tmpStr);
	rs.GetValue(_T("receiver"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("receiver"), tmpStr);

	tmpStr.Empty();
	//pMF->GetStatusString(rs.GetValue(_T("status")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
	if (pMF->GetModuleID() == _T("MA"))
		rpt.GetReportHeader()->SetValue(_T("ReferenceNo"), rs.GetValue(_T("documentno")));
	//Page Header
	//Report Detail

	int nCount = 0;
	int nQty = 0;
	double dMoney = 0;
	double nTotalAmount = 0;

	CString szMoney, szExprDate;
	/*
		szSQL.Format(_T(" SELECT product_id AS id,") \
					_T("        product_name AS name,") \
					_T("        product_uomname AS unit,") \
					_T("        product_expdate AS expdate,") \
					_T("        product_lotno AS lotno,") \
					_T("        SUM(pol_qty) AS qtyorder,") \
					_T("        hpol_unitprice AS price,") \
					_T("        SUM(pol_qty*hpol_unitprice) AS amount") \
					_T(" FROM purchase_orderline2") \
					_T(" LEFT JOIN m_productitem_view ON(pol_product_item_id=product_item_id)") \
					_T(" LEFT JOIN hms_ipharmaorderline ON (hpol_orderid = pol_orderid AND hpol_product_id = pol_product_id)") \
					_T(" WHERE pol_transaction_id=%ld") \
					_T(" GROUP BY product_uomindex, product_id, product_name, product_uomname,") \
					_T("          product_expdate, product_lotno,") \
					_T("          hpol_unitprice ORDER BY product_uomindex, product_name, product_uomname"), nOrderID);

	*/
	/*
		szSQL.Format(_T(" SELECT product_id AS id,") \
	_T("   product_name    AS name,") \
	_T("   product_uomname AS unit,") \
	_T("   product_expdate AS expdate,") \
	_T("   product_lotno   AS lotno,") \
	_T("   hpol_unitprice  AS price,") \
	_T("   SUM(pol_qty)    AS qtyorder,") \
	_T("   SUM(ttlamount)  AS amount") \
	_T(" FROM") \
	_T("   ( SELECT product_id,") \
	_T("     product_name ,") \
	_T("     product_uomname ,") \
	_T("     product_uomindex,") \
	_T("     product_expdate ,") \
	_T("     product_lotno ,") \
	_T("     pol_qty,") \
	_T("     hpol_unitprice ,") \
	_T("     (pol_qty*hpol_unitprice) AS ttlamount") \
	_T("   FROM purchase_orderline2") \
	_T("   LEFT JOIN m_productitem_view") \
	_T("   ON(pol_product_item_id=product_item_id)") \
	_T("   LEFT JOIN hms_ipharmaorderline") \
	_T("   ON (hpol_orderid        = pol_orderid") \
	_T("   AND hpol_product_id     = pol_product_id ") \
	_T("   and (hpol_unitprice=pol_unitprice or nvl(pol_unitprice,0)=0) )") \
	_T("   WHERE pol_transaction_id=%ld") \
	_T("   ) tbl") \
	_T(" GROUP BY product_uomindex,") \
	_T("   product_id,") \
	_T("   product_name,") \
	_T("   product_uomname,") \
	_T("   product_expdate,") \
	_T("   product_lotno,") \
	_T("   hpol_unitprice") \
	_T(" ORDER BY product_uomindex,") \
	_T("   product_name,") \
	_T("   product_uomname"), nOrderID);

	*/
	szSQL.Format(_T(" SELECT product_id            AS id,") \
		_T("   product_name               AS name,") \
		_T("   product_uomname            AS unit,") \
		_T("   product_expdate            AS expdate,") \
		_T("   product_lotno              AS lotno,") \
		_T("   pol_unitprice              AS price,") \
		_T("   SUM(pol_qty)               AS qtyorder,") \
		_T("   SUM(pol_unitprice*pol_qty) AS amount") \
		_T(" FROM") \
		_T("   (SELECT pol_product_item_id,") \
		_T("     pol_qty,") \
		_T("     CASE") \
		_T("       WHEN pol_unitprice > 0") \
		_T("       THEN pol_unitprice") \
		_T("       ELSE") \
		_T("         (SELECT DISTINCT hpol_unitprice") \
		_T("         FROM hms_pharmaorderline_view2") \
		_T("         WHERE hpol_docno    = pol_docno") \
		_T("         AND hpol_orderid    = pol_orderid") \
		_T("         AND hpol_product_id = pol_product_id") \
		_T("         AND (hpol_unitprice = pol_unitprice") \
		_T("         OR coalesce(pol_unitprice,0)    =0)") \
		_T("         )") \
		_T("     END AS pol_unitprice") \
		_T("   FROM purchase_orderline2") \
		_T("   WHERE pol_transaction_id=%ld") \
		_T("   )") \
		_T(" LEFT JOIN m_productitem_view") \
		_T(" ON(pol_product_item_id=product_item_id)") \
		_T(" GROUP BY product_uomindex,") \
		_T("   product_id,") \
		_T("   product_name,") \
		_T("   product_uomname,") \
		_T("   product_expdate,") \
		_T("   product_lotno,") \
		_T("   pol_unitprice") \
		_T(" ORDER BY product_uomindex,") \
		_T("   product_name,") \
		_T("   product_uomname"), nOrderID);

	rs.ExecSQL(szSQL);
	CReportSection* rptDetail = rpt.GetDetail(0);
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();

		nCount++;

		tmpStr.Format(_T("%d"), nCount);
		rptDetail->SetValue(_T("1"), tmpStr);

		rs.GetValue(_T("name"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);

		rs.GetValue(_T("id"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);

		rs.GetValue(_T("unit"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);

		rs.GetValue(_T("expdate"), tmpStr);
		szExprDate = CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy);
		rptDetail->SetValue(_T("5"), szExprDate);

		rs.GetValue(_T("lotno"), tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);

		rs.GetValue(_T("qtyorder"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);

		//		rs.GetValue(_T("qtyissue"), tmpStr);
		rptDetail->SetValue(_T("11"), tmpStr);

		rs.GetValue(_T("price"), dMoney);
		FormatCurrency(dMoney, tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);

		rs.GetValue(_T("amount"), dMoney);
		nTotalAmount += dMoney;
		FormatCurrency(dMoney, tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);


		rs.MoveNext();
	}
	//Page Footer

	//Report Footer
	tmpStr.Format(_T("%d"), nCount);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(nTotalAmount, szAmount);
	rpt.GetReportFooter()->SetValue(_T("SubTotal"), szAmount);
	szAmount.Format(_T("%.2f"), nTotalAmount);
	MoneyToString(szAmount, tmpStr);
#ifdef UNICODE
	tmpStr += _T(" \x111\x1ED3ng.");
#endif
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);

	GetDoctorName(pMF->GetCurrentUser());

	//rpt.PrintPreview();
	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(bDirect);

}


/*
void CPrintForms::PrintDeliveryOrder(long nOrderID)
{
	CGuiMainFrame *pMF = (CGuiMainFrame *) AfxGetMainWnd();
	CString szSQL, szWhere, szOrderBy;

	//if(pMF->m_szDrugOrderByName == _T("Y")){
	//	szOrderBy.Format(_T(" ORDER BY p_name, p_unit, pi_insprice "));
	//}
	//else
	//	szOrderBy.Format(_T(" ORDER BY pmssel_index "));

	CRecord rs(&pMF->m_db);
	//if(!bOpenStatus){
	//	szWhere.Format(_T(" AND pmsse_status <>'O' "));
	//}
	szSQL.Format(_T("  SELECT mt_orderno as invoiceno,") \
	_T("  	mt_orderdate as orderdate,") \
	_T("  	get_syssel_desc('pms_order_status', mt_status) as status,") \
	_T("  	mt_deliveryby as deliverby,") \
	_T("  	mt_receiveby as receiveby,") \
	_T(" 	get_doctype(mt_doctype) as type,") \
	_T(" 	get_storagename(mt_storage_id) as stockname,	") \
	_T("	mt_description as note ") \
	_T("  FROM m_transaction") \
	_T("  WHERE mt_transaction_id= %d %s "), nOrderID, szWhere);
	//_fmsg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	if(rs.IsEOF())
		return;

	CReport rpt;
	CString tmpStr, szNameReport;
	rs.GetValue(_T("type"), tmpStr);
	if (tmpStr!=_T("W"))
		szNameReport.Format(_T("%s"), _T("Reports/HMS/PM_PHIEUXUATKHO.RPT") );
	else
		szNameReport.Format(_T("%s"), _T("Reports/HMS/PMS_WAREHOUSERECEIPT.RPT"));

	if(!rpt.Init(szNameReport) )
		return;
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);

	rs.GetValue(_T("InvoiceNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);
	rs.GetValue(_T("orderdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("OrderDate"), CDate::Convert(rs.GetValue(_T("orderdate")), yyyymmdd, ddmmyyyy));
	CString szDate, szSysDate;
	szSysDate = pMF->GetSysDate();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")),szSysDate.Right(2),szSysDate.Mid(5,2),szSysDate.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);
	rs.GetValue(_T("Status"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
	rs.GetValue(_T("StockName"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName"), tmpStr);
	rs.GetValue(_T("note"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Comment"), tmpStr);
	rs.GetValue(_T("type"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Reason"), tmpStr);
	rs.GetValue(_T("deliverby"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DeliverBy"), tmpStr);
	rs.GetValue(_T("ReceiveBy"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ReceiveBy"), tmpStr);
	//Page Header
	//Report Detail

	int nCount = 0;
	double dMoney = 0;
	double nTotalAmount = 0;
	CString szMoney, szExprDate;
	szSQL.Format(_T("SELECT mp_product_id as pid, mp_name as pnme, get_uomname(mp_uom_id) as uom,") \
		_T(" mpi_lotno as lot, mpi_expdate as expdte, sum(mtl_qtyorder) as qtyord, mpi_unitprice as untprc ") \
		_T(" FROM m_product ") \
		_T(" LEFT JOIN m_product_item ON(mpi_product_id=mp_product_id) ") \
		_T(" LEFT JOIN m_transactionline ON(mpi_product_item_id=mtl_product_item_id) ") \
		_T(" WHERE mtl_transaction_id=%d GROUP BY mp_product_id, mp_name, mp_uom_id, mpi_lotno, mpi_expdate, mpi_unitprice %s "), nOrderID, szOrderBy);
	rs.ExecSQL(szSQL);

	CReportSection* rptDetail = rpt.GetDetail(0);
	while(!rs.IsEOF()){
		rptDetail = rpt.AddDetail();
		rs.GetValue(_T("expdte"), tmpStr);
		szExprDate = CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy);
		dMoney = ToDouble(rs.GetValue(_T("qtyord")))*ToDouble(rs.GetValue(_T("untprc")));
		nTotalAmount += dMoney;
		szMoney.Format(_T("%.2f"), dMoney);
		nCount++;
		tmpStr.Format(_T("%d"), nCount);
		rptDetail->SetValue(_T("1"), tmpStr);
		rs.GetValue(_T("pnme"), tmpStr) ;
		rptDetail->SetValue(_T("2"), tmpStr);
		rs.GetValue(_T("uom"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rs.GetValue(_T("lot"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rptDetail->SetValue(_T("5"), szExprDate);
		FormatCurrencyStr(rs.GetValue(_T("qtyord")), tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		FormatCurrencyStr(rs.GetValue(_T("untprc")), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		FormatCurrencyStr(szMoney, tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		rs.MoveNext();
	}
	//Page Footer
	//Report Footer
	tmpStr.Format(_T("%d"), nCount);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(nTotalAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	szMoney.Format(_T("%.2f"), nTotalAmount);
	MoneyToString(szMoney, tmpStr);
#ifdef UNICODE
	if(!tmpStr.IsEmpty())
		tmpStr += _T(" \x111\x1ED3ng");
#else
	if(!tmpStr.IsEmpty())
		tmpStr += _T(" ®ång");
#endif
	CString szDte;
	szDte = pMF->GetSysDate();
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("ReportDate")), szDte.Right(2), szDte.Mid(5, 2), szDte.Left(4));
	rpt.GetReportFooter()->SetValue(_T("ReportDate"), tmpStr);
	rpt.PrintPreview();	// TODO: Add your command handler code here

}


*/

void CPrintForms::PrintDDO(long nOrderID)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CString tmpStr, tmpStr2, szDate, szSQL, szDesc, szOrderBy;
	CString szFloor;

	double	nTotalAmount = 0, nAmount = 0;
	int		nQty, nTotalItem = 1;
	int		nPrint = 0;
	bool bDirect = false;

	//if(m_szDrugOrderByName == _T("Y")){
	//	szOrderBy.Format(_T(" ORDER BY name, unit, price "));
	//}
	//else
	//	szOrderBy.Format(_T(" ORDER BY pmssel_index "));
	szOrderBy.Format(_T(" ORDER BY name, unit, price "));

	szSQL.Format(_T(" SELECT mt_orderno as ordno,") \
		_T("   mt_doctype          AS doctype,") \
		_T("   mt_deliveryby       AS deliveryby,") \
		_T("   mt_description      AS descr,") \
		_T("   mt_orderdate        AS orddte,") \
		_T("   mt_status           AS stt,") \
		_T("   get_storagename(mt_storage_id)       AS stock,") \
		_T("   get_storagename(mt_storage_to_id)    AS stock_to,") \
		_T("   get_departmentname(mt_department_to_id) AS dept_to") \
		_T(" FROM   m_transaction") \
		_T(" WHERE mt_transaction_id = %ld"), nOrderID);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	CString szType, szReportName, szSendBy;
	rs.GetValue(_T("doctype"), szType);
	if (szType == _T("B"))
	{
		szOrderBy.Format(_T(" ORDER BY name, unit, price "));
		szReportName = _T("Reports/HMS/PMS_DRUGORDER2.RPT");
	}
	else
		szReportName = _T("Reports/HMS/PMS_DRUGORDER2.RPT");
	rs.GetValue(_T("deliveryby"), szSendBy);
	rs.GetValue(_T("descr"), szDesc);


	rs.GetValue(_T("pmsse_floor"), szFloor);
	//szFloor = GetSelectionString(_T("hms_floor"), tmpStr);


	if (szType == _T("DDO") || szType == _T("DPO") || szType == _T("C") || szType == _T("DMO"))
	{
		CRecord rst(&pMF->m_db);
		CRecord rsp(&pMF->m_db);
		CString szGroup, szTitle, szPrintType, szNote;
		szSQL.Format(_T("SELECT * FROM pms_drugtype2 ORDER BY pmdt_id"));
		rst.ExecSQL(szSQL);
		while (!rst.IsEOF())
		{
			//_debug(_T("nOrderID:%ld : szGroup:%s"), nOrderID, szGroup);
			rst.GetValue(_T("pmdt_name"), tmpStr);
			StringUpper(tmpStr, szTitle);
			rst.GetValue(_T("pmdt_desc"), szGroup);
			szGroup.Trim();
			rst.GetValue(_T("pmdt_printtype"), szPrintType);

			if (szPrintType == _T("2"))
			{
				rst.GetValue(_T("pmdt_reportname"), tmpStr);
				if (tmpStr.IsEmpty())
					szReportName = _T("Reports/HMS/PMS_DRUGORDER2.RPT");
				else
					szReportName.Format(_T("Reports/HMS/%s"), tmpStr);
				_debug(_T("%s"), szReportName);
				if (!rpt.Init(szReportName))
					return;

				//Report Header
				rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
				rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
				rpt.GetReportHeader()->Format(_T("TITLE"), szTitle);
				rs.GetValue(_T("orddte"), tmpStr);
				szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
				rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);
				rpt.GetReportHeader()->SetValue(_T("OrderID"), rs.GetValue(_T("ordno")));
				rs.GetValue(_T("stt"), tmpStr);
				//tmpStr = GetStatusString(tmpStr);
				rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
				rs.GetValue(_T("stock"), tmpStr);
				//tmpStr = GetStockName(ToInt(tmpStr));
				rpt.GetReportHeader()->SetValue(_T("FromStock"), tmpStr);
				rpt.GetReportHeader()->SetValue(_T("FromStock2"), tmpStr);

				rpt.GetReportHeader()->SetValue(_T("Comment"), szDesc);
				rpt.GetReportHeader()->SetValue(_T("Comment2"), szDesc);


				//rs.GetValue(_T("stock_to"), tmpStr);
				//if(!tmpStr.IsEmpty())
				//{
				//	//tmpStr = GetStockName(ToInt(tmpStr));
				//	rpt.GetReportHeader()->SetValue(_T("ToStock"), tmpStr);
				//	rpt.GetReportHeader()->SetValue(_T("ToStock2"), tmpStr);
				//}

				if (!tmpStr.IsEmpty())
				{
					tmpStr = rs.GetValue(_T("dept_to"));
					rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
					rpt.GetReportHeader()->SetValue(_T("Department2"), tmpStr);
				}
				tmpStr.Empty();
				rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

				rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE2"), pMF->m_szHealthService);
				rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME2"), pMF->m_szHospitalName);
				rpt.GetReportHeader()->Format(_T("TITLE2"), szTitle);
				rs.GetValue(_T("orddte"), tmpStr);
				szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
				rpt.GetReportHeader()->SetValue(_T("OrderDate2"), szDate);
				rpt.GetReportHeader()->SetValue(_T("OrderID2"), rs.GetValue(_T("ordno")));
				rpt.GetReportHeader()->SetValue(_T("Sheet2"), _T("2"));

				rpt.GetReportHeader()->SetValue(_T("Floor"), szFloor);
				rpt.GetReportHeader()->SetValue(_T("Floor2"), szFloor);

			}
			else
			{
				if (!rpt.Init(szReportName))
					return;



				//Report Header
				rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
				rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
				rpt.GetReportHeader()->Format(_T("TITLE"), szTitle);
				rs.GetValue(_T("mt_orderdate"), tmpStr);
				szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
				rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);
				rpt.GetReportHeader()->SetValue(_T("OrderID"), rs.GetValue(_T("ordno")));
				rs.GetValue(_T("mt_expstockid"), tmpStr);
				//rpt.GetReportHeader()->SetValue(_T("FromStock"), GetStockName(ToInt(tmpStr)));
				rs.GetValue(_T("mt_impstockid"), tmpStr);
				if (!tmpStr.IsEmpty())
					//rpt.GetReportHeader()->SetValue(_T("ToStock"), GetStockName(ToInt(tmpStr)));

					rs.GetValue(_T("mt_deptid"), tmpStr);
				if (!tmpStr.IsEmpty())
					//rpt.GetReportHeader()->SetValue(_T("Department"), GetDepartmentName(tmpStr));
					tmpStr.Empty();
				rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));


				rpt.GetReportHeader()->SetValue(_T("Floor"), szFloor);

			}


			//Page Header
			//Report Detail

			szSQL.Format(_T(" SELECT") \
				_T("   product_id                                  AS id,") \
				_T("   product_name                                        AS name,") \
				_T("   product_uomname                         AS unit,") \
				_T("   Sum(mtl_qtyorder)                              AS qty,") \
				_T("   product_taxprice                                  AS price,") \
				_T("   Sum(mtl_qtyorder*product_taxprice)                AS amount,") \
				_T("   product_manufacturename AS prod_country") \
				_T(" FROM   m_transactionline") \
				_T("        LEFT JOIN m_productitem_view ON(product_item_id=mtl_product_item_id)") \
				_T(" WHERE mtl_transaction_id = %d") \
				_T(" AND product_producttype IN (%s)") \
				_T(" GROUP  BY product_id,") \
				_T("           product_name,") \
				_T("           product_uomname,") \
				_T("           product_taxprice,") \
				_T("           product_manufacturename %s"), nOrderID, szGroup, szOrderBy);
			//_msg(_T("%s"), szSQL);
			rs2.ExecSQL(szSQL);
			if (rs2.IsEOF()) {
				rst.MoveNext();
				continue;
			}
			CReportSection* rptDetail = rpt.GetDetail(0);
			rpt.ResetContent();
			nTotalItem = 1;
			nTotalAmount = 0;
			CString szItemId;
			while (!rs2.IsEOF())
			{
				rptDetail = rpt.AddDetail();
				rs2.GetValue(_T("id"), szItemId);
				if (szPrintType == _T("2"))
				{
					tmpStr.Format(_T("%d"), nTotalItem++);
					rptDetail->SetValue(_T("1"), tmpStr);
					rptDetail->SetValue(_T("12"), tmpStr);
					rs2.GetValue(_T("name"), tmpStr);
					rptDetail->SetValue(_T("2"), tmpStr);
					rptDetail->SetValue(_T("22"), tmpStr);
					rs2.GetValue(_T("unit"), tmpStr);
					rptDetail->SetValue(_T("3"), tmpStr);
					rptDetail->SetValue(_T("32"), tmpStr);
					rs2.GetValue(_T("qty"), nQty);
					if (szGroup == _T("'A1130'") || szGroup == _T("'A1140'") || szGroup == _T("'A2000'"))
						MoneyToString(ToString(nQty), szNote);
					else
						szNote.Empty();
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4"), tmpStr2);
					rptDetail->SetValue(_T("42"), tmpStr2);
					rs2.GetValue(_T("Price"), tmpStr);
					FormatCurrencyStr(tmpStr, tmpStr2);
					rptDetail->SetValue(_T("5"), tmpStr2);
					rptDetail->SetValue(_T("52"), tmpStr2);
					rs2.GetValue(_T("amount"), nAmount);
					nTotalAmount += nAmount;

					rptDetail->SetValue(_T("6"), szNote);
					rptDetail->SetValue(_T("62"), szNote);
				}
				else
				{
					tmpStr.Format(_T("%d"), nTotalItem++);
					rptDetail->SetValue(_T("1"), tmpStr);
					rs2.GetValue(_T("name"), tmpStr);
					rptDetail->SetValue(_T("2"), tmpStr);
					rs2.GetValue(_T("unit"), tmpStr);

					rptDetail->SetValue(_T("3"), tmpStr);
					rs2.GetValue(_T("qty"), nQty);
					if (szGroup == _T("'A1130'") || szGroup == _T("'A1140'") || szGroup == _T("'A2000'"))
						MoneyToString(ToString(nQty), szNote);
					else
						szNote.Empty();
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4"), tmpStr2);
					rs2.GetValue(_T("Price"), tmpStr);
					FormatCurrencyStr(tmpStr, tmpStr2);
					rptDetail->SetValue(_T("5"), tmpStr2);
					rs2.GetValue(_T("amount"), nAmount);
					nTotalAmount += nAmount;
					rptDetail->SetValue(_T("6"), szNote);
				}

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 || szGroup.Find(_T("'A2000'")) != -1)
				{
					//Ne du tru thuoc(phieu linh)
					if (szType == _T("DDO") || szType == _T("DPO") || szType == _T("DMO"))
					{
						szSQL.Format(_T(" SELECT") \
							_T("   hpo_docno            AS docno,") \
							_T("   Trim(hp_surname||' '||hp_midname||' '||hp_firstname) AS pname,") \
							_T("   Sum(hpol_qtyorder)   AS orderqty") \
							_T(" FROM   hms_ipharmaorder") \
							_T("        LEFT JOIN hms_ipharmaorderline ON(hpo_orderid=hpol_orderid)") \
							_T("        LEFT JOIN hms_patient ON(hp_patientno=hpo_patientno)") \
							_T(" WHERE  hpo_transaction_id=%d") \
							_T("        AND hpol_product_id='%s'") \
							_T(" GROUP  BY hpo_docno,") \
							_T("           hp_surname,") \
							_T("           hp_midname,") \
							_T("           hp_firstname") \
							_T(" ORDER  BY pname"), nOrderID, szItemId);
						//_msg(_T("%s"), szSQL);
					}
					else	//Neu bo sung tu truc
					{
						szSQL.Format(_T(" SELECT 	hmc_docno as docno,") \
							_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
							_T(" 	hmc_qty as orderqty") \
							_T(" FROM hms_medicalcabinet_issue") \
							_T(" LEFT JOIN hms_doc ON(hd_docno=hmc_docno)") \
							_T(" LEFT JOIN hms_patient ON(hp_patientno=hd_patientno)") \
							_T(" WHERE hmc_supplementid=%d ") \
							_T(" and hmc_itemid='%s' ORDER BY docno,pname "), nOrderID, szItemId);

					}
					rsp.ExecSQL(szSQL);
					while (!rsp.IsEOF()) {
						rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
						/*
												rptDetail->GetItem(_T("1"))->SetItalic(true);
												rptDetail->GetItem(_T("2"))->SetItalic(true);
												rptDetail->GetItem(_T("3"))->SetItalic(true);
												rptDetail->GetItem(_T("4"))->SetItalic(true);
												rptDetail->GetItem(_T("5"))->SetItalic(true);
												rptDetail->GetItem(_T("6"))->SetItalic(true);
						*/
						rptDetail->SetValue(_T("1"), _T(""));
						rsp.GetValue(_T("pname"), tmpStr);
						rptDetail->SetValue(_T("2"), tmpStr);
						rsp.GetValue(_T("docno"), tmpStr);
						rptDetail->SetValue(_T("3"), tmpStr);
						rsp.GetValue(_T("orderqty"), nQty);
						FormatCurrency(nQty, tmpStr);
						rptDetail->SetValue(_T("4"), tmpStr);
						rptDetail->SetValue(_T("5"), _T(""));
						MoneyToString(ToString(nQty), szNote);
						rptDetail->SetValue(_T("6"), szNote);
						if (szPrintType == _T("2")) {
							/*
														rptDetail->GetItem(_T("12"))->SetItalic(true);
														rptDetail->GetItem(_T("22"))->SetItalic(true);
														rptDetail->GetItem(_T("32"))->SetItalic(true);
														rptDetail->GetItem(_T("42"))->SetItalic(true);
														rptDetail->GetItem(_T("52"))->SetItalic(true);
														rptDetail->GetItem(_T("62"))->SetItalic(true);
							  */
							rptDetail->SetValue(_T("12"), _T(""));
							rsp.GetValue(_T("pname"), tmpStr);
							rptDetail->SetValue(_T("22"), tmpStr);
							rsp.GetValue(_T("docno"), tmpStr);
							rptDetail->SetValue(_T("32"), tmpStr);
							rsp.GetValue(_T("orderqty"), nQty);
							FormatCurrency(nQty, tmpStr);
							rptDetail->SetValue(_T("42"), tmpStr);
							rptDetail->SetValue(_T("52"), _T(""));
							MoneyToString(ToString(nQty), szNote);
							rptDetail->SetValue(_T("62"), szNote);
						}
						rsp.MoveNext();
					}
				}
				rs2.MoveNext();
			}
			//Page Footer
			//Report Footer
			if (szPrintType == _T("2"))
			{
				tmpStr.Format(_T("%d"), nTotalItem - 1);
				rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
				rpt.GetReportFooter()->SetValue(_T("TotalItem2"), tmpStr);
				tmpStr.Format(_T("%.0f"), nTotalAmount);
				FormatCurrencyStr(tmpStr, tmpStr2);
				rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr2);
				rpt.GetReportFooter()->SetValue(_T("TotalAmount2"), tmpStr2);
				CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
				if (img)
				{
					//					img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
					img->SetFixedHeight(false);
				}

				//				rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

				CReportItem* img2 = rpt.GetReportFooter()->GetItem(_T("Signature2"));
				if (img2)
				{
					//					img2->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
					img2->SetFixedHeight(false);
				}

				//				rpt.GetReportFooter()->SetValue(_T("DoctorName2"), GetDoctorName(szSendBy));


				tmpStr = pMF->GetSysDate();
				szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
				rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
				rpt.GetReportFooter()->SetValue(_T("PrintDate2"), szDate);
				//	rpt.Print(bDirect);
				//	bDirect=true;
					//rpt.PrintPreview();
			}
			else
			{
				tmpStr.Format(_T("%d"), nTotalItem - 1);
				rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
				tmpStr.Format(_T("%.0f"), nTotalAmount);
				FormatCurrencyStr(tmpStr, tmpStr2);
				rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr2);
				CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
				if (img)
				{
					//					img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
					img->SetFixedHeight(false);
				}
				//				rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

				tmpStr = pMF->GetSysDate();
				szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
				rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
				rpt.PrintPreview();
				//	bDirect=true;
				//	rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("2"));
				//	rpt.Print(bDirect);
			}
			//rpt.PrintPreview();
			rst.MoveNext();
		}
	}
	else
	{
		if (!rpt.Init(szReportName))
			return;
		//Report Header
		rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
		rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
		rs.GetValue(_T("pmsse_orderdate"), tmpStr);
		szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);
		rpt.GetReportHeader()->SetValue(_T("OrderID"), rs.GetValue(_T("ordno")));
		rs.GetValue(_T("pmsse_expstockid"), tmpStr);
		//		rpt.GetReportHeader()->SetValue(_T("FromStock"), GetStockName(ToInt(tmpStr)));
		rs.GetValue(_T("pmsse_impstockid"), tmpStr);
		if (!tmpStr.IsEmpty())
			//			rpt.GetReportHeader()->SetValue(_T("ToStock"), GetStockName(ToInt(tmpStr)));

			rs.GetValue(_T("pmsse_deptid"), tmpStr);
		if (!tmpStr.IsEmpty())
			//			rpt.GetReportHeader()->SetValue(_T("Department"), GetDepartmentName(tmpStr));
			tmpStr.Empty();
		rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

		rs.GetValue(_T("pmsse_deptid"), tmpStr);
		if (!tmpStr.IsEmpty())
			//			rpt.GetReportHeader()->SetValue(_T("Department"), GetDepartmentName(tmpStr));

			rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

		rpt.GetReportHeader()->SetValue(_T("Floor"), szFloor);
		rpt.GetReportHeader()->SetValue(_T("Floor2"), szFloor);


		//Page Header
		//Report Detail
		szSQL.Format(_T(" SELECT ") \
			_T(" 	pmi_id as id,") \
			_T(" 	pmi_name as name,") \
			_T(" 	pmi_unit	as unit,") \
			_T("	sum(pmssel_qty) as qty, ") \
			_T(" 	pmsi_vatprice as price,") \
			_T(" 	sum(pmssel_qty*pmsi_vatprice) as amount, ") \
			_T(" 	(SELECT sc_name FROM sys_country WHERE sc_id=pmsi_countryid) as prod_country") \
			_T(" FROM pms_stockexport_line") \
			_T(" LEFT JOIN pms_stockitems ON(pmsi_id=pmssel_sitemid)") \
			_T(" LEFT JOIN pms_items ON(pmi_id=pmsi_itemid)") \
			_T(" WHERE pmssel_id=%d ") \
			_T(" GROUP BY pmi_id, pmi_name, pmi_unit, pmsi_vatprice, pmsi_countryid %s "), nOrderID, szOrderBy);

		rs2.ExecSQL(szSQL);

		CReportSection* rptDetail = rpt.GetDetail(0);
		while (!rs2.IsEOF())
		{
			rptDetail = rpt.AddDetail();
			tmpStr.Format(_T("%d"), nTotalItem++);
			rptDetail->SetValue(_T("1"), tmpStr);
			rs2.GetValue(_T("name"), tmpStr);
			rptDetail->SetValue(_T("2"), tmpStr);
			rs2.GetValue(_T("unit"), tmpStr);

			rptDetail->SetValue(_T("3"), tmpStr);
			rs2.GetValue(_T("qty"), nQty);
			FormatCurrency(nQty, tmpStr2);
			rptDetail->SetValue(_T("4"), tmpStr2);
			rs2.GetValue(_T("Price"), tmpStr);
			FormatCurrencyStr(tmpStr, tmpStr2);
			rptDetail->SetValue(_T("5"), tmpStr2);
			rs2.GetValue(_T("amount"), nAmount);
			nTotalAmount += nAmount;
			tmpStr.Empty();
			rptDetail->SetValue(_T("6"), tmpStr);
			rs2.MoveNext();
		}
		//Page Footer
		//Report Footer
		tmpStr.Format(_T("%d"), nTotalItem - 1);
		rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
		tmpStr.Format(_T("%.0f"), nTotalAmount);
		FormatCurrencyStr(tmpStr, tmpStr2);
		rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr2);

		tmpStr = pMF->GetSysDate();
		szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);


		CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
		if (img)
		{
			//			img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
			img->SetFixedHeight(false);
		}
		//		rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

		/*
				CReportItem *img = rpt.GetReportFooter()->GetItem(_T("Signature"));
				if(img)
				{
					img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
					img->SetFixedHeight(false);
				}
		*/
		rpt.PrintPreview();
		//rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("2"));
		//rpt.Print(bDirect);

	}

}

void CPrintForms::PrintDDO2(long nOID, bool bPreviewOnly)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();//mainFramePointer//pGuiMnFrm//UDT:MF=MainFrame, rs=RecordSet, p=Pointer, tmp=temp 
	CReport rpt;

	CRecord rsReport(&pMF->m_db);//tmpRecord//tmpRec
	CRecord rs(&pMF->m_db);//transactionRecord//transactionRecd//trsactionRecord//tstRcd
	CRecord rs2(&pMF->m_db);//itemRecord
	CRecord rst(&pMF->m_db);//typeSortRecord
	CRecord rsp(&pMF->m_db);//qtyPsychoRecord
	CString szGroup, szTitle, szNote;
	CString tmpStr, tmpStr2, szDate, szSQL, szDesc, szOrderBy, szStorageCategory, szOrderType;//orderTypeStr, storageCategoryStr(storgCatgryStr, stoCat),
	//orderByStr, tmpStr2, tmpStr, sqlStr
	int nStorage_id = 0, nBreak = 0;//int storageIndex = 0;
	CString szID, szBarCodeID;
	long nProductID = 0, nProductItemID = 0;//productIndex, productItemIndex

	szID.Format(_T("%ld"), nOID);

	double	nTotalAmount = 0, nAmount = 0, nAmountServ = 0, nTotalAmountServ = 0;//amountTotal, amountServiceTotal//amntServcTotal//amntServTotal//amountServiceTotl
	double nQty;
	int	 nTotalItem = 1;//itemCount 
	//int		nPrint=0;
	//bool bDirect = false;

	szOrderBy.Format(_T(" ORDER BY name, unit, price "));
	szSQL.Format(_T(" SELECT distinct mt_orderno, ") \
		_T("        mt_orderdate, ") \
		_T("        mt_approveddate, ") \
		_T("        mt_postedby, ") \
		_T("        mt_storage_id, ") \
		_T("        Get_storagename(mt_storage_id)          AS mt_storage_name, ") \
		_T("        Get_storagename(mt_storage_to_id)       AS mt_storageto_name, ") \
		_T("        Get_departmentname(mt_department_id)    AS mt_department_name, ") \
		_T("        Get_departmentname(mt_department_to_id) AS mt_departmentto_name, ") \
		_T("        mt_doctype, ") \
		_T("        mt_description, ") \
		_T("		mt_objecttype, ")
		_T("		hpo_ordertype, mt_documentno, mtb_ordertype,  ") \
		_T("		mt_status as status, ") \
		_T("		get_syssel_desc('HMS_TREAT_ZONE', mt_zone) as zone,") \
		_T("		(select count(*) from hms_ipharmaorder ") \
		_T("		where hpo_transaction_id = mt_transaction_id and hpo_orderstatus not in ('O', 'C')) ") \
		_T("		as so_phieu") \
		_T(" FROM   m_transaction ") \
		_T(" LEFT JOIN m_transaction_batch ON(mtb_orderno = mt_orderno) ") \
		_T(" LEFT JOIN hms_ipharmaorder ON (mt_doctype = 'DMO' AND hpo_transaction_id = mt_transaction_id)") \
		_T(" WHERE  mt_transaction_id = %ld ") \
		_T(" AND mt_status NOT IN ('O', 'C')"), nOID);

	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
		return;
	if (rs.GetValue(_T("status")) == _T("A"))
	{
		ShowMessageBox(_T("Phiếu trạng thái đã duyệt. Tới khoa cấp phát để in lại!"));
		//return;
	}
	CString szType, szReportName, szSendBy, szObjectType;//reportNameStr, sendByStr, objectTypeStr
	CString szOrderCategory;

	rs.GetValue(_T("mt_doctype"), szType);
	rs.GetValue(_T("mt_orderno"), szID);


	rs.GetValue(_T("hpo_ordertype"), szOrderType);
	if (szType == _T("DPO") || szType == _T("DMO") || szType == _T("CSO"))
	{
		szOrderBy.Format(_T(" ORDER BY product_uomindex, product_name, product_uomname "));
	}
	else if (szType == _T("DDO"))
	{
		szOrderBy.Format(_T(" ORDER BY product_name, product_uomname "));
	}

	rs.GetValue(_T("mt_postedby"), szSendBy);
	rs.GetValue(_T("mt_description"), szDesc);

	rs.GetValue(_T("mt_storage_id"), nStorage_id);
	rs.GetValue(_T("mt_objecttype"), szObjectType);


	//Kiem tra kho dich vu
	if (szObjectType == _T("S"))
		szStorageCategory = _T("S");
	else
	{
		szSQL.Format(_T("SELECT msl_category category FROM m_storagelist WHERE msl_storage_id = %d"), nStorage_id);
		rsReport.ExecSQL(szSQL);
		rsReport.GetValue(_T("category"), szStorageCategory);
	}
	rs.GetValue(_T("mtb_ordertype"), szOrderCategory);



	if (szType == _T("DPO") || szType == _T("DMO") || szType == _T("DDO") || szType == _T("CSO"))
	{
		szSQL.Format(_T(" SELECT DISTINCT pmdt_name,") \
			_T("   pmdt_desc,") \
			_T("   pmdt_reportname, pmdt_index, pmdt_printtype, pmdt_id  ") \
			_T(" FROM pms_drugtype,") \
			_T("   m_transactionline,") \
			_T("   m_productitem_view") \
			_T(" WHERE mtl_transaction_id =%ld") \
			_T(" AND mtl_product_item_id  =product_item_id") \
			_T(" AND instr(pmdt_desc, product_producttype) > 0") \
			_T(" ORDER BY pmdt_index "), nOID);
		rst.ExecSQL(szSQL);
		//msg(_T("%s"), szSQL);
		while (!rst.IsEOF())
		{
			rst.GetValue(_T("pmdt_name"), tmpStr);
			StringUpper(tmpStr, szTitle);
			rst.GetValue(_T("pmdt_desc"), szGroup);
			szGroup.Trim();

			rst.GetValue(_T("pmdt_reportname"), tmpStr);
			//_msg(_T("%s"), szStorageCategory);
			if (!tmpStr.IsEmpty())
				if (szStorageCategory == _T("S"))
					szReportName.Format(_T("Reports/HMS/%sDV.RPT"), tmpStr);
				else
					szReportName.Format(_T("Reports/HMS/%s.RPT"), tmpStr);

			if (!rpt.Init(szReportName))
				return;
			rpt.GetReportHeader()->SetValue(_T("so_phieu"), rs.GetValue(_T("so_phieu")));
			rpt.GetReportHeader()->SetValue(_T("Zone"), rs.GetValue(_T("zone")));
			//Report Header
			rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
			rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
			//if (szStorageCategory != _T("S"))
			rpt.GetReportHeader()->Format(_T("TITLE"), szTitle);
			rs.GetValue(_T("mt_orderdate"), tmpStr);
			szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);
			rpt.GetReportHeader()->SetValue(_T("OrderID"), szID);
            rpt.GetReportHeader()->SetValue(_T("pmdt_id"), rst.GetValue(L"pmdt_id"));

			rs.GetValue(_T("mt_orderno"), szBarCodeID);
			rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), szBarCodeID);
			rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), szBarCodeID);
			rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), szBarCodeID);
			rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), szBarCodeID);
			rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), szBarCodeID);

			if (szOrderType == _T("M"))
				rpt.GetReportHeader()->SetValue(_T("Purpose"), _T("\x44\xE0nh \x63ho \x63\xE1\x63 \x63\x61 ph\x1EABu thu\x1EADt, th\x1EE7 thu\x1EADt"));
			rs.GetValue(_T("mt_statusdesc"), tmpStr);
			//tmpStr = GetStatusString(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
			rs.GetValue(_T("mt_storage_name"), tmpStr);
			//tmpStr = GetStorageName(ToInt(tmpStr));
			rpt.GetReportHeader()->SetValue(_T("FromStock"), tmpStr);
			rpt.GetReportHeader()->SetValue(_T("Comment"), szDesc);

			rs.GetValue(_T("mt_storageto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("ToStock"), tmpStr);

			rs.GetValue(_T("mt_department_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

			rs.GetValue(_T("mt_departmentto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("DepartmentTo"), tmpStr);
			tmpStr.Empty();
			rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

			if (pMF->GetModuleID() == _T("MA"))
			{
				rs.GetValue(_T("mt_documentno"), tmpStr);
				rpt.GetReportHeader()->SetValue(_T("ReferenceNo"), tmpStr);
			}

			if (szOrderCategory == _T("C"))
			{
				rpt.GetReportHeader()->SetValue(_T("OrderCategory"), _T("Phiếu lĩnh thuốc, hóa chất pha chế"));
			}
			else
			{
				rpt.GetReportHeader()->SetValue(_T("OrderCategory"), _T(""));
			}

			//*?Lay gia ban tu line thuoc
			//Page Header
			//Report Detail
			if (1 == 0 && szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
				szSQL.Format(_T(" SELECT product_id                             AS id, ") \
					_T("		product_item_id item_id,") \
					_T("        product_name                           AS name, ") \
					_T("        product_name2                          AS hamluong, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					_T("        Sum(mtl_qtyservice)                    AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        mtl_saleprice                      AS price, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount, ") \
					_T("        product_expdate                        AS expdate ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  mtl_transaction_id = %ld ") \
					_T("        AND product_producttype NOT IN('A1130', 'A1140') ") \
					_T(" GROUP  BY product_id, ") \
					_T("		   product_item_id,") \
					_T("           product_name, product_name2,") \
					_T("           product_uomname, ") \
					_T("		   mtl_saleprice,") \
					_T("           product_uomindex,product_expdate ") \
					_T("		   %s "), nOID, szOrderBy);
			else
				szSQL.Format(_T(" SELECT product_id                AS id, ") \
					_T("		product_item_id                        AS item_id, ") \
					_T("        product_name                           AS name, ") \
					_T("        product_name2                          AS hamluong, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					//_T("        case when Sum(mtl_qtyservice)>0 then Sum(mtl_qtyservice) else Sum(mtl_qtyorder) end AS qtyservice, ") \//
					_T("        Sum(mtl_qtyservice) AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        mtl_saleprice                      AS price, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount, ") \
					_T("        product_lotno                          AS lotno, ") \
					_T("        product_expdate                        AS expdate, ") \
					_T("		product_manufacturename, product_ma_hieu ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  mtl_transaction_id = %ld ") \
					_T("        AND product_producttype IN(%s) ") \
					_T(" GROUP  BY product_id, ") \
					_T("		   product_item_id,") \
					_T("           product_name, product_name2,") \
					_T("           product_uomname, ") \
					_T("           mtl_saleprice, ") \
					_T("           product_uomindex, ") \
					_T("           product_lotno, ") \
					_T("		   product_manufacturename, product_ma_hieu, ") \
					_T("           product_expdate ") \
					_T("		   %s "), nOID, szGroup, szOrderBy);

			rs2.ExecSQL(szSQL);
			_fmsg(_T("%s"), szSQL);
			if (rs2.IsEOF()) {
				rst.MoveNext();
				continue;

			}
			if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
			{
				//nBreak++;
			}
			CReportSection* rptDetail = rpt.GetDetail(0);
			rpt.ResetContent();
			nTotalItem = 1;
			nTotalAmount = 0;
			CString szItemId;
			while (!rs2.IsEOF())
			{
				rptDetail = rpt.AddDetail();
				rs2.GetValue(_T("id"), nProductID);
				rs2.GetValue(_T("item_id"), nProductItemID);
				tmpStr.Format(_T("%d"), nTotalItem++);
				rptDetail->SetValue(_T("1"), tmpStr);
				rs2.GetValue(_T("name"), tmpStr);
				rptDetail->SetValue(_T("2"), tmpStr);
				rs2.GetValue(_T("unit"), tmpStr);
				rptDetail->SetValue(_T("3"), tmpStr);
				rs2.GetValue(_T("product_ma_hieu"), tmpStr);
				rptDetail->SetValue(_T("3.1"), tmpStr);
				rs2.GetValue(_T("product_manufacturename"), tmpStr);
				rptDetail->SetValue(_T("3.2"), tmpStr);
				rs2.GetValue(_T("qtyorder"), nQty);

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 || szGroup.Find(_T("'A2000'")) != -1 || szOrderType == _T("M"))
					MoneyToString(ToString(nQty), szNote);
				else
					szNote.Empty();
				tmpStr2.Format(_T("%.0f"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4"), tmpStr2);

				rs2.GetValue(_T("qtysold"), nQty);
				tmpStr2.Format(_T("%.0f"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.1"), tmpStr2);

				rs2.GetValue(_T("qtypolicy"), nQty);
				tmpStr2.Format(_T("%.0f"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.2"), tmpStr2);

				rs2.GetValue(_T("qtysoldins"), nQty);
				tmpStr2.Format(_T("%.0f"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.3"), tmpStr2);
				rs2.GetValue(_T("qtyotherins"), nQty);
				tmpStr2.Format(_T("%.0f"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.4"), tmpStr2);

				rs2.GetValue(_T("qtyservice"), nQty);
				tmpStr2.Format(_T("%.0f"), nQty);
				FormatCurrency(nQty, tmpStr2);
				_tprintf(_T("\r\nnStorageId: %d"), nStorage_id);
				//rptDetail->SetValue(_T("4.5"), nStorage_id==14?rs2.GetValue(_T("qtyorder")):tmpStr2);
				rptDetail->SetValue(_T("4.5"), tmpStr2);

				rs2.GetValue(_T("qtyother"), nQty);
				tmpStr2.Format(_T("%.0f"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.6"), tmpStr2);

				rs2.GetValue(_T("price"), tmpStr);
				rs2.GetValue(_T("amount"), nAmount);

				FormatCurrencyStr(tmpStr, tmpStr2);
				rptDetail->SetValue(_T("5"), tmpStr2);

				rptDetail->SetValue(_T("8"), tmpStr2);
				nTotalAmount += nAmount;

				FormatCurrency(nAmount, tmpStr2);
				rptDetail->SetValue(_T("7"), tmpStr2);

				rptDetail->SetValue(_T("9"), tmpStr2);

				rptDetail->SetValue(_T("6"), szNote);

				//if(szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1)
				{
					rs2.GetValue(_T("lotno"), tmpStr);
					rptDetail->SetValue(_T("10"), tmpStr);

					rs2.GetValue(_T("expdate"), tmpStr);
					rptDetail->SetValue(_T("11"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
				}
				rs2.GetValue(_T("hamluong"), tmpStr);
				rptDetail->SetValue(_T("15"), tmpStr);

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 ||
					szGroup.Find(_T("'A2000'")) != -1 || szOrderType == _T("M"))
				{
					szSQL.Format(_T(" SELECT    hpo_docno            AS docno, ") \
						_T("           get_patientname(hpo_docno) AS pname, ") \
						_T("           SUM(hpol_qtyorder)   AS orderqty ") \
						_T(" FROM      hms_ipharmaorder ") \
						_T(" LEFT JOIN hms_ipharmaorderline ON( hpo_orderid = hpol_orderid ) ") \
						_T(" WHERE     hpo_transaction_id = %ld ") \
						_T("       AND hpol_product_item_id = %ld ") \
						_T(" GROUP     BY hpo_docno ") \
						_T(" ORDER     BY pname "), nOID, nProductItemID);
					rsp.ExecSQL(szSQL);
					while (!rsp.IsEOF()) {
						rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
						rptDetail->SetValue(_T("1"), _T(""));
						rsp.GetValue(_T("pname"), tmpStr);
						rptDetail->SetValue(_T("2"), tmpStr);
						rsp.GetValue(_T("docno"), tmpStr);
						rptDetail->SetValue(_T("3"), tmpStr);
						rsp.GetValue(_T("orderqty"), nQty);
						FormatCurrency(nQty, tmpStr);
						rptDetail->SetValue(_T("4"), tmpStr);
						rptDetail->SetValue(_T("5"), _T(""));
						MoneyToString(ToString(nQty), szNote);
						rptDetail->SetValue(_T("6"), szNote);
						rsp.MoveNext();
					}
				}
				rs2.MoveNext();
			}
			//Page Footer
			//Report Footer
			rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
			tmpStr.Format(_T("%d"), nTotalItem - 1);
			rptDetail->SetValue(_T("TotalItem"), tmpStr);
			tmpStr.Format(_T("%.0f"), nTotalAmount);
			FormatCurrencyStr(tmpStr, tmpStr2);
			rptDetail->SetValue(_T("TotalAmount"), tmpStr2);

			MoneyToString(tmpStr, tmpStr2);
			tmpStr.Format(_T("%s \x111\x1ED3ng."), tmpStr2);
			rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);

			CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
			if (img)
			{
				//img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
				//img->SetFixedHeight(false);
			}

			rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

			tmpStr = pMF->GetSysDateTime();
			szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
			tmpStr2 = szDate;
			szDate.Format(_T("%s, %s"), tmpStr.Mid(11, 5), szDate);
			rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

			rpt.PrintPreview(bPreviewOnly);
			//_msg(_T("%s %s"), GroupStr, szGroup);
			if (nBreak > 0)
				break;
			rst.MoveNext();
		}
	}
}

void CPrintForms::PrintDDO2_v2(long nOID, bool bPreviewOnly)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CReportSection* headerSection = NULL, * detailSection = NULL, * groupFooter = NULL, * groupHeader = NULL, * footerSection = NULL;
	CRecord tmpRecord(&pMF->m_db), transactionRecord(&pMF->m_db), itemRecord(&pMF->m_db), typeSortRecord(&pMF->m_db), qtyPsychoRecord(&pMF->m_db);
	CString typeCollectionStr, qty2Word;
	CString tmpStr, tmpStr2, sqlStr, orderByStr, storageCategoryStr, orderTypeStr;
	int storageIndex = 0, tmpInt = 0, itemCount = 1;
	bool printBreak = false;
	long productIndex = 0, productItemIndex = 0;
	double	amountTotal = 0;

	orderByStr.Format(_T(" ORDER BY name, unit, price "));
	sqlStr.Format(_T(" SELECT distinct mt_orderno, ") \
		_T("        mt_orderdate, ") \
		_T("        mt_approveddate, ") \
		_T("        mt_postedby, ") \
		_T("        mt_storage_id, ") \
		_T("        Get_storagename(mt_storage_id)          AS mt_storage_name, ") \
		_T("        Get_storagename(mt_storage_to_id)       AS mt_storageto_name, ") \
		_T("        Get_departmentname(mt_department_id)    AS mt_department_name, ") \
		_T("        Get_departmentname(mt_department_to_id) AS mt_departmentto_name, ") \
		_T("        mt_doctype, ") \
		_T("        mt_description, ") \
		_T("		mt_objecttype, ")
		_T("		hpo_ordertype, mt_documentno ") \
		_T(" FROM   m_transaction ") \
		_T(" LEFT JOIN hms_ipharmaorder ON (mt_doctype = 'DMO' AND hpo_transaction_id = mt_transaction_id)") \
		_T(" WHERE  mt_transaction_id = %ld ") \
		_T(" AND mt_status NOT IN ('C')"), nOID);
	transactionRecord.ExecSQL(sqlStr);
	if (transactionRecord.IsEOF()) return;
	CString szDocType, szReportName, szObjectType;
	transactionRecord.GetValue(_T("mt_doctype"), szDocType);
	transactionRecord.GetValue(_T("hpo_ordertype"), orderTypeStr);
	if (szDocType == _T("DDO") || szDocType == _T("DPO") || szDocType == _T("DMO") || szDocType == _T("CSO"))
		orderByStr.Format(_T(" ORDER BY product_uomindex, product_name, product_uomname "));
	transactionRecord.GetValue(_T("mt_storage_id"), storageIndex);
	transactionRecord.GetValue(_T("mt_objecttype"), szObjectType);
	//Kiem tra kho dich vu
	if (szObjectType == _T("S")) storageCategoryStr = _T("S");
	else {
		sqlStr.Format(_T("SELECT msl_category category FROM m_storagelist WHERE msl_storage_id = %d"), storageIndex);
		tmpRecord.ExecSQL(sqlStr);
		tmpRecord.GetValue(_T("category"), storageCategoryStr);
	}
	if (szDocType == _T("DPO") || szDocType == _T("DMO") || szDocType == _T("DDO") || szDocType == _T("CSO")) {
		sqlStr.Format(_T(" SELECT DISTINCT pmdt_name,") \
			_T("   pmdt_desc,") \
			_T("   pmdt_reportname, pmdt_index, pmdt_printtype  ") \
			_T(" FROM pms_drugtype,") \
			_T("   m_transactionline,") \
			_T("   m_productitem_view") \
			_T(" WHERE mtl_transaction_id =%ld") \
			_T(" AND mtl_product_item_id  =product_item_id") \
			_T(" AND instr(pmdt_desc, product_producttype) > 0") \
			_T(" ORDER BY pmdt_index "), nOID);
		typeSortRecord.ExecSQL(sqlStr);
		while (!typeSortRecord.IsEOF()) {
			typeSortRecord.GetValue(_T("pmdt_desc"), typeCollectionStr);
			typeCollectionStr.Trim();
			typeSortRecord.GetValue(_T("pmdt_reportname"), tmpStr);
			if (!tmpStr.IsEmpty())
				if (storageCategoryStr == _T("S"))
					szReportName.Format(_T("Reports/HMS/%sDV.RPT"), tmpStr);
				else
					szReportName.Format(_T("Reports/HMS/%s.RPT"), tmpStr);
			if (!rpt.Init(szReportName)) return;
			headerSection = rpt.GetReportHeader();
			headerSection->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
			headerSection->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
			if (storageCategoryStr != _T("S")) {
				StringUpper(typeSortRecord.GetValue(_T("pmdt_name")), tmpStr);
				headerSection->Format(_T("TITLE"), tmpStr);
			}
			transactionRecord.GetValue(_T("mt_orderdate"), tmpStr2);
			tmpStr.Format(headerSection->GetValue(_T("OrderDate")), CDate::Convert(tmpStr2, yyyymmdd, ddmmyyyy));
			headerSection->SetValue(_T("OrderDate"), tmpStr);
			headerSection->SetValue(_T("OrderID"), transactionRecord.GetValue(_T("mt_orderno")));
			headerSection->SetValue(_T("Purpose"), orderTypeStr == _T("M") ? _T("\x44\xE0nh \x63ho \x63\xE1\x63 \x63\x61 ph\x1EABu thu\x1EADt, th\x1EE7 thu\x1EADt") : _T(""));
			headerSection->SetValue(_T("Status"), transactionRecord.GetValue(_T("mt_statusdesc")));
			headerSection->SetValue(_T("FromStock"), transactionRecord.GetValue(_T("mt_storage_name")));
			headerSection->SetValue(_T("Comment"), transactionRecord.GetValue(_T("mt_description")));
			headerSection->SetValue(_T("ToStock"), transactionRecord.GetValue(_T("mt_storageto_name")));
			headerSection->SetValue(_T("Department"), transactionRecord.GetValue(_T("mt_department_name")));
			headerSection->SetValue(_T("DepartmentTo"), transactionRecord.GetValue(_T("mt_departmentto_name")));
			tmpStr.Empty();
			headerSection->SetValue(_T("Sheet"), _T("1"));
			headerSection->SetValue(_T("ReferenceNo"), pMF->GetModuleID() == _T("MA") ? transactionRecord.GetValue(_T("mt_documentno")) : _T(""));
			if (storageCategoryStr == _T("S") && (typeCollectionStr.Find(_T("'A1130'")) == -1 && typeCollectionStr.Find(_T("'A1140'")) == -1))
				sqlStr.Format(_T(" SELECT product_id                             AS id, ") \
					_T("		product_item_id item_id,") \
					_T("        product_name                           AS name, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					_T("        Sum(mtl_qtyservice)                    AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        mtl_saleprice                      AS price, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  mtl_transaction_id = %ld ") \
					_T("        AND product_producttype NOT IN('A1130', 'A1140') ") \
					_T(" GROUP  BY product_id, ") \
					_T("		   product_item_id,") \
					_T("           product_name, ") \
					_T("           product_uomname, ") \
					_T("		   mtl_saleprice,") \
					_T("           product_uomindex ") \
					_T("		   %s "), nOID, orderByStr);
			else
				sqlStr.Format(_T(" SELECT product_id                             AS id, ") \
					_T("		product_item_id item_id, ") \
					_T("        product_name                           AS name, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					_T("        Sum(mtl_qtyservice)                    AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        mtl_saleprice                      AS price, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  mtl_transaction_id = %ld ") \
					_T("        AND product_producttype IN(%s) ") \
					_T(" GROUP  BY product_id, ") \
					_T("		   product_item_id,") \
					_T("           product_name, ") \
					_T("           product_uomname, ") \
					_T("           mtl_saleprice, ") \
					_T("           product_uomindex ") \
					_T("		   %s "), nOID, typeCollectionStr, orderByStr);
			itemRecord.ExecSQL(sqlStr);
			if (itemRecord.IsEOF()) {
				typeSortRecord.MoveNext();
				continue;
			}
			if (storageCategoryStr == _T("S") && (typeCollectionStr.Find(_T("'A1130'")) == -1 && typeCollectionStr.Find(_T("'A1140'")) == -1))
				printBreak = true;
			detailSection = rpt.GetDetail(0);
			rpt.ResetContent();
			itemCount = 1;
			amountTotal = 0;
			while (!itemRecord.IsEOF()) {
				detailSection = rpt.AddDetail();
				itemRecord.GetValue(_T("id"), productIndex);
				itemRecord.GetValue(_T("item_id"), productItemIndex);
				tmpStr.Format(_T("%d"), itemCount++);
				detailSection->SetValue(_T("1"), tmpStr);
				itemRecord.GetValue(_T("name"), tmpStr);
				detailSection->SetValue(_T("2"), tmpStr);
				itemRecord.GetValue(_T("unit"), tmpStr);
				detailSection->SetValue(_T("3"), tmpStr);
				itemRecord.GetValue(_T("qtyorder"), tmpInt);

				if (typeCollectionStr.Find(_T("'A1130'")) != -1 || typeCollectionStr.Find(_T("'A1140'")) != -1 || typeCollectionStr.Find(_T("'A2000'")) != -1 || orderTypeStr == _T("M"))
					MoneyToString(ToString(tmpInt), qty2Word);
				else qty2Word.Empty();
				FormatCurrency(tmpInt, tmpStr2);
				detailSection->SetValue(_T("4"), tmpStr2);

				itemRecord.GetValue(_T("qtysold"), tmpInt);
				FormatCurrency(tmpInt, tmpStr2);
				detailSection->SetValue(_T("4.1"), tmpStr2);

				itemRecord.GetValue(_T("qtypolicy"), tmpInt);
				FormatCurrency(tmpInt, tmpStr2);
				detailSection->SetValue(_T("4.2"), tmpStr2);

				itemRecord.GetValue(_T("qtysoldins"), tmpInt);
				FormatCurrency(tmpInt, tmpStr2);
				detailSection->SetValue(_T("4.3"), tmpStr2);
				itemRecord.GetValue(_T("qtyotherins"), tmpInt);
				FormatCurrency(tmpInt, tmpStr2);
				detailSection->SetValue(_T("4.4"), tmpStr2);

				itemRecord.GetValue(_T("qtyservice"), tmpInt);
				FormatCurrency(tmpInt, tmpStr2);
				detailSection->SetValue(_T("4.5"), tmpStr2);

				itemRecord.GetValue(_T("qtyother"), tmpInt);
				FormatCurrency(tmpInt, tmpStr2);
				detailSection->SetValue(_T("4.6"), tmpStr2);

				itemRecord.GetValue(_T("price"), tmpStr);

				FormatCurrencyStr(tmpStr, tmpStr2);
				detailSection->SetValue(_T("5"), tmpStr2);

				detailSection->SetValue(_T("8"), tmpStr2);
				itemRecord.GetValue(_T("amount"), tmpInt);
				amountTotal += tmpInt;
				FormatCurrency(tmpInt, tmpStr2);
				detailSection->SetValue(_T("7"), tmpStr2);

				detailSection->SetValue(_T("9"), tmpStr2);

				detailSection->SetValue(_T("6"), qty2Word);

				if (typeCollectionStr.Find(_T("'A1130'")) != -1 || typeCollectionStr.Find(_T("'A1140'")) != -1 ||
					typeCollectionStr.Find(_T("'A2000'")) != -1 || orderTypeStr == _T("M")) {
					sqlStr.Format(_T(" SELECT    hpo_docno            AS docno, ") \
						_T("           get_patientname(hpo_docno) AS pname, ") \
						_T("           SUM(hpol_qtyorder)   AS orderqty ") \
						_T(" FROM      hms_ipharmaorder ") \
						_T(" LEFT JOIN hms_ipharmaorderline ON( hpo_orderid = hpol_orderid ) ") \
						_T(" WHERE     hpo_transaction_id = %ld ") \
						_T("       AND hpol_product_item_id = %ld ") \
						_T(" GROUP     BY hpo_docno ") \
						_T(" ORDER     BY pname "), nOID, productItemIndex);
					qtyPsychoRecord.ExecSQL(sqlStr);
					while (!qtyPsychoRecord.IsEOF()) {
						groupHeader = rpt.AddDetail(rpt.GetGroupHeader(1));
						groupHeader->SetValue(_T("1"), _T(""));
						qtyPsychoRecord.GetValue(_T("pname"), tmpStr);
						groupHeader->SetValue(_T("2"), tmpStr);
						qtyPsychoRecord.GetValue(_T("docno"), tmpStr);
						groupHeader->SetValue(_T("3"), tmpStr);
						qtyPsychoRecord.GetValue(_T("orderqty"), tmpInt);
						FormatCurrency(tmpInt, tmpStr);
						groupHeader->SetValue(_T("4"), tmpStr);
						groupHeader->SetValue(_T("5"), _T(""));
						MoneyToString(ToString(tmpInt), qty2Word);
						groupHeader->SetValue(_T("6"), qty2Word);
						qtyPsychoRecord.MoveNext();
					}
				}
				itemRecord.MoveNext();
			}
			groupFooter = rpt.AddDetail(rpt.GetGroupFooter(1));
			tmpStr.Format(_T("%d"), itemCount - 1);
			groupFooter->SetValue(_T("TotalItem"), tmpStr);
			tmpStr.Format(_T("%.0f"), amountTotal);
			FormatCurrencyStr(tmpStr, tmpStr2);
			groupFooter->SetValue(_T("TotalAmount"), tmpStr2);

			footerSection = rpt.GetReportFooter();
			MoneyToString(tmpStr, tmpStr2);
			tmpStr.Format(_T("%s \x111\x1ED3ng."), tmpStr2);
			footerSection->SetValue(_T("SumInWord"), tmpStr);

			footerSection->SetValue(_T("DoctorName"), GetDoctorName(transactionRecord.GetValue(_T("mt_postedby"))));

			tmpStr2 = pMF->GetSysDate();
			tmpStr.Format(footerSection->GetValue(_T("PrintDate")), tmpStr2.Mid(8, 2), tmpStr2.Mid(5, 2), tmpStr2.Left(4));
			footerSection->SetValue(_T("PrintDate"), tmpStr);

			rpt.PrintPreview(bPreviewOnly);
			if (printBreak) break;
			typeSortRecord.MoveNext();
		}
	}
}

void CPrintForms::PrintDDO2X(CString szOrderID, bool bPreviewOnly) {
	//Edited 
	//1st
	//Gop cac line thuoc
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rsReport(&pMF->m_db);
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rst(&pMF->m_db);
	CRecord rsp(&pMF->m_db);
	CString szGroup, szTitle, szPrintType, szNote;
	CString tmpStr, tmpStr2, szDate, szSQL, szDesc, szOrderBy, szStorageCategory, szOrderType, szStorageName;
	int nStorage_id = 0;
	CString szID;
	long nProductID = 0, nProductItemID = 0;

	szID.Format(_T("%s"), szOrderID);

	double	nTotalAmount = 0, nAmount = 0, nAmountServ = 0, nTotalAmountServ = 0;
	int		nQty, nTotalItem = 1;
	int		nPrint = 0, nBreak = 0;
	bool bDirect = false;

	szOrderBy.Format(_T(" ORDER BY name, unit, price "));
	szSQL.Format(_T(" SELECT distinct mt_orderno, ") \
		_T("        mt_orderdate, ") \
		_T("        mt_approveddate, ") \
		_T("        mt_postedby, ") \
		_T("        mt_storage_id, ") \
		_T("        Get_storagename(mt_storage_id)          AS mt_storage_name, ") \
		_T("        Get_storagename(mt_storage_to_id)       AS mt_storageto_name, ") \
		_T("        Get_departmentname(mt_department_id)    AS mt_department_name, ") \
		_T("        Get_departmentname(mt_department_to_id) AS mt_departmentto_name, ") \
		_T("        mt_doctype, ") \
		_T("        mt_description, ") \
		_T("		mt_objecttype, ")
		_T("		hpo_ordertype, mt_documentno ") \
		_T(" FROM   m_transaction ") \
		_T(" LEFT JOIN hms_ipharmaorder ON (mt_doctype = 'DMO' AND hpo_transaction_id = mt_transaction_id)") \
		_T(" WHERE  mt_transaction_id IN (%s) ") \
		_T(" AND mt_status NOT IN ('C')"), szOrderID);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	while (!rs.IsEOF())
	{
		if (!szStorageName.IsEmpty())
			szStorageName += _T(", ");
		szStorageName.AppendFormat(_T("%s"), rs.GetValue(_T("mt_storage_name")));
		rs.MoveNext();
	}
	rs.MoveFirst();
	CString szType, szReportName, szSendBy, szObjectType;
	rs.GetValue(_T("mt_doctype"), szType);
	rs.GetValue(_T("mt_orderno"), szID);
	rs.GetValue(_T("hpo_ordertype"), szOrderType);
	if (szType == _T("DDO") || szType == _T("DPO") || szType == _T("DMO") || szType == _T("CSO"))
		szOrderBy.Format(_T(" ORDER BY product_uomindex, product_name, product_uomname "));
	rs.GetValue(_T("mt_postedby"), szSendBy);
	rs.GetValue(_T("mt_description"), szDesc);

	rs.GetValue(_T("mt_storage_id"), nStorage_id);
	rs.GetValue(_T("mt_objecttype"), szObjectType);

	//Kiem tra kho dich vu
	if (szObjectType == _T("S"))
		szStorageCategory = _T("S");
	/*else
	{
		szSQL.Format(_T("SELECT msl_category category FROM m_storagelist WHERE msl_storage_id = %d"), nStorage_id);
		rsReport.ExecSQL(szSQL);
		rsReport.GetValue(_T("category"), szStorageCategory);
	}*/
	if (szType == _T("DPO") || szType == _T("DMO") || szType == _T("DDO") || szType == _T("CSO"))
	{
		szSQL.Format(_T(" SELECT DISTINCT pmdt_name,") \
			_T("   pmdt_desc,") \
			_T("   pmdt_reportname, pmdt_index, pmdt_printtype  ") \
			_T(" FROM pms_drugtype,") \
			_T("   m_transactionline,") \
			_T("   m_productitem_view") \
			_T(" WHERE mtl_transaction_id IN (%s)") \
			_T(" AND mtl_product_item_id  =product_item_id") \
			_T(" AND instr(pmdt_desc, product_producttype) > 0") \
			_T(" ORDER BY pmdt_index "), szOrderID);
		rst.ExecSQL(szSQL);
		while (!rst.IsEOF())
		{
			rst.GetValue(_T("pmdt_name"), tmpStr);
			StringUpper(tmpStr, szTitle);
			rst.GetValue(_T("pmdt_desc"), szGroup);
			szGroup.Trim();

			rst.GetValue(_T("pmdt_reportname"), tmpStr);
			if (!tmpStr.IsEmpty())
				if (szStorageCategory == _T("S"))
					szReportName.Format(_T("Reports/HMS/%sDV.RPT"), tmpStr);
				else
					szReportName.Format(_T("Reports/HMS/%s.RPT"), tmpStr);
			if (!rpt.Init(szReportName))
				return;

			//Report Header
			rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
			rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
			if (szStorageCategory != _T("S"))
				rpt.GetReportHeader()->Format(_T("TITLE"), szTitle);
			rs.GetValue(_T("mt_orderdate"), tmpStr);
			szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);
			rpt.GetReportHeader()->SetValue(_T("OrderID"), szID);
			if (szOrderType == _T("M"))
				rpt.GetReportHeader()->SetValue(_T("Purpose"), _T("\x44\xE0nh \x63ho \x63\xE1\x63 \x63\x61 ph\x1EABu thu\x1EADt, th\x1EE7 thu\x1EADt"));
			rs.GetValue(_T("mt_statusdesc"), tmpStr);
			//tmpStr = GetStatusString(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
			//rs.GetValue(_T("mt_storage_name"), tmpStr);
			//tmpStr = GetStorageName(ToInt(tmpStr));
			rpt.GetReportHeader()->SetValue(_T("FromStock"), szStorageName);
			rpt.GetReportHeader()->SetValue(_T("Comment"), szDesc);

			rs.GetValue(_T("mt_storageto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("ToStock"), tmpStr);

			rs.GetValue(_T("mt_department_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

			rs.GetValue(_T("mt_departmentto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("DepartmentTo"), tmpStr);
			tmpStr.Empty();
			rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

			if (pMF->GetModuleID() == _T("MA"))
			{
				rs.GetValue(_T("mt_documentno"), tmpStr);
				rpt.GetReportHeader()->SetValue(_T("ReferenceNo"), tmpStr);
			}

			//*?Lay gia ban tu line thuoc
			//Page Header
			//Report Detail
			if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
				szSQL.Format(_T(" SELECT product_id                             AS id, ") \
					_T("        product_name                           AS name, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					_T("        Sum(mtl_qtyservice)                    AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  mtl_transaction_id IN (%s)") \
					_T("        AND product_producttype NOT IN('A1130', 'A1140') ") \
					_T(" GROUP  BY product_id, ") \
					_T("           product_name, ") \
					_T("           product_uomname, ") \
					_T("           product_uomindex ") \
					_T("		   %s "), szOrderID, szOrderBy);
			else
				szSQL.Format(_T(" SELECT product_id                             AS id, ") \
					_T("        product_name                           AS name, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					_T("        Sum(mtl_qtyservice)                    AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  mtl_transaction_id IN (%s) ") \
					_T("        AND product_producttype IN(%s) ") \
					_T(" GROUP  BY product_id, ") \
					_T("           product_name, ") \
					_T("           product_uomname, ") \
					_T("           product_uomindex ") \
					_T("		   %s "), szOrderID, szGroup, szOrderBy);

			rs2.ExecSQL(szSQL);
			_fmsg(_T("%s"), szSQL);
			if (rs2.IsEOF()) {
				rst.MoveNext();
				continue;

			}
			if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
			{
				nBreak++;
			}
			CReportSection* rptDetail = rpt.GetDetail(0);
			rpt.ResetContent();
			nTotalItem = 1;
			nTotalAmount = 0;
			CString szItemId;
			while (!rs2.IsEOF())
			{
				rptDetail = rpt.AddDetail();
				rs2.GetValue(_T("id"), nProductID);
				//rs2.GetValue(_T("item_id"), nProductItemID);
				tmpStr.Format(_T("%d"), nTotalItem++);
				rptDetail->SetValue(_T("1"), tmpStr);
				rs2.GetValue(_T("name"), tmpStr);
				rptDetail->SetValue(_T("2"), tmpStr);
				rs2.GetValue(_T("unit"), tmpStr);
				rptDetail->SetValue(_T("3"), tmpStr);
				rs2.GetValue(_T("qtyorder"), nQty);

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 || szGroup.Find(_T("'A2000'")) != -1 || szOrderType == _T("M"))
					MoneyToString(ToString(nQty), szNote);
				else
					szNote.Empty();
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4"), tmpStr2);

				rs2.GetValue(_T("qtysold"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.1"), tmpStr2);

				rs2.GetValue(_T("qtypolicy"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.2"), tmpStr2);

				rs2.GetValue(_T("qtysoldins"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.3"), tmpStr2);
				rs2.GetValue(_T("qtyotherins"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.4"), tmpStr2);

				rs2.GetValue(_T("qtyservice"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.5"), tmpStr2);

				rs2.GetValue(_T("qtyother"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.6"), tmpStr2);

				//rs2.GetValue(_T("price"), tmpStr);
				rs2.GetValue(_T("amount"), nAmount);

				//FormatCurrencyStr(tmpStr, tmpStr2);
				//rptDetail->SetValue(_T("5"), tmpStr2);

				//rptDetail->SetValue(_T("8"), tmpStr2);
				nTotalAmount += nAmount;

				FormatCurrency(nAmount, tmpStr2);
				rptDetail->SetValue(_T("7"), tmpStr2);

				rptDetail->SetValue(_T("9"), tmpStr2);

				rptDetail->SetValue(_T("6"), szNote);

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 ||
					szGroup.Find(_T("'A2000'")) != -1 || szOrderType == _T("M"))
				{
					szSQL.Format(_T(" SELECT    hpo_docno            AS docno, ") \
						_T("           get_patientname(hpo_docno) AS pname, ") \
						_T("           SUM(hpol_qtyorder)   AS orderqty ") \
						_T(" FROM      hms_ipharmaorder ") \
						_T(" LEFT JOIN hms_ipharmaorderline ON( hpo_orderid = hpol_orderid ) ") \
						_T(" WHERE     hpo_transaction_id IN (%s) ") \
						_T("       AND hpol_product_id = %ld ") \
						_T(" GROUP     BY hpo_docno ") \
						_T(" ORDER     BY pname "), szOrderID, nProductID);
					rsp.ExecSQL(szSQL);
					while (!rsp.IsEOF()) {
						rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
						rptDetail->SetValue(_T("1"), _T(""));
						rsp.GetValue(_T("pname"), tmpStr);
						rptDetail->SetValue(_T("2"), tmpStr);
						rsp.GetValue(_T("docno"), tmpStr);
						rptDetail->SetValue(_T("3"), tmpStr);
						rsp.GetValue(_T("orderqty"), nQty);
						FormatCurrency(nQty, tmpStr);
						rptDetail->SetValue(_T("4"), tmpStr);
						rptDetail->SetValue(_T("5"), _T(""));
						MoneyToString(ToString(nQty), szNote);
						rptDetail->SetValue(_T("6"), szNote);
						rsp.MoveNext();
					}
				}
				rs2.MoveNext();
			}
			//Page Footer
			//Report Footer
			rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
			tmpStr.Format(_T("%d"), nTotalItem - 1);
			rptDetail->SetValue(_T("TotalItem"), tmpStr);
			tmpStr.Format(_T("%.0f"), nTotalAmount);
			FormatCurrencyStr(tmpStr, tmpStr2);
			rptDetail->SetValue(_T("TotalAmount"), tmpStr2);

			MoneyToString(tmpStr, tmpStr2);
			tmpStr.Format(_T("%s \x111\x1ED3ng."), tmpStr2);
			rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);

			CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
			if (img)
			{
				//img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
				//img->SetFixedHeight(false);
			}

			rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

			tmpStr = pMF->GetSysDate();
			szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
			rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

			rpt.PrintPreview(bPreviewOnly);
			//_msg(_T("%s %s"), GroupStr, szGroup);
			if (nBreak > 0)
				break;
			rst.MoveNext();
		}
	}
}

void CPrintForms::PM_PrintOldCabinetSheet(long nOID)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rsReport(&pMF->m_db);
	CRecord rs(&pMF->m_db);
	CRecord rsm(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CString tmpStr, tmpStr2, szDate, szSQL, szDesc, szOrderBy;
	CString szFloor;
	int nStorage_id = 0;
	CString szID;
	long nProductID;


	szID.Format(_T("%ld"), nOID);

	double	nTotalAmount = 0, nAmount = 0, nAmountServ = 0, nTotalAmountServ = 0;
	int		nQty, nTotalItem = 1, nPrintStorage = 0;
	int		nPrint = 0;
	bool bDirect = false;

	szOrderBy.Format(_T(" ORDER BY name, unit, price "));
	szSQL.Format(_T("SELECT mt_orderno, mt_orderdate, mt_approveddate, mt_postedby, mt_storage_id, ") \
		_T(" get_storagename(mt_storage_id) as mt_storage_name, ") \
		_T(" get_storagename(mt_storage_to_id) as mt_storageto_name, ") \
		_T(" get_departmentname(mt_department_id) as mt_department_name, ") \
		_T(" get_departmentname(mt_department_to_id) as mt_departmentto_name, ") \
		_T(" mt_doctype, mt_description ") \
		_T("FROM m_transaction WHERE mt_transaction_id=%ld "), nOID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	CString szType, szReportName, szSendBy;
	rs.GetValue(_T("mt_doctype"), szType);
	rs.GetValue(_T("mt_orderno"), szID);

	if (szType == _T("MOV"))
		szReportName = _T("Reports/HMS/PMS_STOCKTRANSFER.RPT");
	else if (szType == _T("DDO") || szType == _T("DPO") || szType == _T("DMO") || szType == _T("CSO"))
	{
		szOrderBy.Format(_T(" ORDER BY product_uomindex, product_name, product_uomname "));
		szReportName = _T("Reports/HMS/PMS_DRUGORDER.RPT");
	}
	else if (szType == _T("MCO"))
		szReportName = _T("Reports/HMS/PMS_CABINETORDER.RPT");
	else
		szReportName = _T("Reports/HMS/PMS_DRUGEXPORT.RPT");
	rs.GetValue(_T("mt_postedby"), szSendBy);
	rs.GetValue(_T("mt_description"), szDesc);


	rs.GetValue(_T("mt_floor"), tmpStr);
	//szFloor = pMF->GetSelectionString(_T("hms_floor"), tmpStr);
	szFloor.Empty();


	if (szType == _T("DPO") || szType == _T("DMO") || szType == _T("DDO") || szType == _T("CSO"))
	{
		CRecord rst(&pMF->m_db);
		CRecord rsp(&pMF->m_db);
		CString szGroup, szTitle, szPrintType, szNote;
		szSQL.Format(_T(" SELECT DISTINCT pmdt_name,") \
			_T("   pmdt_desc,") \
			_T("   pmdt_reportname, pmdt_index,pmdt_printtype  ") \
			_T(" FROM pms_drugtype,") \
			_T("   m_transactionline,") \
			_T("   m_productitem_view") \
			_T(" WHERE mtl_transaction_id =%ld") \
			_T(" AND mtl_product_item_id  =product_item_id") \
			_T(" AND instr(pmdt_desc, product_producttype) > 0") \
			_T(" ORDER BY pmdt_index "), nOID);
		rst.ExecSQL(szSQL);
		while (!rst.IsEOF())
		{
			rst.GetValue(_T("pmdt_name"), tmpStr);
			StringUpper(tmpStr, szTitle);
			rst.GetValue(_T("pmdt_desc"), szGroup);
			szGroup.Trim();
			rst.GetValue(_T("pmdt_printtype"), szPrintType);


			//Kiem tra neu la kho thiet lap cho doi tuong DICH VU thi goi mau rieng
			rs.GetValue(_T("mt_storage_id"), nStorage_id);
			szSQL.Format(_T(" SELECT msd_printtype FROM m_storage_default WHERE msd_storage_id = %d "), nStorage_id);
			rsReport.ExecSQL(szSQL);

			nPrintStorage = rsReport.GetIntValue();


			if (szPrintType == _T("2"))
			{
				rst.GetValue(_T("pmdt_reportname"), tmpStr);
				if (tmpStr.IsEmpty())
					szReportName = _T("Reports/HMS/PMS_DRUGORDER2.RPT");
				else
				{
					if (nPrintStorage == 1)
						szReportName.Format(_T("Reports/HMS/%sDV.RPT"), tmpStr);
					else
						szReportName.Format(_T("Reports/HMS/%s.RPT"), tmpStr);
				}
				//_msg(_T("%s, %s"), szSQL, szReportName);
				if (!rpt.Init(szReportName))
					return;

				//Report Header
				rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
				rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
				rpt.GetReportHeader()->Format(_T("TITLE"), szTitle);

				rs.GetValue(_T("mt_orderdate"), tmpStr);
				szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
				rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);
				rpt.GetReportHeader()->SetValue(_T("OrderID"), szID);
				rs.GetValue(_T("mt_statusdesc"), tmpStr);
				//tmpStr = GetStatusString(tmpStr);
				rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
				rs.GetValue(_T("mt_storage_name"), tmpStr);
				//tmpStr = GetStorageName(ToInt(tmpStr));
				rpt.GetReportHeader()->SetValue(_T("FromStock"), tmpStr);
				rpt.GetReportHeader()->SetValue(_T("FromStock2"), tmpStr);

				rpt.GetReportHeader()->SetValue(_T("Comment"), szDesc);
				rpt.GetReportHeader()->SetValue(_T("Comment2"), szDesc);


				rs.GetValue(_T("mt_storageto_name"), tmpStr);
				if (!tmpStr.IsEmpty())
				{
					//tmpStr = GetStorageName(ToInt(tmpStr));
					rpt.GetReportHeader()->SetValue(_T("ToStock"), tmpStr);
					rpt.GetReportHeader()->SetValue(_T("ToStock2"), tmpStr);
				}

				rs.GetValue(_T("mt_department_name"), tmpStr);
				if (!tmpStr.IsEmpty())
				{
					//tmpStr = GetDepartmentName(tmpStr);
					rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
					rpt.GetReportHeader()->SetValue(_T("Department2"), tmpStr);
				}

				rs.GetValue(_T("mt_departmentto_name"), tmpStr);
				if (!tmpStr.IsEmpty())
				{
					//tmpStr = GetDepartmentName(tmpStr);
					tmpStr.Append(_T(" - "));
					tmpStr.Append(rs.GetValue(_T("mt_storageto_name")));
					rpt.GetReportHeader()->SetValue(_T("DepartmentTo"), tmpStr);
					rpt.GetReportHeader()->SetValue(_T("DepartmentTo2"), tmpStr);
				}
				tmpStr.Empty();
				rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

				rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE2"), pMF->m_szHealthService);
				rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME2"), pMF->m_szHospitalName);
				rpt.GetReportHeader()->Format(_T("TITLE2"), szTitle);
				rs.GetValue(_T("mt_orderdate"), tmpStr);
				szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
				rpt.GetReportHeader()->SetValue(_T("OrderDate2"), szDate);
				rpt.GetReportHeader()->SetValue(_T("OrderID2"), szID);
				rpt.GetReportHeader()->SetValue(_T("Sheet2"), _T("2"));

				rpt.GetReportHeader()->SetValue(_T("Floor"), szFloor);
				rpt.GetReportHeader()->SetValue(_T("Floor2"), szFloor);

				szSQL.Format(_T("SELECT MAX(TRUNC_DATE(hpo_orderdate)) as maxorderdate, MIN(TRUNC_DATE(hpo_orderdate)) as minorderdate ") \
					_T(" FROM hms_medical_transaction_view ")\
					_T(" LEFT JOIN hms_ipharmaorder ON(hmt_orderid=hpo_orderid) ") \
					_T(" WHERE hmt_reftransaction_id=%ld"), nOID);
				_fmsg(_T("%s"), szSQL);
				rsm.ExecSQL(szSQL);
				if (!rsm.IsEOF()) {
					rpt.GetReportHeader()->SetValue(_T("MaxOrderDate"), CDate::Convert(rsm.GetValue(_T("MaxOrderDate")), yyyymmdd, ddmmyyyy));
					rpt.GetReportHeader()->SetValue(_T("MinOrderDate"), CDate::Convert(rsm.GetValue(_T("MinOrderDate")), yyyymmdd, ddmmyyyy));
				}

			}
			else
			{
				if (!rpt.Init(szReportName))
					return;



				//Report Header
				rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
				rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
				rpt.GetReportHeader()->Format(_T("TITLE"), szTitle);
				rs.GetValue(_T("mt_orderdate"), tmpStr);
				szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
				rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);
				rpt.GetReportHeader()->SetValue(_T("OrderID"), szID);
				rs.GetValue(_T("mt_storage_name"), tmpStr);
				rpt.GetReportHeader()->SetValue(_T("FromStock"), tmpStr);
				rs.GetValue(_T("mt_storageto_name"), tmpStr);
				if (!tmpStr.IsEmpty())
					rpt.GetReportHeader()->SetValue(_T("ToStock"), tmpStr);

				rs.GetValue(_T("mt_department_to_name"), tmpStr);
				if (!tmpStr.IsEmpty())
					rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
				tmpStr.Empty();
				rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));
				rpt.GetReportHeader()->SetValue(_T("Floor"), szFloor);

				szSQL.Format(_T("SELECT MAX(TRUNC_DATE(hpo_orderdate)) as maxorderdate, MIN(TRUNC_DATE(hpo_orderdate)) as minorderdate ") \
					_T(" FROM hms_medical_transaction_view ")\
					_T(" LEFT JOIN hms_ipharmaorder ON(hmt_orderid=hpo_orderid) ") \
					_T(" WHERE hmt_reftransaction_id=%ld"), nOID);
				//_fmsg(_T("%s"), szSQL);
				rsm.ExecSQL(szSQL);
				if (!rsm.IsEOF()) {
					rpt.GetReportHeader()->SetValue(_T("MaxOrderDate"), CDate::Convert(rsm.GetValue(_T("MaxOrderDate")), yyyymmdd, ddmmyyyy));
					rpt.GetReportHeader()->SetValue(_T("MinOrderDate"), CDate::Convert(rsm.GetValue(_T("MinOrderDate")), yyyymmdd, ddmmyyyy));
				}

			}


			//Page Header
			//Report Detail

			szSQL.Format(_T(" SELECT ") \
				_T(" 	product_id as id,") \
				_T(" 	product_name as name,") \
				_T(" 	product_uomname	as unit,") \
				_T("	sum(mtl_qtyorder) as qtyorder, ") \
				_T("	sum(mtl_qtysold) as qtysold, ") \
				_T("	sum(mtl_qtypolicy) as qtypolicy, ") \
				_T("	sum(mtl_qtysoldins) as qtysoldins, ") \
				_T("	sum(mtl_qtyotherins) as qtyotherins, ") \
				_T("	sum(mtl_qtyservice) as qtyservice, ") \
				_T("	sum(mtl_qtyother) as qtyother, ") \
				_T(" 	mtl_saleprice as price,") \
				_T(" 	sum(mtl_qtyorder*mtl_saleprice) as amount, ") \
				_T(" 	product_countryname as hpol_productcountry ") \
				_T(" FROM m_transactionline") \
				_T(" LEFT JOIN m_productitem_view ON(product_item_id=mtl_product_item_id)") \
				_T(" WHERE mtl_transaction_id=%ld AND product_producttype in(%s) ") \
				_T(" GROUP BY product_id, product_name, product_uomname, mtl_saleprice, product_countryname, product_uomindex %s "), nOID, szGroup, szOrderBy);
			//_msg(_T("%s"), szSQL);
			rs2.ExecSQL(szSQL);
			if (rs2.IsEOF()) {
				rst.MoveNext();
				continue;

			}
			CReportSection* rptDetail = rpt.GetDetail(0);
			rpt.ResetContent();
			nTotalItem = 1;
			nTotalAmount = 0;
			CString szItemId;
			while (!rs2.IsEOF())
			{
				rptDetail = rpt.AddDetail();
				rs2.GetValue(_T("id"), nProductID);
				if (szPrintType == _T("2"))
				{
					tmpStr.Format(_T("%d"), nTotalItem++);
					rptDetail->SetValue(_T("1"), tmpStr);
					rptDetail->SetValue(_T("12"), tmpStr);
					rs2.GetValue(_T("name"), tmpStr);
					rptDetail->SetValue(_T("2"), tmpStr);
					rptDetail->SetValue(_T("22"), tmpStr);
					rs2.GetValue(_T("unit"), tmpStr);
					rptDetail->SetValue(_T("3"), tmpStr);
					rptDetail->SetValue(_T("32"), tmpStr);
					rs2.GetValue(_T("qtyorder"), nQty);

					if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 || szGroup.Find(_T("'A2000'")) != -1)
						MoneyToString(ToString(nQty), szNote);
					else
						szNote.Empty();
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4"), tmpStr2);
					rptDetail->SetValue(_T("42"), tmpStr2);

					rs2.GetValue(_T("qtysold"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.1"), tmpStr2);

					rs2.GetValue(_T("qtypolicy"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.2"), tmpStr2);

					rs2.GetValue(_T("qtysoldins"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.3"), tmpStr2);
					rs2.GetValue(_T("qtyotherins"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.4"), tmpStr2);

					rs2.GetValue(_T("qtyservice"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.5"), tmpStr2);

					rs2.GetValue(_T("qtyother"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.6"), tmpStr2);


					rs2.GetValue(_T("Price"), tmpStr);
					FormatCurrencyStr(tmpStr, tmpStr2);
					rptDetail->SetValue(_T("5"), tmpStr2);
					rptDetail->SetValue(_T("52"), tmpStr2);
					rs2.GetValue(_T("amount"), nAmount);
					nTotalAmount += nAmount;

					FormatCurrency(nAmount, tmpStr2);
					rptDetail->SetValue(_T("7"), tmpStr2);
					rptDetail->SetValue(_T("72"), tmpStr2);

					rptDetail->SetValue(_T("6"), szNote);
					rptDetail->SetValue(_T("62"), szNote);

					rs2.GetValue(_T("price"), tmpStr);
					FormatCurrencyStr(tmpStr, tmpStr2);
					rptDetail->SetValue(_T("8"), tmpStr2);
					rptDetail->SetValue(_T("82"), tmpStr2);
					rs2.GetValue(_T("amount"), nAmountServ);
					nTotalAmountServ += nAmountServ;

					FormatCurrency(nAmountServ, tmpStr2);
					rptDetail->SetValue(_T("9"), tmpStr2);
					rptDetail->SetValue(_T("92"), tmpStr2);
				}
				else
				{
					tmpStr.Format(_T("%d"), nTotalItem++);
					rptDetail->SetValue(_T("1"), tmpStr);
					rs2.GetValue(_T("name"), tmpStr);
					rptDetail->SetValue(_T("2"), tmpStr);
					rs2.GetValue(_T("unit"), tmpStr);

					rptDetail->SetValue(_T("3"), tmpStr);
					rs2.GetValue(_T("qtyorder"), nQty);
					if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 || szGroup.Find(_T("'A2000'")) != -1)
						MoneyToString(ToString(nQty), szNote);
					else
						szNote.Empty();

					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4"), tmpStr2);

					rs2.GetValue(_T("qtysold"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.1"), tmpStr2);

					rs2.GetValue(_T("qtypolicy"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.2"), tmpStr2);

					rs2.GetValue(_T("qtysoldins"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.3"), tmpStr2);
					rs2.GetValue(_T("qtyotherins"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.4"), tmpStr2);

					rs2.GetValue(_T("qtyservice"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.5"), tmpStr2);

					rs2.GetValue(_T("qtyother"), nQty);
					FormatCurrency(nQty, tmpStr2);
					rptDetail->SetValue(_T("4.6"), tmpStr2);

					rs2.GetValue(_T("Price"), tmpStr);
					FormatCurrencyStr(tmpStr, tmpStr2);
					rptDetail->SetValue(_T("5"), tmpStr2);
					rs2.GetValue(_T("amount"), nAmount);
					nTotalAmount += nAmount;

					rs2.GetValue(_T("price"), tmpStr);
					FormatCurrencyStr(tmpStr, tmpStr2);
					rptDetail->SetValue(_T("8"), tmpStr2);
					rptDetail->SetValue(_T("82"), tmpStr2);
					rs2.GetValue(_T("amount"), nAmountServ);
					nTotalAmountServ += nAmountServ;

					FormatCurrency(nAmountServ, tmpStr2);
					rptDetail->SetValue(_T("9"), tmpStr2);
					rptDetail->SetValue(_T("92"), tmpStr2);

					rptDetail->SetValue(_T("6"), szNote);
				}

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 || szGroup.Find(_T("'A2000'")) != -1)
				{
					//Neu bo sung tu truc
					if (szType == _T("CSO"))
					{
						szSQL.Format(_T(" SELECT 	hmt_docno as docno,") \
							_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
							_T(" 	sum(hmt_qtyissue) as orderqty") \
							_T(" FROM hms_medical_transaction_view") \
							_T(" LEFT JOIN hms_doc ON(hd_docno=hmt_docno)") \
							_T(" LEFT JOIN hms_patient ON(hp_patientno=hd_patientno)") \
							_T(" WHERE hmt_reftransaction_id=%ld ") \
							_T(" and (hmt_suppproduct_id=%ld or hmt_product_id=%ld) ") \
							_T(" GROUP BY hmt_docno, hp_firstname, hp_midname, hp_surname ") \
							_T(" ORDER BY pname"), nOID, nProductID, nProductID);

					}
					else
					{
						szSQL.Format(_T(" SELECT 	hpo_docno as docno,") \
							_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
							_T(" 	sum(hpol_qtyissue) as orderqty") \
							_T(" FROM hms_ipharmaorder") \
							_T(" LEFT JOIN hms_ipharmaorderline ON(hpo_orderid=hpol_orderid)") \
							_T(" LEFT JOIN hms_patient ON(hp_patientno=hpo_patientno)") \
							_T(" WHERE hpo_transaction_id=%ld AND hpol_product_id=%ld ") \
							_T(" GROUP BY hpo_docno, hp_firstname, hp_midname, hp_surname ") \
							_T(" ORDER BY pname"), nOID, nProductID);
					}
					rsp.ExecSQL(szSQL);
					while (!rsp.IsEOF()) {
						rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
						/*
												rptDetail->GetItem(_T("1"))->SetItalic(true);
												rptDetail->GetItem(_T("2"))->SetItalic(true);
												rptDetail->GetItem(_T("3"))->SetItalic(true);
												rptDetail->GetItem(_T("4"))->SetItalic(true);
												rptDetail->GetItem(_T("5"))->SetItalic(true);
												rptDetail->GetItem(_T("6"))->SetItalic(true);
						*/
						rptDetail->SetValue(_T("1"), _T(""));
						rsp.GetValue(_T("pname"), tmpStr);
						rptDetail->SetValue(_T("2"), tmpStr);
						rsp.GetValue(_T("docno"), tmpStr);
						rptDetail->SetValue(_T("3"), tmpStr);
						rsp.GetValue(_T("orderqty"), nQty);
						FormatCurrency(nQty, tmpStr);
						rptDetail->SetValue(_T("4"), tmpStr);
						rptDetail->SetValue(_T("5"), _T(""));
						MoneyToString(ToString(nQty), szNote);
						rptDetail->SetValue(_T("6"), szNote);
						if (szPrintType == _T("2")) {
							/*
														rptDetail->GetItem(_T("12"))->SetItalic(true);
														rptDetail->GetItem(_T("22"))->SetItalic(true);
														rptDetail->GetItem(_T("32"))->SetItalic(true);
														rptDetail->GetItem(_T("42"))->SetItalic(true);
														rptDetail->GetItem(_T("52"))->SetItalic(true);
														rptDetail->GetItem(_T("62"))->SetItalic(true);
							  */
							rptDetail->SetValue(_T("12"), _T(""));
							rsp.GetValue(_T("pname"), tmpStr);
							rptDetail->SetValue(_T("22"), tmpStr);
							rsp.GetValue(_T("docno"), tmpStr);
							rptDetail->SetValue(_T("32"), tmpStr);
							rsp.GetValue(_T("orderqty"), nQty);
							FormatCurrency(nQty, tmpStr);
							rptDetail->SetValue(_T("42"), tmpStr);
							rptDetail->SetValue(_T("52"), _T(""));
							MoneyToString(ToString(nQty), szNote);
							rptDetail->SetValue(_T("62"), szNote);
						}
						rsp.MoveNext();
					}
				}
				rs2.MoveNext();
			}
			//Page Footer
			//Report Footer
			if (szPrintType == _T("2"))
			{
				tmpStr.Format(_T("%d"), nTotalItem - 1);
				rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
				rpt.GetReportFooter()->SetValue(_T("TotalItem2"), tmpStr);
				tmpStr.Format(_T("%.0f"), nTotalAmount);
				FormatCurrencyStr(tmpStr, tmpStr2);
				rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr2);
				rpt.GetReportFooter()->SetValue(_T("TotalAmount2"), tmpStr2);

				MoneyToString(tmpStr, tmpStr2);
				rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr2);

				CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
				if (img)
				{
					//			img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
					//			img->SetFixedHeight(false);
				}

				rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

				CReportItem* img2 = rpt.GetReportFooter()->GetItem(_T("Signature2"));
				if (img2)
				{
					//img2->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
					img2->SetFixedHeight(false);
				}

				rpt.GetReportFooter()->SetValue(_T("DoctorName2"), GetDoctorName(szSendBy));


				tmpStr = pMF->GetSysDate();
				szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
				rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
				rpt.GetReportFooter()->SetValue(_T("PrintDate2"), szDate);
				//	rpt.Print(bDirect);
				//	bDirect=true;
				rpt.PrintPreview();
			}
			else
			{
				tmpStr.Format(_T("%d"), nTotalItem - 1);
				rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
				tmpStr.Format(_T("%.0f"), nTotalAmount);
				FormatCurrencyStr(tmpStr, tmpStr2);
				rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr2);

				MoneyToString(tmpStr, tmpStr2);
				rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr2);

				CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
				if (img)
				{
					//				img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
					img->SetFixedHeight(false);
				}
				rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

				tmpStr = pMF->GetSysDate();
				szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
				rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
				rpt.Print(bDirect);
				bDirect = true;
				rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("2"));
				rpt.Print(bDirect);
			}

			rst.MoveNext();
		}
	}
	else if (szType == _T("CRO"))
		PrintDRO(nOID);
	else
	{
		if (!rpt.Init(szReportName))
			return;
		//Report Header
		rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
		rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
		rs.GetValue(_T("mt_orderdate"), tmpStr);
		szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);
		rpt.GetReportHeader()->SetValue(_T("OrderID"), szID);
		rs.GetValue(_T("mt_storage_name"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("FromStock"), tmpStr);
		rs.GetValue(_T("mt_storage_to_name"), tmpStr);
		if (!tmpStr.IsEmpty())
			rpt.GetReportHeader()->SetValue(_T("ToStock"), tmpStr);

		rs.GetValue(_T("mt_department_to_name"), tmpStr);
		if (!tmpStr.IsEmpty())
			rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
		tmpStr.Empty();
		rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

		rs.GetValue(_T("mt_department_to_name"), tmpStr);
		if (!tmpStr.IsEmpty())
			rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

		rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

		rpt.GetReportHeader()->SetValue(_T("Floor"), szFloor);
		rpt.GetReportHeader()->SetValue(_T("Floor2"), szFloor);

		szSQL.Format(_T("SELECT MAX(TRUNC_DATE(hpo_orderdate)) as maxorderdate, MIN(TRUNC_DATE(hpo_orderdate)) as minorderdate ") \
			_T(" FROM hms_medical_transaction_view ")\
			_T(" LEFT JOIN hms_ipharmaorder ON(hmt_orderid=hpo_orderid) ") \
			_T(" WHERE hmt_reftransaction_id=%ld"), nOID);
		//_fmsg(_T("%s"), szSQL);
		rsm.ExecSQL(szSQL);
		if (!rsm.IsEOF()) {
			rpt.GetReportHeader()->SetValue(_T("MaxOrderDate"), CDate::Convert(rsm.GetValue(_T("MaxOrderDate")), yyyymmdd, ddmmyyyy));
			rpt.GetReportHeader()->SetValue(_T("MinOrderDate"), CDate::Convert(rsm.GetValue(_T("MinOrderDate")), yyyymmdd, ddmmyyyy));
		}

		//Page Header
		//Report Detail
		szSQL.Format(_T(" SELECT product_id                     AS id,") \
			_T("   product_name                        AS name,") \
			_T("   product_uomname                    AS unit,") \
			_T("	sum(mtl_qtyorder) as qtyorder, ") \
			_T("	sum(mtl_qtysold) as qtysold, ") \
			_T("	sum(mtl_qtypolicy) as qtypolicy, ") \
			_T("	sum(mtl_qtysoldins) as qtysoldins, ") \
			_T("	sum(mtl_qtyotherins) as qtyotherins, ") \
			_T("	sum(mtl_qtyservice) as qtyservice, ") \
			_T("	sum(mtl_qtyother) as qtyother, ") \
			_T("   mtl_saleprice                   AS price,") \
			_T("   SUM(mtl_qtyorder*mtl_saleprice) AS amount,") \
			_T("   product_countryname                AS hpol_productcountry") \
			_T(" FROM m_transactionline") \
			_T(" LEFT JOIN m_productitem_view") \
			_T(" ON(product_item_id      =mtl_product_item_id)") \
			_T(" WHERE mtl_transaction_id=%ld ") \
			_T(" GROUP BY product_id,") \
			_T("   product_name,") \
			_T("   product_uomname,") \
			_T("   mtl_saleprice,") \
			_T("   product_countryname") \
			_T(" ORDER BY name,  unit, price"), nOID, szOrderBy);

		rs2.ExecSQL(szSQL);

		CReportSection* rptDetail = rpt.GetDetail(0);
		while (!rs2.IsEOF())
		{
			rptDetail = rpt.AddDetail();
			tmpStr.Format(_T("%d"), nTotalItem++);
			rptDetail->SetValue(_T("1"), tmpStr);
			rs2.GetValue(_T("name"), tmpStr);
			rptDetail->SetValue(_T("2"), tmpStr);
			rs2.GetValue(_T("unit"), tmpStr);

			rptDetail->SetValue(_T("3"), tmpStr);

			rs2.GetValue(_T("qty"), nQty);
			FormatCurrency(nQty, tmpStr2);

			FormatCurrency(nQty, tmpStr2);
			rptDetail->SetValue(_T("4"), tmpStr2);

			rs2.GetValue(_T("qtysold"), nQty);
			FormatCurrency(nQty, tmpStr2);
			rptDetail->SetValue(_T("4.1"), tmpStr2);

			rs2.GetValue(_T("qtypolicy"), nQty);
			FormatCurrency(nQty, tmpStr2);
			rptDetail->SetValue(_T("4.2"), tmpStr2);

			rs2.GetValue(_T("qtysoldins"), nQty);
			FormatCurrency(nQty, tmpStr2);
			rptDetail->SetValue(_T("4.3"), tmpStr2);
			rs2.GetValue(_T("qtyotherins"), nQty);
			FormatCurrency(nQty, tmpStr2);
			rptDetail->SetValue(_T("4.4"), tmpStr2);

			rs2.GetValue(_T("qtyservice"), nQty);
			FormatCurrency(nQty, tmpStr2);
			rptDetail->SetValue(_T("4.5"), tmpStr2);

			rs2.GetValue(_T("qtyother"), nQty);
			FormatCurrency(nQty, tmpStr2);
			rptDetail->SetValue(_T("4.6"), tmpStr2);

			rs2.GetValue(_T("Price"), tmpStr);
			FormatCurrencyStr(tmpStr, tmpStr2);
			rptDetail->SetValue(_T("5"), tmpStr2);
			rs2.GetValue(_T("amount"), nAmount);
			nTotalAmount += nAmount;
			tmpStr.Empty();
			rptDetail->SetValue(_T("6"), tmpStr);
			rs2.MoveNext();
		}
		//Page Footer
		//Report Footer
		tmpStr.Format(_T("%d"), nTotalItem - 1);
		rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
		if (nPrintStorage == 1)
			tmpStr.Format(_T("%.0f"), nTotalAmountServ);
		else
			tmpStr.Format(_T("%.0f"), nTotalAmount);
		FormatCurrencyStr(tmpStr, tmpStr2);
		rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr2);


		MoneyToString(tmpStr, tmpStr2);
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr2);

		tmpStr = pMF->GetSysDate();
		szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);


		CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
		if (img)
		{
			//		img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
			img->SetFixedHeight(false);
		}
		rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

		/*
				CReportItem *img = rpt.GetReportFooter()->GetItem(_T("Signature"));
				if(img)
				{
					img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
					img->SetFixedHeight(false);
				}
		*/
		rpt.PrintPreview();
		//rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("2"));
		//rpt.Print(bDirect);

	}
}

void CPrintForms::PM_PrintCabinetSheet(long nOID)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rsReport(&pMF->m_db);
	CRecord rs(&pMF->m_db);
	CRecord rsm(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CString tmpStr, tmpStr2, szDate, szSQL, szDesc, szOrderBy;
	CString szFloor;
	int nStorage_id = 0;
	CString szID, szBarCodeID;
	//_msg(_T("Chào bạn lộc"));

	szID.Format(_T("%ld"), nOID);

	double	nTotalAmount = 0, nAmount = 0, nAmountServ = 0, nTotalAmountServ = 0, nQty = 0;
	int		nTotalItem = 1;
	CString szPrintStorage;
	int		nPrint = 0;
	bool bDirect = false;
	long nStorageToID = 0;
	szOrderBy.Format(_T(" ORDER BY name, unit, price "));
	szSQL.Format(_T("SELECT mt_orderno, mt_orderdate, mt_approveddate, mt_postedby, mt_storage_id, mt_storage_to_id as storage_to,") \
		_T(" get_storagename(mt_storage_id) as mt_storage_name, ") \
		_T(" get_storagename(mt_storage_to_id) as mt_storageto_name, ") \
		_T(" get_departmentname(mt_department_id) as mt_department_name, ") \
		_T(" get_departmentname(mt_department_to_id) as mt_departmentto_name, ") \
		_T(" mt_doctype, mt_description ") \
		_T("FROM m_transaction ") \
		_T("WHERE mt_transaction_id=%ld "), nOID);
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
		return;
	CString szType, szReportName, szSendBy;
	rs.GetValue(_T("mt_doctype"), szType);
	rs.GetValue(_T("mt_orderno"), szID);
	rs.GetValue(_T("mt_orderno"), szBarCodeID);
	rs.GetValue(_T("storage_to"), nStorageToID);
	szOrderBy.Format(_T(" ORDER BY product_uomindex, product_name, product_uomname "));

	rs.GetValue(_T("mt_postedby"), szSendBy);
	rs.GetValue(_T("mt_description"), szDesc);


	rs.GetValue(_T("mt_floor"), tmpStr);
	//szFloor = pMF->GetSelectionString(_T("hms_floor"), tmpStr);
	szFloor.Empty();


	if (szType == _T("DPO") || szType == _T("DMO") || szType == _T("DDO") || szType == _T("CSO"))
	{
		CRecord rst(&pMF->m_db);
		CRecord rsp(&pMF->m_db);
		CString szGroup, szTitle, szPrintType, szNote;
		szSQL.Format(_T(" SELECT DISTINCT pmdt_id, pmdt_name,") \
			_T("   pmdt_desc,") \
			_T("   pmdt_reportname, pmdt_index,pmdt_printtype  ") \
			_T(" FROM pms_drugtype,") \
			_T("   m_transactionline,") \
			_T("   m_productitem_view") \
			_T(" WHERE mtl_transaction_id =%ld") \
			_T(" AND mtl_product_item_id  =product_item_id") \
			_T(" AND instr(pmdt_desc, product_producttype) > 0") \
			_T(" ORDER BY pmdt_index "), nOID);
		rst.ExecSQL(szSQL);
		//_msg(_T("%s"), szSQL);
		while (!rst.IsEOF())
		{
			rst.GetValue(_T("pmdt_name"), tmpStr);
			StringUpper(tmpStr, szTitle);
			rst.GetValue(_T("pmdt_desc"), szGroup);
			szGroup.Trim();
			rst.GetValue(_T("pmdt_printtype"), szPrintType);


			//Kiem tra neu la kho thiet lap cho doi tuong DICH VU thi goi mau rieng
			rs.GetValue(_T("mt_storage_id"), nStorage_id);
			//szSQL.Format(_T(" SELECT msd_printtype FROM m_storage_default WHERE msd_storage_id = %d "), nStorage_id);
			szSQL.Format(_T("SELECT msl_category FROM m_storagelist WHERE msl_storage_id = %d"), nStorage_id);
			rsReport.ExecSQL(szSQL);
			//_msg(_T("%s"), szSQL);

			szPrintStorage = rsReport.GetStringValue();

			tmpStr = _T("PMS_BOSUNGTUTRUC");
			//if (pMF->GetModuleID() != _T("SOM"))
			{
				if (szPrintStorage == _T("I"))
					tmpStr += _T("_BH");
				else if (szPrintStorage == _T("S"))
					tmpStr += _T("_DV");
				else if (szPrintStorage == _T("P"))
					tmpStr += _T("_QUAN");
				rst.GetValue(_T("pmdt_id"), tmpStr2);
				if (tmpStr2 == _T("YC") || tmpStr2 == _T("VT"))
					tmpStr += _T("TB");
				else if (tmpStr2 == _T("GN") || tmpStr2 == _T("HT"))
					tmpStr += _T("GNHT");
				else if (tmpStr2 == _T("HH"))
					tmpStr += _T("_HC");
			}
			szReportName.Format(_T("Reports/HMS/%s.RPT"), tmpStr);
			//_msg(_T("%s, %s"), szSQL, szReportName);

			if (!rpt.Init(szReportName))
				return;

			//Report Header
			rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
			rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
			rpt.GetReportHeader()->Format(_T("TITLE"), szTitle);

			rs.GetValue(_T("mt_orderdate"), tmpStr);
			szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);

			rpt.GetReportHeader()->SetValue(_T("OrderID"), szID);
			rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), szBarCodeID);
			rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), szBarCodeID);
			rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), szBarCodeID);
			rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), szBarCodeID);
			rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), szBarCodeID);

			rs.GetValue(_T("mt_statusdesc"), tmpStr);
			//tmpStr = GetStatusString(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
			rs.GetValue(_T("mt_storage_name"), tmpStr);
			//tmpStr = GetStorageName(ToInt(tmpStr));
			rpt.GetReportHeader()->SetValue(_T("FromStock"), tmpStr);
			rpt.GetReportHeader()->SetValue(_T("Comment"), szDesc);

			rs.GetValue(_T("mt_storageto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("ToStock"), tmpStr);

			rs.GetValue(_T("mt_department_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

			rs.GetValue(_T("mt_departmentto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
			{
				//tmpStr = GetDepartmentName(tmpStr);
				tmpStr.Append(_T(" - "));
				tmpStr.Append(rs.GetValue(_T("mt_storageto_name")));
				rpt.GetReportHeader()->SetValue(_T("DepartmentTo"), tmpStr);
			}
			tmpStr.Empty();
			rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

			rpt.GetReportHeader()->SetValue(_T("Floor"), szFloor);

			szSQL.Format(_T("SELECT MAX(TRUNC_DATE(hpo_orderdate)) as maxorderdate, MIN(TRUNC_DATE(hpo_orderdate)) as minorderdate ") \
				_T(" FROM hms_medical_transaction_view ")\
				_T(" LEFT JOIN hms_ipharmaorder ON(hmt_orderid=hpo_orderid) ") \
				_T(" WHERE hmt_reftransaction_id=%ld"), nOID);
			_fmsg(_T("%s"), szSQL);
			rsm.ExecSQL(szSQL);
			if (!rsm.IsEOF()) {
				rpt.GetReportHeader()->SetValue(_T("MaxOrderDate"), CDate::Convert(rsm.GetValue(_T("MaxOrderDate")), yyyymmdd, ddmmyyyy));
				rpt.GetReportHeader()->SetValue(_T("MinOrderDate"), CDate::Convert(rsm.GetValue(_T("MinOrderDate")), yyyymmdd, ddmmyyyy));
			}
			//Page Header
			//Report Detail
			szSQL.Format(_T(" SELECT ") \
				_T(" 	product_id as id,") \
				_T(" mtl_xproduct_id as xproduct_id, ") \
				_T(" 	product_name as name,") \
				_T(" 	product_uomname	as unit,") \
				_T("	sum(mtl_qtydelivery) as qtyrealorder, ") \
				_T("	sum(mtl_qtysold) as qtysold, ") \
				_T("	sum(mtl_qtypolicy) as qtypolicy, ") \
				_T("	sum(mtl_qtysoldins) as qtysoldins, ") \
				_T("	sum(mtl_qtyotherins) as qtyotherins, ") \
				_T("	sum(mtl_qtyservice) as qtyservice, ") \
				_T("	sum(mtl_qtyother) as qtyother, ") \
				_T("	sum(mtl_qtyorder) qtyorder,") \
				_T(" 	mtl_saleprice as price,") \
				_T(" 	sum(mtl_qtyorder*mtl_saleprice) as amount, ") \
				_T(" 	product_countryname as hpol_productcountry ") \
				_T(" FROM m_transactionline") \
				_T(" LEFT JOIN m_productitem_view ON(product_item_id=mtl_product_item_id)") \
				_T(" WHERE mtl_transaction_id=%ld ") \
				_T(" AND product_producttype in(%s) ") \
				_T(" and nvl(mtl_client_id,'XXX') <> 'REP' ") \
				_T(" GROUP BY product_id, mtl_xproduct_id, product_name, product_uomname, mtl_saleprice, product_countryname, product_uomindex ") \
				_T(" %s "), nOID, szGroup, szOrderBy);
			rs2.ExecSQL(szSQL);
			//_msg(_T("%s"), szSQL);

			if (rs2.IsEOF())
			{
				rst.MoveNext();
				continue;

			}
			CReportSection* rptDetail = rpt.GetDetail(0);
			rpt.ResetContent();
			nTotalItem = 1;
			nTotalAmount = 0;
			CString szItemId;
			long nProductID, nXProductID;
			CString szName, szName2;
			CRecord rsx(&pMF->m_db);
			while (!rs2.IsEOF())
			{
				rptDetail = rpt.AddDetail();
				rs2.GetValue(_T("id"), nProductID);
				tmpStr.Format(_T("%d"), nTotalItem++);
				rptDetail->SetValue(_T("1"), tmpStr);
				rs2.GetValue(_T("name"), szName);
				rs2.GetValue(_T("id"), nProductID);
				rs2.GetValue(_T("xproduct_id"), nXProductID);
				if (nProductID != nXProductID)
				{
					tmpStr.Format(_T("SELECT mp_name FROM m_product WHERE mp_product_id = %ld "), nXProductID);
					rsx.ExecSQL(tmpStr);
					rsx.GetValue(_T("mp_name"), szName2);
					szName.AppendFormat(_T(" [%s] "), szName2);
				}
				rptDetail->SetValue(_T("2"), szName);
				rs2.GetValue(_T("unit"), tmpStr);
				rptDetail->SetValue(_T("3"), tmpStr);
				rs2.GetValue(_T("qtyorder"), nQty);

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 || szGroup.Find(_T("'A2000'")) != -1)
					MoneyToString(ToString(nQty), szNote);
				else
					szNote.Empty();
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4"), tmpStr2);
				rs2.GetValue(_T("qtysold"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.1"), tmpStr2);

				rs2.GetValue(_T("qtypolicy"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.2"), tmpStr2);

				rs2.GetValue(_T("qtysoldins"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.3"), tmpStr2);

				rs2.GetValue(_T("qtyotherins"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.4"), tmpStr2);

				rs2.GetValue(_T("qtyservice"), nQty);

				/*if (nStorageToID == 98 || nStorageToID ==15012)
				{
					rs2.GetValue(_T("qtyorder"), nQty);
				}*/
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.5"), tmpStr2);

				rs2.GetValue(_T("qtyother"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.6"), tmpStr2);

				rs2.GetValue(_T("qtyrealorder"), tmpStr);
				FormatCurrencyStr(tmpStr, tmpStr2);
				rptDetail->SetValue(_T("5"), tmpStr2);

				rs2.GetValue(_T("amount"), nAmount);
				nTotalAmount += nAmount;

				FormatCurrency(nAmount, tmpStr2);
				rptDetail->SetValue(_T("7"), tmpStr2);

				rptDetail->SetValue(_T("6"), szNote);

				rs2.GetValue(_T("price"), tmpStr);
				FormatCurrencyStr(tmpStr, tmpStr2);
				rptDetail->SetValue(_T("8"), tmpStr2);
				rs2.GetValue(_T("amount"), nAmountServ);
				nTotalAmountServ += nAmountServ;

				FormatCurrency(nAmountServ, tmpStr2);
				rptDetail->SetValue(_T("9"), tmpStr2);

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 || szGroup.Find(_T("'A2000'")) != -1)
				{
					szSQL.Format(_T(" SELECT 	hmt_docno as docno,") \
						_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
						_T(" 	sum(hmt_qtyissue) as orderqty") \
						_T(" FROM hms_medical_transaction_view") \
						_T(" LEFT JOIN hms_doc ON(hd_docno=hmt_docno)") \
						_T(" LEFT JOIN hms_patient ON(hp_patientno=hd_patientno)") \
						_T(" WHERE hmt_reftransaction_id=%ld ") \
						_T(" and hmt_product_id=%ld ") \
						_T(" GROUP BY hmt_docno, hp_firstname, hp_midname, hp_surname ") \
						_T(" ORDER BY pname"), nOID, nProductID);
					rsp.ExecSQL(szSQL);
					while (!rsp.IsEOF()) {
						rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
						/*
												rptDetail->GetItem(_T("1"))->SetItalic(true);
												rptDetail->GetItem(_T("2"))->SetItalic(true);
												rptDetail->GetItem(_T("3"))->SetItalic(true);
												rptDetail->GetItem(_T("4"))->SetItalic(true);
												rptDetail->GetItem(_T("5"))->SetItalic(true);
												rptDetail->GetItem(_T("6"))->SetItalic(true);
						*/
						rptDetail->SetValue(_T("1"), _T(""));
						rsp.GetValue(_T("pname"), tmpStr);
						rptDetail->SetValue(_T("2"), tmpStr);
						rsp.GetValue(_T("docno"), tmpStr);
						rptDetail->SetValue(_T("3"), tmpStr);
						rsp.GetValue(_T("orderqty"), nQty);
						FormatCurrency(nQty, tmpStr);
						rptDetail->SetValue(_T("4"), tmpStr);
						rptDetail->SetValue(_T("5"), _T(""));
						MoneyToString(ToString(nQty), szNote);
						rptDetail->SetValue(_T("6"), szNote);
						/*
												rptDetail->GetItem(_T("12"))->SetItalic(true);
												rptDetail->GetItem(_T("22"))->SetItalic(true);
												rptDetail->GetItem(_T("32"))->SetItalic(true);
												rptDetail->GetItem(_T("42"))->SetItalic(true);
												rptDetail->GetItem(_T("52"))->SetItalic(true);
												rptDetail->GetItem(_T("62"))->SetItalic(true);
						*/
						rsp.MoveNext();
					}
				}
				rs2.MoveNext();
			}
			//Page Footer
			//Report Footer
			tmpStr.Format(_T("%d"), nTotalItem - 1);
			rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
			tmpStr.Format(_T("%.0f"), nTotalAmount);
			FormatCurrencyStr(tmpStr, tmpStr2);
			rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr2);

			MoneyToString(tmpStr, tmpStr2);
			rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr2);

			CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
			if (img)
			{
				//			img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
				//			img->SetFixedHeight(false);
			}

			rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

			tmpStr = pMF->GetSysDate();
			szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
			rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
			//	rpt.Print(bDirect);
			//	bDirect=true;
			rpt.PrintPreview();
			rst.MoveNext();
		}
	}
}





void CPrintForms::PM_PrintExportCabinetSheet(long nOID)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CString szSQL, szOrderBy;
	CRecord rs(&pMF->m_db);
	CRecord rst(&pMF->m_db);




	CReport rpt;
	CString tmpStr, szAmount;
	CString szDate, szSysDate;
	CString szDocType, szGroup, szStorageCategory;

	szSQL.Format(_T(" SELECT DISTINCT pmdt_id, pmdt_name,") \
		_T("   pmdt_desc,") \
		_T("   pmdt_reportname, pmdt_index,pmdt_printtype  ") \
		_T(" FROM pms_drugtype,") \
		_T("   m_transactionline,") \
		_T("   m_productitem_view") \
		_T(" WHERE mtl_transaction_id =%ld") \
		_T(" AND mtl_product_item_id  =product_item_id") \
		_T(" AND instr(pmdt_desc, product_producttype) > 0") \
		_T(" ORDER BY pmdt_index "), nOID);
	rst.ExecSQL(szSQL);
	while (!rst.IsEOF())
	{

		rst.GetValue(_T("pmdt_desc"), szGroup);

		szSQL.Format(
			_T(" SELECT  mt_transaction_id as invoiceid,") \
			_T("	mt_orderno as invoiceno,") \
			_T("  	mt_posteddate as issuedate ,") \
			_T("  	mt_orderdate as invoicedate,") \
			_T(" 	GET_STORAGENAME(mt_storage_id) as storagename,	") \
			_T("  	GET_STORAGENAME(mt_storage_to_id) as storagename_to,") \
			_T("  	GET_DEPARTMENTNAME(mt_department_id) as department,") \
			_T("  	GET_SYSSEL_DESC('pms_export_type', mt_exptype) as exptype,") \
			_T("  	GET_USERNAME(mt_deliveryby) as deliverer,") \
			_T("  	GET_USERNAME(mt_receiveby) as receiver, ") \
			_T("	mt_description as note, ") \
			_T("	mt_status as status, ") \
			_T("	mt_doctype as doctype, ") \
			_T("	(select msl_category from m_storagelist where msl_storage_id = mt_storage_id) storage_category,") \
			_T("	mt_documentno documentno") \
			_T(" FROM m_transaction") \
			_T(" WHERE mt_transaction_id=%ld  "), nOID);

		rs.ExecSQL(szSQL);
		if (rs.IsEOF())
			return;

		CString szPath, szFileTitle;
		if (pMF->GetModuleID() == _T("PM") || pMF->GetModuleID() == _T("BB"))
		{
			szFileTitle = _T("PMS_STORAGEEXPORT");
		}
		else
		{
			szFileTitle.Format(_T("%s_STORAGEEXPORT"), pMF->GetModuleID());
		}
		szPath.Format(_T("Reports/HMS/%s.RPT"), szFileTitle);
		if (!rpt.Init(szPath))
			return;

		//_msg(_T("ECS"));
		rs.GetValue(_T("storage_category"), szStorageCategory);
		rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
		rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
		rs.GetValue(_T("InvoiceNo"), tmpStr);

		rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);

		rs.GetValue(_T("invoicedate"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("IssueDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

		szSysDate = pMF->GetSysDate();
		szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
		rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);
		rs.GetValue(_T("doctype"), szDocType);
		tmpStr.Empty();

		rs.GetValue(_T("storagename"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("StockName"), tmpStr);
		rs.GetValue(_T("storagename_to"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("StockName1"), tmpStr);

		rs.GetValue(_T("Department"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

		rs.GetValue(_T("note"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Comment"), tmpStr);
		rs.GetValue(_T("deliverer"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("deliverer"), tmpStr);
		rs.GetValue(_T("receiver"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("receiver"), tmpStr);

		tmpStr.Empty();
		//pMF->GetStatusString(rs.GetValue(_T("status")), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
		if (pMF->GetModuleID() == _T("MA"))
			rpt.GetReportHeader()->SetValue(_T("ReferenceNo"), rs.GetValue(_T("documentno")));
		//Page Header
		//Report Detail

		int nCount = 0;
		int nQty = 0;
		double dMoney = 0;
		double nTotalAmount = 0;

		CString szMoney, szExprDate;
		szSQL.Format(_T(" SELECT product_id as id,") \
			_T(" mtl_xproduct_id as xproduct_id, ") \
			_T("        product_name AS name,") \
			_T("        product_uomname AS unit,") \
			_T("        product_expdate AS expdate,") \
			_T("        product_lotno AS lotno,") \
			_T("        SUM(mtl_qtyorder) AS qtyorder,") \
			_T("        SUM(mtl_qtydelivery) AS qtyissue,") \
			_T("        mtl_saleprice AS price,") \
			_T("        SUM(mtl_qtyorder*mtl_saleprice) AS orderamount,") \
			_T("        SUM(mtl_qtydelivery*mtl_saleprice) AS issueamount") \
			_T(" FROM m_transactionline") \
			_T(" LEFT JOIN m_productitem_view ON(mtl_product_item_id=product_item_id)") \
			_T(" WHERE mtl_transaction_id=%ld and mtl_qtydelivery > 0 ") \
			_T(" AND product_producttype in(%s) ") \
			_T(" GROUP BY product_uomindex, product_id, product_name, product_uomname,") \
			_T("          product_expdate, product_lotno, mtl_xproduct_id, ") \
			_T("          mtl_saleprice, mtl_line ORDER BY product_uomindex, product_name, product_uomname "),
			nOID, szGroup);

		//_msg(_T("%s"), szSQL);

		rs.ExecSQL(szSQL);
		CReportSection* rptDetail = rpt.GetDetail(0);
		long nProductID, nXProductID;
		CString szName;
		CRecord rsx(&pMF->m_db);
		while (!rs.IsEOF())
		{
			rptDetail = rpt.AddDetail();

			nCount++;

			tmpStr.Format(_T("%d"), nCount);
			rptDetail->SetValue(_T("1"), tmpStr);
			rs.GetValue(_T("id"), nProductID);
			rs.GetValue(_T("xproduct_id"), nXProductID);
			szName.Empty();
			rs.GetValue(_T("name"), szName);
			if (nProductID != nXProductID)
			{
				CString szName2;
				tmpStr.Format(_T("SELECT mp_name FROM m_Product where mp_product_id = %ld"), nXProductID);
				rsx.ExecSQL(tmpStr);
				rsx.GetValue(_T("mp_name"), szName2);

				szName.AppendFormat(_T(" [%s]"), szName2);
			}

			rptDetail->SetValue(_T("2"), szName);

			rs.GetValue(_T("id"), tmpStr);
			rptDetail->SetValue(_T("3"), tmpStr);

			rs.GetValue(_T("unit"), tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);

			rs.GetValue(_T("expdate"), tmpStr);
			szExprDate = CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy);
			rptDetail->SetValue(_T("5"), szExprDate);

			rs.GetValue(_T("lotno"), tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			rs.GetValue(_T("qtyorder"), tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			rs.GetValue(_T("qtyissue"), tmpStr);
			rptDetail->SetValue(_T("11"), tmpStr);

			rs.GetValue(_T("price"), dMoney);
			FormatCurrency(dMoney, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			rs.GetValue(_T("issueamount"), dMoney);
			nTotalAmount += dMoney;
			FormatCurrency(dMoney, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			rs.MoveNext();
		}
		//Page Footer

		//Report Footer
		tmpStr.Format(_T("%d"), nCount);
		CReportSection* rptFooter = rpt.GetReportFooter();
		rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
		FormatCurrency(nTotalAmount, szAmount);
		rpt.GetReportFooter()->SetValue(_T("SubTotal"), szAmount);
		szAmount.Format(_T("%.2f"), nTotalAmount);
		MoneyToString(szAmount, tmpStr);
#ifdef UNICODE
		tmpStr += _T(" \x111\x1ED3ng.");
#endif
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);

		GetDoctorName(pMF->GetCurrentUser());
		OnPrintFooterUser(rptFooter, szStorageCategory == _T("S") ? _T("DV") : _T("BH"), _T("'ng_giao', 'ng_nhan'"));
		rpt.PrintPreview();
		rst.MoveNext();

	}
}




void CPrintForms::PrintPurchaseReturnOrder(long nOrderID, CString szFilter){
	CGuiMainFrame *pMF = (CGuiMainFrame*) AfxGetMainWnd();
	CReport rpt;
	CString szSQL, szWhere, tmpStr, szOrderDate, szDeliver, szReceiver, szFilePath, szFileTitle;
	CRecord rs(&pMF->m_db);
	CReportSection *rptHeader, *rptDetail, *rptFooter;
	int nIdx = 0;
	double nS6 = 0, nS8 = 0;
	szFileTitle.Format(_T("%s_HANGMUATRALAI"), pMF->GetModuleID());
	szFilePath.Format(_T("Reports\\HMS\\%s.RPT"), szFileTitle);
	if (!rpt.Init(szFilePath))
		return;
	szWhere.AppendFormat(_T(" AND %s"), szFilter);
	szSQL.Format(_T(" SELECT") \
				_T("   mt_orderno       AS orderno,") \
				_T("   trunc(mt_orderdate) as orderdate,") \
				_T("   mt_deliveryby    AS deliver,") \
				_T("   mt_receiveby		AS receiver,") \
				_T("   trunc(mt_approveddate)  AS dte,") \
				_T("   get_storagename(mt_storage_id) AS stock,") \
				_T("   get_departmentname(mt_department_id) as dept,") \
				_T("   get_partnername(mt_partner_id) AS partner,") \
				_T("   mt_description   AS descr") \
				_T(" FROM   m_transaction") \
				_T(" WHERE mt_transaction_id = %ld"), nOrderID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"), MB_ICONASTERISK | MB_OK);
		return;
	}
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("dept"), rs.GetValue(_T("dept")));
	rptHeader->SetValue(_T("Invoiceno"), rs.GetValue(_T("orderno")));
	rs.GetValue(_T("deliver"), szDeliver);
	rs.GetValue(_T("receiver"), szReceiver);
	rptHeader->SetValue(_T("StockName"), rs.GetValue(_T("stock")));
	rptHeader->SetValue(_T("Reason"), rs.GetValue(_T("descr")));
	rs.GetValue(_T("orderdate"), szOrderDate);
	rs.GetValue(_T("dte"), tmpStr);
	rptHeader->SetValue(_T("ReturnDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("SupplierName"), rs.GetValue(_T("partner")));
	rptHeader->SetValue(_T("clerk"), pMF->GetCurrentUser());

	szSQL.Format(_T(" SELECT") \
				_T("   product_name   AS pname,") \
				_T("   mtl_qtydelivery	AS qty,") \
				_T("   product_uomname	AS uom,") \
				_T("   product_expdate	AS expdte,") \
				_T("   PRODUCT_VATPRICE AS price,") \
				_T("   product_lotno	AS lot,") \
				_T("   mtl_qtydelivery*PRODUCT_VATPRICE AS amt") \
				_T(" FROM m_transactionline") \
				_T(" LEFT JOIN m_productitem_view ON (product_item_id=mtl_product_item_id)") \
				_T(" WHERE mtl_transaction_id = %ld"), nOrderID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	while (!rs.IsEOF())
	{
		nIdx++;
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("pname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("uom")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("lot")));
		rs.GetValue(_T("expdte"), tmpStr);
		rptDetail->SetValue(_T("5"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		
		rs.GetValue(_T("qty"), tmpStr);
		nS6 += str2double(tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		
		rptDetail->SetValue(_T("7"), rs.GetValue(_T("price")));
		
		rs.GetValue(_T("amt"), tmpStr);
		nS8 += str2double(tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		rs.MoveNext();
	}
	rptFooter = rpt.AddDetail(rpt.GetGroupFooter(1));
	rptFooter->SetValue(_T("s8"), double2str(nS8));
	tmpStr.Format(rptFooter->GetValue(_T("tongso")), nIdx);
	rptFooter->SetValue(_T("tongso"), tmpStr);
	MoneyToString(ToString(nS8), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		tmpStr += _T(" \x111\x1ED3ng.");
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
	}
	rptFooter = rpt.GetReportFooter();
	rptFooter->SetValue(_T("TotalItem"), int2str(nIdx));
	tmpStr.Format(rptFooter->GetValue(_T("PrintDate")), szOrderDate.Mid(8, 2), szOrderDate.Mid(5,2), szOrderDate.Left(4));
	rptFooter->SetValue(_T("PrintDate"), tmpStr);
	rptFooter->SetValue(_T("User1"), _T(""));
	rptFooter->SetValue(_T("User2"), szDeliver);
	rptFooter->SetValue(_T("User3"), szReceiver);
	rptFooter->SetValue(_T("User4"), pMF->GetCurrentUser());
	rpt.PrintPreview();

}


void CPrintForms::PrintDRO(long nOrderID, CString szFilter, CString szDepttype) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	//_msg(_T("Vào đây"));
	CString szSQL, szWhere, tmpStr, tmpStr2, szGroup, szFilePath, szTitle,
		szFileTitle, szObjectType, szStorageCategory, szNote, szStorageOrgId,
		szBarCodeID;
	CRecord rs(&pMF->m_db), rst(&pMF->m_db), rsp(&pMF->m_db), rsReport(&pMF->m_db), rsl(&pMF->m_db);

	CReportSection* rptHeader, * rptDetail, * rptFooter;
	int nTotalItem = 0, nBreak = 0, nStorage_id = 0, nQty = 0;
	double nS6 = 0, nS8 = 0;
	long nProductID = 0;
	CString szSysDte;
	szWhere.AppendFormat(_T(" AND %s"), szFilter);
	szSQL.Format(_T(" SELECT") \
		_T("   mt_orderno       AS orderno,") \
		_T("   mt_storage_to_id,") \
		_T("   get_username(mt_approvedby)    AS clerk,") \
		_T("   trunc(mt_approveddate)  AS dte,") \
		_T("   get_storagename(mt_storage_to_id) AS stock,") \
		_T("   get_departmentname(mt_department_id) AS dept,") \
		_T("   mt_description   AS descr,") \
		_T("   mt_documentno AS documentno,") \
		_T("   case when sd_type = 'KB' then 'E' else 'A' end as dept_type ") \
		/*_T("   mt_objecttype AS objecttype") \*/
		_T(" FROM   m_transaction") \
		_T(" LEFT JOIN sys_dept ON (sd_id = mt_department_id)") \
		_T(" WHERE mt_transaction_id = %ld AND mt_status <> 'O'"), nOrderID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"), MB_ICONASTERISK | MB_OK);
		return;
	}



	//rs.GetValue(_T("mt_objecttype"), szObjectType);
	rs.GetValue(_T("mt_storage_to_id"), nStorage_id);
	if (szDepttype.IsEmpty())
	{
		rs.GetValue(_T("dept_type"), szDepttype);
	}
	//Kiem tra kho dich vu
	//if (szObjectType == _T("S"))
	//	szStorageCategory = _T("S");
	//else
	{
		szSQL.Format(_T("SELECT msl_category as category, msl_org_id as org_id ") \
			_T(" FROM m_storagelist WHERE msl_storage_id = %d"), nStorage_id);
		rsReport.ExecSQL(szSQL);
		rsReport.GetValue(_T("category"), szStorageCategory);
		rsReport.GetValue(_T("org_id"), szStorageOrgId);
	}
	szSQL.Format(_T(" SELECT DISTINCT pmdt_name2,") \
		_T("   pmdt_desc,") \
		_T("   pmdt_reportname2, pmdt_index, pmdt_printtype, pmdt_id  ") \
		_T(" FROM pms_drugtype,") \
		_T("   m_transactionline,") \
		_T("   m_productitem_view") \
		_T(" WHERE mtl_transaction_id =%ld") \
		_T(" AND mtl_product_item_id  =product_item_id") \
		_T(" AND instr(pmdt_desc, product_producttype) > 0") \
		_T(" ORDER BY pmdt_index "), nOrderID);
	rst.ExecSQL(szSQL);
	while (!rst.IsEOF())
	{
		rst.GetValue(_T("pmdt_name2"), tmpStr);
		StringUpper(tmpStr, szTitle);
		rst.GetValue(_T("pmdt_desc"), szGroup);
		szGroup.Trim();

		rst.GetValue(_T("pmdt_reportname2"), tmpStr);
		if (!tmpStr.IsEmpty())
		{
			if (szStorageCategory == _T("S"))
			{
				szFileTitle.Format(_T("DV_%s_%s"), szStorageOrgId, tmpStr);
			}
			else
			{
				szFileTitle.Format(_T("%s_%s"), szStorageOrgId, tmpStr);
			}
		}
		szFilePath.Format(_T("Reports\\HMS\\%s"), szFileTitle);
		if (!rpt.Init(szFilePath))
			return;

		rptHeader = rpt.GetReportHeader();
		rptHeader->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
		rptHeader->SetValue(_T("REPORTTITLE"), szTitle);
		rptHeader->SetValue(_T("Orderno"), rs.GetValue(_T("orderno")));
        rptHeader->SetValue(_T("pmdt_id"), rst.GetValue(_T("pmdt_id")));

		rs.GetValue(_T("orderno"), szBarCodeID);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), szBarCodeID);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), szBarCodeID);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), szBarCodeID);
		rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), szBarCodeID);
		rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), szBarCodeID);

		rptHeader->SetValue(_T("DeliverBy"), rs.GetValue(_T("clerk")));
		rptHeader->SetValue(_T("StockName"), rs.GetValue(_T("stock")));
		rptHeader->SetValue(_T("Reason"), rs.GetValue(_T("descr")));
		rs.GetValue(_T("dte"), tmpStr);
		rptHeader->SetValue(_T("ReturnDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rptHeader->SetValue(_T("Department"), rs.GetValue(_T("dept")));
		//So phieu nhap tu dong
		if (pMF->GetModuleID() == _T("MA"))
			rptHeader->SetValue(_T("ReferenceNo"), rs.GetValue(_T("documentno")));

		// Neu la ngoai tru thi lay trong bang hms_pharmaorderline_r
		//Ngày 11/8 sửa lại lấy từ view ra để bổ sung trường hợp trả lại thuốc, vật tư khi làm thủ thuật trong khoa//
		_tprintf(_T("\r\nszDeptType: %s"), szDepttype);
		if (szDepttype == _T("E"))
		{
			if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
				szSQL.Format(_T(" SELECT productid,uomindex, ") \
					_T("        pname, ") \
					_T("		price,") \
					_T("		uom,") \
					_T("        SUM(solqty)    solqty, ") \
					_T("        SUM(polqty)    polqty, ") \
					_T("        SUM(solinsqty) solinsqty, ") \
					_T("        SUM(othinsqty) othinsqty, ") \
					_T("        SUM(palqty)    palqty, ") \
					_T("        SUM(servqty)    servqty, ") \
					_T("		SUM(solqty+polqty+solinsqty+othinsqty+palqty+servqty) reverseqty,") \
					_T("        SUM(amt)       amt ") \
					_T(" FROM   (SELECT    hpolr_product_id                  productid, ") \
					_T("                   product_name                     AS pname, ") \
					_T("				   product_uomindex as uomindex, ") \
					_T("				   get_uomname(product_uomid) uom,") \
					_T("                   CASE WHEN hpo_object_id = 1 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS solqty, ") \
					_T("                   CASE WHEN hpo_object_id = 3 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS polqty, ") \
					_T("                   CASE WHEN hpo_object_id IN ( 2, 10, 11 ) THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS solinsqty, ") \
					_T("                   CASE WHEN hpo_object_id IN (4, 5, 12) THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS othinsqty, ") \
					_T("                   CASE WHEN hpo_object_id = 8 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS palqty, ") \
					_T("                   CASE WHEN hpo_object_id = 7 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS servqty, ") \
					_T("                   hpolr_unitprice                   AS price, ") \
					_T("                   hpolr_qtyreverse * hpolr_unitprice AS amt ") \
					_T("         FROM      hms_pharmaorder_view ") \
					_T("         LEFT JOIN HMS_PHARMAORDERLINE_R_VIEW ON ( hpo_orderid = hpolr_orderid ) ") \
					_T("         LEFT JOIN m_productitem_view ON ( product_item_id = hpolr_product_item_id ) ") \
					_T("         WHERE     hpolr_retorder_id = %ld ") \
					_T("               AND product_producttype NOT IN ('A1130', 'A1140') ") \
					_T("			   AND hpolr_status = 'A')") \
					_T(" GROUP  BY  uomindex,pname,uom,productid,") \
					_T("           price  ORDER BY uomindex,pname,uom"), nOrderID);
			else
				szSQL.Format(_T(" SELECT productid,uomindex, ") \
					_T("        pname, ") \
					_T("		price,") \
					_T("		uom,") \
					_T("        SUM(solqty)    solqty, ") \
					_T("        SUM(polqty)    polqty, ") \
					_T("        SUM(solinsqty) solinsqty, ") \
					_T("        SUM(othinsqty) othinsqty, ") \
					_T("        SUM(palqty)    palqty, ") \
					_T("        SUM(servqty)    servqty, ") \
					_T("		SUM(solqty+polqty+solinsqty+othinsqty+palqty+servqty) reverseqty,") \
					_T("        SUM(amt)       amt ") \
					_T(" FROM   (SELECT    hpolr_product_id                  productid, ") \
					_T("                   product_name                     AS pname, ") \
					_T("					product_uomindex as uomindex, ") \
					_T("				   get_uomname(product_uomid) uom,") \
					_T("                   CASE WHEN hpo_object_id = 1 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS solqty, ") \
					_T("                   CASE WHEN hpo_object_id = 3 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS polqty, ") \
					_T("                   CASE WHEN hpo_object_id IN ( 2, 10, 11 ) THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS solinsqty, ") \
					_T("                   CASE WHEN hpo_object_id IN (4, 5, 6, 9, 12) THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS othinsqty, ") \
					_T("                   CASE WHEN hpo_object_id = 8 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS palqty, ") \
					_T("                   CASE WHEN hpo_object_id = 7 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS servqty, ") \
					_T("                   hpolr_unitprice                   AS price, ") \
					_T("                   hpolr_qtyreverse * hpolr_unitprice AS amt ") \
					_T("         FROM      hms_pharmaorder_view ") \
					_T("         LEFT JOIN HMS_PHARMAORDERLINE_R_VIEW ON (hpo_orderid = hpolr_orderid ) ") \
					_T("         LEFT JOIN m_productitem_view ON ( product_item_id = hpolr_product_item_id ) ") \
					_T("         WHERE     hpolr_retorder_id = %ld ") \
					_T("               AND product_producttype IN (%s) ") \
					_T("			   AND hpolr_status = 'A')") \
					_T(" GROUP  BY productid,uom,pname,uomindex, ") \
					_T("           price ORDER BY uomindex,pname,uom "), nOrderID, szGroup);
		}
		else
		{
			if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
				szSQL.Format(_T(" SELECT productid,uomindex, ") \
					_T("        pname, ") \
					_T("		price,") \
					_T("		uom,") \
					_T("        SUM(solqty)    solqty, ") \
					_T("        SUM(polqty)    polqty, ") \
					_T("        SUM(solinsqty) solinsqty, ") \
					_T("        SUM(othinsqty) othinsqty, ") \
					_T("        SUM(palqty)    palqty, ") \
					_T("        SUM(servqty)    servqty, ") \
					_T("		SUM(solqty+polqty+solinsqty+othinsqty+palqty+servqty) reverseqty,") \
					_T("        SUM(amt)       amt ") \
					_T(" FROM   (SELECT    hpolr_product_id                  productid, ") \
					_T("                   product_name                     AS pname, ") \
					_T("					product_uomindex as uomindex, ") \
					_T("				   get_uomname(product_uomid) uom,") \
					_T("                   CASE WHEN hpo_object_id = 1 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS solqty, ") \
					_T("                   CASE WHEN hpo_object_id = 3 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS polqty, ") \
					_T("                   CASE WHEN hpo_object_id IN ( 2, 10, 11 ) THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS solinsqty, ") \
					_T("                   CASE WHEN hpo_object_id IN (4, 5, 6, 9, 12) THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS othinsqty, ") \
					_T("                   CASE WHEN hpo_object_id = 8 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS palqty, ") \
					_T("                   CASE WHEN hpo_object_id = 7 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS servqty, ") \
					_T("                   hpolr_unitprice                   AS price, ") \
					_T("                   hpolr_qtyreverse * hpolr_unitprice AS amt ") \
					_T("         FROM      hms_pharmaorder_view ") \
					_T("         LEFT JOIN HMS_PHARMAORDERLINE_R_VIEW ON ( hpo_orderid = hpolr_orderid ) ") \
					_T("         LEFT JOIN m_productitem_view ON ( product_item_id = hpolr_product_item_id ) ") \
					_T("         WHERE     hpolr_retorder_id = %ld ") \
					_T("               AND product_producttype NOT IN ('A1130', 'A1140') ") \
					_T("			   AND hpolr_status = 'A')") \
					_T(" GROUP  BY pname,uom,productid,uomindex, ") \
					_T("           price ORDER BY uomindex,pname,uom "), nOrderID);
			else
				szSQL.Format(_T(" SELECT productid,uomindex, ") \
					_T("        pname, ") \
					_T("		price,") \
					_T("		uom,") \
					_T("        SUM(solqty)    solqty, ") \
					_T("        SUM(polqty)    polqty, ") \
					_T("        SUM(solinsqty) solinsqty, ") \
					_T("        SUM(othinsqty) othinsqty, ") \
					_T("        SUM(palqty)    palqty, ") \
					_T("        SUM(servqty)    servqty, ") \
					_T("		SUM(solqty+polqty+solinsqty+othinsqty+palqty+servqty) reverseqty,") \
					_T("        SUM(amt)       amt ") \
					_T(" FROM   (SELECT    hpolr_product_id                  productid, ") \
					_T("                   product_name                     AS pname, ") \
					_T("					product_uomindex as uomindex, ") \
					_T("				   get_uomname(product_uomid) uom,") \
					_T("                   CASE WHEN hpo_object_id = 1 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS solqty, ") \
					_T("                   CASE WHEN hpo_object_id = 3 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS polqty, ") \
					_T("                   CASE WHEN hpo_object_id IN ( 2, 10, 11 ) THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS solinsqty, ") \
					_T("                   CASE WHEN hpo_object_id IN (4, 5, 6, 9, 12) THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS othinsqty, ") \
					_T("                   CASE WHEN hpo_object_id = 8 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS palqty, ") \
					_T("                   CASE WHEN hpo_object_id = 7 THEN hpolr_qtyreverse ") \
					_T("                   ELSE 0 ") \
					_T("                   END                              AS servqty, ") \
					_T("                   hpolr_unitprice                   AS price, ") \
					_T("                   hpolr_qtyreverse * hpolr_unitprice AS amt ") \
					_T("         FROM      hms_pharmaorder_view ") \
					_T("         LEFT JOIN HMS_PHARMAORDERLINE_R_VIEW ON (hpo_orderid = hpolr_orderid ) ") \
					_T("         LEFT JOIN m_productitem_view ON ( product_item_id = hpolr_product_item_id ) ") \
					_T("         WHERE     hpolr_retorder_id = %ld ") \
					_T("               AND product_producttype IN (%s) ") \
					_T("			   AND hpolr_status = 'A')") \
					_T(" GROUP  BY  productid,uom, pname,uomindex, ") \
					_T("           price ORDER BY uomindex,pname,uom "), nOrderID, szGroup);
		}

		/*if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
			szSQL.Format(_T(" SELECT productid,uomindex, ") \
						_T("        pname, ") \
						_T("		price,") \
						_T("		uom,") \
						_T("        SUM(solqty)    solqty, ") \
						_T("        SUM(polqty)    polqty, ") \
						_T("        SUM(solinsqty) solinsqty, ") \
						_T("        SUM(othinsqty) othinsqty, ") \
						_T("        SUM(palqty)    palqty, ") \
						_T("        SUM(servqty)    servqty, ") \
						_T("		SUM(solqty+polqty+solinsqty+othinsqty+palqty+servqty) reverseqty,") \
						_T("        SUM(amt)       amt ") \
						_T(" FROM   (SELECT    hpolr_product_id                  productid, ") \
						_T("                   product_name                     AS pname, ") \
						_T("				   product_uomindex as uomindex, ") \
						_T("				   get_uomname(product_uomid) uom,") \
						_T("                   CASE WHEN hpo_object_id = 1 THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS solqty, ") \
						_T("                   CASE WHEN hpo_object_id = 3 THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS polqty, ") \
						_T("                   CASE WHEN hpo_object_id IN ( 2, 10, 11 ) THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS solinsqty, ") \
						_T("                   CASE WHEN hpo_object_id IN (4, 5) THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS othinsqty, ") \
						_T("                   CASE WHEN hpo_object_id = 8 THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS palqty, ") \
						_T("                   CASE WHEN hpo_object_id = 7 THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS servqty, ") \
						_T("                   hpolr_unitprice                   AS price, ") \
						_T("                   hpolr_qtyreverse * hpolr_unitprice AS amt ") \
						_T("         FROM      hms_pharmaorder_view ") \
						_T("         LEFT JOIN HMS_PHARMAORDERLINE_R_VIEW ON ( hpo_orderid = hpolr_orderid ) ") \
						_T("         LEFT JOIN m_productitem_view ON ( product_item_id = hpolr_product_item_id ) ") \
						_T("         WHERE     hpolr_retorder_id = %ld ") \
						_T("               AND product_producttype NOT IN ('A1130', 'A1140') ") \
						_T("			   AND hpolr_status = 'A')") \
						_T(" GROUP  BY  uomindex,pname,uom,productid,") \
						_T("           price  ORDER BY uomindex,pname,uom"), nOrderID);
		else
			szSQL.Format(_T(" SELECT productid,uomindex, ") \
						_T("        pname, ") \
						_T("		price,") \
						_T("		uom,") \
						_T("        SUM(solqty)    solqty, ") \
						_T("        SUM(polqty)    polqty, ") \
						_T("        SUM(solinsqty) solinsqty, ") \
						_T("        SUM(othinsqty) othinsqty, ") \
						_T("        SUM(palqty)    palqty, ") \
						_T("        SUM(servqty)    servqty, ") \
						_T("		SUM(solqty+polqty+solinsqty+othinsqty+palqty+servqty) reverseqty,") \
						_T("        SUM(amt)       amt ") \
						_T(" FROM   (SELECT    hpolr_product_id                  productid, ") \
						_T("                   product_name                     AS pname, ") \
						_T("					product_uomindex as uomindex, ") \
						_T("				   get_uomname(product_uomid) uom,") \
						_T("                   CASE WHEN hpo_object_id = 1 THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS solqty, ") \
						_T("                   CASE WHEN hpo_object_id = 3 THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS polqty, ") \
						_T("                   CASE WHEN hpo_object_id IN ( 2, 10, 11 ) THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS solinsqty, ") \
						_T("                   CASE WHEN hpo_object_id IN (4, 5, 6, 9, 12) THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS othinsqty, ") \
						_T("                   CASE WHEN hpo_object_id = 8 THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS palqty, ") \
						_T("                   CASE WHEN hpo_object_id = 7 THEN hpolr_qtyreverse ") \
						_T("                   ELSE 0 ") \
						_T("                   END                              AS servqty, ") \
						_T("                   hpolr_unitprice                   AS price, ") \
						_T("                   hpolr_qtyreverse * hpolr_unitprice AS amt ") \
						_T("         FROM      hms_pharmaorder_view ") \
						_T("         LEFT JOIN HMS_PHARMAORDERLINE_R_VIEW ON (hpo_orderid = hpolr_orderid ) ") \
						_T("         LEFT JOIN m_productitem_view ON ( product_item_id = hpolr_product_item_id ) ") \
						_T("         WHERE     hpolr_retorder_id = %ld ") \
						_T("               AND product_producttype IN (%s) ") \
						_T("			   AND hpolr_status = 'A')") \
						_T(" GROUP  BY productid,uom,pname,uomindex, ") \
						_T("           price ORDER BY uomindex,pname,uom "), nOrderID, szGroup);*/

		rsl.ExecSQL(szSQL);

		//if(rs.IsEOF()){
		//	rst.MoveNext();
		//	continue;

		//}
		if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
		{
			nBreak++;
		}
		nTotalItem = 1;
		nS8 = 0;
		while (!rsl.IsEOF())
		{
			rsl.GetValue(_T("productid"), nProductID);
			rptDetail = rpt.AddDetail();
			rptDetail->SetValue(_T("1"), int2str(nTotalItem++));
			rptDetail->SetValue(_T("2"), rsl.GetValue(_T("pname")));
			rptDetail->SetValue(_T("3"), rsl.GetValue(_T("uom")));
			rptDetail->SetValue(_T("4.1"), rsl.GetValue(_T("solqty")));
			rptDetail->SetValue(_T("4.2"), rsl.GetValue(_T("polqty")));
			rptDetail->SetValue(_T("4.3"), rsl.GetValue(_T("solinsqty")));
			rptDetail->SetValue(_T("4.4"), rsl.GetValue(_T("othinsqty")));
			rptDetail->SetValue(_T("4.5"), rsl.GetValue(_T("Servqty")));
			rptDetail->SetValue(_T("4.6"), rsl.GetValue(_T("palqty")));
			rptDetail->SetValue(_T("4"), rsl.GetValue(_T("reverseqty")));
			rptDetail->SetValue(_T("5"), rsl.GetValue(_T("price")));
			rsl.GetValue(_T("amt"), tmpStr);
			nS8 += str2double(tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);
			if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1)
			{
				szSQL.Format(_T(" SELECT    hpo_docno            AS docno, ") \
					_T("           Trim(hp_surname||' '||hp_midname||' '||hp_firstname) AS pname, ") \
					_T("           SUM(hpolr_qtyreverse)   AS orderqty ") \
					_T(" FROM      hms_ipharmaorder ") \
					_T(" LEFT JOIN hms_ipharmaorderline_r ON( hpo_orderid = hpolr_orderid ) ") \
					_T(" LEFT JOIN hms_patient ON( hp_patientno = hpo_patientno ) ") \
					_T(" WHERE     hpolr_retorder_id = %ld ") \
					_T("       AND hpolr_product_id = %ld ") \
					_T(" GROUP     BY hpo_docno, ") \
					_T("              hp_firstname, ") \
					_T("              hp_midname, ") \
					_T("              hp_surname ") \
					_T(" ORDER     BY pname "), nOrderID, nProductID);
				//Neu bo sung tu truc
				//{
				//	szSQL.Format(_T(" SELECT 	hmc_docno as docno,") \
				//	_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
				//	_T(" 	hmc_qty as orderqty") \
				//	_T(" FROM hms_medicalcabinet_issue") \
				//	_T(" LEFT JOIN hms_doc ON(hd_docno=hmc_docno)") \
				//	_T(" LEFT JOIN hms_patient ON(hp_patientno=hd_patientno)") \
				//	_T(" WHERE hmc_supplementid='%s' ") \
				//	_T(" and hmc_itemid='%s' ORDER BY docno,pname "), szID, szItemId);
				//}
				rsp.ExecSQL(szSQL);
				while (!rsp.IsEOF()) {
					rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
					rptDetail->SetValue(_T("1"), _T(""));
					rsp.GetValue(_T("pname"), tmpStr);
					rptDetail->SetValue(_T("2"), tmpStr);
					rsp.GetValue(_T("docno"), tmpStr);
					rptDetail->SetValue(_T("3"), tmpStr);
					rsp.GetValue(_T("orderqty"), nQty);
					FormatCurrency(nQty, tmpStr);
					rptDetail->SetValue(_T("4"), tmpStr);
					rptDetail->SetValue(_T("5"), _T(""));
					MoneyToString(ToString(nQty), szNote);
					rptDetail->SetValue(_T("6"), szNote);
					rsp.MoveNext();
				}
			}
			rsl.MoveNext();
		}
		rptFooter = rpt.AddDetail(rpt.GetGroupFooter(1));
		rptFooter->SetValue(_T("s6"), double2str(nS6));
		rptFooter->SetValue(_T("s8"), double2str(nS8));
		rptFooter->SetValue(_T("TotalItem"), int2str(nTotalItem - 1));
		tmpStr.Format(_T("%f"), nS8);
		FormatCurrencyStr(tmpStr, tmpStr2);
		rptFooter->SetValue(_T("TotalAmount"), tmpStr2);
		MoneyToString(ToString(nS8), tmpStr);
		if (!tmpStr.IsEmpty())
		{
			tmpStr += _T(" \x111\x1ED3ng");
			rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
		}
		szSysDte = pMF->GetSysDate();
		tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDte.Right(2), szSysDte.Mid(5, 2), szSysDte.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
		rpt.PrintPreview();
		if (nBreak > 0)
			break;
		rst.MoveNext();
	}
}

void CPrintForms::PM_OnPrintCROwoPatient(long nTransactionID) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CReport rpt;
	CReportSection* rptHeader = NULL, * rptDetail = NULL, * rptFooter = NULL;
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, tmpStr2;
	int nIdx = 1;
	double nTotalAmount = 0;
	if (!rpt.Init(_T("Reports\\HMS\\PMS_RDRUGORDER3.RPT")))
		return;
	szSQL.Format(_T(" SELECT mt_orderno order_no, get_storagename(mt_storage_to_id) storage_to, get_departmentname(mt_department_id) department_id, to_char(mt_approveddate, 'dd/mm/yyyy') approved_date, mt_description description, ") \
		_T("		(select distinct mp_org_id from m_transactionline, m_product where mp_product_id = mtl_product_id and mtl_transaction_id = mt_transaction_id and mp_org_id <> 'GL') module") \
		_T(" FROM m_transaction ") \
		_T(" WHERE mt_transaction_id = %ld"), nTransactionID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF()) {
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptHeader = rpt.GetReportHeader();
	rptFooter = rpt.GetReportFooter();
	rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("ReportTitle"), rs.GetValue(_T("module")) == _T("PM") ? _T("PHI\x1EBEU TR\x1EA2 THU\x1ED0\x43") : _T("PHI\x1EBEU TR\x1EA2 V\x1EACT T\x1AF TI\xCAU H\x41O"));
	for (int i = 0; i < rs.GetFieldCount(); i++) rptHeader->SetValue(rs.GetFieldName(i), rs.GetValue(rs.GetFieldName(i)));
	szSQL.Format(_T(" SELECT product_name           AS c2,") \
		_T("   get_uomname(product_uomid) AS c3 ,product_uomindex, ") \
		_T("   SUM(mtl_qtydelivery)   AS c4,") \
		_T("   CASE") \
		_T("     WHEN msl_category = 'S'") \
		_T("     THEN mtl_saleprice") \
		_T("     ELSE mtl_taxprice") \
		_T("   END AS c5,") \
		_T("   CASE") \
		_T("     WHEN msl_category = 'S'") \
		_T("     THEN SUM(mtl_qtydelivery*mtl_saleprice)") \
		_T("     ELSE SUM(mtl_qtydelivery*mtl_taxprice)") \
		_T("   END AS c6") \
		_T(" FROM m_transaction") \
		_T(" LEFT JOIN m_transactionline") \
		_T(" ON (mt_transaction_id = mtl_transaction_id)") \
		_T(" LEFT JOIN m_productitem_view on (mtl_product_item_id= product_item_id) ") \
		_T(" LEFT JOIN m_storagelist") \
		_T(" ON(mt_storage_id        = msl_storage_id)") \
		_T(" WHERE mt_transaction_id = %ld") \
		_T(" GROUP BY product_name,product_uomindex,") \
		_T("   product_uomid,") \
		_T("   mtl_taxprice,") \
		_T("   mtl_saleprice,") \
		_T("   msl_category order by product_uomindex, product_name"), nTransactionID);
	_fmsg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF()) {
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("c1"), int2str(nIdx++));
		for (int i = 0; i < rs.GetFieldCount(); i++)
			rptDetail->SetValue(rs.GetFieldName(i), rs.GetValue(rs.GetFieldName(i)));
		nTotalAmount += str2double(rs.GetValue(_T("c6")));
		rs.MoveNext();
	}
	tmpStr.Format(_T("%f"), nTotalAmount);
	rptFooter->SetValue(_T("TotalAmount"), tmpStr);
	MoneyToString(tmpStr, tmpStr2);
	rptFooter->SetValue(_T("SumInWord"), tmpStr2);
	tmpStr2 = pMF->GetSysDate();
	tmpStr.Format(rptFooter->GetValue(_T("PrintDate")), tmpStr2.Mid(8, 2), tmpStr2.Mid(5, 2), tmpStr2.Left(4));
	rptFooter->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::PrintCompositeExportSheet(long nSheetID) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr;
	CString szSysDte;
	int nIdx = 0;
	double nS7 = 0, nS8 = 0;
	CReportSection* rptDetail, * rptHeader, * rptFooter;
	m_szReportName = _T("Reports\\HMS\\PM_PHIEUXUATKHO.RPT");
	m_szReportName.Format(_T("Reports\\HMS\\%s_PHIEUXUATKHO.RPT"), pMF->GetModuleID());
	if (!rpt.Init(m_szReportName))
		return;
	szSQL.Format(_T(" SELECT") \
		_T("   mt_orderno       AS orderno,") \
		_T("   get_username(mt_approvedby)    AS clerk,") \
		_T("   get_partnername(mt_partner_id) as deliverto,") \
		_T("   trunc(mt_approveddate)  AS dte,") \
		_T("   get_storagename(mt_storage_id) AS stock,") \
		_T("   get_departmentname(mt_department_id) AS dept,") \
		_T("   mt_description   AS descr,") \
		_T("   mt_documentno documentno,") \
		_T("   get_syssel_desc('HMS_TREAT_ZONE', mt_zone) as zone") \
		_T(" FROM m_transaction") \
		_T(" WHERE mt_transaction_id = %ld"), nSheetID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"), MB_ICONASTERISK | MB_OK);
		return;
	}
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("zone"), rs.GetValue(_T("zone")));
	rptHeader->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Invoiceno"), rs.GetValue(_T("orderno")));
	rptHeader->SetValue(_T("DeliverBy"), rs.GetValue(_T("clerk")));
	rptHeader->SetValue(_T("StockName"), rs.GetValue(_T("stock")));
	rptHeader->SetValue(_T("Reason"), rs.GetValue(_T("descr")));
	rs.GetValue(_T("dte"), szSysDte);
	tmpStr.Format(rptHeader->GetValue(_T("OrderDate")), szSysDte.Mid(8, 2), szSysDte.Mid(5, 2), szSysDte.Left(4));
	rptHeader->SetValue(_T("OrderDate"), tmpStr);
	rptHeader->SetValue(_T("Department"), rs.GetValue(_T("dept")));
	rptHeader->SetValue(_T("DeliveryTo"), rs.GetValue(_T("deliverto")));
	rptHeader->SetValue(_T("ReferenceNo"), rs.GetValue(_T("documentno")));
	szSQL.Format(_T(" SELECT") \
		_T("   product_name   AS pname,") \
		_T("   mtl_qtydelivery	AS qty,") \
		_T("   product_uomname	AS uom,") \
		_T("   product_expdate	AS expdte,") \
		_T("   product_taxprice AS price,") \
		_T("   product_lotno	AS lot,") \
		_T("   mtl_qtydelivery*product_taxprice AS amt") \
		_T(" FROM m_transactionline") \
		_T(" LEFT JOIN m_productitem_view ON (product_item_id=mtl_product_item_id)") \
		_T(" WHERE mtl_transaction_id = %ld"), nSheetID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	while (!rs.IsEOF())
	{
		nIdx++;
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("pname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("uom")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("lot")));
		rs.GetValue(_T("expdte"), tmpStr);
		rptDetail->SetValue(_T("5"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("price")));
		rs.GetValue(_T("qty"), tmpStr);
		nS7 += str2double(tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rs.GetValue(_T("amt"), tmpStr);
		nS8 += str2double(tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		rs.MoveNext();
	}
	rptFooter = rpt.AddDetail(rpt.GetGroupFooter(1));
	rptFooter->SetValue(_T("s7"), double2str(nS7));
	rptFooter->SetValue(_T("s8"), double2str(nS8));
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), int2str(nIdx));
	MoneyToString(ToString(nS8), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		tmpStr += _T(" \x111\x1ED3ng");
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
	}
	szSysDte = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDte.Right(2), szSysDte.Mid(5, 2), szSysDte.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::PM_PrintOtherImport(long nOrderID) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CString szSQL, szSQL1, tmpStr, szOrg_Module;
	CString szSysDte;
	int nIdx = 0;
	double nS7 = 0, nS8 = 0;
	CReportSection* rptDetail, * rptHeader, * rptFooter;

	szSQL1.Format(_T(" SELECT msl_org_id as Org_Module") \
		_T(" FROM m_transaction left join M_STORAGELIST ON (mt_storage_to_id=MSL_STORAGE_ID) ") \
		_T(" WHERE mt_transaction_id = %ld"), nOrderID);
	rs.ExecSQL(szSQL1);
	rs.GetValue(_T("Org_Module"), szOrg_Module);

	if (szOrg_Module == _T("MA"))
	{
		m_szReportName = _T("Reports\\HMS\\MA_PHIEUNHAPKHAC.RPT");
	}
	else if (szOrg_Module == _T("PM"))
	{
		m_szReportName = _T("Reports\\HMS\\PM_PHIEUNHAPKHAC.RPT");
	}
	else
		m_szReportName = _T("Reports\\HMS\\GL_PHIEUNHAPKHAC.RPT");

	if (!rpt.Init(m_szReportName))
		return;

	szSQL.Format(_T(" SELECT") \
		_T("   mt_orderno       AS orderno,") \
		_T("   get_username(mt_approvedby)    AS clerk,") \
		_T("   get_partnername(mt_partner_id) as deliverto,") \
		_T("   trunc(mt_approveddate)  AS dte,") \
		_T("   get_storagename(mt_storage_to_id) AS stock,") \
		_T("   get_departmentname(mt_department_id) AS dept,") \
		_T("   mt_description   AS descr,") \
		_T("   mt_documentno documentno") \
		_T(" FROM m_transaction ") \
		_T(" WHERE mt_transaction_id = %ld"), nOrderID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"), MB_ICONASTERISK | MB_OK);
		return;
	}

	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Invoiceno"), rs.GetValue(_T("orderno")));
	rptHeader->SetValue(_T("DeliverBy"), rs.GetValue(_T("clerk")));
	rptHeader->SetValue(_T("StockName"), rs.GetValue(_T("stock")));
	rptHeader->SetValue(_T("Reason"), rs.GetValue(_T("descr")));
	rs.GetValue(_T("dte"), szSysDte);
	tmpStr.Format(rptHeader->GetValue(_T("OrderDate")), szSysDte.Mid(8, 2), szSysDte.Mid(5, 2), szSysDte.Left(4));
	rptHeader->SetValue(_T("OrderDate"), tmpStr);
	rptHeader->SetValue(_T("Department"), rs.GetValue(_T("dept")));
	rptHeader->SetValue(_T("DeliveryTo"), rs.GetValue(_T("deliverto")));
	rptHeader->SetValue(_T("ReferenceNo"), rs.GetValue(_T("documentno")));
	szSQL.Format(_T(" SELECT") \
		_T("   product_name   AS pname,") \
		_T("   mtl_qtydelivery	AS qty,") \
		_T("   product_uomname	AS uom,") \
		_T("   product_expdate	AS expdte,") \
		_T("   product_taxprice AS price,") \
		_T("   product_lotno	AS lot,") \
		_T("   mtl_qtydelivery*product_taxprice AS amt") \
		_T(" FROM m_transactionline") \
		_T(" LEFT JOIN m_productitem_view ON (product_item_id=mtl_product_item_id)") \
		_T(" WHERE mtl_transaction_id = %ld"), nOrderID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	while (!rs.IsEOF())
	{
		nIdx++;
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("pname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("uom")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("lot")));
		rs.GetValue(_T("expdte"), tmpStr);
		rptDetail->SetValue(_T("5"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("price")));
		rs.GetValue(_T("qty"), tmpStr);
		nS7 += str2double(tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rs.GetValue(_T("amt"), tmpStr);
		nS8 += str2double(tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		rs.MoveNext();
	}
	rptFooter = rpt.AddDetail(rpt.GetGroupFooter(1));
	rptFooter->SetValue(_T("s7"), double2str(nS7));
	rptFooter->SetValue(_T("s8"), double2str(nS8));
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), int2str(nIdx));
	MoneyToString(ToString(nS8), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		tmpStr += _T(" \x111\x1ED3ng");
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
	}
	szSysDte = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDte.Right(2), szSysDte.Mid(5, 2), szSysDte.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::PrintDepartmentExportSheet(long nSheetID, CString szFilter) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CString szSQL, szOrderBy;
	CRecord rs(&pMF->m_db), trs(&pMF->m_db);
	szSQL.Format(
		_T(" SELECT  mt_transaction_id as invoiceid,") \
		_T("	mt_orderno as invoiceno,") \
		_T("  	mt_posteddate as issuedate ,") \
		_T("  	mt_orderdate as invoicedate,") \
		_T(" 	GET_STORAGENAME(mt_storage_id) as storagename,	") \
		_T("  	GET_STORAGENAME(mt_storage_to_id) as storagename_to,") \
		_T("  	GET_DEPARTMENTNAME(mt_department_to_id) as department,") \
		_T("  	GET_SYSSEL_DESC('pms_export_type', mt_exptype) as exptype,") \
		_T("  	GET_USERNAME(mt_deliveryby) as deliverer,") \
		_T("  	GET_USERNAME(mt_receiveby) as receiver, ") \
		_T("	mt_description as note, ") \
		_T("	mt_status as status, ") \
		_T("	mt_doctype as doctype, mt_documentno, ") \
		_T("	(select NVL(msl_sub_org_id, 'N') from m_storagelist where msl_storage_id = mt_storage_id) storage_sub_org_id,") \
		_T("   get_syssel_desc('HMS_TREAT_ZONE', mt_zone) as zone") \
		_T(" FROM m_transaction") \
		_T(" WHERE mt_transaction_id=%ld  "), nSheetID);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;

	CReport rpt;
	CString tmpStr, szAmount;
	CString szDate, szSysDate, szinvoicedate;
	CString szDocType, szReportTitle, szPath, szinvoiceid, szstorage_sub_org_id;

	rs.GetValue(_T("storage_sub_org_id"), szstorage_sub_org_id);


	if (pMF->GetModuleID() == _T("PM") || pMF->GetModuleID() == _T("BB"))
	{
		szReportTitle = _T("PMS_DRUGEXPORT");
	}

	else if (pMF->GetModuleID() == _T("PCNMT") && szstorage_sub_org_id != _T("N"))
	{
		szReportTitle.Format(_T("%s_%s_DRUGEXPORT"), pMF->GetModuleID(), szstorage_sub_org_id);
	}
	else
	{
		szReportTitle.Format(_T("%s_DRUGEXPORT"), pMF->GetModuleID());
	}
	szPath.Format(_T("Reports/HMS/%s.RPT"), szReportTitle);
	if (!rpt.Init(szPath))
		return;
	rpt.GetReportHeader()->SetValue(_T("zone"), rs.GetValue(_T("zone")));
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rs.GetValue(_T("InvoiceNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);

	rs.GetValue(_T("invoicedate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("OrderDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	//szSysDate = pMF->GetSysDate(); 
	//szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")),szSysDate.Right(2),szSysDate.Mid(5,2),szSysDate.Left(4));
	//rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);	


	rs.GetValue(_T("doctype"), szDocType);
	tmpStr.Empty();

	rs.GetValue(_T("storagename"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName"), tmpStr);
	rs.GetValue(_T("storagename_to"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName1"), tmpStr);

	rs.GetValue(_T("Department"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

	rs.GetValue(_T("note"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Comment"), tmpStr);
	rs.GetValue(_T("deliverer"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("deliverer"), tmpStr);
	rs.GetValue(_T("receiver"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("receiver"), tmpStr);

	tmpStr.Empty();
	//pMF->GetStatusString(rs.GetValue(_T("status")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
	rs.GetValue(_T("invoiceid"), szinvoiceid);
	rs.GetValue(_T("invoicedate"), szinvoicedate);

	if (pMF->GetModuleID() == _T("MA"))
	{
		rs.GetValue(_T("mt_documentno"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("ReferenceNo"), tmpStr);
	}

	//Page Header
	//Report Detail

	int nCount = 0;
	int nQty = 0;
	double dMoney = 0;
	double nTotalAmount = 0;

	CString szMoney, szExprDate;
	szSQL.Format(_T(" SELECT product_id AS id,") \
		_T("        product_name AS name,") \
		_T("        product_uomname AS unit,") \
		_T("        product_expdate AS expdate,") \
		_T("        product_lotno AS lotno,") \
		_T("        SUM(mtl_qtyorder) AS qtyorder,") \
		_T("        SUM(mtl_qtydelivery) AS qtyissue,") \
		_T("        mtl_saleprice AS price,") \
		_T("		product_ma_hieu, product_manufacturename,") \
		_T("        SUM(mtl_qtyorder*mtl_saleprice) AS orderamount,") \
		_T("        SUM(mtl_qtydelivery*mtl_saleprice) AS issueamount") \
		_T(" FROM m_transactionline") \
		_T(" LEFT JOIN m_productitem_view ON(mtl_product_item_id=product_item_id)") \
		_T(" WHERE mtl_transaction_id=%ld") \
		_T(" GROUP BY product_id, product_name, product_uomname,") \
		_T("          product_expdate, product_lotno,") \
		_T("          mtl_saleprice, mtl_line, product_ma_hieu, product_manufacturename") \
		_T(" ORDER BY mtl_line"), nSheetID);

	//_msg(_T("%s"), szSQL);

	rs.ExecSQL(szSQL);
	CReportSection* rptDetail = rpt.GetDetail(0);
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();

		nCount++;

		tmpStr.Format(_T("%d"), nCount);
		rptDetail->SetValue(_T("1"), tmpStr);

		rs.GetValue(_T("name"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);

		rs.GetValue(_T("unit"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);

		rs.GetValue(_T("product_ma_hieu"), tmpStr);
		rptDetail->SetValue(_T("4.1"), tmpStr);

		rs.GetValue(_T("product_manufacturename"), tmpStr);
		rptDetail->SetValue(_T("4.2"), tmpStr);

		rs.GetValue(_T("expdate"), tmpStr);
		szExprDate = CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy);
		rptDetail->SetValue(_T("4"), szExprDate);

		rs.GetValue(_T("lotno"), tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);

		rs.GetValue(_T("qtyorder"), tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);

		rs.GetValue(_T("qtyissue"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);

		rs.GetValue(_T("price"), dMoney);
		FormatCurrency(dMoney, tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);

		rs.GetValue(_T("issueamount"), dMoney);
		nTotalAmount += dMoney;
		FormatCurrency(dMoney, tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);


		rs.MoveNext();
	}
	//Page Footer

	//Report Footer
	tmpStr.Format(_T("%d"), nCount);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(nTotalAmount, szAmount);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), szAmount);
	szAmount.Format(_T("%.2f"), nTotalAmount);
	MoneyToString(szAmount, tmpStr);
#ifdef UNICODE
	tmpStr += _T(" \x111\x1ED3ng.");
#endif
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);

	/*tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(11,5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);*/

	if (szinvoiceid == _T("6150077") || szinvoiceid == _T("6150076"))
	{
		//szDate = CDateTime::Convert(szinvoicedate, yyyymmdd|hhmmss, ddmmyyyy|hhmmss);
		tmpStr = szinvoicedate;
		szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	}
	else
	{
		tmpStr = pMF->GetSysDateTime();
		szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	}

	//GetDoctorName(pMF->GetCurrentUser());

	rpt.PrintPreview();
}

CString CPrintForms::GetQueryString(CString szQueryID, CString szInvoiceID) {
	CString szSQL, szWhere;
	if (szQueryID == _T("INVOICE"))
	{
		szWhere.Format(_T(" AND fac_invoiceno = '%s'"), szInvoiceID);
		szSQL.Format(_T(" SELECT") \
			_T("   fac_cash_id      AS id,") \
			_T("   fac_client_id    AS client,") \
			_T("   fac_org_id       AS org,") \
			_T("   fac_user_id      AS userid,") \
			_T("   fac_invoicedate  AS invoicedate,") \
			_T("   facl_debit_acct  AS debit,") \
			_T("   facl_credit_acct AS credit,") \
			_T("   fac_invoiceno    AS invoiceno,") \
			_T("   fac_invoicedate     AS acctdate,") \
			_T("   fac_partner_id   AS partnerid,") \
			_T("   fac_transactor   AS transactor,") \
			_T("   fac_reason       AS reason,") \
			_T("   fac_amount       AS totalamount") \
			_T(" FROM   fa_cash") \
			_T(" LEFT JOIN fa_cashline ON (fac_cash_id=facl_cash_id)") \
			_T(" WHERE  fac_isactive='Y' %s") \
			_T(" ORDER  BY fac_cash_id "), szWhere);
	}
	//if(szQueryID == _T("Bank"))
	//{
	//	szWhere.Format(_T(" AND fac_invoiceno = '%s'"), szInvoiceID);
	//	szSQL.Format(_T("SELECT fac_cash_id as id, fac_client_id as client, fac_org_id as org, fac_user_id as uid, fac_invoicedate as invoicedate, ") \
	//			_T("facl_debit_acct as debit, facl_credit_acct as credit,") \
	//			_T("fac_invoiceno as invoiceno, fac_invoicedate as acctdate, ") \
	//			_T("fac_partner_id as partnerid, fac_transactor as transactor, ") \
	//			_T("fac_reason as reason, fac_amount as totalamount ") \
	//			_T(" FROM fa_cash LEFT JOIN fa_cashline ON (fac_cash_id = facl_cash_id) WHERE fac_isactive='Y' %s ORDER BY fac_cash_id"), szWhere);
	//}
	if (szQueryID == _T("CASH_VOUCHER"))
	{
		szWhere.Format(_T(" AND fac_invoiceno = '%s'"), szInvoiceID);
		szSQL.Format(_T(" SELECT") \
			_T("   'COMPANY NAME'                AS org,") \
			_T("   'DEPARTMENT'                  AS department,") \
			_T("   (SELECT") \
			_T("      adp_name") \
			_T("    FROM   ad_partner") \
			_T("    WHERE  adp_partner_id=fac_partner_id) AS obj,") \
			_T("   (SELECT") \
			_T("      adp_address") \
			_T("    FROM   ad_partner") \
			_T("    WHERE  adp_partner_id=fac_partner_id) AS addr,") \
			_T("   fac_invoicedate               AS invoicedate,") \
			_T("   facl_debit_acct               AS debit,") \
			_T("   facl_credit_acct              AS credit,") \
			_T("   fac_invoiceno                 AS invoiceno,") \
			_T("   facl_description              AS descr,") \
			_T("   facl_baseamt                  AS base,") \
			_T("   facl_taxamt                   AS taxamt,") \
			_T("   fac_amount                    AS amt,") \
			_T("   facl_tax_acct                 AS tax") \
			_T(" FROM   fa_cash") \
			_T("        LEFT JOIN fa_cashline ON (fac_cash_id=facl_cash_id)") \
			_T(" WHERE  fac_isactive='Y' %s") \
			_T(" ORDER  BY fac_cash_id "), szWhere);
	}
	if (szQueryID == _T("BANK_VOUCHER"))
	{
		szWhere.Format(_T(" AND fabs_invoiceno = '%s'"), szInvoiceID);
		szSQL.Format(_T(" SELECT") \
			_T("   'COMPANY NAME'                          AS org,") \
			_T("   'DEPARTMENT'                            AS department,") \
			_T("   (SELECT") \
			_T("      fap_name") \
			_T("    FROM   fa_partner") \
			_T("    WHERE  fap_partner_id=fabs_partner_id) AS obj,") \
			_T("   (SELECT") \
			_T("      fap_name") \
			_T("    FROM   fa_partner") \
			_T("    WHERE  fap_partner_id=fabs_partner_id) AS addr,") \
			_T("   fabs_invoicedate                        AS invoicedate,") \
			_T("   fabsl_debit_acct                        AS debit,") \
			_T("   fabsl_credit_acct                       AS credit,") \
			_T("   fabs_invoiceno                          AS invoiceno,") \
			_T("   fabsl_description                       AS descr,") \
			_T("   fabsl_baseamt                           AS base,") \
			_T("   fabsl_taxamt                            AS taxamt,") \
			_T("   fabs_amount                             AS amt,") \
			_T("   fabsl_tax_acct                          AS tax") \
			_T(" FROM   fa_bankstatement") \
			_T("        LEFT JOIN fa_bankstatementline ON (fabs_bankstatement_id=fabsl_bankstatement_id)") \
			_T(" WHERE  fabs_isactive='Y' %s") \
			_T(" ORDER  BY fabs_bankstatement_id "), szWhere);
	}
	if (szQueryID == _T("PAYMENT_ORDER"))
	{
		szSQL.Format(_T("SELECT 'SerialNo' as SerialNo, 'PrintDate' as PrintDate,") \
			_T(" 'Payer' as Payer, 'AccNo' as AccNo, 'Bank' as Bank, 'Receiver' as Receiver, 'AccNo0' as AccNo0,") \
			_T(" 'Bank0' as Bank0, 'TotalAmount' as TotalAmount, 'SumInWord' as SumInWord, 'Reason' as Reason") \
			_T(" FROM dual"));
	}
	if (szQueryID == _T("CREDIT_NOTE"))
	{
		szSQL.Format(_T(" SELECT 'Funder' as Funder, 'Address' as Address,") \
			_T(" 'Reason' as Reason, 'Currency' as Currency, 'Amount' as Amount,") \
			_T(" 'AmountInWord' as AmountInWord, 'No' as No, 'Date' as dte, 'AccNo' as AccNo, 1 as c1,") \
			_T(" 2 as c2, 3 as c3, 4 as c4, 5 as c5") \
			_T(" FROM dual"));
	}
	if (szQueryID == _T("PURCHASE_ORDER"))
		//szSQL.Format(_T("SELECT 'DebitAccount' as DebAcc, 'CreditAccount' as CreAcc, 'SheetNo' as ShtNo, 'SupplierName' as SupNme, 'StockName' as StkNme, 'Address' as Ads, 1 as c1, 2 as c2, 3 as c3 , 4 as c4, 5 as c5, 6 as c6, 7 as c7, 8 as c8 FROM dual"));
		szSQL.Format(_T(" SELECT") \
			_T("   po_debitacct                          AS debacc,") \
			_T("   po_creditacct                         AS creacc,") \
			_T("   po_orderno                            AS shtno,") \
			_T("   Get_partnername(po_partner_id)        AS supnme,") \
			_T("   Get_storagename(po_storage_id)        AS stknme,") \
			_T("   'Address'                             AS ads,") \
			_T("   1                                     AS c1,") \
			_T("   (SELECT") \
			_T("      mp_name") \
			_T("    FROM   m_product") \
			_T("    WHERE  mp_product_id=pol_product_id) AS c2,") \
			_T("   pol_product_id                        AS c3,") \
			_T("   Get_uomname(pol_uom_id)               AS c4,") \
			_T("   pol_qtyorder                          AS c5,") \
			_T("   pol_qtyinvoice                        AS c6,") \
			_T("   pol_unitprice                         AS c7,") \
			_T("   pol_netamount                         AS c8") \
			_T(" FROM   purchase_order") \
			_T("        LEFT JOIN purchase_orderline ON (po_purchase_order_id=pol_purchase_order_id)") \
			_T(" WHERE  po_status='A' AND po_orderno = '%s'"), szInvoiceID);
	if (szQueryID == _T("EXPORT_ORDER"))
		szSQL.Format(_T("SELECT 'DebitAccount' as DebAcc, 'CreditAccount' as CreAcc, 'SheetNo' as ShtNo, 'SupplierName' as SupNme, 'StockName' as StkNme, 'Address' as Ads, 'Unit' as Unt, 1 as c1, 2 as c2, 3 as c3 , 4 as c4, 5 as c5, 6 as c6, 7 as c7, 8 as c8 FROM dual"));
	if (szQueryID == _T("SHEET_LIST"))
	{
		if (!m_szType.IsEmpty())
			szWhere.Format(_T(" and fac_invoicetype='%s' "), m_szType);
		if (!m_szFromDate.IsEmpty() && !m_szToDate.IsEmpty())
			szWhere.AppendFormat(_T(" and trunc(fac_invoicedate) between to_date('%s', 'yyyy/mm/dd hh24:mi:ss') and to_date('%s', 'yyyy/mm/dd hh24:mi:ss') "), m_szFromDate, m_szToDate);
		if (!m_szID.IsEmpty())
		{
			szWhere.AppendFormat(_T(" and fac_invoiceno='%s' "), m_szID);
		}
		szSQL.Format(_T(" SELECT") \
			_T("   fac_cash_id                            AS id,") \
			_T("   fac_client_id,") \
			_T("   fac_org_id,") \
			_T("   fac_user_id,") \
			_T("   fac_invoicedate                        AS invdate,") \
			_T("   fac_invoiceno                          AS invno,") \
			_T("   fac_invoicedate                           AS accdate,") \
			_T("   (SELECT") \
			_T("      DISTINCT") \
			_T("      fap_name") \
			_T("    FROM   fa_partner") \
			_T("    WHERE  fap_partner_id=fac_partner_id) AS partner,") \
			_T("   fac_transactor                         AS transactor,") \
			_T("   fac_reason                             AS reason,") \
			_T("   fac_amount                             AS totalamt") \
			_T(" FROM   fa_cash") \
			_T(" WHERE  fac_isactive='Y' %s") \
			_T(" ORDER  BY fac_cash_id "), szWhere);
	}
	return szSQL;
}

void CPrintForms::SetReference(CString szSheetType, CString szSheetID, CString szFromDate, CString szToDate) {
	m_szType = szSheetType;
	if (!szFromDate.IsEmpty())
		m_szFromDate = szFromDate;
	else
		m_szFromDate.Empty();
	if (!szToDate.IsEmpty())
		m_szToDate = szToDate;
	else
		m_szToDate.Empty();
	if (!szSheetID.IsEmpty())
		m_szID = szSheetID;
	else
		m_szID.Empty();
}

void CPrintForms::PMS_PrintDrugDelivery(long nOrderID, bool bPreview, bool bDirect) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr;

	//Report Header

	CString szSQL, szUsage, szDeptType;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	long nDocumentNo;
	int nRefIndex;
	double dblTotalAmount = 0;

	szSQL.Format(_T(" SELECT 	hd_patientno as patientno,  ") \
		_T(" 	hd_docno as docno,") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	TO_CHAR(hp_birthdate, 'YYYY') as birthyear,") \
		_T(" 	hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age,") \
		_T(" 	hp_sex as sexid,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T(" 	sys_sel_getname('hms_rank', hp_rank) as rank,") \
		_T(" 	hp_occupation as occupationid,") \
		_T(" 	nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T(" 	hms_getaddress(hp_provid,hp_distid, hp_villid) as address,") \
		_T(" 	hp_workplaceid as workplaceid,") \
		_T(" 	hp_workplace as workplace,") \
		_T(" 	hd_object as objectid,") \
		_T(" 	ho_desc as objectname,") \
		_T(" 	ho_type as objecttype,") \
		_T(" 	hd_cardno as cardno,") \
		_T(" 	hd_cardidx as cardidx, ") \
		_T("	hd_reldisease as relationdisease, ") \
		_T("	hd_diagnostic ||' ['||hd_icd||']' as diagnostic, ") \
		_T(" 	hd_status, ") \
		_T(" 	hdf_acceptedfee, ") \
		_T("	trunc_date(hd_admitdate) as examdate, ") \
		_T(" 	hc_regdate as regdate, ") \
		_T(" 	hc_expdate as expdate, ") \
		_T(" 	hpo_orderdate as orderdate, ") \
		_T(" 	hpo_doctor as doctor,GET_USERNAME(hpo_doctor) as doctorname,  ") \
		_T(" 	hpo_storage_id as stockid, ") \
		_T("	GET_STORAGENAME(hpo_storage_id) as stockname	, ") \
		_T(" 	hpo_deptid as deptid, ") \
		_T(" 	hpo_roomid as roomid, ") \
		_T(" 	HMS_GETROOMNAME(hpo_deptid, hpo_roomid)  as roomname, ") \
		_T(" 	hpo_bedid as bedid, ") \
		_T(" 	hpo_depttype as depttype, ") \
		_T(" 	hpo_refidx as refidx, ") \
		_T(" 	hpo_printed as printed ") \
		_T(" FROM HMS_PHARMAORDER_VIEW") \
		_T(" LEFT JOIN hms_patient ON(hp_patientno=hpo_patientno)") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno and hd_docno=hpo_docno)") \
		_T(" LEFT JOIN hms_object ON(ho_id=hd_object) ") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hpo_orderid=%ld AND hpo_orderstatus NOT IN('O','C') "), nOrderID);
	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		_debug(_T("Order not found."));
		return;
	}


	szSQL.Format(_T(" SELECT hpol_line,") \
		_T("   hpol_product_id,") \
		_T("   hpol_productcode,") \
		_T("   hpol_productname,") \
		_T("   hpol_productuom,") \
		_T("   hpol_unitprice,") \
		_T("   SUM(hpol_qtyissue) AS hpol_qtyissue,") \
		_T("   SUM(hpol_qtyissue*hpol_unitprice) AS hpol_amount,") \
		_T("   hpol_productcountry, ") \
		_T(" HMS_GETDOUSAGE(hpol_orderid, hpol_product_id) as hpol_usage ") \
		_T(" FROM HMS_PHARMAORDERLINE_VIEW2") \
		_T(" WHERE hpol_orderid =%ld ") \
		_T(" GROUP BY hpol_orderid, hpol_line,") \
		_T("   hpol_product_id,") \
		_T("   hpol_productcode,") \
		_T("   hpol_productname,") \
		_T("   hpol_productuom,") \
		_T("   hpol_unitprice,") \
		_T("   hpol_productcountry ") \
		_T(" HAVING SUM(hpol_qtyissue) > 0 ")\
		_T(" ORDER BY hpol_productname,hpol_line"), nOrderID);

	rsl.ExecSQL(szSQL);
	if (rsl.IsEOF()) {

		_debug(_T("\r\nData not found"));
		return;
	}

	CString szReportName;
	if (rs.GetValue(_T("objectid")) == _T("7"))
		szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTE_DV.RPT"));
	else
		if (rs.GetValue(_T("objectid")) == _T("1") || rs.GetValue(_T("objectid")) == _T("3") ||
			rs.GetValue(_T("objectid")) == _T("8"))
			szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTE_D.RPT"));
		else
			szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTE.RPT"));


	if (!rpt.Init(szReportName, false, false, 1))
		return;
	_tprintf(_T("\r\n%s"), szReportName);

	//rpt.SetPrintCallback(_OnCheckPrintPrescriptionFnc);


	/*rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);*/

	tmpStr.Empty();
	StringUpper(pMF->m_szHealthService, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_szHospitalName, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);
	rs.GetValue(_T("deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("deptid")));
	rs.GetValue(_T("roomname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);

	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("OrderID"), tmpStr);

	CString szPatientName;
	rs.GetValue(_T("pname"), szPatientName);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), szPatientName);
	//In ra tuoi	
	rs.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	//Chi In ra nam sinh.
	rs.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	rs.GetValue(_T("address"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);
	rs.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);
	rs.GetValue(_T("objectname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Object"), tmpStr);

	rs.GetValue(_T("examdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExamDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("rank"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Rank"), tmpStr);

	rs.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	int nStockId;
	rs.GetValue(_T("stockname"), tmpStr);


	rpt.GetReportHeader()->SetValue(_T("Stock"), (tmpStr));
	//	rs.GetValue(_T("refidx"), nRefIndex);
	//	rs.GetValue(_T("roomid"), m_nRoomID);
	//tmpStr.Format(_T("%d"), m_nRoomID);
	rpt.GetReportHeader()->SetValue(_T("RoomID"), tmpStr);
	rs.GetValue(_T("bedid"), tmpStr);
	rs.GetValue(_T("depttype"), szDeptType);
	szDeptType.Trim();


	szSQL.Format(_T("SELECT hcr_mainicd as Icd,hcr_maindisease || ' [' || hcr_mainicd || ']' as Diagnostic, hcr_reldisease as reldisease FROM hms_clinical_record WHERE hcr_docno=%ld "), nDocumentNo);
	rs2.ExecSQL(szSQL);

	if (!rs2.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs2.GetValue(_T("Diagnostic")));

	}
	else
	{
		rs.GetValue(_T("Diagnostic"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	}
	rs2.GetValue(_T("reldisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);



	//Page Header
	//Report Detail
	CReportSection* rptDetail = rpt.GetDetail(0);
	int nItem = 1;

	CString szWhere, tmpStr2, szQty;

	nItem = 1;
	dblTotalAmount = 0;
	double money = 0;
	while (!rsl.IsEOF()) {
		rptDetail = rpt.AddDetail();
		rsl.GetValue(_T("hpol_usage"), szUsage);

		rsl.GetValue(_T("hpol_amount"), money);
		dblTotalAmount += money;
		tmpStr.Format(_T("%d"), nItem++);
		rptDetail->SetValue(_T("1"), tmpStr);
		rsl.GetValue(_T("hpol_productname"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rsl.GetValue(_T("hpol_productuom"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rsl.GetValue(_T("hpol_qtyissue"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rptDetail->SetValue(_T("4.1"), _T(""));

		rsl.GetValue(_T("hpol_unitprice"), tmpStr);
		FormatCurrencyStr(tmpStr, tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		rsl.GetValue(_T("hpol_amount"), tmpStr);
		FormatCurrencyStr(tmpStr, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rsl.GetValue(_T("hpol_productcountry"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rsl.MoveNext();
	}

	//Page Footer
	//Report Footer
	CString tmpVal;
	tmpStr.Format(_T("%d"), nItem - 1);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(dblTotalAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	tmpVal.Format(_T("%2.f"), dblTotalAmount);
	MoneyToString(tmpVal, tmpStr);
#ifdef UNICODE
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr + _T(" \x111\x1ED3ng"));
#endif
	CString szDate;
	//rs.GetValue(_T("orderdate"), tmpStr);

	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);


	rpt.GetReportFooter()->SetValue(_T("PatientSign"), szPatientName);

	rs.GetValue(_T("doctor"), tmpStr);

	/*rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem *img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if(img)
	{
		img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img->SetFixedHeight(false);
	}*/

	//rpt.GetReportFooter()->SetValue(_T("IssueBy"), pMF->GetDoctorName(GetCurrentUser()));
	CString szStatus;
	CString szAcceptedFee;
	CString szObjectType;
	int nPrinted = 0;

	rs.GetValue(_T("hd_status"), szStatus);
	rs.GetValue(_T("objecttype"), szObjectType);
	rs.GetValue(_T("printed"), nPrinted);
	rs.GetValue(_T("hd_acceptedfee"), szAcceptedFee);

	//if(CheckPermission(_T("10.10")))
	//{
	//	if(bPreview)
	//		rpt.PrintPreview();
	//	else
	//	{
	//		rpt.Print(bDirect);		
	//	}
	//}
	//else
	//{
	//	if(bPreview)
	//	{
	//		if((szObjectType == _T("I") || szObjectType == _T("C")) && (szAcceptedFee != _T("Y")) )
	//		{
	//			nPrinted = 1;
	//		}

	//		if(szObjectType == _T("D") && szStatus != _T("T"))
	//			nPrinted = 1;

	//		if(nPrinted > 0 && !CheckPermission(_T("10.10")))
	//			rpt.PrintPreview(false);
	//		else
	//			rpt.PrintPreview();

	//	}
	//	else
	//	{
	//		
	//		if(nPrinted > 0){
	//			
	//			CString szMsg;
	//			szMsg.Format(_T("\x110\x1A1n thu\x1ED1\x63 \x111\xE3 \x111\x1B0\x1EE3\x63 in [%\x64] l\x1EA7n. Kh\xF4ng th\x1EC3 in l\x1EA1i!"), nPrinted);
	//			ShowMessageBox(szMsg, MB_OK);

	//			return;
	//		}
	//		if(szObjectType == _T("D") && szStatus != _T("T"))
	//		{
	//			ShowMessageBox(_T("Patient profile not finish. Cannot allow print prescription"));
	//			return;
	//		}

	//		if((szObjectType == _T("I") || szObjectType == _T("C")) && (szAcceptedFee != _T("Y"))  && GetModuleID() != _T("FM") )
	//		{
	//			ShowMessageBox(_T("\x42\x1EC7nh nh\xE2n \x42HYT \x63h\x1B0\x61 \x64uy\x1EC7t ph\xED. Kh\xF4ng \x111\x1B0\x1EE3\x63 in \x111\x1A1n thu\x1ED1\x63!"));
	//			return;
	//		}
	//		

	//		rpt.Print(bDirect);		
	//	}
	//}

	rpt.PrintPreview(true);
}

void CPrintForms::PrintDrugReturn(long nOrderID) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr;

	//Report Header

	CString szSQL, szUsage, szDeptType;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	long nDocumentNo;
	double dblTotalAmount = 0, nTemp = 0;

	szSQL.Format(_T(" SELECT") \
		_T("   hd_patientno                                                AS patientno,") \
		_T("   hd_docno                                                    AS docno,") \
		_T("   get_patientname(hpo_docno) AS pname,") \
		_T("   To_char(hp_birthdate, 'YYYY')                               AS birthyear,") \
		_T("   Hms_getage(trunc(hd_admitdate), hp_birthdate) AS age,") \
		_T("   Get_syssel_desc('sys_sex', hp_sex)                          AS sex,") \
		_T("   hp_dtladdr                                                  AS detailaddress,") \
		_T("   CASE WHEN hpo_doctype = 'DRO' THEN CAST(hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS NVARCHAR2(254))") \
		_T("   ELSE (SELECT so_partneraddress FROM sale_order WHERE so_sale_order_id = hpo_orderid) END AS address,") \
		_T("   hp_workplaceid                                              AS workplaceid,") \
		_T("   hp_workplace                                                AS workplace,") \
		_T("   hd_object                                                   AS objectid,") \
		_T("   Hms_getobjectname(hd_object)                                AS objectname,") \
		_T("   hd_cardno                                                   AS cardno,") \
		_T("   hd_cardidx                                                  AS cardidx,") \
		_T("   hd_reldisease                                               AS relationdisease,") \
		_T("   hd_diagnostic||' ['||hd_icd||']'                            AS diagnostic,") \
		_T("   hc_regdate                                                  AS regdate,") \
		_T("   hc_expdate                                                  AS expdate,") \
		_T("   hpo_approvedby                                              AS doctor,") \
		_T("   get_storagename(hpo_storage_id)							   AS stock,") \
		_T("   CASE WHEN hpo_doctype = 'DRO' THEN CAST(hpo_orderid AS NVARCHAR2(8)) ") \
		_T("   ELSE (select so_orderno from sale_order where so_sale_order_id = hpo_orderid) END AS forderid,") \
		_T("   hpo_approveddate AS retdate,") \
		_T("   get_departmentname(hpo_deptid)                                                  AS dept") \
		_T(" FROM   hms_pharmareturnorder") \
		_T("        LEFT JOIN hms_doc ON(hd_docno=hpo_docno)") \
		_T("        LEFT JOIN hms_patient ON(hd_patientno=hp_patientno)") \
		_T("        LEFT JOIN hms_card ON(hc_patientno=hd_patientno") \
		_T("                              AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hpo_pharmareturnorder_id=%ld AND hpo_status <>'O' "), nOrderID);
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
		return;

	szSQL.Format(_T(" SELECT ") \
		_T("   product_item_id,") \
		_T("   product_name,") \
		_T("   product_uomname,") \
		_T("   SUM(hpol_qtyreturn)                AS product_qtyreverse,") \
		_T("   hpol_unitprice AS price,") \
		_T("   SUM(hpol_qtyreturn*hpol_unitprice) AS amount,") \
		_T("   product_countryname AS mfg") \
		_T(" FROM hms_pharmareturnorder_line") \
		_T(" LEFT JOIN m_productitem_view") \
		_T(" ON(product_item_id             =hpol_product_item_id)") \
		_T(" WHERE hpol_pharmareturnorder_id=%ld ") \
		_T(" GROUP BY ") \
		_T("   product_item_id,") \
		_T("   product_name,") \
		_T("   product_uomname,") \
		_T("   hpol_unitprice,") \
		_T("   product_countryname") \
		_T(" ORDER BY product_name "), nOrderID);
	rsl.ExecSQL(szSQL);
	if (rsl.IsEOF())
	{
		return;
	}
	if (pMF->GetModuleID() == _T("GLS"))
	{
		if (!rpt.Init(_T("Reports/HMS/GLS_ITEMRETURN.RPT")))
			return;
	}
	else
	{
		if (!rpt.Init(_T("Reports/HMS/PMS_DRUGRETURN.RPT")))
			return;
	}

	tmpStr.Empty();
	rpt.GetReportHeader()->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rs.GetValue(_T("dept"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
	rs.GetValue(_T("roomname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("OrderID"), tmpStr);
	rs.GetValue(_T("forderid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("FOrderID"), tmpStr);
	rs.GetValue(_T("stock"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Stock"), tmpStr);
	CString szPatientName;
	rs.GetValue(_T("pname"), szPatientName);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), szPatientName);
	//In ra tuoi	
	rs.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	//Chi In ra nam sinh.
	rs.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	rs.GetValue(_T("address"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);
	tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("ReturnDate")), CDate::Convert(rs.GetValue(_T("retdate")), yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("ReturnDate"), tmpStr);

	//Page Header
	//Report Detail
	CReportSection* rptDetail = rpt.GetDetail(0);
	int nItem = 1;

	CString szWhere, tmpStr2, szQty;

	nItem = 1;
	dblTotalAmount = 0;
	while (!rsl.IsEOF()) {
		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nItem++);
		rptDetail->SetValue(_T("1"), tmpStr);
		rsl.GetValue(_T("product_name"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rsl.GetValue(_T("product_uomname"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rsl.GetValue(_T("product_qtyreverse"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rsl.GetValue(_T("price"), tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		rsl.GetValue(_T("amount"), nTemp);
		dblTotalAmount += nTemp;
		tmpStr.Format(_T("%f"), nTemp);
		rptDetail->SetValue(_T("6"), tmpStr);
		rsl.GetValue(_T("mfg"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rsl.MoveNext();
	}

	//Page Footer
	//Report Footer
	CString tmpVal;
	tmpStr.Format(_T("%d"), nItem - 1);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(dblTotalAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	tmpVal.Format(_T("%2.f"), dblTotalAmount);
	MoneyToString(tmpVal, tmpStr);
#ifdef UNICODE
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr + _T(" \x111\x1ED3ng"));
#endif
	CString szDate;
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);


	rpt.GetReportFooter()->SetValue(_T("PatientSign"), szPatientName);

	rs.GetValue(_T("doctor"), tmpStr);

	rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{
		//		img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img->SetFixedHeight(false);
	}

	rpt.GetReportFooter()->SetValue(_T("IssueBy"), GetDoctorName(pMF->GetCurrentUser()));
	rpt.PrintPreview();
}


void CPrintForms::PM_PrintDrugDeliveryOrder(long nOrderID) {

}

CString CPrintForms::GetDoctorName(CString szDoctorID)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CString szSQL, szRet;
	CRecord rs(&pMF->m_db);
	szRet.Empty();
	szSQL.Format(_T("SELECT su_name ") \
		_T(" FROM sys_user") \
		_T(" WHERE lower(su_userid)=lower('%s')"), szDoctorID);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return _T("");
	rs.GetValue(_T("su_name"), szRet);
	return szRet;
}


void CPrintForms::PrintDeliveryOrder(long nOID) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CRecord ors(&pMF->m_db);
	CString szSQL, szStatus, szDoctor, tmpStr;
	szSQL.Format(_T("SELECT mt_status, mt_updatedby, mt_orderdate  ") \
		_T("FROM m_transaction ") \
		_T("WHERE mt_transaction_id=%ld "), nOID);
	ors.ExecSQL(szSQL);
	if (ors.IsEOF())
		return;
	ors.GetValue(_T("mt_status"), szStatus);
	ors.GetValue(_T("mt_updatedby"), szDoctor);
	ors.GetValue(_T("mt_orderdate"), tmpStr);
	if (szStatus == _T("O"))
		return;

	CString szPrintType;
	szSQL.Format(_T("SELECT hi_deliveryvote_printtype FROM hms_config "));
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		//	rs.GetValue(_T("hi_autoprint_deliveryvote"), m_szAutoPrintDeliveryVote);
		rs.GetValue(_T("hi_deliveryvote_printtype"), szPrintType);
	}
	if (szPrintType == _T("P"))
	{
		OnPrintDelivery(nOID, tmpStr.Left(10), szDoctor);
		return;
	}
	else
	{
		szSQL.Format(_T(" SELECT distinct trunc(hpo_orderdate) as orderdate ") \
			_T(" FROM hms_pharmaorder ") \
			_T(" WHERE 	hpo_transaction_id=%ld ") \
			_T(" ORDER BY trunc(hpo_orderdate) DESC "), nOID);
		rs.ExecSQL(szSQL);

		while (!rs.IsEOF()) {
			rs.GetValue(_T("orderdate"), tmpStr);
			OnPrintDelivery(nOID, tmpStr, szDoctor);
			rs.MoveNext();
		}
	}

}
void CPrintForms::OnPrintDelivery(long nOID, LPCTSTR lpszDate, LPCTSTR lpszDoctor)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szSQL, szPrintType, szDeptID;
	CString szTransactionOrderNo;
	CRecord rs(&pMF->m_db);
	CRecord prs(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	CRecord rsx(&pMF->m_db);
	int nRoomId, nBedIdx;
	CString	szOldDate, szNewDate, szReportDate, szPrintDate;
	CString szDepartment;
	CString szRoomName, szBedName;
	szSQL.Format(_T("SELECT hi_deliveryvote_printtype FROM hms_config "));
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		//	rs.GetValue(_T("hi_autoprint_deliveryvote"), m_szAutoPrintDeliveryVote);
		rs.GetValue(_T("hi_deliveryvote_printtype"), szPrintType);
	}

	if (szPrintType == _T("P"))
	{
		CReportSection* rptDetail = NULL;
		CString szItemID;
		long nOrderID;

		if (!rpt.Init(_T("Reports/HMS/HT_DAILYDELIVERYDRUGPORTRAIT.RPT"), true, false))
			return;


		rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));

		tmpStr.Empty();
		//StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
		rptDetail->SetValue(_T("HealthService"), pMF->m_szHealthService);
		//StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
		rptDetail->SetValue(_T("HospitalName"), pMF->m_szHospitalName);

		szNewDate.Empty();
		szOldDate.Empty();
		szReportDate = rptDetail->GetValue(_T("ReportDate"));

		tmpStr.Format(szReportDate, CDate::Convert(szNewDate, yyyymmdd, ddmmyyyy));
		rptDetail->SetValue(_T("ReportDate"), tmpStr);
		rptDetail->SetValue(_T("SheetNo"), szTransactionOrderNo);
		//Page Header
		szSQL.Format(_T(" SELECT  hpo_docno as docno, ") \
			_T(" hpo_deptid as deptid, ") \
			_T(" hpo_orderid as orderid, ") \
			_T(" trunc(hpo_orderdate) as orderdate, ") \
			_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
			_T(" hms_getage(trunc(hd_admitdate), hp_birthdate) as age, ") \
			_T(" date_part('year', hp_birthdate) as yearofbirth, ") \
			_T(" hpo_roomid as roomid,	hpo_bedid as bedid ") \
			_T(" FROM hms_patient ") \
			_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno) ") \
			_T(" LEFT JOIN hms_ipharmaorder ON(hpo_docno=hd_docno)") \
			_T(" WHERE 	hpo_transaction_id=%ld ") \
			_T(" ORDER BY orderdate, roomid, bedid, pname, docno"), nOID);
		prs.ExecSQL(szSQL);


		int i = 1;
		CString szDate, szDoctorName;

		tmpStr = pMF->GetSysDate();

		szDoctorName = GetDoctorName(lpszDoctor);

		szDate = rpt.GetGroupFooter(1)->GetValue(_T("PrintDate"));
		tmpStr = pMF->GetSysDateTime();
		szPrintDate.Format(szDate, tmpStr.Mid(10, 6), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));

		while (!prs.IsEOF())
		{

			prs.GetValue(_T("orderdate"), szNewDate);
			if (szOldDate.IsEmpty()) {
				szOldDate = szNewDate;
				tmpStr.Format(szReportDate, CDate::Convert(szNewDate, yyyymmdd, ddmmyyyy));
				rptDetail->SetValue(_T("ReportDate"), tmpStr);

			}
			if (rptDetail && szNewDate != szOldDate) {
				szOldDate = szNewDate;
				rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
				rptDetail->SetValue(_T("PrintDate"), szPrintDate);
				//	rs.GetValue(_T("doctor"), tmpStr);
				rptDetail->SetValue(_T("Doctor"), szDoctorName);
				CReportItem* img = rptDetail->GetItem(_T("Signature"));
				if (img)
				{
					//				img->SetHBITMAP(pMF->GetSignatureImage(lpszDoctor));
					img->SetFixedHeight(false);
				}

				rptDetail->SetPageBreak(true);


				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
				tmpStr.Empty();
				//StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
				rptDetail->SetValue(_T("HealthService"), pMF->m_szHealthService);
				//StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
				rptDetail->SetValue(_T("HospitalName"), pMF->m_szHospitalName);

				tmpStr.Format(szReportDate, CDate::Convert(szNewDate, yyyymmdd, ddmmyyyy));
				rptDetail->SetValue(_T("ReportDate"), tmpStr);
				rptDetail->SetValue(_T("SheetNo"), szTransactionOrderNo);


			}

			rptDetail = rpt.AddDetail();
			rptDetail->GetItem(_T("1"))->SetBold(true);
			rptDetail->GetItem(_T("2"))->SetBold(true);
			rptDetail->GetItem(_T("3"))->SetBold(true);
			rptDetail->GetItem(_T("4"))->SetBold(true);

			prs.GetValue(_T("deptid"), szDepartment);
			rpt.GetReportHeader()->SetValue(_T("Department"), szDepartment);

			rptDetail->SetValue(_T("1"), CDate::Convert(szNewDate, yyyymmdd, ddmmyyyy));
			prs.GetValue(_T("pname"), tmpStr);
			CString szPatientName;
			szPatientName.Format(_T("[%s] %s  - %s"), prs.GetValue(_T("docno")), tmpStr, prs.GetValue(_T("age")));
			rptDetail->SetValue(_T("2"), szPatientName);

			prs.GetValue(_T("age"), tmpStr);
			rptDetail->SetValue(_T("age"), tmpStr);
			prs.GetValue(_T("yearofbirth"), tmpStr);
			rptDetail->SetValue(_T("yearofbirth"), tmpStr);


			prs.GetValue(_T("roomname"), nRoomId);
			rptDetail->SetValue(_T("3"), szRoomName);
			prs.GetValue(_T("bedname"), nBedIdx);
			rptDetail->SetValue(_T("4"), szBedName);

			prs.GetValue(_T("orderid"), nOrderID);

			szSQL.Format(_T(" SELECT 	product_id as itemid,") \
				_T(" product_name as name, product_uomname as unit, ") \
				_T(" 	sum(hpol_qtyorder) as qty, HMS_GETDOUSAGE(hpol_orderid, hpol_product_id) as usage ") \
				_T(" FROM hms_ipharmaorderline ") \
				_T(" LEFT JOIN m_productitem_view  ON(hpol_product_item_id=product_item_id)") \
				_T(" WHERE hpol_orderid=%ld ") \
				_T(" GROUP BY product_id, product_name, product_uomname, hpol_orderid, hpol_product_id ") \
				_T(" ORDER BY name"), nOrderID);
			rsl.ExecSQL(szSQL);
			int n = 1;
			while (!rsl.IsEOF()) {
				rptDetail = rpt.AddDetail();
				tmpStr.Format(_T("%d"), n++);
				rptDetail->SetValue(_T("1"), tmpStr);
				rsl.GetValue(_T("name"), tmpStr);
				rptDetail->SetValue(_T("2"), tmpStr);
				rsl.GetValue(_T("unit"), tmpStr);
				rptDetail->SetValue(_T("3"), tmpStr);
				rsl.GetValue(_T("qty"), tmpStr);
				rptDetail->SetValue(_T("4"), tmpStr);
				rsl.GetValue(_T("usage"), tmpStr);
				rptDetail->SetValue(_T("5"), tmpStr);
				rsl.MoveNext();
			}


			prs.MoveNext();
		}

		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
		rptDetail->SetValue(_T("PrintDate"), szPrintDate);
		//	rs.GetValue(_T("doctor"), tmpStr);
		rptDetail->SetValue(_T("Doctor"), szDoctorName);
		CReportItem* img = rptDetail->GetItem(_T("Signature"));
		if (img)
		{
			//			img->SetHBITMAP(pMF->GetSignatureImage(lpszDoctor));
			img->SetFixedHeight(false);
		}
		rpt.PrintPreview();


	}
	else
	{
		if (!rpt.Init(_T("Reports/HMS/HT_DAILYDELIVERYDRUG.RPT")))
			return;

		tmpStr.Empty();
		//StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
		rpt.GetReportHeader()->SetValue(_T("HealthService"), pMF->m_szHealthService);
		//StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
		rpt.GetReportHeader()->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		rpt.GetReportHeader()->SetValue(_T("Department"), szDepartment);
		tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("ReportDate")), CDate::Convert(lpszDate, yyyymmdd, ddmmyyyy));
		rpt.GetReportHeader()->SetValue(_T("ReportDate"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("SheetNo"), szTransactionOrderNo);


		//Page Header

		szSQL.Format(_T(" SELECT distinct product_name as drugname, product_id as itemid ") \
			_T(" FROM hms_ipharmaorder ") \
			_T(" LEFT JOIN hms_ipharmaorderline ON(hpo_orderid=hpol_orderid)") \
			_T(" LEFT JOIN m_productitem_view  ON(hpol_product_item_id=product_item_id)") \
			_T(" WHERE 	hpo_transaction_id=%ld ") \
			_T(" 	and trunc(hpo_orderdate)='%s' ORDER BY drugname "), nOID, lpszDate);
		int nCount = rs.ExecSQL(szSQL);
		if (rs.IsEOF())
			return;
		CString szName;
		int i = 1;
		while (!rs.IsEOF())
		{
			szName.Format(_T("%d"), i++);
			rs.GetValue(_T("drugname"), tmpStr);
			rpt.GetPageHeader()->SetValue(szName, tmpStr);
			rs.MoveNext();
		}
		for (; i < 37; i++) {
			szName.Format(_T("%d"), i++);
			rpt.GetPageHeader()->SetValue(szName, _T(""));
		}
		szSQL.Format(_T(" SELECT  hpo_docno as docno, hpo_orderid as orderid, ") \
			_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
			_T(" hms_getage(trunc(hd_admitdate), hp_birthdate) as age, ") \
			_T(" date_part('year', hp_birthdate) as yearofbirth, ") \
			_T(" 	hpo_deptid as deptid, hpo_roomid as roomid, hpo_bedid as bedid ") \
			_T(" FROM hms_patient ") \
			_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno) ") \
			_T(" LEFT JOIN hms_ipharmaorder ON(hpo_docno=hd_docno)") \
			_T(" WHERE 	hpo_transaction_id=%ld ") \
			_T(" 	and trunc(hpo_orderdate)='%s'") \
			_T(" ORDER BY pname, docno"), nOID, lpszDate);
		prs.ExecSQL(szSQL);
		CReportSection* rptDetail;
		CString szItemID;
		long nOrderID;
		i = 1;
		while (!prs.IsEOF())
		{
			rptDetail = rpt.AddDetail();
			szName.Format(_T("%d"), i++);
			rptDetail->SetValue(_T("Index"), szName);
			prs.GetValue(_T("docno"), tmpStr);
			rptDetail->SetValue(_T("DocNo"), tmpStr);
			prs.GetValue(_T("pname"), tmpStr);
			rptDetail->SetValue(_T("PatientName"), tmpStr);
			prs.GetValue(_T("age"), tmpStr);
			rptDetail->SetValue(_T("age"), tmpStr);
			prs.GetValue(_T("yearofbirth"), tmpStr);
			rptDetail->SetValue(_T("yearofbirth"), tmpStr);

			prs.GetValue(_T("department"), szDepartment);
			prs.GetValue(_T("roomname"), szRoomName);
			rptDetail->SetValue(_T("roomname"), szRoomName);
			prs.GetValue(_T("bedname"), szBedName);
			rptDetail->SetValue(_T("bedname"), szBedName);

			rptDetail->SetValue(_T("SignLabel"), _T(""));

			prs.GetValue(_T("orderid"), nOrderID);

			szSQL.Format(_T(" SELECT 	product_id as itemid,") \
				_T(" 	sum(hpol_qtyorder) as qty") \
				_T(" FROM hms_ipharmaorderline ") \
				_T(" LEFT JOIN m_productitem_view  ON(hpol_product_item_id=product_item_id)") \
				_T(" WHERE hpol_orderid=%ld ") \
				_T(" GROUP BY product_id"), nOrderID);
			rsl.ExecSQL(szSQL);
			while (!rsl.IsEOF()) {
				int n = 0;
				rsl.GetValue(_T("itemid"), szItemID);
				rs.MoveFirst();
				while (!rs.IsEOF())
				{
					n++;
					rs.GetValue(_T("itemid"), tmpStr);
					if (tmpStr == szItemID) {
						break;
					}

					rs.MoveNext();
				}
				szName.Format(_T("%d"), n);
				rsl.GetValue(_T("qty"), tmpStr);
				rptDetail->SetValue(szName, tmpStr);
				rsl.MoveNext();
			}
			prs.MoveNext();
		}

		CString szDate;
		tmpStr = pMF->GetSysDate();
		szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
		rpt.GetReportFooter()->SetValue(_T("Doctor"), GetDoctorName(lpszDoctor));
		CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
		if (img)
		{
			//		img->SetHBITMAP(pMF->GetSignatureImage(lpszDoctor));
			img->SetFixedHeight(false);
		}
		rpt.PrintPreview();
	}
}

CString CPrintForms::GetReportName() {
	return m_szReportName;
}

void CPrintForms::OnPrintDailyViewDetail(LPCTSTR lpszOrderNo, LPCTSTR lpszDate, LPCTSTR lpszTransactionString, long nProduct_ID, long nProductItem_ID, LPCTSTR lpszOrderType, int nStorage_ID, CString szOrgID) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szSQL;
	CString szTransactionOrderNo;
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	int nProduct_item_id;
	CString	szOldDate, szNewDate, szReportDate, szPrintDate;
	CString szDepartment;
	CString szRoomName, szBedName;
	CString szTableName;
	CReportSection* rptDetail = NULL;

	if (!rpt.Init(_T("Reports/HMS/HT_DAILYDELIVERYDRUGVIEWDETAIL_ALL.RPT"), true, false))
		return;

	if (szOrgID == _T("TM"))
		szTableName = _T("hms_ipharmaorder");
	else
		szTableName = _T("hms_pharmaorder");

	rptDetail = rpt.GetReportHeader();

	tmpStr.Empty();
	StringUpper(pMF->m_szHealthService, tmpStr);
	rptDetail->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_szHospitalName, tmpStr);
	rptDetail->SetValue(_T("HospitalName"), tmpStr);

	szNewDate.Empty();
	szOldDate.Empty();
	szReportDate = rptDetail->GetValue(_T("ReportDate"));

	tmpStr.Format(szReportDate, CDate::Convert(szNewDate, yyyymmdd, ddmmyyyy));
	rptDetail->SetValue(_T("ReportDate"), tmpStr);
	rptDetail->SetValue(_T("SheetNo"), szTransactionOrderNo);
	//Page Header	
	CString szWhere;
	szWhere.Empty();
	if (nProductItem_ID > 0)
		szWhere.Format(_T(" and product_item_id=%ld "), nProductItem_ID);

	if (szOrgID == _T("TM"))
	{
		szSQL.Format(_T(" SELECT Get_StorageName(hpo_storage_id) as storagename, hpo_storage_id,") \
			_T("	product_id, product_name as product_name, ") \
			_T(" 	product_uomname as product_unit,") \
			_T(" 	hpol_unitprice as product_taxprice,") \
			_T(" 	sum(hpol_qtyorder) as product_qtyorder,") \
			_T(" 	sum(hpol_qtyissue) as product_qtyissue,") \
			_T(" 	sum(hpol_qtyissue*hpol_unitprice) as product_amount ") \
			_T(" FROM %s ") \
			_T(" LEFT JOIN %sline ON(hpo_orderid=hpol_orderid)") \
			_T(" LEFT JOIN m_productitem_view ON(product_item_id=hpol_product_item_id) ") \
			_T(" WHERE hpo_ordertype in(%s) ") \
			_T("	AND hpo_transaction_id in(%s)  ") \
			_T("	AND hpo_storage_id = %ld AND product_id=%ld  %s ") \
			_T("	AND hpo_org_id NOT IN('SMM') ") \
			_T(" GROUP BY hpo_storage_id, product_id, ") \
			_T("	product_name, product_uomname, hpol_unitprice ") \
			_T(" ORDER BY hpo_storage_id, product_name, product_unit, product_taxprice  "),
			szTableName, szTableName,
			lpszOrderType,
			lpszTransactionString,
			nStorage_ID,
			nProduct_ID,
			szWhere
		);
	}
	else
	{
		szSQL.Format(_T(" SELECT Get_StorageName(hpo_storage_id) as storagename, hpo_storage_id,") \
			_T("	product_id, product_item_id, product_name as product_name, ") \
			_T(" 	product_uomname as product_unit,") \
			_T(" 	hpol_unitprice as product_taxprice,") \
			_T(" 	sum(hpol_qtyorder) as product_qtyorder,") \
			_T(" 	sum(hpol_qtyissue) as product_qtyissue,") \
			_T(" 	sum(hpol_qtyissue*hpol_unitprice) as product_amount ") \
			_T(" FROM %s ") \
			_T(" LEFT JOIN %sline ON(hpo_orderid=hpol_orderid)") \
			_T(" LEFT JOIN m_productitem_view ON(product_item_id=hpol_product_item_id) ") \
			_T(" WHERE hpo_ordertype in(%s) ") \
			_T("	AND hpo_transaction_id in(%s)  ") \
			_T("	AND hpo_storage_id = %ld AND product_id=%ld  %s ") \
			_T("	AND hpo_org_id NOT IN('SMM') ") \
			_T(" GROUP BY hpo_storage_id, product_id, product_item_id, ") \
			_T("	product_name, product_uomname, hpol_unitprice ") \
			_T(" ORDER BY hpo_storage_id, product_name, product_unit, product_taxprice  "),
			szTableName, szTableName,
			lpszOrderType,
			lpszTransactionString,
			nStorage_ID,
			nProduct_ID,
			szWhere
		);
	}
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF()) {
		ShowMessageBox(_T("No data"));
		return;
	}

	rs.GetValue(_T("product_item_id"), nProduct_item_id);
	rptDetail->SetValue(_T("Storage"), rs.GetValue(_T("storagename")));
	rptDetail->SetValue(_T("SheetNo"), lpszOrderNo);
	rptDetail->SetValue(_T("DrugName"), rs.GetValue(_T("product_name")));
	rptDetail->SetValue(_T("Unit"), rs.GetValue(_T("product_unit")));
	rptDetail->SetValue(_T("Qty"), rs.GetValue(_T("product_qtyorder")));

	szSQL.Format(_T(" SELECT DISTINCT orderdate,") \
		_T("   pname,") \
		_T("   docno,") \
		_T("   recordno,") \
		_T("   get_departmentname(deptid) deptname,") \
		_T("   (select sd_id_alias from sys_dept where sd_id = deptid) as deptid, roomname, ") \
		_T("   bedname, ") \
		_T("   cardno, ") \
		_T("   objectname, ") \
		_T("   address, ")
		_T("   yearofbirth, ") \
		_T("   hpo_storage_id,") \
		_T("   product_name,") \
		_T("   product_unit,") \
		_T("   product_taxprice,") \
		_T("   SUM(product_qtyorder) AS QtyOrder,") \
		_T("   SUM(product_qtyissue) AS QtyIssue") \
		_T(" FROM") \
		_T("   (SELECT hpo_docno      AS docno,") \
		_T("	 hcr_recordno recordno,") \
		_T("     hpo_deptid           AS deptid,") \
		_T("     hpo_orderid          AS orderid,") \
		_T("     trunc(hpo_orderdate) AS orderdate,") \
		_T("     trim(hp_surname") \
		_T("     ||' '") \
		_T("     ||hp_midname") \
		_T("     ||' '") \
		_T("     ||hp_firstname)                               AS pname,") \
		_T("     hms_getage(trunc(hd_admitdate), hp_birthdate) AS age,") \
		_T("     extract(year from hp_birthdate)               AS yearofbirth,") \
		_T(" 	 hms_getaddress(hp_provid,hp_distid,hp_villid) as address,") \
		_T(" (SELECT hrl_name") \
		_T("     FROM hms_roomlist") \
		_T("     WHERE hrl_id  =hpo_roomid") \
		_T("     AND hrl_deptid=hpo_deptid") \
		_T("     ) AS roomname,") \
		_T("     (SELECT hbl_name") \
		_T("     FROM hms_bedlist") \
		_T("     WHERE hbl_id  = hpo_bedid") \
		_T("     AND hbl_roomid=hpo_roomid") \
		_T("     AND hbl_deptid=hpo_deptid") \
		_T("     ) AS bedname,") \
		_T("	 ho_desc as objectname, ") \
		_T(" 	 hd_cardno as cardno,") \
		_T("     hpo_storage_id,") \
		_T("     product_id,") \
		_T("     product_item_id,") \
		_T("     product_name    AS product_name,") \
		_T("     product_uomname AS product_unit,") \
		_T("     hpol_unitprice  AS product_taxprice,") \
		_T("     hpol_qtyorder   AS product_qtyorder,") \
		_T("     hpol_qtyissue   AS product_qtyissue") \
		_T("   FROM %s ") \
		_T("   LEFT JOIN %sline") \
		_T("   ON(hpo_orderid=hpol_orderid)") \
		_T("   LEFT JOIN m_productitem_view") \
		_T("   ON(product_item_id   =hpol_product_item_id)") \
		_T("   LEFT JOIN hms_doc") \
		_T("   ON(hpo_docno=hd_docno)") \
		_T("   LEFT JOIN hms_clinical_record ON (hd_docno = hcr_docno)")
		_T(" LEFT JOIN hms_patient ") \
		_T("   ON(hd_patientno=hp_patientno)") \
		_T("   LEFT JOIN hms_object ON(ho_id=hd_object) ") \
		_T("   LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T("   WHERE hpo_ordertype  IN(%s)") \
		_T("   AND hpo_transaction_id IN(%s) AND hpo_org_id NOT IN('SMM')") \
		_T(" and hpo_storage_id=%ld ") \
		_T("   AND product_id  =%ld  %s ") \
		_T("   )") \
		_T(" GROUP BY orderdate,") \
		_T("   pname,") \
		_T("   docno,") \
		_T("   recordno,") \
		_T("   deptid, roomname, bedname, ") \
		_T("   cardno, ") \
		_T("   objectname, ") \
		_T("   address, ") \
		_T("   yearofbirth, ") \
		_T("   hpo_storage_id,") \
		_T("   product_name,") \
		_T("   product_unit,") \
		_T("   product_taxprice") \
		_T(" ORDER BY docno,") \
		_T("   pname,") \
		_T("   orderdate,") \
		_T("   hpo_storage_id,") \
		_T("   product_name,") \
		_T("   product_unit,") \
		_T("   product_taxprice"),
		szTableName, szTableName,
		lpszOrderType, lpszTransactionString, nStorage_ID, nProduct_ID, szWhere);

	//_msg(_T("%s"), szSQL);
	rsl.ExecSQL(szSQL);
	int nIdx = 0;
	while (!rsl.IsEOF())
	{
		nIdx++;
		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nIdx);
		rptDetail->SetValue(_T("0"), tmpStr);
		rsl.GetValue(_T("OrderDate"), tmpStr);
		rptDetail->SetValue(_T("1"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rsl.GetValue(_T("pname"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rsl.GetValue(_T("docno"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rsl.GetValue(_T("recordno"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);

		rsl.GetValue(_T("deptid"), tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);

		rsl.GetValue(_T("roomname"), tmpStr);
		rptDetail->SetValue(_T("5.1"), tmpStr);

		rsl.GetValue(_T("QtyOrder"), tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rsl.GetValue(_T("CardNo"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rsl.GetValue(_T("ObjectName"), tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		rsl.GetValue(_T("Address"), tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);

		rsl.MoveNext();
	}

	CString szDate, szSysDate;
	szSysDate = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Mid(11, 5), szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.PrintPreview();
}

void CPrintForms::PM_PrintCabinetUsageDetail(LPCTSTR lpszOrderNo, LPCTSTR lpszDate, LPCTSTR lpszTransactionString, long nProduct_id, LPCTSTR lpszOrderType, int nStorage_ID, CString szOrgID) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szSQL;
	CString szTransactionOrderNo;
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	int nProduct_item_id;
	CString	szOldDate, szNewDate, szReportDate, szPrintDate;
	CString szDepartment;
	CString szRoomName, szBedName;
	CReportSection* rptDetail = NULL;

	if (!rpt.Init(_T("Reports/HMS/HT_DAILYDELIVERYDRUGVIEWDETAIL.RPT"), true, false))
		return;

	rptDetail = rpt.GetReportHeader();

	tmpStr.Empty();
	StringUpper(pMF->m_szHealthService, tmpStr);
	rptDetail->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_szHospitalName, tmpStr);
	rptDetail->SetValue(_T("HospitalName"), tmpStr);

	szNewDate.Empty();
	szOldDate.Empty();
	szReportDate = rptDetail->GetValue(_T("ReportDate"));

	tmpStr.Format(szReportDate, CDate::Convert(szNewDate, yyyymmdd, ddmmyyyy));
	rptDetail->SetValue(_T("ReportDate"), tmpStr);
	rptDetail->SetValue(_T("SheetNo"), szTransactionOrderNo);
	//Page Header	

	szSQL.Format(_T("SELECT Get_storagename(mt_storage_id)        AS storagename, ") \
		_T("       mt_storage_id, ") \
		_T("	   get_storagename(mt_storage_to_id) AS storagetoname,")
		_T("       product_id, ") \
		_T("       product_name                          AS product_name, ") \
		_T("	   case when hmt_product_id <> hmt_suppproduct_id and hmt_suppproduct_id > 0 then (select distinct mp_name from m_product where mp_product_id = hmt_suppproduct_id) else cast('' as nvarchar2(254)) end as xproduct_name, ") \
		_T("       product_uomname                       AS product_unit, ") \
		_T("       Sum(hmt_qtyissue)                     AS product_qtyorder, ") \
		_T("       Sum(hmt_qtyissue)                     AS product_qtyissue, ") \
		_T("       Sum(hmt_qtyissue * product_unitprice) AS product_amount ") \
		_T("FROM   hms_medical_transaction_view ") \
		_T("       LEFT JOIN m_product_view ") \
		_T("              ON( product_id = hmt_product_id ) ") \
		_T("       LEFT JOIN m_transaction ") \
		_T("              ON ( mt_transaction_id = hmt_reftransaction_id ) ") \
		_T("WHERE hmt_reftransaction_id = %s ") \
		_T("       AND (hmt_suppproduct_id = %d or hmt_product_id=%ld) ") \
		_T("       AND mt_storage_id = %d ") \
		_T("GROUP  BY mt_storage_id, ") \
		_T("		  mt_storage_to_id,") \
		_T("          product_id, ") \
		_T("          hmt_product_id, ") \
		_T("          hmt_suppproduct_id, ") \
		_T("          product_name, ") \
		_T("          product_uomname ") \
		_T("ORDER  BY mt_storage_id, ") \
		_T("          product_name, ") \
		_T("          product_unit "),
		lpszTransactionString, nProduct_id, nProduct_id, nStorage_ID);
	rs.ExecSQL(szSQL);
	_fmsg(_T("%s"), szSQL);
	if (rs.IsEOF()) {
		ShowMessageBox(_T("No data"));
		return;
	}

	CString  szName;
	rs.GetValue(_T("product_item_id"), nProduct_item_id);
	rptDetail->SetValue(_T("Storage"), rs.GetValue(_T("storagename")));
	rptDetail->SetValue(_T("ToStorage"), rs.GetValue(_T("storagetoname")));
	rptDetail->SetValue(_T("SheetNo"), lpszOrderNo);
	rs.GetValue(_T("xproduct_name"), tmpStr);
	rs.GetValue(_T("product_name"), szName);
	if (!tmpStr.IsEmpty())
		szName.AppendFormat(_T(" ->[%s]"), tmpStr);
	rptDetail->SetValue(_T("DrugName"), szName);
	rptDetail->SetValue(_T("Unit"), rs.GetValue(_T("product_unit")));
	rptDetail->SetValue(_T("Qty"), rs.GetValue(_T("product_qtyorder")));

	if (szOrgID != _T("EM"))
	{
		szSQL.Format(_T("SELECT DISTINCT orderdate, ") \
			_T("                roomname, ") \
			_T("                bedname, ") \
			_T("                pname, ") \
			_T("                docno, ") \
			_T("				recordno,") \
			_T("				get_departmentname(deptid) deptname,") \
			_T("                cardno, ") \
			_T("                objectname, ") \
			_T("                address, ") \
			_T("                yearofbirth, ") \
			_T("                hpo_storage_id, ") \
			_T("                product_name, ") \
			_T("                product_unit, ") \
			_T("                Sum(product_qtyorder) AS QtyOrder, ") \
			_T("                Sum(product_qtyissue) AS QtyIssue, table_name") \
			_T(" FROM   (SELECT hmt_docno                                       AS docno, ") \
			_T("			   hcr_recordno recordno,") \
			_T("               (select htr_deptid from hms_treatment_record where htr_docno = hmt_docno and htr_status = 'I') deptid, ") \
			_T("               hmt_medical_transaction_id                      AS orderid, ") \
			_T("               trunc(hpo_orderdate)                            AS orderdate, ") \
			_T("               Trim(hp_surname ") \
			_T("                    || ' ' ") \
			_T("                    || hp_midname ") \
			_T("                    || ' ' ") \
			_T("                    || hp_firstname)                           AS pname, ") \
			_T("               Hms_getage(trunc(hd_admitdate), hp_birthdate)   AS age, ") \
			_T("               Extract(YEAR FROM hp_birthdate)                 AS yearofbirth, ") \
			_T("               hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS address, ") \
			_T("               (SELECT hrl_name ") \
			_T("                FROM   hms_roomlist ") \
			_T("                WHERE  hrl_id = hpo_roomid ") \
			_T("                       AND hrl_deptid = hpo_deptid)            AS roomname, ") \
			_T("               (SELECT hbl_name ") \
			_T("                FROM   hms_bedlist ") \
			_T("                WHERE  hbl_id = hpo_bedid ") \
			_T("                       AND hbl_roomid = hpo_roomid ") \
			_T("                       AND hbl_deptid = hpo_deptid)            AS bedname, ") \
			_T("               ho_desc                                         AS objectname, ") \
			_T("               hd_cardno                                       AS cardno, ") \
			_T("               hpo_storage_id, ") \
			_T("               product_id, ") \
			_T("               product_name                                    AS product_name, ") \
			_T("               product_uomname                                 AS product_unit, ") \
			_T("               hmt_qtyissue                                    AS product_qtyorder, ") \
			_T("               hmt_qtyissue                                    AS product_qtyissue, ") \
			_T("			   (SELECT hst_name FROM hms_surgery_table WHERE hst_idx = ho_opera_table) as table_name") \
			_T("        FROM   hms_patient ") \
			_T("               LEFT JOIN hms_doc ") \
			_T("                      ON( hd_patientno = hp_patientno ) ") \
			_T("			   LEFT JOIN hms_clinical_record ON (hcr_docno = hd_docno)") \
			_T("               LEFT JOIN hms_medical_transaction_view ") \
			_T("                      ON( hmt_docno = hd_docno ) ") \
			_T("               LEFT JOIN m_product_view ") \
			_T("                      ON( product_id = hmt_suppproduct_id ) ") \
			_T("               LEFT JOIN hms_object ") \
			_T("                      ON( ho_id = hd_object ) ") \
			_T("               LEFT JOIN hms_card ") \
			_T("                      ON( hc_patientno = hd_patientno ") \
			_T("                          AND hc_idx = hd_cardidx ) ") \
			_T("               LEFT JOIN HMS_PHARMAORDER_VIEW_B5 ") \
			_T("                      ON ( hpo_docno = hmt_docno AND hpo_orderid = hmt_orderid ) ") \
			_T(" %s JOIN hms_operation ON ( hmt_docno = hpo_docno AND hpo_reference_id = ho_idx )") \
			_T("        WHERE  hmt_reftransaction_id = %s ") \
			_T("              and (hmt_suppproduct_id = %ld or hmt_product_id=%ld) ) tbl ") \
			_T("GROUP  BY orderdate, ") \
			_T("          roomname, ") \
			_T("          bedname, ") \
			_T("          pname, ") \
			_T("          docno, ") \
			_T("		  recordno,") \
			_T("		  deptid,") \
			_T("          cardno, ") \
			_T("          objectname, ") \
			_T("          address, ") \
			_T("          yearofbirth, ") \
			_T("          hpo_storage_id, ") \
			_T("          product_name, ") \
			_T("          product_unit,table_name ") \
			_T("ORDER  BY docno, ") \
			_T("          roomname, ") \
			_T("          bedname, ") \
			_T("          pname, ") \
			_T("          orderdate, ") \
			_T("          hpo_storage_id, ") \
			_T("          product_name, ") \
			_T("          product_unit "),
			pMF->GetModuleID() == _T("SMM") ? _T("INNER") : _T("LEFT"), lpszTransactionString, nProduct_id, nProduct_id);
	}
	else
	{
		szSQL.Format(_T("SELECT DISTINCT orderdate, ") \
			_T("                roomname, ") \
			_T("                bedname, ") \
			_T("                pname, ") \
			_T("                docno, ") \
			_T("				get_departmentname(deptid) deptname,") \
			_T("                cardno, ") \
			_T("                objectname, ") \
			_T("                address, ") \
			_T("                yearofbirth, ") \
			_T("                hpo_storage_id, ") \
			_T("                product_name, ") \
			_T("                product_unit, ") \
			_T("                Sum(product_qtyorder) AS QtyOrder, ") \
			_T("                Sum(product_qtyissue) AS QtyIssue ") \
			_T("FROM   (SELECT hmt_docno                                       AS docno, ") \
			_T("               (select htr_deptid from hms_treatment_record where htr_docno = hmt_docno and htr_status = 'I') AS deptid, ") \
			_T("               hmt_medical_transaction_id                      AS orderid, ") \
			_T("               trunc(hpo_orderdate)                            AS orderdate, ") \
			_T("               Trim(hp_surname ") \
			_T("                    || ' ' ") \
			_T("                    || hp_midname ") \
			_T("                    || ' ' ") \
			_T("                    || hp_firstname)                           AS pname, ") \
			_T("               Hms_getage(trunc(hd_admitdate), hp_birthdate)   AS age, ") \
			_T("               Extract(YEAR FROM hp_birthdate)                 AS yearofbirth, ") \
			_T("               hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS address, ") \
			_T("               (SELECT hrl_name ") \
			_T("                FROM   hms_roomlist ") \
			_T("                WHERE  hrl_id = hpo_roomid ") \
			_T("                       AND hrl_deptid = hpo_deptid)            AS roomname, ") \
			_T("               (SELECT hbl_name ") \
			_T("                FROM   hms_bedlist ") \
			_T("                WHERE  hbl_id = hpo_bedid ") \
			_T("                       AND hbl_roomid = hpo_roomid ") \
			_T("                       AND hbl_deptid = hpo_deptid)            AS bedname, ") \
			_T("               ho_desc                                         AS objectname, ") \
			_T("               hd_cardno                                       AS cardno, ") \
			_T("               hpo_storage_id, ") \
			_T("               product_id, ") \
			_T("               product_name                                    AS product_name, ") \
			_T("               product_uomname                                 AS product_unit, ") \
			_T("               hmt_qtyissue                                    AS product_qtyorder, ") \
			_T("               hmt_qtyissue                                    AS product_qtyissue ") \
			_T("        FROM   hms_patient ") \
			_T("               LEFT JOIN hms_doc ") \
			_T("                      ON( hd_patientno = hp_patientno ) ") \
			_T("               LEFT JOIN hms_medical_transaction_view ") \
			_T("                      ON( hmt_docno = hd_docno ) ") \
			_T("               LEFT JOIN m_product_view ") \
			_T("                      ON( product_id = hmt_suppproduct_id ) ") \
			_T("               LEFT JOIN hms_object ") \
			_T("                      ON( ho_id = hd_object ) ") \
			_T("               LEFT JOIN hms_card ") \
			_T("                      ON( hc_patientno = hd_patientno ") \
			_T("                          AND hc_idx = hd_cardidx ) ") \
			_T("               LEFT JOIN hms_pharmaorder ") \
			_T("                      ON ( hpo_orderid = hmt_orderid ) ") \
			_T("        WHERE  hmt_reftransaction_id = %s") \
			_T("               and  (hmt_suppproduct_id = %ld or hmt_product_id=%ld) ) tbl ") \
			_T("GROUP  BY orderdate, ") \
			_T("		  deptid,") \
			_T("          roomname, ") \
			_T("          bedname, ") \
			_T("          pname, ") \
			_T("          docno, ") \
			_T("          cardno, ") \
			_T("          objectname, ") \
			_T("          address, ") \
			_T("          yearofbirth, ") \
			_T("          hpo_storage_id, ") \
			_T("          product_name, ") \
			_T("          product_unit ") \
			_T("ORDER  BY docno, ") \
			_T("          roomname, ") \
			_T("          bedname, ") \
			_T("          pname, ") \
			_T("          orderdate, ") \
			_T("          hpo_storage_id, ") \
			_T("          product_name, ") \
			_T("          product_unit "),
			lpszTransactionString, nProduct_id, nProduct_id);
	}
	_fmsg(_T("%s"), szSQL);
	rsl.ExecSQL(szSQL);
	int nIdx = 0;
	while (!rsl.IsEOF())
	{
		nIdx++;
		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nIdx);
		rptDetail->SetValue(_T("0"), tmpStr);
		rsl.GetValue(_T("OrderDate"), tmpStr);
		rptDetail->SetValue(_T("1"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rsl.GetValue(_T("pname"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rsl.GetValue(_T("yearofbirth"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rsl.GetValue(_T("roomname"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rsl.GetValue(_T("bedname"), tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		rsl.GetValue(_T("QtyOrder"), tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rsl.GetValue(_T("CardNo"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rsl.GetValue(_T("ObjectName"), tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		rsl.GetValue(_T("Address"), tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);
		rptDetail->SetValue(_T("10"), rsl.GetValue(_T("docno")));
		rptDetail->SetValue(_T("11"), rsl.GetValue(_T("recordno")));
		rptDetail->SetValue(_T("12"), rsl.GetValue(_T("deptname")));
		rptDetail->SetValue(_T("13"), rsl.GetValue(_T("table_name")));
		rsl.MoveNext();
	}

	CString szDate, szSysDate;
	szSysDate = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Mid(11, 5), szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.PrintPreview();
}



void CPrintForms::OnPrintProcessedPrescription(LPCTSTR lpszFilter) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CReport rpt;
	CReportSection* rptDetail;
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr;
	int nIdx = 1;
	if (!rpt.Init(_T("Reports\\HMS\\PMS_DANHSACHDUYETDONTHUOC.RPT")))
		return;
	szSQL.Format(_T(" SELECT") \
		_T("   hpo_processeddate              AS approveddate,") \
		_T("   hpo_orderid                    AS orderid,") \
		_T("   hpo_docno                      AS docno,") \
		_T("   Get_patientname(hpo_docno)     AS patname,") \
		_T("   Get_departmentname(hpo_deptid) AS dept,") \
		_T("   hpo_amount                     AS amount") \
		_T(" FROM   hms_ipharmaorder "));
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy), CDate::Convert(m_szToDate, yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), tmpStr);
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx++));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("approveddate")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("orderid")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("docno")));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("patname")));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("dept")));
		rptDetail->SetValue(_T("7"), rs.GetValue(_T("amount")));
		rs.MoveNext();
	}
	rpt.PrintPreview();
}

void CPrintForms::TM_PrintDrugReturnPatientList(long nOrderID)
{
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CString szSQL, szWhere, tmpStr, szOldDoc, szNewDoc, szDate;
	CReportSection* rptHeader, * rptDetail;
	int nIdx = 1;
	double nTtlAmt = 0, nGrpAmt = 0, nAmt = 0;
	if (!rpt.Init(_T("Reports\\HMS\\PMS_DANHSACHTHUOCTRALAI.RPT")))
		return;
	szSQL.Format(_T("SELECT get_storagename(mt_storage_to_id) as stockname, ") \
		_T("       get_departmentname(mt_department_id) as deptname, ") \
		_T("       mt_approveddate as approveddate, mt_orderno as orderno ") \
		_T("FROM   m_transaction ") \
		_T("WHERE  mt_transaction_id = %ld AND mt_status <> 'O' AND mt_doctype IN ('CRO', 'DRO')"), nOrderID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data."), MB_OK);
		return;
	}
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("PrintDate"), CDate::Convert(rs.GetValue(_T("approveddate")), yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("StockName"), rs.GetValue(_T("stockname")));
	rptHeader->SetValue(_T("Department"), rs.GetValue(_T("deptname")));
    rptHeader->SetValue(_T("OrderNo"), rs.GetValue(_T("orderno")));
	szSQL.Format(_T("SELECT hpolr_docno                  AS docno, ") \
		_T("       Get_patientname(hpolr_docno) AS patname, ") \
		_T("       product_name                AS pname, ") \
		_T("       product_uomname             AS uom, ") \
		_T("       hpolr_unitprice              AS price, ") \
		_T("       Sum(hpolr_qtyreverse)        AS qty, ") \
		_T("	   SUM(hpolr_qtyreverse)*hpolr_unitprice AS amt ") \
		_T("FROM   hms_ipharmaorderline_r ") \
		_T("LEFT JOIN m_product_view ON ( hpolr_product_id = product_id ) ") \
		_T("WHERE  hpolr_retorder_id = %ld ") \
		_T("GROUP  BY hpolr_docno, ") \
		_T("          product_name, ") \
		_T("          product_uomname, ") \
		_T("          hpolr_unitprice ") \
		_T("ORDER  BY docno, ") \
		_T("          pname "), nOrderID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		szSQL.Format(_T("SELECT hpolr_docno                  AS docno, ") \
			_T("       Get_patientname(hpolr_docno) AS patname, ") \
			_T("       product_name                AS pname, ") \
			_T("       product_uomname             AS uom, ") \
			_T("       hpolr_unitprice              AS price, ") \
			_T("       Sum(hpolr_qtyreverse)        AS qty, ") \
			_T("	   SUM(hpolr_qtyreverse)*hpolr_unitprice AS amt ") \
			_T("FROM   hms_pharmaorderline_r ") \
			_T("LEFT JOIN m_product_view ON ( hpolr_product_id = product_id ) ") \
			_T("WHERE  hpolr_retorder_id = %ld ") \
			_T("GROUP  BY hpolr_docno, ") \
			_T("          product_name, ") \
			_T("          product_uomname, ") \
			_T("          hpolr_unitprice ") \
			_T("ORDER  BY docno, ") \
			_T("          pname "), nOrderID);
		rs.ExecSQL(szSQL);
	}
	while (!rs.IsEOF())
	{
		rs.GetValue(_T("docno"), szNewDoc);
		if (szNewDoc != szOldDoc)
		{
			if (nGrpAmt > 0)
			{
				rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
				rptDetail->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m"));
				nTtlAmt += nGrpAmt;
				rptDetail->SetValue(_T("s6"), double2str(nGrpAmt));
				nGrpAmt = 0;
			}
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
			tmpStr.Format(_T("[%s] %s"), rs.GetValue(_T("docno")), rs.GetValue(_T("patname")));
			rptDetail->SetValue(_T("PName"), tmpStr);
			szOldDoc = szNewDoc;
			nIdx = 1;
		}
		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nIdx++);
		rptDetail->SetValue(_T("1"), tmpStr);
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("pname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("uom")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("price")));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("qty")));
		rs.GetValue(_T("amt"), nAmt);
		nGrpAmt += nAmt;
		rptDetail->SetValue(_T("6"), double2str(nAmt));
		rs.MoveNext();
	}
	if (nGrpAmt > 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
		rptDetail->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m"));
		nTtlAmt += nGrpAmt;
		rptDetail->SetValue(_T("s6"), double2str(nGrpAmt));
	}
	if (nTtlAmt > 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
		rptDetail->SetValue(_T("TotalGroup"), _T("T\x1ED5ng \x63\x1ED9ng"));
		rptDetail->SetValue(_T("s6"), double2str(nTtlAmt));
	}
	szDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Mid(8, 2), szDate.Mid(5, 2), szDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::FM_PrintGeneralApprovedInOrder(long nTransactionID, bool bPreview) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CReport rpt;

	CString szSQL, szWhere;
	CString tmpStr, szDate, szSysDate, tmpStr2, szFacList;
	CString szObject, szGroups, szObjectName, szType, szTypeName, szTableName;
	CString szStocks, szStockNames;
	CRecord rs(&pMF->m_db);
	szType.Empty();
	szTypeName.Empty();

	int nCount = 0;

	//if (!rpt.Init(_T("Reports/HMS/PTTT/QUYETTOANSUDUNGTHUOC-VTYTBN.RPT")))
	if (!rpt.Init(_T("Reports/HMS/PTTT/HF_PHIEULINHDV.RPT")))
	{
		return;
	}
	szSQL.Format(_T("SELECT mt_approveddate appdate, ") \
		_T("       get_storagename(mt_storage_id) stockname, ") \
		_T("	   get_departmentname(mt_department_to_id) deptname,") \
		_T("	   mt_orderno orderno") \
		_T(" FROM   m_transaction ") \
		_T(" WHERE  mt_transaction_id = %ld"), nTransactionID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		return;
	}

	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("deptname")));
	rpt.GetReportHeader()->SetValue(_T("OrderNo"), rs.GetValue(_T("orderno")));
	//tmpStr.Format(_T("\x42\xE1o \x63\xE1o quy\x1EBFt to\xE1n s\x1EED \x64\x1EE5ng thu\x1ED1\x63"));
	//rpt.GetReportHeader()->SetValue(_T("ReportName"),tmpStr);
	szSysDate = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("ReportDate")),
		CDateTime::Convert(m_szFromDate, yyyymmdd | hhmm, ddmmyyyy | hhmm),
		CDateTime::Convert(m_szToDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));
	rpt.GetReportHeader()->SetValue(_T("ReportDate"), CDate::Convert(rs.GetValue(_T("appdate")), yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("StockName"), rs.GetValue(_T("stockname")));
	rpt.GetReportHeader()->SetValue(_T("Object"), szObjectName);
	rpt.GetReportHeader()->SetValue(_T("DrugType"), szTypeName);
	rpt.GetReportHeader()->SetValue(_T("TableName"), szTableName);


	szSQL.Format(_T("SELECT pname, ") \
		_T("       age, ") \
		_T("       docno, ") \
		_T("       Sum(drugamt)     drugamt, ") \
		_T("       Sum(materialamt) materialamt, ") \
		_T("       Sum(amount)      amount ") \
		_T("FROM   (SELECT Get_patientname(hpol_docno)    pname, ") \
		_T("               Hms_getagebydoc(hpol_docno)    age, ") \
		_T("               hpol_docno                     docno, ") \
		_T("               CASE ") \
		_T("                 WHEN product_org_id = 'PM' THEN hpol_qtyorder * hpol_unitprice ") \
		_T("                 ELSE 0 ") \
		_T("               END                            AS drugamt, ") \
		_T("               CASE ") \
		_T("                 WHEN product_org_id = 'MA' THEN hpol_qtyorder * hpol_unitprice ") \
		_T("                 ELSE 0 ") \
		_T("               END                            AS materialamt, ") \
		_T("               hpol_qtyorder * hpol_unitprice AS amount ") \
		_T("        FROM   hms_ipharmaorder ") \
		_T("               LEFT JOIN hms_ipharmaorderline ") \
		_T("                      ON ( hpo_orderid = hpol_orderid ) ") \
		_T("               LEFT JOIN m_product_view ") \
		_T("                      ON ( hpol_product_id = product_id ) ") \
		_T("        WHERE  hpo_transaction_id = %ld) tbl ") \
		_T("GROUP  BY pname, ") \
		_T("          age, ") \
		_T("          docno "), nTransactionID);


	//_msg(_T("%s"), szSQL);

	CReportSection* rptDetail;
	CString szOldLine, szNewLine, szAmount;

	double grpCost[8];
	double ttlCost[8];
	double cost = 0;
	int nItem = 1;

	_fmsg(_T("%s"), szSQL);

	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		_msg(_T("%s"), szSQL);
		ShowMessageBox(_T("No Data"), MB_OK);
		return;
	}

	for (int i = 0; i < 8; i++)
	{
		grpCost[i] = 0;
		ttlCost[i] = 0;
	}

	while (!rs.IsEOF())
	{

		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nItem++);
		rptDetail->SetValue(_T("1"), tmpStr);
		rs.GetValue(_T("id"), tmpStr);
		rs.GetValue(_T("pname"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rs.GetValue(_T("docno"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rs.GetValue(_T("age"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);

		rs.GetValue(_T("docno"), tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);

		rs.GetValue(_T("materialamt"), cost);
		grpCost[5] += cost;
		FormatCurrency(cost, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);

		rs.GetValue(_T("drugamt"), cost);
		grpCost[6] += cost;
		FormatCurrency(cost, tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);

		rs.GetValue(_T("amount"), cost);
		grpCost[7] += cost;
		FormatCurrency(cost, tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);

		rs.MoveNext();
	}


	if (grpCost[7] > 0)
	{
		TranslateString(_T("Total Group"), szAmount);
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(0));
		rptDetail->SetValue(_T("TotalGroup"), szAmount);
		for (int i = 5; i < 8; i++)
		{
			FormatCurrency(grpCost[i], tmpStr);
			tmpStr2.Format(_T("s%d"), i + 1);
			rptDetail->SetValue(tmpStr2, tmpStr);
			ttlCost[i] += grpCost[i];
			grpCost[i] = 0;
		}
	}
	if (ttlCost[7] > 0)
	{
		TranslateString(_T("Total Amount"), szAmount);
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(0));
		rptDetail->SetValue(_T("TotalAmount"), szAmount);
		for (int i = 5; i < 8; i++)
		{
			FormatCurrency(ttlCost[i], tmpStr);
			tmpStr2.Format(_T("s%d"), i + 1);
			rptDetail->SetValue(tmpStr2, tmpStr);
		}
	}
	CString szTime;
	szTime = pMF->GetSysDateTime();
	szSysDate = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")),
		szTime.Right(8), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	/*if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(true);*/
	rpt.PrintPreview();
}

void CPrintForms::FM_PrintDetailedApprovedInOrder(long nDocno, long nTransactionID, bool bPreview) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CRecord rss(&pMF->m_db);

	static CReport rpt;

	CString szSQL;
	CString tmpStr, tmpStr1, szType;

	if (!rpt.Init(_T("Reports/HMS/PTTT/HF_PHIEULINHDV_CT.RPT")))
	{
		//ShowMessageBox(_T("Can not open file report."), MB_OK);
		return;
	}
	szSQL.Format(_T("SELECT hcr_docno                                       docno, ") \
		_T("       hcr_recordno                                    recordno, ") \
		_T("       Get_departmentname(hcr_admitdept)               deptname, ") \
		_T("       Get_patientname(hcr_docno)                      patname, ") \
		_T("       Hms_getagebydoc(hcr_docno)                      age, ") \
		_T("       Get_syssel_desc('sys_sex', hp_sex) sex, ") \
		_T("	   hd_diagnostic diagno,") \
		_T("       hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) addr ") \
		_T("FROM   hms_clinical_record ") \
		_T("       LEFT JOIN hms_patient ") \
		_T("              ON ( hcr_patientno = hp_patientno ) ") \
		_T("	   LEFT JOIN hms_doc ") \
		_T("			  ON (hcr_docno = hd_docno)") \
		_T("WHERE  hcr_docno = %ld"), nDocno);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	rpt.GetReportHeader()->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("deptname")));

	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), rs.GetValue(_T("docno")));

	rpt.GetReportHeader()->SetValue(_T("RecordNo"), rs.GetValue(_T("recordno")));

	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), rs.GetValue(_T("patname")));

	rpt.GetReportHeader()->SetValue(_T("Age"), rs.GetValue(_T("age")));

	rpt.GetReportHeader()->SetValue(_T("Sex"), rs.GetValue(_T("sex")));

	rpt.GetReportHeader()->SetValue(_T("Address"), rs.GetValue(_T("addr")));

	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs.GetValue(_T("diagno")));
	szSQL.Format(_T("SELECT mt_orderno orderno FROM m_transaction WHERE mt_transaction_id = %ld"), nTransactionID);
	rs.ExecSQL(szSQL);
	rpt.GetReportHeader()->SetValue(_T("OrderNo"), rs.GetValue(_T("orderno")));
	//Page Header
	//Report Detail
	szSQL.Format(_T("SELECT product_name                        pname, ") \
		_T("       product_uomname                     uom, ") \
		_T("       Sum(hpol_qtyorder)                  qty, ") \
		_T("       hpol_unitprice                      price, ") \
		_T("       Sum(hpol_unitprice * hpol_qtyorder) amount ") \
		_T("FROM   hms_ipharmaorder ") \
		_T("       LEFT JOIN hms_ipharmaorderline ") \
		_T("              ON ( hpo_orderid = hpol_orderid ) ") \
		_T("       LEFT JOIN m_product_view ") \
		_T("              ON ( product_id = hpol_product_id ) ") \
		_T("WHERE  hpo_transaction_id = %ld ") \
		_T("       AND hpol_docno = %ld ") \
		_T("GROUP  BY product_name, ") \
		_T("          product_uomname, ") \
		_T("          hpol_unitprice "), nTransactionID, nDocno);
	rs.ExecSQL(szSQL);
	CReportSection* rptDetail = NULL;

	int m_nIdx = 0;
	double Cost = 0;
	double ttCost = 0, grpCost = 0;
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		m_nIdx++;
		tmpStr.Format(_T("%d"), m_nIdx);
		rptDetail->SetValue(_T("1"), tmpStr);
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("pname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("uom")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("price")));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("qty")));
		rs.GetValue(_T("amount"), tmpStr);
		Cost += str2double(tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rs.MoveNext();
	}
	rptDetail = rpt.AddDetail(rpt.GetGroupFooter(0));
	rptDetail->SetValue(_T("s6"), double2str(Cost));
	//Page Footer
	//Report Footer
	CDate sysDate;
	sysDate.ParseDate(pMF->GetSysDate());
	rpt.GetReportFooter()->Format(_T("PrintDate"), sysDate.GetDay(), sysDate.GetMonth(), sysDate.GetYear());
	/*if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(true);*/
	rpt.PrintPreview();
}

void CPrintForms::FM_PrintDetailedApprovedInOrderbyDrug(long nTransactionID) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szDate, szSysDate, szSQL, tmpStr2, m_szFacList, szWhere;
	CString  szObject, m_szGroups, szObjectName, szType, szTypeName, szTableName;
	CString szStocks, szStockNames;
	int nCount = 0;

	if (!rpt.Init(_T("Reports/HMS/PTTT/PMS_BAOCAOXUATTHUOCCHOKHOATHEODOITUONG.RPT")))
	{
		//CString MsgReport;
		//MsgReport.Format(_T("Mau bao cao [%s] chua co. Lien he voi Adminstrator"),  _T("PMS_BAOCAOXUATTHUOCCHOKHOATHEODOITUONG.RPT"));
		//AfxMessageBox(MsgReport);
		return;
	}

	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	szSysDate = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("ReportDate")), CDateTime::Convert(m_szFromDate, yyyymmdd | hhmm, ddmmyyyy | hhmm),
		CDateTime::Convert(m_szToDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));
	rpt.GetReportHeader()->SetValue(_T("ReportDate"), szDate);
	rpt.GetReportHeader()->SetValue(_T("StockName"), szStockNames);
	rpt.GetReportHeader()->SetValue(_T("TableName"), szTableName);
	rpt.GetReportHeader()->SetValue(_T("DrugType"), szTypeName);
	rpt.GetReportHeader()->SetValue(_T("Object"), szObjectName);

	szSQL.Format(_T("SELECT product_id                          id, ") \
		_T("       product_name                        name, ") \
		_T("       product_uomname                     unit, ") \
		_T("       hpol_unitprice                      price, ") \
		_T("       Sum(hpol_qtyissue)                  AS qty, ") \
		_T("       Sum(hpol_unitprice * hpol_qtyissue) AS amount ") \
		_T("FROM   hms_ipharmaorder ") \
		_T("       LEFT JOIN hms_ipharmaorderline ") \
		_T("              ON ( hpo_orderid = hpol_orderid ) ") \
		_T("       LEFT JOIN m_product_view ") \
		_T("              ON ( product_id = hpol_product_id ) ") \
		_T("WHERE  hpo_transaction_id = %ld ") \
		_T("GROUP  BY product_id, ") \
		_T("          product_name, ") \
		_T("          product_uomname, ") \
		_T("          hpol_unitprice ") \
		_T("ORDER  BY product_name "), nTransactionID);


	CReportSection* rptDetail;
	CString szOldLine, szNewLine, szAmount;
	CRecord rs(&pMF->m_db);
	double grpCost = 0.0;
	double ttlCost = 0.0;
	double cost = 0;
	int nItem = 1;
	_fmsg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		ShowMessageBox(_T("No Data"), MB_OK);
		return;
	}


	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nItem++);
		rptDetail->SetValue(_T("1"), tmpStr);
		rs.GetValue(_T("id"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rs.GetValue(_T("name"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rs.GetValue(_T("unit"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rs.GetValue(_T("price"), cost);
		FormatCurrency(cost, tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);

		rs.GetValue(_T("qty"), tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rs.GetValue(_T("amount"), cost);
		grpCost += cost;
		FormatCurrency(cost, tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);

		rs.MoveNext();
	}

	ttlCost += grpCost;

	if (grpCost > 0)
	{
		TranslateString(_T("Total Group"), szAmount);
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
		rptDetail->SetValue(_T("TotalGroup"), szAmount);
		FormatCurrency(grpCost, tmpStr);
		rptDetail->SetValue(_T("s7"), tmpStr);
	}
	if (ttlCost > 0)
	{
		TranslateString(_T("Total Amount"), szAmount);
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
		rptDetail->SetValue(_T("TotalGroup"), szAmount);
		FormatCurrency(ttlCost, tmpStr);
		rptDetail->SetValue(_T("s7"), tmpStr);
		ttlCost += grpCost;
	}

	CString szTime;
	szTime = pMF->GetSysDateTime();
	szSysDate = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szTime.Right(8), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	//	rpt.GetReportFooter()->SetValue(_T("username"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::TM_PrintInSurgeryPayment(long nSOrderID, long nDocumentNo, CString szDeptID) 
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	CRecord rss(&pMF->m_db);
	CRecord rsb5(&pMF->m_db);
    CString szSQLb5, szPdeptid;

	//Kiểm tra nếu khoa thực hiện là B5 thì in ra mẫu giống với khoa B5

	szSQLb5.Format(_T("SELECT ho_idx, ho_docno, HO_PDEPTID as pdeptid ") \
		_T(" FROM hms_operation ") \
		_T(" LEFT JOIN hms_fee_list ON(hfl_feeid = ho_itemid)") \
		_T(" WHERE ho_idx = %ld AND ho_status in('A','T','S')") \
		_T(" ORDER BY ho_idx"), nSOrderID);

	rsb5.ExecSQL(szSQLb5);  

	if (rsb5.IsEOF()) 
	{
		_tprintf(_T("\r\nNo Operation"));
		return;
	}

	rsb5.GetValue(_T("pdeptid"), szPdeptid);	

	if (szPdeptid == _T("B5"))
    {
        PrintSurgeryPayment(nSOrderID, nDocumentNo, szDeptID);
        return;
    }

	static CReport rpt;
	CReportSection* grp;
	CString tmpStr, tmpStrIdx, szSQL, szGroups, szReportName, szObjectKey;

	CString lpszChapter[] = { _T("I"), _T("II"), _T("III"), _T("IV"), _T("V"),
							_T("VI"), _T("VII"), _T("VIII"), _T("IX"), _T("X"), _T("XI") };
	int nChapter = 0;

	szSQL.Format(_T(" SELECT    hd_patientno                    AS patientno, ") \
		_T("           hcr_recordno                    AS recordno, ") \
		_T("           Trim(hp_surname ") \
		_T("                ||' ' ") \
		_T("                ||hp_midname ") \
		_T("                ||' ' ") \
		_T("                ||hp_firstname)            AS pname, ") \
		_T("           Extract(YEAR FROM hp_birthdate) AS birthdate, ") \
		_T("           hp_birthdate                    AS birthdate1, ") \
		_T("           get_syssel_desc('sys_sex', hp_sex)                          AS sex, ") \
		_T("           sp_name                         AS provname, ") \
		_T("           sys_dist.sd_name                AS distname, ") \
		_T("           sv_name                         AS villname, ") \
		_T("           hp_dtladdr                      AS address, ") \
		_T("           hp_workplace                    AS workplace, ") \
		_T("           hp_rank                         AS rank, ") \
		_T("           hd_object                       AS obj, ") \
		_T("		   get_objectname(hd_object)	   AS objname,") \
		_T("           hd_doctor                       AS doctor, ") \
		_T("           hd_indept                       AS deptid, ") \
		_T("		   get_departmentname(hd_indept)   AS deptname,") \
		_T("           hc_cardno                       AS cardno, ") \
		_T("           hd_disrate                      AS insrate, ") \
		_T("           hd_isinpatient                  AS inpatient, ") \
		_T("           hcr_admitdate                   AS admitdate, ") \
		_T("           hd_diagnostic                   AS diagnostic ") \
		_T(" FROM      hms_patient ") \
		_T(" LEFT JOIN hms_doc ON( hd_patientno = hp_patientno ) ") \
		_T(" LEFT JOIN hms_clinical_record ON( hcr_docno = hd_docno ) ") \
		_T(" LEFT JOIN hms_card ON( hc_patientno = hp_patientno ") \
		_T("                        AND hc_idx = hd_cardidx ") \
		_T("                        AND hc_cardno = hd_cardno ) ") \
		_T(" LEFT JOIN sys_dept ON( sys_dept.sd_id = hd_indept ) ") \
		_T(" LEFT JOIN sys_prov ON( sp_id = hp_provid ) ") \
		_T(" LEFT JOIN sys_dist ON( sd_provid = hp_provid ") \
		_T("                        AND sys_dist.sd_id = hp_distid ) ") \
		_T(" LEFT JOIN sys_vill ON( sv_id = hp_villid ") \
		_T("                        AND sv_distid = hp_distid ") \
		_T("                        AND sv_id = hp_villid ) ") \
		_T(" WHERE     hd_docno = %ld "), nDocumentNo);
	_fmsg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF()) {
		_tprintf(_T("\r\nNo Patient!"));
		return;
	}
	rs.GetValue(_T("obj"), szObjectKey);
	if (szObjectKey == _T("1") || szObjectKey == _T("7") || szObjectKey == _T("8")
		/*|| m_bExpireFlag*/)
	{
		szReportName = _T("Reports/HMS/PTTT/HF_BANGKEPTTT_QUAN_DICHVU.RPT");
	}
	else
	{
		szReportName = _T("Reports/HMS/PTTT/HF_INSDISCHARGEPAYMENT.RPT");
	}


	if (!rpt.Init(szReportName))
	{
		//ShowMessageBox(_T("Can not open file report."), MB_OK);
		return;
	}
	CString szDate;
	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")),
		tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);

	rpt.GetReportHeader()->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), pMF->m_szHospitalName);


	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);

	//tmpStr.Format(_T("%ld"), m_nRecordNo);
	tmpStr.Format(_T("%s"), rs.GetValue(_T("recordno")));

	rpt.GetReportHeader()->SetValue(_T("RecordNo"), tmpStr);
	StringUpper(rs.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), rs.GetValue(_T("birthdate")));
	rpt.GetReportHeader()->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
	tmpStr.Empty();
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("villname")));
	if (!tmpStr.IsEmpty())
		tmpStr += _T(" - ");
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("distname")));
	if (!tmpStr.IsEmpty())
		tmpStr += _T(" - ");
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("provname")));

	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Object"), rs.GetValue(_T("objname")));

	rpt.GetReportHeader()->SetValue(_T("CardNo"), rs.GetValue(_T("cardno")));

	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("deptname")));
	//Page Header
	//Report Detail

	int nIdx = 1, nIdxl = 1, nNhom = 0;
	int nNewIndex = 0, nOldIndex = 0;
	long nOrderID;
	double cost = 0;
	CReportSection* rptDetail = NULL;
	double optcost = 0, inscost = 0, patpaid = 0;
	double grpoptcost = 0, grpinscost = 0, grppatpaid = 0, grpcost = 0;
	double grp2optcost = 0, grp2inscost = 0, grp2patpaid = 0, grp2cost = 0;
	double ttloptcost = 0, ttlinscost = 0, ttlpatpaid = 0, ttlcost = 0, ttSurgeryCost = 0;
	double unitprice = 0, qty = 0;
	long nDocNo;
	CString szOldLine, szNewLine, szOldGroup, szNewGroup, szLineName, szLineNameOld;
	CString szComment, szTotalComment;

	szGroups.Empty();
	CString szTmp;

	szSQL.Format(_T("SELECT ho_idx, ho_docno, hfl_name, ho_comment, hfl_unit, hfl_servprice, ") \
		_T(" ho_diagnostic diagnostic, (select hst_name from hms_surgery_table where hst_idx = ho_opera_table) table_name") \
		_T(" FROM hms_operation ") \
		_T(" LEFT JOIN hms_fee_list ON(hfl_feeid = ho_itemid)") \
		_T(" WHERE ho_idx = %ld AND ho_status in('A','T','S')") \
		_T(" ORDER BY ho_idx"), nSOrderID);


	rs.ExecSQL(szSQL);
	if (rs.IsEOF()) {
		_tprintf(_T("\r\nNo Operation"));
		return;
	}

	rpt.GetReportHeader()->SetValue(_T("room"), rs.GetValue(_T("table_name")));
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs.GetValue(_T("diagnostic")));
	szComment.Empty();
	szGroups.Empty();

	grp = rpt.GetGroupHeader(1);
	rptDetail = rpt.AddDetail(grp);
	tmpStr.Format(_T("%s%s"), lpszChapter[nChapter], _T("."));
	rptDetail->SetValue(_T("SubGroupID"), tmpStr);
	rs.GetValue(_T("ho_comment"), szComment);

	tmpStr = rs.GetValue(_T("hfl_name"));
	rptDetail->SetValue(_T("SubGroupName"), tmpStr);
	rs.GetValue(_T("hfl_servprice"), cost);
	ttSurgeryCost += cost;
	FormatCurrency(cost, tmpStr);

	rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

	if (!szComment.IsEmpty())
	{
		rptDetail = rpt.AddDetail(grp);
		tmpStr.Format(_T("* %s"), szComment);
		rptDetail->SetValue(_T("SubGroupName"), tmpStr);
	}

	rs.GetValue(_T("ho_idx"), nOrderID);
	rs.GetValue(_T("ho_docno"), nDocNo);

	szSQL.Format(_T(" SELECT hsd_feeidx AS grpidx,") \
		_T("   hsd_name        AS grpname,") \
		_T("   hfe_desc,") \
		_T("   hfe_unit,") \
		_T("   hfe_unitprice as hfe_unitprice,") \
		_T("   hfe_category,") \
		_T("   SUM(hfe_quantity) AS qty,") \
		_T("   CASE") \
		_T("     WHEN hfe_category='Y'") \
		_T("     THEN SUM(hfe_cost)") \
		_T("     ELSE 0") \
		_T("   END AS optcost,") \
		_T("   CASE") \
		_T("     WHEN hfe_category='N'") \
		_T("     THEN SUM(hfe_inspaid)") \
		_T("     ELSE 0") \
		_T("   END                              AS inscost,") \
		_T("   SUM(hfe_diffcost)                AS diffcost,") \
		_T("   SUM(hfe_quantity*hfe_unitprice) AS cost") \
		_T(" FROM hms_fee") \
		_T(" LEFT JOIN hms_surgery_drugtype") \
		_T(" ON(hsd_id =hfe_group)") \
		_T(" LEFT JOIN HMS_PHARMAORDER_VIEW") \
		_T(" ON(hfe_docno    = hpo_docno") \
		_T(" AND hfe_orderid = hpo_orderid)") \
		_T(" LEFT JOIN HMS_PHARMAORDERLINE_VIEW") \
		_T(" ON(hpol_orderid      = hpo_orderid") \
		_T(" AND hpol_orderlineid = hfe_orderline)") \
		_T(" WHERE hfe_docno      =%ld") \
		_T(" AND hpo_reference_id =%ld") \
		_T(" AND hfe_type        IN('D','P','M') AND hfe_status <> 'C'") \
		_T(" GROUP BY hsd_feeidx,") \
		_T("   hsd_name,") \
		_T("   hfe_desc,") \
		_T("   hfe_unit,") \
		_T("   hfe_unitprice,") \
		_T("   hfe_category,") \
		_T("   hpol_unitprice") \
		_T(" ORDER BY hsd_feeidx,") \
		_T("   hfe_desc"), nDocumentNo, nOrderID);
	int nNewFeeIdx = 0, nOldFeeIdx = 0;

	rsl.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rsl.IsEOF()) {
		_tprintf(_T("\r\nNo Drug"));
		return;
	}
	while (!rsl.IsEOF())
	{

		rsl.GetValue(_T("grpidx"), nNewFeeIdx);
		if (nNewFeeIdx != nOldFeeIdx)
		{
			if (grp2cost > 0)
			{
				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
				tmpStr.Format(_T("\x43\x1ED9ng(%d):"), nIdx);
				rptDetail->SetValue(_T("TotalAmountLabel"), tmpStr);
				FormatCurrency(grp2optcost, tmpStr);
				rptDetail->SetValue(_T("6"), tmpStr);
				FormatCurrency(grp2inscost, tmpStr);
				rptDetail->SetValue(_T("7"), tmpStr);
				FormatCurrency(grp2patpaid, tmpStr);
				rptDetail->SetValue(_T("8"), tmpStr);
				FormatCurrency(grp2cost, tmpStr);
				rptDetail->SetValue(_T("9"), tmpStr);
				grp2cost = grp2inscost = grp2optcost = grp2patpaid = 0;
			}

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(2));
			tmpStr.Format(_T("%d"), ++nIdx);
			rptDetail->SetValue(_T("TypeID"), tmpStr);
			if (nNewFeeIdx == 1)
				tmpStr.Format(_T("Thu\x1ED1\x63, h\xF3\x61 \x63h\x1EA5t, m\xE1u, \x64\x1ECB\x63h truy\x1EC1n"));
			else if (nNewFeeIdx == 2)
				tmpStr.Format(_T("V\x1EADt t\x1B0 y t\x1EBF ti\xEAu h\x61o"));
			else
			{
				rsl.GetValue(_T("grpname"), tmpStr);
			}
			rptDetail->SetValue(_T("TypeName"), tmpStr);

			nIdxl = 1;
			nOldFeeIdx = nNewFeeIdx;
		}
		rptDetail = rpt.AddDetail();

		tmpStrIdx.Format(_T("%d)   "), nIdxl++);
		rsl.GetValue(_T("hfe_desc"), tmpStr);
		rptDetail->SetValue(_T("1"), _T(""));
		rptDetail->SetValue(_T("2"), tmpStrIdx + tmpStr);

		rsl.GetValue(_T("hfe_unit"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);

		rsl.GetValue(_T("qty"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);

		rsl.GetValue(_T("hfe_unitprice"), unitprice);
		FormatCurrency(unitprice, tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);

		rsl.GetValue(_T("optcost"), optcost);
		grp2optcost += optcost;
		grpoptcost += optcost;
		ttloptcost += optcost;
		FormatCurrency(optcost, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);

		rsl.GetValue(_T("inscost"), inscost);
		grp2inscost += inscost;
		grpinscost += inscost;
		ttlinscost += inscost;
		FormatCurrency(inscost, tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);

		rsl.GetValue(_T("patpaid"), patpaid);
		grp2patpaid += patpaid;
		grppatpaid += patpaid;
		ttlpatpaid += patpaid;
		FormatCurrency(patpaid, tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);


		rsl.GetValue(_T("cost"), cost);
		grp2cost += cost;
		grpcost += cost;
		ttlcost += cost;
		FormatCurrency(cost, tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);

		rsl.MoveNext();
	}


	if (grp2cost > 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
		tmpStr.Format(_T("\x43\x1ED9ng(%d):"), nIdx);
		rptDetail->SetValue(_T("TotalAmountLabel"), tmpStr);
		FormatCurrency(grp2optcost, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		FormatCurrency(grp2inscost, tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		FormatCurrency(grp2patpaid, tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		FormatCurrency(grp2cost, tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);
		grp2cost = grp2inscost = grp2optcost = grp2patpaid = 0;
	}

	rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
	for (int i = 0; i < nIdx; i++) {
		if (!szTotalComment.IsEmpty())
			szTotalComment.AppendFormat(_T("+"));
		szTotalComment.AppendFormat(_T("%d"), i + 1);
	}
	tmpStr.Format(_T("T\x1ED5ng (%s)=(%s):"), lpszChapter[nChapter], szTotalComment);
	szTotalComment.Empty();
	rptDetail->SetValue(_T("TotalAmountLabel"), tmpStr);

	FormatCurrency(grpoptcost, tmpStr);
	rptDetail->SetValue(_T("6"), tmpStr);
	FormatCurrency(grpinscost, tmpStr);
	rptDetail->SetValue(_T("7"), tmpStr);
	FormatCurrency(grppatpaid, tmpStr);
	rptDetail->SetValue(_T("8"), tmpStr);
	FormatCurrency(grpcost, tmpStr);
	rptDetail->SetValue(_T("9"), tmpStr);


	CString szSumInWord;
	szSumInWord.Format(_T("\x110\x1ED3ng"));
	FormatCurrency(ttlcost, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	FormatCurrency(ttlinscost, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("InsurancePaid"), tmpStr);
	FormatCurrency(ttlpatpaid, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("PatientPaid"), tmpStr);

	//Page Footer
	//Report Footer
	CDate sysDate;
	sysDate.ParseDate(pMF->GetSysDate());
	rpt.GetReportFooter()->Format(_T("PrintDate"), sysDate.GetDay(), sysDate.GetMonth(), sysDate.GetYear());
	//rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);
	rpt.PrintPreview();

}

void CPrintForms::EM_PrintSurgeryPayment(long nSOrderID, long nDocumentNo, CString szDeptID) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	CRecord rss(&pMF->m_db);

	static CReport rpt;
	CReportSection* grp;
	CString tmpStr, tmpStrIdx, szSQL, szGroups, szReportName, szObjectKey;

	CString lpszChapter[] = { _T("I"), _T("II"), _T("III"), _T("IV"), _T("V"),
							_T("VI"), _T("VII"), _T("VIII"), _T("IX"), _T("X"), _T("XI") };
	int nChapter = 0;

	szSQL.Format(_T(" SELECT    hd_patientno                    AS patientno, ") \
		_T("           hcr_recordno                    AS recordno, ") \
		_T("           Trim(hp_surname ") \
		_T("                ||' ' ") \
		_T("                ||hp_midname ") \
		_T("                ||' ' ") \
		_T("                ||hp_firstname)            AS pname, ") \
		_T("           Extract(YEAR FROM hp_birthdate) AS birthdate, ") \
		_T("           hp_birthdate                    AS birthdate1, ") \
		_T("           get_syssel_desc('sys_sex', hp_sex)                          AS sex, ") \
		_T("           sp_name                         AS provname, ") \
		_T("           sys_dist.sd_name                AS distname, ") \
		_T("           sv_name                         AS villname, ") \
		_T("           hp_dtladdr                      AS address, ") \
		_T("           hp_workplace                    AS workplace, ") \
		_T("           hp_rank                         AS rank, ") \
		_T("           hd_object                       AS obj, ") \
		_T("		   get_objectname(hd_object)	   AS objname,") \
		_T("           hd_doctor                       AS doctor, ") \
		_T("           hd_indept                       AS deptid, ") \
		_T("		   get_departmentname(hd_indept)   AS deptname,") \
		_T("           hc_cardno                       AS cardno, ") \
		_T("           hd_disrate                      AS insrate, ") \
		_T("           hd_isinpatient                  AS inpatient, ") \
		_T("           hcr_admitdate                   AS admitdate, ") \
		_T("           hd_diagnostic                   AS diagnostic ") \
		_T(" FROM      hms_patient ") \
		_T(" LEFT JOIN hms_doc ON( hd_patientno = hp_patientno ) ") \
		_T(" LEFT JOIN hms_clinical_record ON( hcr_docno = hd_docno ) ") \
		_T(" LEFT JOIN hms_card ON( hc_patientno = hp_patientno ") \
		_T("                        AND hc_idx = hd_cardidx ") \
		_T("                        AND hc_cardno = hd_cardno ) ") \
		_T(" LEFT JOIN sys_dept ON( sys_dept.sd_id = hd_indept ) ") \
		_T(" LEFT JOIN sys_prov ON( sp_id = hp_provid ) ") \
		_T(" LEFT JOIN sys_dist ON( sd_provid = hp_provid ") \
		_T("                        AND sys_dist.sd_id = hp_distid ) ") \
		_T(" LEFT JOIN sys_vill ON( sv_id = hp_villid ") \
		_T("                        AND sv_distid = hp_distid ") \
		_T("                        AND sv_id = hp_villid ) ") \
		_T(" WHERE     hd_docno = %ld "), nDocumentNo);
	_fmsg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF()) {
		_tprintf(_T("\r\nNo Patient!"));
		return;
	}
	rs.GetValue(_T("obj"), szObjectKey);
	if (szObjectKey == _T("1") || szObjectKey == _T("7") || szObjectKey == _T("8")
		/*|| m_bExpireFlag*/)
	{
		szReportName = _T("Reports/HMS/PTTT/HF_BANGKEPTTT_QUAN_DICHVU.RPT");
	}
	else
	{
		szReportName = _T("Reports/HMS/PTTT/HF_INSDISCHARGEPAYMENT.RPT");
	}


	if (!rpt.Init(szReportName))
	{
		//ShowMessageBox(_T("Can not open file report."), MB_OK);
		return;
	}
	CString szDate;
	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")),
		tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);

	rpt.GetReportHeader()->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), pMF->m_szHospitalName);


	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);

	//tmpStr.Format(_T("%ld"), m_nRecordNo);
	tmpStr.Format(_T("%s"), rs.GetValue(_T("recordno")));

	rpt.GetReportHeader()->SetValue(_T("RecordNo"), tmpStr);
	StringUpper(rs.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), rs.GetValue(_T("birthdate")));
	rpt.GetReportHeader()->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
	tmpStr.Empty();
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("villname")));
	if (!tmpStr.IsEmpty())
		tmpStr += _T(" - ");
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("distname")));
	if (!tmpStr.IsEmpty())
		tmpStr += _T(" - ");
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("provname")));

	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Object"), rs.GetValue(_T("objname")));

	rpt.GetReportHeader()->SetValue(_T("CardNo"), rs.GetValue(_T("cardno")));

	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("deptname")));
	//Page Header
	//Report Detail

	int nIdx = 1, nIdxl = 1, nNhom = 0;
	int nNewIndex = 0, nOldIndex = 0;
	long nOrderID;
	double cost = 0;
	CReportSection* rptDetail = NULL;
	double optcost = 0, inscost = 0, patpaid = 0;
	double grpoptcost = 0, grpinscost = 0, grppatpaid = 0, grpcost = 0;
	double grp2optcost = 0, grp2inscost = 0, grp2patpaid = 0, grp2cost = 0;
	double ttloptcost = 0, ttlinscost = 0, ttlpatpaid = 0, ttlcost = 0, ttSurgeryCost = 0;
	double unitprice = 0, qty = 0;
	long nDocNo;
	CString szOldLine, szNewLine, szOldGroup, szNewGroup, szLineName, szLineNameOld;
	CString szComment, szTotalComment;

	szGroups.Empty();
	CString szTmp;

	szSQL.Format(_T("SELECT ho_idx, ho_docno, hfl_name, ho_comment, hfl_unit, hfl_servprice, ") \
		_T(" ho_diagnostic diagnostic, (select hst_name from hms_surgery_table where hst_idx = ho_opera_table) table_name") \
		_T(" FROM hms_operation ") \
		_T(" LEFT JOIN hms_fee_list ON(hfl_feeid = ho_itemid)") \
		_T(" WHERE ho_idx = %ld AND ho_status in('A','T','S')") \
		_T(" ORDER BY ho_idx"), nSOrderID);


	rs.ExecSQL(szSQL);
	if (rs.IsEOF()) {
		_tprintf(_T("\r\nNo Operation"));
		return;
	}

	rpt.GetReportHeader()->SetValue(_T("room"), rs.GetValue(_T("table_name")));
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs.GetValue(_T("diagnostic")));
	szComment.Empty();
	szGroups.Empty();

	grp = rpt.GetGroupHeader(1);
	rptDetail = rpt.AddDetail(grp);
	tmpStr.Format(_T("%s%s"), lpszChapter[nChapter], _T("."));
	rptDetail->SetValue(_T("SubGroupID"), tmpStr);
	rs.GetValue(_T("ho_comment"), szComment);

	tmpStr = rs.GetValue(_T("hfl_name"));
	rptDetail->SetValue(_T("SubGroupName"), tmpStr);
	rs.GetValue(_T("hfl_servprice"), cost);
	ttSurgeryCost += cost;
	FormatCurrency(cost, tmpStr);

	rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

	if (!szComment.IsEmpty())
	{
		rptDetail = rpt.AddDetail(grp);
		tmpStr.Format(_T("* %s"), szComment);
		rptDetail->SetValue(_T("SubGroupName"), tmpStr);
	}

	rs.GetValue(_T("ho_idx"), nOrderID);
	rs.GetValue(_T("ho_docno"), nDocNo);

	szSQL.Format(_T(" SELECT hsd_feeidx AS grpidx,") \
		_T("   hsd_name        AS grpname,") \
		_T("   hfe_desc,") \
		_T("   hfe_unit,") \
		_T("   hpol_unitprice as hfe_unitprice,") \
		_T("   hfe_category,") \
		_T("   SUM(hfe_quantity) AS qty,") \
		_T("   CASE") \
		_T("     WHEN hfe_category='Y'") \
		_T("     THEN SUM(hfe_cost)") \
		_T("     ELSE 0") \
		_T("   END AS optcost,") \
		_T("   CASE") \
		_T("     WHEN hfe_category='N'") \
		_T("     THEN SUM(hfe_inspaid)") \
		_T("     ELSE 0") \
		_T("   END                              AS inscost,") \
		_T("   SUM(hfe_diffcost)                AS diffcost,") \
		_T("   SUM(hfe_quantity*hpol_unitprice) AS cost") \
		_T(" FROM hms_fee") \
		_T(" LEFT JOIN hms_surgery_drugtype") \
		_T(" ON(hsd_id =hfe_group)") \
		_T(" LEFT JOIN hms_pharmaorder") \
		_T(" ON(hfe_docno    = hpo_docno") \
		_T(" AND hfe_orderid = hpo_orderid)") \
		_T(" LEFT JOIN hms_pharmaorderline") \
		_T(" ON(hpol_orderid      = hpo_orderid") \
		_T(" AND hpol_orderlineid = hfe_orderline)") \
		_T(" WHERE hfe_docno      =%ld") \
		_T(" AND hpo_reference_id =%ld") \
		_T(" AND hfe_type        IN('D','P','M')") \
		_T(" GROUP BY hsd_feeidx,") \
		_T("   hsd_name,") \
		_T("   hfe_desc,") \
		_T("   hfe_unit,") \
		_T("   hfe_unitprice,") \
		_T("   hfe_category,") \
		_T("   hpol_unitprice") \
		_T(" ORDER BY hsd_feeidx,") \
		_T("   hfe_desc"), nDocumentNo, nOrderID);
	int nNewFeeIdx = 0, nOldFeeIdx = 0;

	rsl.ExecSQL(szSQL);
	if (rsl.IsEOF()) {
		_tprintf(_T("\r\nNo Drug"));
		return;
	}
	while (!rsl.IsEOF())
	{

		rsl.GetValue(_T("grpidx"), nNewFeeIdx);
		if (nNewFeeIdx != nOldFeeIdx)
		{
			if (grp2cost > 0)
			{
				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
				tmpStr.Format(_T("\x43\x1ED9ng(%d):"), nIdx);
				rptDetail->SetValue(_T("TotalAmountLabel"), tmpStr);
				FormatCurrency(grp2optcost, tmpStr);
				rptDetail->SetValue(_T("6"), tmpStr);
				FormatCurrency(grp2inscost, tmpStr);
				rptDetail->SetValue(_T("7"), tmpStr);
				FormatCurrency(grp2patpaid, tmpStr);
				rptDetail->SetValue(_T("8"), tmpStr);
				FormatCurrency(grp2cost, tmpStr);
				rptDetail->SetValue(_T("9"), tmpStr);
				grp2cost = grp2inscost = grp2optcost = grp2patpaid = 0;
			}

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(2));
			tmpStr.Format(_T("%d"), ++nIdx);
			rptDetail->SetValue(_T("TypeID"), tmpStr);
			if (nNewFeeIdx == 1)
				tmpStr.Format(_T("Thu\x1ED1\x63, h\xF3\x61 \x63h\x1EA5t, m\xE1u, \x64\x1ECB\x63h truy\x1EC1n"));
			else if (nNewFeeIdx == 2)
				tmpStr.Format(_T("V\x1EADt t\x1B0 y t\x1EBF ti\xEAu h\x61o"));
			else
			{
				rsl.GetValue(_T("grpname"), tmpStr);
			}
			rptDetail->SetValue(_T("TypeName"), tmpStr);

			nIdxl = 1;
			nOldFeeIdx = nNewFeeIdx;
		}
		rptDetail = rpt.AddDetail();

		tmpStrIdx.Format(_T("%d)   "), nIdxl++);
		rsl.GetValue(_T("hfe_desc"), tmpStr);
		rptDetail->SetValue(_T("1"), _T(""));
		rptDetail->SetValue(_T("2"), tmpStrIdx + tmpStr);

		rsl.GetValue(_T("hfe_unit"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);

		rsl.GetValue(_T("qty"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);

		rsl.GetValue(_T("hfe_unitprice"), unitprice);
		FormatCurrency(unitprice, tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);

		rsl.GetValue(_T("optcost"), optcost);
		grp2optcost += optcost;
		grpoptcost += optcost;
		ttloptcost += optcost;
		FormatCurrency(optcost, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);

		rsl.GetValue(_T("inscost"), inscost);
		grp2inscost += inscost;
		grpinscost += inscost;
		ttlinscost += inscost;
		FormatCurrency(inscost, tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);

		rsl.GetValue(_T("patpaid"), patpaid);
		grp2patpaid += patpaid;
		grppatpaid += patpaid;
		ttlpatpaid += patpaid;
		FormatCurrency(patpaid, tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);


		rsl.GetValue(_T("cost"), cost);
		grp2cost += cost;
		grpcost += cost;
		ttlcost += cost;
		FormatCurrency(cost, tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);

		rsl.MoveNext();
	}


	if (grp2cost > 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
		tmpStr.Format(_T("\x43\x1ED9ng(%d):"), nIdx);
		rptDetail->SetValue(_T("TotalAmountLabel"), tmpStr);
		FormatCurrency(grp2optcost, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		FormatCurrency(grp2inscost, tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		FormatCurrency(grp2patpaid, tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		FormatCurrency(grp2cost, tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);
		grp2cost = grp2inscost = grp2optcost = grp2patpaid = 0;
	}

	rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
	for (int i = 0; i < nIdx; i++) {
		if (!szTotalComment.IsEmpty())
			szTotalComment.AppendFormat(_T("+"));
		szTotalComment.AppendFormat(_T("%d"), i + 1);
	}
	tmpStr.Format(_T("T\x1ED5ng (%s)=(%s):"), lpszChapter[nChapter], szTotalComment);
	szTotalComment.Empty();
	rptDetail->SetValue(_T("TotalAmountLabel"), tmpStr);

	FormatCurrency(grpoptcost, tmpStr);
	rptDetail->SetValue(_T("6"), tmpStr);
	FormatCurrency(grpinscost, tmpStr);
	rptDetail->SetValue(_T("7"), tmpStr);
	FormatCurrency(grppatpaid, tmpStr);
	rptDetail->SetValue(_T("8"), tmpStr);
	FormatCurrency(grpcost, tmpStr);
	rptDetail->SetValue(_T("9"), tmpStr);


	CString szSumInWord;
	szSumInWord.Format(_T("\x110\x1ED3ng"));
	FormatCurrency(ttlcost, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	FormatCurrency(ttlinscost, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("InsurancePaid"), tmpStr);
	FormatCurrency(ttlpatpaid, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("PatientPaid"), tmpStr);

	//Page Footer
	//Report Footer
	CDate sysDate;
	sysDate.ParseDate(pMF->GetSysDate());
	rpt.GetReportFooter()->Format(_T("PrintDate"), sysDate.GetDay(), sysDate.GetMonth(), sysDate.GetYear());
	//rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);
	rpt.PrintPreview();

}



void CPrintForms::PrintOperationHitechMaterial(long nDocumentNo, long nOperationIdx)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	static CReport rpt;
	CString tmpStr, szSQL;
	if (!rpt.Init(_T("Reports/HMS/HF_OPERATIONMATERIAL_HITECH.RPT")))
	{
		//ShowMessageBox(_T("Can not open file report."), MB_OK);
		return;
	}


	//Page Header
//Report Detail
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptHead = NULL;
	int nIdx = 1;
	double nTtCost = 0, nGrpCost = 0, nGrpCostAB = 0, nCost = 0, nOutInsCost = 0;
	double nTotalInsLimit = 0, nTotalDiscount = 0, nTotalPatpaid = 0, nAmount = 0;
	bool bInsOnly = true;
	bool	bVeocotsong = false;

	CRecord rsl(&pMF->m_db);
	CString szOldType = _T(""), szNewType, szSysTime = pMF->GetSysTime(), szSysDate = pMF->GetSysDate();
	//Patient Info query
	szSQL.Format(_T(" SELECT hcr_recordno AS recordno,") \
		_T("   hd_docno docno,") \
		_T("   Trim(hp_surname") \
		_T("   ||' '") \
		_T("   ||hp_midname") \
		_T("   ||' '") \
		_T("   ||hp_firstname)                                         AS pname,") \
		_T("   Extract(YEAR FROM hp_birthdate)                         AS birthdate,") \
		_T("   hms_getage(hd_admitdate, hp_birthdate)                  AS age,") \
		_T("   Get_syssel_desc('sys_sex', hp_sex)                      AS sex,") \
		_T("   hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid))         AS address,") \
		_T("   get_objectname(hd_object)                               AS obj,") \
		_T("   get_username(ho_practitioner)                                 AS doctor,") \
		_T("   hc_cardno                                               AS cardno,") \
		_T("   hd_disrate                                              AS insrate,") \
		_T("   hd_diagnostic                                           AS diagnostic,") \
		_T("   Get_departmentname(ho_deptid)                           AS dept,") \
		_T("   ho_performdate                                          AS performdate,") \
		_T("   hfe_desc                                                AS optname ,") \
		_T("   hfe_quantity                                            AS qty,") \
		_T("   (hms_fee.hfe_cost-hfe_diffcost)/hfe_quantity                 AS insprice,") \
		_T("   (hms_fee.hfe_cost-hfe_diffcost) AS amount,") \
		_T("   hms_fee.hfe_inspaid as inscost, ") \
		_T("   hms_fee.hfe_discount as discount, ") \
		_T("   hfe_diffcost as  diffamount,") \
		_T(" (hfe_patdebt+hfe_patpaid) as patpaid, ") \
		_T("   ho_maxinspaid, ") \
		_T(" HO_SCOLIOSIS ") \
		_T(" FROM hms_patient") \
		_T(" LEFT JOIN hms_doc") \
		_T(" ON( hd_patientno = hp_patientno )") \
		_T(" LEFT JOIN hms_clinical_record") \
		_T(" ON( hcr_docno = hd_docno )") \
		_T(" LEFT JOIN hms_card") \
		_T(" ON( hc_patientno = hp_patientno") \
		_T(" AND hc_idx       = hd_cardidx") \
		_T(" AND hc_cardno    = hd_cardno )") \
		_T(" LEFT JOIN hms_operation") \
		_T(" ON ( hd_docno = ho_docno)") \
		_T(" LEFT JOIN hms_fee") \
		_T(" ON (hfe_docno    = ho_docno") \
		_T(" AND hfe_orderid  = ho_idx)") \
		_T(" WHERE hd_docno   = %ld") \
		_T(" AND ho_idx       = %ld") \
		_T(" AND hfe_type     ='O'") \
		_T(" AND hfe_quantity > 0"), nDocumentNo, nOperationIdx);




	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}

	rs.GetValue(_T("ho_maxinspaid"), nTotalInsLimit);
	rs.GetValue(_T("HO_SCOLIOSIS"), bVeocotsong);

	//Header Data
	rpt.GetReportHeader()->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptHead = rpt.GetReportHeader();
	rptHead->SetValue(_T("RecordNo"), rs.GetValue(_T("recordno")));
	rptHead->SetValue(_T("DocumentNo"), rs.GetValue(_T("docno")));
	tmpStr.Format(rptHead->GetValue(_T("PrintDate")), szSysTime, szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rptHead->SetValue(_T("PrintDate"), tmpStr);
	rptHead->SetValue(_T("PatientName"), rs.GetValue(_T("pname")));
	rptHead->SetValue(_T("Age"), rs.GetValue(_T("age")));
	rptHead->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
	rptHead->SetValue(_T("address"), rs.GetValue(_T("address")));
	rptHead->SetValue(_T("cardno"), rs.GetValue(_T("cardno")));
	rptHead->SetValue(_T("Object"), rs.GetValue(_T("obj")));
	rptHead->SetValue(_T("Department"), rs.GetValue(_T("dept")));
	rptHead->SetValue(_T("%"), rs.GetValue(_T("insrate")));
	rptHead->SetValue(_T("perfomdate"), CDate::Convert(rs.GetValue(_T("performdate")), yyyymmdd, ddmmyyyy));
	rptHead->SetValue(_T("doctor"), rs.GetValue(_T("doctor")));
	rptHead->SetValue(_T("diagnostic"), rs.GetValue(_T("diagnostic")));

	rs.GetValue(_T("diffamount"), nOutInsCost);

	rptHeader = rpt.AddDetail(rpt.GetGroupHeader(1));
	rptHeader->SetValue(_T("SubGroupID"), _T("A"));
	rptHeader->SetValue(_T("SubGroupName"), _T("\x43hi ph\xED trong quy \x111\x1ECBnh \x63\x1EE7\x61 \x42H\x58H"));
	int nIndex = 1;
	double opt_inscost = 0;
	double opt_discount = 0;
	double opt_patpaid = 0;
	rs.GetValue(_T("inscost"), opt_inscost);
	rs.GetValue(_T("discount"), opt_discount);
	rs.GetValue(_T("patpaid"), opt_patpaid);


	rptHeader = rpt.AddDetail(rpt.GetGroupHeader(2));
	rptHeader->SetValue(_T("TypeID"), _T("I"));
	rptHeader->SetValue(_T("TypeName"), _T("\x44\x1ECB\x63h v\x1EE5 k\x1EF9 thu\x1EADt \x63\x61o (\x44VKT\x43)"));

	if (opt_discount > 0)
	{
		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nIndex++);
		rptDetail->SetValue(_T("1"), tmpStr);
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("optname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("unit")));
		rptDetail->SetValue(_T("4"), _T(""));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("qty")));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("qty")));
		rptDetail->SetValue(_T("7"), rs.GetValue(_T("insprice")));
		rs.GetValue(_T("amount"), nCost);
		rptDetail->SetValue(_T("8"), double2str(nCost));

		nGrpCostAB += nCost;

		if (nCost > 0)
		{
			rptHeader = rpt.AddDetail(rpt.GetGroupHeader(3));
			rptHeader->SetValue(_T("TotalAmount"), _T("\x43\x1ED9ng I"));
			rptHeader->SetValue(_T("8"), double2str(nCost));

			nCost = 0;
		}
	}
	else
	{

	}

	rs.GetValue(_T("discount"), nAmount);
	nTotalDiscount += nAmount;
	rs.GetValue(_T("patpaid"), nAmount);
	nTotalPatpaid += nAmount;

	//Material Info query
	szSQL.Format(_T(" SELECT product_type,") \
		_T("   product_name,") \
		_T("   product_uomname,") \
		_T("   manufacture,") \
		_T("   idx,") \
		_T("   unitprice,") \
		_T("   SUM(qty)      AS qty,") \
		_T("   SUM(cost)     AS amount,") \
		_T(" SUM(inspaid) as inspaid, ") \
		_T("   SUM(discount) AS discount, ") \
		_T(" SUM(diffpaid) AS diffpaid ") \
		_T(" FROM") \
		_T("   (SELECT mp_producttype AS product_type,") \
		_T("     mp_name              AS product_name,") \
		_T("     adu_name             AS product_uomname,") \
		_T("     get_manufacturename(mp_manufacture_id) manufacture,") \
		_T("     CASE") \
		_T("       WHEN hpol_inspaid = 'Y'") \
		_T("       THEN 0") \
		_T("       ELSE 1") \
		_T("     END                                     AS idx,") \
		_T("     hfe_unitprice AS unitprice,") \
		_T("     hfe_quantity                            AS qty,") \
		_T("     hfe_cost                   AS cost,") \
		_T("     hfe_inspaid                   AS inspaid,") \
		_T("     hfe_discount                            AS discount, ") \
		_T("     hfe_diffcost                            AS diffpaid ") \
		_T("   FROM hms_ipharmaorder") \
		_T("   LEFT JOIN hms_ipharmaorderline") \
		_T("   ON(hpol_docno=hpo_docno and hpol_orderid=hpo_orderid)") \
		_T("   LEFT JOIN hms_fee") \
		_T("   ON(hfe_docno      = hpo_docno") \
		_T("   AND hfe_orderid   = hpo_orderid") \
		_T("   AND hfe_orderline = hpol_orderlineid") \
		_T("   AND hfe_type     IN('D','M') )") \
		_T("   LEFT JOIN m_product") \
		_T("   ON(mp_product_id=hpol_product_id)") \
		_T("   LEFT JOIN ad_uom") \
		_T("   ON(adu_uom_id        =mp_product_uom_id)") \
		_T("   WHERE hpo_docno      =%ld") \
		_T("   AND hpo_reference_id =%ld") \
		_T("   AND hpo_ordertype   IN('D','M')") \
		_T("   AND mp_org_id     IN('MA','BB') ") \
		_T("   AND hpol_inoperation<>'Y' AND hfe_discount > 0  and hpol_hitech='Y' ") \
		_T("   )") \
		_T(" GROUP BY product_type,") \
		_T("   product_uomname,") \
		_T("   product_name,") \
		_T("   manufacture,") \
		_T("   unitprice,") \
		_T("   idx") \
		_T(" ORDER BY idx, product_name, manufacture, unitprice"), nDocumentNo, nOperationIdx);



	rsl.ExecSQL(szSQL);
	if (!rsl.IsEOF())
	{
	}

	rptHeader = rpt.AddDetail(rpt.GetGroupHeader(2));
	rptHeader->SetValue(_T("TypeID"), _T("II"));
	rptHeader->SetValue(_T("TypeName"), _T("V\x1EADt t\x1EF1 ti\xEAu h\x61o \x111\x1EB7\x63 \x62i\x1EC7t"));

	nIdx = 1;
	double nDiffPaid = 0;
	double nAmt = 0;
	double nInsPaid = 0;
	double nTotalInsPaid = 0;


	bool bApplyMaterialLimit = false;

	nTotalInsPaid += nGrpCostAB;

	while (!rsl.IsEOF())
	{
		rsl.GetValue(_T("idx"), szNewType);
		if (szNewType != szOldType)
		{

			nIdx = 1;
			szOldType = szNewType;
		}
		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nIdx++);
		rptDetail->SetValue(_T("1"), tmpStr);
		rsl.GetValue(_T("product_name"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rsl.GetValue(_T("product_uomname"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rsl.GetValue(_T("manufacture"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rsl.GetValue(_T("qty"), tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rsl.GetValue(_T("unitprice"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rsl.GetValue(_T("amount"), nCost);
		rsl.GetValue(_T("inspaid"), nInsPaid);
		rsl.GetValue(_T("diffpaid"), nAmt);

		nTotalInsPaid += nInsPaid;

		//	nDiffPaid += nAmt;
		nGrpCost += nCost;
		tmpStr.Format(_T("%f"), nCost);
		rptDetail->SetValue(_T("8"), tmpStr);
		if (szNewType == _T("0"))
		{
			rsl.GetValue(_T("discount"), nAmount);
			nTotalDiscount += nAmount;
		}
		if (nInsPaid > 0 && nInsPaid != nCost)
		{
			rptDetail = rpt.AddDetail();
			rptDetail->SetValue(_T("1"), _T(""));
			//rptDetail->SetValue(_T("2"), _T(""));
			rptDetail->SetValue(_T("3"), _T(""));
			rptDetail->SetValue(_T("4"), _T(""));
			rptDetail->SetValue(_T("5"), _T(""));
			rptDetail->SetValue(_T("6"), _T(""));
			rptDetail->SetValue(_T("7"), _T(""));
			rptDetail->SetValue(_T("2"), _T("\x110\x1ECBnh m\x1EE9\x63 \x42H\x58H"));
			tmpStr.Format(_T("%.2f"), nInsPaid);
			rptDetail->SetValue(_T("8"), tmpStr);

			bApplyMaterialLimit = true;

		}

		rsl.MoveNext();
	}

	szSQL.Format(_T("SELECT hfe_inspaid, hfe_discount  FROM hms_fee WHERE hfe_docno = %ld and hfe_orderid=%ld and hfe_type='V' and hfe_itemid='VT000000' "),
		nDocumentNo, nOperationIdx);
	rsl.ExecSQL(szSQL);
	if (!rsl.IsEOF())
	{
		rsl.GetValue(_T("hfe_inspaid"), nTotalInsPaid);
		rsl.GetValue(_T("hfe_discount"), nTotalDiscount);


		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), _T(""));
		//rptDetail->SetValue(_T("2"), _T(""));
		rptDetail->SetValue(_T("3"), _T(""));
		rptDetail->SetValue(_T("4"), _T(""));
		rptDetail->SetValue(_T("5"), _T(""));
		rptDetail->SetValue(_T("6"), _T(""));
		rptDetail->SetValue(_T("7"), _T(""));
		rptDetail->SetValue(_T("2"), _T("\x110\x1ECBnh m\x1EE9\x63 \x42H\x58H"));
		tmpStr.Format(_T("%.2f"), nTotalInsPaid);
		rptDetail->SetValue(_T("8"), tmpStr);

	}


	if (nGrpCost > 0)
	{
		rptHeader = rpt.AddDetail(rpt.GetGroupHeader(3));
		rptHeader->SetValue(_T("TotalAmount"), _T("\x43\x1ED9ng II"));
		tmpStr.Format(_T("%f"), nGrpCost);
		rptHeader->SetValue(_T("8"), tmpStr);
		nGrpCostAB += nGrpCost;
	}
	nTtCost += nGrpCostAB;
	nGrpCostAB = 0;
	//	if(nTtCost > 0)
	{
		rptHeader = rpt.AddDetail(rpt.GetGroupHeader(3));
		rptHeader->SetValue(_T("TotalAmount"), _T("\x43\x1ED9ng A(I+II)"));
		tmpStr.Format(_T("%f"), nTtCost);
		nGrpCostAB = 0;
		rptHeader->SetValue(_T("8"), tmpStr);

	}



	//B:NGOAI QUY DINH BHXH
	rptHeader = rpt.AddDetail(rpt.GetGroupHeader(1));
	rptHeader->SetValue(_T("SubGroupID"), _T("B"));
	rptHeader->SetValue(_T("SubGroupName"), _T("\x43hi ph\xED ngo\xE0i quy \x111\x1ECBnh \x42H\x58H"));

	nGrpCostAB = 0;
	if (opt_discount <= 0 && opt_patpaid > 0)
	{
		rptHeader = rpt.AddDetail(rpt.GetGroupHeader(2));
		rptHeader->SetValue(_T("TypeID"), _T("I"));
		rptHeader->SetValue(_T("TypeName"), _T("\x44\x1ECB\x63h v\x1EE5 k\x1EF9 thu\x1EADt \x63\x61o (\x44VKT\x43)"));

		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nIndex++);
		rptDetail->SetValue(_T("1"), tmpStr);
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("optname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("unit")));
		rptDetail->SetValue(_T("4"), _T(""));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("qty")));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("qty")));
		rptDetail->SetValue(_T("7"), rs.GetValue(_T("insprice")));
		rs.GetValue(_T("amount"), nCost);
		rptDetail->SetValue(_T("8"), double2str(nCost));
		if (nCost > 0)
		{
			rptHeader = rpt.AddDetail(rpt.GetGroupHeader(3));
			rptHeader->SetValue(_T("TotalAmount"), _T("\x43\x1ED9ng I"));
			rptHeader->SetValue(_T("8"), double2str(nCost));
			nGrpCostAB += nCost;
			nCost = 0;
		}



	}
	else if (nOutInsCost > 0)
	{

		nOutInsCost += nDiffPaid;
		rptHeader = rpt.AddDetail(rpt.GetGroupHeader(3));
		rptHeader->SetValue(_T("TotalID"), _T("I"));
		rptHeader->SetValue(_T("TotalAmount"), _T("\x43hi ph\xED kh\xE1\x63 ngo\xE0i quy \x111\x1ECBnh \x42H\x58H"));
		tmpStr.Format(_T("%.2f"), (nOutInsCost));
		rptHeader->SetValue(_T("8"), tmpStr);

		nGrpCostAB += nOutInsCost;
	}

	//Material Info query
	szSQL.Format(_T(" SELECT product_type,") \
		_T("   product_name,") \
		_T("   product_uomname,") \
		_T("   manufacture,") \
		_T("   idx,") \
		_T("   unitprice,") \
		_T("   SUM(qty)      AS qty,") \
		_T("   SUM(cost)     AS amount,") \
		_T(" SUM(inspaid) as inspaid, ") \
		_T("   SUM(discount) AS discount, ") \
		_T(" SUM(diffpaid) AS diffpaid ") \
		_T(" FROM") \
		_T("   (SELECT mp_producttype AS product_type,") \
		_T("     mp_name              AS product_name,") \
		_T("     adu_name             AS product_uomname,") \
		_T("     get_manufacturename(mp_manufacture_id) manufacture,") \
		_T("     CASE") \
		_T("       WHEN hpol_inspaid = 'Y'") \
		_T("       THEN 0") \
		_T("       ELSE 1") \
		_T("     END                                     AS idx,") \
		_T("     hfe_unitprice AS unitprice,") \
		_T("     hfe_quantity                            AS qty,") \
		_T("     hfe_cost                   AS cost,") \
		_T("     hfe_inspaid                   AS inspaid,") \
		_T("     hfe_discount                            AS discount, ") \
		_T("     hfe_diffcost                            AS diffpaid ") \
		_T("   FROM hms_ipharmaorder") \
		_T("   LEFT JOIN hms_ipharmaorderline") \
		_T("   ON(hpol_docno=hpo_docno and hpol_orderid=hpo_orderid)") \
		_T("   LEFT JOIN hms_fee") \
		_T("   ON(hfe_docno      = hpo_docno") \
		_T("   AND hfe_orderid   = hpo_orderid") \
		_T("   AND hfe_orderline = hpol_orderlineid") \
		_T("   AND hfe_type     IN('D','M') )") \
		_T("   LEFT JOIN m_product") \
		_T("   ON(mp_product_id=hpol_product_id)") \
		_T("   LEFT JOIN ad_uom") \
		_T("   ON(adu_uom_id        =mp_product_uom_id)") \
		_T("   WHERE hpo_docno      =%ld") \
		_T("   AND hpo_reference_id =%ld") \
		_T("   AND hpo_ordertype   IN('D','M')") \
		_T("   AND mp_org_id     IN('MA','BB') ") \
		_T("   AND hpol_inoperation<>'Y' AND hfe_discount = 0 and hpol_hitech='Y' ") \
		_T("   )") \
		_T(" GROUP BY product_type,") \
		_T("   product_uomname,") \
		_T("   product_name,") \
		_T("   manufacture,") \
		_T("   unitprice,") \
		_T("   idx") \
		_T(" ORDER BY idx, product_name, manufacture, unitprice"), nDocumentNo, nOperationIdx);

	//_msg(_T("%s"), szSQL);
	rsl.ExecSQL(szSQL);
	if (!rsl.IsEOF())
	{
	}

	rptHeader = rpt.AddDetail(rpt.GetGroupHeader(2));
	rptHeader->SetValue(_T("TypeID"), _T("II"));
	rptHeader->SetValue(_T("TypeName"), _T("V\x1EADt t\x1EF1 ti\xEAu h\x61o \x111\x1EB7\x63 \x62i\x1EC7t"));


	nIdx = 1;
	nDiffPaid = 0;
	nAmt = 0;
	nInsPaid = 0;



	bApplyMaterialLimit = false;



	nGrpCost = 0;
	while (!rsl.IsEOF())
	{
		rsl.GetValue(_T("idx"), szNewType);
		if (szNewType != szOldType)
		{

			nIdx = 1;
			szOldType = szNewType;
		}
		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nIdx++);
		rptDetail->SetValue(_T("1"), tmpStr);
		rsl.GetValue(_T("product_name"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rsl.GetValue(_T("product_uomname"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rsl.GetValue(_T("manufacture"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rsl.GetValue(_T("qty"), tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rsl.GetValue(_T("unitprice"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rsl.GetValue(_T("amount"), nCost);
		rsl.GetValue(_T("inspaid"), nInsPaid);
		rsl.GetValue(_T("diffpaid"), nAmt);



		//	nDiffPaid += nAmt;
		nGrpCost += nCost;
		tmpStr.Format(_T("%f"), nCost);
		rptDetail->SetValue(_T("8"), tmpStr);
		if (szNewType == _T("0"))
		{
			rsl.GetValue(_T("discount"), nAmount);
			nTotalDiscount += nAmount;
		}


		if (nInsPaid > 0 && nInsPaid != nCost)
		{
			rptDetail = rpt.AddDetail();
			rptDetail->SetValue(_T("1"), _T(""));
			//rptDetail->SetValue(_T("2"), _T(""));
			rptDetail->SetValue(_T("3"), _T(""));
			rptDetail->SetValue(_T("4"), _T(""));
			rptDetail->SetValue(_T("5"), _T(""));
			rptDetail->SetValue(_T("6"), _T(""));
			rptDetail->SetValue(_T("7"), _T(""));
			rptDetail->SetValue(_T("2"), _T("\x110\x1ECBnh m\x1EE9\x63 \x42H\x58H"));
			tmpStr.Format(_T("%.2f"), nInsPaid);
			rptDetail->SetValue(_T("8"), tmpStr);

			bApplyMaterialLimit = true;

		}

		rsl.MoveNext();
	}






	if (nGrpCost > 0)
	{
		rptHeader = rpt.AddDetail(rpt.GetGroupHeader(3));
		rptHeader->SetValue(_T("TotalAmount"), _T("\x43\x1ED9ng II"));
		tmpStr.Format(_T("%f"), nGrpCost);
		rptHeader->SetValue(_T("8"), tmpStr);
		nGrpCostAB += nGrpCost;
	}

	nTtCost += nGrpCostAB;
	if (nGrpCostAB > 0)
	{
		rptHeader = rpt.AddDetail(rpt.GetGroupHeader(3));
		rptHeader->SetValue(_T("TotalAmount"), _T("\x43\x1ED9ng B (I + II)"));
		tmpStr.Format(_T("%f"), nGrpCostAB);
		rptHeader->SetValue(_T("8"), tmpStr);
	}



	if (nTtCost > 0)
	{
		rptHeader = rpt.AddDetail(rpt.GetGroupHeader(3));
		rptHeader->SetValue(_T("TotalID"), _T("C"));
		rptHeader->SetValue(_T("TotalAmount"), _T("C = A + B"));
		tmpStr.Format(_T("%f"), nTtCost);
		rptHeader->SetValue(_T("8"), tmpStr);
	}


	//Page Footer
	//Report Footer
	rptDetail = rpt.GetReportFooter();

	if (!bVeocotsong)
	{
		szSQL.Format(_T("SELECT hfe_inspaid, hfe_discount  FROM hms_fee WHERE hfe_docno = %ld and hfe_orderid=%ld and hfe_type='V' and hfe_itemid='VT000002' "),
			nDocumentNo, nOperationIdx);
		rs.ExecSQL(szSQL);
		if (!rs.IsEOF())
		{
			rs.GetValue(_T("hfe_inspaid"), nTotalInsPaid);
			rs.GetValue(_T("hfe_discount"), nTotalDiscount);
		}
	}

	nTotalInsPaid += opt_inscost;
	nTotalDiscount += opt_discount;

	if (nTotalDiscount <= 0)
	{
		nTotalInsPaid = 0;
	}

	tmpStr.Format(_T("%.f"), (nTotalInsPaid));

	rptDetail->SetValue(_T("TotalInsLimit"), tmpStr);

	tmpStr.Format(_T("%.f"), (nTotalDiscount + opt_discount));
	rptDetail->SetValue(_T("TotalInsPaid"), tmpStr);
	nTotalPatpaid = nTtCost - nTotalDiscount;
	tmpStr.Format(_T("%.f"), ceil(nTotalPatpaid));
	rptDetail->SetValue(_T("TotalPatpaid"), tmpStr);
	rpt.PrintPreview();
}




BOOL CPrintForms::CheckCardExpire(long nDocumentNo, long nRefIdx)
{
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr;
	CString szExpDate, szInsRegDate;

	bool bCardExpire = false;

	szSQL.Format(_T(" SELECT hc_expdate as expdate,") \
		_T("        hd_insregdate as insregdate") \
		_T(" FROM hms_doc") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx)") \
		_T(" WHERE hd_docno=%ld AND length(hd_cardno)>1"), nDocumentNo);

	rs.ExecSQL(szSQL);

	if (!rs.IsEOF())
	{
		rs.GetValue(_T("expdate"), szExpDate);
		rs.GetValue(_T("insregdate"), szInsRegDate);
	}
	else
	{
		return bCardExpire;
	}

	szSQL.Format(_T(" SELECT trunc_date(ho_orderdate) AS orderdate") \
		_T(" FROM hms_operation") \
		_T(" WHERE ho_docno=%ld AND ho_hasfee IN('Y','M')") \
		_T("       AND hfe_refstatus IN('O') AND ho_idx=%ld"),
		nDocumentNo, nRefIdx);

	rs.ExecSQL(szSQL);

	while (!rs.IsEOF())
	{
		rs.GetValue(_T("orderdate"), tmpStr);

		if (!bCardExpire)
		{
			if (CompareDate(tmpStr, szInsRegDate) < 0 || CompareDate(tmpStr, szExpDate) > 0)
			{
				bCardExpire = true;
			}
		}
		rs.MoveNext();
	}

	if (!bCardExpire)
	{
		szSQL.Format(_T(" SELECT trunc_date(hpo_orderdate) AS orderdate") \
			_T(" FROM hms_ipharmaorder") \
			_T(" LEFT JOIN hms_ipharmaorderline ON(hpol_docno=hpo_docno and hpol_orderid=hpo_orderid)") \
			_T(" WHERE hpo_docno=%ld AND hfe_refstatus IN('O')") \
			_T("       AND hpo_reference_id=%ld AND hpo_deptid IN('%s')"),
			nDocumentNo, nRefIdx, pMF->GetDepartmentID());

		rs.ExecSQL(szSQL);

		while (!rs.IsEOF())
		{
			rs.GetValue(_T("orderdate"), tmpStr);

			if (!bCardExpire)
			{
				if (CompareDate(tmpStr, szInsRegDate) < 0 || CompareDate(tmpStr, szExpDate) > 0)
				{
					bCardExpire = true;
				}
			}
			rs.MoveNext();
		}
	}
	return bCardExpire;
}

//void CPrintForms::TM_PrintDrugCabinetUsed(CString szFromDate, CString szToDate)
//{
//	CGuiMainFrame *pMF = (CGuiMainFrame *) AfxGetMainWnd();
//
//	CStringArray strObjects;
//	CStringArray strOrgID;
//
//	strObjects.Add(_T("'1','3','8'"));
//	strObjects.Add(_T("'7'"));
//	strObjects.Add(_T("'2','4','5','6','9','10','11','12'"));
//
//	strOrgID.Add(_T("'PM'"));
//	strOrgID.Add(_T("'MA'"));
//
//	CRecord rs(&pMF->m_db);
//	CRecord rsl(&pMF->m_db);
//	CRecord rsc(&pMF->m_db);
//
//	static CReport rpt;
//	CString szSQL;
//	CString tmpStr, szTemp;
//
//	if (!rpt.Init(_T("Reports/HMS/TM_DANHSACHBENHNHANSUDUNGTHUOCTUTRUC.RPT")))
//		return;
//
//	StringUpper(pMF->m_szHealthService, tmpStr);
//	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), tmpStr);
//	StringUpper(pMF->m_szHospitalName, tmpStr);
//	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), tmpStr);
//	
//	rpt.GetReportHeader()->Format(_T("OrderDate"),
//		                          CDateTime::Convert(szFromDate, yyyymmdd | hhmm, ddmmyyyy | hhmm),
//								  CDateTime::Convert(szToDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));
//
//	CReportSection* rptDetail;
//	CString szObjects, szOrgIDs;
//	CString szOldDoc, szNewDoc;
//	CString szOldType, szNewType;
//
//	for (int p = 0; p < strObjects.GetSize(); p++)
//	{
//		szObjects.Format(_T("%s"), strObjects[p]);
//
//		for (int q = 0; q < strOrgID.GetSize(); q++)
//		{
//			szOrgIDs.Format(_T("%s"), strOrgID[q]);
//
//			szSQL.Format(_T(" SELECT * ") \
//						_T(" FROM") \
//						_T(" (") \
//						_T("  SELECT distinct hpo_orderid as orderid,") \
//						_T("         hd_docno as docno,") \
//						_T("         hcr_recordno as recordno,") \
//						_T(" 			  trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
//						_T("         hpo_ordertype as ordertype,") \
//						_T("         case when hpo_ordertype in('C') then 1") \
//						_T("              when hpo_ordertype in('M') then 2") \
//						_T("              when hpo_ordertype in('B') then 3") \
//						_T("         else 4 end as idx") \
//						_T("  FROM hms_patient") \
//						_T("  LEFT JOIN hms_doc ON(hd_patientno=hp_patientno)") \
//						_T("  LEFT JOIN hms_clinical_record ON(hcr_docno=hd_docno)") \
//						_T("  LEFT JOIN hms_ipharmaorder ON(hpo_docno=hd_docno)") \
//						_T("  LEFT JOIN hms_ipharmaorderline ON(hpo_orderid=hpol_orderid)") \
//						_T("  LEFT JOIN m_product ON(mp_product_id=hpol_product_id)") \
//						_T("  LEFT JOIN m_product_item ON(mpi_product_item_id=hpol_product_item_id)") \
//						_T("  LEFT JOIN m_storagelist ON(msl_storage_id=hpo_storage_id)") \
//						_T("  WHERE msl_type IN('C')") \
//						_T("        AND hpo_orderstatus IN('A')") \
//						_T("        AND hd_object IN(%s)") \
//						_T("        AND mp_org_id IN(%s)") \
//						_T("        AND hpo_approvedate BETWEEN to_timestamp('%s', 'yyyy/mm/dd hh24:mi:ss') AND to_timestamp('%s', 'yyyy/mm/dd hh24:mi:ss')") \
//						_T(" ) Tbl") \
//						_T(" ORDER BY idx, ordertype, pname"),
//						szObjects, szOrgIDs,
//						szFromDate, szToDate);
//
//			rs.ExecSQL(szSQL);
//
//			if (rs.IsEOF())
//				continue;
//
//			double nQty = 0;
//			int nIndex = 1, nIdx = 1;
//			//int nRoomID, nBedID;
//			CString szOrderID, szDocNo;
//			CString szTemp;
//			COLDRUGINFO colInfo;
//			CArray<COLDRUGINFO, COLDRUGINFO&> m_arrItem;
//
//			m_arrItem.RemoveAll();
//
//			while (!rs.IsEOF())
//			{
//				if (!szOrderID.IsEmpty())
//					szOrderID += _T(",");
//				szOrderID.AppendFormat(_T("%ld"), str2long(rs.GetValue(_T("orderid"))));
//				rs.MoveNext();
//			}
//
//			if (!szOrderID.IsEmpty())
//			{
//				szSQL.Format(_T(" SELECT distinct mp_product_id as id,") \
//							_T("        mp_name as drugname") \
//							_T(" FROM hms_ipharmaorder") \
//							_T(" LEFT JOIN hms_ipharmaorderline ON(hpo_orderid=hpol_orderid)") \
//							_T(" LEFT JOIN m_product ON(mp_product_id=hpol_product_id)") \
//							_T(" LEFT JOIN m_product_item ON(mpi_product_item_id=hpol_product_item_id)") \
//							_T(" WHERE hpo_orderid IN(%s)") \
//							_T("       AND length(mp_name)>0 AND mp_org_id IN(%s)") \
//							_T(" ORDER BY drugname"),
//							szOrderID, szOrgIDs);
//
//				rsc.ExecSQL(szSQL);
//
//				_fmsg(_T("%s"), szSQL);
//
//				while (!rsc.IsEOF())
//				{ 
//					//MessageBox(_T("OK"));
//					/*if (nIndex <= m_nMaxCol)
//					{
//						szTemp.Format(_T("%d"), nIndex);
//						rsc.GetValue(_T("drugname"), tmpStr);	
//						rptDetail->SetValue(szTemp, tmpStr);
//						nIndex++;
//					}*/
//					if (nIdx % m_nMaxCol == 1)
//						nIdx = 1;
//
//					rsc.GetValue(_T("id"), tmpStr);
//					colInfo.szItemID = tmpStr;
//
//					rsc.GetValue(_T("drugname"), tmpStr);
//					colInfo.szName = tmpStr;
//
//					colInfo.nIndex = nIdx;
//					//colInfo.bIsRep = true;
//					m_arrItem.Add(colInfo);
//
//					nIdx++;
//					rsc.MoveNext();
//				}
//			}
//
//			int nCount = 0;
//			bool bCheck = false;
//			//_msg(_T("%d"), m_arrItem.GetSize());
//			int nMaxVal;
//
//			while (nCount * m_nMaxCol < m_arrItem.GetSize())
//			{
//				rs.MoveFirst();
//
//				nIndex = 1;
//
//				szOldDoc.Empty();
//				szNewDoc.Empty();
//				szNewType.Empty();
//				szOldType.Empty();
//				szOrderID.Empty();
//
//				if ((nCount + 1) * m_nMaxCol < m_arrItem.GetSize())
//					nMaxVal = (nCount + 1) * m_nMaxCol;
//				else
//					nMaxVal = m_arrItem.GetSize();
//
//				if (nCount > 0)
//				{
//					if (rptDetail)
//						rptDetail->SetPageBreak(true);
//				}
//
//				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
//
//				for (int j = nCount * m_nMaxCol; j < nMaxVal; j++)
//				{
//					/*if (j > nCount * m_nMaxCol && j % m_nMaxCol == 0)
//						break;*/
//					colInfo = m_arrItem[j];
//					szTemp.Format(_T("l%d"), colInfo.nIndex);
//					rptDetail->SetValue(szTemp, colInfo.szName);
//				}
//
//				while (!rs.IsEOF())
//				{
//					rs.GetValue(_T("ordertype"), szNewType);
//
//					if (!szNewType.IsEmpty() && szOldType != szNewType)
//					{
//						rptDetail = rpt.AddDetail(rpt.GetGroupHeader(2));
//						if (szNewType == _T("C"))
//							rptDetail->SetValue(_T("GroupName"), _T(""));
//						else if (szNewType == _T("M"))
//							rptDetail->SetValue(_T("GroupName"), _T(""));
//						else if (szNewType == _T("B"))
//							rptDetail->SetValue(_T("GroupName"), _T(""));
//						else
//							rptDetail->SetValue(_T("GroupName"), _T(""));
//
//						szOldType = szNewType;
//						szOldDoc.Empty();
//					}
//
//					rs.GetValue(_T("docno"), szNewDoc);
//
//					if (!szNewDoc.IsEmpty() && szOldDoc != szNewDoc)
//					{
//						if (!szOrderID.IsEmpty())
//						{
//							szSQL.Format(_T(" SELECT mp_product_id as id,") \
//										_T("        mp_name as drugname,") \
//										_T("        sum(hpol_qtyissue) as qty") \
//										_T(" FROM hms_ipharmaorder") \
//										_T(" LEFT JOIN hms_ipharmaorderline ON(hpo_orderid=hpol_orderid)") \
//										_T(" LEFT JOIN m_product ON(mp_product_id=hpol_product_id)") \
//										_T(" LEFT JOIN m_product_item ON(mpi_product_item_id=hpol_product_item_id)") \
//										_T(" LEFT JOIN ad_uom ON(adu_uom_id=mp_product_uom_id)") \
//										_T(" WHERE hpo_orderid IN(%s) AND mp_org_id IN(%s)") \
//										_T(" GROUP BY mp_product_id, mp_name") \
//										_T(" ORDER BY drugname, id"),
//										szOrderID, szOrgIDs);
//
//							rsl.ExecSQL(szSQL);
//							//double nTotalAmount = 0;
//							
//							while (!rsl.IsEOF())
//							{
//								rsl.GetValue(_T("id"), tmpStr);
//								for (int i = nCount * m_nMaxCol; i < nMaxVal; i++)
//								{
//									colInfo = m_arrItem[i];
//									if (colInfo.szItemID == tmpStr)
//									{
//										szTemp.Format(_T("%d"), colInfo.nIndex);
//										rsl.GetValue(_T("qty"), nQty);
//										tmpStr.Format(_T("%d"), nQty);
//										rptDetail->SetValue(szTemp, tmpStr);
//										/*rsl.GetValue(_T("qty"), nQty);
//										colInfo.nTotal += nQty;
//										m_arrItem.SetAt(i, colInfo);*/
//										//_msg(_T("%ld"), colInfo.nTotal);
//										break;
//									}
//								}
//								rsl.MoveNext();
//							}
//						}
//
//						rptDetail = rpt.AddDetail();
//
//						tmpStr.Format(_T("%d"), nIndex);
//						rptDetail->SetValue(_T("Index"), tmpStr);
//
//						rs.GetValue(_T("recordno"), tmpStr);
//						rptDetail->SetValue(_T("RecordNo"), szDocNo);
//
//						rs.GetValue(_T("pname"), tmpStr);
//						rptDetail->SetValue(_T("PatientName"), tmpStr);
//
//						szOrderID.Empty();
//						szOldDoc = szNewDoc;
//						nIndex++;
//					}
//
//					if (!szOrderID.IsEmpty())
//						szOrderID += _T(",");
//					szOrderID.AppendFormat(_T("%ld"), str2long(rs.GetValue(_T("orderid"))));
//					
//					rs.MoveNext();
//				}
//
//				if (!szOrderID.IsEmpty())
//				{
//					szSQL.Format(_T(" SELECT mp_product_id as id,") \
//										_T("        mp_name as drugname,") \
//										_T("        sum(hpol_qtyissue) as qty") \
//										_T(" FROM hms_ipharmaorder") \
//										_T(" LEFT JOIN hms_ipharmaorderline ON(hpo_orderid=hpol_orderid)") \
//										_T(" LEFT JOIN m_product ON(mp_product_id=hpol_product_id)") \
//										_T(" LEFT JOIN m_product_item ON(mpi_product_item_id=hpol_product_item_id)") \
//										_T(" LEFT JOIN ad_uom ON(adu_uom_id=mp_product_uom_id)") \
//										_T(" WHERE hpo_orderid IN(%s) AND mp_org_id IN(%s)") \
//										_T(" GROUP BY mp_product_id, mp_name") \
//										_T(" ORDER BY drugname, id"),
//										szOrderID, szOrgIDs);
//
//					rsl.ExecSQL(szSQL);
//					//double nTotalAmount = 0;
//					while (!rsl.IsEOF())
//					{
//						rsl.GetValue(_T("id"), tmpStr);
//						for (int l = nCount * m_nMaxCol; l < nMaxVal; l++)
//						{
//							colInfo = m_arrItem[l];
//							if (colInfo.szItemID == tmpStr)
//							{
//								szTemp.Format(_T("%d"), colInfo.nIndex);
//								rsl.GetValue(_T("qty"), nQty);
//								tmpStr.Format(_T("%d"), nQty);
//								rptDetail->SetValue(szTemp, tmpStr);
//								break;
//							}
//						}
//						rsl.MoveNext();
//					}
//				}
//
//				bCheck = false;
//				nCount++;
//			}
//
//			rpt.PrintPreview();
//
//		}
//	}
//}


typedef struct tagDrugItemData {
	long product_id;
	CString product_name;
	CString product_uomname;
	float	qty[365 + 1];
	float	ttlqty;
	int		qtywarning;
	int		page;
	int		col_filter;
	CString	is_buyinstall;

}DrugItemData;

void CPrintForms::PM_PrintDailyMaterialAndDrugsOfPatient(long nDocumentNo, CString szPrintType, CString szTransactionIDS) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReportSection* rptDetail = NULL;
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	CString szTableName, szSQL, szDate, szReportTitle, szSysDate, tmpStr;
	int nBuyInStall = -1;


	CArray<DrugItemData, DrugItemData> items;

	bool bInpatient = true;


	if (bInpatient) {
		szTableName = _T("hms_ipharmaorder");

		szSQL.Format(_T(" SELECT hcr_docno AS docno,") \
			_T("   trim(hp_surname") \
			_T("   ||' '") \
			_T("   ||hp_midname") \
			_T("   ||' '") \
			_T("   ||hp_firstname)                                     AS pname,") \
			_T("   hms_getage( trunc_date(hd_admitdate), hp_birthdate) AS age,") \
			_T("   extract(YEAR FROM hp_birthdate)                     AS yearofbirth,") \
			_T("   sys_sel_getname('sys_sex', hp_sex)                  AS sex,") \
			_T("   hms_getobjectname(hd_object)                        AS object,") \
			_T("   hcr_maindisease                                     AS diagnostic,") \
			_T("   trunc_date(hcr_admitdate)                           AS admitdate,") \
			_T("   trunc_date(hcr_dischargedate)                       AS dischargedate,") \
			_T("   LISTAGG(CAST(GET_DEPARTMENTNAME(htr_deptid) AS VARCHAR2(1024)), ', ') WITHIN GROUP (ORDER BY hcr_admitdate) AS deptname,") \
			_T("   LISTAGG(CAST(hrl_name AS VARCHAR2(1024)), ', ') WITHIN GROUP (ORDER BY hcr_admitdate) AS roomname,") \
			_T("   LISTAGG(CAST(hbl_name AS VARCHAR2(1024)), ', ') WITHIN GROUP (ORDER BY hcr_admitdate) AS bedname") \
			_T(" FROM hms_patient") \
			_T(" LEFT JOIN hms_doc") \
			_T(" ON(hd_patientno=hp_patientno)") \
			_T(" LEFT JOIN hms_clinical_record") \
			_T(" ON(hd_docno=hcr_docno)") \
			_T(" LEFT JOIN hms_treatment_record") \
			_T(" ON(htr_docno=hcr_docno)") \
			_T(" LEFT JOIN hms_bed") \
			_T(" ON(hb_docno  =hcr_docno") \
			_T(" AND hb_deptid=htr_deptid)") \
			_T(" LEFT JOIN hms_roomlist") \
			_T(" ON(hrl_deptid=hb_deptid") \
			_T(" AND hrl_id   =hb_roomid)") \
			_T(" LEFT JOIN hms_bedlist") \
			_T(" ON(hbl_deptid =hb_deptid") \
			_T(" AND hbl_roomid=hb_roomid") \
			_T(" AND hbl_id    =hb_bedid)") \
			_T(" WHERE hd_docno= %ld ") \
			_T(" GROUP BY") \
			_T(" hcr_docno,") \
			_T(" hp_surname,") \
			_T(" hp_midname,") \
			_T(" hp_firstname,") \
			_T(" hd_admitdate,") \
			_T(" hp_birthdate,") \
			_T(" hp_sex,") \
			_T(" hd_object,") \
			_T(" hcr_maindisease,") \
			_T(" hcr_admitdate,") \
			_T(" hcr_dischargedate"), nDocumentNo);
	}
	else {
		//Kham benh

		szSQL.Format(_T(" SELECT hcr_docno as docno,") \
			_T("    trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
			_T("    hms_getage( trunc_date(hd_admitdate), hp_birthdate) as age,") \
			_T(" 	extract(year from hp_birthdate) as yearofbirth,") \
			_T("    sys_sel_getname('sys_sex', hp_sex) as sex,") \
			_T("	hms_getobjectname(hd_object)                       AS object, ") \
			_T("    hd_diagnostic as diagnostic,") \
			_T("    trunc_date(hd_admitdate) as admitdate,") \
			_T("    trunc_date(hd_enddate) as dischargedate,") \
			_T("    hd_deptid,") \
			_T("    hb_roomid,") \
			_T("    hb_bedid,") \
			_T("    GET_DEPARTMENTNAME(hd_deptid) as deptname,") \
			_T("    '' as roomname,") \
			_T("    '' as bedname") \
			_T(" FROM hms_patient") \
			_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno)") \
			_T(" WHERE hd_docno=%ld"), nDocumentNo);
		szTableName = _T("hms_pharmaorder");

	}

	rs.ExecSQL(szSQL);

	CString szName, szFromDate, szToDate, szMinDate, szMaxDate;
	CDate dte;

	//Print Detail
	int nItem = 1;
	long nProduct_ID;
	CRecord rsc(&pMF->m_db);
	CString szWhere;

	if (!szTransactionIDS.IsEmpty())
		szWhere.AppendFormat(_T(" and hpo_transaction_id in(%s) and hpo_orderstatus IN('O', 'A','S')  "), szTransactionIDS);
	else
		szWhere.AppendFormat(_T(" and hpo_orderstatus in('A','S') "));
	if (!szPrintType.IsEmpty()) {
		if (szPrintType == _T("GL")) szWhere.AppendFormat(_T(" and msl_org_id in('GL','PM','MA')  "), szPrintType);
		else szWhere.AppendFormat(_T(" and msl_org_id IN ('GL', '%s') "), szPrintType);

	}
	//if(szPrintType.IsEmpty())
	//	szWhere.Empty();

	szSQL.Format(_T("SELECT trunc_date(min(hpo_orderdate)) as min_orderdate, trunc_date(max(hpo_orderdate)) max_orderdate ") \
		_T(" from hms_ipharmaorder ") \
		_T(" left join m_storagelist on(msl_storage_id=hpo_storage_id) ") \
		_T(" where hpo_docno=%ld and hpo_orderstatus in('O', 'A','S') ") \
		_T(" %s "), nDocumentNo, szWhere);
	rsl.ExecSQL(szSQL);
	rsl.GetValue(_T("min_orderdate"), tmpStr);
	szMinDate = tmpStr.Left(10);
	rsl.GetValue(_T("max_orderdate"), tmpStr);
	szMaxDate = tmpStr.Left(10);
	int n = CompareDate(szMaxDate, szMinDate);

	if (!szPrintType.IsEmpty() && n > 29) {
		szSQL.Format(_T("SELECT TO_DATE('%s','YYYY-MM-DD')-29 as min_date FROM DUAL"), szMaxDate);
		rsl.ExecSQL(szSQL);
		rsl.GetValue(_T("min_date"), tmpStr);
		szMinDate = tmpStr.Left(10);
	}

	szFromDate = szMinDate;
	dte.ParseDate(szFromDate);
	rptDetail = NULL;
	szWhere.Empty();
	if (!szTransactionIDS.IsEmpty())
		szWhere.AppendFormat(_T(" and hpo_transaction_id in(%s) and hpo_orderstatus IN('O', 'A','S')  "), szTransactionIDS);
	else
		szWhere.AppendFormat(_T(" and hpo_orderstatus in('A','S') "));


	if (!szPrintType.IsEmpty())
	{
		if (szPrintType == _T("GL"))
			szWhere.AppendFormat(_T(" and product_org_id in('GL','PM','MA')  "), szPrintType);
		else
			szWhere.AppendFormat(_T(" and product_org_id='%s' "), szPrintType);
		szWhere.AppendFormat(_T(" and trunc(hpo_orderdate) between to_date('%s', 'yyyy/mm/dd hh24:mi:ss')-30 and to_date('%s', 'yyyy/mm/dd hh24:mi:ss') "), szMaxDate, szMaxDate);

	}
	//_msg(_T("%s"), szPrintType);
	//if(szPrintType.IsEmpty())
	//	szWhere.Empty();
	szSQL.Format(_T(" SELECT is_buyinstall, product_name,") \
		_T("   product_uomname,") \
		_T("   product_id,") \
		_T("   product_qtywarning, ") \
		_T("   SUM(qtyissue) AS qtyissue") \
		_T(" FROM (") \
		_T(" SELECT CASE WHEN NVL(msl_category, 'X') = 'S' AND ho_type = 'I' THEN 0 ELSE 1 END is_buyinstall,") \
		_T("   product_name,") \
		_T("   product_uomname,") \
		_T("   product_id,") \
		_T("   product_qtywarning, ") \
		_T("   product_uomindex,") \
		_T("   (hpol_qtyissue) AS qtyissue") \
		_T(" FROM hms_ipharmaorder") \
		_T(" LEFT JOIN hms_ipharmaorderline ON(hpol_docno=hpo_docno and hpol_orderid=hpo_orderid)") \
		_T(" LEFT JOIN m_productitem_view ON(hpol_product_item_id=product_item_id)") \
		_T(" LEFT JOIN m_storagelist ON (msl_storage_id = hpo_storage_id)") \
		_T(" LEFT JOIN hms_object ON (hpo_object_id = ho_id)") \
		_T(" WHERE hpo_docno        =%ld  ") \
		_T(" %s ") \
		_T(" AND hpo_ordertype <>'M'") \
		_T(" AND hpol_qtyissue  > 0) tbl") \
		_T(" GROUP BY is_buyinstall, ") \
		_T("   product_name,") \
		_T("   product_uomname,") \
		_T("   product_id,") \
		_T("   product_uomindex, product_qtywarning ") \
		_T(" ORDER BY ") \
		_T("   product_uomindex, product_name, is_buyinstall "), nDocumentNo, szWhere);



	items.RemoveAll();
	rsl.ExecSQL(szSQL);

	int nMaxPage = 0;
	while (!rsl.IsEOF()) {
		DrugItemData dta;
		dta.page = 1;
		rsl.GetValue(_T("is_buyinstall"), nBuyInStall);

		if (nBuyInStall == 0) dta.is_buyinstall = _T("Y");
		else dta.is_buyinstall = _T("N");
		rsl.GetValue(_T("product_id"), dta.product_id);
		rsl.GetValue(_T("product_name"), dta.product_name);
		rsl.GetValue(_T("product_uomname"), dta.product_uomname);
		rsl.GetValue(_T("product_qtywarning"), dta.qtywarning);
		nProduct_ID = dta.product_id;
		_tprintf(_T("\nproduct_id : %ld, buyinstall: %d"), nProduct_ID, nBuyInStall);
		for (int i = 0; i <= 365; i++) {
			dta.qty[i] = 0;
			dta.ttlqty = 0;
		}
		szSQL.Format(_T(" SELECT is_buyinstall,") \
			_T("   trunc_date(orderdate) as orderdate,") \
			_T("   SUM(qtyissue) AS qtyissue") \
			_T(" FROM (") \
			_T(" SELECT CASE WHEN NVL(msl_category, 'X') = 'S' AND ho_type = 'I' THEN 0 ELSE 1 END is_buyinstall,") \
			_T("   trunc_date(hpo_orderdate) as orderdate,") \
			_T("   (hpol_qtyissue) AS qtyissue") \
			_T(" FROM hms_ipharmaorder") \
			_T(" LEFT JOIN hms_ipharmaorderline ON(hpol_docno=hpo_docno and hpol_orderid=hpo_orderid)") \
			_T(" LEFT JOIN m_productitem_view ON(hpol_product_item_id=product_item_id)") \
			_T(" LEFT JOIN m_storagelist ON (msl_storage_id = hpo_storage_id)") \
			_T(" LEFT JOIN hms_object ON (hpo_object_id = ho_id)") \
			_T(" WHERE hpo_docno        =%ld  ") \
			_T(" and product_id=%ld ") \
			_T(" %s ") \
			_T(" AND hpo_ordertype <>'M'") \
			_T(" AND hpol_qtyissue  > 0) tbl") \
			_T(" WHERE is_buyinstall = %d") \
			_T(" GROUP BY orderdate, is_buyinstall") \
			_T(" ORDER BY orderdate, is_buyinstall "), nDocumentNo, nProduct_ID, szWhere, nBuyInStall);

		rsc.ExecSQL(szSQL);
		//_tprintf(_T("\nProduct Name :%s"), dta.product_name);
		while (!rsc.IsEOF()) {
			rsc.GetValue(_T("orderdate"), szDate);
			//_tprintf(_T("szDate before: %s"), szDate);
			szDate.Replace(_T("-"), _T("/"));
			//_tprintf(_T("szDate after: %s"), szDate);
			dte.ParseDate(szMinDate);
			for (int i = 0; i <= 365; i++) {
				tmpStr = dte.GetDate();
				dte++;
				//_tprintf(_T("\ntmpStr: %s|szDate: %s"), tmpStr, szDate);
				if (tmpStr == szDate.Left(10)) {
					rsc.GetValue(_T("qtyissue"), tmpStr);
					dta.qty[i] = str2float(tmpStr);
					dta.ttlqty += dta.qty[i];
					if (dta.qty[i] > 0) dta.page = (int)floor(i / 15.0);
					else dta.page = 0;
					nMaxPage = max(nMaxPage, dta.page);
					break;
				}
			}
			rsc.MoveNext();
		}

		items.Add(dta);
		rsl.MoveNext();
	}

	int nLast = 0;
	dte.ParseDate(szMinDate);



	for (int nPage = 0; nPage <= nMaxPage; nPage++) {
		nItem = 1;

		CReport rpt;

		if (!rpt.Init(_T("Reports/HMS/TM_NHATTRINHVACONGKHAITHUOC.RPT"), true)) return;
		//Print Report Header
		rptDetail = rpt.GetPageHeader();
		rptDetail->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
		rptDetail->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
		rptDetail->SetValue(_T("ReportTitle"), szReportTitle);
		rs.GetValue(_T("deptname"), tmpStr);
		rptDetail->SetValue(_T("DEPARTMENT"), tmpStr);
		//Print page header
		rs.GetValue(_T("pname"), tmpStr);
		rptDetail->SetValue(_T("PatientName"), tmpStr);

		rs.GetValue(_T("age"), tmpStr);
		rptDetail->SetValue(_T("Age"), tmpStr);

		rs.GetValue(_T("sex"), tmpStr);
		rptDetail->SetValue(_T("Sex"), tmpStr);

		rs.GetValue(_T("bedname"), tmpStr);
		rptDetail->SetValue(_T("Bednumber"), tmpStr);

		rs.GetValue(_T("roomname"), tmpStr);
		rptDetail->SetValue(_T("Room"), tmpStr);

		rptDetail->SetValue(_T("object"), rs.GetValue(_T("object")));
		rptDetail->SetValue(_T("yearofbirth"), rs.GetValue(_T("yearofbirth")));

		tmpStr = CDate::Convert(rs.GetValue(_T("Admitdate")), yyyymmdd, ddmmyyyy);
		rptDetail->SetValue(_T("AdmitDate"), tmpStr);

		rs.GetValue(_T("diagnostic"), tmpStr);
		rptDetail->SetValue(_T("Diagnostic"), tmpStr);

		tmpStr = CDate::Convert(rs.GetValue(_T("Dischargedate")), yyyymmdd, ddmmyyyy);
		rptDetail->SetValue(_T("DischargeDate"), tmpStr);
		rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
		for (int i = 0; i < 15; i++) {
			tmpStr = dte.GetDate(ddmmyyyy);
			szName.Format(_T("l%d"), i + 1);
			rptDetail->SetValue(szName, tmpStr.Left(5));
			dte++;
		}

		bool bFound = false;
		for (int itemIndex = 0; itemIndex < items.GetCount(); itemIndex++) {
			float ttlqty = 0;
			DrugItemData dta = items[itemIndex];
			//	if(dta.page > nPage)
			//		continue;

			nLast = 0;
			for (int dayIndex = 365; dayIndex >= 0; dayIndex--) {
				if (dta.qty[dayIndex] > 0) {
					nLast = dayIndex;
					break;
				}
			}

			for (int columnIndex = 0; columnIndex < 15; columnIndex++)
				ttlqty += dta.qty[nPage * 15 + columnIndex];

			if (ttlqty > 0) {
				int x = 0;
				dta.col_filter = 0;
				//if (dta.qtywarning > 0 )
				{
					for (int k = 0; k < nLast; k++) {
						if (dta.qty[k] <= 0) {
							dta.col_filter = 0;
							x = 0;
						}
						else if (dta.qty[k] > 0) x++;
						if (x >= dta.qtywarning) {
							dta.col_filter = k;
							x = 0;
							break;
						}
					}
				}
				rptDetail = rpt.AddDetail();
				bFound = true;
				tmpStr.Format(_T("%d"), nItem++);
				rptDetail->SetValue(_T("Index"), tmpStr);
				rptDetail->SetValue(_T("DrugName"), dta.product_name);
				rptDetail->SetValue(_T("Unit"), dta.product_uomname);
				for (int columnIndex = 0; columnIndex < 15; columnIndex++) {
					tmpStr.Format(_T("%.2f"), dta.qty[nPage * 15 + columnIndex]);
					szName.Format(_T("%d"), columnIndex + 1);
					rptDetail->SetValue(szName, tmpStr);
					CReportItem* obj = rptDetail->GetItem(szName);
					if (obj)
						if (dta.is_buyinstall == _T("Y")) obj->SetItalic(true);
					if (nPage * 15 + columnIndex > dta.col_filter && dta.col_filter > 0)
						obj->SetBkColor(RGB(200, 200, 200));
				}
				if (nLast >= nPage * 15 && nLast <= nPage * 15 + 15) {
					tmpStr.Format(_T("%.2f"), dta.ttlqty);
					rptDetail->SetValue(_T("32"), tmpStr);
				}
			}
		}

		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
		szSysDate = pMF->GetSysDate();
		szDate.Format(rptDetail->GetValue(_T("PrintDate")), szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
		rptDetail->SetValue(_T("PrintDate"), szDate);

		if (bFound) rpt.PrintPreview();
	}
}

//#include "Print/PM_PrintDailyMaterialAndDrugsOfPatient_revised.h"
void CPrintForms::PM_PrintDailyMaterialAndDrugsOfPatient_revised(long nDocumentNo, CString szPrintType, CString szTransactionIDS) {
	//CPM_PrintDailyMaterialAndDrugsOfPatient_revised printer;
	//printer.OnPrint(nDocumentNo, szPrintType, szTransactionIDS);
	//return;
	//CMainFrame_E10 *pMF = (CMainFrame_E10*) AfxGetMainWnd();
	//CRecord rs(&pMF->m_db);
	//CString szSQL;
	//ItemLog item_log;
	//CArray<ItemLog, ItemLog> arr_Item_Log;

}

void CPrintForms::FM_PrintCollectDetailbyItem(long nCashID) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szSysDate;

	int nIdx = 0;

	double nTemp = 0;
	double nGrpTimes = 0, nGrpExam = 0, nGrpIn = 0, nGrpAmount = 0;
	double nTotalExam = 0, nTotalIn = 0, nTotalAmount = 0;
	szSQL.Format(_T("SELECT min(hfe_date) fromdate, max(hfe_date) todate FROM hms_fee_invoice WHERE hfe_cash_id = %ld"), nCashID);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rs.GetValue(_T("fromdate"), m_szFromDate);
		rs.GetValue(_T("todate"), m_szToDate);
	}
	szSQL.Format(_T(" SELECT    hfe_depttype depttype, ") \
		_T("           hfe_deptid deptid, ") \
		_T("           hfg_index                     AS idx, ") \
		_T("           sd_name                       AS deptname, ") \
		_T("           hfe_desc itemname, ") \
		_T("           SUM(count_patient)            AS total, ") \
		_T("           SUM(exam_fee)                 AS exam_fee, ") \
		_T("           SUM(inpatient_fee)            AS inpatient_fee, ") \
		_T("           SUM(exam_fee + inpatient_fee) AS total_amount ") \
		_T(" FROM      (SELECT    f.hfe_docno, ") \
		_T("                      f.hfe_itemid, ") \
		_T("                      f.hfe_desc, ") \
		_T("                      CASE WHEN f.hfe_deptid IN( 'C1.1', 'C1.2', 'C1.3' ) THEN Cast('KB' AS NVARCHAR2(7)) ") \
		_T("                        WHEN f.hfe_group = 'F0000' THEN Cast('XX' AS NVARCHAR2(7)) ") \
		_T("                        WHEN f.hfe_deptid IN( 'KD' ) THEN Cast('KD' AS NVARCHAR2(7)) ") \
		_T("                        WHEN f.hfe_deptid IN( 'C10' ) THEN Cast('KTB' AS NVARCHAR2(7)) ") \
		_T("                      ELSE Cast('DT' AS NVARCHAR2(7)) ") \
		_T("                      END AS hfe_depttype, ") \
		_T("                      f.hfe_deptid, ") \
		_T("                      f.hfe_class, ") \
		_T("                      f.hfe_type, ") \
		_T("                      f.hfe_group, ") \
		_T("                      CASE WHEN i.hfe_class IN( 'E', 'X' ) THEN f.hfe_patpaid ") \
		_T("                      ELSE 0 ") \
		_T("                      END AS exam_fee, ") \
		_T("                      CASE WHEN i.hfe_class NOT IN( 'E', 'X' ) THEN f.hfe_patpaid ") \
		_T("                      ELSE 0 ") \
		_T("                      END AS inpatient_fee, ") \
		_T("                      CASE WHEN f.hfe_group = 'C0000' THEN f.hfe_quantity ") \
		_T("                      ELSE 1 ") \
		_T("                      END AS count_patient ") \
		_T("            FROM      hms_fee_invoice i ") \
		_T("            LEFT JOIN (SELECT    hfe_invoiceno, ") \
		_T("                                 hfe_docno, ") \
		_T("                                 hfe_class, ") \
		_T("                                 hfe_type, ") \
		_T("                                 hfe_group, ") \
		_T("                                 CASE WHEN hfe_type IN ('P', 'T') THEN hfl_deptid ") \
		_T("								 ELSE CASE WHEN hfe_type = 'O' THEN ho_pdeptid ELSE hfe_deptid ") \
		_T("                                 END END hfe_deptid, ") \
		_T("                                 hfe_itemid, ") \
		_T("                                 CASE WHEN he_deptid = 'C1.1' AND hfe_type = 'E' AND he_roomid IN (50, 54) ") \
		_T("								 THEN hfe_desc||'-'||(select hrl_name from hms_roomlist where hrl_deptid = 'C1.1' and hrl_id = he_roomid) ELSE hfe_desc END hfe_desc, ") \
		_T("                                 hfe_quantity, ") \
		_T("                                 hfe_patpaid ") \
		_T("                       FROM      hms_fee ") \
		_T("					   LEFT JOIN hms_operation ON (hfe_type = 'O' AND hfe_docno = ho_docno AND hfe_orderid = ho_idx)") \
		_T("                       LEFT JOIN hms_fee_list ON( hfl_feeid = hfe_itemid ) ") \
		_T("					   LEFT JOIN hms_exam ON (he_docno = hfe_docno AND he_receptidx = hfe_orderid)") \
		_T("                       WHERE     hfe_status IN ('P', 'R') AND hfe_type IN( 'E', 'V', 'O', 'P', ") \
		_T("                                              'T', 'X', 'F' ) ") \
		_T("                       UNION ALL ") \
		_T("                       SELECT hfe_invoiceno, ") \
		_T("                              hfe_docno, ") \
		_T("                              hfe_class, ") \
		_T("                              hfe_type, ") \
		_T("                              hfe_group, ") \
		_T("                              hfe_deptid, ") \
		_T("                              hfe_itemid, ") \
		_T("                              hfe_desc, ") \
		_T("                              hfe_quantity, ") \
		_T("                              hfe_patpaid ") \
		_T("                       FROM   hms_fee ") \
		_T("                       WHERE  hfe_type IN( 'B', 'J' ) ") \
		_T("                       UNION ALL ") \
		_T("                       SELECT    hfe_invoiceno, ") \
		_T("                                 hfe_docno, ") \
		_T("                                 hfe_class, ") \
		_T("                                 hfe_type, ") \
		_T("                                 hfe_group, ") \
		_T("                                 CASE WHEN mp_org_id = 'PM' THEN Cast('KD' AS NVARCHAR2(7)) ") \
		_T("                                   WHEN mp_org_id = 'MA' THEN Cast('C10' AS NVARCHAR2(7)) ") \
		_T("                                 ELSE hfe_deptid ") \
		_T("                                 END AS hfe_deptid, ") \
		_T("                                 hfe_itemid, ") \
		_T("                                 hfe_desc, ") \
		_T("                                 hfe_quantity, ") \
		_T("                                 hfe_patpaid ") \
		_T("                       FROM      hms_fee ") \
		_T("                       LEFT JOIN hms_pharmaretailorder_view ON( hfe_docno = hpo_docno ") \
		_T("                                                      AND hfe_orderid = hpo_orderid ) ") \
		_T("                       LEFT JOIN m_product_item ON( Cast(mpi_product_item_id AS NVARCHAR2(15)) = hfe_itemid ) ") \
		_T("                       LEFT JOIN m_product ON( mp_product_id = mpi_product_id ) ") \
		_T("                       WHERE     hfe_status IN ('P', 'R') AND hfe_type IN( 'R', 'D', 'M' ) AND hpo_orderid > 0) f ON( f.hfe_docno = i.hfe_docno ") \
		_T("                                                                     AND f.hfe_invoiceno = i.hfe_invoiceno ) ") \
		_T("            WHERE hfe_cash_id = %ld ") \
		_T("			AND f.hfe_patpaid > 0 AND hfe_payment > 0") \
		_T("                  AND i.hfe_status = 'P') tbl ") \
		_T(" LEFT JOIN hms_fee_group ON( hfg_id = tbl.hfe_group ) ") \
		_T(" LEFT JOIN sys_dept ON( sd_id = hfe_deptid ) ") \
		_T(" GROUP     BY hfe_depttype, ") \
		_T("              hfe_deptid, ") \
		_T("              hfg_index, ") \
		_T("              sd_name, ") \
		_T("              hfe_desc ") \
		_T(" ORDER     BY hfe_depttype, ") \
		_T("              hfe_deptid, ") \
		_T("              hfg_index, ") \
		_T("              hfe_desc "), nCashID);

	int nCount = rs.ExecSQL(szSQL);

	if (nCount <= 0)
	{
		ShowMessage(150, MB_ICONSTOP);
		return;
	}

	if (!rpt.Init(_T("Reports/HMS/HF_CHITIETTHUTIENTHEODANHMUC.RPT")))
		return;

	rpt.GetReportHeader()->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), pMF->m_szHospitalName);

	tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("ReportDate")),
		CDateTime::Convert(m_szFromDate, yyyymmdd | hhmm, ddmmyyyy | hhmm),
		CDateTime::Convert(m_szToDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));

	rpt.GetReportHeader()->SetValue(_T("ReportDate"), tmpStr);
	CReportSection* rptDetail;
	CReportSection* rptSector;
	CString szOldFeeGrp, szNewFeeGrp;

	while (!rs.IsEOF())
	{
		rs.GetValue(_T("deptid"), szNewFeeGrp);
		if (szNewFeeGrp != szOldFeeGrp)
		{
			if (nGrpTimes > 0)
			{
				rptSector = rpt.AddDetail(rpt.GetGroupFooter(1));
				FormatCurrency(nGrpTimes, tmpStr);
				rptSector->SetValue(_T("s3"), tmpStr);
				FormatCurrency(nGrpExam, tmpStr);
				rptSector->SetValue(_T("s4"), tmpStr);
				FormatCurrency(nGrpIn, tmpStr);
				rptSector->SetValue(_T("s5"), tmpStr);
				FormatCurrency(nGrpAmount, tmpStr);
				rptSector->SetValue(_T("s6"), tmpStr);
			}
			nIdx++;

			if (szNewFeeGrp != _T("X") && szNewFeeGrp != _T("NA"))
				tmpStr.Format(_T("%d. %s"), nIdx, rs.GetValue(_T("deptname")));
			else if (szNewFeeGrp == _T("X"))
				tmpStr.Format(_T("%d. Thu ph\xED kh\xE1\x63"), nIdx);
			else if (szNewFeeGrp == _T("NA"))
				tmpStr.Format(_T("%d. \x43h\x1B0\x61 thi\x1EBFt l\x1EADp kho\x61 th\x1EF1\x63 hi\x1EC7n"), nIdx);

			rptSector = rpt.AddDetail(rpt.GetGroupHeader(0));
			rptSector->SetValue(_T("GroupName"), tmpStr);
			szOldFeeGrp = szNewFeeGrp;
			nGrpTimes = 0;
			nTotalExam += nGrpExam;
			nGrpExam = 0;
			nTotalIn += nGrpIn;
			nGrpIn = 0;
			nTotalAmount += nGrpAmount;
			nGrpAmount = 0;
		}
		rptDetail = rpt.AddDetail();

		rs.GetValue(_T("itemname"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);

		rs.GetValue(_T("total"), nTemp);
		//FormatCurrency(nTemp, tmpStr);
		tmpStr.Format(_T("%.0f"), nTemp);
		rptDetail->SetValue(_T("3"), tmpStr);
		nGrpTimes += nTemp;

		rs.GetValue(_T("exam_fee"), nTemp);
		FormatCurrency(nTemp, tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		nGrpExam += nTemp;

		rs.GetValue(_T("inpatient_fee"), nTemp);
		FormatCurrency(nTemp, tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		nGrpIn += nTemp;

		rs.GetValue(_T("total_amount"), nTemp);
		FormatCurrency(nTemp, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		nGrpAmount += nTemp;

		rs.MoveNext();
	}
	if (nGrpTimes > 0)
	{
		rptSector = rpt.AddDetail(rpt.GetGroupFooter(1));
		FormatCurrency(nGrpTimes, tmpStr);
		rptSector->SetValue(_T("s3"), tmpStr);
		FormatCurrency(nGrpExam, tmpStr);
		rptSector->SetValue(_T("s4"), tmpStr);
		FormatCurrency(nGrpIn, tmpStr);
		rptSector->SetValue(_T("s5"), tmpStr);
		FormatCurrency(nGrpAmount, tmpStr);
		rptSector->SetValue(_T("s6"), tmpStr);

		//Vertical total
		nTotalExam += nGrpExam;
		nTotalIn += nGrpIn;
		nTotalAmount += nGrpAmount;
	}

	FormatCurrency(nTotalExam, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("t4"), tmpStr);
	FormatCurrency(nTotalIn, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("t5"), tmpStr);
	FormatCurrency(nTotalAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("t6"), tmpStr);
	szSysDate = pMF->GetSysDate();

	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::FM_PrintCollectDetailbyItem_(long nCashID) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL;
	double nTmp = 0;
	int nIdx = 1, j = 0;
	CString szSQL, tmpStr, szReportName, szDate, szPos, szOldLev1, szNewLev1, szWhere;
	CStringArray data_name;
	double nTotal[4], GrandAmt[4], nTotalClass[4];
	for (int i = 0; i < 4; i++)
	{
		GrandAmt[i] = 0;
		nTotalClass[i] = 0;
		nTotal[i] = 0;
	}
	szReportName = _T("Reports\\HMS\\HF_CHITIETTHUTIENTHEODANHMUC_MAU2.RPT");
	if (!rpt.Init(szReportName))
		return;

	szWhere.Format(_T(" and hfe_cash_id in(%d) "), nCashID);

	szSQL.Format(_T(" SELECT    dept_id, ") \
		_T("           descr, ") \
		_T("           SUM(times) times, ") \
		_T("           SUM(e_amount) e_amount, ") \
		_T("           SUM(i_amount) i_amount, ") \
		_T("           SUM(amount) total_amount ") \
		_T(" FROM      fa_cash INNER JOIN (SELECT    hfe_cash_id, hfe_class,") \
		_T("                      CASE WHEN ( fee_type = 'E' AND Nvl(hd_outpatient, 'N') = 'Y' )  OR i.hfe_type = 'O' THEN i.hfe_deptid ELSE dept_id END ") \
		_T("						dept_id, ") \
		_T("					  NVL(hfg_type_id, 2000) hfe_typeindex, substr(hfe_group, 1, 3) hfe_group3,") \
		_T("                      Decode('O', i.hfe_type, 'Other fee in dept', descr) descr, ") \
		_T("                      Decode('O', i.hfe_type, 1, times) times, ") \
		_T("                      Decode('I', i.hfe_class, Decode('O', i.hfe_type, hfe_amount, amount), 0) i_amount, ") \
		_T("                      Decode('I', i.hfe_class, 0, Decode('O', i.hfe_type, hfe_amount, amount)) e_amount, ") \
		_T("                      Decode('O', i.hfe_type, hfe_amount, amount) amount ") \
		_T("            FROM      hms_fee_invoice_view_v2 i ") \
		_T("            LEFT JOIN hms_doc ON ( i.hfe_docno = hd_docno ) ") \
		_T("            INNER JOIN (SELECT    hfe_invoiceno, ") \
		_T("                                 hfe_docno, ") \
		_T("                                 CASE WHEN he_roomid IN ( 50, 54 ) THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3)) ELSE hfe_deptid END ") \
		_T("									dept_id, ") \
		_T("								 f.hfe_group,") \
		_T("                                 hfe_type fee_type, ") \
		_T("                                 hfe_desc descr, ") \
		_T("								 CAST('N' AS NVARCHAR2(1)) hitech_machine,") \
		_T("                                 hfe_quantity times, ") \
		_T("                                 hfe_cost amount ") \
		_T("                       FROM      hms_fee f ") \
		_T("                       LEFT JOIN hms_exam ON ( hfe_docno = he_docno AND hfe_orderid = he_receptidx ) ") \
		_T("                       LEFT JOIN hms_roomlist ON ( hrl_deptid = he_deptid AND hrl_id = he_roomid ) ") \
		_T("                       WHERE     hfe_type = 'E' AND hfe_status IN ( 'P', 'R' ) AND Nvl(hfe_category, 'N') NOT IN ( 'Y', 'BQP', 'BBV' ) ") \
		_T("                       UNION ALL ") \
		_T("                       SELECT    hfe_invoiceno, ") \
		_T("                                 hfe_docno, ") \
		_T("                                 CASE WHEN hfe_type IN ( 'P', 'T' ) THEN hfl_deptid ELSE CASE Cast(hfe_type AS VARCHAR2(15)) WHEN Cast('O' AS VARCHAR2(15)) THEN Decode ('B5', HO_PDEPTID, ho_deptid, ho_pdeptid) ELSE hfe_deptid END END ") \
		_T("									dept_id, ") \
		_T("								 f.hfe_group,") \
		_T("                                 hfe_type fee_type, ") \
		_T("                                 hfe_desc descr, ") \
		_T("								 NVL(hfl_hitechmachine, 'N') hitech_machine,") \
		_T("                                 hfe_quantity times, ") \
		_T("                                 hfe_cost amount ") \
		_T("                       FROM      hms_fee f ") \
		_T("                       LEFT JOIN hms_operation ON ( hfe_docno = ho_docno AND hfe_orderid = ho_idx ) ") \
		_T("                       LEFT JOIN hms_fee_list ON ( hfl_feeid = hfe_itemid ) ") \
		_T("                       WHERE     hfe_status IN ( 'P', 'R' ) AND hfe_type IN ( 'O', 'P', 'T', 'B', ") \
		_T("                                                   'J', 'F', 'X' ) AND Nvl(hfe_category, 'N') NOT IN ( 'Y', 'BQP', 'BBV' )") \
		_T("                       UNION ALL ") \
		_T("                       SELECT    hfe_invoiceno, ") \
		_T("                                 hfe_docno, ") \
		_T("                                 Cast(CASE Cast(mp_org_id AS VARCHAR2(15)) WHEN 'PM' THEN 'KD' ") \
		_T("                                        WHEN 'MA' THEN 'C10' ") \
		_T("                                        WHEN 'BB' THEN 'C16' ") \
		_T("                                      END AS NVARCHAR2(15)) dept_id, ") \
		_T("								 f.hfe_group,") \
		_T("                                 hfe_type fee_type, ") \
		_T("                                 DECODE(mp_org_id, 'PM', NVL(get_vnname('Drug Amount'), 'Drug Amount'), 'MA', NVL(get_vnname('Material Amount'), 'Material Amount'), 'BB', f.hfe_desc) descr, ") \
		_T("								 CAST('N' AS NVARCHAR2(1)) hitech_machine,") \
		_T("                                 hfe_quantity times, ") \
		_T("                                 hfe_cost amount ") \
		_T("                       FROM      hms_fee f ") \
		_T("                       LEFT JOIN m_product_item ON ( Cast(hfe_itemid AS INTEGER) = mpi_product_item_id ) ") \
		_T("                       LEFT JOIN m_product ON ( mpi_product_id = mp_product_id ) ") \
		_T("                       WHERE     hfe_type IN ( 'D', 'M', 'R' ) AND hfe_status IN ( 'P', 'R' ) AND Nvl(hfe_category, 'N') NOT IN ( 'Y', 'BQP', 'BBV' )) tbl_fee ON ( i.hfe_docno = tbl_fee.hfe_docno AND i.hfe_invoiceno = tbl_fee.hfe_invoiceno ) ") \
		_T("			LEFT JOIN hms_fee_group ON (hfg_id = hfe_group)") \
		_T("            WHERE     hfe_cash_id > 0) tbl_invoice ON (fac_cash_id = hfe_cash_id)") \
		_T(" WHERE     amount > 0 %s") \
		_T(" GROUP     BY dept_id, hfe_typeindex, hfe_group3, descr ") \
		_T(" ORDER     BY dept_id, hfe_typeindex, hfe_group3, descr "), szWhere);


	pMF->BeginWaitCursor();
	rs.ExecSQL(szSQL);
	pMF->EndWaitCursor();
	if (rs.IsEOF()) {
		AfxMessageBox(_T("No Data"));
		return;
	}
	_tprintf(_T("\r\n1"));
	data_name.Add(_T("times"));
	data_name.Add(_T("e_amount"));
	data_name.Add(_T("i_amount"));
	data_name.Add(_T("total_amount"));

	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ReportDate"), tmpStr);
	}
	_tprintf(_T("\r\n2"));


	rpt.GetReportHeader()->SetValue(_T("InvoiceNos"), int2str(nCashID));

	CString szOldIndex, szNewIndex;

	int col_pos = 3;
	int sum_pos = (int)(data_name.GetCount()) - 1;

	while (!rs.IsEOF())
	{
		//Group Seperation

		rs.GetValue(_T("dept_id"), szNewLev1);
		if (szOldLev1 != szNewLev1)
		{
			if (GrandAmt[sum_pos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				for (int i = 0; i < data_name.GetCount(); i++)
				{
					tmpStr.Format(_T("%f"), GrandAmt[i]);
					szPos.Format(_T("s%d"), i + col_pos);
					rptGroup->SetValue(szPos, tmpStr);

					GrandAmt[i] = 0;
				}
			}
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(0));
			if (rptGroup)
			{
				tmpStr.Format(_T("Kho\x61 %s"), szNewLev1);
				rptGroup->SetValue(_T("GroupName"), tmpStr);
			}
			szOldLev1 = szNewLev1;
			nIdx = 1;
		}

		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("descr")));

			for (int i = 0; i < data_name.GetCount(); i++)
			{
				tmpStr = data_name[i];

				rs.GetValue(tmpStr, nTmp);
				GrandAmt[i] += nTmp;
				nTotal[i] += nTmp;
				tmpStr.Format(_T("%d"), i + col_pos);
				rptDetail->SetValue(tmpStr, double2str(nTmp));
			}
		}
		rs.MoveNext();
	}
	_tprintf(_T("\r\n3"));
	//if(m_szOrderByKey == _T("04"))
	{
		if (GrandAmt[sum_pos] > 0)
		{
			rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));

			for (int i = 0; i < data_name.GetCount(); i++)
			{
				tmpStr.Format(_T("%f"), GrandAmt[i]);
				szPos.Format(_T("s%d"), i + col_pos);
				rptGroup->SetValue(szPos, tmpStr);
			}
		}
	}

	_tprintf(_T("\r\n4"));
	if (nTotal[sum_pos] > 0)
	{
		for (int i = 0; i < data_name.GetCount(); i++)
		{
			tmpStr.Format(_T("%f"), nTotal[i]);
			szPos.Format(_T("t%d"), i + col_pos);
			rpt.GetReportFooter()->SetValue(szPos, tmpStr);
		}
	}
	_tprintf(_T("\r\n5"));
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.GetReportHeader()->SetValue(_T("ClassName"), _T("CFMCollectDetailByItem_"));

	CString szValue;
	szValue.Format(_T("%.3f"), nTotal[sum_pos]);
	MoneyToString(szValue, tmpStr);
	tmpStr.AppendFormat(_T(" \x111\x1ED3ng."));
	rpt.GetReportFooter()->SetValue(_T("SuminWords"), tmpStr);

	rpt.PrintPreview();
}

void CPrintForms::FM_PrintSpendDetailbyItem(long nCashID)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL;
	double nTmp = 0;
	int nIdx = 1, j = 0;
	CString szSQL, szWhere, tmpStr, szReportName, szDate, szPos, szOldLev1, szNewLev1;
	CStringArray data_name;
	double nTotal[4], GrandAmt[4], nTotalClass[4];
	for (int i = 0; i < 4; i++)
	{
		GrandAmt[i] = 0;
		nTotalClass[i] = 0;
		nTotal[i] = 0;
	}
	szReportName = _T("Reports\\HMS\\HF_CHITIETTHUTIENTHEODANHMUC_MAU3.RPT");
	if (!rpt.Init(szReportName))
		return;
	szWhere.Format(_T(" AND hfe_cash_id = %ld"), nCashID);
	szSQL.Format(_T(" SELECT    dept_id, ") \
		_T("           descr, ") \
		_T("           SUM(times) times, ") \
		_T("           SUM(e_amount) e_amount, ") \
		_T("           SUM(i_amount) i_amount, ") \
		_T("           SUM(amount) total_amount ") \
		_T(" FROM      (SELECT    hfe_cash_id, ") \
		_T("                      CASE WHEN ( fee_type = 'E' AND Nvl(hd_outpatient, 'N') = 'Y' )  OR i.hfe_type = 'O' THEN i.hfe_deptid ELSE dept_id END ") \
		_T("						dept_id, ") \
		_T("					  NVL(hfg_type_id, 2000) hfe_typeindex, substr(tbl_fee.hfe_group, 1, 3) hfe_group3,") \
		_T("                      Decode('O', i.hfe_type, cast('Other fee in dept' as nvarchar2(35)), descr) descr, ") \
		_T("                      Decode('O', i.hfe_type, 1, times) times, ") \
		_T("                      Decode('I', i.hfe_class, Decode('O', i.hfe_type, hfe_amount, amount), 0) i_amount, ") \
		_T("                      Decode('I', i.hfe_class, 0, Decode('O', i.hfe_type, hfe_amount, amount)) e_amount, ") \
		_T("                      Decode('O', i.hfe_type, hfe_amount, amount) amount ") \
		_T("            FROM      hms_fee_refund i ") \
		_T("            LEFT JOIN hms_doc ON ( i.hfe_docno = hd_docno ) ") \
		_T("            INNER JOIN (SELECT    hfe_invoiceno, ") \
		_T("                                 hfe_docno, ") \
		_T("                                 CASE WHEN he_roomid IN ( 50, 54 ) THEN CAST(DECODE(he_roomid, 50, 'C15', 54, 'C6') AS NVARCHAR2(3)) ELSE hfe_deptid END ") \
		_T("									dept_id, ") \
		_T("								 f.hfe_group,") \
		_T("                                 hfe_type fee_type, ") \
		_T("                                 hfe_desc descr, ") \
		_T("								 CAST('N' AS NVARCHAR2(1)) hitech_machine,") \
		_T("                                 hfe_quantity times, ") \
		_T("                                 hfe_cost amount, ") \
		_T("								 (select hfe_cash_id from hms_fee_refundline l, hms_fee_refund r where r.hfe_invoiceno = l.hfe_invoiceno and r.hfe_docno = f.hfe_docno and hfe_fee_refundline_id = f.hfe_fee_id) rcash_id") \
		_T("                       FROM      hms_fee f ") \
		_T("                       LEFT JOIN hms_exam ON ( hfe_docno = he_docno AND hfe_orderid = he_receptidx ) ") \
		_T("                       LEFT JOIN hms_roomlist ON ( hrl_deptid = he_deptid AND hrl_id = he_roomid ) ") \
		_T("                       WHERE     hfe_type = 'E' AND hfe_status IN ('R') AND Nvl(hfe_category, 'N') NOT IN ( 'Y', 'BQP', 'BBV' ) ") \
		_T("                       UNION ALL ") \
		_T("                       SELECT    hfe_invoiceno, ") \
		_T("                                 hfe_docno, ") \
		_T("                                 CASE WHEN hfe_type IN ( 'P', 'T' ) THEN hfl_deptid ELSE CASE Cast(hfe_type AS VARCHAR2(15)) WHEN Cast('O' AS VARCHAR2(15)) THEN Decode ('B5', HO_PDEPTID, ho_deptid, ho_pdeptid) ELSE hfe_deptid END END ") \
		_T("									dept_id, ") \
		_T("								 f.hfe_group,") \
		_T("                                 hfe_type fee_type, ") \
		_T("                                 hfe_desc descr, ") \
		_T("								 NVL(hfl_hitechmachine, 'N') hitech_machine,") \
		_T("                                 hfe_quantity times, ") \
		_T("                                 hfe_cost amount, ") \
		_T("								 (select hfe_cash_id from hms_fee_refundline l, hms_fee_refund r where r.hfe_invoiceno = l.hfe_invoiceno and r.hfe_docno = f.hfe_docno and hfe_fee_refundline_id = f.hfe_fee_id) rcash_id") \
		_T("                       FROM      hms_fee f ") \
		_T("                       LEFT JOIN hms_operation ON ( hfe_docno = ho_docno AND hfe_orderid = ho_idx ) ") \
		_T("                       LEFT JOIN hms_fee_list ON ( hfl_feeid = hfe_itemid ) ") \
		_T("                       WHERE     hfe_status IN ('R' ) AND hfe_type IN ( 'O', 'P', 'T', 'B', ") \
		_T("                                                   'J', 'F', 'X' ) AND Nvl(hfe_category, 'N') NOT IN ( 'Y', 'BQP', 'BBV' )") \
		_T("                       UNION ALL ") \
		_T("                       SELECT    hfe_invoiceno, ") \
		_T("                                 hfe_docno, ") \
		_T("                                 Cast(CASE Cast(mp_org_id AS VARCHAR2(15)) WHEN 'PM' THEN 'KD' ") \
		_T("                                        WHEN 'MA' THEN 'C10' ") \
		_T("                                        WHEN 'BB' THEN 'C16' ") \
		_T("                                      END AS NVARCHAR2(15)) dept_id, ") \
		_T("								 f.hfe_group,") \
		_T("                                 hfe_type fee_type, ") \
		_T("                                 DECODE(mp_org_id, 'PM', NVL(get_vnname('Drug Amount'), 'Drug Amount'), 'MA', NVL(get_vnname('Material Amount'), 'Material Amount'), 'BB', f.hfe_desc) descr, ") \
		_T("								 CAST('N' AS NVARCHAR2(1)) hitech_machine,") \
		_T("                                 hfe_quantity times, ") \
		_T("                                 hfe_cost amount, ") \
		_T("								 (select hfe_cash_id from hms_fee_refundline l, hms_fee_refund r where r.hfe_invoiceno = l.hfe_invoiceno and r.hfe_docno = f.hfe_docno and hfe_fee_refundline_id = f.hfe_fee_id) rcash_id") \
		_T("                       FROM      hms_fee f ") \
		_T("                       LEFT JOIN m_product_item ON ( Cast(hfe_itemid AS INTEGER) = mpi_product_item_id ) ") \
		_T("                       LEFT JOIN m_product ON ( mpi_product_id = mp_product_id ) ") \
		_T("                       WHERE     hfe_type IN ( 'D', 'M', 'R' ) AND hfe_status IN ('R' ) AND Nvl(hfe_category, 'N') NOT IN ( 'Y', 'BQP', 'BBV' )") \
		_T("			) tbl_fee ON ( i.hfe_docno = tbl_fee.hfe_docno AND i.hfe_refidx = tbl_fee.hfe_invoiceno AND i.hfe_cash_id = rcash_id) ") \
		_T("			LEFT JOIN hms_fee_group ON (hfg_id = tbl_fee.hfe_group)") \
		_T("            WHERE     hfe_cash_id > 0 AND (SELECT count(*) FROM hms_fee_refundline WHERE hfe_invoiceno = i.hfe_invoiceno) > 0") \
		_T("			UNION ALL") \
		_T("			SELECT    hfe_cash_id, ") \
		_T("                      Cast(CASE Cast(mp_org_id AS VARCHAR2(15)) WHEN 'PM' THEN 'KD' ") \
		_T("                                        WHEN 'MA' THEN 'C10' ") \
		_T("                                        WHEN 'BB' THEN 'C16' ") \
		_T("                                      END AS NVARCHAR2(15)) dept_id, ") \
		_T("					  NVL(hfg_type_id, 2000) hfe_typeindex, substr(mp_producttype, 1, 3) hfe_group3,") \
		_T("                      DECODE(mp_org_id, 'PM', NVL(get_vnname('Drug Amount'), cast('Drug Amount' as nvarchar2(15))), 'MA', NVL(get_vnname('Material Amount'), cast('Material Amount' as nvarchar2(15))), cast('BB' as nvarchar2(15)), mp_name) descr, ") \
		_T("                      hpol_qtyreturn times, ") \
		_T("                      0 i_amount, ") \
		_T("                      hpol_qtyreturn * hpol_unitprice e_amount, ") \
		_T("                      hpol_qtyreturn * hpol_unitprice amount ") \
		_T("            FROM      hms_fee_refund i ") \
		_T("			INNER JOIN hms_pharmareturnorder r ON (hfe_invoiceno = hpo_invoiceno)") \
		_T("			LEFT JOIN hms_pharmareturnorder_line l ON (r.hpo_pharmareturnorder_id = l.hpol_pharmareturnorder_id)") \
		_T("			LEFT JOIN hms_doc ON(hd_docno = i.hfe_docno)") \
		_T("            LEFT JOIN m_product_item ON ( hpol_product_item_id = mpi_product_item_id ) ") \
		_T("            LEFT JOIN m_product ON ( mpi_product_id = mp_product_id ) ") \
		_T("			LEFT JOIN hms_fee_group ON (hfg_id = mp_producttype)") \
		_T("			WHERE hfe_cash_id > 0 AND hpo_status = 'A'") \
		_T(" ) tbl_invoice ") \
		_T(" WHERE     amount > 0 %s") \
		_T(" GROUP     BY dept_id, hfe_typeindex, hfe_group3, descr ") \
		_T(" ORDER     BY dept_id, hfe_typeindex, hfe_group3, descr "), szWhere);


	pMF->BeginWaitCursor();
	rs.ExecSQL(szSQL);
	pMF->EndWaitCursor();
	if (rs.IsEOF()) {
		AfxMessageBox(_T("No Data"));
		return;
	}
	_tprintf(_T("\r\n1"));
	data_name.Add(_T("times"));
	data_name.Add(_T("e_amount"));
	data_name.Add(_T("i_amount"));
	data_name.Add(_T("total_amount"));

	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ReportDate"), tmpStr);
	}
	_tprintf(_T("\r\n2"));

	tmpStr.Format(_T("%ld"), nCashID);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNos"), tmpStr);

	CString szOldIndex, szNewIndex;

	int col_pos = 3;
	int sum_pos = (int)(data_name.GetCount()) - 1;

	while (!rs.IsEOF())
	{
		//Group Seperation

		rs.GetValue(_T("dept_id"), szNewLev1);
		if (szOldLev1 != szNewLev1)
		{
			if (GrandAmt[sum_pos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				for (int i = 0; i < data_name.GetCount(); i++)
				{
					tmpStr.Format(_T("%f"), GrandAmt[i]);
					szPos.Format(_T("s%d"), i + col_pos);
					rptGroup->SetValue(szPos, tmpStr);

					GrandAmt[i] = 0;
				}
			}
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(0));
			if (rptGroup)
			{
				tmpStr.Format(_T("Kho\x61 %s"), szNewLev1);
				rptGroup->SetValue(_T("GroupName"), tmpStr);
			}
			szOldLev1 = szNewLev1;
			nIdx = 1;
		}

		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("descr")));

			for (int i = 0; i < data_name.GetCount(); i++)
			{
				tmpStr = data_name[i];

				rs.GetValue(tmpStr, nTmp);
				GrandAmt[i] += nTmp;
				nTotal[i] += nTmp;
				tmpStr.Format(_T("%d"), i + col_pos);
				rptDetail->SetValue(tmpStr, double2str(nTmp));
			}
		}
		rs.MoveNext();
	}
	_tprintf(_T("\r\n3"));
	//if(m_szOrderByKey == _T("04"))
	{
		if (GrandAmt[sum_pos] > 0)
		{
			rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));

			for (int i = 0; i < data_name.GetCount(); i++)
			{
				tmpStr.Format(_T("%f"), GrandAmt[i]);
				szPos.Format(_T("s%d"), i + col_pos);
				rptGroup->SetValue(szPos, tmpStr);
			}
		}
	}

	_tprintf(_T("\r\n4"));
	if (nTotal[sum_pos] > 0)
	{
		for (int i = 0; i < data_name.GetCount(); i++)
		{
			tmpStr.Format(_T("%f"), nTotal[i]);
			szPos.Format(_T("t%d"), i + col_pos);
			rpt.GetReportFooter()->SetValue(szPos, tmpStr);
		}
	}
	_tprintf(_T("\r\n5"));
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.GetReportHeader()->SetValue(_T("ClassName"), _T("CFMSpendDetailByItem"));

	CString szValue;
	szValue.Format(_T("%.3f"), nTotal[sum_pos]);
	MoneyToString(szValue, tmpStr);
	tmpStr.AppendFormat(_T(" \x111\x1ED3ng."));
	rpt.GetReportFooter()->SetValue(_T("SuminWords"), tmpStr);

	rpt.PrintPreview();
}

#include "HMSFeeManager.h"
void CPrintForms::FM_PrintDischargePaymentInvoice(long nDocumentNo, long nInvoiceNo)
{

	//_msg(_T("Vào đây Lộc"));
	CHMSFeeManager fm(nDocumentNo);
	fm.PrintDischargePayment(nInvoiceNo);
	return;
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, szObjectType;
	szSQL.Format(_T("select ho_type  as objecttype from hms_fee_invoice left join hms_object on(ho_id=hfe_objectid) where hfe_docno=%ld and hfe_invoiceno=%ld"), nDocumentNo, nInvoiceNo);
	rs.ExecSQL(szSQL);
	rs.GetValue(_T("objecttype"), szObjectType);




	if (szObjectType == _T("I") || szObjectType == _T("C"))
	{
		FM_PrintInsuranceDischargePaymentInvoice(nDocumentNo, nInvoiceNo);
		szSQL.Format(_T("SELECT count(*) FROM hms_fee WHERE hfe_invoiceno=%ld and hfe_docno = %ld and hfe_object=7 "), nInvoiceNo, nDocumentNo);
		rs.ExecSQL(szSQL);
		if (rs.GetIntValue() > 0)
		{
			FM_PrintServiceDischargePaymentInvoice(nDocumentNo, nInvoiceNo);
		}
	}
	else if (szObjectType == _T("D") || szObjectType == _T("P"))
	{
		FM_PrintPolicyDischargePaymentInvoice(nDocumentNo, nInvoiceNo);
		szSQL.Format(_T("SELECT count(*) FROM hms_fee WHERE hfe_invoiceno=%ld and hfe_docno = %ld and hfe_object=7 "), nInvoiceNo, nDocumentNo);
		rs.ExecSQL(szSQL);
		if (rs.GetIntValue() > 0)
		{
			FM_PrintServiceDischargePaymentInvoice(nDocumentNo, nInvoiceNo);
		}

	}
	else if (szObjectType == _T("S"))
	{
		FM_PrintServiceDischargePaymentInvoice(nDocumentNo, nInvoiceNo);
		szSQL.Format(_T("SELECT count(*) FROM hms_fee WHERE hfe_invoiceno=%ld and hfe_docno=%ld and hfe_object<>7 "), nInvoiceNo, nDocumentNo);
		rs.ExecSQL(szSQL);
		if (rs.GetIntValue() > 0)
		{
			FM_PrintInsuranceDischargePaymentInvoice(nDocumentNo, nInvoiceNo);
		}
	}

}

void CPrintForms::FM_PrintServiceDischargePaymentInvoice(long nDocumentNo, long nInvoiceNo)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	//	if (!pMF->IsInPatient())
	//		return;
		//_msg(_T("Chào bạn Lộc"));

	CReport rpt;
	CString tmpStr, szSQL, szWhere, szAdmitDate, szEndDate, szDepartments, szAddonedayoutofhospital, szNumbertreat;
	CRecord rs(&pMF->m_db);
	CRecord rsd(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	int		nDeskNo = 0;
	CString szRecvDate;
	CString	szObjectType;
	CString	szDescription;
	CString szPrintMaterialOperation = _T("Y");
	CString	szOutPatient;


	double	nTotalCost = 0,				//Tong chi phi
		nTotalInsCost = 0,
		nTotalDiscount = 0,			//Tong Mien giam
		nTotalPatPaid = 0,			//Tong benh nhan tra
		nTotalDiffPaid = 0,	//Tong so tra chenh lech
		nTotalPayable = 0,
		nTotalDeposit = 0,			//Tong tam ung
		nTotalFree = 0,				//Tong mien phi
		nTotalRefund = 0,				//Tong hoan tra
		nDepositPayable = 0,			//So tien tra tu tam ung
		nTotalPayment = 0;


	double nSumFoodAmount = 0;


	szWhere.AppendFormat(_T(" and hfe_invoiceno=%ld "), nInvoiceNo);

	szSQL.Format(_T(" SELECT *") \
		_T(" FROM") \
		_T(" (") \
		_T("  SELECT hd_patientno as patientno,") \
		_T("         hd_docno as docno,") \
		_T("         trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T("         hp_birthdate as birthdate,") \
		_T("         hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age,") \
		_T("         extract(year from hp_birthdate) as yearofbirth, ") \
		_T("         Get_Selection_Desc('sys_sex', hp_sex) as sex,") \
		_T("         hp_sex as sex_id,") \
		_T("         hp_ethnic as ethnic,") \
		_T("         Get_Selection_Desc('sys_ethnic', hp_ethnic) as ethnicdesc, ") \
		_T("         nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T("         hms_getaddress(hp_provid,hp_distid, hp_villid) as address,") \
		_T("         hp_workplace as workplace,") \
		_T("         hd_doctor as doctor,") \
		_T("         hd_createdby as createdby,") \
		_T("         hd_icd as icd10,") \
		_T("         hd_diagnostic as diagnostic,") \
		_T("         hd_reldisease as reldisease,") \
		_T("         hd_emergency as emergency, ") \
		_T("         Get_Selection_Desc('hms_result',hd_result) as result,") \
		_T("         hd_admitdate as examdate,") \
		_T("         hd_enddate as enddate,") \
		_T(" hd_outpatient, ") \
		_T("         hcr_recordno as recordno ,") \
		_T("         hcr_admitdate as admitdate,") \
		_T("         hcr_dischargedate as dischargedate,") \
		_T("         hcr_sumtreat as TreatmentDay,") \
		_T("         hcr_mainicd as mainicd ,") \
		_T("         hcr_maindisease as maindisease ,") \
		_T("         hcr_treatdoctor as treatdoctor, ") \
		_T("         hcr_reldisease as ireldisease,") \
		_T("         hcr_suggestion as isuggestion,") \
		_T("         hd_suggestion as esuggestion,") \
		_T("         Get_Selection_Desc('hms_result' ,hcr_result)  as iresult,") \
		_T("         hfe_deptid as deptid,") \
		_T("         hfe_serialno as serialno,") \
		_T("         hfe_receiptno as recvno,") \
		_T("         hfe_date as recvdate, ") \
		_T("         hfe_staff as receiver,") \
		_T("         hfe_desc as reason,") \
		_T("         hfe_amount as cost,") \
		_T("         hfe_discount as discount,") \
		_T("         hfe_patpaid as patpaid,") \
		_T("         hfe_deposit as deposit_amount, ") \
		_T("         hfe_payment as payment_amount,") \
		_T("         hfe_refund as refund_amount, ") \
		_T("         hfe_freeamount as free_amount,") \
		_T("         hfe_eat_amount as food_amount,") \
		_T("         row_number() over (partition by hd_docno order by hd_docno) as dn") \
		_T(" FROM hms_fee_invoice ") \
		_T(" LEFT JOIN hms_doc ON(hd_docno=hfe_docno)") \
		_T(" LEFT JOIN hms_patient ON(hp_patientno=hd_patientno)") \
		_T(" LEFT JOIN hms_clinical_record ON(hcr_docno=hd_docno) ") \
		_T(" LEFT JOIN hms_treatment_record ON(hfe_docno=htr_docno) ") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hfe_docno=%ld and hfe_type<>'E' %s ") \
		_T(" ) Tbl") \
		_T(" WHERE dn=1"), nDocumentNo, szWhere);


	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		return;
	}

	rs.GetValue(_T("cost"), nTotalCost);
	rs.GetValue(_T("discount"), nTotalDiscount);
	rs.GetValue(_T("patpaid"), nTotalPatPaid);
	rs.GetValue(_T("deposit_amount"), nTotalDeposit);
	rs.GetValue(_T("free_amount"), nTotalFree);
	rs.GetValue(_T("refund_amount"), nTotalRefund);
	rs.GetValue(_T("payment_amount"), nTotalPayment);
	rs.GetValue(_T("reason"), szDescription);
	rs.GetValue(_T("deskno"), nDeskNo);

	rs.GetValue(_T("food_amount"), nSumFoodAmount);

	rs.GetValue(_T("hd_outpatient"), szOutPatient);
	if (szOutPatient == _T("Y"))
	{
		if (!rpt.Init(_T("Reports/HMS/HF_DISCHARGEPAYMENTOUT.RPT"), false))
			return;
	}
	else
	{
		if (!rpt.Init(_T("Reports/HMS/HF_DISCHARGEPAYMENT.RPT"), false))
			return;
	}
	//Report Header
	tmpStr.Empty();
	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	tmpStr.Format(_T("%s-%s-%s"), rs.GetValue(_T("serialno")), rs.GetValue(_T("bookno")), rs.GetValue(_T("recvno")));
	rpt.GetReportHeader()->SetValue(_T("ReceiptNo"), tmpStr);
	tmpStr.Format(_T("%ld"), nInvoiceNo);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);


	CString szDate;
	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);


	rs.GetValue(_T("recordno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RecordNo"), tmpStr);
	//rs.GetValue(_T("pname"), tmpStr);


	CString szPatientName;
	StringUpper(rs.GetValue(_T("pname")), szPatientName);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), szPatientName);
	rs.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	rs.GetValue(_T("yearofbirth"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("birthdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("BirthDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);

	rs.GetValue(_T("sex_id"), tmpStr);
	if (tmpStr == _T("F"))
		rpt.GetReportHeader()->SetValue(_T("Female"), _T("X"));
	else
		rpt.GetReportHeader()->SetValue(_T("Male"), _T("X"));


	rs.GetValue(_T("ethnic"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ethnic"), tmpStr);
	rs.GetValue(_T("ethnicdesc"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ethnicdesc"), tmpStr);

	rs.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);

	CString szAddress;
	rs.GetValue(_T("detailaddress"), tmpStr);
	szAddress = tmpStr;
	rs.GetValue(_T("address"), tmpStr);
	if (!szAddress.IsEmpty())
		szAddress += _T(" - ");
	szAddress += tmpStr;
	rpt.GetReportHeader()->SetValue(_T("Address"), szAddress);


	rs.GetValue(_T("transplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TransferHospital"), tmpStr);


	rs.GetValue(_T("emergency"), tmpStr);
	if (tmpStr == _T("Y"))
		tmpStr = _T("X");
	else
		tmpStr.Empty();

	rpt.GetReportHeader()->SetValue(_T("Emergency"), tmpStr);

	rs.GetValue(_T("maindisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	rs.GetValue(_T("ireldisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RelationDisease"), tmpStr);
	rs.GetValue(_T("mainicd"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ICD10"), tmpStr);
	rs.GetValue(_T("iresult"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Result"), tmpStr);
	rs.GetValue(_T("isuggestion"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Suggestion"), pMF->GetSelectionString(_T("hms_suggestion"), tmpStr));



	CString szDischargeDate;
	rs.GetValue(_T("admitdate"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("admitdate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));

	rs.GetValue(_T("dischargedate"), tmpStr);
	szDischargeDate = tmpStr;

	if (szDischargeDate.Left(4) != _T("1752"))
		rpt.GetReportHeader()->SetValue(_T("dischargedate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));
	else
		rpt.GetReportHeader()->SetValue(_T("dischargedate"), _T(""));

	rs.GetValue(_T("TreatmentDay"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TreatmentDay"), tmpStr);

	CString szData;
	tmpStr.Format(_T("%s-%s-%s"), rs.GetValue(_T("bookno")), rs.GetValue(_T("serialno")), rs.GetValue(_T("recvno")));
	rpt.GetReportFooter()->SetValue(_T("SerialNo"), tmpStr);
	rs.GetValue(_T("recvdate"), szRecvDate);
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate"), CDateTime::Convert(szRecvDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));
	szData.Format(rpt.GetReportFooter()->GetValue(_T("ReceiptDate1")), szRecvDate.Mid(11, 5), szRecvDate.Mid(8, 2), szRecvDate.Mid(5, 2), szRecvDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate1"), szData);
	szData.Format(rpt.GetReportFooter()->GetValue(_T("ReceiptDate2")), szRecvDate.Mid(11, 5), szRecvDate.Mid(8, 2), szRecvDate.Mid(5, 2), szRecvDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate2"), szData);

	rs.GetValue(_T("treatdoctor"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("Doctor"), GetDoctorName(tmpStr));

	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{
		img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img->SetFixedHeight(true);
	}
	tmpStr.Empty();
	rs.GetValue(_T("receiver"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("ReceiverBy"), GetDoctorName(tmpStr));
	CReportItem* img2 = rpt.GetReportFooter()->GetItem(_T("Signature2"));
	if (img2)
	{
		img2->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img2->SetFixedHeight(false);
	}


	// Nguoi tiep don
	tmpStr.Empty();
	rs.GetValue(_T("createdby"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("createdby"), GetDoctorName(tmpStr));
	CReportItem* img3 = rpt.GetReportFooter()->GetItem(_T("Signature3"));
	if (img3)
	{
		img3->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img3->SetFixedHeight(false);
	}


	CReportSection* rptDetail = NULL;
	CReportSection* grp;
	CRecord grs(&pMF->m_db);
	CString szFeeID, szID;
	CString szSubItem, szType;

	TCHAR* lpszChapter[] = { _T("I"), _T("II"), _T("III"), _T("IV"), _T("V"), _T("VI"), _T("VII"), _T("VIII"), _T("IX"), _T("X"), _T("XI") };


	CRecord drs(&pMF->m_db);
	CString szDeptID;
	CStringArray arDepartmentList;

	szSQL.Format(_T(" SELECT deptid, admitdate, dischargedate, mainicd, maindisease") \
		_T(" FROM") \
		_T(" (") \
		_T("  select htr_deptid as deptid,") \
		_T("         htr_admitdate as admitdate,") \
		_T("         htr_dischargedate as dischargedate,") \
		_T("         htr_mainicd as mainicd,") \
		_T("         htr_maindisease as maindisease,") \
		_T("         htr_idx as idx") \
		_T("  from hms_treatment_record") \
		_T("  where htr_docno=%ld") \
		_T("  union all") \
		_T("  select hd_admitdept,") \
		_T("         hd_admitdate,") \
		_T("         hd_enddate,") \
		_T("         hd_icd,") \
		_T("         hd_diagnostic,") \
		_T("         0") \
		_T("  from hms_doc") \
		_T("  where hd_docno=%ld") \
		_T(" ) tbl") \
		_T(" WHERE deptid in(select distinct hfe_deptid from hms_fee where hfe_invoiceno=%ld)") \
		_T(" ORDER BY idx"), nDocumentNo, nDocumentNo, nInvoiceNo);

	drs.ExecSQL(szSQL);

	RECEIPTINFO pi;
	CString szDepts;
	szDepts.Empty();
	CString szTreatDeptID;
	while (!drs.IsEOF())
	{
		drs.GetValue(_T("deptid"), szTreatDeptID);

		bool bFound = false;
		for (int i = 0; i < arDepartmentList.GetCount(); i++)
		{
			tmpStr = arDepartmentList[i];
			if (szTreatDeptID == tmpStr)
			{
				bFound = true;
				break;
			}
		}
		if (!szDepts.IsEmpty())
			szDepts += _T(",  ");
		szDepts.AppendFormat(_T("%s"), szTreatDeptID);

		if (!bFound)
		{
			arDepartmentList.Add(szTreatDeptID);
		}

		drs.MoveNext();
	}

	rpt.GetReportHeader()->SetValue(_T("Department"), szDepts);

	double nSumCost = 0, nSumInsCost = 0, nSumDiscount = 0, nSumDiffPaid = 0, nSumPatPaid = 0;

	szDepts.Empty();


	int nChapter = 0;
	int nCount = 0, nIndex, nChapterID = 0;
	int nItem = 0, nOldItem = 0, nItem2 = 0;
	bool bDeleteParent = false;
	bool bLoadItems = false;
	CString szNewGroup, szOldGroup, szParentGroup;


	double nGroup0Cost = 0, nGroup0InsCost = 0, nGroup0Discount = 0, nGroup0DiffPaid = 0, nGroup0PatPaid = 0;
	double nGroup1Cost = 0, nGroup1InsCost = 0, nGroup1Discount = 0, nGroup1DiffPaid = 0, nGroup1PatPaid = 0;
	double nGroup2Cost = 0, nGroup2InsCost = 0, nGroup2Discount = 0, nGroup2DiffPaid = 0, nGroup2PatPaid = 0;
	double nCost = 0, nInsCost = 0, nDiscount = 0, nDiffPaid = 0, nPatPaid = 0;


	nTotalCost = nTotalDiffPaid = nTotalInsCost = nTotalPatPaid = nTotalDiscount = 0;

	szSQL.Format(_T("SELECT * FROM hms_fee_type ORDER BY hft_id "));
	grs.ExecSQL(szSQL);

	szWhere.Format(_T(" AND hfe_invoiceno=%ld"), nInvoiceNo);

	if (szOutPatient != _T("Y"))
		szWhere.AppendFormat(_T(" and hfe_groupid <>'D0000' "));
	szWhere.AppendFormat(_T(" and hfe_class in('E', 'I','X') "));
	szWhere.AppendFormat(_T(" and (hfe_category <> 'Y' or hfe_category is null) "));

	szWhere.AppendFormat(_T(" and hfe_object in(7) "));

	szSQL.Format(_T(" SELECT hfe_typeindex AS typeindex,") \
		_T("   hfe_status         AS status,") \
		_T("   hfe_type           AS feetype,") \
		_T("   hfe_groupid        AS groupid,") \
		_T("   hfe_groupid3       AS groupid3,") \
		_T("   hfe_itemid         AS itemid,") \
		_T("   hfe_name           AS name,") \
		_T("   hfe_unit           AS unit,") \
		_T("   hfe_hitech         AS hitech,") \
		_T("   hfe_unitprice      AS unitprice,") \
		_T("   SUM(hfe_quantity)       AS qty,") \
		_T("   SUM(hfe_cost)      AS cost,") \
		_T("   SUM(hfe_patpaid)   AS patpaid") \
		_T(" FROM hms_fee_invoiceline_view ") \
		_T(" WHERE hfe_docno  =%ld %s ") \
		_T(" GROUP BY hfe_typeindex,") \
		_T("   hfe_status ,") \
		_T("   hfe_type ,") \
		_T("   hfe_groupid ,") \
		_T("   hfe_groupid3 ,") \
		_T("   hfe_itemid ,") \
		_T("   hfe_name ,") \
		_T("   hfe_unit ,") \
		_T("   hfe_hitech ,") \
		_T("   hfe_unitprice") \
		_T(" ORDER BY hfe_typeindex, hfe_groupid3, hfe_name, hfe_unit, hfe_unitprice"), nDocumentNo, szWhere);



	nIndex = 1;
	int nSubItem = 1;
	int nIDX;
	nChapterID = 0;
	CArray<FEEITEM, FEEITEM&> feeList;
	FEEITEM fee;
	CString szName;
	CString szNewIndex, szOldIndex;
	CString szIndex;
	bool bFound = false;
	bool bInList = false;
	bool bOutList = false;
	bool bKList = false;
	int nSubIndex = 1;

	double nTtlCost = 0, nTtlInsCost = 0, nTtlDiscount = 0, nTtlDiffPaid = 0, nTtlPatPaid = 0;
	rs.ExecSQL(szSQL);
	_fmsg(_T("%s"), szSQL);


	int nNumberTreat = 0;
	while (!grs.IsEOF()) {
		tmpStr.Format(_T("%d"), nIndex);
		grs.GetValue(_T("hft_name"), szName);
		grs.GetValue(_T("hft_id"), szNewIndex);

		fee.szGroupID = _T("Type");
		fee.szID = tmpStr;
		fee.szName = szName;
		nItem = feeList.Add(fee);

		nIDX = nItem;
		bFound = false;
		nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
		nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;

		rs.MoveFirst();
		while (!rs.IsEOF())
		{
			rs.GetValue(_T("typeindex"), tmpStr);

			if (tmpStr == szNewIndex) {
				bFound = true;
				rs.GetValue(_T("groupid"), szNewGroup);
				if (szNewGroup != szOldGroup)
				{
					szOldGroup = szNewGroup;
					if (szNewGroup.Left(2) == _T("B1")) {
						szSQL.Format(_T("SELECT hfg_name FROM hms_fee_group WHERE rtrim(hfg_id,'0')='%s' "), szNewGroup);
						CRecord rs2(&pMF->m_db);
						rs2.ExecSQL(szSQL);
						if (nGroup2Cost > 0) {
							TranslateString(_T("Sub Amount"), tmpStr);
							fee.szGroupID = _T("SubAmount");
							fee.szName = tmpStr;
							fee.nCost = nGroup2Cost;
							fee.nInsPaid = nGroup2InsCost;
							fee.nDiscount = nGroup2Discount;
							fee.nDiffPaid = nGroup2DiffPaid;
							fee.nPatPaid = nGroup2PatPaid;
							int nItem2 = feeList.Add(fee);
						}

						szIndex.Format(_T("%d.%d"), nIndex, nSubIndex++);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = rs2.GetValue(_T("hfg_name"));
						int nItem2 = feeList.Add(fee);
						nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;

					}

				}

				if (szOldIndex != szNewIndex)
				{
					szOldIndex = szNewIndex;
					bInList = false;
					bOutList = false;
				}


				nInsCost = 0;
				nDiscount = 0;
				rs.GetValue(_T("cost"), nCost);
				rs.GetValue(_T("patpaid"), nPatPaid);

				nTotalCost += nCost;
				nGroup1Cost += nCost;
				nGroup2Cost += nCost;

				nTotalInsCost += nInsCost;
				nGroup1InsCost += nInsCost;
				nGroup2InsCost += nInsCost;

				nTotalDiscount += nDiscount;
				nGroup1Discount += nDiscount;
				nGroup2Discount += nDiscount;

				nTotalDiffPaid += nDiffPaid;
				nGroup1DiffPaid += nDiffPaid;
				nGroup2DiffPaid += nDiffPaid;

				nTotalPatPaid += nPatPaid;
				nGroup1PatPaid += nPatPaid;
				nGroup2PatPaid += nPatPaid;

				fee.szID.Empty();
				fee.szGroupID = _T("Item");
				fee.szName = rs.GetValue(_T("name"));
				fee.szUnit = rs.GetValue(_T("unit"));
				fee.nCost = nCost;
				fee.nInsPaid = nInsCost;
				fee.nDiscount = nDiscount;
				fee.nQuantity = str2float(rs.GetValue(_T("qty")));
				fee.nPrice = str2double(rs.GetValue(_T("unitprice")));
				fee.nInsPrice = 0;
				fee.nDiffPaid = nDiffPaid;
				fee.nPatPaid = nPatPaid;
				feeList.Add(fee);

				if (szNewGroup.Left(1) == _T("C"))
				{
					nNumberTreat += (int)fee.nQuantity;

				}

				if (szNewGroup.Left(2) == _T("B4") || szNewGroup.Left(2) == _T("B5")) {
					/*
										CString szItemID;
										rs.GetValue(_T("itemid"), szItemID);

										szSQL.Format(_T("SELECT hfe_itemid, hfe_desc, hfe_quantity, hfe_unitprice, hfe_cost, hfe_discount, hfe_diffcost, hfe_patpaid ") \
													_T("FROM hms_fee ") \
													_T("WHERE hfe_docno=%ld and hfe_type='V' and hfe_unit='%s' ORDER BY hfe_itemid DESC "),
													nDocumentNo, szItemID);
										rsl.ExecSQL(szSQL);
										nCost = nInsCost = nPatPaid  = 0;
										rsl.MoveFirst();
										while(!rsl.IsEOF())
										{
													CString szItemID;
													rsl.GetValue(_T("hfe_itemid"), szItemID);

													fee.szID = _T("*");
													fee.szGroupID = _T("Item");
													fee.szName = rsl.GetValue(_T("hfe_desc"));
													fee.nQuantity = str2double(rsl.GetValue(_T("hfe_quantity")));
													fee.nCost = 0;
													fee.nDiscount = 0;
													fee.nPrice = str2double(rsl.GetValue(_T("hfe_unitprice")));

													if(m_szObjectType == _T("S"))
													{
														rsl.GetValue(_T("hfe_patpaid"), nPatPaid);
														fee.nCost = nPatPaid;
														fee.nDiffPaid = 0;
														fee.nPatPaid = nPatPaid;

														nCost = nPatPaid;
														nDiscount =0;
														nInsCost =0;
														feeList.Add(fee);
														nTtlCost += nCost;
														nTtlPatPaid += nPatPaid;

													}
													else
													{
														rsl.GetValue(_T("hfe_cost"), nCost);
														rsl.GetValue(_T("hfe_discount"), nDiscount);
														rsl.GetValue(_T("hfe_diffcost"), nDiffPaid);
														//rsl.GetValue(_T("hfe_patpaid"), nPatPaid);
														nPatPaid =0;
														fee.nDiffPaid = nDiffPaid;
														fee.nPatPaid = nPatPaid;
														fee.nCost = nCost;
														fee.nDiscount = nDiscount;
														nInsCost = nCost;
														feeList.Add(fee);
														nTtlDiffPaid += nDiffPaid;
														nTtlCost += nCost;
														nTtlInsCost += nInsCost;
														nTtlDiscount += nDiscount;
														nTtlPatPaid += nPatPaid;
													}
													if(nDiscount +nDiffPaid+nPatPaid > 0)
													{
														nTotalCost += nCost;

														nGroup1Cost += nCost;
														nGroup2Cost += nCost;
														nTotalInsCost += nInsCost;
														nGroup1InsCost += nInsCost;
														nGroup2InsCost += nInsCost;
														nTotalDiscount += nDiscount;
														nGroup1Discount += nDiscount;
														nGroup2Discount += nDiscount;
														nTotalDiffPaid += nDiffPaid;
														nGroup1DiffPaid += nDiffPaid;
														nGroup2DiffPaid += nDiffPaid;
														nTotalPatPaid += nPatPaid;
														nGroup1PatPaid += nPatPaid;
														nGroup2PatPaid += nPatPaid;
													}
											rsl.MoveNext();

										}
					*/

				}	//end B4, B5



			}
			rs.MoveNext();
		}
		if (!bFound)
		{
			feeList.RemoveAt(nIDX);
			nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
			nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;
		}
		else
		{
			if (nGroup1Cost > 0) {
				if (nGroup2Cost > 0 && nGroup1Cost != nGroup2Cost) {
					TranslateString(_T("Sub Amount"), tmpStr);
					fee.szGroupID = _T("SubAmount");
					fee.szID.Empty();;
					fee.szName = tmpStr;
					fee.nCost = nGroup2Cost;
					fee.nInsPaid = nGroup2InsCost;
					fee.nDiscount = nGroup2Discount;
					fee.nDiffPaid = nGroup2DiffPaid;
					fee.nPatPaid = nGroup2PatPaid;
					feeList.Add(fee);
				}

				TranslateString(_T("Total"), tmpStr);
				tmpStr.AppendFormat(_T(" (%d)"), nIndex);
				fee.szGroupID = _T("GrandAmount");
				fee.szID.Empty();;
				fee.szName = tmpStr;
				fee.nCost = nGroup1Cost;
				fee.nInsPaid = nGroup1InsCost;
				fee.nDiscount = nGroup1Discount;
				fee.nDiffPaid = nGroup1DiffPaid;
				fee.nPatPaid = nGroup1PatPaid;
				feeList.Add(fee);
			}
			nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
			nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;

			nIndex++;
		}



		grs.MoveNext();
	}

	nTotalCost = ceil(nTotalCost);
	nTotalInsCost = ceil(nTotalInsCost);
	nTotalDiscount = ceil(nTotalDiscount);
	nTotalDiffPaid = ceil(nTotalDiffPaid);
	nTotalPatPaid = ceil(nTotalPatPaid);
	nTotalPayable = nTotalCost - nTotalDiscount;

	TranslateString(_T("Total Amount"), szName);
	fee.szGroupID = _T("TotalAmount");
	fee.szName.Format(_T("%s "), szName);
	fee.nCost = nTotalCost;
	fee.nInsPaid = nTotalInsCost;
	fee.nDiscount = nTotalDiscount;
	fee.nDiffPaid = nTotalDiffPaid;
	fee.nPatPaid = nTotalPatPaid;
	feeList.Add(fee);

	nSumCost += nTotalCost;
	nSumInsCost += nTotalInsCost;
	nSumDiscount += nTotalDiscount;
	nSumDiffPaid += nTotalDiffPaid;
	nSumPatPaid += nTotalPatPaid;


	for (int i = 0; i < feeList.GetCount(); i++) {
		fee = feeList[i];
		szType = fee.szGroupID;

		if (szType == _T("Type"))
		{
			grp = rpt.GetGroupHeader(1);
			rptDetail = rpt.AddDetail(grp);
			tmpStr = fee.szID;
			rptDetail->SetValue(_T("TypeID"), tmpStr);
			StringUpper(fee.szName, tmpStr);
			rptDetail->SetValue(_T("TypeName"), tmpStr);
		}
		else if (szType == _T("Group")) {
			grp = rpt.GetGroupHeader(1);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("TypeID"), fee.szID);
			rptDetail->SetValue(_T("TypeName"), fee.szName);
		}
		else if (szType == _T("SubGroup")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("SubGroupID"), fee.szID);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);


			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}
		}
		else if (szType == _T("SubAmount")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			CReportItem* obj;
			obj = rptDetail->GetItem(_T("SubGroupName")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupCost")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupDiscount")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupPatpaid")); if (obj) obj->SetBold(true);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);


			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}

		}
		else if (szType == _T("GrandAmount")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			//	rptDetail->GetItem(_T("SubGroupName"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupCost"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupDiscount"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupPatpaid"))->SetBold(true);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}

		}

		else if (szType == _T("Item")) {
			rptDetail = rpt.AddDetail();
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), fee.szUnit);
			FormatCurrency(fee.nQuantity, tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), tmpStr);

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);

		}
		else if (szType == _T("SubItemGroup")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj)
				{
					obj->SetItalic(true);
					obj->SetBold(true);
				}

			}
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), _T(""));
			rptDetail->SetValue(_T("4"), _T(""));
			rptDetail->SetValue(_T("5"), _T(""));

		}

		else if (szType == _T("SubItem")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj) obj->SetItalic(true);
			}

			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), fee.szUnit);
			FormatCurrency(fee.nQuantity, tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), tmpStr);

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}

		}
		else if (szType == _T("SubItemAmount")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj)
				{
					obj->SetItalic(true);
					obj->SetBold(true);
				}

			}
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), _T(""));
			rptDetail->SetValue(_T("4"), _T(""));
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), _T(""));

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}

		}

		else if (szType == _T("Dousage")) {
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(4));
			rptDetail->SetValue(_T("usage"), fee.szName);
		}
		else if (szType == _T("TotalAmount")) {
			grp = rpt.GetGroupHeader(3);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("TotalAmountLabel"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("TotalAmount"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("TotalInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("TotalDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("TotalDiffPaid"), tmpStr);
			//fee.nPatPaid= fee.nCost-fee.nDiscount;
			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("TotalPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("TotalInsUnPaid"), tmpStr);
			}
		}
	}


	if (nTotalCost != nSumCost) {
		CString szName;
		TranslateString(_T("Total Amount"), tmpStr);
		szName.Format(_T("%s"), tmpStr);
		grp = rpt.GetGroupHeader(3);
		rptDetail = rpt.AddDetail(grp);
		rptDetail->SetValue(_T("TotalAmountLabel"), szName);
		FormatCurrency(nSumCost, tmpStr);
		rptDetail->SetValue(_T("TotalAmount"), tmpStr);

		FormatCurrency(nSumInsCost, tmpStr);
		rptDetail->SetValue(_T("TotalInsCost"), tmpStr);

		FormatCurrency(nSumDiscount, tmpStr);
		rptDetail->SetValue(_T("TotalDiscount"), tmpStr);

		FormatCurrency(nSumDiffPaid, tmpStr);
		rptDetail->SetValue(_T("TotalDiffPaid"), tmpStr);
		FormatCurrency(nSumPatPaid, tmpStr);
		rptDetail->SetValue(_T("TotalPatPaid"), tmpStr);
	}


	szSQL.Format(_T(" SELECT hfe_amount as hfe_amount,") \
		_T("   hfe_inspaid,") \
		_T("   hfe_discount,") \
		_T("   hfe_patpaid,") \
		_T("   hfe_payment,") \
		_T("   hfe_diffcost,") \
		_T("   hfe_diffpaid,") \
		_T("   hfe_deposit,") \
		_T("   hfe_refund,") \
		_T("   hfe_freeamount") \
		_T(" FROM hms_fee_invoice") \
		_T(" WHERE hfe_invoiceno=%ld and hfe_status='P' "), nInvoiceNo);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		double nTotalDiffPaid;
		double nTotalPayment;
		double nTotalPatPaid;

		rs.GetValue(_T("hfe_amount"), nTotalCost);
		rs.GetValue(_T("hfe_inspaid"), nTotalInsCost);
		rs.GetValue(_T("hfe_discount"), nTotalDiscount);
		rs.GetValue(_T("hfe_patpaid"), nTotalPatPaid);
		rs.GetValue(_T("hfe_diffcost"), nTotalDiffPaid);
		rs.GetValue(_T("hfe_deposit"), nTotalDeposit);
		rs.GetValue(_T("hfe_refund"), nTotalRefund);
		rs.GetValue(_T("hfe_freeamount"), nTotalFree);
		rs.GetValue(_T("hfe_payment"), nTotalPayment);
	}
	else
	{
		double nDepositAmount = 0;
		szSQL.Format(_T("select sum(hfe_amount-hfe_patpaid) as deposit_amount ") \
			_T("from hms_fee_deposit ") \
			_T("where hfe_docno=%ld and hfe_status<>'C' ") \
			_T("and hfe_class IN('E','I','A') and hfe_objectid=7  "), nDocumentNo);
		rs.ExecSQL(szSQL);
		if (!rs.IsEOF())
		{
			rs.GetValue(_T("deposit_amount"), nDepositAmount);
		}
		nTotalDeposit = nDepositAmount;
		if (nTotalCost < nTotalDeposit)
		{
			nTotalRefund = nTotalDeposit - nTotalCost;
			nTotalPayment = 0;
		}
		else
		{
			nTotalPayment = nTotalCost - nTotalDeposit;
			nTotalRefund = 0;
		}
	}

	if (nNumberTreat > 0)
	{
		tmpStr.Format(_T("%d"), nNumberTreat);
		rpt.GetReportHeader()->SetValue(_T("TreatmentDay"), tmpStr);
	}
	rpt.GetReportFooter()->SetValue(_T("PatientSign"), szPatientName);
	FormatCurrency((nTotalCost), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumAmount"), tmpStr);
	CString szSumInWord;
	tmpStr.Format(_T("%.0f"), nTotalCost);
	MoneyToString(tmpStr, szSumInWord);
	szSumInWord += _T(" \x111\x1ED3ng.");
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), szSumInWord);

	FormatCurrency(nTotalInsCost, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumInsCost"), tmpStr);


	FormatCurrency(nTotalDiscount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumInsDiscount"), tmpStr);

	FormatCurrency(nTotalPatPaid, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumInsUnPaid"), tmpStr);

	FormatCurrency((nTotalDiffPaid), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumDiffPaid"), tmpStr);


	FormatCurrency(nTotalPatPaid, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumPatPaid"), tmpStr);



	FormatCurrency((nTotalDeposit), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumDeposit"), tmpStr);

	FormatCurrency(nTotalFree, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumDiscount"), tmpStr);

	FormatCurrency(nSumFoodAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumFoodAmount"), tmpStr);

	if (nTotalRefund > 0)
	{
		//	FormatCurrency(nTotalRefund, tmpStr);
		//	rpt.GetReportFooter()->SetValue(_T("SumPayment"), tmpStr);

		FormatCurrency(nTotalRefund, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumRefund"), tmpStr);
	}
	else
	{
		FormatCurrency(nTotalPayment, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumPayment"), tmpStr);
	}


	rpt.PrintPreview();
}









void CPrintForms::FM_PrintAllServiceDischargePayment(long nDocumentNo)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	//	if (!pMF->IsInPatient())
	//		return;

	CReport rpt;
	CString tmpStr, szSQL, szWhere, szAdmitDate, szEndDate, szDepartments, szAddonedayoutofhospital, szNumbertreat;
	CRecord rs(&pMF->m_db);
	CRecord rsd(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	int		nDeskNo = 0;
	CString szRecvDate;
	CString	szObjectType;
	CString	szDescription;
	CString szPrintMaterialOperation = _T("Y");
	CString szOutPatient;

	double	nTotalCost = 0,				//Tong chi phi
		nTotalInsCost = 0,
		nTotalDiscount = 0,			//Tong Mien giam
		nTotalPatPaid = 0,			//Tong benh nhan tra
		nTotalDiffPaid = 0,	//Tong so tra chenh lech
		nTotalPayable = 0,
		nTotalDeposit = 0,			//Tong tam ung
		nTotalFree = 0,				//Tong mien phi
		nTotalRefund = 0,				//Tong hoan tra
		nDepositPayable = 0;			//So tien tra tu tam ung


	double nSumFoodAmount = 0;


	szWhere.AppendFormat(_T(" and hfe_invoiceno > 0 and hfe_status ='P' "));

	szSQL.Format(_T(" SELECT *") \
		_T(" FROM") \
		_T(" (") \
		_T("  SELECT hd_patientno as patientno,") \
		_T("         hd_docno as docno,") \
		_T("         trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T("         hp_birthdate as birthdate,") \
		_T("         hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age,") \
		_T("         extract(year from hp_birthdate) as yearofbirth, ") \
		_T("         Get_Selection_Desc('sys_sex', hp_sex) as sex,") \
		_T("         hp_sex as sex_id,") \
		_T("         hp_ethnic as ethnic,") \
		_T("         Get_Selection_Desc('sys_ethnic', hp_ethnic) as ethnicdesc, ") \
		_T("         nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T("         hms_getaddress(hp_provid,hp_distid, hp_villid) as address,") \
		_T("         hp_workplace as workplace,") \
		_T("         hd_doctor as doctor,") \
		_T("         hd_createdby as createdby,") \
		_T("         hd_icd as icd10,") \
		_T("         hd_diagnostic as diagnostic,") \
		_T("         hd_reldisease as reldisease,") \
		_T("         hd_emergency as emergency, ") \
		_T("         Get_Selection_Desc('hms_result',hd_result) as result,") \
		_T("         hd_admitdate as examdate,") \
		_T("         hd_enddate as enddate,") \
		_T("		hd_outpatient, ") \
		_T("         hcr_recordno as recordno ,") \
		_T("         hcr_admitdate as admitdate,") \
		_T("         hcr_dischargedate as dischargedate,") \
		_T("         hcr_sumtreat as TreatmentDay,") \
		_T("         hcr_mainicd as mainicd ,") \
		_T("         hcr_maindisease as maindisease ,") \
		_T("         hcr_treatdoctor as treatdoctor, ") \
		_T("         hcr_reldisease as ireldisease,") \
		_T("         hcr_suggestion as isuggestion,") \
		_T("         hd_suggestion as esuggestion,") \
		_T("         Get_Selection_Desc('hms_result' ,hcr_result)  as iresult,") \
		_T("         hfe_deptid as deptid,") \
		_T("         hfe_serialno as serialno,") \
		_T("         hfe_receiptno as recvno,") \
		_T("         hfe_date as recvdate, ") \
		_T("         hfe_staff as receiver,") \
		_T("         hfe_desc as reason,") \
		_T("         hfe_amount as cost,") \
		_T("         hfe_discount as discount,") \
		_T("         hfe_patpaid as patpaid,") \
		_T("         hfe_deposit as deposit_amount, ") \
		_T("         0 as deposit_payable,") \
		_T("         hfe_refund as refund_amount, ") \
		_T("         hfe_freeamount as free_amount,") \
		_T("         hfe_eat_amount as food_amount,") \
		_T("         row_number() over (partition by hd_docno order by hd_docno) as dn") \
		_T(" FROM hms_fee_invoice ") \
		_T(" LEFT JOIN hms_doc ON(hd_docno=hfe_docno)") \
		_T(" LEFT JOIN hms_patient ON(hp_patientno=hd_patientno)") \
		_T(" LEFT JOIN hms_clinical_record ON(hcr_docno=hd_docno) ") \
		_T(" LEFT JOIN hms_treatment_record ON(hfe_docno=htr_docno) ") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hfe_docno=%ld and hfe_type<>'E' %s ") \
		_T(" ) Tbl") \
		_T(" WHERE dn=1"), nDocumentNo, szWhere);


	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		return;
	}

	rs.GetValue(_T("cost"), nTotalCost);
	rs.GetValue(_T("discount"), nTotalDiscount);
	rs.GetValue(_T("patpaid"), nTotalPatPaid);
	rs.GetValue(_T("deposit_amount"), nTotalDeposit);
	rs.GetValue(_T("free_amount"), nTotalFree);
	rs.GetValue(_T("refund_amount"), nTotalRefund);
	rs.GetValue(_T("deposit_payable"), nDepositPayable);
	rs.GetValue(_T("reason"), szDescription);
	rs.GetValue(_T("deskno"), nDeskNo);

	rs.GetValue(_T("food_amount"), nSumFoodAmount);
	rs.GetValue(_T("hd_outpatient"), szOutPatient);



	if (!rpt.Init(_T("Reports/HMS/HF_DISCHARGEPAYMENTALL.RPT"), false))
		return;

	//Report Header
	tmpStr.Empty();
	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	tmpStr.Format(_T("%s-%s-%s"), rs.GetValue(_T("serialno")), rs.GetValue(_T("bookno")), rs.GetValue(_T("recvno")));
	rpt.GetReportHeader()->SetValue(_T("ReceiptNo"), tmpStr);
	//	tmpStr.Format(_T("%ld"), nInvoiceNo);
	//	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);


	CString szDate;
	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);


	rs.GetValue(_T("recordno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RecordNo"), tmpStr);
	//rs.GetValue(_T("pname"), tmpStr);


	CString szPatientName;
	StringUpper(rs.GetValue(_T("pname")), szPatientName);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), szPatientName);
	rs.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	rs.GetValue(_T("yearofbirth"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("birthdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("BirthDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);

	rs.GetValue(_T("sex_id"), tmpStr);
	if (tmpStr == _T("F"))
		rpt.GetReportHeader()->SetValue(_T("Female"), _T("X"));
	else
		rpt.GetReportHeader()->SetValue(_T("Male"), _T("X"));


	rs.GetValue(_T("ethnic"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ethnic"), tmpStr);
	rs.GetValue(_T("ethnicdesc"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ethnicdesc"), tmpStr);

	rs.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);

	CString szAddress;
	rs.GetValue(_T("detailaddress"), tmpStr);
	szAddress = tmpStr;
	rs.GetValue(_T("address"), tmpStr);
	if (!szAddress.IsEmpty())
		szAddress += _T(" - ");
	szAddress += tmpStr;
	rpt.GetReportHeader()->SetValue(_T("Address"), szAddress);


	rs.GetValue(_T("transplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TransferHospital"), tmpStr);


	rs.GetValue(_T("emergency"), tmpStr);
	if (tmpStr == _T("Y"))
		tmpStr = _T("X");
	else
		tmpStr.Empty();

	rpt.GetReportHeader()->SetValue(_T("Emergency"), tmpStr);

	rs.GetValue(_T("maindisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	rs.GetValue(_T("ireldisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RelationDisease"), tmpStr);
	rs.GetValue(_T("mainicd"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ICD10"), tmpStr);
	rs.GetValue(_T("iresult"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Result"), tmpStr);
	rs.GetValue(_T("isuggestion"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Suggestion"), pMF->GetSelectionString(_T("hms_suggestion"), tmpStr));



	CString szDischargeDate;
	rs.GetValue(_T("admitdate"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("admitdate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));

	rs.GetValue(_T("dischargedate"), tmpStr);
	szDischargeDate = tmpStr;

	if (szDischargeDate.Left(4) != _T("1752"))
		rpt.GetReportHeader()->SetValue(_T("dischargedate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));
	else
		rpt.GetReportHeader()->SetValue(_T("dischargedate"), _T(""));

	rs.GetValue(_T("TreatmentDay"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TreatmentDay"), tmpStr);

	CString szData;
	tmpStr.Format(_T("%s-%s-%s"), rs.GetValue(_T("bookno")), rs.GetValue(_T("serialno")), rs.GetValue(_T("recvno")));
	rpt.GetReportFooter()->SetValue(_T("SerialNo"), tmpStr);
	rs.GetValue(_T("recvdate"), szRecvDate);
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate"), CDateTime::Convert(szRecvDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));
	szData.Format(rpt.GetReportFooter()->GetValue(_T("ReceiptDate1")), szRecvDate.Mid(11, 5), szRecvDate.Mid(8, 2), szRecvDate.Mid(5, 2), szRecvDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate1"), szData);
	szData.Format(rpt.GetReportFooter()->GetValue(_T("ReceiptDate2")), szRecvDate.Mid(11, 5), szRecvDate.Mid(8, 2), szRecvDate.Mid(5, 2), szRecvDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate2"), szData);

	rs.GetValue(_T("treatdoctor"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("Doctor"), GetDoctorName(tmpStr));

	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{
		img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img->SetFixedHeight(true);
	}
	tmpStr.Empty();
	rs.GetValue(_T("receiver"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("ReceiverBy"), GetDoctorName(tmpStr));
	CReportItem* img2 = rpt.GetReportFooter()->GetItem(_T("Signature2"));
	if (img2)
	{
		img2->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img2->SetFixedHeight(false);
	}


	// Nguoi tiep don
	tmpStr.Empty();
	rs.GetValue(_T("createdby"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("createdby"), GetDoctorName(tmpStr));
	CReportItem* img3 = rpt.GetReportFooter()->GetItem(_T("Signature3"));
	if (img3)
	{
		img3->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img3->SetFixedHeight(false);
	}


	CReportSection* rptDetail = NULL;
	CReportSection* grp;
	CRecord grs(&pMF->m_db);
	CString szFeeID, szID;
	CString szSubItem, szType;

	TCHAR* lpszChapter[] = { _T("I"), _T("II"), _T("III"), _T("IV"), _T("V"), _T("VI"), _T("VII"), _T("VIII"), _T("IX"), _T("X"), _T("XI") };


	CRecord drs(&pMF->m_db);
	CString szDeptID;
	CStringArray arDepartmentList;

	szSQL.Format(_T(" SELECT deptid, admitdate, dischargedate, mainicd, maindisease") \
		_T(" FROM") \
		_T(" (") \
		_T("  select htr_deptid as deptid,") \
		_T("         htr_admitdate as admitdate,") \
		_T("         htr_dischargedate as dischargedate,") \
		_T("         htr_mainicd as mainicd,") \
		_T("         htr_maindisease as maindisease,") \
		_T("         htr_idx as idx") \
		_T("  from hms_treatment_record") \
		_T("  where htr_docno=%ld") \
		_T("  union all") \
		_T("  select hd_admitdept,") \
		_T("         hd_admitdate,") \
		_T("         hd_enddate,") \
		_T("         hd_icd,") \
		_T("         hd_diagnostic,") \
		_T("         0") \
		_T("  from hms_doc") \
		_T("  where hd_docno=%ld") \
		_T(" ) tbl") \
		_T(" WHERE deptid in(select distinct hfe_deptid from hms_fee where hfe_invoiceno > 0 and hfe_status ='P' )") \
		_T(" ORDER BY idx"), nDocumentNo, nDocumentNo);

	drs.ExecSQL(szSQL);

	RECEIPTINFO pi;
	CString szDepts;
	szDepts.Empty();
	CString szTreatDeptID;
	while (!drs.IsEOF())
	{
		drs.GetValue(_T("deptid"), szTreatDeptID);

		bool bFound = false;
		for (int i = 0; i < arDepartmentList.GetCount(); i++)
		{
			tmpStr = arDepartmentList[i];
			if (szTreatDeptID == tmpStr)
			{
				bFound = true;
				break;
			}
		}
		if (!szDepts.IsEmpty())
			szDepts += _T(",  ");
		szDepts.AppendFormat(_T("%s"), szTreatDeptID);

		if (!bFound)
		{
			arDepartmentList.Add(szTreatDeptID);
		}

		drs.MoveNext();
	}

	rpt.GetReportHeader()->SetValue(_T("Department"), szDepts);

	double nSumCost = 0, nSumInsCost = 0, nSumDiscount = 0, nSumDiffPaid = 0, nSumPatPaid = 0;

	szDepts.Empty();


	int nChapter = 0;
	int nCount = 0, nIndex, nChapterID = 0;
	int nItem = 0, nOldItem = 0, nItem2 = 0;
	bool bDeleteParent = false;
	bool bLoadItems = false;
	CString szNewGroup, szOldGroup, szParentGroup;


	double nGroup0Cost = 0, nGroup0InsCost = 0, nGroup0Discount = 0, nGroup0DiffPaid = 0, nGroup0PatPaid = 0;
	double nGroup1Cost = 0, nGroup1InsCost = 0, nGroup1Discount = 0, nGroup1DiffPaid = 0, nGroup1PatPaid = 0;
	double nGroup2Cost = 0, nGroup2InsCost = 0, nGroup2Discount = 0, nGroup2DiffPaid = 0, nGroup2PatPaid = 0;
	double nCost = 0, nInsCost = 0, nDiscount = 0, nDiffPaid = 0, nPatPaid = 0;


	nTotalCost = nTotalDiffPaid = nTotalInsCost = nTotalPatPaid = nTotalDiscount = 0;

	szSQL.Format(_T("SELECT * FROM hms_fee_type ORDER BY hft_id "));
	grs.ExecSQL(szSQL);

	szWhere.Format(_T(" AND hfe_invoiceno > 0 and hfe_status='P' "));

	if (szOutPatient != _T("Y"))
		szWhere.AppendFormat(_T(" and hfe_groupid <>'D0000' "));
	szWhere.AppendFormat(_T(" and hfe_class in('E', 'I','X') "));
	//szWhere.AppendFormat(_T(" and hfe_category<>'Y' "));
	szWhere.AppendFormat(_T(" and (hfe_category <> 'Y' or hfe_category is null) "));


	szSQL.Format(_T(" SELECT hfe_typeindex AS typeindex,") \
		_T("   hfe_status         AS status,") \
		_T("   hfe_type           AS feetype,") \
		_T("   hfe_groupid        AS groupid,") \
		_T("   hfe_groupid3       AS groupid3,") \
		_T("   hfe_itemid         AS itemid,") \
		_T("   hfe_name           AS name,") \
		_T("   hfe_unit           AS unit,") \
		_T("   hfe_hitech         AS hitech,") \
		_T("   hfe_inlist         AS inlist,") \
		_T("   hfe_unitprice      AS unitprice,") \
		_T("   SUM(hfe_quantity)       AS qty,") \
		_T("   SUM(hfe_amount)      AS cost,") \
		_T("   SUM(hfe_discount)  AS discount,") \
		_T("   SUM(hfe_diffpaid)  AS DiffPaid,") \
		_T("   SUM(hfe_copayment) AS copayment,") \
		_T("   SUM(hfe_patpaid)   AS patpaid") \
		_T(" FROM hms_fee_invoiceline_view ") \
		_T(" WHERE hfe_docno  =%ld %s ") \
		_T(" GROUP BY hfe_typeindex,") \
		_T("   hfe_status ,") \
		_T("   hfe_type ,") \
		_T("   hfe_groupid ,") \
		_T("   hfe_groupid3 ,") \
		_T("   hfe_itemid ,") \
		_T("   hfe_name ,") \
		_T("   hfe_unit ,") \
		_T("   hfe_hitech ,") \
		_T("   hfe_inlist,") \
		_T("   hfe_unitprice") \
		_T(" ORDER BY hfe_typeindex, hfe_inlist, hfe_groupid3, hfe_name, hfe_unit, hfe_unitprice"), nDocumentNo, szWhere);



	_fmsg(_T("%s"), szSQL);

	nIndex = 1;
	int nSubItem = 1;
	int nIDX;
	nChapterID = 0;
	CArray<FEEITEM, FEEITEM&> feeList;
	FEEITEM fee;
	CString szName;
	CString szNewIndex, szOldIndex;
	CString szIndex;
	bool bFound = false;
	bool bInList = false;
	bool bOutList = false;
	bool bKList = false;
	int nSubIndex = 1;

	double nTtlCost = 0, nTtlInsCost = 0, nTtlDiscount = 0, nTtlDiffPaid = 0, nTtlPatPaid = 0;
	rs.ExecSQL(szSQL);
	_fmsg(_T("%s"), szSQL);



	while (!grs.IsEOF()) {
		tmpStr.Format(_T("%d"), nIndex);
		grs.GetValue(_T("hft_name"), szName);
		grs.GetValue(_T("hft_id"), szNewIndex);

		fee.szGroupID = _T("Type");
		fee.szID = tmpStr;
		fee.szName = szName;
		nItem = feeList.Add(fee);

		nIDX = nItem;
		bFound = false;
		nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
		nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;

		rs.MoveFirst();
		while (!rs.IsEOF())
		{
			rs.GetValue(_T("typeindex"), tmpStr);

			if (tmpStr == szNewIndex) {
				bFound = true;
				rs.GetValue(_T("groupid"), szNewGroup);
				if (szNewGroup != szOldGroup)
				{
					szOldGroup = szNewGroup;
					if (szNewGroup.Left(2) == _T("B1")) {
						szSQL.Format(_T("SELECT hfg_name FROM hms_fee_group WHERE rtrim(hfg_id,'0')='%s' "), szNewGroup);
						CRecord rs2(&pMF->m_db);
						rs2.ExecSQL(szSQL);
						if (nGroup2Cost > 0) {
							TranslateString(_T("Sub Amount"), tmpStr);
							fee.szGroupID = _T("SubAmount");
							fee.szName = tmpStr;
							fee.nCost = nGroup2Cost;
							fee.nInsPaid = nGroup2InsCost;
							fee.nDiscount = nGroup2Discount;
							fee.nDiffPaid = nGroup2DiffPaid;
							fee.nPatPaid = nGroup2PatPaid;
							int nItem2 = feeList.Add(fee);
						}

						szIndex.Format(_T("%d.%d"), nIndex, nSubIndex++);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = rs2.GetValue(_T("hfg_name"));
						int nItem2 = feeList.Add(fee);
						nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;

					}

				}

				if (szOldIndex != szNewIndex)
				{
					szOldIndex = szNewIndex;
					bInList = false;
					bOutList = false;
				}



				rs.GetValue(_T("cost"), nCost);
				rs.GetValue(_T("inscost"), nInsCost);
				rs.GetValue(_T("discount"), nDiscount);
				rs.GetValue(_T("DiffPaid"), nDiffPaid);
				rs.GetValue(_T("copayment"), nPatPaid);

				nTotalCost += nCost;
				nGroup1Cost += nCost;
				nGroup2Cost += nCost;

				nTotalInsCost += nInsCost;
				nGroup1InsCost += nInsCost;
				nGroup2InsCost += nInsCost;

				nTotalDiscount += nDiscount;
				nGroup1Discount += nDiscount;
				nGroup2Discount += nDiscount;

				nTotalDiffPaid += nDiffPaid;
				nGroup1DiffPaid += nDiffPaid;
				nGroup2DiffPaid += nDiffPaid;

				nTotalPatPaid += nPatPaid;
				nGroup1PatPaid += nPatPaid;
				nGroup2PatPaid += nPatPaid;

				fee.szID.Empty();
				fee.szGroupID = _T("Item");
				fee.szName = rs.GetValue(_T("name"));
				fee.szUnit = rs.GetValue(_T("unit"));
				fee.nCost = nCost;
				fee.nInsPaid = nInsCost;
				fee.nDiscount = nDiscount;
				fee.nQuantity = str2float(rs.GetValue(_T("qty")));
				fee.nPrice = str2double(rs.GetValue(_T("unitprice")));
				fee.nInsPrice = str2double(rs.GetValue(_T("insprice")));
				fee.nDiffPaid = nDiffPaid;
				fee.nPatPaid = nPatPaid;
				feeList.Add(fee);

				if (szNewGroup.Left(2) == _T("B4") || szNewGroup.Left(2) == _T("B5")) {
					/*
										CString szItemID;
										rs.GetValue(_T("itemid"), szItemID);

										szSQL.Format(_T("SELECT hfe_itemid, hfe_desc, hfe_quantity, hfe_unitprice, hfe_cost, hfe_discount, hfe_diffcost, hfe_patpaid ") \
													_T("FROM hms_fee ") \
													_T("WHERE hfe_docno=%ld and hfe_type='V' and hfe_unit='%s' ORDER BY hfe_itemid DESC "),
													nDocumentNo, szItemID);
										rsl.ExecSQL(szSQL);
										nCost = nInsCost = nPatPaid  = 0;
										rsl.MoveFirst();
										while(!rsl.IsEOF())
										{
													CString szItemID;
													rsl.GetValue(_T("hfe_itemid"), szItemID);

													fee.szID = _T("*");
													fee.szGroupID = _T("Item");
													fee.szName = rsl.GetValue(_T("hfe_desc"));
													fee.nQuantity = str2double(rsl.GetValue(_T("hfe_quantity")));
													fee.nCost = 0;
													fee.nDiscount = 0;
													fee.nPrice = str2double(rsl.GetValue(_T("hfe_unitprice")));

													if(m_szObjectType == _T("S"))
													{
														rsl.GetValue(_T("hfe_patpaid"), nPatPaid);
														fee.nCost = nPatPaid;
														fee.nDiffPaid = 0;
														fee.nPatPaid = nPatPaid;

														nCost = nPatPaid;
														nDiscount =0;
														nInsCost =0;
														feeList.Add(fee);
														nTtlCost += nCost;
														nTtlPatPaid += nPatPaid;

													}
													else
													{
														rsl.GetValue(_T("hfe_cost"), nCost);
														rsl.GetValue(_T("hfe_discount"), nDiscount);
														rsl.GetValue(_T("hfe_diffcost"), nDiffPaid);
														//rsl.GetValue(_T("hfe_patpaid"), nPatPaid);
														nPatPaid =0;
														fee.nDiffPaid = nDiffPaid;
														fee.nPatPaid = nPatPaid;
														fee.nCost = nCost;
														fee.nDiscount = nDiscount;
														nInsCost = nCost;
														feeList.Add(fee);
														nTtlDiffPaid += nDiffPaid;
														nTtlCost += nCost;
														nTtlInsCost += nInsCost;
														nTtlDiscount += nDiscount;
														nTtlPatPaid += nPatPaid;
													}
													if(nDiscount +nDiffPaid+nPatPaid > 0)
													{
														nTotalCost += nCost;

														nGroup1Cost += nCost;
														nGroup2Cost += nCost;
														nTotalInsCost += nInsCost;
														nGroup1InsCost += nInsCost;
														nGroup2InsCost += nInsCost;
														nTotalDiscount += nDiscount;
														nGroup1Discount += nDiscount;
														nGroup2Discount += nDiscount;
														nTotalDiffPaid += nDiffPaid;
														nGroup1DiffPaid += nDiffPaid;
														nGroup2DiffPaid += nDiffPaid;
														nTotalPatPaid += nPatPaid;
														nGroup1PatPaid += nPatPaid;
														nGroup2PatPaid += nPatPaid;
													}
											rsl.MoveNext();

										}
					*/

				}	//end B4, B5



			}
			rs.MoveNext();
		}
		if (!bFound)
		{
			feeList.RemoveAt(nIDX);
			nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
			nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;
		}
		else
		{
			if (nGroup1Cost > 0) {
				if (nGroup2Cost > 0 && nGroup1Cost != nGroup2Cost) {
					TranslateString(_T("Sub Amount"), tmpStr);
					fee.szGroupID = _T("SubAmount");
					fee.szID.Empty();;
					fee.szName = tmpStr;
					fee.nCost = nGroup2Cost;
					fee.nInsPaid = nGroup2InsCost;
					fee.nDiscount = nGroup2Discount;
					fee.nDiffPaid = nGroup2DiffPaid;
					fee.nPatPaid = nGroup2PatPaid;
					feeList.Add(fee);
				}

				TranslateString(_T("Total"), tmpStr);
				tmpStr.AppendFormat(_T(" (%d)"), nIndex);
				fee.szGroupID = _T("GrandAmount");
				fee.szID.Empty();;
				fee.szName = tmpStr;
				fee.nCost = nGroup1Cost;
				fee.nInsPaid = nGroup1InsCost;
				fee.nDiscount = nGroup1Discount;
				fee.nDiffPaid = nGroup1DiffPaid;
				fee.nPatPaid = nGroup1PatPaid;
				feeList.Add(fee);
			}
			nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
			nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;

			nIndex++;
		}



		grs.MoveNext();
	}

	nTotalCost = ceil(nTotalCost);
	nTotalInsCost = ceil(nTotalInsCost);
	nTotalDiscount = ceil(nTotalDiscount);
	nTotalDiffPaid = ceil(nTotalDiffPaid);
	nTotalPatPaid = ceil(nTotalPatPaid);
	nTotalPayable = nTotalCost - nTotalDiscount;
	nTotalDiscount = nTotalDiscount;

	TranslateString(_T("Total Amount"), szName);
	fee.szGroupID = _T("TotalAmount");
	fee.szName.Format(_T("%s "), szName);
	fee.nCost = nTotalCost;
	fee.nInsPaid = nTotalInsCost;
	fee.nDiscount = nTotalDiscount;
	fee.nDiffPaid = nTotalDiffPaid;
	fee.nPatPaid = nTotalPatPaid;
	feeList.Add(fee);

	nSumCost += nTotalCost;
	nSumInsCost += nTotalInsCost;
	nSumDiscount += nTotalDiscount;
	nSumDiffPaid += nTotalDiffPaid;
	nSumPatPaid += nTotalPatPaid;


	for (int i = 0; i < feeList.GetCount(); i++) {
		fee = feeList[i];
		szType = fee.szGroupID;

		if (szType == _T("Type"))
		{
			grp = rpt.GetGroupHeader(1);
			rptDetail = rpt.AddDetail(grp);
			tmpStr = fee.szID;
			rptDetail->SetValue(_T("TypeID"), tmpStr);
			StringUpper(fee.szName, tmpStr);
			rptDetail->SetValue(_T("TypeName"), tmpStr);
		}
		else if (szType == _T("Group")) {
			grp = rpt.GetGroupHeader(1);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("TypeID"), fee.szID);
			rptDetail->SetValue(_T("TypeName"), fee.szName);
		}
		else if (szType == _T("SubGroup")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("SubGroupID"), fee.szID);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);


			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}
		}
		else if (szType == _T("SubAmount")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			CReportItem* obj;
			obj = rptDetail->GetItem(_T("SubGroupName")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupCost")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupDiscount")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupPatpaid")); if (obj) obj->SetBold(true);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);


			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}

		}
		else if (szType == _T("GrandAmount")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			//	rptDetail->GetItem(_T("SubGroupName"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupCost"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupDiscount"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupPatpaid"))->SetBold(true);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}

		}

		else if (szType == _T("Item")) {
			rptDetail = rpt.AddDetail();
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), fee.szUnit);
			FormatCurrency(fee.nQuantity, tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), tmpStr);

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}

		}
		else if (szType == _T("SubItemGroup")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj)
				{
					obj->SetItalic(true);
					obj->SetBold(true);
				}

			}
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), _T(""));
			rptDetail->SetValue(_T("4"), _T(""));
			rptDetail->SetValue(_T("5"), _T(""));

		}

		else if (szType == _T("SubItem")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj) obj->SetItalic(true);
			}

			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), fee.szUnit);
			FormatCurrency(fee.nQuantity, tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), tmpStr);

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}

		}
		else if (szType == _T("SubItemAmount")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj)
				{
					obj->SetItalic(true);
					obj->SetBold(true);
				}

			}
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), _T(""));
			rptDetail->SetValue(_T("4"), _T(""));
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), _T(""));

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}

		}

		else if (szType == _T("Dousage")) {
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(4));
			rptDetail->SetValue(_T("usage"), fee.szName);
		}
		else if (szType == _T("TotalAmount")) {
			grp = rpt.GetGroupHeader(3);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("TotalAmountLabel"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("TotalAmount"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("TotalInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("TotalDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("TotalDiffPaid"), tmpStr);
			//fee.nPatPaid= fee.nCost-fee.nDiscount;
			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("TotalPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("TotalInsUnPaid"), tmpStr);
			}
		}
	}


	if (nTotalCost != nSumCost) {
		CString szName;
		TranslateString(_T("Total Amount"), tmpStr);
		szName.Format(_T("%s"), tmpStr);
		grp = rpt.GetGroupHeader(3);
		rptDetail = rpt.AddDetail(grp);
		rptDetail->SetValue(_T("TotalAmountLabel"), szName);
		FormatCurrency(nSumCost, tmpStr);
		rptDetail->SetValue(_T("TotalAmount"), tmpStr);

		FormatCurrency(nSumInsCost, tmpStr);
		rptDetail->SetValue(_T("TotalInsCost"), tmpStr);

		FormatCurrency(nSumDiscount, tmpStr);
		rptDetail->SetValue(_T("TotalDiscount"), tmpStr);

		FormatCurrency(nSumDiffPaid, tmpStr);
		rptDetail->SetValue(_T("TotalDiffPaid"), tmpStr);
		FormatCurrency(nSumPatPaid, tmpStr);
		rptDetail->SetValue(_T("TotalPatPaid"), tmpStr);
	}

	szSQL.Format(_T(" SELECT coalesce(sum(hfe_amount),0) as amount,") \
		_T("   coalesce(sum(hfe_inspaid), 0) as inspaid,") \
		_T("   coalesce(sum(hfe_discount), 0) as discount,") \
		_T("   coalesce(sum(hfe_patpaid), 0) as patpaid,") \
		_T("   coalesce(sum(hfe_payment), 0) as payment,") \
		_T("   coalesce(sum(hfe_diffcost), 0) as diffcost,") \
		_T("   coalesce(sum(hfe_deposit), 0) as deposit,") \
		_T("   coalesce(sum(hfe_refund), 0) as refund,") \
		_T("   coalesce(sum(hfe_freeamount), 0) as freeamount ") \
		_T(" FROM hms_fee_invoice") \
		_T(" WHERE hfe_docno=%ld and hfe_invoiceno > 0 and hfe_status='P' "), nDocumentNo);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		double nTotalDiffPaid;
		double nTotalPayment;
		double nTotalPatPaid;

		rs.GetValue(_T("amount"), nTotalCost);
		rs.GetValue(_T("inspaid"), nTotalInsCost);
		rs.GetValue(_T("discount"), nTotalDiscount);
		rs.GetValue(_T("patpaid"), nTotalPatPaid);
		rs.GetValue(_T("diffcost"), nTotalDiffPaid);
		rs.GetValue(_T("deposit"), nTotalDeposit);
		rs.GetValue(_T("refund"), nTotalRefund);
		rs.GetValue(_T("freeamount"), nTotalFree);
		rs.GetValue(_T("payment"), nTotalPayment);




		rpt.GetReportFooter()->SetValue(_T("PatientSign"), szPatientName);
		FormatCurrency((nTotalCost), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumAmount"), tmpStr);
		CString szSumInWord;
		tmpStr.Format(_T("%.0f"), nTotalCost);
		MoneyToString(tmpStr, szSumInWord);
		szSumInWord += _T(" \x111\x1ED3ng.");
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), szSumInWord);

		FormatCurrency(nTotalInsCost, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumInsCost"), tmpStr);


		FormatCurrency(nTotalDiscount, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumInsDiscount"), tmpStr);

		FormatCurrency(nTotalPatPaid, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumInsUnPaid"), tmpStr);

		FormatCurrency((nTotalDiffPaid), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumDiffPaid"), tmpStr);


		FormatCurrency(nTotalPatPaid, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumPatPaid"), tmpStr);



		FormatCurrency((nTotalDeposit), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumDeposit"), tmpStr);

		FormatCurrency(nTotalFree, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumDiscount"), tmpStr);

		FormatCurrency(nSumFoodAmount, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumFoodAmount"), tmpStr);

		if (nTotalRefund > 0)
		{
			//	FormatCurrency(nTotalRefund, tmpStr);
			//	rpt.GetReportFooter()->SetValue(_T("SumPayment"), tmpStr);

			FormatCurrency(nTotalRefund, tmpStr);
			rpt.GetReportFooter()->SetValue(_T("SumRefund"), tmpStr);
		}
		else
		{
			FormatCurrency(nTotalPayment, tmpStr);
			rpt.GetReportFooter()->SetValue(_T("SumPayment"), tmpStr);

		}

	}
	rpt.PrintPreview();
}





void CPrintForms::FM_PrintInsuranceDischargePaymentInvoice(long nDocumentNo, long nInvoiceNo)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	//	if (!pMF->IsInPatient())
	//		return;

	CReport rpt;
	CString tmpStr, szSQL, szWhere, szAdmitDate, szEndDate, szDepartments, szAddonedayoutofhospital, szNumbertreat;
	CRecord rs(&pMF->m_db);
	CRecord rsd(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rsx(&pMF->m_db);
	int		nDeskNo = 0;
	CString szRecvDate;
	CString	szObjectType;
	CString	szDescription;
	CString szPrintMaterialOperation = _T("Y");
	CString	szOutPatient;


	double	nTotalCost = 0,				//Tong chi phi
		nTotalInsCost = 0,
		nTotalDiscount = 0,			//Tong Mien giam
		nTotalPatPaid = 0,			//Tong benh nhan tra
		nTotalDiffPaid = 0,	//Tong so tra chenh lech
		nTotalPayable = 0,
		nTotalDeposit = 0,			//Tong tam ung
		nTotalFree = 0,				//Tong mien phi
		nTotalRefund = 0,				//Tong hoan tra
		nDepositPayable = 0,			//So tien tra tu tam ung
		nTotalPayment = 0;


	double nSumFoodAmount = 0;


	szWhere.AppendFormat(_T(" and hfe_invoiceno=%ld "), nInvoiceNo);

	szSQL.Format(_T(" SELECT *") \
		_T(" FROM") \
		_T(" (") \
		_T("  SELECT hd_patientno as patientno,") \
		_T("         hd_docno as docno,") \
		_T("         trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T("         hp_birthdate as birthdate,") \
		_T("         hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age,") \
		_T("         extract(year from hp_birthdate) as yearofbirth, ") \
		_T("         Get_Selection_Desc('sys_sex', hp_sex) as sex,") \
		_T("         hp_sex as sex_id,") \
		_T("         hp_ethnic as ethnic,") \
		_T("         Get_Selection_Desc('sys_ethnic', hp_ethnic) as ethnicdesc, ") \
		_T("         nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T("         hms_getaddress(hp_provid,hp_distid, hp_villid) as address,") \
		_T("         hp_workplace as workplace,") \
		_T("		 hd_rank as rank, ") \
		_T("		 get_selection_desc('hms_rank', hd_rank) as rankname, ") \
		_T("         hd_doctor as doctor,") \
		_T("         hd_createdby as createdby,") \
		_T("         hd_icd as icd10,") \
		_T("         hd_diagnostic as diagnostic,") \
		_T("         hd_reldisease as reldisease,") \
		_T("         hd_xobject as xobject, ") \
		_T("         hd_xcardno as xcardno, ") \
		_T("         hd_xissuedate as xissuedate, ") \
		_T("         hd_emergency as emergency, ") \
		_T("         Get_Selection_Desc('hms_result',hd_result) as result,") \
		_T("         hd_admitdate as examdate,") \
		_T("         hd_enddate as enddate,") \
		_T("		 hd_outpatient, ") \
		_T("         hcr_recordno as recordno ,") \
		_T("         htr_admitdate as admitdate,") \
		_T("         htr_dischargedate as dischargedate,") \
		_T("         hcr_sumtreat as TreatmentDay,") \
		_T("         hcr_mainicd as mainicd ,") \
		_T("         hcr_maindisease as maindisease ,") \
		_T("         hcr_treatdoctor as treatdoctor, ") \
		_T("         hcr_reldisease as ireldisease,") \
		_T("         hcr_suggestion as isuggestion,") \
		_T("         hd_suggestion as esuggestion,") \
		_T("         Get_Selection_Desc('hms_result' ,hcr_result)  as iresult,") \
		_T("         Hms_GetObjectType(hd_object) as objecttype, ") \
		_T("         cast(hd_disrate as integer) as disrate, ") \
		_T("         hd_insline as insline, ") \
		_T("         hd_insregdate as insregdate, ") \
		_T("         hd_transplace as transplace, ") \
		_T("         hc_cardno as cardno, ") \
		_T("         hc_regdate as regdate, ") \
		_T("         hc_expdate as expdate, ") \
		_T("         hc_regcode as regcode, ") \
		_T("         HMS_GETHOSPITALNAME(hc_regcode) as regplace, ") \
		_T("         hfe_deptid as deptid,") \
		_T("         hfe_serialno as serialno,") \
		_T("         hfe_receiptno as recvno,") \
		_T("         hfe_date as recvdate, ") \
		_T("         hfe_staff as receiver,") \
		_T("         hfe_desc as reason,") \
		_T("         hfe_amount as cost,") \
		_T("         hfe_discount as discount,") \
		_T("         hfe_patpaid as patpaid,") \
		_T("         hfe_deposit as deposit_amount, ") \
		_T("         hfe_payment as payment_amount,") \
		_T("         hfe_refund as refund_amount, ") \
		_T("         hfe_freeamount as free_amount,") \
		_T("         hfe_eat_amount as food_amount,") \
		_T(" hfe_admitdate, hfe_dischargedate,hfe_treattime, ") \
		_T("         row_number() over (partition by hd_docno order by hd_docno) as dn") \
		_T(" FROM hms_fee_invoice ") \
		_T(" LEFT JOIN hms_doc ON(hd_docno=hfe_docno)") \
		_T(" LEFT JOIN hms_patient ON(hp_patientno=hd_patientno)") \
		_T(" LEFT JOIN hms_clinical_record ON(hcr_docno=hd_docno) ") \
		_T(" LEFT JOIN hms_treatment_record ON(hfe_docno=htr_docno) ") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hfe_docno=%ld %s ") \
		_T(" ) Tbl") \
		_T(" WHERE dn=1"), nDocumentNo, szWhere);

	_fmsg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		return;
	}

	rs.GetValue(_T("cost"), nTotalCost);
	rs.GetValue(_T("discount"), nTotalDiscount);
	rs.GetValue(_T("patpaid"), nTotalPatPaid);
	rs.GetValue(_T("deposit_amount"), nTotalDeposit);
	rs.GetValue(_T("free_amount"), nTotalFree);
	rs.GetValue(_T("refund_amount"), nTotalRefund);
	rs.GetValue(_T("paymennt_amount"), nTotalPayment);
	rs.GetValue(_T("reason"), szDescription);
	rs.GetValue(_T("deskno"), nDeskNo);

	rs.GetValue(_T("food_amount"), nSumFoodAmount);

	rs.GetValue(_T("objecttype"), szObjectType);

	//rs.GetValue(_T("hd_outpatient"), szOutPatient);

	int tmpInt = 0;
	rs.GetValue(_T("hfe_treattime"), tmpInt);
	szSQL.Format(_T("select nvl(htr_outpatient,'N') as outpatientx  ") \
		_T(" from  hms_treatment_record where htr_docno=%ld and htr_treattime = %d and rownum <=1 order by htr_idx desc "), nDocumentNo, tmpInt);
	rs2.ExecSQL(szSQL);
	szOutPatient = rs2.GetStringValue();

	if (szOutPatient == _T("Y"))
	{
		if (!rpt.Init(_T("Reports/HMS/HF_INSDISCHARGEPAYMENTOUT.RPT"), true))
			return;
	}
	else
	{
		if (!rpt.Init(_T("Reports/HMS/HF_INSDISCHARGEPAYMENT.RPT"), true))
			return;
	}

	//Report Header
	tmpStr.Empty();
	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	tmpStr.Format(_T("%s-%s-%s"), rs.GetValue(_T("serialno")), rs.GetValue(_T("bookno")), rs.GetValue(_T("recvno")));
	rpt.GetReportHeader()->SetValue(_T("ReceiptNo"), tmpStr);
	tmpStr.Format(_T("%ld"), nInvoiceNo);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);


	CString szDate;
	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);


	rs.GetValue(_T("recordno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RecordNo"), tmpStr);
	//rs.GetValue(_T("pname"), tmpStr);


	CString szPatientName;
	StringUpper(rs.GetValue(_T("pname")), szPatientName);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), szPatientName);
	rs.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	rs.GetValue(_T("yearofbirth"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("birthdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("BirthDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);

	rs.GetValue(_T("sex_id"), tmpStr);
	if (tmpStr == _T("F"))
		rpt.GetReportHeader()->SetValue(_T("Female"), _T("X"));
	else
		rpt.GetReportHeader()->SetValue(_T("Male"), _T("X"));


	rs.GetValue(_T("ethnic"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ethnic"), tmpStr);
	rs.GetValue(_T("ethnicdesc"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ethnicdesc"), tmpStr);

	rs.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);


	rs.GetValue(_T("rankname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RankName"), tmpStr);

	CString szAddress;
	rs.GetValue(_T("detailaddress"), tmpStr);
	szAddress = tmpStr;
	rs.GetValue(_T("address"), tmpStr);
	if (!szAddress.IsEmpty())
		szAddress += _T(" - ");
	szAddress += tmpStr;
	rpt.GetReportHeader()->SetValue(_T("Address"), szAddress);


	rs.GetValue(_T("transplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TransferHospital"), tmpStr);


	rs.GetValue(_T("rankame"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Rank"), tmpStr);

	rs.GetValue(_T("objecttype"), szObjectType);



	rs.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr.Left(15));
	if (!tmpStr.IsEmpty())
	{
		rpt.GetReportHeader()->SetValue(_T("HasCardNo"), _T("X"));
	}
	else
	{
		rpt.GetReportHeader()->SetValue(_T("NoCardNo"), _T("X"));
	}

	rs.GetValue(_T("disrate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Insrate"), tmpStr);


	rs.GetValue(_T("insline"), tmpStr);
	if (tmpStr == _T("Y"))
	{
		rpt.GetReportHeader()->SetValue(_T("InsLine"), _T("X"));
		rpt.GetReportHeader()->SetValue(_T("NotInsLine"), _T(""));
	}
	else
	{
		rpt.GetReportHeader()->SetValue(_T("InsLine"), _T(""));
		rpt.GetReportHeader()->SetValue(_T("NotInsLine"), _T("X"));
	}

	rs.GetValue(_T("insregdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InsRegDate"), CDate::Convert(tmpStr));


	rs.GetValue(_T("regdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("expdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExpiryDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs.GetValue(_T("regplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegistrationPlace"), tmpStr);


	CString szRegCode;
	rs.GetValue(_T("regcode"), szRegCode);
	rpt.GetReportHeader()->SetValue(_T("RegCode"), szRegCode);

	CReportItem* obj = rpt.GetReportHeader()->GetItem(_T("InsuranceCompany"));
	if (obj)
	{
		CString insname;
		CRecord rsx(&pMF->m_db);

		tmpStr.Format(_T("select sp_name as insname ") \
			_T("from sys_prov left join hms_hospital on(hh_provid=sp_id or hh_newprov_id=sp_id) where trim(hh_id)=trim('%s') "), szRegCode);
		rsx.ExecSQL(tmpStr);
		if (!rsx.IsEOF())
		{
			rsx.GetValue(_T("insname"), tmpStr);
			rpt.GetReportHeader()->Format(_T("InsuranceCompany"), tmpStr);
		}
	}

	rs.GetValue(_T("emergency"), tmpStr);
	if (tmpStr == _T("Y"))
	{
		tmpStr = _T("X");
		rpt.GetReportHeader()->SetValue(_T("InsLine"), _T(""));
		rpt.GetReportHeader()->SetValue(_T("NotInsLine"), _T(""));
	}
	else
		tmpStr.Empty();

	rpt.GetReportHeader()->SetValue(_T("Emergency"), tmpStr);

	rs.GetValue(_T("maindisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	rs.GetValue(_T("ireldisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RelationDisease"), tmpStr);
	rs.GetValue(_T("mainicd"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ICD10"), tmpStr);
	rs.GetValue(_T("iresult"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Result"), tmpStr);
	rs.GetValue(_T("isuggestion"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Suggestion"), pMF->GetSelectionString(_T("hms_suggestion"), tmpStr));



	CString szDischargeDate;
	rs.GetValue(_T("hfe_admitdate"), szAdmitDate);
	rs.GetValue(_T("hfe_dischargedate"), szDischargeDate);
	//_msg(_T("%s: %s"), szAdmitDate, szDischargeDate);
	if (szAdmitDate.IsEmpty() && szDischargeDate.IsEmpty())
	{
		rs.GetValue(_T("admitdate"), tmpStr);

		rpt.GetReportHeader()->SetValue(_T("admitdate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));

		rs.GetValue(_T("dischargedate"), tmpStr);
		szDischargeDate = tmpStr;

		if (szDischargeDate.Left(4) != _T("1752"))
			rpt.GetReportHeader()->SetValue(_T("dischargedate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));
		else
			rpt.GetReportHeader()->SetValue(_T("dischargedate"), _T(""));
	}
	else
	{
		rpt.GetReportHeader()->SetValue(_T("admitdate"), CDateTime::Convert(szAdmitDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));
		rpt.GetReportHeader()->SetValue(_T("dischargedate"), CDateTime::Convert(szDischargeDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));
	}


	rs.GetValue(_T("TreatmentDay"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TreatmentDay"), tmpStr);

	CString szData;
	tmpStr.Format(_T("%s-%s-%s"), rs.GetValue(_T("bookno")), rs.GetValue(_T("serialno")), rs.GetValue(_T("recvno")));
	rpt.GetReportFooter()->SetValue(_T("SerialNo"), tmpStr);
	rs.GetValue(_T("recvdate"), szRecvDate);
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate"), CDateTime::Convert(szRecvDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));
	szData.Format(rpt.GetReportFooter()->GetValue(_T("ReceiptDate1")), szRecvDate.Mid(11, 5), szRecvDate.Mid(8, 2), szRecvDate.Mid(5, 2), szRecvDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate1"), szData);
	szData.Format(rpt.GetReportFooter()->GetValue(_T("ReceiptDate2")), szRecvDate.Mid(11, 5), szRecvDate.Mid(8, 2), szRecvDate.Mid(5, 2), szRecvDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate2"), szData);

	rs.GetValue(_T("treatdoctor"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("Doctor"), GetDoctorName(tmpStr));

	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{
		img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img->SetFixedHeight(true);
	}
	tmpStr.Empty();
	rs.GetValue(_T("receiver"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("ReceiverBy"), GetDoctorName(tmpStr));
	CReportItem* img2 = rpt.GetReportFooter()->GetItem(_T("Signature2"));
	if (img2)
	{
		img2->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img2->SetFixedHeight(false);
	}


	// Nguoi tiep don
	tmpStr.Empty();
	rs.GetValue(_T("createdby"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("createdby"), GetDoctorName(tmpStr));
	CReportItem* img3 = rpt.GetReportFooter()->GetItem(_T("Signature3"));
	if (img3)
	{
		img3->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img3->SetFixedHeight(false);
	}


	CReportSection* rptDetail = NULL;
	CReportSection* grp;
	CRecord grs(&pMF->m_db);
	CString szFeeID, szID;
	CString szSubItem, szType;

	TCHAR* lpszChapter[] = { _T("I"), _T("II"), _T("III"), _T("IV"), _T("V"), _T("VI"), _T("VII"), _T("VIII"), _T("IX"), _T("X"), _T("XI") };


	CRecord drs(&pMF->m_db);
	CString szDeptID;

	CArray<RECEIPTINFO, RECEIPTINFO& > payInfo;

	szSQL.Format(_T(" SELECT deptid, admitdate, dischargedate, mainicd, maindisease") \
		_T(" FROM") \
		_T(" (") \
		_T("  select htr_deptid as deptid,") \
		_T("         htr_admitdate as admitdate,") \
		_T("         htr_dischargedate as dischargedate,") \
		_T("         htr_mainicd as mainicd,") \
		_T("         htr_maindisease as maindisease,") \
		_T("         htr_idx as idx") \
		_T("  from hms_treatment_record") \
		_T("  where htr_docno=%ld") \
		_T("  union all") \
		_T("  select hd_admitdept,") \
		_T("         hd_admitdate,") \
		_T("         hd_enddate,") \
		_T("         hd_icd,") \
		_T("         hd_diagnostic,") \
		_T("         0") \
		_T("  from hms_doc") \
		_T("  where hd_docno=%ld") \
		_T(" ) tbl") \
		_T(" WHERE deptid in(select distinct hfe_deptid from hms_fee where hfe_invoiceno=%ld)") \
		_T(" ORDER BY idx"), nDocumentNo, nDocumentNo, nInvoiceNo);

	drs.ExecSQL(szSQL);

	RECEIPTINFO pi;
	CString szDepts;
	szDepts.Empty();

	while (!drs.IsEOF())
	{
		drs.GetValue(_T("deptid"), tmpStr);

		bool bFound = false;
		int i = 0;
		for (i = 0; i < payInfo.GetCount(); i++)
		{
			pi = payInfo[i];
			if (pi.deptid == tmpStr)
			{
				bFound = true;
				break;
			}
		}
		pi.deptid = tmpStr;
		if (!szDepts.IsEmpty())
			szDepts += _T(",  ");
		szDepts.AppendFormat(_T("%s"), tmpStr);

		drs.GetValue(_T("dischargedate"), pi.dischargedate);
		drs.GetValue(_T("mainicd"), pi.mainicd);
		drs.GetValue(_T("maindisease"), pi.maindisease);

		if (bFound)
		{
			payInfo.SetAt(i, pi);
		}
		else
		{
			drs.GetValue(_T("admitdate"), pi.admitdate);
			payInfo.Add(pi);

		}

		drs.MoveNext();
	}

	rpt.GetReportHeader()->SetValue(_T("Department"), szDepts);


	int nInsRate;
	rs.GetValue(_T("disrate"), nInsRate);
	if (nInsRate > 0)
	{
		int nUnRate = 100 - nInsRate;
		if (nUnRate == 0)
			nUnRate = nInsRate;

		tmpStr.Format(_T("(%d%s)"), nUnRate, _T("%"));
		rpt.GetReportFooter()->SetValue(_T("UnRate"), tmpStr);
	}



	double nSumCost = 0, nSumInsCost = 0, nSumDiscount = 0, nSumDiffPaid = 0, nSumPatPaid = 0;

	szDepts.Empty();


	int nChapter = 0;
	int nCount = 0, nIndex, nChapterID = 0;
	int nItem = 0, nOldItem = 0, nItem2 = 0;
	bool bDeleteParent = false;
	bool bLoadItems = false;
	CString szNewGroup, szOldGroup, szParentGroup;


	double nGroup0Cost = 0, nGroup0InsCost = 0, nGroup0Discount = 0, nGroup0DiffPaid = 0, nGroup0PatPaid = 0;
	double nGroup1Cost = 0, nGroup1InsCost = 0, nGroup1Discount = 0, nGroup1DiffPaid = 0, nGroup1PatPaid = 0;
	double nGroup2Cost = 0, nGroup2InsCost = 0, nGroup2Discount = 0, nGroup2DiffPaid = 0, nGroup2PatPaid = 0;
	double nCost = 0, nInsCost = 0, nDiscount = 0, nDiffPaid = 0, nPatPaid = 0;


	nTotalCost = nTotalDiffPaid = nTotalInsCost = nTotalPatPaid = nTotalDiscount = 0;

	szSQL.Format(_T("SELECT * FROM hms_fee_type ORDER BY hft_id "));
	grs.ExecSQL(szSQL);

	szWhere.Format(_T(" AND (hfe_invoiceno=%ld ) "), nInvoiceNo);

	if (szOutPatient != _T("Y"))
		szWhere.AppendFormat(_T(" and hfe_groupid <>'D0000' "));
	szWhere.AppendFormat(_T(" and hfe_class in('E', 'I','X','A') "));
	//	szWhere.AppendFormat(_T(" and hfe_subgroup='XX' "));
	szWhere.AppendFormat(_T(" and (hfe_category <> 'Y' or hfe_category is null) "));

	szWhere.AppendFormat(_T(" and hfe_object not in(7) "));

	//	szWhere.AppendFormat(_T(" and hfe_feegroup not in('OPT','OPT_L','HITECH','HITECH_L') "));

	szSQL.Format(_T(" SELECT hfe_typeindex AS typeindex,") \
		_T("   hfe_status         AS status,") \
		_T("   hfe_type           AS feetype,") \
		_T("   hfe_groupid        AS groupid,") \
		_T("   hfe_groupid3       AS groupid3,") \
		_T("	hfe_feegroup as feegroup, ") \
		_T("   hfe_itemid         AS itemid,") \
		_T("   hfe_name           AS name,") \
		_T("   hfe_unit           AS unit,") \
		_T("   hfe_hitech         AS hitech,") \
		_T("   hfe_inlist         AS inlist,") \
		_T("   hfe_unitprice      AS unitprice,") \
		_T("   SUM(hfe_quantity)       AS qty,") \
		_T("   SUM(hfe_amount)      AS cost,") \
		_T("   SUM(hfe_discount)  AS discount,") \
		_T("   SUM(hfe_diffpaid)  AS DiffPaid,") \
		_T("   SUM(hfe_copayment) AS copayment,") \
		_T("   SUM(hfe_patpaid)   AS patpaid") \
		_T(" FROM hms_fee_invoiceline_view ") \
		_T(" WHERE hfe_docno  =%ld %s ") \
		_T(" and hfe_feegroup not in('OPT','OPT_L','HITECH','HITECH_L')  ") \
		_T(" GROUP BY hfe_typeindex,") \
		_T("   hfe_status ,") \
		_T("   hfe_type ,") \
		_T("   hfe_groupid ,") \
		_T("   hfe_groupid3 ,") \
		_T(" hfe_feegroup, ") \
		_T("   hfe_itemid ,") \
		_T("   hfe_name ,") \
		_T("   hfe_unit ,") \
		_T("   hfe_hitech ,") \
		_T("   hfe_inlist,") \
		_T("   hfe_unitprice") \
		_T(" ORDER BY hfe_typeindex, hfe_inlist, hfe_groupid3, hfe_inlist, hfe_name, hfe_unit, hfe_unitprice"),
		nDocumentNo, szWhere);

	//	_msg(_T("%s"), szSQL);		

	nIndex = 1;
	int nSubItem = 1;
	int nIDX;
	nChapterID = 0;
	CArray<FEEITEM, FEEITEM&> feeList;
	FEEITEM fee;
	CString szName;
	CString szNewIndex, szOldIndex;
	CString szIndex;
	bool bFound = false;
	bool bInList = false;
	bool bOutList = false;
	bool bKList = false;
	int nSubIndex = 1;
	int nLineIndex = 0;
	int nNumberTreat = 0;

	double nTtlCost = 0, nTtlInsCost = 0, nTtlDiscount = 0, nTtlDiffPaid = 0, nTtlPatPaid = 0;
	rs.ExecSQL(szSQL);
	//_fmsg(_T("%s"), szSQL);


	while (!grs.IsEOF()) {
		tmpStr.Format(_T("%d"), nIndex);
		grs.GetValue(_T("hft_name"), szName);
		grs.GetValue(_T("hft_id"), szNewIndex);

		fee.szGroupID = _T("Type");
		fee.szID = tmpStr;
		fee.szName = szName;
		nItem = feeList.Add(fee);

		nIDX = nItem;
		bFound = false;
		nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
		nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;

		rs.MoveFirst();
		while (!rs.IsEOF())
		{
			rs.GetValue(_T("typeindex"), tmpStr);

			if (tmpStr == szNewIndex) {
				bFound = true;
				rs.GetValue(_T("groupid"), szNewGroup);
				if (szNewGroup != szOldGroup)
				{

					szOldGroup = szNewGroup;
					/*
					if(szNewGroup.Left(2) == _T("B1") ){
						szSQL.Format(_T("SELECT hfg_name FROM hms_fee_group WHERE rtrim(hfg_id,'0')='%s' "), szNewGroup);
						CRecord rs2(&pMF->m_db);
						rs2.ExecSQL(szSQL);
						if(nGroup2Cost+nGroup2DiffPaid > 0){
							TranslateString(_T("Sub Amount"), tmpStr);
							fee.szGroupID = _T("SubAmount");
							fee.szName = tmpStr;
							fee.nCost = nGroup2Cost;
							fee.nInsPaid = nGroup2InsCost;
							fee.nDiscount = nGroup2Discount;
							fee.nDiffPaid = nGroup2DiffPaid;
							fee.nPatPaid = nGroup2PatPaid;
							int nItem2 = feeList.Add(fee);
						}

						szIndex.Format(_T("%d.%d"), nIndex, nSubIndex++);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = rs2.GetValue(_T("hfg_name"));
						int nItem2 = feeList.Add(fee);
						nGroup2Cost=nGroup2InsCost=nGroup2Discount=nGroup2DiffPaid=nGroup2PatPaid=0;

					}

					*/


				}

				if (szOldIndex != szNewIndex)
				{
					szOldIndex = szNewIndex;
					bInList = false;
					bOutList = false;
				}



				if (szNewIndex == _T("800")) {


					rs.GetValue(_T("inlist"), tmpStr);

					if (tmpStr == _T("1") && !bInList) {
						bInList = true;
						TranslateString(_T("Inside insurance list"), tmpStr);
						szIndex.Format(_T("%d.1"), nIndex);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = tmpStr;
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nDiffPaid = 0;
						fee.nPatDebt = 0;

						int nItem2 = feeList.Add(fee);

					}
					if (tmpStr == _T("2") && !bOutList) {
						bOutList = true;
						TranslateString(_T("Outside insurance list"), tmpStr);
						if (bInList)
							szIndex.Format(_T("%d.2"), nIndex);
						else
							szIndex.Format(_T("%d.1"), nIndex);

						szIndex.Format(_T("%d.1"), nIndex);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = tmpStr;
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nDiffPaid = 0;
						fee.nPatDebt = 0;
						int nItem2 = feeList.Add(fee);
					}

					if (tmpStr == _T("3") && !bKList) {
						bKList = true;
						if (bInList && bOutList)
							szIndex.Format(_T("%d.3"), nIndex);
						else if (bInList || bOutList)
							szIndex.Format(_T("%d.2"), nIndex);
						else
							szIndex.Format(_T("%d.1"), nIndex);

						TranslateString(_T("Inside cancer list"), tmpStr);
						szIndex.Format(_T("%d.1"), nIndex);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = tmpStr;
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nDiffPaid = 0;
						fee.nPatDebt = 0;
						int nItem2 = feeList.Add(fee);
					}


				}

				if (szNewIndex == _T("900")) {

					rs.GetValue(_T("inlist"), tmpStr);

					if (tmpStr == _T("1") && !bInList) {
						bInList = true;
						TranslateString(_T("Inside insurance list"), tmpStr);
						szIndex.Format(_T("%d.1"), nIndex);
						szIndex.Format(_T("%d.1"), nIndex);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = tmpStr;
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nDiffPaid = 0;
						fee.nPatDebt = 0;
						int nItem2 = feeList.Add(fee);
					}
					if (tmpStr == _T("2") && !bOutList) {
						bOutList = true;
						TranslateString(_T("Outside insurance list"), tmpStr);
						if (!bInList)
							szIndex.Format(_T("%d.1"), nIndex);
						else
							szIndex.Format(_T("%d.2"), nIndex);

						szIndex.Format(_T("%d.1"), nIndex);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = tmpStr;
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nDiffPaid = 0;
						fee.nPatDebt = 0;
						int nItem2 = feeList.Add(fee);
					}
				}


				//IN CHI PHI PHAU THUAT KY THUAT CAO
				CString szFeeGroup;
				rs.GetValue(_T("feegroup"), szFeeGroup);
				if (szFeeGroup == _T("HITECH") || szFeeGroup == _T("HITECH_L"))
				{
					CString szItemID;
					CString tmpStr;
					CString szOptGroup;


					int nCount = 0;
					double nTtlCost = 0, nCostA = 0, nCostB = 0;
					double nTtlDiffCost = 0;
					double nOptDiffCost = 0;
					double nTtlInsPaid = 0;
					double nAmount = 0;

					if (szFeeGroup == _T("HITECH"))
						szOptGroup = _T("OPT");
					else
						szOptGroup = _T("OPT_L");

					rs.GetValue(_T("itemid"), szItemID);
					rs.GetValue(_T("cost"), nTtlCost);
					rs.GetValue(_T("diffpaid"), nTtlDiffCost);
					nOptDiffCost = nTtlDiffCost;
					rs.GetValue(_T("discount"), nAmount);
					nTtlInsPaid += nAmount;


					fee.szID.Format(_T("%d"), nLineIndex++);
					fee.szGroupID = _T("Item");
					fee.szName = rs.GetValue(_T("name"));
					fee.szUnit = rs.GetValue(_T("unit"));
					fee.nCost = nTtlCost;
					fee.nInsPaid = 0;
					fee.nDiscount = 0;
					fee.nQuantity = str2float(rs.GetValue(_T("qty")));
					fee.nPrice = str2double(rs.GetValue(_T("unitprice")));
					fee.nInsPrice = str2double(rs.GetValue(_T("insprice")));
					fee.nDiffPaid = str2double(rs.GetValue(_T("diffpaid")));
					fee.nDiscount = str2double(rs.GetValue(_T("discount")));
					fee.nPatPaid = 0;
					feeList.Add(fee);


					szSQL.Format(_T("SELECT hfe_desc as hfe_name, hfe_unit, hfe_unitprice, sum(hfe_quantity) as hfe_quantity, sum(hfe_inspaid) as hfe_cost, sum(hfe_discount) as hfe_discount, sum(hfe_diffpaid) as hfe_diffpaid ") \
						_T(" FROM hms_fee ") \
						_T(" WHERE hfe_docno=%ld and hfe_type in('D','M') ") \
						_T(" and hfe_feegroup IN('%s') and hfe_subgroup='%s' and hfe_discount > 0 ")\
						_T(" and hfe_category <> 'Y' ") \
						_T(" GROUP BY hfe_desc, hfe_unit, hfe_unitprice ") \
						_T(" ORDER BY hfe_desc "),
						nDocumentNo, szOptGroup, szItemID);
					rsl.ExecSQL(szSQL);

					int n = 1;
					if (rsl.GetRecordCount() > 0)
					{
						//						nItem = pList->AddItems(_T("a."), _T("Trong \x64\x61nh m\x1EE5\x63 \x42HYT"), NULL);
						//						pList->MergeCell(nItem, 1, nItem, 8, DT_LEFT|DT_VCENTER|DT_SINGLELINE, false, true);
						//						pList->SetItemBkColor(nItem, RGB(220, 220, 220), FALSE);

						fee.szID.Format(_T("a."));
						fee.szGroupID = _T("SubItemGroup");
						fee.szName.Format(_T("Trong \x64\x61nh m\x1EE5\x63 \x42HYT"));
						fee.szUnit.Empty();
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nQuantity = 0;
						fee.nPrice = 0;
						fee.nInsPrice = 0;
						fee.nDiffPaid = 0;
						fee.nPatPaid = 0;
						feeList.Add(fee);

					}

					while (!rsl.IsEOF())
					{
						//tmpStr.Format(_T("%d.%d - %s"), nIndex2, n++, rsl.GetValue(_T("hfe_name")));
						fee.szID.Empty();
						fee.szGroupID = _T("Item");
						fee.szName.Format(_T("%s"), rsl.GetValue(_T("hfe_name")));
						fee.szUnit = rsl.GetValue(_T("hfe_unit"));
						rsl.GetValue(_T("hfe_cost"), nAmount);
						rsl.GetValue(_T("hfe_diffpaid"), fee.nDiffPaid);
						fee.nPrice = str2double(rsl.GetValue(_T("hfe_unitprice")));
						fee.nInsPrice = str2double(rsl.GetValue(_T("hfe_unitprice")));
						fee.nCost = nAmount;
						fee.nInsPaid = 0;
						fee.nDiscount = str2double(rsl.GetValue(_T("hfe_discount")));
						fee.nQuantity = str2float(rsl.GetValue(_T("hfe_quantity")));
						//fee.nDiffPaid = 0;
						fee.nPatPaid = 0;


						nCostA += nAmount;

						rsl.GetValue(_T("hfe_discount"), nAmount);
						nTtlInsPaid += nAmount;

						rsl.GetValue(_T("hfe_diffpaid"), nAmount);
						fee.nDiffPaid = nAmount;
						nTtlDiffCost += nAmount;

						feeList.Add(fee);

						rsl.MoveNext();
						nCount++;
					}

					if (nCount > 0)
					{
						tmpStr.Format(_T("%.2f"), nCostA);
						/*	nItem = pList->AddItems(_T(""), _T("\x43\x1ED9ng (a)"), _T(""), _T(""), _T(""), tmpStr, NULL);
							pList->MergeCell(nItem, 1, nItem, 4, DT_LEFT|DT_VCENTER|DT_SINGLELINE, false, true);
							pList->SetItemBkColor(nItem, RGB(230, 230, 230), FALSE);*/

						fee.szID.Empty();
						fee.szGroupID = _T("SubItemAmount");
						fee.szName.Format(_T("\x43\x1ED9ng (a)"));
						fee.szUnit.Empty();
						fee.nCost = nCostA;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nQuantity = 0;
						fee.nPrice = 0;
						fee.nInsPrice = 0;
						fee.nDiffPaid = 0;
						fee.nPatPaid = 0;
						feeList.Add(fee);

					}
					nTtlCost += nCostA;


					tmpStr.Format(_T("%.2f"), nTtlCost);



					//nItem = pList->AddItems(_T("+"), _T("T\x1ED5ng \x63hi ph\xED trong quy \x111\x1ECBnh \x42HYT"), _T(""), _T(""), _T(""), tmpStr, NULL);
					//pList->MergeCell(nItem, 1, nItem, 4, DT_LEFT|DT_VCENTER|DT_SINGLELINE, false, true);
					//pList->SetItemBkColor(nItem, RGB(200, 220, 220), FALSE);


					fee.szID.Format(_T("+"));
					fee.szGroupID = _T("SubItemAmount");
					fee.szName.Format(_T("T\x1ED5ng \x63hi ph\xED trong quy \x111\x1ECBnh \x42HYT"));
					fee.szUnit.Empty();
					fee.nCost = nTtlCost;
					fee.nInsPaid = 0;
					fee.nDiscount = 0;
					fee.nQuantity = 0;
					fee.nPrice = 0;
					fee.nInsPrice = 0;
					fee.nDiffPaid = 0;
					fee.nPatPaid = 0;
					feeList.Add(fee);

					//Ngoai danh muc
					szSQL.Format(_T("SELECT hfe_desc as hfe_name, hfe_unit, hfe_unitprice, sum(hfe_quantity) as hfe_quantity, sum(hfe_cost) as hfe_cost ") \
						_T("FROM hms_fee ") \
						_T("WHERE hfe_docno=%ld and hfe_type in('D','M') ") \
						_T("and hfe_feegroup IN('%s') and hfe_subgroup='%s' and hfe_discount <= 0 and hfe_category <> 'Y' ") \
						_T("GROUP BY hfe_desc, hfe_unit, hfe_unitprice ORDER BY hfe_desc "),
						nDocumentNo, szOptGroup, szItemID);
					rsl.ExecSQL(szSQL);


					if (rsl.GetRecordCount() > 0)
					{
						/*nItem = pList->AddItems(_T("b."), _T("Ngo\xE0i \x64\x61nh m\x1EE5\x63 \x42HYT"), NULL);
						pList->MergeCell(nItem, 1, nItem, 8, DT_LEFT|DT_VCENTER|DT_SINGLELINE, false, true);
						pList->SetItemBkColor(nItem, RGB(220, 220, 220), FALSE);*/

						fee.szID.Format(_T("b."));
						fee.szGroupID = _T("SubItemGroup");
						fee.szName.Format(_T("Ngo\xE0i \x64\x61nh m\x1EE5\x63 \x42HYT"));
						fee.szUnit.Empty();
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nQuantity = 0;
						fee.nPrice = 0;
						fee.nInsPrice = 0;
						fee.nDiffPaid = 0;
						fee.nPatPaid = 0;
						feeList.Add(fee);

					}
					nCount = 0;
					while (!rsl.IsEOF())
					{
						/*tmpStr.Format(_T("%d.%d - %s"), nIndex2, n++, rsl.GetValue(_T("hfe_name")));
						nItem = pList->AddItems(
							_T(""),
							tmpStr,
							rsl.GetValue(_T("hfe_unit")),
							rsl.GetValue(_T("hfe_quantity")),
							rsl.GetValue(_T("hfe_unitprice")),
							rsl.GetValue(_T("hfe_cost")),
							_T(""),
							_T(""),
							_T(""),
							_T("subitem"),
							NULL);*/

						fee.szID.Empty();
						fee.szGroupID = _T("Item");
						fee.szName.Format(_T("%s"), rsl.GetValue(_T("hfe_name")));
						fee.szUnit = rsl.GetValue(_T("hfe_unit"));
						rsl.GetValue(_T("hfe_cost"), nAmount);
						fee.nPrice = str2double(rsl.GetValue(_T("hfe_unitprice")));
						fee.nInsPrice = fee.nPrice;
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nQuantity = str2float(rsl.GetValue(_T("hfe_quantity")));
						fee.nDiffPaid = nAmount;
						fee.nPatPaid = 0;
						feeList.Add(fee);
						nCostB += nAmount;
						nCount++;

						rsl.MoveNext();
					}

					if (nCount > 0)
					{
						/*tmpStr.Format(_T("%.2f"), nCostB);
						nItem = pList->AddItems(_T(""), _T("\x43\x1ED9ng (b)"), _T(""), _T(""), _T(""), tmpStr,  NULL);
						pList->MergeCell(nItem, 1, nItem, 4, DT_LEFT|DT_VCENTER|DT_SINGLELINE, false, true);
						pList->SetItemBkColor(nItem, RGB(220, 220, 220), FALSE);*/

						fee.szID.Empty();
						fee.szGroupID = _T("SubItemAmount");
						fee.szName.Format(_T("\x43\x1ED9ng (b)"));
						fee.szUnit.Empty();
						fee.nCost = nCostB;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nQuantity = 0;
						fee.nPrice = 0;
						fee.nInsPrice = 0;
						fee.nDiffPaid = 0;
						fee.nPatPaid = 0;
						feeList.Add(fee);

					}
					if (nTtlDiffCost > 0)
					{
						double nMatDiffCost = nTtlDiffCost - nOptDiffCost;
						if (nOptDiffCost > 0)
						{
							fee.szID.Empty();
							fee.szGroupID = _T("SubItemAmount");
							fee.szName.Format(_T("\x43hi ph\xED \x63h\xEAnh l\x1EC7\x63h PTTT"));
							fee.szUnit.Empty();
							fee.nCost = nOptDiffCost;
							fee.nInsPaid = 0;
							fee.nDiscount = 0;
							fee.nQuantity = 0;
							fee.nPrice = 0;
							fee.nInsPrice = 0;
							fee.nDiffPaid = 0;
							fee.nPatPaid = 0;
							feeList.Add(fee);
						}
						if (nMatDiffCost > 0)
						{
							fee.szID.Empty();
							fee.szGroupID = _T("SubItemAmount");
							fee.szName.Format(_T("\x43hi ph\xED \x63h\xEAnh l\x1EC7\x63h thu\x1ED1\x63, v\x1EADt t\x1B0"));
							fee.szUnit.Empty();
							fee.nCost = nMatDiffCost;
							fee.nInsPaid = 0;
							fee.nDiscount = 0;
							fee.nQuantity = 0;
							fee.nPrice = 0;
							fee.nInsPrice = 0;
							fee.nDiffPaid = 0;
							fee.nPatPaid = 0;
							feeList.Add(fee);
						}

					}
					double nTtlCostOut = nTtlDiffCost + nCostB;
					if (nTtlCostOut > 0)
					{
						/*tmpStr.Format(_T("%.2f"), nTtlCostOut);
						nItem = pList->AddItems(_T("+"), _T("T\x1ED5ng \x63hi ph\xED ngo\xE0i quy \x111\x1ECBnh \x42HYT kh\xF4ng th\x61nh to\xE1n"), _T(""), _T(""), _T(""),  tmpStr, NULL);
						pList->MergeCell(nItem, 1, nItem, 4, DT_LEFT|DT_VCENTER|DT_SINGLELINE, false, true);
						pList->SetItemBkColor(nItem, RGB(200, 220, 220), FALSE);*/
						fee.szID.Format(_T("+"));
						fee.szGroupID = _T("SubItemAmount");
						fee.szName.Format(_T("T\x1ED5ng \x63hi ph\xED ngo\xE0i quy \x111\x1ECBnh \x42HYT kh\xF4ng th\x61nh to\xE1n"));
						fee.szUnit.Empty();
						fee.nCost = nTtlCostOut;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nQuantity = 0;
						fee.nPrice = 0;
						fee.nInsPrice = 0;
						fee.nDiffPaid = 0;
						fee.nPatPaid = 0;
						feeList.Add(fee);

					}
					szSQL.Format(_T("SELECT hfe_discount FROM hms_fee ") \
						_T("WHERE hfe_docno = %ld and hfe_type='V' and hfe_itemid='VT000002' and hfe_subgroup='%s'"),
						nDocumentNo, szItemID);
					rsx.ExecSQL(szSQL);

					if (!rsx.IsEOF())
					{
						rsx.GetValue(_T("hfe_discount"), nAmount);
						nTtlInsPaid = nAmount;
					}
					else
					{

					}
					nTtlDiffCost += nCostB;


					/*tmpStr.Format(_T("%.2f"), nTtlCost);
					nItem = pList->AddItems(_T("*"), _T("T\x1ED5ng s\x1ED1 ti\x1EC1n \x64\x1ECB\x63h v\x1EE5 v\xE0 \x64\x1EE5ng \x63\x1EE5"), _T(""), _T(""), _T(""), tmpStr, ToString(nTtlInsPaid), ToString(nTtlDiffCost), ToString(nTtlCost-nTtlInsPaid), NULL);
					pList->MergeCell(nItem, 1, nItem, 4, DT_LEFT|DT_VCENTER|DT_SINGLELINE, false, true);
					pList->SetItemBkColor(nItem, RGB(200, 220, 220), FALSE);*/

					fee.szID = _T("*");
					fee.szGroupID = _T("SubItemAmount");
					fee.szName.Format(_T("S\x1ED1 ti\x1EC1n \x64\x1ECB\x63h v\x1EE5 v\xE0 \x64\x1EE5ng \x63\x1EE5 th\x61nh to\xE1n"));
					fee.szUnit.Empty();
					fee.nCost = nTtlCost;
					fee.nInsPaid = nTtlCost;
					fee.nDiscount = nTtlInsPaid;
					fee.nQuantity = 0;
					fee.nPrice = 0;
					fee.nInsPrice = 0;
					fee.nDiffPaid = nTtlDiffCost;
					fee.nPatPaid = nTtlCost - nTtlInsPaid;
					feeList.Add(fee);

					nTotalCost += nTtlCost;
					nGroup1Cost += nTtlCost;
					nGroup2Cost += nTtlCost;

					/*nTotalInsCost += nInsCost;
					nGroup1InsCost += nInsCost;
					nGroup2InsCost += nInsCost;*/

					nTotalDiscount += nTtlInsPaid;
					nGroup1Discount += nTtlInsPaid;
					nGroup2Discount += nTtlInsPaid;

					nTotalDiffPaid += nTtlDiffCost;
					nGroup1DiffPaid += nTtlDiffCost;
					nGroup2DiffPaid += nTtlDiffCost;

					nAmount = (nTtlCost - nTtlInsPaid);
					nTotalPatPaid += nAmount;
					nGroup1PatPaid += nAmount;
					nGroup2PatPaid += nAmount;
					nAmount = 0;


				}
				else
				{
					rs.GetValue(_T("cost"), nCost);
					rs.GetValue(_T("inscost"), nInsCost);
					rs.GetValue(_T("discount"), nDiscount);
					rs.GetValue(_T("DiffPaid"), nDiffPaid);
					rs.GetValue(_T("copayment"), nPatPaid);

					if (nInsCost <= 0)
					{
						//	nDiffPaid = nCost;
						//	nCost = 0;
					}
					nTotalCost += nCost;
					nGroup1Cost += nCost;
					nGroup2Cost += nCost;

					nTotalInsCost += nInsCost;
					nGroup1InsCost += nInsCost;
					nGroup2InsCost += nInsCost;

					nTotalDiscount += nDiscount;
					nGroup1Discount += nDiscount;
					nGroup2Discount += nDiscount;

					nTotalDiffPaid += nDiffPaid;
					nGroup1DiffPaid += nDiffPaid;
					nGroup2DiffPaid += nDiffPaid;

					nTotalPatPaid += nPatPaid;
					nGroup1PatPaid += nPatPaid;
					nGroup2PatPaid += nPatPaid;


					fee.szID.Format(_T("%d"), nLineIndex++);
					fee.szGroupID = _T("Item");
					fee.szName = rs.GetValue(_T("name"));
					fee.szUnit = rs.GetValue(_T("unit"));
					fee.nCost = nCost;
					fee.nInsPaid = nInsCost;
					fee.nDiscount = nDiscount;
					fee.nQuantity = str2float(rs.GetValue(_T("qty")));
					fee.nPrice = str2double(rs.GetValue(_T("unitprice")));
					fee.nInsPrice = str2double(rs.GetValue(_T("insprice")));
					fee.nDiffPaid = nDiffPaid;
					fee.nPatPaid = nPatPaid;
					feeList.Add(fee);

					if (szNewGroup.Left(1) == _T("C"))
					{
						nNumberTreat += (int)fee.nQuantity;

					}

				}

			}
			else
				nLineIndex = 1;
			rs.MoveNext();
		}
		if (!bFound)
		{
			feeList.RemoveAt(nIDX);
			nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
			nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;
		}
		else
		{
			if (nGroup1Cost + nGroup1DiffPaid > 0)
			{
				if (nGroup2Cost > 0 && nGroup1Cost != nGroup2Cost) {
					TranslateString(_T("Sub Amount"), tmpStr);
					fee.szGroupID = _T("SubAmount");
					fee.szID.Empty();;
					fee.szName = tmpStr;
					fee.nCost = nGroup2Cost;
					fee.nInsPaid = nGroup2InsCost;
					fee.nDiscount = nGroup2Discount;
					fee.nDiffPaid = nGroup2DiffPaid;
					fee.nPatPaid = nGroup2PatPaid;
					feeList.Add(fee);
				}

				TranslateString(_T("Total"), tmpStr);
				tmpStr.AppendFormat(_T(" (%d)"), nIndex);
				fee.szGroupID = _T("GrandAmount");
				fee.szID.Empty();;
				fee.szName = tmpStr;
				fee.nCost = nGroup1Cost;
				fee.nInsPaid = nGroup1InsCost;
				fee.nDiscount = nGroup1Discount;
				fee.nDiffPaid = nGroup1DiffPaid;
				fee.nPatPaid = nGroup1PatPaid;
				feeList.Add(fee);
			}
			nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
			nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;

			nIndex++;
		}



		grs.MoveNext();
	}


	nTotalCost = ceil(nTotalCost);

	if (szObjectType == _T("I") || szObjectType == _T("C"))
	{
		nTotalInsCost = (nTotalCost);
	}
	nTotalDiscount = (nTotalDiscount);
	nTotalDiffPaid = (nTotalDiffPaid);
	nTotalPatPaid = (nTotalPatPaid);
	nTotalPayable = (nTotalCost - nTotalDiscount);


	TranslateString(_T("Total Amount"), szName);
	fee.szGroupID = _T("TotalAmount");
	fee.szName.Format(_T("%s (II)"), szName);
	fee.nCost = nTotalCost;
	fee.nInsPaid = nTotalInsCost;
	fee.nDiscount = nTotalDiscount;
	fee.nDiffPaid = nTotalDiffPaid;
	fee.nPatPaid = nTotalPatPaid;
	feeList.Add(fee);


	//In phan dich vu ky thuat cao va chi phi lon


	szWhere.Format(_T(" AND (hfe_invoiceno=%ld ) "), nInvoiceNo);

	if (szOutPatient != _T("Y"))
		szWhere.AppendFormat(_T(" and hfe_group <>'D0000' "));
	szWhere.AppendFormat(_T(" and hfe_class in('E', 'I','X','A') "));
	//	szWhere.AppendFormat(_T(" and hfe_subgroup='XX' "));
	szWhere.AppendFormat(_T(" and (hfe_category <> 'Y' or hfe_category is null) "));

	szWhere.AppendFormat(_T(" and hfe_object not in(7) "));

	szSQL.Format(_T(" SELECT hfe_status   AS status,") \
		_T("   hfe_type          AS feetype,") \
		_T("   hfe_feegroup      AS feegroup,") \
		_T("   hfe_itemid        AS itemid,") \
		_T("   hfe_desc          AS name,") \
		_T("   hfe_unit          AS unit,") \
		_T("   hfe_hitech        AS hitech,") \
		_T("   hfe_unitprice     AS unitprice,") \
		_T("   hfe_insprice     AS insprice,") \
		_T("   SUM(hfe_quantity) AS qty,") \
		_T("   SUM(hfe_inspaid)     AS cost,") \
		_T("   SUM(hfe_discount) AS discount,") \
		_T("   SUM(hfe_diffpaid) AS DiffPaid,") \
		_T("   SUM(hfe_patpaid+hfe_patdebt)  AS patpaid") \
		_T(" FROM hms_fee") \
		_T(" WHERE hfe_docno     =%ld %s ") \
		_T(" AND hfe_feegroup   IN('HITECH','HITECH_L')") \
		_T(" GROUP BY hfe_status ,") \
		_T("   hfe_type ,") \
		_T("   hfe_feegroup,") \
		_T("   hfe_itemid,") \
		_T("   hfe_desc ,") \
		_T("   hfe_unit ,") \
		_T("   hfe_hitech ,") \
		_T("   hfe_unitprice, ") \
		_T("   hfe_insprice ") \
		_T(" ORDER BY hfe_desc,") \
		_T("   hfe_unit,") \
		_T("   hfe_unitprice"), nDocumentNo, szWhere);


	rs.ExecSQL(szSQL);

	if (!rs.IsEOF())
	{
		fee.szGroupID = _T("HITECH_HEADER");
		fee.szID = _T("");
		fee.szName.Format(_T(""));
		fee.nCost = 0;
		fee.nInsPaid = 0;
		fee.nDiscount = 0;
		fee.nDiffPaid = 0;
		fee.nPatPaid = 0;
		feeList.Add(fee);


		double nCostA = 0, nCostB = 0;
		double nCostAIns = 0;
		double nOptDiffCost = 0;
		double nAmount = 0;

		double ttl_amount = 0;
		double ttl_diffcost = 0;
		double ttl_inspaid = 0;
		double ttl_discount = 0;
		double ttl_patpaid = 0;


		double ttl2_amount = 0;
		double ttl2_diffcost = 0;
		double ttl2_inspaid = 0;
		double ttl2_discount = 0;
		double ttl2_patpaid = 0;

		double grp_cost = 0, grp_inspaid = 0, grp_discount = 0, grp_diffcost = 0, grp_patpaid = 0;
		CString szItemID;
		CString szItems;
		CString szOptGroup;
		long nOrderID;


		int nHitechCount = 0;
		while (!rs.IsEOF())
		{
			nCostA = 0;
			nCostB = 0;
			nOptDiffCost = 0;
			ttl_amount = 0;
			ttl_inspaid = 0;
			ttl_discount = 0;
			ttl_diffcost = 0;
			ttl_patpaid = 0;
			nLineIndex = 1;

			nHitechCount++;
			if (nHitechCount > 1)
			{
				fee.szGroupID = _T("HITECH_TYPE");
				fee.szID = _T("");
				fee.szName.Format(_T("************************************"));
				feeList.Add(fee);
			}

			fee.szGroupID = _T("HITECH_TYPE");
			fee.szID = _T("A");
			fee.szName.Format(_T("Trong quy \x111\x1ECBnh \x42H\x58H"));
			fee.nCost = 0;
			fee.nInsPaid = 0;
			fee.nDiscount = 0;
			fee.nDiffPaid = 0;
			fee.nPatPaid = 0;
			feeList.Add(fee);


			CString szFeeGroup;
			rs.GetValue(_T("feegroup"), szFeeGroup);
			rs.GetValue(_T("hfe_orderid"), nOrderID);




			if (szFeeGroup == _T("HITECH"))
				szOptGroup = _T("OPT");
			else
				szOptGroup = _T("OPT_L");


			rs.GetValue(_T("itemid"), szItemID);

			rs.GetValue(_T("cost"), nAmount);

			fee.szID.Format(_T("%d"), nLineIndex++);
			fee.szGroupID = _T("HITECH_ITEM");
			fee.szName = rs.GetValue(_T("name"));
			fee.szUnit = rs.GetValue(_T("unit"));
			rs.GetValue(_T("patpaid"), fee.nPatPaid);


			nCostA += nAmount;
			fee.nCost = nAmount;
			ttl_amount += nAmount;
			ttl_inspaid += nAmount;
			grp_cost += nAmount;

			rs.GetValue(_T("discount"), nAmount);
			fee.nDiscount = nAmount;
			ttl_discount += nAmount;
			grp_discount += nAmount;

			fee.nQuantity = str2float(rs.GetValue(_T("qty")));
			fee.nPrice = str2double(rs.GetValue(_T("insprice")));


			rs.GetValue(_T("diffpaid"), nOptDiffCost);
			fee.nDiffPaid = nOptDiffCost;
			ttl_diffcost += nOptDiffCost;
			grp_diffcost += nOptDiffCost;

			nAmount = fee.nCost - fee.nDiscount;

			fee.nPatPaid = nAmount;
			ttl_patpaid += nAmount;
			grp_patpaid += nAmount;

			feeList.Add(fee);


			nCostAIns = fee.nInsPaid;


			fee.szID.Empty();
			fee.szGroupID = _T("HITECH_ITEM_GROUP");
			fee.szName.Format(_T("\x43\x1ED9ng (1)"));
			fee.szUnit.Empty();
			fee.nCost = nCostA;
			fee.nInsPaid = nCostA;
			fee.nDiscount = ttl_discount;
			fee.nQuantity = 0;
			fee.nPrice = 0;
			fee.nInsPrice = 0;
			fee.nDiffPaid = ttl_diffcost;
			fee.nPatPaid = ttl_patpaid;
			feeList.Add(fee);



			szSQL.Format(_T("SELECT hfe_desc as hfe_name, hfe_unit, hfe_unitprice, sum(hfe_quantity) as hfe_quantity, ") \
				_T("sum(hfe_cost) as hfe_cost, sum(hfe_inspaid) as hfe_inspaid, sum(hfe_discount) as hfe_discount, sum(hfe_diffcost) as hfe_diffcost ") \
				_T(" FROM hms_fee ") \
				_T(" WHERE hfe_docno=%ld and hfe_type in('D','M') ") \
				_T(" and hfe_feegroup IN('%s') and hfe_subgroup='%s' and hfe_discount > 0 ")\
				_T(" and hfe_category <> 'Y' ") \
				_T(" GROUP BY hfe_desc, hfe_unit, hfe_unitprice ") \
				_T(" ORDER BY hfe_desc "),
				nDocumentNo, szOptGroup, szItemID);

			rsl.ExecSQL(szSQL);

			int n = 1;
			if (rsl.GetRecordCount() > 0)
			{
				fee.szID.Format(_T("2"));
				fee.szGroupID = _T("HITECH_TYPE");
				fee.szName.Format(_T("V\x1EADt t\x1B0 ti\xEAu h\x61o \x111\x1EB7\x63 \x62i\x1EC7t"));
				fee.szUnit.Empty();
				feeList.Add(fee);

			}

			int nIdx = 1;
			nCostA = 0;
			nCount = 0;
			grp_cost = grp_inspaid = grp_discount = grp_diffcost = grp_patpaid = 0;
			while (!rsl.IsEOF())
			{
				fee.szID.Format(_T("2.%d"), nIdx++);
				fee.szGroupID = _T("HITECH_ITEM");
				fee.szName.Format(_T("%s"), rsl.GetValue(_T("hfe_name")));
				fee.szUnit = rsl.GetValue(_T("hfe_unit"));

				fee.nPrice = str2double(rsl.GetValue(_T("hfe_unitprice")));
				fee.nInsPrice = str2double(rsl.GetValue(_T("hfe_unitprice")));
				fee.nQuantity = str2float(rsl.GetValue(_T("hfe_quantity")));

				rsl.GetValue(_T("hfe_inspaid"), nAmount);
				fee.nCost = nAmount;
				grp_cost += nAmount;
				ttl_amount += nAmount;


				rsl.GetValue(_T("hfe_inspaid"), nAmount);
				fee.nInsPaid = nAmount;
				grp_inspaid += nAmount;
				ttl_inspaid += nAmount;


				rsl.GetValue(_T("hfe_discount"), nAmount);
				fee.nDiscount = nAmount;
				grp_discount += nAmount;
				ttl_discount += nAmount;

				rsl.GetValue(_T("hfe_diffcost"), nAmount);
				fee.nDiffPaid = nAmount;
				grp_diffcost += nAmount;
				ttl_diffcost += nAmount;
				nAmount = 0;

				fee.nPatPaid = fee.nInsPaid - fee.nDiscount;
				grp_patpaid += fee.nPatPaid;
				ttl_patpaid += fee.nPatPaid;



				feeList.Add(fee);

				rsl.MoveNext();
				nCount++;
			}

			if (nCount > 0)
			{
				tmpStr.Format(_T("%.2f"), nCostA);
				fee.szID.Empty();
				fee.szGroupID = _T("HITECH_ITEM_GROUP");
				fee.szName.Format(_T("\x43\x1ED9ng (2)"));
				fee.szUnit.Empty();
				fee.nCost = grp_cost;
				fee.nInsPaid = grp_inspaid;
				fee.nDiscount = grp_discount;
				fee.nQuantity = 0;
				fee.nPrice = 0;
				fee.nInsPrice = 0;
				fee.nDiffPaid = grp_diffcost;
				fee.nPatPaid = grp_patpaid;
				feeList.Add(fee);

			}

			fee.szID.Format(_T(""));
			fee.szGroupID = _T("HITECH_ITEM_GROUP");
			fee.szName.Format(_T("\x43\x1ED9ng \x41(\x31+\x32)"));
			fee.szUnit.Empty();
			fee.nCost = ttl_amount;
			fee.nInsPaid = ttl_inspaid;
			fee.nDiscount = ttl_discount;
			fee.nDiffPaid = ttl_diffcost;
			fee.nPatPaid = ttl_patpaid;
			feeList.Add(fee);


			//Ngoai danh muc
			szSQL.Format(_T("SELECT hfe_desc as hfe_name, hfe_unit, hfe_unitprice, sum(hfe_quantity) as hfe_quantity, ") \
				_T("sum(hfe_cost) as hfe_cost ") \
				_T("FROM hms_fee ") \
				_T("WHERE hfe_docno=%ld and hfe_type in('D','M') ") \
				_T("and hfe_feegroup IN('%s') and hfe_subgroup='%s'  and hfe_discount <= 0 and hfe_category <> 'Y' ") \
				_T("GROUP BY hfe_desc, hfe_unit, hfe_unitprice ORDER BY hfe_desc "),
				nDocumentNo, szOptGroup, szItemID);
			rsl.ExecSQL(szSQL);

			bool bOutList = false;


			if (rsl.GetRecordCount() > 0)
			{
				fee.szID.Format(_T("B."));
				fee.szGroupID = _T("HITECH_TYPE");
				fee.szName.Format(_T("Ngo\xE0i \x64\x61nh m\x1EE5\x63 \x42HYT"));
				fee.szUnit.Empty();
				fee.nCost = 0;
				fee.nInsPaid = 0;
				fee.nDiscount = 0;
				fee.nQuantity = 0;
				fee.nPrice = 0;
				fee.nInsPrice = 0;
				fee.nDiffPaid = 0;
				fee.nPatPaid = 0;
				feeList.Add(fee);
				bOutList = true;
			}


			nCount = 0;
			grp_diffcost = 0;

			while (!rsl.IsEOF())
			{
				fee.szID.Empty();
				fee.szGroupID = _T("HITECH_ITEM");
				fee.szName.Format(_T("%s"), rsl.GetValue(_T("hfe_name")));
				fee.szUnit = rsl.GetValue(_T("hfe_unit"));

				fee.nPrice = str2double(rsl.GetValue(_T("hfe_unitprice")));

				rsl.GetValue(_T("hfe_cost"), nAmount);
				fee.nInsPrice = fee.nPrice;
				fee.nDiffPaid = nAmount;
				fee.nCost = 0;
				fee.nDiscount = 0;
				fee.nInsPaid = 0;
				fee.nPatPaid = 0;

				ttl_diffcost += nAmount;
				grp_diffcost += nAmount;

				fee.nQuantity = str2float(rsl.GetValue(_T("hfe_quantity")));
				feeList.Add(fee);
				nAmount = 0;
				nCount++;
				rsl.MoveNext();
			}

			if (nCount > 0)
			{
				fee.szID.Empty();
				fee.szGroupID = _T("HITECH_ITEM_GROUP");
				fee.szName.Format(_T("\x43\x1ED9ng B"));
				fee.szUnit.Empty();
				fee.nCost = 0;
				fee.nInsPaid = 0;
				fee.nDiscount = 0;
				fee.nQuantity = 0;
				fee.nPrice = 0;
				fee.nInsPrice = 0;
				fee.nDiffPaid = grp_diffcost;
				fee.nPatPaid = 0;
				feeList.Add(fee);
			}

			if (bOutList)
			{
				fee.szID = _T("C");
				fee.szGroupID = _T("HITECH_ITEM_GROUP");
				fee.szName.Format(_T("T\x1ED5ng \x63\x1ED9ng(A+B)"));
				fee.szUnit.Empty();
				fee.nCost = ttl_amount;

				fee.nInsPaid = ttl_inspaid;
				fee.nDiscount = ttl_discount;
				fee.nQuantity = 0;
				fee.nPrice = 0;
				fee.nInsPrice = 0;
				fee.nDiffPaid = ttl_diffcost;
				fee.nPatPaid = ttl_patpaid;
				feeList.Add(fee);


			}


			szSQL.Format(_T("SELECT hfe_cost, hfe_inspaid, hfe_discount, hfe_patpaid+hfe_patdebt as hfe_patpaid, hfe_diffcost ") \
				_T("FROM hms_fee WHERE hfe_type='V' and hfe_docno=%ld and hfe_itemid='VT000002' and hfe_subgroup='%s'  "),
				nDocumentNo, szItemID);
			rsl.ExecSQL(szSQL);


			if (!rsl.IsEOF())
			{
				rsl.GetValue(_T("hfe_inspaid"), nAmount);
				ttl_inspaid = nAmount;
				ttl_amount = nAmount;
				rsl.GetValue(_T("hfe_discount"), nAmount);
				ttl_discount = nAmount;
				rsl.GetValue(_T("hfe_patpaid"), nAmount);
				rsl.GetValue(_T("hfe_diffcost"), nAmount);
				ttl_diffcost = nAmount;
				ttl_patpaid = ttl_amount - ttl_discount;

				fee.szID = _T("");
				fee.szGroupID = _T("HITECH_ITEM_GROUP");
				fee.szName.Format(_T("T\x1ED5ng s\x1ED1 ti\x1EC1n \x64\x1ECB\x63h v\x1EE5 s\x61u khi \xE1p m\x1EE9\x63 tr\x1EA7n \x42H\x58H"));
				fee.szUnit.Empty();
				fee.nCost = ttl_amount;

				fee.nInsPaid = ttl_inspaid;
				fee.nDiscount = ttl_discount;
				fee.nQuantity = 0;
				fee.nPrice = 0;
				fee.nInsPrice = 0;
				fee.nDiffPaid = ttl_diffcost;
				fee.nPatPaid = ttl_patpaid;
				feeList.Add(fee);


			}

			nTotalCost += ttl_amount;
			nTotalInsCost += ttl_inspaid;
			nTotalDiscount += ttl_discount;
			nTotalDiffPaid += ttl_diffcost;
			nTotalPatPaid += ttl_patpaid;
			ttl2_amount += ttl_amount;
			ttl2_inspaid += ttl_inspaid;
			ttl2_discount += ttl_discount;
			ttl2_diffcost += ttl_diffcost;
			ttl2_patpaid += ttl_patpaid;


			rs.MoveNext();
		}



		if (ttl2_amount > ttl_amount)
		{
			fee.szID = _T("");
			fee.szGroupID = _T("HITECH_ITEM_GROUP");
			fee.szName.Format(_T("T\x1ED5ng s\x1ED1 ti\x1EC1n \x64\x1ECB\x63h v\x1EE5"));
			fee.szUnit.Empty();
			fee.nCost = ttl2_amount;

			fee.nInsPaid = ttl2_inspaid;
			fee.nDiscount = ttl2_discount;
			fee.nQuantity = 0;
			fee.nPrice = 0;
			fee.nInsPrice = 0;
			fee.nDiffPaid = ttl2_diffcost;
			fee.nPatPaid = ttl2_patpaid;
			feeList.Add(fee);
		}


	}



	nSumCost += nTotalCost;
	nSumInsCost += nTotalInsCost;
	nSumDiscount += nTotalDiscount;
	nSumDiffPaid += nTotalDiffPaid;
	nSumPatPaid += nTotalPatPaid;



	for (int i = 0; i < feeList.GetCount(); i++) {
		fee = feeList[i];
		szType = fee.szGroupID;

		if (szType == _T("Type") || szType == _T("Section"))
		{
			grp = rpt.GetGroupHeader(1);
			rptDetail = rpt.AddDetail(grp);
			tmpStr = fee.szID;
			rptDetail->SetValue(_T("TypeID"), tmpStr);
			StringUpper(fee.szName, tmpStr);
			rptDetail->SetValue(_T("TypeName"), tmpStr);
		}
		else if (szType == _T("Group")) {
			grp = rpt.GetGroupHeader(1);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("TypeID"), fee.szID);
			rptDetail->SetValue(_T("TypeName"), fee.szName);
		}
		else if (szType == _T("SubGroup")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("SubGroupID"), fee.szID);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);


			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}
		}
		else if (szType == _T("SubAmount")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			CReportItem* obj;
			obj = rptDetail->GetItem(_T("SubGroupName")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupCost")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupDiscount")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupPatpaid")); if (obj) obj->SetBold(true);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);


			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}

		}
		else if (szType == _T("GrandAmount")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			//	rptDetail->GetItem(_T("SubGroupName"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupCost"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupDiscount"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupPatpaid"))->SetBold(true);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}

		}

		else if (szType == _T("Item")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = rptDetail->GetItem(_T("1"));
			if (obj) {

				obj->SetTextAlign(ES_RIGHT);
			}
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), fee.szUnit);
			FormatCurrency(fee.nQuantity, tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), tmpStr);

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}

		}
		else if (szType == _T("SubItemGroup")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj)
				{
					obj->SetItalic(true);
					obj->SetBold(true);
				}

			}
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), _T(""));
			rptDetail->SetValue(_T("4"), _T(""));
			rptDetail->SetValue(_T("5"), _T(""));
			rptDetail->SetValue(_T("6"), _T(""));
			rptDetail->SetValue(_T("7"), _T(""));
			rptDetail->SetValue(_T("8"), _T(""));
			rptDetail->SetValue(_T("9"), _T(""));
		}

		else if (szType == _T("SubItem")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj) obj->SetItalic(true);
			}

			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), fee.szUnit);
			FormatCurrency(fee.nQuantity, tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), tmpStr);

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}

		}
		else if (szType == _T("SubItemAmount")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj)
				{
					obj->SetItalic(true);
					obj->SetBold(true);
				}

			}
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), _T(""));
			rptDetail->SetValue(_T("4"), _T(""));
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), _T(""));

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}

		}

		else if (szType == _T("Dousage")) {
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(4));
			rptDetail->SetValue(_T("usage"), fee.szName);
		}
		else if (szType == _T("TotalAmount")) {
			grp = rpt.GetGroupHeader(3);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("TotalAmountLabel"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("TotalAmount"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("TotalInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("TotalDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("TotalDiffPaid"), tmpStr);
			//fee.nPatPaid= fee.nCost-fee.nDiscount;
			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("TotalPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("TotalInsUnPaid"), tmpStr);
			}
		}
		else if (szType == _T("HITECH_HEADER"))
		{
			CReportSection* rptGrp = rpt.GetGroupFooter(1);
			rptDetail = rpt.AddDetail(rptGrp);
		}
		else if (szType == _T("HITECH_TYPE"))
		{
			CReportSection* rptGrp = rpt.GetGroupHeader(1);
			rptDetail = rpt.AddDetail(rptGrp);
			rptDetail->SetValue(_T("TypeID"), fee.szID);
			rptDetail->SetValue(_T("TypeName"), fee.szName);


		}
		else if (szType == _T("HITECH_GROUP"))
		{
			CReportSection* rptGrp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(rptGrp);
			rptDetail->SetValue(_T("SubGroupID"), fee.szID);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			tmpStr.Format(_T("%.2f"), fee.nCost);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);
			tmpStr.Format(_T("%.2f"), fee.nDiscount);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);
			tmpStr.Format(_T("%.2f"), fee.nDiffPaid);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);
			tmpStr.Format(_T("%.2f"), fee.nPatPaid);
			rptDetail->SetValue(_T("SubGroupPatpaid"), tmpStr);


		}
		else if (szType == _T("HITECH_ITEM"))
		{
			rptDetail = rpt.AddDetail();
			CReportItem* obj = rptDetail->GetItem(_T("1"));
			if (obj) {

				obj->SetTextAlign(ES_RIGHT);
			}
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), fee.szUnit);
			FormatCurrency(fee.nQuantity, tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), tmpStr);

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}


		}
		else if (szType == _T("HITECH_ITEM_GROUP"))
		{
			grp = rpt.GetGroupHeader(3);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("TotalAmountLabel"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("TotalAmount"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("TotalInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("TotalDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("TotalDiffPaid"), tmpStr);
			//fee.nPatPaid= fee.nCost-fee.nDiscount;
			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("TotalPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("TotalInsUnPaid"), tmpStr);
			}


		}
	}


	if (nTotalCost != nSumCost) {
		CString szName;
		TranslateString(_T("Total Amount"), tmpStr);
		szName.Format(_T("%s"), tmpStr);
		grp = rpt.GetGroupHeader(3);
		rptDetail = rpt.AddDetail(grp);
		rptDetail->SetValue(_T("TotalAmountLabel"), szName);
		FormatCurrency(nSumCost, tmpStr);
		rptDetail->SetValue(_T("TotalAmount"), tmpStr);

		FormatCurrency(nSumInsCost, tmpStr);
		rptDetail->SetValue(_T("TotalInsCost"), tmpStr);

		FormatCurrency(nSumDiscount, tmpStr);
		rptDetail->SetValue(_T("TotalDiscount"), tmpStr);

		FormatCurrency(nSumDiffPaid, tmpStr);
		rptDetail->SetValue(_T("TotalDiffPaid"), tmpStr);
		FormatCurrency(nSumPatPaid, tmpStr);
		rptDetail->SetValue(_T("TotalPatPaid"), tmpStr);
	}






	szSQL.Format(_T(" SELECT hfe_amount as hfe_amount,") \
		_T("   hfe_inspaid,") \
		_T("   hfe_discount,") \
		_T("   hfe_patpaid,") \
		_T("   hfe_payment,") \
		_T("   hfe_diffcost,") \
		_T("   hfe_diffpaid,") \
		_T("   hfe_deposit,") \
		_T("   hfe_refund,") \
		_T("   hfe_freeamount") \
		_T(" FROM hms_fee_invoice") \
		_T(" WHERE hfe_invoiceno=%ld and hfe_status in('A','P') "), nInvoiceNo);

	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{


		rs.GetValue(_T("hfe_amount"), nTotalCost);
		rs.GetValue(_T("hfe_inspaid"), nTotalInsCost);
		rs.GetValue(_T("hfe_discount"), nTotalDiscount);
		rs.GetValue(_T("hfe_patpaid"), nTotalPatPaid);
		rs.GetValue(_T("hfe_diffcost"), nTotalDiffPaid);
		rs.GetValue(_T("hfe_deposit"), nTotalDeposit);
		rs.GetValue(_T("hfe_refund"), nTotalRefund);
		rs.GetValue(_T("hfe_freeamount"), nTotalFree);
		rs.GetValue(_T("hfe_payment"), nTotalPayment);

		nTotalPayable = nTotalPatPaid;


	}
	else
	{
		nTotalCost += nTotalDiffPaid;
		szSQL.Format(_T("SELECT sum(hfe_amount-hfe_patpaid) as amount ") \
			_T("FROM hms_fee_deposit ") \
			_T("WHERE hfe_docno=%ld and hfe_status<>'C' and hfe_class IN('E','I','A') and hfe_objectid<>7"),
			nDocumentNo);
		rs.ExecSQL(szSQL);
		if (!rs.IsEOF())
		{
			rs.GetValue(_T("amount"), nTotalDeposit);
		}
		nTotalPayable = nTotalPatPaid + nTotalDiffPaid;
		nTotalPayment = nTotalPayable - (nTotalDeposit + nTotalFree);

		nTotalRefund = 0;
		if (nTotalPayment < 0)
		{
			nTotalRefund = -1 * nTotalPayment;
			nTotalPayment = 0;
		}
		//_msg(_T("%f:%f"), nTotalPayment, nTotalRefund);
	}

	//In lai so ngay dieu tri
	if (nNumberTreat > 0)
	{
		tmpStr.Format(_T("%d"), nNumberTreat);
		rpt.GetReportHeader()->SetValue(_T("TreatmentDay"), tmpStr);
	}

	/*nTotalCost = ceil(nTotalCost);
	nTotalInsCost = ceil(nTotalInsCost);
	nTotalDiscount = ceil(nTotalDiscount);
	nTotalPayable = ceil(nTotalPayable);
	nTotalDiffPaid = ceil(nTotalDiffPaid);*/

	nTotalPayable = ceil(nTotalPayable);

	rpt.GetReportFooter()->SetValue(_T("PatientSign"), szPatientName);
	FormatCurrency((nTotalCost), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumAmount"), tmpStr);
	CString szSumInWord;
	tmpStr.Format(_T("%.0f"), nTotalCost);
	MoneyToString(tmpStr, szSumInWord);
	szSumInWord += _T(" \x111\x1ED3ng.");
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), szSumInWord);

	FormatCurrency(nTotalInsCost, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumInsCost"), tmpStr);


	FormatCurrency(nTotalDiscount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumInsDiscount"), tmpStr);

	FormatCurrency(nTotalInsCost - nTotalDiscount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumInsUnPaid"), tmpStr);

	FormatCurrency((nTotalDiffPaid), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumDiffPaid"), tmpStr);


	FormatCurrency(nTotalPayable, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumPatPaid"), tmpStr);



	FormatCurrency((nTotalDeposit), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumDeposit"), tmpStr);

	FormatCurrency(nTotalFree, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumDiscount"), tmpStr);

	FormatCurrency(nSumFoodAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SumFoodAmount"), tmpStr);

	nTotalRefund = ceil(nTotalRefund);
	nTotalPayment = ceil(nTotalPayment);

	if (nTotalRefund > 0)
	{
		//	FormatCurrency(nTotalRefund, tmpStr);
		//	rpt.GetReportFooter()->SetValue(_T("SumPayment"), tmpStr);

		FormatCurrency(nTotalRefund, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumRefund"), tmpStr);
	}
	else
	{
		FormatCurrency(nTotalPayment, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumPayment"), tmpStr);

	}



	//	szSQL.Format(_T("UPDATE hms_fee_invoice SET hfe_print=hfe_print+1 WHERE hfe_invoiceno=%ld "), nInvoiceNo);
	//	ExecSQL(szSQL);

	//	rpt.Print();
	rpt.PrintPreview();

}



void CPrintForms::FM_PrintPolicyDischargePaymentInvoice(long nDocumentNo, long nInvoiceNo)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	//	if(!pMF->IsInPatient())
	//		return;
	CReport rpt;
	CString tmpStr, szSQL, szWhere, szAdmitDate, szEndDate, szDepartments, szAddonedayoutofhospital, szNumbertreat;
	CRecord rs(&pMF->m_db);
	CRecord rsd(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	int		nDeskNo = 0;
	CString szRecvDate;
	CString	szObjectType;
	CString	szDescription;
	CString szPrintMaterialOperation = _T("Y");
	CString szOutPatient;


	double	nTotalCost = 0,				//Tong chi phi
		nTotalInsCost = 0,
		nTotalDiscount = 0,			//Tong Mien giam
		nTotalPatPaid = 0,			//Tong benh nhan tra
		nTotalDiffPaid = 0,	//Tong so tra chenh lech
		nTotalPayable = 0,
		nTotalDeposit = 0,			//Tong tam ung
		nTotalFree = 0,				//Tong mien phi
		nTotalRefund = 0,				//Tong hoan tra
		nDepositPayable = 0;			//So tien tra tu tam ung


	double nSumFoodAmount = 0;


	szWhere.AppendFormat(_T(" and hfe_invoiceno=%ld "), nInvoiceNo);

	szSQL.Format(_T(" SELECT *") \
		_T(" FROM") \
		_T(" (") \
		_T("  SELECT hd_patientno as patientno,") \
		_T("         hd_docno as docno,") \
		_T("         trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T("         hp_birthdate as birthdate,") \
		_T("         hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age,") \
		_T("         extract(year from hp_birthdate) as yearofbirth, ") \
		_T("         Get_Selection_Desc('sys_sex', hp_sex) as sex,") \
		_T("         hp_sex as sex_id,") \
		_T("         hp_ethnic as ethnic,") \
		_T("         Get_Selection_Desc('sys_ethnic', hp_ethnic) as ethnicdesc, ") \
		_T("         nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T("         hms_getaddress(hp_provid,hp_distid, hp_villid) as address,") \
		_T("         hp_workplace as workplace,") \
		_T("		 hd_rank, get_selection_desc('hms_rank', hd_rank) as rankname, ") \
		_T("         hd_doctor as doctor,") \
		_T("         hd_createdby as createdby,") \
		_T("         hd_icd as icd10,") \
		_T("         hd_diagnostic as diagnostic,") \
		_T("         hd_reldisease as reldisease,") \
		_T("         hd_xobject as xobject, ") \
		_T("         hd_xcardno as xcardno, ") \
		_T("         hd_xissuedate as xissuedate, ") \
		_T("         hd_emergency as emergency, ") \
		_T("         Get_Selection_Desc('hms_result',hd_result) as result,") \
		_T("         hd_admitdate as examdate,") \
		_T("         hd_enddate as enddate,") \
		_T(" hd_outpatient, ") \
		_T("         hcr_recordno as recordno ,") \
		_T("         hcr_admitdate as admitdate,") \
		_T("         hcr_dischargedate as dischargedate,") \
		_T("         hcr_sumtreat as TreatmentDay,") \
		_T("         hcr_mainicd as mainicd ,") \
		_T("         hcr_maindisease as maindisease ,") \
		_T("         hcr_treatdoctor as treatdoctor, ") \
		_T("         hcr_reldisease as ireldisease,") \
		_T("         hcr_suggestion as isuggestion,") \
		_T("         hd_suggestion as esuggestion,") \
		_T("         Get_Selection_Desc('hms_result' ,hcr_result)  as iresult,") \
		_T("         Hms_GetObjectType(hd_object) as objecttype, ") \
		_T("         cast(hd_disrate as integer) as disrate, ") \
		_T("         hd_insline as insline, ") \
		_T("         hd_insregdate as insregdate, ") \
		_T("         hd_transplace as transplace, ") \
		_T("         hc_cardno as cardno, ") \
		_T("         hc_regdate as regdate, ") \
		_T("         hc_expdate as expdate, ") \
		_T("         hc_regcode as regcode, ") \
		_T("         HMS_GETHOSPITALNAME(hc_regcode) as regplace, ") \
		_T("         hfe_deptid as deptid,") \
		_T("         hfe_serialno as serialno,") \
		_T("         hfe_receiptno as recvno,") \
		_T("         hfe_date as recvdate, ") \
		_T("         hfe_staff as receiver,") \
		_T("         hfe_desc as reason,") \
		_T("         hfe_amount as cost,") \
		_T("         hfe_discount as discount,") \
		_T("         hfe_patpaid as patpaid,") \
		_T("         hfe_deposit as deposit_amount, ") \
		_T("         0 as deposit_payable,") \
		_T("         hfe_refund as refund_amount, ") \
		_T("         hfe_freeamount as free_amount,") \
		_T("         hfe_eat_amount as food_amount,") \
		_T("         row_number() over (partition by hd_docno order by hd_docno) as dn") \
		_T(" FROM hms_fee_invoice ") \
		_T(" LEFT JOIN hms_doc ON(hd_docno=hfe_docno)") \
		_T(" LEFT JOIN hms_patient ON(hp_patientno=hd_patientno)") \
		_T(" LEFT JOIN hms_clinical_record ON(hcr_docno=hd_docno) ") \
		_T(" LEFT JOIN hms_treatment_record ON(hfe_docno=htr_docno) ") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hfe_docno=%ld %s ") \
		_T(" ) Tbl") \
		_T(" WHERE dn=1"), nDocumentNo, szWhere);

	_fmsg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		return;
	}

	rs.GetValue(_T("cost"), nTotalCost);
	rs.GetValue(_T("discount"), nTotalDiscount);
	rs.GetValue(_T("patpaid"), nTotalPatPaid);
	rs.GetValue(_T("deposit_amount"), nTotalDeposit);
	rs.GetValue(_T("free_amount"), nTotalFree);
	rs.GetValue(_T("refund_amount"), nTotalRefund);
	rs.GetValue(_T("deposit_payable"), nDepositPayable);
	rs.GetValue(_T("reason"), szDescription);
	rs.GetValue(_T("deskno"), nDeskNo);

	rs.GetValue(_T("food_amount"), nSumFoodAmount);

	rs.GetValue(_T("objecttype"), szObjectType);
	rs.GetValue(_T("hd_outpatient"), szOutPatient);


	if (szObjectType == _T("I") || szObjectType == _T("C"))
	{
		if (!rpt.Init(_T("Reports/HMS/HF_INSDISCHARGEPAYMENT.RPT"), false))
			return;
	}
	else if (szObjectType == _T("D"))
	{
		if (!rpt.Init(_T("Reports/HMS/HF_FREEDISCHARGEPAYMENT.RPT"), false))
			return;
	}
	else
	{
		if (!rpt.Init(_T("Reports/HMS/HF_DISCHARGEPAYMENT.RPT"), false))
			return;
	}

	//Report Header
	tmpStr.Empty();
	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	tmpStr.Format(_T("%s-%s-%s"), rs.GetValue(_T("serialno")), rs.GetValue(_T("bookno")), rs.GetValue(_T("recvno")));
	rpt.GetReportHeader()->SetValue(_T("ReceiptNo"), tmpStr);
	tmpStr.Format(_T("%ld"), nInvoiceNo);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);


	CString szDate;
	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);


	rs.GetValue(_T("recordno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RecordNo"), tmpStr);
	//rs.GetValue(_T("pname"), tmpStr);


	CString szPatientName;
	StringUpper(rs.GetValue(_T("pname")), szPatientName);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), szPatientName);
	rs.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	rs.GetValue(_T("yearofbirth"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("birthdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("BirthDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);

	rs.GetValue(_T("sex_id"), tmpStr);
	if (tmpStr == _T("F"))
		rpt.GetReportHeader()->SetValue(_T("Female"), _T("X"));
	else
		rpt.GetReportHeader()->SetValue(_T("Male"), _T("X"));


	rs.GetValue(_T("ethnic"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ethnic"), tmpStr);
	rs.GetValue(_T("ethnicdesc"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ethnicdesc"), tmpStr);

	rs.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);


	rs.GetValue(_T("rankname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Rank"), tmpStr);

	CString szAddress;
	rs.GetValue(_T("detailaddress"), tmpStr);
	szAddress = tmpStr;
	rs.GetValue(_T("address"), tmpStr);
	if (!szAddress.IsEmpty())
		szAddress += _T(" - ");
	szAddress += tmpStr;
	rpt.GetReportHeader()->SetValue(_T("Address"), szAddress);


	rs.GetValue(_T("transplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TransferHospital"), tmpStr);


	rs.GetValue(_T("objecttype"), szObjectType);

	rs.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr.Left(15));
	if (!tmpStr.IsEmpty())
	{
		rpt.GetReportHeader()->SetValue(_T("HasCardNo"), _T("X"));
	}
	else
	{
		rpt.GetReportHeader()->SetValue(_T("NoCardNo"), _T("X"));
	}

	rs.GetValue(_T("disrate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Insrate"), tmpStr);


	rs.GetValue(_T("insline"), tmpStr);
	if (tmpStr == _T("Y"))
	{
		rpt.GetReportHeader()->SetValue(_T("InsLine"), _T("X"));
		rpt.GetReportHeader()->SetValue(_T("NotInsLine"), _T(""));
	}
	else
	{
		rpt.GetReportHeader()->SetValue(_T("InsLine"), _T(""));
		rpt.GetReportHeader()->SetValue(_T("NotInsLine"), _T("X"));
	}

	rs.GetValue(_T("insregdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InsRegDate"), CDate::Convert(tmpStr));


	rs.GetValue(_T("regdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("expdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExpiryDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs.GetValue(_T("regplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegistrationPlace"), tmpStr);


	CString szRegCode;
	rs.GetValue(_T("regcode"), szRegCode);
	rpt.GetReportHeader()->SetValue(_T("RegCode"), szRegCode);

	CReportItem* obj = rpt.GetReportHeader()->GetItem(_T("InsuranceCompany"));
	if (obj)
	{
		CString insname;
		CRecord rsx(&pMF->m_db);

		tmpStr.Format(_T("select sp_name as insname ") \
			_T("from sys_prov left join hms_hospital on(hh_provid=sp_id or hh_newprov_id=sp_id) where trim(hh_id)=trim('%s') "), szRegCode);
		rsx.ExecSQL(tmpStr);
		if (!rsx.IsEOF())
		{
			rsx.GetValue(_T("insname"), tmpStr);
			rpt.GetReportHeader()->Format(_T("InsuranceCompany"), tmpStr);
		}
	}

	rs.GetValue(_T("emergency"), tmpStr);
	if (tmpStr == _T("Y"))
		tmpStr = _T("X");
	else
		tmpStr.Empty();

	rpt.GetReportHeader()->SetValue(_T("Emergency"), tmpStr);

	rs.GetValue(_T("maindisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	rs.GetValue(_T("ireldisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RelationDisease"), tmpStr);
	rs.GetValue(_T("mainicd"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ICD10"), tmpStr);
	rs.GetValue(_T("iresult"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Result"), tmpStr);
	rs.GetValue(_T("isuggestion"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Suggestion"), pMF->GetSelectionString(_T("hms_suggestion"), tmpStr));



	CString szDischargeDate;
	rs.GetValue(_T("admitdate"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("admitdate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));

	rs.GetValue(_T("dischargedate"), tmpStr);
	szDischargeDate = tmpStr;

	if (szDischargeDate.Left(4) != _T("1752"))
		rpt.GetReportHeader()->SetValue(_T("dischargedate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));
	else
		rpt.GetReportHeader()->SetValue(_T("dischargedate"), _T(""));

	rs.GetValue(_T("TreatmentDay"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TreatmentDay"), tmpStr);

	CString szData;
	tmpStr.Format(_T("%s-%s-%s"), rs.GetValue(_T("bookno")), rs.GetValue(_T("serialno")), rs.GetValue(_T("recvno")));
	rpt.GetReportFooter()->SetValue(_T("SerialNo"), tmpStr);
	rs.GetValue(_T("recvdate"), szRecvDate);
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate"), CDateTime::Convert(szRecvDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));
	szData.Format(rpt.GetReportFooter()->GetValue(_T("ReceiptDate1")), szRecvDate.Mid(11, 5), szRecvDate.Mid(8, 2), szRecvDate.Mid(5, 2), szRecvDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate1"), szData);
	szData.Format(rpt.GetReportFooter()->GetValue(_T("ReceiptDate2")), szRecvDate.Mid(11, 5), szRecvDate.Mid(8, 2), szRecvDate.Mid(5, 2), szRecvDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate2"), szData);

	rs.GetValue(_T("treatdoctor"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("Doctor"), GetDoctorName(tmpStr));

	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{
		img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img->SetFixedHeight(true);
	}
	tmpStr.Empty();
	rs.GetValue(_T("receiver"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("ReceiverBy"), GetDoctorName(tmpStr));
	CReportItem* img2 = rpt.GetReportFooter()->GetItem(_T("Signature2"));
	if (img2)
	{
		img2->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img2->SetFixedHeight(false);
	}


	// Nguoi tiep don
	tmpStr.Empty();
	rs.GetValue(_T("createdby"), tmpStr);
	tmpStr.Trim();
	rpt.GetReportFooter()->SetValue(_T("createdby"), GetDoctorName(tmpStr));
	CReportItem* img3 = rpt.GetReportFooter()->GetItem(_T("Signature3"));
	if (img3)
	{
		img3->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img3->SetFixedHeight(false);
	}


	CReportSection* rptDetail = NULL;
	CReportSection* grp;
	CRecord grs(&pMF->m_db);
	CString szFeeID, szID;
	CString szSubItem, szType;

	TCHAR* lpszChapter[] = { _T("I"), _T("II"), _T("III"), _T("IV"), _T("V"), _T("VI"), _T("VII"), _T("VIII"), _T("IX"), _T("X"), _T("XI") };


	CRecord drs(&pMF->m_db);
	CString szDeptID;

	CArray<RECEIPTINFO, RECEIPTINFO& > payInfo;

	szSQL.Format(_T(" SELECT deptid, admitdate, dischargedate, mainicd, maindisease") \
		_T(" FROM") \
		_T(" (") \
		_T("  select htr_deptid as deptid,") \
		_T("         htr_admitdate as admitdate,") \
		_T("         htr_dischargedate as dischargedate,") \
		_T("         htr_mainicd as mainicd,") \
		_T("         htr_maindisease as maindisease,") \
		_T("         htr_idx as idx") \
		_T("  from hms_treatment_record") \
		_T("  where htr_docno=%ld") \
		_T("  union all") \
		_T("  select hd_admitdept,") \
		_T("         hd_admitdate,") \
		_T("         hd_enddate,") \
		_T("         hd_icd,") \
		_T("         hd_diagnostic,") \
		_T("         0") \
		_T("  from hms_doc") \
		_T("  where hd_docno=%ld") \
		_T(" ) tbl") \
		_T(" WHERE deptid in(select distinct hfe_deptid from hms_fee where hfe_invoiceno=%ld)") \
		_T(" ORDER BY idx"), nDocumentNo, nDocumentNo, nInvoiceNo);

	drs.ExecSQL(szSQL);

	RECEIPTINFO pi;
	CString szDepts;
	szDepts.Empty();

	while (!drs.IsEOF())
	{
		drs.GetValue(_T("deptid"), tmpStr);

		bool bFound = false;
		int i = 0;
		for (i = 0; i < payInfo.GetCount(); i++)
		{
			pi = payInfo[i];
			if (pi.deptid == tmpStr)
			{
				bFound = true;
				break;
			}
		}
		pi.deptid = tmpStr;
		if (!szDepts.IsEmpty())
			szDepts += _T(",  ");
		szDepts.AppendFormat(_T("%s"), tmpStr);

		drs.GetValue(_T("dischargedate"), pi.dischargedate);
		drs.GetValue(_T("mainicd"), pi.mainicd);
		drs.GetValue(_T("maindisease"), pi.maindisease);

		if (bFound)
		{
			payInfo.SetAt(i, pi);
		}
		else
		{
			drs.GetValue(_T("admitdate"), pi.admitdate);
			payInfo.Add(pi);

		}

		drs.MoveNext();
	}

	rpt.GetReportHeader()->SetValue(_T("Department"), szDepts);

	double nSumCost = 0, nSumInsCost = 0, nSumDiscount = 0, nSumDiffPaid = 0, nSumPatPaid = 0;

	szDepts.Empty();


	int nChapter = 0;
	int nCount = 0, nIndex, nChapterID = 0;
	int nItem = 0, nOldItem = 0, nItem2 = 0;
	bool bDeleteParent = false;
	bool bLoadItems = false;
	CString szNewGroup, szOldGroup, szParentGroup;


	double nGroup0Cost = 0, nGroup0InsCost = 0, nGroup0Discount = 0, nGroup0DiffPaid = 0, nGroup0PatPaid = 0;
	double nGroup1Cost = 0, nGroup1InsCost = 0, nGroup1Discount = 0, nGroup1DiffPaid = 0, nGroup1PatPaid = 0;
	double nGroup2Cost = 0, nGroup2InsCost = 0, nGroup2Discount = 0, nGroup2DiffPaid = 0, nGroup2PatPaid = 0;
	double nCost = 0, nInsCost = 0, nDiscount = 0, nDiffPaid = 0, nPatPaid = 0;


	nTotalCost = nTotalDiffPaid = nTotalInsCost = nTotalPatPaid = nTotalDiscount = 0;

	szSQL.Format(_T("SELECT * FROM hms_fee_type ORDER BY hft_id "));
	grs.ExecSQL(szSQL);

	szWhere.Format(_T(" AND hfe_invoiceno=%ld"), nInvoiceNo);

	if (szOutPatient != _T("Y"))
		szWhere.AppendFormat(_T(" and hfe_groupid <>'D0000' "));
	szWhere.AppendFormat(_T(" and hfe_class in('E', 'I','X') "));
	//szWhere.AppendFormat(_T(" and hfe_subgroup='XX' "));
	szWhere.AppendFormat(_T(" and (hfe_category <> 'Y' or hfe_category is null) "));


	szSQL.Format(_T(" SELECT hfe_typeindex AS typeindex,") \
		_T("   hfe_status         AS status,") \
		_T("   hfe_type           AS feetype,") \
		_T("   hfe_groupid        AS groupid,") \
		_T("   hfe_groupid3       AS groupid3,") \
		_T("   hfe_itemid         AS itemid,") \
		_T("   hfe_name           AS name,") \
		_T("   hfe_unit           AS unit,") \
		_T("   hfe_hitech         AS hitech,") \
		_T("   hfe_inlist         AS inlist,") \
		_T("   hfe_unitprice      AS unitprice,") \
		_T("   SUM(hfe_quantity)       AS qty,") \
		_T("   SUM(hfe_amount)      AS cost,") \
		_T("   SUM(hfe_discount)  AS discount,") \
		_T("   SUM(hfe_diffpaid)  AS DiffPaid,") \
		_T("   SUM(hfe_copayment) AS copayment,") \
		_T("   SUM(hfe_patpaid)   AS patpaid") \
		_T(" FROM hms_fee_invoiceline_view ") \
		_T(" WHERE hfe_docno  =%ld %s ") \
		_T(" GROUP BY hfe_typeindex,") \
		_T("   hfe_status ,") \
		_T("   hfe_type ,") \
		_T("   hfe_groupid ,") \
		_T("   hfe_groupid3 ,") \
		_T("   hfe_itemid ,") \
		_T("   hfe_name ,") \
		_T("   hfe_unit ,") \
		_T("   hfe_hitech ,") \
		_T("   hfe_inlist,") \
		_T("   hfe_unitprice") \
		_T(" ORDER BY hfe_typeindex, hfe_inlist, hfe_groupid3, hfe_name, hfe_unit, hfe_unitprice"), nDocumentNo, szWhere);



	_fmsg(_T("%s"), szSQL);

	nIndex = 1;
	int nSubItem = 1;
	int nIDX;
	nChapterID = 0;
	CArray<FEEITEM, FEEITEM&> feeList;
	FEEITEM fee;
	CString szName;
	CString szNewIndex, szOldIndex;
	CString szIndex;
	bool bFound = false;
	bool bInList = false;
	bool bOutList = false;
	bool bKList = false;
	int nSubIndex = 1;

	double nTtlCost = 0, nTtlInsCost = 0, nTtlDiscount = 0, nTtlDiffPaid = 0, nTtlPatPaid = 0;
	rs.ExecSQL(szSQL);
	_fmsg(_T("%s"), szSQL);



	while (!grs.IsEOF()) {
		tmpStr.Format(_T("%d"), nIndex);
		grs.GetValue(_T("hft_name"), szName);
		grs.GetValue(_T("hft_id"), szNewIndex);

		fee.szGroupID = _T("Type");
		fee.szID = tmpStr;
		fee.szName = szName;
		nItem = feeList.Add(fee);

		nIDX = nItem;
		bFound = false;
		nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
		nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;

		rs.MoveFirst();
		while (!rs.IsEOF())
		{
			rs.GetValue(_T("typeindex"), tmpStr);

			if (tmpStr == szNewIndex) {
				bFound = true;
				rs.GetValue(_T("groupid"), szNewGroup);
				if (szNewGroup != szOldGroup)
				{
					szOldGroup = szNewGroup;
					if (szNewGroup.Left(2) == _T("B1")) {
						szSQL.Format(_T("SELECT hfg_name FROM hms_fee_group WHERE rtrim(hfg_id,'0')='%s' "), szNewGroup);
						CRecord rs2(&pMF->m_db);
						rs2.ExecSQL(szSQL);
						if (nGroup2Cost > 0) {
							TranslateString(_T("Sub Amount"), tmpStr);
							fee.szGroupID = _T("SubAmount");
							fee.szName = tmpStr;
							fee.nCost = nGroup2Cost;
							fee.nInsPaid = nGroup2InsCost;
							fee.nDiscount = nGroup2Discount;
							fee.nDiffPaid = nGroup2DiffPaid;
							fee.nPatPaid = nGroup2PatPaid;
							int nItem2 = feeList.Add(fee);
						}

						szIndex.Format(_T("%d.%d"), nIndex, nSubIndex++);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = rs2.GetValue(_T("hfg_name"));
						int nItem2 = feeList.Add(fee);
						nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;

					}

				}

				if (szOldIndex != szNewIndex)
				{
					szOldIndex = szNewIndex;
					bInList = false;
					bOutList = false;
				}



				if (szNewIndex == _T("800")) {


					rs.GetValue(_T("inlist"), tmpStr);

					if (tmpStr == _T("1") && !bInList) {
						bInList = true;
						TranslateString(_T("Inside insurance list"), tmpStr);
						szIndex.Format(_T("%d.1"), nIndex);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = tmpStr;
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nDiffPaid = 0;
						fee.nPatDebt = 0;

						int nItem2 = feeList.Add(fee);

					}
					if (tmpStr == _T("2") && !bOutList) {
						bOutList = true;
						TranslateString(_T("Outside insurance list"), tmpStr);
						if (bInList)
							szIndex.Format(_T("%d.2"), nIndex);
						else
							szIndex.Format(_T("%d.1"), nIndex);

						szIndex.Format(_T("%d.1"), nIndex);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = tmpStr;
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nDiffPaid = 0;
						fee.nPatDebt = 0;
						int nItem2 = feeList.Add(fee);
					}

					if (tmpStr == _T("3") && !bKList) {
						bKList = true;
						if (bInList && bOutList)
							szIndex.Format(_T("%d.3"), nIndex);
						else if (bInList || bOutList)
							szIndex.Format(_T("%d.2"), nIndex);
						else
							szIndex.Format(_T("%d.1"), nIndex);

						TranslateString(_T("Inside cancer list"), tmpStr);
						szIndex.Format(_T("%d.1"), nIndex);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = tmpStr;
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nDiffPaid = 0;
						fee.nPatDebt = 0;
						int nItem2 = feeList.Add(fee);
					}


				}

				if (szNewIndex == _T("900")) {

					rs.GetValue(_T("inlist"), tmpStr);

					if (tmpStr == _T("1") && !bInList) {
						bInList = true;
						TranslateString(_T("Inside insurance list"), tmpStr);
						szIndex.Format(_T("%d.1"), nIndex);
						szIndex.Format(_T("%d.1"), nIndex);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = tmpStr;
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nDiffPaid = 0;
						fee.nPatDebt = 0;
						int nItem2 = feeList.Add(fee);
					}
					if (tmpStr == _T("2") && !bOutList) {
						bOutList = true;
						TranslateString(_T("Outside insurance list"), tmpStr);
						if (!bInList)
							szIndex.Format(_T("%d.1"), nIndex);
						else
							szIndex.Format(_T("%d.2"), nIndex);

						szIndex.Format(_T("%d.1"), nIndex);
						fee.szGroupID = _T("Group");
						fee.szID = szIndex;
						fee.szName = tmpStr;
						fee.nCost = 0;
						fee.nInsPaid = 0;
						fee.nDiscount = 0;
						fee.nDiffPaid = 0;
						fee.nPatDebt = 0;
						int nItem2 = feeList.Add(fee);
					}
				}





				rs.GetValue(_T("cost"), nCost);
				rs.GetValue(_T("inscost"), nInsCost);
				rs.GetValue(_T("discount"), nDiscount);
				rs.GetValue(_T("DiffPaid"), nDiffPaid);
				rs.GetValue(_T("copayment"), nPatPaid);

				nTotalCost += nCost;
				nGroup1Cost += nCost;
				nGroup2Cost += nCost;

				nTotalInsCost += nInsCost;
				nGroup1InsCost += nInsCost;
				nGroup2InsCost += nInsCost;

				nTotalDiscount += nDiscount;
				nGroup1Discount += nDiscount;
				nGroup2Discount += nDiscount;

				nTotalDiffPaid += nDiffPaid;
				nGroup1DiffPaid += nDiffPaid;
				nGroup2DiffPaid += nDiffPaid;

				nTotalPatPaid += nPatPaid;
				nGroup1PatPaid += nPatPaid;
				nGroup2PatPaid += nPatPaid;

				fee.szID.Empty();
				fee.szGroupID = _T("Item");
				fee.szName = rs.GetValue(_T("name"));
				fee.szUnit = rs.GetValue(_T("unit"));
				fee.nCost = nCost;
				fee.nInsPaid = nInsCost;
				fee.nDiscount = nDiscount;
				fee.nQuantity = str2float(rs.GetValue(_T("qty")));
				fee.nPrice = str2double(rs.GetValue(_T("unitprice")));
				fee.nInsPrice = str2double(rs.GetValue(_T("insprice")));
				fee.nDiffPaid = nDiffPaid;
				fee.nPatPaid = nPatPaid;
				feeList.Add(fee);

				if (szNewGroup.Left(2) == _T("B4") || szNewGroup.Left(2) == _T("B5")) {
					/*
										double nOperationCost, nOperationInsCost, nOperationDiscount, nOperationDiffCost, nOperationPatPaid;

										bool bHasInOperation=false;
										bool bHasOutsideInsurance = false;

										nOperationCost = nCost;
										nOperationInsCost = nInsCost;
										nOperationDiscount = nDiscount;
										nOperationDiffCost = nDiffPaid;
										nOperationPatPaid = nPatPaid;

										CString szItemID;
										rs.GetValue(_T("itemid"), szItemID);
										CRecord rsi(&pMF->m_db);

										szSQL.Format(_T("SELECT hfe_itemid, hfe_desc, hfe_quantity, hfe_unitprice, hfe_cost, hfe_discount, hfe_diffcost, hfe_patpaid ") \
													_T("FROM hms_fee ") \
													_T("WHERE hfe_docno=%ld and hfe_type='V' and hfe_unit='%s' ORDER BY hfe_itemid DESC "),
													nDocumentNo, szItemID);
										rsi.ExecSQL(szSQL);

										while(!rsi.IsEOF()){
											rsi.GetValue(_T("hfe_itemid"), tmpStr);
											if(tmpStr == _T("VT000001")){
												bHasInOperation = true;
											}
											if(tmpStr == _T("VT000002")){
												bHasOutsideInsurance = true;
											}
											rsi.MoveNext();
										}



										if(m_szObjectType == _T("I") || m_szObjectType == _T("C"))
										{
											szSQL.Format(_T(" SELECT hfe_group, ") \
													_T(" 		hfe_desc as name,") \
													_T(" hfe_unit as unit, ") \
													_T(" hfe_category, ") \
													_T(" 		sum(hfe_quantity) as qty,") \
													_T(" 		hfe_insprice as unitprice,") \
													_T(" 		sum(hfe_inspaid) as cost,") \
													_T(" 		case when hfe_category<>'Y' then sum(hfe_discount) else 0 end as discount,") \
													_T(" 		sum(hfe_DiffPaid) as DiffPaid,") \
													_T(" 		sum(hfe_cost-hfe_discount-hfe_diffcost) as patpaid") \
													_T(" FROM hms_fee_view ") \
													_T(" LEFT JOIN hms_fee_group ON(hfg_id=hfe_group) ") \
													_T(" WHERE hfe_docno=%ld  and hfe_cost > 0  and hfe_class='I'  ") \
													_T(" and hfe_subgroup='%s'   ") \
													_T(" GROUP BY hfg_type_id, hfe_group, hfe_desc, hfe_unit, hfe_insprice, hfe_category, hfe_status ") \
													_T(" ORDER BY hfe_category DESC, hfg_type_id, hfe_group,  name, unitprice"),
													nDocumentNo, szItemID);
										}
										else
										{
											szSQL.Format(_T(" SELECT hfe_group, ") \
													_T(" 		hfe_desc as name,") \
													_T(" hfe_unit as unit, ") \
													_T(" hfe_category, ") \
													_T(" 		sum(hfe_quantity) as qty,") \
													_T(" 		hfe_unitprice as unitprice,") \
													_T(" 		sum(hfe_cost) as cost,") \
													_T(" 		case when hfe_category<>'Y' then sum(hfe_discount) else 0 end as discount,") \
													_T(" 		sum(hfe_DiffPaid) as DiffPaid,") \
													_T(" 		sum(hfe_cost-hfe_discount-hfe_diffcost) as patpaid") \
													_T(" FROM hms_fee_view ") \
													_T(" LEFT JOIN hms_fee_group ON(hfg_id=hfe_group) ") \
													_T(" WHERE hfe_docno=%ld  and hfe_cost > 0  and hfe_class='I'  ") \
													_T(" and hfe_subgroup='%s'   ") \
													_T(" GROUP BY hfg_type_id, hfe_group, hfe_desc, hfe_unit, hfe_unitprice, hfe_category, hfe_status") \
													_T(" ORDER BY hfe_category DESC, hfg_type_id, hfe_group,  name, unitprice"),
													nDocumentNo, szItemID);

										}


												rsl.ExecSQL(szSQL);

												CString szCategory;
												nCost = nInsCost = nPatPaid = nPatPaid = 0;
												nTtlCost = nTtlDiscount = nTtlDiffPaid = nTtlPatPaid = 0;
												double nTtlCost2 = 0, nTtlInsCost2=0, nTtlDiscount2 = 0, nTtlDiffPaid2 = 0, nTtlPatPaid2 = 0;
												bool bInOperation=false, bOutOperation=false;
												while(!rsl.IsEOF()){
													rsl.GetValue(_T("cost"),nCost);
													rsl.GetValue(_T("inscost"),nInsCost);
													rsl.GetValue(_T("discount"), nDiscount);
													rsl.GetValue(_T("DiffPaid"), nDiffPaid);
													rsl.GetValue(_T("patpaid"), nPatPaid);
													if(nDiscount == 0)
													{
													//	nCost = 0;
														//nPatPaid = 0;
														//nDiffPaid = 0;
													}



													rsl.GetValue(_T("hfe_category"), szCategory);
													if(szCategory == _T("Y") && !bInOperation)
													{
														bInOperation = true;
														CString szLabel;
														TranslateString(_T("Inside operation"), szLabel);
														fee.szGroupID = _T("SubItemGroup");
														fee.szID = _T("*");
														fee.szName = szLabel;
														fee.szUnit.Empty();
														fee.nCost = 0;
														fee.nInsPaid = 0;
														fee.nDiscount = 0;
														fee.nDiffPaid = 0;
														fee.nPatDebt = 0;
														feeList.Add(fee);


													}
													if(szCategory != _T("Y") && !bOutOperation)
													{
														CString szLabel;

														bOutOperation = true;

														if(nTtlCost > 0){
															TranslateString(_T("Amount"), tmpStr);
															fee.szGroupID = _T("SubItemAmount");
															fee.szID.Empty();
															fee.szName.Format(_T("   %s"), tmpStr);;
															fee.nCost = nTtlCost;
															fee.nDiscount = nTtlDiscount;
															fee.nDiffPaid = nTtlDiffPaid;
															fee.nPatPaid = nTtlPatPaid;
															feeList.Add(fee);

															nTtlCost = nTtlDiscount = nTtlDiffPaid = nTtlPatPaid = 0;

														}




														TranslateString(_T("Outside operation"), szLabel);

														fee.szGroupID = _T("SubItemGroup");
														fee.szID = _T("*");
														fee.szName = szLabel;
														fee.nCost = 0;
														fee.nInsPaid = 0;
														fee.nDiscount = 0;
														fee.nDiffPaid = 0;
														fee.nPatDebt = 0;

														feeList.Add(fee);


													}


													nTtlCost += nCost;
													nTtlInsCost += nInsCost;
													nTtlDiscount += nDiscount;
													nTtlDiffPaid += nDiffPaid;
													nTtlPatPaid += nPatPaid;




													if(nDiscount +nDiffPaid+nPatPaid > 0)
													{
														nTtlCost2 += nCost;
														nTtlInsCost2 += nInsCost;
														nTtlDiscount2 += nDiscount;
														nTtlDiffPaid2 += nDiffPaid;
														nTtlPatPaid2 += nPatPaid;
													}


													if(szCategory != _T("Y") && !bHasOutsideInsurance){
														nTotalCost += nCost;

														nGroup1Cost += nCost;
														nGroup2Cost += nCost;
														nTotalInsCost += nInsCost;
														nGroup1InsCost += nInsCost;
														nGroup2InsCost += nInsCost;
														nTotalDiscount += nDiscount;
														nGroup1Discount += nDiscount;
														nGroup2Discount += nDiscount;
														nTotalDiffPaid += nDiffPaid;
														nGroup1DiffPaid += nDiffPaid;
														nGroup2DiffPaid += nDiffPaid;
														nTotalPatPaid += nPatPaid;
														nGroup1PatPaid += nPatPaid;
														nGroup2PatPaid += nPatPaid;

													}

													rsl.GetValue(_T("name"), tmpStr);
													fee.szID.Empty();
													fee.szName.Format(_T("      %s"), tmpStr);
													fee.szUnit = rsl.GetValue(_T("unit"));
													fee.szGroupID = _T("SubItem");
													fee.nQuantity = str2double(rsl.GetValue(_T("qty")));
													fee.nPrice = str2double(rsl.GetValue(_T("unitprice")));
													fee.nCost = str2double(rsl.GetValue(_T("cost")));
													fee.nInsPaid = str2double(rsl.GetValue(_T("inscost")));
													fee.nDiscount = str2double(rsl.GetValue(_T("discount")));
													fee.nDiffPaid = str2double(rsl.GetValue(_T("diffpaid")));
													fee.nPatPaid = str2double(rsl.GetValue(_T("patpaid")));
													feeList.Add(fee);
													rsl.MoveNext();
												}

												if(nTtlCost > 0){
													TranslateString(_T("Amount"), tmpStr);
													fee.szGroupID = _T("SubItemAmount");
													fee.szID.Empty();
													fee.szName.Format(_T("   %s"), tmpStr);;
													fee.szUnit.Empty();

													fee.nCost = nTtlCost;
													fee.nDiscount = nTtlDiscount;
													fee.nDiffPaid = nTtlDiffPaid;
													fee.nPatPaid = nTtlPatPaid;
													feeList.Add(fee);

													nTtlCost = nTtlDiscount = nTtlDiffPaid = nTtlPatPaid = 0;

												}

												bool bOutsideOperation = false;


												nCost = nInsCost = nPatPaid  = 0;
												rsi.MoveFirst();
												while(!rsi.IsEOF())
												{
													CString szItemID;
													rsi.GetValue(_T("hfe_itemid"), szItemID);

													fee.szID = _T("*");
													fee.szGroupID = _T("Item");
													fee.szName = rsi.GetValue(_T("hfe_desc"));
													fee.nQuantity = str2double(rsi.GetValue(_T("hfe_quantity")));
													fee.nCost = 0;
													fee.nDiscount = 0;
													fee.nPrice = str2double(rsi.GetValue(_T("hfe_unitprice")));

													if(m_szObjectType == _T("S"))
													{
														rsi.GetValue(_T("hfe_patpaid"), nPatPaid);
														fee.nCost = nPatPaid;
														fee.nDiffPaid = 0;
														fee.nPatPaid = nPatPaid;

														nCost = nPatPaid;
														nDiscount =0;
														nInsCost =0;
														feeList.Add(fee);
														nTtlCost += nCost;
														nTtlPatPaid += nPatPaid;

													}
													else
													{
														rsi.GetValue(_T("hfe_cost"), nCost);
														rsi.GetValue(_T("hfe_discount"), nDiscount);
														rsi.GetValue(_T("hfe_diffcost"), nDiffPaid);
														//rsi.GetValue(_T("hfe_patpaid"), nPatPaid);
														nPatPaid =0;
														fee.nDiffPaid = nDiffPaid;
														fee.nPatPaid = nPatPaid;
														fee.nCost = nCost;
														fee.nDiscount = nDiscount;
														nInsCost = nCost;
														feeList.Add(fee);
														nTtlDiffPaid += nDiffPaid;
														nTtlCost += nCost;
														nTtlInsCost += nInsCost;
														nTtlDiscount += nDiscount;
														nTtlPatPaid += nPatPaid;
													}
													if(nDiscount +nDiffPaid+nPatPaid > 0)
													{
														nTotalCost += nCost;

														nGroup1Cost += nCost;
														nGroup2Cost += nCost;
														nTotalInsCost += nInsCost;
														nGroup1InsCost += nInsCost;
														nGroup2InsCost += nInsCost;
														nTotalDiscount += nDiscount;
														nGroup1Discount += nDiscount;
														nGroup2Discount += nDiscount;
														nTotalDiffPaid += nDiffPaid;
														nGroup1DiffPaid += nDiffPaid;
														nGroup2DiffPaid += nDiffPaid;
														nTotalPatPaid += nPatPaid;
														nGroup1PatPaid += nPatPaid;
														nGroup2PatPaid += nPatPaid;
													}

													bOutsideOperation = true;

													rsi.MoveNext();

												}

					*/
				}	//end B4, B5
			}
			rs.MoveNext();
		}
		if (!bFound)
		{
			feeList.RemoveAt(nIDX);
			nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
			nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;
		}
		else
		{
			if (nGroup1Cost > 0) {
				if (nGroup2Cost > 0 && nGroup1Cost != nGroup2Cost) {
					TranslateString(_T("Sub Amount"), tmpStr);
					fee.szGroupID = _T("SubAmount");
					fee.szID.Empty();;
					fee.szName = tmpStr;
					fee.nCost = nGroup2Cost;
					fee.nInsPaid = nGroup2InsCost;
					fee.nDiscount = nGroup2Discount;
					fee.nDiffPaid = nGroup2DiffPaid;
					fee.nPatPaid = nGroup2PatPaid;
					feeList.Add(fee);
				}

				TranslateString(_T("Total"), tmpStr);
				tmpStr.AppendFormat(_T(" (%d)"), nIndex);
				fee.szGroupID = _T("GrandAmount");
				fee.szID.Empty();;
				fee.szName = tmpStr;
				fee.nCost = nGroup1Cost;
				fee.nInsPaid = nGroup1InsCost;
				fee.nDiscount = nGroup1Discount;
				fee.nDiffPaid = nGroup1DiffPaid;
				fee.nPatPaid = nGroup1PatPaid;
				feeList.Add(fee);
			}
			nGroup1Cost = nGroup1InsCost = nGroup1Discount = nGroup1DiffPaid = nGroup1PatPaid = 0;
			nGroup2Cost = nGroup2InsCost = nGroup2Discount = nGroup2DiffPaid = nGroup2PatPaid = 0;

			nIndex++;
		}



		grs.MoveNext();
	}

	nTotalCost = ceil(nTotalCost);
	nTotalInsCost = ceil(nTotalInsCost);
	nTotalDiscount = ceil(nTotalDiscount);
	nTotalDiffPaid = ceil(nTotalDiffPaid);
	nTotalPatPaid = ceil(nTotalPatPaid);
	nTotalPayable = nTotalCost - nTotalDiscount;
	nTotalDiscount = nTotalDiscount;

	TranslateString(_T("Total Amount"), szName);
	fee.szGroupID = _T("TotalAmount");
	fee.szName.Format(_T("%s "), szName);
	fee.nCost = nTotalCost;
	fee.nInsPaid = nTotalInsCost;
	fee.nDiscount = nTotalDiscount;
	fee.nDiffPaid = nTotalDiffPaid;
	fee.nPatPaid = nTotalPatPaid;
	feeList.Add(fee);

	nSumCost += nTotalCost;
	nSumInsCost += nTotalInsCost;
	nSumDiscount += nTotalDiscount;
	nSumDiffPaid += nTotalDiffPaid;
	nSumPatPaid += nTotalPatPaid;


	for (int i = 0; i < feeList.GetCount(); i++) {
		fee = feeList[i];
		szType = fee.szGroupID;

		if (szType == _T("Type"))
		{
			grp = rpt.GetGroupHeader(1);
			rptDetail = rpt.AddDetail(grp);
			tmpStr = fee.szID;
			rptDetail->SetValue(_T("TypeID"), tmpStr);
			StringUpper(fee.szName, tmpStr);
			rptDetail->SetValue(_T("TypeName"), tmpStr);
		}
		else if (szType == _T("Group")) {
			grp = rpt.GetGroupHeader(1);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("TypeID"), fee.szID);
			rptDetail->SetValue(_T("TypeName"), fee.szName);
		}
		else if (szType == _T("SubGroup")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("SubGroupID"), fee.szID);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);


			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}
		}
		else if (szType == _T("SubAmount")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			CReportItem* obj;
			obj = rptDetail->GetItem(_T("SubGroupName")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupCost")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupDiscount")); if (obj) obj->SetBold(true);
			obj = rptDetail->GetItem(_T("SubGroupPatpaid")); if (obj) obj->SetBold(true);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);


			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}

		}
		else if (szType == _T("GrandAmount")) {
			grp = rpt.GetGroupHeader(2);
			rptDetail = rpt.AddDetail(grp);
			//	rptDetail->GetItem(_T("SubGroupName"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupCost"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupDiscount"))->SetBold(true);
			//	rptDetail->GetItem(_T("SubGroupPatpaid"))->SetBold(true);
			rptDetail->SetValue(_T("SubGroupName"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupDiffPaid"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("SubGroupPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("SubGroupInsUnPaid"), tmpStr);
			}

		}

		else if (szType == _T("Item")) {
			rptDetail = rpt.AddDetail();
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), fee.szUnit);
			FormatCurrency(fee.nQuantity, tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), tmpStr);

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}

		}
		else if (szType == _T("SubItemGroup")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj)
				{
					obj->SetItalic(true);
					obj->SetBold(true);
				}

			}
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), _T(""));
			rptDetail->SetValue(_T("4"), _T(""));
			rptDetail->SetValue(_T("5"), _T(""));

		}

		else if (szType == _T("SubItem")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj) obj->SetItalic(true);
			}

			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), fee.szUnit);
			FormatCurrency(fee.nQuantity, tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), tmpStr);

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}

		}
		else if (szType == _T("SubItemAmount")) {
			rptDetail = rpt.AddDetail();
			CReportItem* obj = NULL;
			for (int i = 1; i <= 9; i++)
			{
				obj = rptDetail->GetItem(i);
				if (obj)
				{
					obj->SetItalic(true);
					obj->SetBold(true);
				}

			}
			rptDetail->SetValue(_T("1"), fee.szID);
			rptDetail->SetValue(_T("2"), fee.szName);
			rptDetail->SetValue(_T("3"), _T(""));
			rptDetail->SetValue(_T("4"), _T(""));
			FormatCurrency(fee.nPrice, tmpStr);
			rptDetail->SetValue(_T("5"), _T(""));

			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("10"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);

			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);


			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("11"), tmpStr);
			}

		}

		else if (szType == _T("Dousage")) {
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(4));
			rptDetail->SetValue(_T("usage"), fee.szName);
		}
		else if (szType == _T("TotalAmount")) {
			grp = rpt.GetGroupHeader(3);
			rptDetail = rpt.AddDetail(grp);
			rptDetail->SetValue(_T("TotalAmountLabel"), fee.szName);
			FormatCurrency(fee.nCost, tmpStr);
			rptDetail->SetValue(_T("TotalAmount"), tmpStr);

			FormatCurrency(fee.nInsPaid, tmpStr);
			rptDetail->SetValue(_T("TotalInsCost"), tmpStr);

			FormatCurrency(fee.nDiscount, tmpStr);
			rptDetail->SetValue(_T("TotalDiscount"), tmpStr);

			FormatCurrency(fee.nDiffPaid, tmpStr);
			rptDetail->SetValue(_T("TotalDiffPaid"), tmpStr);
			//fee.nPatPaid= fee.nCost-fee.nDiscount;
			FormatCurrency(fee.nPatPaid, tmpStr);
			rptDetail->SetValue(_T("TotalPatPaid"), tmpStr);

			if (fee.nDiscount > 0)
			{
				FormatCurrency(fee.nPatPaid - fee.nDiffPaid, tmpStr);
				rptDetail->SetValue(_T("TotalInsUnPaid"), tmpStr);
			}
		}
	}


	if (nTotalCost != nSumCost) {
		CString szName;
		TranslateString(_T("Total Amount"), tmpStr);
		szName.Format(_T("%s"), tmpStr);
		grp = rpt.GetGroupHeader(3);
		rptDetail = rpt.AddDetail(grp);
		rptDetail->SetValue(_T("TotalAmountLabel"), szName);
		FormatCurrency(nSumCost, tmpStr);
		rptDetail->SetValue(_T("TotalAmount"), tmpStr);

		FormatCurrency(nSumInsCost, tmpStr);
		rptDetail->SetValue(_T("TotalInsCost"), tmpStr);

		FormatCurrency(nSumDiscount, tmpStr);
		rptDetail->SetValue(_T("TotalDiscount"), tmpStr);

		FormatCurrency(nSumDiffPaid, tmpStr);
		rptDetail->SetValue(_T("TotalDiffPaid"), tmpStr);
		FormatCurrency(nSumPatPaid, tmpStr);
		rptDetail->SetValue(_T("TotalPatPaid"), tmpStr);
	}

	szSQL.Format(_T(" SELECT hfe_amount as hfe_amount,") \
		_T("   hfe_inspaid,") \
		_T("   hfe_discount,") \
		_T("   hfe_patpaid,") \
		_T("   hfe_payment,") \
		_T("   hfe_diffcost,") \
		_T("   hfe_diffpaid,") \
		_T("   hfe_deposit,") \
		_T("   hfe_refund,") \
		_T("   hfe_freeamount") \
		_T(" FROM hms_fee_invoice") \
		_T(" WHERE hfe_invoiceno=%ld"), nInvoiceNo);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		double nTotalDiffPaid;
		double nTotalPayment;
		double nTotalPatPaid;

		rs.GetValue(_T("hfe_amount"), nTotalCost);
		rs.GetValue(_T("hfe_inspaid"), nTotalInsCost);
		rs.GetValue(_T("hfe_discount"), nTotalDiscount);
		rs.GetValue(_T("hfe_patpaid"), nTotalPatPaid);
		rs.GetValue(_T("hfe_diffcost"), nTotalDiffPaid);
		rs.GetValue(_T("hfe_deposit"), nTotalDeposit);
		rs.GetValue(_T("hfe_refund"), nTotalRefund);
		rs.GetValue(_T("hfe_freeamount"), nTotalFree);
		rs.GetValue(_T("hfe_payment"), nTotalPayment);




		rpt.GetReportFooter()->SetValue(_T("PatientSign"), szPatientName);
		FormatCurrency((nTotalCost), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumAmount"), tmpStr);
		CString szSumInWord;
		tmpStr.Format(_T("%.0f"), nTotalCost);
		MoneyToString(tmpStr, szSumInWord);
		szSumInWord += _T(" \x111\x1ED3ng.");
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), szSumInWord);

		FormatCurrency(nTotalInsCost, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumInsCost"), tmpStr);


		FormatCurrency(nTotalDiscount, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumInsDiscount"), tmpStr);

		FormatCurrency(nTotalPatPaid, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumInsUnPaid"), tmpStr);

		FormatCurrency((nTotalDiffPaid), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumDiffPaid"), tmpStr);


		FormatCurrency(nTotalPatPaid, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumPatPaid"), tmpStr);



		FormatCurrency((nTotalDeposit), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumDeposit"), tmpStr);

		FormatCurrency(nTotalFree, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumDiscount"), tmpStr);

		FormatCurrency(nSumFoodAmount, tmpStr);
		rpt.GetReportFooter()->SetValue(_T("SumFoodAmount"), tmpStr);

		if (nTotalRefund > 0)
		{
			//	FormatCurrency(nTotalRefund, tmpStr);
			//	rpt.GetReportFooter()->SetValue(_T("SumPayment"), tmpStr);

			FormatCurrency(nTotalRefund, tmpStr);
			rpt.GetReportFooter()->SetValue(_T("SumRefund"), tmpStr);
		}
		else
		{
			FormatCurrency(nTotalPayment, tmpStr);
			rpt.GetReportFooter()->SetValue(_T("SumPayment"), tmpStr);

		}

	}

	int nInsRate;
	rs.GetValue(_T("disrate"), nInsRate);
	if (nInsRate > 0)
	{
		int nUnRate = 100 - nInsRate;
		if (nUnRate == 0)
			nUnRate = nInsRate;

		tmpStr.Format(_T("(%d%s)"), nUnRate, _T("%"));
		rpt.GetReportFooter()->SetValue(_T("UnRate"), tmpStr);
	}

	//	szSQL.Format(_T("UPDATE hms_fee_invoice SET hfe_print=hfe_print+1 WHERE hfe_invoiceno=%ld "), nInvoiceNo);
	//	ExecSQL(szSQL);

	//	rpt.Print();
	rpt.PrintPreview();

}

void CPrintForms::E10_PrintSaleExport(long nOID) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CString szSQL, tmpStr, szMoney, szSysDate;
	CReport rpt;
	CReportSection* rptHeader = NULL, * rptDetail = NULL, * rptFooter = NULL;
	int nIdx = 1, nQty = 0, nTmp = 0;
	double nAmt = 0;
	double nTtlAmt = 0;
	CRecord rs(&pMF->m_db);
	CString szPath, szFileTitle;
	if (pMF->GetModuleID() == _T("PM") || pMF->GetModuleID() == _T("BB"))
	{
		szFileTitle = _T("PMS_DRUGEXPORT");
	}
	else
	{
		szFileTitle.Format(_T("%s_DRUGEXPORT"), pMF->GetModuleID());
	}
	szPath.Format(_T("Reports/HMS/%s.RPT"), szFileTitle);
	if (!rpt.Init(szPath))
		return;
	szSQL.Format(_T(" SELECT so_documentno                  documentno, ") \
		_T("        so_orderno                     orderno, ") \
		_T("        N''                            department, ") \
		_T("        so_orderdate                   orderdate, ") \
		_T("        Get_storagename(so_storage_id) storagename, ") \
		_T("        so_description descr") \
		_T(" FROM   sale_order ") \
		_T(" WHERE so_sale_order_id = %ld"), nOID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		rptHeader->SetValue(_T("ReferenceNo"), rs.GetValue(_T("documentno")));
		rptHeader->SetValue(_T("InvoiceNo"), rs.GetValue(_T("orderno")));
		rptHeader->SetValue(_T("orderdate"), CDate::Convert(rs.GetValue(_T("orderdate")), yyyymmdd, ddmmyyyy));
		rptHeader->SetValue(_T("stockname"), rs.GetValue(_T("storagename")));
		rptHeader->SetValue(_T("note"), rs.GetValue(_T("descr")));
	}
	szSQL.Format(_T(" SELECT    product_name product_name, ") \
		_T("           product_uomname uom_name, ") \
		_T("           product_lotno lot_no, ") \
		_T("           case when product_hasexp = 'Y' then product_expdate else null end exp_date, ") \
		_T("           SUM(sol_qtyorder) qty, ") \
		_T("           sol_unitprice price, ") \
		_T("           SUM(sol_qtyorder) * sol_unitprice amount ") \
		_T(" FROM      sale_orderline ") \
		_T(" LEFT JOIN m_productitem_view ON ( sol_product_item_id = product_item_id ) ") \
		_T(" WHERE     sol_sale_order_id = %ld ") \
		_T(" GROUP     BY product_name, ") \
		_T("              product_uomname, ") \
		_T("              product_lotno, ") \
		_T("              product_expdate, ") \
		_T("			  product_hasexp,") \
		_T("              sol_unitprice "), nOID);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx++));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("product_name")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("uom_name")));
		rptDetail->SetValue(_T("4"), CDate::Convert(rs.GetValue(_T("exp_date")), yyyymmdd, ddmmyyyy));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("lot_no")));
		rs.GetValue(_T("qty"), nTmp);
		nQty += nTmp;
		rptDetail->SetValue(_T("6"), int2str(nTmp));
		rptDetail->SetValue(_T("8"), rs.GetValue(_T("price")));
		rs.GetValue(_T("amount"), nAmt);
		nTtlAmt += nAmt;
		rptDetail->SetValue(_T("9"), double2str(nAmt));
		rs.MoveNext();
	}
	nIdx--;
	rptFooter = rpt.GetReportFooter();
	if (rptFooter)
	{
		rptFooter->SetValue(_T("TotalItem"), int2str(nIdx));
		tmpStr.Format(_T("%f"), nTtlAmt);
		MoneyToString(tmpStr, szMoney);
		szMoney += _T(" \x111\x1ED3ng.");
		rptFooter->SetValue(_T("TotalAmount"), tmpStr);
		rptFooter->SetValue(_T("SumInWord"), szMoney);
		szSysDate = pMF->GetSysDate();
		tmpStr.Format(rptFooter->GetValue(_T("PrintDate")), pMF->GetSysTime().Left(5), szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
		rptFooter->SetValue(_T("PrintDate"), tmpStr);
	}
	rpt.PrintPreview();
}

void CPrintForms::E10_PrintSaleImport(long nOID) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptFooter = NULL;
	int nIdx = 1;
	double nCost = 0;
	double nTtlCost = 0;
	if (!rpt.Init(_T("Reports\\HMS\\MA_PHIEUNHAPKHO.RPT")))
		return;
	CString szSQL, tmpStr, tmpStr2;
	szSQL.Format(_T("SELECT hpo_pharmareturnorder_id order_no,") \
		_T("		hpo_createddate order_date, get_storagename(hpo_storage_id) storage_name,") \
		_T("		hpo_documentno document_no") \
		_T(" FROM	hms_pharmareturnorder") \
		_T(" WHERE	hpo_status = 'A'") \
		_T(" AND	hpo_pharmareturnorder_id = %ld"), nOID);
	_fmsg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		rptHeader->SetValue(_T("ReferenceNo"), rs.GetValue(_T("document_no")));
		rptHeader->SetValue(_T("OrderNo"), rs.GetValue(_T("order_no")));
		rs.GetValue(_T("order_date"), tmpStr2);
		tmpStr = CDate::Convert(tmpStr2, yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("OrderDate"), tmpStr);
		rptHeader->SetValue(_T("StockName"), rs.GetValue(_T("storage_name")));
		rptHeader->SetValue(_T("Reason"), _T(""));
	}
	szSQL.Format(_T("SELECT product_name,") \
		_T("		product_uomname,") \
		_T("		case when product_hasexp = 'Y' then product_expdate else null end product_expdate,") \
		_T("		product_lotno,") \
		_T("		sum(hpol_qtyreturn) hpol_qtyreverse,") \
		_T("		hpol_unitprice,")
		_T("		sum(hpol_qtyreturn*hpol_unitprice) amount") \
		_T(" FROM hms_pharmareturnorder_line") \
		_T(" LEFT JOIN m_productitem_view ON (hpol_product_item_id = product_item_id)") \
		_T(" WHERE hpol_pharmareturnorder_id = %ld") \
		_T(" GROUP BY product_name, product_uomname, product_hasexp, product_expdate, product_lotno, hpol_unitprice"), nOID);
	_fmsg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx++));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("product_name")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("product_uomname")));
		rs.GetValue(_T("product_expdate"), tmpStr2);
		tmpStr = CDate::Convert(tmpStr2, yyyymmdd, ddmmyyyy);
		rptDetail->SetValue(_T("4"), tmpStr);
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("product_lotno")));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("hpol_qtyreverse")));
		rptDetail->SetValue(_T("7"), rs.GetValue(_T("hpol_unitprice")));
		rptDetail->SetValue(_T("8"), rs.GetValue(_T("")));
		rs.GetValue(_T("amount"), nCost);
		nTtlCost += nCost;
		rptDetail->SetValue(_T("9"), double2str(nCost));
		rs.MoveNext();
	}
	rptDetail = NULL;
	tmpStr2.Format(_T("%f"), nTtlCost);
	rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
	if (rptDetail)
		rptDetail->SetValue(_T("s9"), tmpStr2);
	rptFooter = rpt.GetReportFooter();
	nIdx--;
	rptFooter->SetValue(_T("TotalItem"), int2str(nIdx));
	MoneyToString(tmpStr2, tmpStr);
	tmpStr += _T(" \x111\x1ED3ng");
	rptFooter->SetValue(_T("SumInWord"), tmpStr);
	tmpStr2 = pMF->GetSysDate();
	tmpStr.Format(rptFooter->GetValue(_T("PrintDate")), tmpStr2.Mid(8, 2), tmpStr2.Mid(5, 2), tmpStr2.Left(4));
	rptFooter->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::E10_PrintReturnImport(long nOID) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptFooter = NULL;
	int nIdx = 1;
	double nCost = 0;
	double nTtlCost = 0;
	if (!rpt.Init(_T("Reports\\HMS\\MA_PHIEUNHAPKHO.RPT")))
		return;
	CString szSQL, tmpStr, tmpStr2;
	szSQL.Format(_T("SELECT mt_orderno order_no,") \
		_T("		mt_orderdate order_date,") \
		_T("		get_storagename(mt_storage_to_id) storage_name,") \
		_T("		mt_description descr,") \
		_T("		mt_documentno document_no,") \
		_T("		mt_deliveryby deliver_by,") \
		_T("		mt_receiveby receive_by") \
		_T(" FROM m_transaction") \
		_T(" WHERE mt_transaction_id = %ld"), nOID);
	_fmsg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		rptHeader->SetValue(_T("ReferenceNo"), rs.GetValue(_T("document_no")));
		rptHeader->SetValue(_T("OrderNo"), rs.GetValue(_T("order_no")));
		rs.GetValue(_T("order_date"), tmpStr2);
		tmpStr = CDate::Convert(tmpStr2, yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("OrderDate"), tmpStr);
		rptHeader->SetValue(_T("StockName"), rs.GetValue(_T("storage_name")));
		rptHeader->SetValue(_T("Reason"), rs.GetValue(_T("descr")));
		rptHeader->SetValue(_T("DeliverBy"), rs.GetValue(_T("deliver_by")));
		rptHeader->SetValue(_T("ReceiveBy"), rs.GetValue(_T("receive_by")));
	}
	if (pMF->GetModuleID() != _T("MA"))
		szSQL.Format(_T("SELECT product_name,") \
			_T("		product_uomname,") \
			_T("		case when product_hasexp = 'Y' then product_expdate else null end product_expdate,") \
			_T("		product_lotno,") \
			_T("		sum(mtl_qtyorder) mtl_qtyreverse,") \
			_T("		DECODE(0, mtl_saleprice, mtl_taxprice, mtl_saleprice) mtl_saleprice,")
			_T("		sum(mtl_qtyorder*DECODE(0, mtl_saleprice, mtl_taxprice, mtl_saleprice)) amount") \
			_T(" FROM m_transactionline") \
			_T(" LEFT JOIN m_productitem_view ON (mtl_product_item_id = product_item_id)") \
			_T(" WHERE  mtl_transaction_id = %ld") \
			_T(" GROUP BY product_uomindex, product_name, product_uomname, product_hasexp, product_expdate, product_lotno, mtl_saleprice, mtl_taxprice") \
			_T(" ORDER BY product_uomindex, product_name, product_uomname, product_expdate"), nOID);
	else
		szSQL.Format(_T("SELECT product_name,") \
			_T("		product_uomname,") \
			_T("		case when product_hasexp = 'Y' then product_expdate else null end product_expdate,") \
			_T("		product_lotno,") \
			_T("		sum(mtl_qtyorder) mtl_qtyreverse,") \
			_T("		product_taxprice mtl_saleprice,")
			_T("		sum(mtl_qtyorder*product_taxprice) amount") \
			_T(" FROM m_transactionline") \
			_T(" LEFT JOIN m_productitem_view ON (mtl_product_item_id = product_item_id)") \
			_T(" WHERE  mtl_transaction_id = %ld") \
			_T(" GROUP BY product_uomindex, product_name, product_uomname, product_hasexp, product_expdate, product_lotno, product_taxprice")	\
			_T(" ORDER BY product_uomindex, product_name, product_uomname, product_expdate"), nOID);
	_fmsg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx++));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("product_name")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("product_uomname")));
		rs.GetValue(_T("product_expdate"), tmpStr2);
		tmpStr = CDate::Convert(tmpStr2, yyyymmdd, ddmmyyyy);
		rptDetail->SetValue(_T("4"), tmpStr);
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("product_lotno")));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("mtl_qtyreverse")));
		rptDetail->SetValue(_T("7"), rs.GetValue(_T("mtl_saleprice")));
		rptDetail->SetValue(_T("8"), rs.GetValue(_T("")));
		rs.GetValue(_T("amount"), nCost);
		nTtlCost += nCost;
		rptDetail->SetValue(_T("9"), double2str(nCost));
		rs.MoveNext();
	}
	rptDetail = NULL;
	tmpStr2.Format(_T("%f"), nTtlCost);
	rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
	if (rptDetail)
		rptDetail->SetValue(_T("s9"), tmpStr2);
	rptFooter = rpt.GetReportFooter();
	nIdx--;
	rptFooter->SetValue(_T("TotalItem"), int2str(nIdx));
	MoneyToString(tmpStr2, tmpStr);
	tmpStr += _T(" \x111\x1ED3ng");
	rptFooter->SetValue(_T("SumInWord"), tmpStr);
	tmpStr2 = pMF->GetSysDate();
	tmpStr.Format(rptFooter->GetValue(_T("PrintDate")), tmpStr2.Mid(8, 2), tmpStr2.Mid(5, 2), tmpStr2.Left(4));
	rptFooter->SetValue(_T("PrintDate"), tmpStr);
	rptFooter->SetValue(_T("prepared_by"), pMF->GetUserName(pMF->GetCurrentUser()));
	rpt.PrintPreview();
}

void CPrintForms::TM_PrintDailyValuableMaterial(long nDocNo, long nOpIdx) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL;
	CString szSQL, szOldType, szNewType, tmpStr, szSysDate;
	int nIdx = 1, nGroup = 0;
	double nGrpAmt = 0, nAmt = 0;
	CRecord rs(&pMF->m_db);
	CStringArray arrGroup;
	arrGroup.Add(_T("I"));
	arrGroup.Add(_T("II"));
	arrGroup.Add(_T("III"));
	arrGroup.Add(_T("IV"));
	arrGroup.Add(_T("V"));
	arrGroup.Add(_T("VI"));
	if (!rpt.Init(_T("Reports\\HMS\\TM_SURGERYPRESCRIPTIONORDER.RPT")))
		return;
	szSQL.Format(_T(" SELECT   hd_docno doc_no, ") \
		_T("           hcr_recordno record_no, ") \
		_T("           get_departmentname(ho_deptid) dept_name, ") \
		_T("           Get_patientname(hd_docno) patient_name, ") \
		_T("           Extract(year FROM hp_birthdate) yob, ") \
		_T("           get_syssel_desc('sys_sex', hp_sex) sex, ") \
		_T("           hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) addr, ") \
		_T("           get_objectname(hd_object) obj_name, ") \
		_T("           get_syssel_desc('hms_rank', hd_rank) rank_name, ") \
		_T("           hd_cardno card_no, ") \
		_T("           hd_diagnostic diagnostic, ") \
		_T("           get_departmentname(ho_pdeptid) pdept_name , ") \
		_T("		   ho_opera_table op_table,") \
		_T("           ho_comment op_name") \
		_T(" FROM      hms_op_materialorder ") \
		_T(" LEFT JOIN hms_doc ON ( hd_docno = hopm_docno ) ") \
		_T(" LEFT JOIN hms_clinical_record ON ( hcr_docno = hd_docno ) ") \
		_T(" LEFT JOIN hms_patient ON ( hp_patientno = hd_patientno ) ") \
		_T(" LEFT JOIN hms_operation ON ( ho_idx = hopm_operation_id ) ") \
		_T(" WHERE     hd_docno = %ld"), nDocNo);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		//AfxMessageBox(_T("Không có dữ liệu!"), MB_OK);
		return;
	}
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		rptHeader->SetValue(_T("Department"), rs.GetValue(_T("dept_name")));
		rptHeader->SetValue(_T("DocumentNo"), rs.GetValue(_T("doc_no")));
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("record_no")));
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("patient_name")));
		rptHeader->SetValue(_T("age"), rs.GetValue(_T("yob")));
		rptHeader->SetValue(_T("sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("address"), rs.GetValue(_T("addr")));
		rptHeader->SetValue(_T("object"), rs.GetValue(_T("obj_name")));
		rptHeader->SetValue(_T("rank"), rs.GetValue(_T("rank_name")));
		rptHeader->SetValue(_T("cardno"), rs.GetValue(_T("card_no")));
		rptHeader->SetValue(_T("diagnostic"), rs.GetValue(_T("diagnostic")));
		rptHeader->SetValue(_T("pdepartment"), rs.GetValue(_T("pdept_name")));
		rptHeader->SetValue(_T("surgeryname"), rs.GetValue(_T("op_name")));
		rptHeader->SetValue(_T("surgerytable"), rs.GetValue(_T("op_table")));
	}
	szSQL.Format(_T(" SELECT    product_producttype, ") \
		_T("		   get_producttypename(product_producttype) typename,") \
		_T("           product_name, ") \
		_T("           product_manufacturename, ") \
		_T("           product_uomname, ") \
		_T("           hopm_unitprice, ") \
		_T("           hopm_qtyissue, ") \
		_T("           hopm_amount ") \
		_T(" FROM      hms_op_materialorder ") \
		_T(" LEFT JOIN m_product_view ON ( product_id = hopm_product_id ) ") \
		_T(" WHERE     hopm_docno = %ld ") \
		_T("       AND hopm_operation_id = %ld"), nDocNo, nOpIdx);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF())
	{
		rs.GetValue(_T("product_producttype"), szNewType);
		if (szNewType != szOldType)
		{
			if (nGrpAmt > 0)
			{
				rptDetail = rpt.AddDetail(rpt.GetGroupFooter(0));
				tmpStr.Format(_T("%s (%s)"), rptDetail->GetValue(_T("TotalAmount")), arrGroup.GetAt(nGroup));
				rptDetail->Format(_T("TotalAmount"), tmpStr);
				rptDetail->SetValue(_T("s6"), double2str(nGrpAmt));
				nGrpAmt = 0;
				nGroup++;
			}
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
			tmpStr.Format(_T("%s. %s"), arrGroup.GetAt(nGroup), rs.GetValue(_T("typename")));
			rptDetail->SetValue(_T("GroupName"), tmpStr);
			szOldType = szNewType;
		}
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx++));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("product_name")));
		rptDetail->SetValue(_T("7"), rs.GetValue(_T("product_manufacturename")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("product_uomname")));
		rs.GetValue(_T("hopm_unitprice"), nAmt);
		FormatCurrency(nAmt, tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("hopm_qtyissue")));
		rs.GetValue(_T("hopm_amount"), nAmt);
		nGrpAmt += nAmt;
		FormatCurrency(nAmt, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rs.MoveNext();
	}
	if (nGrpAmt > 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(0));
		tmpStr.Format(_T("%s (%s)"), rptDetail->GetValue(_T("TotalAmount")), arrGroup.GetAt(nGroup));
		rptDetail->SetValue(_T("TotalAmount"), tmpStr);
		FormatCurrency(nGrpAmt, tmpStr);
		rptDetail->SetValue(_T("s6"), tmpStr);
	}
	szSysDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();

}

void CPrintForms::TM_DepositRequestForm(long nDocNo, CString szDeptID, long nAmount) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szSQL, szDate = pMF->GetSysDate();
	CRecord rs(&pMF->m_db);
	tmpStr = _T("Reports\\HMS\\TM_GIAYYEUCAUTAMUNG.RPT");
	if (!rpt.Init(tmpStr))
		return;
	szSQL.Format(_T(" SELECT    Get_patientname(hd_docno)       patient_name, ") \
		_T("           hms_getagebydoc(hd_docno) age, ") \
		_T("		   get_syssel_desc('sys_sex', hp_sex) sex,") \
		_T("           Get_objectname(hd_object)       object_name, ") \
		_T("		   hd_cardno card_no,") \
		_T("           hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) ") \
		_T("           ||' ' ") \
		_T("           || hp_dtladdr                   addr, ") \
		_T("		   hms_getroomname(hb_deptid, hb_roomid) room_name") \
		_T(" FROM      hms_doc ") \
		_T(" LEFT JOIN hms_patient ON ( hd_patientno = hd_patientno ) ") \
		_T(" LEFT JOIN hms_bed ON (hb_docno = hd_docno AND hb_status = 'O')") \
		_T(" WHERE hd_docno = %ld"), nDocNo);

	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
		rpt.GetReportHeader()->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);
		rpt.GetReportHeader()->SetValue(_T("DocumentNo"), long2str(nDocNo));
		rpt.GetReportHeader()->SetValue(_T("Department"), pMF->GetDepartmentName(szDeptID));
		rpt.GetReportHeader()->SetValue(_T("PatientName"), rs.GetValue(_T("patient_name")));
		rpt.GetReportHeader()->SetValue(_T("Age"), rs.GetValue(_T("age")));
		rpt.GetReportHeader()->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rpt.GetReportHeader()->SetValue(_T("Address"), rs.GetValue(_T("addr")));
		rpt.GetReportHeader()->SetValue(_T("Object"), rs.GetValue(_T("object_name")));
		rpt.GetReportHeader()->SetValue(_T("CardNo"), rs.GetValue(_T("card_no")));
		rpt.GetReportHeader()->SetValue(_T("RoomName"), rs.GetValue(_T("room_name")));
		rpt.GetReportHeader()->SetValue(_T("TotalAmount"), long2str(nAmount));
		MoneyToString(long2str(nAmount), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("SumInWord"), tmpStr);
		tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Mid(8, 2), szDate.Mid(5, 2), szDate.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	}
	rpt.PrintPreview();

}

void CPrintForms::PrintTestOrderX(long nOrderID, bool bPreview, bool bDirect) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	//_msg(_T("Hi"));
	CReport rpt;
	CString tmpStr, szGroupID, szSex, szStatus;
	CString szReportName, szOrderName;
	CString szSQL;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rs3(&pMF->m_db);
	CRecord rsal(&pMF->m_db);
	long nDocumentNo;
	int nRefIndex, nRoomID;
	int nNumberOrder = 0, n_count = 0;
	CString tmpStr2, szDeptType;
	CString szFormID;


	if (pMF->GetObjectType() == _T("I"))
	{
		szSQL.Format(_T(" SELECT Count(*)") \
			_T(" FROM   HMS_PACS_TEST_VIEW_LINE") \
			_T(" WHERE  hpcl_orderid = %ld AND hpcl_itemid IN (SELECT ss_code FROM   sys_sel WHERE  ss_id = 'HMS_FEE_LIST_APPROVAL') "), nOrderID);
		rs.ExecSQL(szSQL);
		//_msg(_T("%s"), szSQL);
		n_count = (rs.GetIntValue());
		//_msg(_T("%d"), n_count);
	}


	if (pMF->GetModuleID() != _T("EM") && pMF->GetModuleID() != _T("SOM") && (pMF->GetModuleID() == _T("TM") && n_count <= 0))
		return;


	szSQL.Format(_T("SELECT * FROM hms_testorder WHERE hpc_orderid=%ld "), nOrderID);

	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
		return;

	rs.GetValue(_T("hpc_groupid"), szGroupID);
	rs.GetValue(_T("hpc_docno"), nDocumentNo);
	rs.GetValue(_T("hpc_refidx"), nRefIndex);
	rs.GetValue(_T("hpc_roomid"), nRoomID);
	rs.GetValue(_T("hpc_status"), szStatus);
	rs.GetValue(_T("hpc_depttype"), szDeptType);

	szSQL.Format(_T("SELECT hfg_report as reportname FROM hms_fee_group WHERE hfg_id='%s' "), szGroupID);
	rs2.ExecSQL(szSQL);
	if (!rs2.IsEOF())
		rs2.GetValue(_T("reportname"), tmpStr);

	if (tmpStr.IsEmpty())
		tmpStr = _T("PACS_VOTE.RPT");
	tmpStr.Trim();
	tmpStr.Replace(_T("_"), _T("O_"));
	szReportName.Format(_T("Reports/HMS/%s"), tmpStr);

	szReportName.Trim();

	if (!rpt.Init(szReportName))
	{
		return;
	}


	szSQL.Format(_T(" SELECT 	hd_patientno as patientno,  ") \
		_T(" 	hd_docno as docno,") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	CAST(TO_CHAR(hp_birthdate, 'YYYY') as integer) as birthyear,") \
		_T(" 	hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age, 	hp_sex as sexid,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T(" 	hp_occupation as occupationid,") \
		_T(" 	sys_sel_getname('sys_occupation', cast(hp_occupation as varchar(15))) as occupation,") \
		_T(" 	nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T(" 	hms_getaddress(hp_provid,hp_distid,hp_villid) as address,") \
		_T(" 	hp_workplaceid as workplaceid,") \
		_T(" 	hp_workplace as workplace,") \
		_T(" 	hd_object as objectid,") \
		_T(" 	(SELECT ho_desc FROM hms_object WHERE ho_id=hd_object) as objectname,") \
		_T(" 	hd_cardno as cardno,") \
		_T(" 	hd_cardidx as cardidx, ") \
		_T(" 	hd_reldisease as relationdisease, ") \
		_T("	trim(hd_diagnostic) ||' ['||trim(hd_icd)||']' as diagnostic, ") \
		_T(" 	hc_regdate as regdate, ") \
		_T(" 	hc_expdate as expdate ") \
		_T(" FROM hms_patient") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno)") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hd_docno=%ld"), nDocumentNo);
	//_fmsg(_T("%s"), szSQL);
	int ret = rs2.ExecSQL(szSQL);
	if (rs2.IsEOF())
	{
		ShowMessageBox(_T("Patient not found."));
		return;
	}

	//Report Header
	tmpStr.Empty();
	rs2.GetValue(_T("sexid"), szSex);
	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);
	rs.GetValue(_T("hpc_pdeptid"), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		CString szPerformDept;
		StringUpper(pMF->GetDepartmentName(tmpStr), szPerformDept);
		rpt.GetReportHeader()->SetValue(_T("Faculty"), szPerformDept);
	}
	else
		rpt.GetReportHeader()->SetValue(_T("Faculty"), _T(""));

	rs.GetValue(_T("hpc_docno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);

	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("SheetNo"), tmpStr);
	StringUpper(rs2.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);
	rs2.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);

	//Chi In ra nam sinh.
	rs2.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);
	//	_msg(_T("%s"), tmpStr);
	rs2.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	tmpStr.Format(_T("%s - %s"), rs2.GetValue(_T("detailaddress")), rs2.GetValue(_T("address")));
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);

	rs2.GetValue(_T("objectname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("objectname"), tmpStr);

	rs2.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);

	rs2.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	rs2.GetValue(_T("regdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs2.GetValue(_T("expdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExpiryDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));


	szSQL.Format(_T(" SELECT ") \
		_T(" hbo_reason as Lydo,") \
		_T(" HBO_TRANSFUSIONS_NUMBER as SolanTruyen,") \
		_T(" HBO_BLOOD_TYPE as NhomMau, ") \
		_T(" HBO_ORDERDATE as OrderBloodDate, ") \
		_T(" HBO_COMMENT as Ghichu, ") \
		_T(" HBO_REASON as Lydo ") \
		_T(" from hms_blood_order ") \
		_T(" where hbo_orderid=%ld"), nOrderID);
	rsal.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	rpt.GetReportHeader()->SetValue(_T("Lydo"), rsal.GetValue(_T("Lydo")));
	rpt.GetReportHeader()->SetValue(_T("SolanTruyen"), rsal.GetValue(_T("SolanTruyen")));
	rpt.GetReportHeader()->SetValue(_T("NhomMau"), rsal.GetValue(_T("NhomMau")));
	rpt.GetReportHeader()->SetValue(_T("Comment"), rsal.GetValue(_T("Ghichu")));
	rpt.GetReportHeader()->SetValue(_T("Lydo"), rsal.GetValue(_T("Lydo")));


	CString szDate;
	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportHeader()->GetValue(_T("OrderDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);

	rs.GetValue(_T("hpc_doctor"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* imgHeader = rpt.GetReportHeader()->GetItem(_T("Signature"));
	if (imgHeader)
	{
		imgHeader->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		imgHeader->SetFixedHeight(false);
	}



	CString szDept;
	CRecord rsd(&pMF->m_db);
	rs.GetValue(_T("hpc_roomid"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Room"), nRoomID);
	rs.GetValue(_T("hpc_deptid"), szDept);
	szSQL.Format(_T("SELECT hrl_name as roomname FROM hms_roomlist WHERE hrl_deptid='%s' AND hrl_id=%d"), szDept, nRoomID);
	rsd.ExecSQL(szSQL);
	if (!rsd.IsEOF())
	{
		rsd.GetValue(_T("roomname"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);
	}


	rs.GetValue(_T("hpc_deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), pMF->GetDepartmentName(tmpStr));

	rs.GetValue(_T("hpc_bedid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Bed"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("BedName"), _T(""));


	szSQL.Format(_T("SELECT he_prediagnostic as Diagnostic FROM hms_exam WHERE he_docno=%ld AND he_roomid=%d"), nDocumentNo, nRoomID);
	rs3.ExecSQL(szSQL);
	if (!rs3.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs3.GetValue(_T("Diagnostic")));
	}

	rs2.GetValue(_T("diagnostic"), tmpStr);
	if (tmpStr.GetLength() > 5)
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);

	rs2.GetValue(_T("relationdisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);



	szSQL.Format(_T(" SELECT hfl_name   AS name,") \
		_T("      hfl_unit     AS unit,") \
		_T("      hfl_index1   AS index1,") \
		_T("      hfl_index2   AS index2,") \
		_T("      hpcl_result  AS result,") \
		_T("      hpcl_note    AS note,") \
		_T("      hfl_subitem AS subitem") \
		_T(" FROM hms_testorderline") \
		_T(" LEFT JOIN hms_fee_list") \
		_T(" ON(hfl_feeid                =hpcl_itemid)") \
		_T(" WHERE hpcl_orderid          = %ld") \
		_T(" and (hpcl_status IN('P','T') or hpcl_hasfee='Y') ") \
		_T(" ORDER BY hpcl_orderlineid"), nOrderID);


	CRecord rsl(&pMF->m_db);
	ret = rsl.ExecSQL(szSQL);
	//_fmsg(_T("%s"), szSQL);
	CReportSection* rptDetail;
	if (szGroupID.Left(2) == _T("B1")) {
		/*
				rsl.MoveFirst();
				if(ret > 30)
				{
					for (int i =0; i <= ret/2; i++)
					{
						rptDetail = rpt.AddDetail();
						rsl.GetValue(_T("name"), tmpStr);
						rptDetail->SetValue(_T("1"), tmpStr);
						rsl.GetValue(_T("index1"), tmpStr);
						rptDetail->SetValue(_T("2"), tmpStr);
						rsl.GetValue(_T("result"), tmpStr);
						rptDetail->SetValue(_T("3"), tmpStr);
						rptDetail->SetValue(_T("4"), _T(""));
						rptDetail->SetValue(_T("5"), _T(""));
						rptDetail->SetValue(_T("6"), _T(""));
						rsl.MoveNext();
					}
					for (int i =0; i <= ret/2 ; i++)
					{
						if(rsl.IsEOF())
							break;
						rptDetail = rpt.GetDetail(i+1);
						rsl.GetValue(_T("name"), tmpStr);
						rptDetail->SetValue(_T("4"), tmpStr);
						rsl.GetValue(_T("index1"), tmpStr);
						rptDetail->SetValue(_T("5"), tmpStr);
						rsl.GetValue(_T("result"), tmpStr);
						rptDetail->SetValue(_T("6"), tmpStr);
						rsl.MoveNext();
					}
				}
				else
				{
		*/
		int nItem = 1;
		while (!rsl.IsEOF())
		{
			rsl.GetValue(_T("subitem"), tmpStr);
			if (tmpStr.GetLength() <= 1)
			{
				//rpt.GetDetail(0)->GetItem(_T("1"))->SetFaceSize(10);
				//rpt.GetDetail(0)->GetItem(_T("1"))->SetItalic(false);
				tmpStr.Format(_T(" %d. %s"), nItem++, rsl.GetValue(_T("name")));
			}
			else
			{
				rpt.GetDetail(0)->GetItem(_T("1"))->SetFaceSize(10);
				rpt.GetDetail(0)->GetItem(_T("1"))->SetItalic(true);
				tmpStr.Format(_T("     - %s"), rsl.GetValue(_T("name")));
			}

			rptDetail = rpt.AddDetail();
			rptDetail->SetValue(_T("1"), tmpStr);
			if (szSex == _T("F"))
				rsl.GetValue(_T("index2"), tmpStr);
			else
				rsl.GetValue(_T("index1"), tmpStr);
			if (tmpStr == _T("0") || tmpStr == _T("0 - 0") || tmpStr == _T("0-0"))
				tmpStr.Empty();
			rptDetail->SetValue(_T("2"), tmpStr);

			tmpStr.Empty();

			rsl.GetValue(_T("unit"), tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);


			rsl.MoveNext();
		}
	}
	else
	{
		int nItem = 1;
		while (!rsl.IsEOF())
		{
			rptDetail = rpt.AddDetail();
			tmpStr.Format(_T("%d. %s"), nItem++, rsl.GetValue(_T("name")));
			rptDetail->SetValue(_T("1"), tmpStr);
			rsl.GetValue(_T("unit"), tmpStr);
			rptDetail->SetValue(_T("2"), tmpStr);
			rsl.MoveNext();
		}

	}


	//Page Footer
	//Report Footer

	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("OrderDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("OrderDate"), szDate);

	CReportItem* Picture = NULL;

	Picture = rpt.GetReportFooter()->GetItem(_T("Picture"));
	if (Picture)
	{
		HBITMAP hBitmap = pMF->GetPACSImage(pMF->m_szCurrentFileNamePACS);
		if (hBitmap)
		{
			Picture->SetHBITMAP(hBitmap);
			Picture->SetFixedHeight(false);
			::DeleteObject(hBitmap);
		}
	}
	Picture = rpt.GetReportHeader()->GetItem(_T("Picture"));

	if (Picture)
	{
		HBITMAP hBitmap = pMF->GetPACSImage(pMF->m_szCurrentFileNamePACS);
		if (hBitmap)
		{
			Picture->SetHBITMAP(hBitmap);
			Picture->SetFixedHeight(false);
			::DeleteObject(hBitmap);
		}
	}
	tmpStr.Empty();
	rs.GetValue(_T("hpc_doctor"), tmpStr);

	rpt.GetReportFooter()->SetValue(_T("DoctorName"), _T(""));
	if (!tmpStr.IsEmpty())
	{
		rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
		CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
		if (img)
		{
			img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
			img->SetFixedHeight(false);
		}
	}


	rs.GetValue(_T("hpc_performdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PerformDate"));
	if (CDateTime::IsValid(tmpStr))
		szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	else
		szDate.Format(tmpStr2, _T("....."), _T("....."), _T("........"));
	rpt.GetReportFooter()->SetValue(_T("PerformDate"), szDate);
	rs.GetValue(_T("hpc_practitioner"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Practitioner"), _T(""));
	if (!tmpStr.IsEmpty())
	{
		rpt.GetReportFooter()->SetValue(_T("Practitioner"), GetDoctorName(tmpStr));
		CReportItem* img2 = rpt.GetReportFooter()->GetItem(_T("Signature2"));
		if (img2)
		{
			img2->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
			img2->SetFixedHeight(false);
		}
	}
	rpt.GetReportFooter()->SetValue(_T("thu_truong_ky"), _T("THỦ TRƯỞNG KÝ"));


	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(bDirect);
}



void CPrintForms::PrintTestResultX(long nOrderID, bool bPreview, bool bDirect) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szGroupID, szSex, szStatus;
	CString szReportName, szOrderName;
	CString szSQL;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rs3(&pMF->m_db);
	long nDocumentNo;
	int nRefIndex, nRoomID;
	int nNumberOrder = 0;
	CString tmpStr2, szDeptType;
	CString szFormID;

	if (pMF->GetModuleID() != _T("EM"))
		return;


	szSQL.Format(_T("SELECT * FROM hms_testorder WHERE hpc_orderid=%ld "), nOrderID);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;

	rs.GetValue(_T("hpc_groupid"), szGroupID);
	rs.GetValue(_T("hpc_docno"), nDocumentNo);
	rs.GetValue(_T("hpc_refidx"), nRefIndex);
	rs.GetValue(_T("hpc_roomid"), nRoomID);
	rs.GetValue(_T("hpc_status"), szStatus);
	rs.GetValue(_T("hpc_depttype"), szDeptType);

	szSQL.Format(_T("SELECT hfg_report as reportname FROM hms_fee_group WHERE hfg_id='%s' "), szGroupID);
	rs2.ExecSQL(szSQL);
	if (!rs2.IsEOF())
		rs2.GetValue(_T("reportname"), tmpStr);

	if (tmpStr.IsEmpty())
		tmpStr = _T("PACS_VOTE.RPT");
	tmpStr.Trim();

	szReportName.Format(_T("Reports/HMS/%s"), tmpStr);

	szReportName.Trim();

	if (!rpt.Init(szReportName))
	{
		return;
	}



	szSQL.Format(_T(" SELECT 	hd_patientno as patientno,  ") \
		_T(" 	hd_docno as docno,") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	CAST(TO_CHAR(hp_birthdate, 'YYYY') as integer) as birthyear,") \
		_T(" 	hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age, 	hp_sex as sexid,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T(" 	hp_occupation as occupationid,") \
		_T(" 	sys_sel_getname('sys_occupation', cast(hp_occupation as varchar(15))) as occupation,") \
		_T(" 	nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T(" 	hms_getaddress(hp_provid,hp_distid,hp_villid) as address,") \
		_T(" 	hp_workplaceid as workplaceid,") \
		_T(" 	hp_workplace as workplace,") \
		_T(" 	hd_object as objectid,") \
		_T(" 	(SELECT ho_desc FROM hms_object WHERE ho_id=hd_object) as objectname,") \
		_T(" 	hd_cardno as cardno,") \
		_T(" 	hd_cardidx as cardidx, ") \
		_T(" 	hd_reldisease as relationdisease, ") \
		_T("	trim(hd_diagnostic) ||' ['||trim(hd_icd)||']' as diagnostic, ") \
		_T(" 	hc_regdate as regdate, ") \
		_T(" 	hc_expdate as expdate ") \
		_T(" FROM hms_patient") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno)") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hd_docno=%ld"), nDocumentNo);
	//_fmsg(_T("%s"), szSQL);
	int ret = rs2.ExecSQL(szSQL);
	if (rs2.IsEOF())
	{
		ShowMessageBox(_T("Patient not found."));
		return;
	}

	//Report Header
	tmpStr.Empty();
	rs2.GetValue(_T("sexid"), szSex);
	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);
	rs.GetValue(_T("hpc_pdeptid"), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		CString szPerformDept;
		StringUpper(pMF->GetDepartmentName(tmpStr), szPerformDept);
		rpt.GetReportHeader()->SetValue(_T("Faculty"), szPerformDept);
	}
	else
		rpt.GetReportHeader()->SetValue(_T("Faculty"), _T(""));

	rs.GetValue(_T("hpc_docno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);

	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("SheetNo"), tmpStr);
	StringUpper(rs2.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);
	rs2.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);

	//Chi In ra nam sinh.
	rs2.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);
	//	_msg(_T("%s"), tmpStr);
	rs2.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	tmpStr.Format(_T("%s - %s"), rs2.GetValue(_T("detailaddress")), rs2.GetValue(_T("address")));
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);

	rs2.GetValue(_T("objectname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("objectname"), tmpStr);

	rs2.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);

	rs2.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	rs2.GetValue(_T("regdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs2.GetValue(_T("expdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExpiryDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));


	CString szDate;
	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportHeader()->GetValue(_T("OrderDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);

	rs.GetValue(_T("hpc_doctor"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* imgHeader = rpt.GetReportHeader()->GetItem(_T("Signature"));
	if (imgHeader)
	{
		imgHeader->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		imgHeader->SetFixedHeight(false);
	}



	CString szDept;
	CRecord rsd(&pMF->m_db);
	rs.GetValue(_T("hpc_roomid"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Room"), nRoomID);
	rs.GetValue(_T("hpc_deptid"), szDept);
	szSQL.Format(_T("SELECT hrl_name as roomname FROM hms_roomlist WHERE hrl_deptid='%s' AND hrl_id=%d"), szDept, nRoomID);
	rsd.ExecSQL(szSQL);
	if (!rsd.IsEOF())
	{
		rsd.GetValue(_T("roomname"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);
	}


	rs.GetValue(_T("hpc_deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), pMF->GetDepartmentName(tmpStr));

	rs.GetValue(_T("hpc_bedid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Bed"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("BedName"), _T(""));


	szSQL.Format(_T("SELECT he_prediagnostic as Diagnostic FROM hms_exam WHERE he_docno=%ld AND he_roomid=%d"), nDocumentNo, nRoomID);
	rs3.ExecSQL(szSQL);
	if (!rs3.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs3.GetValue(_T("Diagnostic")));
	}

	rs2.GetValue(_T("diagnostic"), tmpStr);
	if (tmpStr.GetLength() > 5)
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);

	rs2.GetValue(_T("relationdisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);



	szSQL.Format(_T(" SELECT hfl_name   AS name,") \
		_T("      hfl_unit     AS unit,") \
		_T("      hfl_index1   AS index1,") \
		_T("      hfl_index2   AS index2,") \
		_T("      hpcl_result  AS result,") \
		_T("      hpcl_note    AS note,") \
		_T("      hfl_subitem AS subitem") \
		_T(" FROM hms_testorderline") \
		_T(" LEFT JOIN hms_fee_list") \
		_T(" ON(hfl_feeid                =hpcl_itemid)") \
		_T(" WHERE hpcl_orderid          = %ld") \
		_T(" and (hpcl_status IN('P','T') or hpcl_hasfee='Y') ") \
		_T(" ORDER BY hpcl_orderlineid"), nOrderID);


	CRecord rsl(&pMF->m_db);
	ret = rsl.ExecSQL(szSQL);
	//_fmsg(_T("%s"), szSQL);
	CReportSection* rptDetail;
	if (szGroupID.Left(2) == _T("B1")) {
		/*
				rsl.MoveFirst();
				if(ret > 30)
				{
					for (int i =0; i <= ret/2; i++)
					{
						rptDetail = rpt.AddDetail();
						rsl.GetValue(_T("name"), tmpStr);
						rptDetail->SetValue(_T("1"), tmpStr);
						rsl.GetValue(_T("index1"), tmpStr);
						rptDetail->SetValue(_T("2"), tmpStr);
						rsl.GetValue(_T("result"), tmpStr);
						rptDetail->SetValue(_T("3"), tmpStr);
						rptDetail->SetValue(_T("4"), _T(""));
						rptDetail->SetValue(_T("5"), _T(""));
						rptDetail->SetValue(_T("6"), _T(""));
						rsl.MoveNext();
					}
					for (int i =0; i <= ret/2 ; i++)
					{
						if(rsl.IsEOF())
							break;
						rptDetail = rpt.GetDetail(i+1);
						rsl.GetValue(_T("name"), tmpStr);
						rptDetail->SetValue(_T("4"), tmpStr);
						rsl.GetValue(_T("index1"), tmpStr);
						rptDetail->SetValue(_T("5"), tmpStr);
						rsl.GetValue(_T("result"), tmpStr);
						rptDetail->SetValue(_T("6"), tmpStr);
						rsl.MoveNext();
					}
				}
				else
				{
		*/
		int nItem = 1;
		while (!rsl.IsEOF())
		{
			rsl.GetValue(_T("subitem"), tmpStr);
			if (tmpStr.GetLength() <= 1)
			{
				//rpt.GetDetail(0)->GetItem(_T("1"))->SetFaceSize(10);
				//rpt.GetDetail(0)->GetItem(_T("1"))->SetItalic(false);
				tmpStr.Format(_T(" %d. %s"), nItem++, rsl.GetValue(_T("name")));
			}
			else
			{
				rpt.GetDetail(0)->GetItem(_T("1"))->SetFaceSize(10);
				rpt.GetDetail(0)->GetItem(_T("1"))->SetItalic(true);
				tmpStr.Format(_T("     - %s"), rsl.GetValue(_T("name")));
			}

			rptDetail = rpt.AddDetail();
			rptDetail->SetValue(_T("1"), tmpStr);
			if (szSex == _T("F"))
				rsl.GetValue(_T("index2"), tmpStr);
			else
				rsl.GetValue(_T("index1"), tmpStr);
			if (tmpStr == _T("0") || tmpStr == _T("0 - 0") || tmpStr == _T("0-0"))
				tmpStr.Empty();
			rptDetail->SetValue(_T("2"), tmpStr);

			rsl.GetValue(_T("result"), tmpStr);
			rptDetail->SetValue(_T("3"), tmpStr);

			rsl.GetValue(_T("note"), tmpStr);
			if (tmpStr == _T("H") || tmpStr == _T("L"))
			{
				rptDetail->SetValue(_T("5"), tmpStr);
			}

			rsl.GetValue(_T("unit"), tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);


			rsl.MoveNext();
		}
	}
	else
	{
		int nItem = 1;
		while (!rsl.IsEOF())
		{
			rptDetail = rpt.AddDetail();
			tmpStr.Format(_T("%d. %s"), nItem++, rsl.GetValue(_T("name")));
			rptDetail->SetValue(_T("1"), tmpStr);
			rsl.GetValue(_T("unit"), tmpStr);
			rptDetail->SetValue(_T("2"), tmpStr);
			rsl.MoveNext();
		}

	}


	//Page Footer
	//Report Footer

	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("OrderDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("OrderDate"), szDate);

	CReportItem* Picture = NULL;

	Picture = rpt.GetReportFooter()->GetItem(_T("Picture"));
	if (Picture)
	{
		HBITMAP hBitmap = pMF->GetPACSImage(pMF->m_szCurrentFileNamePACS);
		if (hBitmap)
		{
			Picture->SetHBITMAP(hBitmap);
			Picture->SetFixedHeight(false);
			::DeleteObject(hBitmap);
		}
	}
	Picture = rpt.GetReportHeader()->GetItem(_T("Picture"));

	if (Picture)
	{
		HBITMAP hBitmap = pMF->GetPACSImage(pMF->m_szCurrentFileNamePACS);
		if (hBitmap)
		{
			Picture->SetHBITMAP(hBitmap);
			Picture->SetFixedHeight(false);
			::DeleteObject(hBitmap);
		}
	}

	if (szStatus != _T("T"))
		rs.GetValue(_T("hpc_doctor"), tmpStr);
	else
		rs.GetValue(_T("hpc_practitioner"), tmpStr);

	rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{
		img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img->SetFixedHeight(false);
	}


	rs.GetValue(_T("hpc_performdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PerformDate"));
	if (CDateTime::IsValid(tmpStr))
		szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	else
		szDate.Format(tmpStr2, _T("....."), _T("....."), _T("........"));
	rpt.GetReportFooter()->SetValue(_T("PerformDate"), szDate);
	rs.GetValue(_T("hpc_practitioner"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Practitioner"), GetDoctorName(tmpStr));
	CReportItem* img2 = rpt.GetReportFooter()->GetItem(_T("Signature2"));
	if (img2)
	{
		img2->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img2->SetFixedHeight(false);
	}


	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(bDirect);
}


void CPrintForms::PrintPACSOrderX(long nOrderID, CString szItemID, bool bPreview, bool bDirect, bool bDownload) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szGroupID, szSex, szStatus;
	CString szReportName, szOrderName;
	CString szSQL;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rs3(&pMF->m_db);
	long nDocumentNo;
	int nRefIndex, nRoomID;

	CString tmpStr2, szDeptType;
	CString szFormID;
	CString szOrderDate;
	szSQL.Format(_T("SELECT * FROM hms_pacsorder LEFT JOIN hms_pacsorderline ON(hpcl_orderid=hpc_orderid) WHERE hpc_orderid=%ld and hpcl_itemid='%s' "), nOrderID, szItemID);
	//_msg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;


	rs.GetValue(_T("hpc_groupid"), szGroupID);
	rs.GetValue(_T("hpc_docno"), nDocumentNo);
	rs.GetValue(_T("hpc_refidx"), nRefIndex);
	rs.GetValue(_T("hpc_status"), szStatus);
	rs.GetValue(_T("hpc_roomid"), nRoomID);
	rs.GetValue(_T("hpc_depttype"), szDeptType);
	rs.GetValue(_T("hpc_orderdate"), szOrderDate);

	szItemID.Empty();

	szSQL.Format(_T("SELECT hfg_report as reportname FROM hms_fee_group WHERE hfg_id='%s' "), szGroupID);
	rs2.ExecSQL(szSQL);
	tmpStr.Empty();
	if (!rs2.IsEOF())
		rs2.GetValue(_T("reportname"), tmpStr);

	if (tmpStr.IsEmpty())
		tmpStr = _T("PACS_VOTE.RPT");
	tmpStr.Trim();

	tmpStr.Replace(_T("_"), _T("O_"));
	szReportName.Format(_T("Reports/HMS/%s"), tmpStr);


	szSQL.Format(_T(" SELECT hfl_name as name, hfl_unit as unit") \
		_T(" FROM hms_pacsorderline") \
		_T(" LEFT JOIN hms_fee_list ON(hpcl_itemid=hfl_feeid)") \
		_T(" WHERE 	hpcl_orderid=%ld ") \
		_T(" 	and hpcl_result='%s'") \
		_T(" ORDER BY hpcl_orderlineid "), nOrderID, szFormID);

	rs2.ExecSQL(szSQL);

	while (!rs2.IsEOF())
	{
		rs2.GetValue(_T("name"), tmpStr2);
		if (!szOrderName.IsEmpty())
			szOrderName += _T("\r\n");
		szOrderName.AppendFormat(_T("%s"), tmpStr2);
		rs2.MoveNext();
	}

	szReportName.Trim();

	if (!rpt.Init(szReportName))
	{
		return;
	}



	szSQL.Format(_T(" SELECT 	hd_patientno as patientno,  ") \
		_T(" 	hd_docno as docno,") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	CAST(TO_CHAR(hp_birthdate, 'YYYY') as integer) as birthyear,") \
		_T(" 	hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age, 	hp_sex as sexid,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T(" 	hp_occupation as occupationid,") \
		_T(" 	sys_sel_getname('sys_occupation', cast(hp_occupation as nvarchar2(15))) as occupation,") \
		_T(" 	nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T(" 	hms_getaddress(hp_provid,hp_distid,hp_villid) as address,") \
		_T(" 	hp_workplaceid as workplaceid,") \
		_T(" 	hp_workplace as workplace,") \
		_T(" 	hd_object as objectid,") \
		_T("	trim(hd_diagnostic) ||' ['||trim(hd_icd)||']' as diagnostic, ") \
		_T(" 	(SELECT ho_desc FROM hms_object WHERE ho_id=hd_object) as objectname,") \
		_T(" 	hd_cardno as cardno,") \
		_T(" 	hd_cardidx as cardidx, ") \
		_T(" 	hd_reldisease as relationdisease, ") \
		_T(" 	hc_regdate as regdate, ") \
		_T(" 	hc_expdate as expdate ") \
		_T(" FROM hms_patient") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno)") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hd_docno=%ld"), nDocumentNo);
	//_fmsg(_T("%s"), szSQL);
	int ret = rs2.ExecSQL(szSQL);
	if (rs2.IsEOF())
	{
		ShowMessageBox(_T("Patient not found."));
		return;
	}


	//Report Header
	tmpStr.Empty();
	rs2.GetValue(_T("sexid"), szSex);
	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);
	rs.GetValue(_T("hpc_pdeptid"), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		CString szPerformDept;
		StringUpper(pMF->GetDepartmentName(tmpStr), szPerformDept);
		rpt.GetReportHeader()->SetValue(_T("Faculty"), szPerformDept);
	}
	else
		rpt.GetReportHeader()->SetValue(_T("Faculty"), _T(""));

	rs.GetValue(_T("hpc_docno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);


	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("SheetNo"), tmpStr);
	StringUpper(rs2.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);
	rs2.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);

	//Chi In ra nam sinh.
	rs2.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs2.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	tmpStr.Format(_T("%s - %s"), rs2.GetValue(_T("detailaddress")), rs2.GetValue(_T("address")));
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);

	rs2.GetValue(_T("objectname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("objectname"), tmpStr);

	rs2.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);

	rs2.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	rs2.GetValue(_T("regdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs2.GetValue(_T("expdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExpiryDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));


	CString szDate;
	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportHeader()->GetValue(_T("OrderDate"));

	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);

	rs.GetValue(_T("hpc_doctor"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* imgHeader = rpt.GetReportHeader()->GetItem(_T("Signature"));
	if (imgHeader)
	{
		imgHeader->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		imgHeader->SetFixedHeight(false);
	}



	CString szDept;
	CRecord rsd(&pMF->m_db);

	rpt.GetReportHeader()->SetValue(_T("Room"), nRoomID);

	rs.GetValue(_T("hpc_deptid"), szDept);
	szSQL.Format(_T("SELECT hrl_name as roomname FROM hms_roomlist WHERE hrl_deptid='%s' AND hrl_id=%d"), szDept, nRoomID);
	rsd.ExecSQL(szSQL);
	if (!rsd.IsEOF())
	{
		rsd.GetValue(_T("roomname"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);
	}


	rs.GetValue(_T("hpc_deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), pMF->GetDepartmentName(tmpStr));


	szSQL.Format(_T("SELECT he_prediagnostic as Diagnostic FROM hms_exam WHERE he_docno=%ld AND he_roomid=%d"), nDocumentNo, nRoomID);
	rs3.ExecSQL(szSQL);

	if (!rs3.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs3.GetValue(_T("Diagnostic")));
	}


	rs2.GetValue(_T("diagnostic"), tmpStr);
	if (tmpStr.GetLength() > 5)
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);

	rs2.GetValue(_T("relationdisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);

	//Page Header

	//Report Detail
	CRecord rsl(&pMF->m_db);

	szSQL.Format(_T(" SELECT 	hfl_name as name, ") \
		_T(" 	hfl_unit as unit, ") \
		_T(" 	hfl_index1 as index1, ") \
		_T(" 	hfl_index2 as index2,") \
		_T(" 	hpcl_result as result,") \
		_T(" 	hpcl_note as note,hfl_subitem as subitem, hpcl_qty as qty, hpcl_note ") \
		_T(" FROM hms_pacsorderline ") \
		_T(" LEFT JOIN hms_fee_list ON(hfl_feeid=hpcl_itemid)") \
		_T(" WHERE hpcl_orderid=%ld ") \
		_T(" and (hpcl_hasfee='Y') ") \
		_T(" AND hpcl_status  NOT IN ('C')") \
		_T(" ORDER BY hpcl_orderlineid "), nOrderID);


	ret = rsl.ExecSQL(szSQL);
	CReportSection* rptDetail;
	int nItem = 1;
	int nQty;
	CString szNote, szUnit;
	while (!rsl.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		rsl.GetValue(_T("qty"), nQty);
		rsl.GetValue(_T("hpcl_note"), szNote);
		szNote.Trim();

		tmpStr.Format(_T("%d. %s"), nItem++, rsl.GetValue(_T("name")));
		if (!szNote.IsEmpty())
		{
			tmpStr.AppendFormat(_T(" (%s)"), szNote);
		}
		if (nQty > 1)
		{
			tmpStr.AppendFormat(_T("; S\x1ED1 l\x1B0\x1EE3ng: %d"), nQty);
		}
		rptDetail->SetValue(_T("1"), tmpStr);
		rsl.GetValue(_T("unit"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rsl.MoveNext();
	}
	//_fmsg(_T("%s"), szSQL);



		//Page Footer
		//Report Footer

	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("OrderDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("OrderDate"), szDate);

	CReportItem* Picture = NULL;

	Picture = rpt.GetReportFooter()->GetItem(_T("Picture"));

	HBITMAP hBitmap = NULL;
	if (Picture && bDownload)
	{

		hBitmap = pMF->DownloadImage(nDocumentNo, nOrderID, szItemID, Picture->GetItemRect().Width(), Picture->GetItemRect().Height(), Picture->m_nCol1, Picture->m_nRow1);
		if (hBitmap)
		{
			Picture->SetHBITMAP(hBitmap);
			Picture->SetFixedHeight(false);
		}
	}
	Picture = rpt.GetReportHeader()->GetItem(_T("Picture"));
	if (Picture && bDownload)
	{

		//HBITMAP hBitmap = pMF->GetPACSImage(pMF->m_szCurrentFileNamePACS);
		if (hBitmap == NULL)
			hBitmap = pMF->DownloadImage(nDocumentNo, nOrderID, szItemID, Picture->GetItemRect().Width(), Picture->GetItemRect().Height(), Picture->m_nCol1, Picture->m_nRow1);
		if (hBitmap)
		{
			Picture->SetHBITMAP(hBitmap);
			Picture->SetFixedHeight(false);

		}
	}
	if (hBitmap) ::DeleteObject(hBitmap);

	tmpStr.Empty();
	rs.GetValue(_T("hpc_doctor"), tmpStr);



	rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{
		img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img->SetFixedHeight(false);
	}


	rs.GetValue(_T("hpc_performdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PerformDate"));
	if (CDateTime::IsValid(tmpStr))
		szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	else
		szDate.Format(tmpStr2, _T("....."), _T("....."), _T("........"));
	rpt.GetReportFooter()->SetValue(_T("PerformDate"), szDate);
	tmpStr.Empty();
	rs.GetValue(_T("hpcl_practitioner"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Practitioner"), GetDoctorName(tmpStr));
	CReportItem* img2 = rpt.GetReportFooter()->GetItem(_T("Signature2"));
	if (img2)
	{
		img2->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img2->SetFixedHeight(false);
	}

	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(bDirect);
}

void CPrintForms::PrintPACSResultX(long nOrderID, CString szItemID, bool bPreview, bool bDirect, bool bDownload) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szGroupID, szSex, szStatus;
	CString szReportName, szOrderName;
	CString szSQL;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rs3(&pMF->m_db);
	long nDocumentNo;
	int nRefIndex, nRoomID;

	CString tmpStr2, szDeptType;
	CString szFormID;
	CString szOrderDate;
	szSQL.Format(_T("SELECT * FROM hms_pacsorder LEFT JOIN hms_pacsorderline ON(hpcl_orderid=hpc_orderid) WHERE hpc_orderid=%ld and hpcl_itemid='%s' "), nOrderID, szItemID);
	//_msg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;


	rs.GetValue(_T("hpc_groupid"), szGroupID);
	rs.GetValue(_T("hpc_docno"), nDocumentNo);
	rs.GetValue(_T("hpc_refidx"), nRefIndex);
	rs.GetValue(_T("hpc_status"), szStatus);
	rs.GetValue(_T("hpc_roomid"), nRoomID);
	rs.GetValue(_T("hpc_depttype"), szDeptType);
	rs.GetValue(_T("hpc_orderdate"), szOrderDate);

	szSQL.Format(_T(" SELECT hpf_id as id, hpf_reportname as reportname") \
		_T(" FROM hms_pacsorderline") \
		_T(" LEFT JOIN hms_pacs_form ON(hpf_id=hpcl_result)") \
		_T(" WHERE hpcl_orderid=%ld and hpcl_itemid='%s'"), nOrderID, szItemID);

	rs2.ExecSQL(szSQL);
	if (!rs2.IsEOF())
	{
		rs2.GetValue(_T("id"), szFormID);
	}

	tmpStr.Empty();
	if (!rs2.IsEOF())
		rs2.GetValue(_T("reportname"), tmpStr);

	if (tmpStr.IsEmpty())
		tmpStr = _T("PACS_VOTE.RPT");
	tmpStr.Trim();

	tmpStr.Replace(_T("_"), _T("O_"));
	szReportName.Format(_T("Reports/HMS/%s"), tmpStr);

	szSQL.Format(_T(" SELECT hfl_name as name, hfl_unit as unit") \
		_T(" FROM hms_pacsorderline") \
		_T(" LEFT JOIN hms_fee_list ON(hpcl_itemid=hfl_feeid)") \
		_T(" WHERE 	hpcl_orderid=%ld ") \
		_T(" 	and hpcl_result='%s'") \
		_T(" ORDER BY hpcl_orderlineid "), nOrderID, szFormID);
	rs2.ExecSQL(szSQL);

	while (!rs2.IsEOF())
	{
		rs2.GetValue(_T("name"), tmpStr2);
		if (!szOrderName.IsEmpty())
			szOrderName += _T("\r\n");
		szOrderName.AppendFormat(_T("%s"), tmpStr2);
		rs2.MoveNext();
	}

	szReportName.Trim();

	if (!rpt.Init(szReportName))
	{
		return;
	}

	szSQL.Format(_T(" SELECT 	hd_patientno as patientno,  ") \
		_T(" 	hd_docno as docno,") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	CAST(TO_CHAR(hp_birthdate, 'YYYY') as integer) as birthyear,") \
		_T(" 	hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age, 	hp_sex as sexid,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T(" 	hp_occupation as occupationid,") \
		_T(" 	sys_sel_getname('sys_occupation', cast(hp_occupation as nvarchar2(15))) as occupation,") \
		_T(" 	nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T(" 	hms_getaddress(hp_provid,hp_distid,hp_villid) as address,") \
		_T(" 	hp_workplaceid as workplaceid,") \
		_T(" 	hp_workplace as workplace,") \
		_T(" 	hd_object as objectid,") \
		_T("	trim(hd_diagnostic) ||' ['||trim(hd_icd)||']' as diagnostic, ") \
		_T(" 	(SELECT ho_desc FROM hms_object WHERE ho_id=hd_object) as objectname,") \
		_T(" 	hd_cardno as cardno,") \
		_T(" 	hd_cardidx as cardidx, ") \
		_T(" 	hd_reldisease as relationdisease, ") \
		_T(" 	hc_regdate as regdate, ") \
		_T(" 	hc_expdate as expdate ") \
		_T(" FROM hms_patient") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno)") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hd_docno=%ld"), nDocumentNo);
	//_fmsg(_T("%s"), szSQL);
	int ret = rs2.ExecSQL(szSQL);
	if (rs2.IsEOF())
	{
		ShowMessageBox(_T("Patient not found."));
		return;
	}


	//Report Header
	tmpStr.Empty();
	rs2.GetValue(_T("sexid"), szSex);
	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);
	rs.GetValue(_T("hpc_pdeptid"), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		CString szPerformDept;
		StringUpper(pMF->GetDepartmentName(tmpStr), szPerformDept);
		rpt.GetReportHeader()->SetValue(_T("Faculty"), szPerformDept);
	}
	else
		rpt.GetReportHeader()->SetValue(_T("Faculty"), _T(""));

	rs.GetValue(_T("hpc_docno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);


	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("SheetNo"), tmpStr);
	StringUpper(rs2.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);
	rs2.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);

	//Chi In ra nam sinh.
	rs2.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs2.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	tmpStr.Format(_T("%s - %s"), rs2.GetValue(_T("detailaddress")), rs2.GetValue(_T("address")));
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);

	rs2.GetValue(_T("objectname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("objectname"), tmpStr);

	rs2.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);

	rs2.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	rs2.GetValue(_T("regdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs2.GetValue(_T("expdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExpiryDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));


	CString szDate;
	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportHeader()->GetValue(_T("OrderDate"));

	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);

	rs.GetValue(_T("hpc_doctor"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* imgHeader = rpt.GetReportHeader()->GetItem(_T("Signature"));
	if (imgHeader)
	{
		imgHeader->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		imgHeader->SetFixedHeight(false);
	}



	CString szDept;
	CRecord rsd(&pMF->m_db);

	rpt.GetReportHeader()->SetValue(_T("Room"), nRoomID);

	rs.GetValue(_T("hpc_deptid"), szDept);
	szSQL.Format(_T("SELECT hrl_name as roomname FROM hms_roomlist WHERE hrl_deptid='%s' AND hrl_id=%d"), szDept, nRoomID);
	rsd.ExecSQL(szSQL);
	if (!rsd.IsEOF())
	{
		rsd.GetValue(_T("roomname"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);
	}


	rs.GetValue(_T("hpc_deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), pMF->GetDepartmentName(tmpStr));


	szSQL.Format(_T("SELECT he_prediagnostic as Diagnostic FROM hms_exam WHERE he_docno=%ld AND he_roomid=%d"), nDocumentNo, nRoomID);
	rs3.ExecSQL(szSQL);

	if (!rs3.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs3.GetValue(_T("Diagnostic")));
	}


	rs2.GetValue(_T("diagnostic"), tmpStr);
	if (tmpStr.GetLength() > 5)
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);

	rs2.GetValue(_T("relationdisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);

	//Page Header

	//Report Detail
	CRecord rsl(&pMF->m_db);


	if (szFormID.IsEmpty())
	{
		szSQL.Format(_T("SELECT hpr_name as name, hpr_desc as describe ") \
			_T(" FROM hms_pacsorderline") \
			_T(" ") \
			_T(" LEFT JOIN hms_pacs_result ON(hpr_name=hpl_name AND hpr_orderid=%ld AND hpr_itemid='%s') ") \
			_T(" LEFT JOIN hms_fee_list ON(hfl_feeid=hpr_itemid) ") \
			_T("ORDER BY hfl_line"), nOrderID, szItemID);
	}
	else
	{
		szSQL.Format(_T(" SELECT  ") \
			_T(" 	hpl_name as name, ") \
			_T(" 	hpr_desc as describe  ") \
			_T(" from hms_pacsorderline  ") \
			_T(" left join hms_pacs_form on(hpf_id=hpcl_result)") \
			_T(" left join hms_pacs_layout on(hpl_id=hpf_id)") \
			_T(" left join hms_pacs_result on(hpr_orderid=hpcl_orderid and hpr_name=hpl_name and hpr_itemid=hpcl_itemid)") \
			_T(" WHERE hpcl_orderid=%ld AND hpcl_itemid='%s' and hpl_id='%s' and length(hpr_desc) > 0 "), nOrderID, szItemID, szFormID);
	}
	//_fmsg(_T("%s"), szSQL);
	ret = rsl.ExecSQL(szSQL);

	CReportSection* pDetail = NULL;
	CString szDescribe, szName;
	rpt.GetReportHeader()->SetValue(_T("OrderName"), szOrderName);
	while (!rsl.IsEOF())
	{
		rsl.GetValue(_T("name"), szName);
		rsl.GetValue(_T("describe"), szDescribe);
		rpt.GetReportHeader()->SetValue(szName, szDescribe);
		rpt.GetReportFooter()->SetValue(szName, szDescribe);
		rsl.MoveNext();
	}
	//Page Footer
	//Report Footer

	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("OrderDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("OrderDate"), szDate);

	CReportItem* Picture = NULL;

	Picture = rpt.GetReportFooter()->GetItem(_T("Picture"));

	HBITMAP hBitmap = NULL;
	if (Picture && bDownload)
	{

		hBitmap = pMF->DownloadImage(nDocumentNo, nOrderID, szItemID, Picture->GetItemRect().Width(), Picture->GetItemRect().Height(), Picture->m_nCol1, Picture->m_nRow1);
		if (hBitmap)
		{
			Picture->SetHBITMAP(hBitmap);
			Picture->SetFixedHeight(false);
		}
	}
	Picture = rpt.GetReportHeader()->GetItem(_T("Picture"));
	if (Picture && bDownload)
	{

		//HBITMAP hBitmap = pMF->GetPACSImage(pMF->m_szCurrentFileNamePACS);
		if (hBitmap == NULL)
			hBitmap = pMF->DownloadImage(nDocumentNo, nOrderID, szItemID, Picture->GetItemRect().Width(), Picture->GetItemRect().Height(), Picture->m_nCol1, Picture->m_nRow1);
		if (hBitmap)
		{
			Picture->SetHBITMAP(hBitmap);
			Picture->SetFixedHeight(false);

		}
	}
	if (hBitmap) ::DeleteObject(hBitmap);

	rs.GetValue(_T("hpcl_practitioner"), tmpStr);


	rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{
		img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img->SetFixedHeight(false);
	}


	rs.GetValue(_T("hpc_performdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PerformDate"));
	if (CDateTime::IsValid(tmpStr))
		szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	else
		szDate.Format(tmpStr2, _T("....."), _T("....."), _T("........"));
	rpt.GetReportFooter()->SetValue(_T("PerformDate"), szDate);
	rs.GetValue(_T("hpcl_practitioner"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Practitioner"), GetDoctorName(tmpStr));
	CReportItem* img2 = rpt.GetReportFooter()->GetItem(_T("Signature2"));
	if (img2)
	{
		img2->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img2->SetFixedHeight(false);
	}

	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(bDirect);
}





void CPrintForms::PrintTestOrder(long nOrderID, bool bPreview, bool bDirect) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szGroupID, szSex, szStatus;
	CString szFilePath, szReportName, szOrderName;
	CString szSQL;
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db), rsd(&pMF->m_db), rs2(&pMF->m_db), rsal(&pMF->m_db);

	long nDocumentNo;
	int nNumberOrder = 0;
	CString tmpStr2, szDeptType, sztxt;
	CString szFormID, ReportName;


	szSQL.Format(_T(" SELECT  hpc_groupid ") \
		_T(" FROM  hms_testorder") \
		_T(" WHERE hpc_orderid = %ld "), nOrderID);

	
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		return;
	}
    
    rs.GetValue(_T("hpc_groupid"), sztxt);

	if (sztxt == _T("B1G00"))
	{
		szReportName = _T("HMS_TESTORDERBLOOD.RPT");
	}
	else
	{
		szReportName = _T("HMS_TESTORDER.RPT");
	}
//////////////////////////////
// Goi gen docx tu server
//////////////////////////////
	bool bRet = false;
    CString szId = _T("testorderx_108"), szItemID = L"";
	bRet = pMF->OnPostGenDocX(&rpt, szId, pMF->m_nDocumentNo, nOrderID, szReportName, szItemID, L"", bPreview, bDirect);
	if (bRet)
	{
		return;
	}
////////////////////////////////
////////////////////////////////


	szSQL.Format(
        _T(" SELECT hpc_deptid as deptid, hpc_docno AS docno,")
        _T("   (SELECT DISTINCT hfg_name2 FROM hms_fee_group WHERE ")
        _T("hfg_id=hpc_groupid")
        _T("   ) AS group_name,")
        _T("   trim(hp_surname")
        _T("   ||' '")
        _T("   ||hp_midname")
        _T("   ||' '")
        _T("   ||hp_firstname) AS pname,")
        _T("   date_part('year', hp_birthdate) as yob, ")
        _T("   HMS_GETSEX(hp_sex)           AS gender,")
        _T("   HMS_GETOBJECTNAME(hd_object) AS object_desc,")
        _T("   hd_cardno as cardno, hd_diagnostic, ")
        _T(" hpc_orderdate as orderdate , ")
        _T(" get_username(hpc_doctor) as doctorname,  ")
        _T(" hpc_roomid as roomid, hpc_class, hpc_groupid, HPC_ORDERID, ")
        _T("(SELECT ss_desc from sys_sel WHERE ss_id='phanloai_xetnghiem'  ")
        _T("AND ss_code=hpc_testtype) as testtype, ")
        _T(" (SELECT trim(ss_vndesc) from sys_sel WHERE ss_id='hms_ma_phieu'  ")
        _T("AND ss_code=hpc_groupid) as ma_phieu, ")
        _T(" hpc_roomname as roomname2 ")
        _T(" FROM hms_patient,")
        _T("   hms_doc,")
        _T("   hms_testorder")
        _T(" WHERE hpc_orderid = %ld ")
        _T(" AND hpc_docno     = hd_docno")
        _T(" AND hd_patientno  = hp_patientno"),
        nOrderID);

    rs.ExecSQL(szSQL);
    rs.GetValue(_T("hpc_groupid"), sztxt);

    if (rs.IsEOF())
    {
        return;
    }

	szFilePath.Format(_T("Reports\\HMS\\%s"), szReportName);
	_tprintf(_T("\nszFilePath: %s"), szFilePath);
	if (!rpt.Init(szFilePath))
		return;

	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("order_id"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);

	CString szDeptID;

	rs.GetValue(_T("deptid"), szDeptID);
	rpt.GetReportHeader()->SetValue(_T("Department"), pMF->GetDepartmentName(szDeptID));


	StringUpper(rs.GetValue(_T("group_name")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TITLE"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);

	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("OrderNo"), tmpStr);

	rs.GetValue(_T("HPC_ORDERID"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("OrderNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode1[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode1[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode1[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode1[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode1[93]"), tmpStr);

	rs.GetValue(_T("ma_phieu"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ma_phieu"), tmpStr);


	szSQL.Format(_T(" SELECT") \
		_T(" CASE WHEN htop_receptno IS NOT NULL THEN htop_receptno ELSE hpc_receptno END AS hpc_receptno") \
		_T(" FROM hms_testorder") \
		_T(" LEFT JOIN hms_testorder_pending") \
		_T(" ON(hpc_orderid = htop_orderid)") \
		_T(" WHERE hpc_orderid= %ld "), nOrderID);

	rs2.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	rs2.GetValue(_T("hpc_receptno"), tmpStr);
	if (tmpStr == _T("0"))
	{
		//tmpStr==_T("");		
		//rpt.GetReportHeader()->SetValue(_T("STT"), tmpStr);
	}
	else
	{
		rpt.GetReportHeader()->SetValue(_T("STT"), _T("STT"));
		rpt.GetReportHeader()->SetValue(_T("receptno"), tmpStr);
	}

	//Lấy ra thông tin truyền máu
	szSQL.Format(_T(" SELECT ") \
		_T(" hbo_reason as Lydo,") \
		_T(" HBO_TRANSFUSIONS_NUMBER as SolanTruyen,") \
		_T(" HBO_BLOOD_TYPE as NhomMau, ") \
		_T(" HBO_ORDERDATE as OrderBloodDate, ") \
		_T(" HBO_COMMENT as Ghichu, ") \
		_T(" HBO_REASON as Lydo ") \
		_T(" from hms_blood_order ") \
		_T(" where hbo_orderid=%ld"), nOrderID);
	rsal.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	rpt.GetReportHeader()->SetValue(_T("Lydo"), rsal.GetValue(_T("Lydo")));
	rpt.GetReportHeader()->SetValue(_T("SolanTruyen"), rsal.GetValue(_T("SolanTruyen")));
	rpt.GetReportHeader()->SetValue(_T("NhomMau"), rsal.GetValue(_T("NhomMau")));
	rpt.GetReportHeader()->SetValue(_T("Comment"), rsal.GetValue(_T("Ghichu")));

	rs.GetValue(_T("pname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);
	//Chi In ra nam sinh.
	rs.GetValue(_T("yob"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("Gender"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Gender"), tmpStr);
	rs.GetValue(_T("object_desc"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Object"), tmpStr);
	rs.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);

	rs.GetValue(_T("testtype"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("testtype"), tmpStr);

	CString szroomname2;
	rs.GetValue(_T("roomname2"), szroomname2);

	rs.GetValue(_T("roomid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RoomID"), tmpStr);
	szSQL.Format(_T("SELECT hrl_name as roomname FROM hms_roomlist WHERE hrl_deptid='%s' AND hrl_id=%d"), szDeptID, ToInt(tmpStr));
	rsd.ExecSQL(szSQL);
	if (!rsd.IsEOF())
	{
		rsd.GetValue(_T("roomname"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);
	}

	if (!szroomname2.IsEmpty())
	{
		rpt.GetReportHeader()->SetValue(_T("RoomName"), szroomname2);
	}

	CString szDate;


	if (sztxt == _T("B1G00"))
	{
		rsal.GetValue(_T("OrderBloodDate"), tmpStr);
	}
	else
	{
		rs.GetValue(_T("orderdate"), tmpStr);
		//_msg(_T("%s"), tmpStr);
	}
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PrintDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);



	rs.GetValue(_T("doctorname"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);

	rs.GetValue(_T("hpc_class"), tmpStr);
	if (tmpStr == _T("E"))
	{
		rs.GetValue(_T("hd_diagnostic"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	}
	else
	{
		CRecord rsx(&pMF->m_db);
		CString szSQL;
		szSQL.Format(_T("SELECT htr_maindisease FROM hms_treatment_record ") \
			_T("WHERE htr_docno =%ld and htr_deptid='%s' and rownum <=1 ORDER BY htr_idx DESC "),
			nDocumentNo, szDeptID);
		rsx.ExecSQL(szSQL);
		rsx.GetValue(_T("htr_maindisease"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	}

	CRecord rsxx(&pMF->m_db);
	szSQL.Format(_T(" SELECT CASE WHEN NVL(HTR_OUTPATIENT,'N')='Y' THEN 'Điều trị ngoại trú' else 'Điều trị nội trú' end as treattype from HMS_TREATMENT_RECORD ") \
		_T(" left join HMS_TESTORDER ON (htr_docno=hpc_docno and htr_treattime = HPC_TREATTIME)") \
		_T(" where htr_docno=%ld and HPC_ORDERID=%ld"), nDocumentNo, nOrderID);
	rsxx.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	rsxx.GetValue(_T("treattype"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("treattype"), tmpStr);

	szSQL.Format(_T(" SELECT case when hpc_groupid='B1E00' then hpcl_orderlineid||'-'||hfl_name else hfl_name end AS testname, HPCL_ISRELATIVE as xnnguoithan,") \
		_T("   hfl_unit      AS unit, hpcl_qty, hpcl_noteex as hpcl_note, ") \
		_T("   hfl_print_bold AS print_bold,") \
		_T("   hfl_print_bold_italic AS print_bold_italic , GET_SYSSEL_SAMPLE_DESC('test_sample_type', hpcl_sample) as sample,") \

		_T(" (SELECT hr_name FROM hms_relative WHERE hr_docno = hpc_docno AND HR_RELATIVE_ID=hpc_relative_id) as tennguoithan,") \
		_T("   (SELECT hr_yob FROM hms_relative WHERE hr_docno = hpc_docno AND HR_RELATIVE_ID=hpc_relative_id) as tuoinguoithan,") \
		_T("   (select hms_getsex(hr_sex) FROM hms_relative WHERE hr_docno = hpc_docno AND HR_RELATIVE_ID=hpc_relative_id) as gioitinhnguoithan,") \
		_T("   (select GET_SYSSEL_RELATIVE('hrm_relation',hr_relation) FROM hms_relative WHERE hr_docno = hpc_docno AND HR_RELATIVE_ID=hpc_relative_id) as quanhenguoithan") \

		_T(" FROM hms_testorderline") \
		_T(" LEFT JOIN hms_fee_list") \
		_T(" ON(hfl_feeid       = hpcl_itemid)") \
		_T(" LEFT JOIN hms_testorder ON (hpcl_docno=hpc_docno AND hpcl_orderid=hpc_orderid)") \
		_T(" WHERE hpcl_orderid = %ld") \
		_T(" AND hpcl_hasfee    ='Y'") \
		_T(" AND hpcl_status  NOT IN ('C')") \
		_T(" ORDER BY hfl_line "), nOrderID);


	rsl.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	CReportSection* rptDetail = NULL;
	int nItem = 1;
	int nQty;
	CString szNote, szUnit, szSample, sztennguoithan, sztuoinguoithan, szgioitinhnguoithan, szquanhenguoithan, szxnnguoithan;

	while (!rsl.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nItem++);
		rptDetail->SetValue(_T("IDX"), tmpStr);
		rsl.GetValue(_T("testname"), tmpStr);
		rsl.GetValue(_T("hpcl_note"), szNote);
		rsl.GetValue(_T("hpcl_qty"), nQty);

		rsl.GetValue(_T("tennguoithan"), sztennguoithan);
		rsl.GetValue(_T("tuoinguoithan"), sztuoinguoithan);
		rsl.GetValue(_T("gioitinhnguoithan"), szgioitinhnguoithan);
		rsl.GetValue(_T("quanhenguoithan"), szquanhenguoithan);
		rsl.GetValue(_T("xnnguoithan"), szxnnguoithan);
		szNote.Trim();
		sztennguoithan.Trim();
		sztuoinguoithan.Trim();
		szgioitinhnguoithan.Trim();
		szquanhenguoithan.Trim();

		if (!sztennguoithan.IsEmpty() && !szxnnguoithan.IsEmpty())
		{
			tmpStr.AppendFormat(_T(" :Tên:%s,"), sztennguoithan);
		}

		if (!sztuoinguoithan.IsEmpty() && !szxnnguoithan.IsEmpty())
		{
			tmpStr.AppendFormat(_T(" SN:%s,"), sztuoinguoithan);
		}

		if (!szgioitinhnguoithan.IsEmpty() && !szxnnguoithan.IsEmpty())
		{
			tmpStr.AppendFormat(_T(" Giới:%s,"), szgioitinhnguoithan);
		}

		if (!szquanhenguoithan.IsEmpty() && !szxnnguoithan.IsEmpty())
		{
			tmpStr.AppendFormat(_T(" Quan hệ:%s - "), szquanhenguoithan);
		}

		if (!szNote.IsEmpty())
		{
			tmpStr.AppendFormat(_T(" (%s)"), szNote);
		}
		rsl.GetValue(_T("sample"), szSample);
		if (!szSample.IsEmpty())
		{
			tmpStr.AppendFormat(_T(" (Mẫu: %s)"), szSample);
		}

		if (nQty > 1)
		{
			rsl.GetValue(_T("unit"), szUnit);
			tmpStr.AppendFormat(_T("; S\x1ED1 l\x1B0\x1EE3ng: %d %s"), nQty, szUnit);
		}
		if (rsl.GetValue(_T("print_bold")) == _T("Y"))
		{
			rptDetail->GetItem(_T("TestName"))->SetBold(true);
		}
		else if (rsl.GetValue(_T("print_bold_italic")) == _T("Y"))
		{
			rptDetail->GetItem(_T("TestName"))->SetBold(true);
			rptDetail->GetItem(_T("TestName"))->SetItalic(true);
		}
		rptDetail->SetValue(_T("TestName"), tmpStr);

		rsl.MoveNext();
	}

	//Page Footer
	//Report Footer
	if (pMF->GetObjectType() == _T("I"))
	{
		szSQL.Format(_T(" SELECT Count(*)") \
			_T(" FROM   hms_testorderline") \
			_T(" WHERE  hpcl_orderid = %ld AND hpcl_itemid IN (SELECT ss_code FROM   sys_sel WHERE  ss_id = 'HMS_FEE_LIST_APPROVAL') "), nOrderID);
		rs.ExecSQL(szSQL);

		if (rs.GetIntValue() > 0)
		{
			rpt.GetReportFooter()->SetValue(_T("thu_truong_ky"), _T("THỦ TRƯỞNG KÝ"));
		}
	}

	tmpStr = pMF->GetSysDateTime();
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PrintTime"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintTime"), szDate);


	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(bDirect);
}

void CPrintForms::PrintTestResult(long nOrderID, bool bPreview, bool bDirect)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();

	CString szModuleID = pMF->GetModuleID();
	pMF->m_szModuleID = _T("EM");
	pMF->PrintTestResultX(nOrderID, true);
	pMF->m_szModuleID = szModuleID;
	return;

	CReport rpt;
	CString tmpStr, szGroupID, szSex, szStatus;
	CString szReportName, szOrderName;
	CString szSQL;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rs3(&pMF->m_db);
	long nDocumentNo;
	int nRefIndex, nRoomID;
	int nNumberOrder = 0;
	CString tmpStr2, szDeptType;
	CString szFormID;


	szSQL.Format(_T("SELECT * FROM hms_testorder WHERE hpc_orderid=%ld "), nOrderID);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;

	rs.GetValue(_T("hpc_groupid"), szGroupID);
	rs.GetValue(_T("hpc_docno"), nDocumentNo);
	rs.GetValue(_T("hpc_refidx"), nRefIndex);
	rs.GetValue(_T("hpc_status"), szStatus);
	rs.GetValue(_T("hpc_depttype"), szDeptType);

	szSQL.Format(_T("SELECT hfg_report as reportname FROM hms_fee_group WHERE hfg_id='%s' "), szGroupID);
	rs2.ExecSQL(szSQL);
	tmpStr.Empty();
	if (!rs2.IsEOF())
		rs2.GetValue(_T("reportname"), tmpStr);

	if (tmpStr.IsEmpty())
		tmpStr = _T("PACS_VOTE.RPT");
	tmpStr.Trim();

	szReportName.Format(_T("Reports/HMS/%s"), tmpStr);



	szSQL.Format(_T(" SELECT hfl_name as name, hfl_unit as unit") \
		_T(" FROM hms_testorderline") \
		_T(" LEFT JOIN hms_fee_list ON(hpcl_itemid=hfl_feeid)") \
		_T(" WHERE 	hpcl_orderid=%ld ") \
		_T(" 	and hpcl_result='%s'"), nOrderID, szFormID);
	rs2.ExecSQL(szSQL);

	while (!rs2.IsEOF())
	{
		rs2.GetValue(_T("name"), tmpStr2);
		if (!szOrderName.IsEmpty())
			szOrderName += _T("\r\n");
		szOrderName.AppendFormat(_T("%s"), tmpStr2);
		rs2.MoveNext();
		nNumberOrder++;
	}

	szReportName.Trim();

	if (!rpt.Init(szReportName))
	{
		return;
	}



	szSQL.Format(_T(" SELECT 	hd_patientno as patientno,  ") \
		_T(" 	hd_docno as docno,") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	CAST(TO_CHAR(hp_birthdate, 'YYYY') as integer) as birthyear,") \
		_T(" 	hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age, 	hp_sex as sexid,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T(" 	hp_occupation as occupationid,") \
		_T(" 	sys_sel_getname('sys_occupation', cast(hp_occupation as varchar(15))) as occupation,") \
		_T(" 	nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T(" 	hms_getaddress(hp_provid,hp_distid,hp_villid) as address,") \
		_T(" 	hp_workplaceid as workplaceid,") \
		_T(" 	hp_workplace as workplace,") \
		_T(" 	hd_object as objectid,") \
		_T(" 	(SELECT ho_desc FROM hms_object WHERE ho_id=hd_object) as objectname,") \
		_T(" 	hd_cardno as cardno,") \
		_T(" 	hd_cardidx as cardidx, ") \
		_T(" 	hd_reldisease as relationdisease, ") \
		_T(" 	hc_regdate as regdate, ") \
		_T(" 	hc_expdate as expdate ") \
		_T(" FROM hms_patient") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno)") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hd_docno=%ld"), nDocumentNo);
	//_fmsg(_T("%s"), szSQL);
	int ret = rs2.ExecSQL(szSQL);
	if (rs2.IsEOF())
	{
		ShowMessageBox(_T("Patient not found."));
		return;
	}

	//Report Header
	tmpStr.Empty();
	rs2.GetValue(_T("sexid"), szSex);
	//StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	//StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);
	rs.GetValue(_T("hpc_pdeptid"), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		CString szPerformDept;
		StringUpper(pMF->GetDepartmentName(tmpStr), szPerformDept);
		rpt.GetReportHeader()->SetValue(_T("PerformDept"), szPerformDept);
	}
	else
		rpt.GetReportHeader()->SetValue(_T("PerformDept"), _T(""));

	rs.GetValue(_T("hpc_docno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("SheetNo"), tmpStr);
	rs2.GetValue(_T("pname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);
	rs2.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);

	//Chi In ra nam sinh.
	rs2.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs2.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	tmpStr.Format(_T("%s - %s"), rs2.GetValue(_T("detailaddress")), rs2.GetValue(_T("address")));
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);

	rs2.GetValue(_T("objectname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("objectname"), tmpStr);

	rs2.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);

	rs2.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	rs2.GetValue(_T("regdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs2.GetValue(_T("expdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExpiryDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));


	CString szDate;
	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportHeader()->GetValue(_T("OrderDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);

	rs.GetValue(_T("hpc_doctor"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* imgHeader = rpt.GetReportHeader()->GetItem(_T("Signature"));
	if (imgHeader)
	{
		imgHeader->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		imgHeader->SetFixedHeight(false);
	}



	CString szDept;
	CRecord rsd(&pMF->m_db);
	rs.GetValue(_T("hpc_roomid"), tmpStr);
	nRoomID = ToInt(tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Room"), tmpStr);

	rs.GetValue(_T("hpc_deptid"), szDept);
	szSQL.Format(_T("SELECT hrl_name as roomname FROM hms_roomlist WHERE hrl_deptid='%s' AND hrl_id=%d"), szDept, ToInt(tmpStr));
	rsd.ExecSQL(szSQL);
	if (!rsd.IsEOF())
	{
		rsd.GetValue(_T("roomname"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);
	}


	rs.GetValue(_T("hpc_deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), pMF->GetDepartmentName(tmpStr));

	rs.GetValue(_T("hpc_bedid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Bed"), tmpStr);

	szSQL.Format(_T("SELECT hbl_name as bedname FROM hms_Bedlist WHERE hbl_deptid='%s' AND hbl_roomid =%d AND hbl_id=%d"), szDept, nRoomID, ToInt(tmpStr));
	rsd.ExecSQL(szSQL);
	if (!rsd.IsEOF())
	{
		rsd.GetValue(_T("Bedname"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("BedName"), tmpStr);
	}

	szSQL.Format(_T("SELECT htr_maindisease as maindisease, hcr_reldisease as reldisease FROM hms_clinical_record LEFT JOIN hms_treatment_record ON(htr_docno=hcr_docno) WHERE htr_docno=%ld and htr_idx=%d"), nDocumentNo, nRefIndex);
	rs3.ExecSQL(szSQL);
	if (!rs3.IsEOF())
	{
		rs3.GetValue(_T("maindisease"), tmpStr);

		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
		rs3.GetValue(_T("reldisease"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);
	}
	else
	{
		tmpStr.Empty();
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);
	}


	szSQL.Format(_T(" SELECT 	hfl_name as name, ") \
		_T(" 	hfl_unit as unit, ") \
		_T(" 	hfl_index1 as index1, ") \
		_T(" 	hfl_index2 as index2,") \
		_T(" 	hpcl_result as result,") \
		_T(" 	hpcl_note as note,hfl_subitem as subitem, ") \
		_T("	limsi_model as model ") \
		_T(" FROM hms_testorderline ") \
		_T(" LEFT JOIN hms_fee_list ON(hfl_feeid=hpcl_itemid)") \
		_T(" LEFT JOIN lims_instrument ON (limsi_id= hpcl_instid") \
		_T(" WHERE hpcl_orderid=%ld  and (hfl_printsubitem is NULL or hfl_printsubitem <>'N') ") \
		_T(" ORDER BY hfl_line"), nOrderID);


	ret = rs2.ExecSQL(szSQL);
	CReportSection* rptDetail;
	if (szGroupID.Left(2) == _T("B1")) {
		/*
				rs2.MoveFirst();
				if(ret > 30)
				{
					for (int i =0; i <= ret/2; i++)
					{
						rptDetail = rpt.AddDetail();
						rs2.GetValue(_T("name"), tmpStr);
						rptDetail->SetValue(_T("1"), tmpStr);
						rs2.GetValue(_T("index1"), tmpStr);
						rptDetail->SetValue(_T("2"), tmpStr);
						rs2.GetValue(_T("result"), tmpStr);
						rptDetail->SetValue(_T("3"), tmpStr);
						rptDetail->SetValue(_T("4"), _T(""));
						rptDetail->SetValue(_T("5"), _T(""));
						rptDetail->SetValue(_T("6"), _T(""));
						rs2.MoveNext();
					}
					for (int i =0; i <= ret/2 ; i++)
					{
						if(rs2.IsEOF())
							break;
						rptDetail = rpt.GetDetail(i+1);
						rs2.GetValue(_T("name"), tmpStr);
						rptDetail->SetValue(_T("4"), tmpStr);
						rs2.GetValue(_T("index1"), tmpStr);
						rptDetail->SetValue(_T("5"), tmpStr);
						rs2.GetValue(_T("result"), tmpStr);
						rptDetail->SetValue(_T("6"), tmpStr);
						rs2.MoveNext();
					}
				}
				else
				{
		*/
		int nItem = 1;
		while (!rs2.IsEOF())
		{
			rs2.GetValue(_T("subitem"), tmpStr);
			if (tmpStr.GetLength() <= 1)
			{
				//rpt.GetDetail(0)->GetItem(_T("1"))->SetFaceSize(10);
				//rpt.GetDetail(0)->GetItem(_T("1"))->SetItalic(false);
				tmpStr.Format(_T(" %d. %s"), nItem++, rs2.GetValue(_T("name")));
			}
			else
			{
				rpt.GetDetail(0)->GetItem(_T("1"))->SetFaceSize(8);
				rpt.GetDetail(0)->GetItem(_T("1"))->SetItalic(true);
				tmpStr.Format(_T("     - %s"), rs2.GetValue(_T("name")));
			}

			rptDetail = rpt.AddDetail();
			rptDetail->SetValue(_T("1"), tmpStr);
			if (szSex == _T("F"))
				rs2.GetValue(_T("index2"), tmpStr);
			else
				rs2.GetValue(_T("index1"), tmpStr);
			if (tmpStr == _T("0") || tmpStr == _T("0 - 0") || tmpStr == _T("0-0"))
				tmpStr.Empty();
			rptDetail->SetValue(_T("2"), tmpStr);

			tmpStr.Empty();
			rs2.GetValue(_T("result"), tmpStr);

			rptDetail->SetValue(_T("3"), tmpStr);
			rs2.GetValue(_T("unit"), tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);

			rs2.GetValue(_T("model"), tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			rs2.MoveNext();
		}
	}
	else
	{
		int nItem = 1;
		while (!rs2.IsEOF())
		{
			rptDetail = rpt.AddDetail();
			tmpStr.Format(_T("%d. %s"), nItem++, rs2.GetValue(_T("name")));
			rptDetail->SetValue(_T("1"), tmpStr);
			rs2.GetValue(_T("unit"), tmpStr);
			rptDetail->SetValue(_T("2"), tmpStr);
			rs2.MoveNext();
		}

	}


	//Page Footer
	//Report Footer

	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("OrderDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("OrderDate"), szDate);

	CReportItem* Picture = NULL;

	Picture = rpt.GetReportFooter()->GetItem(_T("Picture"));
	if (Picture)
	{
		HBITMAP hBitmap = pMF->GetPACSImage(pMF->m_szCurrentFileNamePACS);
		if (hBitmap)
		{
			Picture->SetHBITMAP(hBitmap);
			Picture->SetFixedHeight(false);
			::DeleteObject(hBitmap);
		}
	}
	Picture = rpt.GetReportHeader()->GetItem(_T("Picture"));

	if (Picture)
	{
		HBITMAP hBitmap = pMF->GetPACSImage(pMF->m_szCurrentFileNamePACS);
		if (hBitmap)
		{
			Picture->SetHBITMAP(hBitmap);
			Picture->SetFixedHeight(false);
			::DeleteObject(hBitmap);
		}
	}

	rs.GetValue(_T("hpc_doctor"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{
		img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img->SetFixedHeight(false);
	}


	rs.GetValue(_T("hpc_performdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PerformDate"));
	if (CDateTime::IsValid(tmpStr))
		szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	else
		szDate.Format(tmpStr2, _T("....."), _T("....."), _T("........"));
	rpt.GetReportFooter()->SetValue(_T("PerformDate"), szDate);
	rs.GetValue(_T("hpc_practitioner"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Practitioner"), GetDoctorName(tmpStr));
	CReportItem* img2 = rpt.GetReportFooter()->GetItem(_T("Signature2"));
	if (img2)
	{
		img2->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img2->SetFixedHeight(false);
	}


	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(bDirect);
}

void CPrintForms::PrintPACSOrder(long nOrderID, CString szItemID, bool bPreview, bool bDirect) {
	
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szGroupID, szSex, szStatus, tmpStrx, tmpStrx3, szstt;
	CString szFilePath, szReportName, szOrderName;
	CString szSQL;
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db), rsd(&pMF->m_db);
	CRecord rsp(&pMF->m_db);
	CRecord rsc2(&pMF->m_db);
	CRecord rsc3(&pMF->m_db);

	long nDocumentNo;
	int nNumberOrder = 0;
	CString tmpStr2, szDeptType;
	CString szFormID;

	szSQL.Format(_T(" SELECT hpc_deptid as deptid, hpc_docno AS docno, 'P' || '' || hd_patientno as patientno,") \
		_T("   (SELECT DISTINCT hfg_name2 FROM hms_fee_group WHERE hfg_id=hpc_groupid") \
		_T("   ) AS group_name,") \
		_T("   trim(hp_surname") \
		_T("   ||' '") \
		_T("   ||hp_midname") \
		_T("   ||' '") \
		_T("   ||hp_firstname) AS pname,") \
		_T("   date_part('year', hp_birthdate) as yob, ") \
		_T("   HMS_GETSEX(hp_sex)           AS gender,") \
		_T("   HMS_GETOBJECTNAME(hd_object) AS object_desc,") \
		_T("   hd_cardno as cardno, hd_diagnostic, ") \
		_T(" hpc_orderdate as orderdate , ") \
		_T(" get_username(hpc_doctor) as doctorname, ") \
		_T(" hpc_roomid as roomid, hpc_class, hd_rank, HPC_ORDERID, (SELECT ss_desc from sys_sel WHERE ss_id='phanloai_xetnghiem'  AND ss_code=hpc_testtype) as testtype, ") \
		_T(" (SELECT trim(ss_vndesc) from sys_sel WHERE ss_id='hms_ma_phieu'  AND ss_code=hpc_groupid) as ma_phieu, ") \
		_T(" hpc_roomname as roomname2 ") \
		_T(" FROM hms_patient,") \
		_T("   hms_doc,") \
		_T("   hms_pacsorder") \
		_T(" WHERE hpc_orderid = %ld ") \
		_T(" AND hpc_docno     = hd_docno") \
		_T(" AND hd_patientno  = hp_patientno ORDER BY hpc_orderid"), nOrderID);

	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
	{
		return;
	}

	bool bRet = false;
	CString szId = _T("pacsorderx_108");
	szReportName = _T("HMS_PACSORDER.RPT");

	bRet = pMF->OnPostGenDocX(&rpt, szId, pMF->m_nDocumentNo, nOrderID, szReportName, szItemID);
	if (bRet)
	{
		return;
	}

	szFilePath.Format(_T("REPORTS\\HMS\\%s"), szReportName);
    _tprintf(_T("\nszFilePath:%s"), szFilePath);
    


	if (!rpt.Init(szFilePath))
	{
		return;
	}

	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);


	CString szDeptID;
	rs.GetValue(_T("deptid"), szDeptID);
	rpt.GetReportHeader()->SetValue(_T("Department"), pMF->GetDepartmentName(szDeptID));


	StringUpper(rs.GetValue(_T("group_name")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TITLE"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("DocumentNo_2"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode_2"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo_2"), tmpStr);

	rs.GetValue(_T("patientno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("patNo"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("patNo_1"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Barcode_1"), tmpStr);

	rs.GetValue(_T("ma_phieu"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ma_phieu"), tmpStr);


	//Lấy thêm barcode là số hpcl_orderlineid để phục vụ PACS
	szSQL.Format(_T("SELECT hpcl_orderid from hms_pacsorderline where hpcl_orderid=%ld AND rownum<=1"), nOrderID);
	//_msg(_T("%s"), szSQL);
	long nOrderLine = 0;
	rsp.ExecSQL(szSQL);
	if (!rsp.IsEOF())
	{
		rsp.GetValue(_T("hpcl_orderid"), tmpStr);
		rsp.GetValue(_T("hpcl_orderid"), nOrderLine);
	}
	rpt.GetReportHeader()->SetValue(_T("OrderNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode1[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode1[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode1[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode1[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode1[93]"), tmpStr);
	//Lấy thêm thông tin chẩn đoán khi chỉ định phục vụ cho CT/MRI
	CRecord rsl10(&pMF->m_db);
	szSQL.Format(_T(" SELECT Listagg(Cast(HPCL_PREDIAGNOSIS AS VARCHAR2(1024)), ',') within GROUP (ORDER BY HPCL_ORDERLINEID) as Prediagnosis") \
		_T(" FROM hms_pacsorderline") \
		_T(" WHERE hpcl_docno=%ld") \
		_T(" AND hpcl_orderid=%ld"), pMF->m_nDocumentNo, nOrderID);

	rsl10.ExecSQL(szSQL);
	if (!rsl10.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("Prediagnosis"), rsl10.GetValue(_T("Prediagnosis")));
	}
	//Thông tin phòng thực hiện
	//Phòng thực hiện nội soi, phòng thiết lập ở khu C1.1 nhưng lại thực hiện nội soi CĐHA	

	szSQL.Format(_T(" SELECT htop_receptno AS receptno,ss_desc from HMS_PACSORDER_PENDING") \
		_T(" LEFT JOIN sys_sel ON (NVL(htop_proomid, 0)=cast(ss_code as int) )") \
		_T(" where ss_id='hms_endo_proom' and ss_vndesc = 'B3100' ") \
		_T(" AND htop_orderid =%ld") \
		_T(" and rownum <=1"), nOrderID);
	rsc3.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	if (!rsc3.IsEOF())
	{
		rsc3.GetValue(_T("receptno"), szstt);
		rsc3.GetValue(_T("ss_desc"), tmpStrx3);
	}
	rpt.GetReportHeader()->SetValue(_T("PerformRoom"), tmpStrx3);
	rpt.GetReportHeader()->SetValue(_T("receptno"), szstt);

	tmpStr.Format(_T("%ld"), nOrderLine);
	rpt.GetReportHeader()->SetValue(_T("OrderNo"), tmpStr);
	rs.GetValue(_T("pname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);
	//Chi In ra nam sinh.
	rs.GetValue(_T("yob"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("Gender"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Gender"), tmpStr);
	rs.GetValue(_T("object_desc"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Object"), tmpStr);

	rs.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);

	rs.GetValue(_T("testtype"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("testtype"), tmpStr);

	CString szroomname2;
	rs.GetValue(_T("roomname2"), szroomname2);

	int nRoomID;
	rs.GetValue(_T("roomid"), tmpStr);
	nRoomID = str2int(tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RoomID"), tmpStr);
	szSQL.Format(_T("SELECT hrl_name as roomname FROM hms_roomlist WHERE hrl_deptid='%s' AND hrl_id=%d"), szDeptID, nRoomID);
	rsd.ExecSQL(szSQL);
	if (!rsd.IsEOF())
	{
		rsd.GetValue(_T("roomname"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);
	}

	if (!szroomname2.IsEmpty())
	{
		rpt.GetReportHeader()->SetValue(_T("RoomName"), szroomname2);
	}

	rs.GetValue(_T("hd_rank"), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		rpt.GetReportHeader()->SetValue(_T("Rank"), pMF->GetSelectionString(_T("hms_rank"), tmpStr));
	}


	CString szDate;
	rs.GetValue(_T("orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PrintDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	rs.GetValue(_T("doctorname"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);

	rs.GetValue(_T("hpc_class"), tmpStr);
	if (tmpStr == _T("E"))
	{
		rs.GetValue(_T("hd_diagnostic"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
		szSQL.Format(_T("SELECT max(he_receptno) as receptno FROM hms_exam WHERe he_docno=%ld and he_roomid=%d"), nDocumentNo, nRoomID);
		CRecord rsx(&pMF->m_db);
		rsx.ExecSQL(szSQL);
		if (!rsx.IsEOF())
		{
			rsx.GetValue(_T("receptno"), tmpStr);
			rpt.GetReportHeader()->SetValue(_T("ReceptNo"), tmpStr);
		}

	}
	else
	{
		CRecord rsx(&pMF->m_db);
		szSQL.Format(_T("SELECT htr_maindisease FROM hms_treatment_record ") \
			_T("WHERE htr_docno =%ld and htr_deptid='%s' and rownum <=1 ORDER BY htr_idx DESC "),
			nDocumentNo, szDeptID);
		rsx.ExecSQL(szSQL);
		rsx.GetValue(_T("htr_maindisease"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	}


	szSQL.Format(_T(" SELECT hpcl_orderlineid||'-'||hfl_name AS testname, hpcl_noteex as hpcl_note, ") \
		_T("   hfl_unit AS unit, hpcl_qty as qty,hfl_print_bold print_bold, GET_SYSSEL_SAMPLE_DESC('test_sample_type', hpcl_sample) as sample ") \
		_T(" FROM hms_pacsorderline ") \
		_T(" LEFT JOIN hms_fee_list") \
		_T(" ON(hfl_feeid       = hpcl_itemid)") \
		_T(" WHERE hpcl_orderid = %ld") \
		_T(" AND hpcl_hasfee    ='Y'") \
		_T(" AND hpcl_status  NOT IN ('C')") \
		_T(" ORDER BY hpcl_orderlineid "), nOrderID);


	rsl.ExecSQL(szSQL);

	CReportSection* rptDetail = NULL;
	int nItem = 1;
	int nQty;
	CString szNote, szUnit, szSample;
	while (!rsl.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nItem++);
		rptDetail->SetValue(_T("IDX"), tmpStr);
		rsl.GetValue(_T("qty"), nQty);
		rsl.GetValue(_T("testname"), tmpStr);
		rsl.GetValue(_T("hpcl_note"), szNote);
		szNote.Trim();
		if (!szNote.IsEmpty())
		{
			tmpStr.AppendFormat(_T(" (%s)"), szNote);
		}

		rsl.GetValue(_T("sample"), szSample);
		if (!szSample.IsEmpty())
		{
			tmpStr.AppendFormat(_T(" (Mẫu: %s)"), szSample);
		}
		if (nQty > 1)
		{
			rsl.GetValue(_T("hfl_unit"), szUnit);
			tmpStr.AppendFormat(_T("; S\x1ED1 l\x1B0\x1EE3ng: %d %s"), nQty, szUnit);
		}
		if (rsl.GetValue(_T("print_bold")) == _T("Y")) rptDetail->GetItem(_T("TestName"))->SetBold(true);
		rptDetail->SetValue(_T("TestName"), tmpStr);
		rsl.MoveNext();
	}

	//Page Footer
	//Report Footer
	tmpStr = pMF->GetSysDateTime();
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PrintTime"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintTime"), szDate);

	if (pMF->GetObjectType() == _T("I"))
	{
		szSQL.Format(_T(" SELECT Count(*)") \
			_T(" FROM   hms_pacsorderline") \
			_T(" WHERE  hpcl_orderid = %ld AND hpcl_itemid IN (SELECT ss_code FROM   sys_sel WHERE  ss_id = 'HMS_FEE_LIST_APPROVAL') "), nOrderID);
		rs.ExecSQL(szSQL);
		//_msg(_T("%s"), szSQL);
		if (rs.GetIntValue() > 0)
		{
			rpt.GetReportFooter()->SetValue(_T("thu_truong_ky"), _T("THỦ TRƯỞNG KÝ"));
		}
	}

	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(bDirect);
}

void CPrintForms::PrintPACSResult(long nOrderID, CString szItemID, bool bPreview, bool bDirect) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CString szModuleID = pMF->GetModuleID();
	pMF->m_szModuleID = _T("EM");
	pMF->PrintPACSResultX(nOrderID, szItemID, true, false);
	pMF->m_szModuleID = szModuleID;
	return;

}

void CPrintForms::PM_PrintPurchaseInvoice(long nOrderID, CString szSearch)
{
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL, * rptPrevGroup = NULL;
	double nTmp = 0;
	int nIdx = 1, nIdx2 = 0;
	CString szSQL, tmpStr, szReportName, szDate, szOldLev1, szNewLev1, szFromDate, szToDate, szField, szTemp, szPrevGroup;
	double nTotal = 0, nGroupTotal1 = 0;
	if (pMF->GetModuleID() == _T("PM"))
	{
		if (!rpt.Init(_T("Reports/HMS/PM_BANGKETHANHTOANCONGNO.RPT")))
			return;
	}
	else
	{
		if (!rpt.Init(_T("Reports/HMS/MA_BANGKETHANHTOANCONGNO_MAU1.RPT")))
			return;
	}

	szSQL.Format(_T(" SELECT min(po_approveddate) from_date, max(po_approveddate) to_date") \
		_T(" FROM   purchase_order") \
		_T(" WHERE  po_payment = 'Y' AND po_refpayment_id = %ld"), nOrderID);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rs.GetValue(_T("from_date"), szFromDate);
		rs.GetValue(_T("to_date"), szToDate);
	}
	szSQL.Format(_T(" SELECT") \
		_T("   po_purchase_order_id as id,") \
		_T("   po_invoiceno                   AS invoiceno,") \
		_T("   trunc(po_invoicedate)                 AS invoicedate,") \
		_T("   po_orderno                     AS orderno,") \
		_T("   trunc(po_approveddate)                AS importdate,") \
		_T("   po_totalamount                 AS amount,") \
		_T("   Get_partnername(po_partner_id) AS partnername") \
		_T(" FROM   purchase_order") \
		_T(" LEFT JOIN purchase_payment ON (po_refpayment_id=pp_purchase_payment_id)") \
		_T(" WHERE  po_payment = 'Y' AND po_refpayment_id = %ld and lower(get_partnername(po_partner_id)) like(chr(37)||lower('%s')||chr(37))") \
		_T(" ORDER  BY po_partner_id "), nOrderID, szSearch);
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(szToDate), yyyymmdd, ddmmyyyy);
		rpt.GetReportHeader()->SetValue(_T("ReportDate"), tmpStr);
	}

	while (!rs.IsEOF())
	{
		rs.GetValue(_T("partnername"), szNewLev1);
		if (szOldLev1 != szNewLev1)
		{
			if (nGroupTotal1 > 0)
			{
				tmpStr.Format(_T("%f"), nGroupTotal1);
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				rptGroup->SetValue(_T("s6"), tmpStr);
				FormatCurrency(nGroupTotal1, szTemp);
				tmpStr.Format(_T("%s (%s)"), szPrevGroup, szTemp);
				rptPrevGroup->SetValue(_T("GroupName"), tmpStr);
				nTotal += nGroupTotal1;
				nGroupTotal1 = 0;
			}
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(0));
			if (rptGroup)
			{
				rptGroup->SetValue(_T("GroupName"), szNewLev1);
				rptPrevGroup = rptGroup;
				szPrevGroup = szNewLev1;
			}
			nIdx2++;
			szOldLev1 = szNewLev1;
		}
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("invoiceno")));
			rs.GetValue(_T("invoicedate"), tmpStr);
			rptDetail->SetValue(_T("3"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("orderno")));
			rs.GetValue(_T("importdate"), tmpStr);
			rptDetail->SetValue(_T("5"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rs.GetValue(_T("amount"), nTmp);
			nGroupTotal1 += nTmp;
			rptDetail->SetValue(_T("6"), double2str(nTmp));
			rptDetail->SetValue(_T("7"), rs.GetValue(_T("productname")));
		}
		rs.MoveNext();
	}
	if (nGroupTotal1 > 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
		rptDetail->SetValue(_T("s6"), double2str(nGroupTotal1));
		nTotal += nGroupTotal1;
		FormatCurrency(nGroupTotal1, szTemp);
		tmpStr.Format(_T("%s (%s)"), szPrevGroup, szTemp);
		rptPrevGroup->SetValue(_T("GroupName"), tmpStr);
	}
	if (nTotal > 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
		rptDetail->SetValue(_T("s6"), ToString(nTotal));
	}
	rptDetail = rpt.GetReportFooter();
	rptDetail->SetValue(_T("TotalItem"), int2str(nIdx2++));
	tmpStr.Format(_T("%f"), nTotal);
	rptDetail->SetValue(_T("TotalAmount"), tmpStr);

	szSQL.Format(_T(" SELECT SUM(thuoc) drug, ") \
		_T("        SUM(hoachat) chemicals, ") \
		_T("        SUM(bbg) cotton, ") \
		_T("        SUM(duoclieu) herb,") \
		_T("        SUM(tpdd) compound,") \
		_T("        SUM(ycu) instrument") \
		_T(" FROM   (SELECT CASE WHEN (instr(product_producttype, 'A11') > 0 OR product_producttype IN ('A1400', 'A6000'))") \
		_T("                     THEN pol_totalamount ") \
		_T("                ELSE 0 ") \
		_T("                END AS thuoc, ") \
		_T("                CASE WHEN instr(product_producttype, 'A121') > 0 THEN pol_totalamount ") \
		_T("                ELSE 0 ") \
		_T("                END AS hoachat, ") \
		_T("                CASE WHEN product_producttype = 'A1500' THEN pol_totalamount ") \
		_T("                ELSE 0 ") \
		_T("                END AS bbg, ") \
		_T("                CASE WHEN product_producttype = 'A1302' THEN pol_totalamount ") \
		_T("                ELSE 0 ") \
		_T("                END AS duoclieu, ") \
		_T("				CASE WHEN product_producttype = 'A1301' THEN pol_totalamount") \
		_T("				ELSE 0") \
		_T("				END AS tpdd,") \
		_T("				CASE WHEN product_producttype = 'A1600' THEN pol_totalamount") \
		_T("				ELSE 0") \
		_T("				END AS ycu") \
		_T("         FROM   purchase_orderline, ") \
		_T("                m_product_view, ") \
		_T("				purchase_order,") \
		_T("				purchase_payment") \
		_T("         WHERE  pol_product_id = product_id ") \
		_T("			AND po_purchase_order_id = pol_purchase_order_id") \
		_T("			AND po_refpayment_id=pp_purchase_payment_id AND po_payment = 'Y' AND po_refpayment_id = %ld) "), nOrderID);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		//l1..l4
		int nIdx = 1;
		for (int i = 0; i < rs.GetFieldCount(); i++)
		{
			szField = rs.GetFieldName(i);
			rs.GetValue(szField, nTmp);
			if (nTmp > 0)
			{
				tmpStr.Format(_T("l%d"), nIdx);
				TranslateString(szField, szTemp);
				rptDetail->SetValue(tmpStr, szTemp);
				tmpStr.Format(_T("s%d"), nIdx);
				FormatCurrency(nTmp, szTemp);
				szTemp += _T(" \x111\x1ED3ng.");
				rptDetail->SetValue(tmpStr, szTemp);
				nIdx++;
			}
		}
	}
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.PrintPreview();
}
//Hàm in bảng xác định khối lượng công việc hoàn thành, phần công nợ//
void CPrintForms::MA_PrintPurchaseInvoice_Approve(long nOrderID, CString szSearch)
{
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CString szSQL, szOrderDate;
	CString tmpStr, tmpStr2;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rs3(&pMF->m_db);

	int nCount = 0;
	int nVAT;
	double nTotalAmount = 0;
	double nTotalVatAmount = 0;
	double nTotalPaidAmount = 0;

	szSQL.Format(_T(" SELECT") \
		_T("   po_purchase_order_id as id,") \
		_T("   po_invoiceno                   AS invoiceno,") \
		_T("   trunc(po_invoicedate)                 AS invoicedate,") \
		_T("   po_orderno                     AS orderno,") \
		_T("   trunc(po_approveddate)                AS importdate,") \
		_T("	Get_Taxrate(po_tax_id)*100 as vat, ") \
		_T("   po_totalamount                 AS amount,") \
		_T("   po_paidamount                 AS totalpaidamount,") \
		_T("  ADC_PARTNER_ID                 AS ADC_PARTNER_ID,") \
		_T("   Get_partnername(po_partner_id) AS congty_trungthau,") \
		_T("   ADC_CONTRACT_NO                AS so_hop_dong,") \
		_T("   Get_partnername(po_partner_id) AS congty_trungthau1,") \
		_T("   ADC_AMOUNT                     AS gia_tri_hop_dong") \
		_T(" FROM   purchase_order") \
		_T(" LEFT JOIN ad_contract ON (po_partner_id = ADC_PARTNER_ID)") \
		_T(" LEFT JOIN purchase_payment ON (po_refpayment_id=pp_purchase_payment_id)") \
		_T(" WHERE  po_payment = 'Y' AND po_refpayment_id = %ld and lower(get_partnername(po_partner_id)) like(chr(37)||lower('%s')||chr(37))") \
		_T(" ORDER  BY po_partner_id "), nOrderID, szSearch);
	//_msg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		ShowMessageBox(_T("No Data"));
		return;
	}

	CReport rpt;
	CString szDate, szSysDate;

	CString szReportTitle, szPath;
	if (pMF->GetModuleID() == _T("MA"))
	{
		szReportTitle = _T("BANGXACDINHKHOILUONG_MA");
	}
	else if (pMF->GetModuleID() == _T("BB"))
	{
		szReportTitle = _T("BANGXACDINHKHOILUONG");
	}
	else
	{
		szReportTitle.Format(_T("%s_BANGXACDINHKHOILUONG"), pMF->GetModuleID());
	}
	szPath.Format(_T("Reports/HMS/%s.RPT"), szReportTitle);
	if (!rpt.Init(szPath))
	{
		return;
	}
	//Step to undercover field name
	//for (int i = 0; i < 50; i++)
	//{
	//	_debug(_T("%s"), rpt.GetReportHeader()->GetItem(i)->GetName());
	//}
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rpt.GetReportHeader()->SetValue(_T("Department"), pMF->GetDepartmentName(pMF->GetDepartmentID()));
	rs.GetValue(_T("orderdate"), szOrderDate);
	//szOrderDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")),tmpStr.Mid(8, 2), tmpStr.Mid(5,2),tmpStr.Left(4));
	szDate = CDateTime::Convert(szOrderDate, yyyymmdd | hhmmss, ddmmyyyy | hhmmss);
	rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);

	rpt.GetReportHeader()->SetValue(_T("ID"), nOrderID);
	rs.GetValue(_T("Invoiceno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Orderno"), rs.GetValue(_T("orderno")));

	rpt.GetReportHeader()->SetValue(_T("so_hopdong"), rs.GetValue(_T("so_hopdong")));
	rs.GetValue(_T("invoicedate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InvoiceDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs.GetValue(_T("Status"), tmpStr);
	if (tmpStr == _T("A"))
		TranslateString(_T("Approved"), tmpStr);
	else
		TranslateString(_T("Openning"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
	rs.GetValue(_T("suppliername"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("suppliername"), tmpStr);
	/*rs.GetValue(_T("deliverby"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("deliverby"), tmpStr);
	rs.GetValue(_T("ReceiveBy"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("receiveby"), tmpStr);*/
	rs.GetValue(_T("DebitAccount"), tmpStr);
	if (tmpStr == _T("0"))
		tmpStr.Empty();
	rpt.GetReportHeader()->SetValue(_T("DebitAccount"), tmpStr);
	rs.GetValue(_T("CreditAccount"), tmpStr);
	if (tmpStr == _T("0"))
		tmpStr.Empty();
	rpt.GetReportHeader()->SetValue(_T("CreditAccount"), tmpStr);
	rs.GetValue(_T("StorageName"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("StockName"), tmpStr);
	rs.GetValue(_T("Importdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ImportDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs.GetValue(_T("voucher"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("voucher"), tmpStr);

	if (pMF->GetModuleID() == _T("MA"))
	{
		rs.GetValue(_T("documentno"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("ReferenceNo"), tmpStr);
	}

	rs.GetValue(_T("description"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Reason"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Source"), rs.GetValue(_T("original")));

	rpt.GetReportHeader()->SetValue(_T("so_hop_dong"), rs.GetValue(_T("so_hop_dong")));
	rpt.GetReportHeader()->SetValue(_T("congty_trungthau"), rs.GetValue(_T("congty_trungthau")));
	rpt.GetReportHeader()->SetValue(_T("congty_trungthau1"), rs.GetValue(_T("congty_trungthau1")));
	tmpStr = SetNumberDelim(rs.GetValue(_T("gia_tri_hop_dong")));
	rpt.GetReportHeader()->SetValue(_T("gia_tri_hop_dong"), tmpStr);


	//Page Header
	//Report Detail

	CString szMoney, szExprDate, szItemType;
	rs.GetValue(_T("vat"), nVAT);

	tmpStr.Format(_T("%d %s"), nVAT, _T("%"));

	rpt.GetReportHeader()->SetValue(_T("VAT"), tmpStr);

	szSQL.Format(_T(" SELECT product_id                     AS id,") \
		_T("   product_name                        AS name,") \
		_T("   GET_UOMNAME(product_purchase_uomid) AS unit,") \
		_T("   pol_expdate                         AS expdate,") \
		_T("   pol_lotno                           AS lotno,") \
		_T("   product_countryname                 AS madein,") \
		_T("   product_manufacturename             AS mfgname,") \
		_T("   pol_qtyorder                        AS qty,") \
		_T("   pol_unitprice                       AS price,") \
		_T("   product_groupname,") \
		_T("   pol_unitprice +pol_unitprice*pol_taxrate/100.0 AS vatprice,") \
		_T("   (pol_unitprice+pol_unitprice*pol_taxrate/100.0)*pol_qtyorder vatamount,") \
		_T("   pol_qtyorder  *pol_unitprice AS amount") \
		_T(" FROM purchase_orderline") \
		_T(" LEFT JOIN purchase_order ON (PO_PURCHASE_ORDER_ID = POL_PURCHASE_ORDER_ID)") \
		_T(" LEFT JOIN purchase_payment") \
		_T(" ON (po_refpayment_id =pp_purchase_payment_id)") \
		_T(" LEFT JOIN m_productitem_view3") \
		_T(" ON(product_item_id         =pol_product_item_id)") \
		_T(" WHERE  po_payment = 'Y' AND po_refpayment_id = %ld and lower(get_partnername(po_partner_id)) like(chr(37)||lower('%s')||chr(37))") \
		_T(" ORDER BY pol_line"), nOrderID, szSearch);

	rs2.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	CReportSection* rptDetail;
	while (!rs2.IsEOF()) {
		rptDetail = rpt.AddDetail();
		rs2.GetValue(_T("expdate"), tmpStr);
		if (CDate::IsValid(tmpStr))
			szExprDate = CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy);
		else
			szExprDate.Empty();
		nTotalAmount += ToDouble(rs2.GetValue(_T("amount")));
		nTotalVatAmount += ToDouble(rs2.GetValue(_T("vatamt")));
		nTotalPaidAmount += ToDouble(rs2.GetValue(_T("vatamount")));
		nCount++;
		rs2.GetValue(_T("product_groupname"), tmpStr);
		if (szItemType.Find(tmpStr) == -1)
		{
			if (!szItemType.IsEmpty())
				szItemType += _T(", ");
			szItemType.AppendFormat(_T("%s"), tmpStr);
		}

		tmpStr.Format(_T("%d"), nCount);
		rptDetail->SetValue(_T("1"), tmpStr);
		rs2.GetValue(_T("name"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rs2.GetValue(_T("unit"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rptDetail->SetValue(_T("4"), szExprDate);
		rs2.GetValue(_T("lotno"), tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		tmpStr = SetNumberDelim(rs2.GetValue(_T("qty")));
		rptDetail->SetValue(_T("6"), tmpStr);
		tmpStr = SetNumberDelim(rs2.GetValue(_T("price")));
		rptDetail->SetValue(_T("7"), tmpStr);
		tmpStr = SetNumberDelim(rs2.GetValue(_T("vatprice")));
		rptDetail->SetValue(_T("8"), tmpStr);

		tmpStr = SetNumberDelim(rs2.GetValue(_T("amount")));
		rptDetail->SetValue(_T("9"), tmpStr);
		rs2.GetValue(_T("madein"), tmpStr);
		rptDetail->SetValue(_T("10"), tmpStr);
		rs2.GetValue(_T("mfgname"), tmpStr);
		rptDetail->SetValue(_T("11"), tmpStr);
		tmpStr = SetNumberDelim(rs2.GetValue(_T("vatamount")));
		rptDetail->SetValue(_T("12"), tmpStr);
		rs2.MoveNext();
	}
	CStringToken token(szItemType);
	int nTokenSize = token.GetSize();
	switch (nTokenSize)
	{
	case 0:
		break;
	case 1:
		token.GetAt(0, tmpStr2);
		TranslateString(tmpStr2, tmpStr);
		break;
	case 6:
		tmpStr = _T("To\xE0n \x62\x1ED9");
		break;
	default:
		tmpStr = _T("\x110\x61 lo\x1EA1i");
		break;
	}
	rpt.GetReportHeader()->SetValue(_T("ItemType"), tmpStr);
	//	rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
	double nVatAmt = (double)(nTotalAmount * nVAT) / 100.0;
	//	FormatCurrency(nTotalAmount, tmpStr);
	//	rptDetail->SetValue(_T("s8"), tmpStr);
		//Page Footer
		//Report Footer
	rs.GetValue(_T("createdby"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("CreatedBy"), tmpStr);

	tmpStr.Format(_T("%d"), nCount);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);

	FormatCurrency(nTotalAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("SubTotal"), tmpStr);

	FormatCurrency(nVatAmt, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalVAT"), tmpStr);

	FormatCurrency(floor(nTotalAmount + nVatAmt + 0.5), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);

	FormatCurrency(nTotalVatAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalPrice"), tmpStr);

	//szMoney.Format(_T("%.2f"), floor(nTotalAmount+nVatAmt+0.5));
	//MoneyToString(szMoney, tmpStr);
	szSQL.Format(_T(" SELECT ") \
		_T("   SUM(po_paidamount)                  AS totalpaidamount ") \
		_T(" FROM purchase_order") \
		_T(" LEFT JOIN purchase_payment") \
		_T(" ON (po_refpayment_id =pp_purchase_payment_id)") \
		_T(" WHERE po_payment     = 'Y'") \
		_T(" AND po_refpayment_id = %ld") \
		_T(" AND lower(get_partnername(po_partner_id)) LIKE(chr(37)") \
		_T("   ||lower('%s')") \
		_T("   ||chr(37))") \
		_T(" ORDER BY po_partner_id"), nOrderID, szSearch);
	rs3.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	nTotalPaidAmount = ToDouble(rs3.GetValue(_T("totalpaidamount")));
	FormatCurrency(nTotalPaidAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalPaidAmount"), tmpStr);

	szMoney.Format(_T("%.2f"), floor(nTotalPaidAmount));
	MoneyToString(szMoney, tmpStr);

#ifdef UNICODE
	if (!tmpStr.IsEmpty()
		)
		tmpStr += _T(" \x111\x1ED3ng.");
#else
	if (!tmpStr.IsEmpty())
		tmpStr += _T(" ®ång.");
#endif
	CReportSection* rptFooter = rpt.GetReportFooter();
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
	//szSysDate = pMF->GetSysDate(); 
	//tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")),szOrderDate.Mid(8, 2),szOrderDate.Mid(5,2),szOrderDate.Left(4));
	//rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);


	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	OnPrintFooterUser(rptFooter, rs.GetValue(_T("storage_category")) == _T("S") ? _T("DV") : _T("BH"), _T("'ng_giao', 'ng_nhan'"));
	rptFooter->SetValue(_T("ng_giao"), rs.GetValue(_T("deliverby")));
	rptFooter->SetValue(_T("ng_nhan"), rs.GetValue(_T("ReceiveBy")));
	rptFooter->SetValue(_T("createdby1"), pMF->GetUserName(pMF->GetCurrentUser()));
	rpt.PrintPreview();
}

void CPrintForms::E10_PrintAdjustmentExport(long nOrderId) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	/*Declaration Section*/
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL, * rptFooter = NULL;
	double nTmp = 0;
	int nIdx = 1;
	CString szSQL, tmpStr, szReportName, szDate, szTemp;
	double nTotal = 0;
	szReportName = _T("Reports\\HMS\\PMS_EXPORTORDER.RPT");
	if (!rpt.Init(szReportName))
		return;

	szSQL.Format(_T(" SELECT mi_orderno                     invoice_no, ") \
		_T("        mi_date                        inventory_date, ") \
		_T("        mi_status                      status, ") \
		_T("        Get_storagename(mi_storage_id) storage_name, ") \
		_T("        mi_description                 note ") \
		_T(" FROM   m_inventory") \
		_T(" WHERE mi_inventory_id = %ld ") \
		_T(" AND mi_status = 'A'"), nOrderId);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		szDate = pMF->GetSysDate();
		tmpStr.Format(rptHeader->GetValue(_T("PrintDate")), szDate.Mid(8, 2), szDate.Mid(5, 2), szDate.Left(4));
		rptHeader->SetValue(_T("PrintDate"), tmpStr);
		rptHeader->SetValue(_T("InvoiceNo"), rs.GetValue(_T("invoice_no")));
		rptHeader->SetValue(_T("OrderDate"), rs.GetValue(_T("inventory_date")));
		rptHeader->SetValue(_T("Status"), _T("\x110\xE3 \x64uy\x1EC7t"));
		rptHeader->SetValue(_T("StockName"), rs.GetValue(_T("storage_name")));
		rptHeader->SetValue(_T("Comment"), rs.GetValue(_T("note")));
		rptHeader->SetValue(_T("Reason"), _T("\x110i\x1EC1u \x63h\x1EC9nh"));
	}
	szSQL.Format(_T(" SELECT    product_name, ") \
		_T("           product_countryname, ") \
		_T("           product_uomname, ") \
		_T("           product_lotno, ") \
		_T("           mil_qtyadj, ") \
		_T("           product_taxprice, ") \
		_T("           mil_qtyadj * product_taxprice amount ") \
		_T(" FROM      m_inventoryline ") \
		_T(" LEFT JOIN m_productitem_view ON ( mil_product_item_id = product_item_id ) ") \
		_T(" WHERE mil_inventory_id = %ld ") \
		_T(" AND mil_qtyadj > 0"), nOrderId);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("product_name")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("product_countryname")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("product_uomname")));
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("product_lotno")));
			rptDetail->SetValue(_T("6"), rs.GetValue(_T("mil_qtyadj")));
			rptDetail->SetValue(_T("7"), rs.GetValue(_T("product_taxprice")));
			rs.GetValue(_T("amount"), nTmp);
			nTotal += nTmp;
			rptDetail->SetValue(_T("8"), double2str(nTmp));
		}
		rs.MoveNext();
	}
	nIdx--;
	rptFooter = rpt.GetReportFooter();
	if (rptFooter)
	{
		rptFooter->SetValue(_T("TotalItem"), int2str(nIdx));
		tmpStr.Format(_T("%f"), nTotal);
		rptFooter->SetValue(_T("TotalAmount"), tmpStr);
		MoneyToString(tmpStr, szTemp);
		rptFooter->SetValue(_T("SumInWord"), szTemp);
	}
	rpt.PrintPreview();
}
void CPrintForms::PM_PrintPurchaseInvoiceEx(long nOrderID)
{
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL;
	double nTmp = 0;
	int nIdx = 1;
	CString szSQL, tmpStr, szReportName, szDate, szOldLev1, szNewLev1, szFromDate, szToDate, szField, szTemp;
	double nTotal = 0, nGroupTotal1 = 0;
	if (!rpt.Init(_T("Reports/HMS/PM_BANGKETHANHTOANCONGNO.RPT")))
		return;
	szSQL.Format(_T(" SELECT min(po_approveddate) from_date, max(po_approveddate) to_date") \
		_T(" FROM   purchase_order") \
		_T(" WHERE  po_payment = 'Y' AND po_refpayment_id = %ld"), nOrderID);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rs.GetValue(_T("from_date"), szFromDate);
		rs.GetValue(_T("to_date"), szToDate);
	}
	szSQL.Format(_T(" SELECT") \
		_T("   po_purchase_order_id as id,") \
		_T("   po_invoiceno                   AS invoiceno,") \
		_T("   trunc(po_invoicedate)                 AS invoicedate,") \
		_T("   po_orderno                     AS orderno,") \
		_T("   trunc(po_approveddate)                AS importdate,") \
		_T("   po_totalamount                 AS amount,") \
		_T("   Get_partnername(po_partner_id) AS partnername") \
		_T(" FROM   purchase_order") \
		_T(" LEFT JOIN purchase_payment ON (po_refpayment_id=pp_purchase_payment_id)") \
		_T(" WHERE  po_payment = 'Y' AND po_refpayment_id = %ld)") \
		_T(" ORDER  BY po_partner_id "), nOrderID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(szToDate), yyyymmdd, ddmmyyyy);
		rpt.GetReportHeader()->SetValue(_T("ReportDate"), tmpStr);
	}
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("invoiceno")));
			rs.GetValue(_T("invoicedate"), tmpStr);
			rptDetail->SetValue(_T("3"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("orderno")));
			rs.GetValue(_T("importdate"), tmpStr);
			rptDetail->SetValue(_T("5"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rs.GetValue(_T("amount"), nTmp);
			nGroupTotal1 += nTmp;
			rptDetail->SetValue(_T("6"), double2str(nTmp));
		}
		rs.MoveNext();
	}
	if (nGroupTotal1 > 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
		rptDetail->SetValue(_T("s6"), double2str(nGroupTotal1));
		nTotal += nGroupTotal1;
	}
	rptDetail = rpt.GetReportFooter();
	rptDetail->SetValue(_T("TotalItem"), int2str(nIdx++));
	tmpStr.Format(_T("%f"), nTotal);
	rptDetail->SetValue(_T("TotalAmount"), tmpStr);
	szSQL.Format(_T(" SELECT SUM(thuoc) drug, ") \
		_T("        SUM(hoachat) chemicals, ") \
		_T("        SUM(bbg) cotton, ") \
		_T("        SUM(duoclieu) herb,") \
		_T("        SUM(tpdd) compound,") \
		_T("        SUM(ycu) instrument") \
		_T(" FROM   (SELECT CASE WHEN (instr(product_producttype, 'A11') > 0 OR product_producttype IN ('A1400', 'A6000'))") \
		_T("                     THEN pol_totalamount ") \
		_T("                ELSE 0 ") \
		_T("                END AS thuoc, ") \
		_T("                CASE WHEN instr(product_producttype, 'A121') > 0 THEN pol_totalamount ") \
		_T("                ELSE 0 ") \
		_T("                END AS hoachat, ") \
		_T("                CASE WHEN product_producttype = 'A1500' THEN pol_totalamount ") \
		_T("                ELSE 0 ") \
		_T("                END AS bbg, ") \
		_T("                CASE WHEN product_producttype = 'A1302' THEN pol_totalamount ") \
		_T("                ELSE 0 ") \
		_T("                END AS duoclieu, ") \
		_T("				CASE WHEN product_producttype = 'A1301' THEN pol_totalamount") \
		_T("				ELSE 0") \
		_T("				END AS tpdd,") \
		_T("				CASE WHEN product_producttype = 'A1600' THEN pol_totalamount") \
		_T("				ELSE 0") \
		_T("				END AS ycu") \
		_T("         FROM   purchase_orderline, ") \
		_T("                m_product_view, ") \
		_T("				purchase_order,") \
		_T("				purchase_payment") \
		_T("         WHERE  pol_product_id = product_id ") \
		_T("			AND po_purchase_order_id = pol_purchase_order_id") \
		_T("			AND po_refpayment_id=pp_purchase_payment_id AND po_payment = 'Y' AND po_refpayment_id = %ld) "), nOrderID);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		//l1..l4
		int nIdx = 1;
		for (int i = 0; i < rs.GetFieldCount(); i++)
		{
			szField = rs.GetFieldName(i);
			rs.GetValue(szField, nTmp);
			if (nTmp > 0)
			{
				tmpStr.Format(_T("l%d"), nIdx);
				TranslateString(szField, szTemp);
				rptDetail->SetValue(tmpStr, szTemp);
				tmpStr.Format(_T("s%d"), nIdx);
				FormatCurrency(nTmp, szTemp);
				szTemp += _T(" \x111\x1ED3ng.");
				rptDetail->SetValue(tmpStr, szTemp);
				nIdx++;
			}
		}
	}
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.PrintPreview();
}


void CPrintForms::E10_PrintAdjustmentImport(long nOrderId) {
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	/*Declaration Section*/
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL, * rptFooter = NULL;
	double nTmp = 0;
	int nIdx = 1;
	CString szSQL, tmpStr, szReportName, szDate, szTemp;
	double nTotal = 0;
	szReportName = _T("Reports\\HMS\\PMS_IMPORTORDER.RPT");
	if (!rpt.Init(szReportName))
		return;

	szSQL.Format(_T(" SELECT mi_orderno                     invoice_no, ") \
		_T("        mi_date                        inventory_date, ") \
		_T("        mi_status                      status, ") \
		_T("        Get_storagename(mi_storage_id) storage_name, ") \
		_T("        mi_description                 note ") \
		_T(" FROM   m_inventory") \
		_T(" WHERE mi_inventory_id = %ld ") \
		_T(" AND mi_status = 'A'"), nOrderId);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		szDate = pMF->GetSysDate();
		tmpStr.Format(rptHeader->GetValue(_T("PrintDate")), szDate.Mid(8, 2), szDate.Mid(5, 2), szDate.Left(4));
		rptHeader->SetValue(_T("PrintDate"), tmpStr);
		rptHeader->SetValue(_T("InvoiceNo"), rs.GetValue(_T("invoice_no")));
		rptHeader->SetValue(_T("OrderDate"), rs.GetValue(_T("inventory_date")));
		rptHeader->SetValue(_T("Status"), _T("\x110\xE3 \x64uy\x1EC7t"));
		rptHeader->SetValue(_T("StockName"), rs.GetValue(_T("storage_name")));
		rptHeader->SetValue(_T("Comment"), rs.GetValue(_T("note")));
		rptHeader->SetValue(_T("Reason"), _T("\x110i\x1EC1u \x63h\x1EC9nh"));
	}
	szSQL.Format(_T(" SELECT    product_name, ") \
		_T("           product_countryname, ") \
		_T("           product_uomname, ") \
		_T("           product_lotno, ") \
		_T("           mil_qtyadj, ") \
		_T("           product_taxprice, ") \
		_T("           mil_qtyadj * product_taxprice amount ") \
		_T(" FROM      m_inventoryline ") \
		_T(" LEFT JOIN m_productitem_view ON ( mil_product_item_id = product_item_id ) ") \
		_T(" WHERE mil_inventory_id = %ld ") \
		_T(" AND mil_qtyadj < 0"), nOrderId);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("product_name")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("product_countryname")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("product_uomname")));
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("product_lotno")));
			rptDetail->SetValue(_T("6"), rs.GetValue(_T("mil_qtyadj")));
			rptDetail->SetValue(_T("7"), rs.GetValue(_T("product_taxprice")));
			rs.GetValue(_T("amount"), nTmp);
			nTotal += nTmp;
			rptDetail->SetValue(_T("8"), double2str(nTmp));
		}
		rs.MoveNext();
	}
	nIdx--;
	rptFooter = rpt.GetReportFooter();
	if (rptFooter)
	{
		rptFooter->SetValue(_T("TotalItem"), int2str(nIdx));
		tmpStr.Format(_T("%f"), nTotal);
		rptFooter->SetValue(_T("TotalAmount"), tmpStr);
		MoneyToString(tmpStr, szTemp);
		rptFooter->SetValue(_T("SumInWord"), szTemp);
	}
	rpt.PrintPreview();
}

void CPrintForms::HMS_InwardDrugUsage(long nDocNo) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	/*Declaration Section*/
	CRecord rs(&pMF->m_db);
	int nRefIdx = 0;
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL;
	double nTmp = 0;
	int nIdx = 1;
	CString szSQL, tmpStr, szReportName, szDate, szTemp;
	double nTotal = 0;
	szReportName = _T("Reports\\HMS\\TM_THONGKESUDUNGTHUOCNOITRU.RPT");
	if (!rpt.Init(szReportName))
		return;
	if (nRefIdx <= 0)
	{
		AfxMessageBox(_T("No reference idx"));
		return;
	}
	szSQL.Format(_T(" SELECT    get_departmentname(hcr_dischargedept) dept, ") \
		_T("           hcr_recordno record_no, ") \
		_T("		   hd_docno doc_no,") \
		_T("           Get_patientname(hd_docno) patient_name, ") \
		_T("           Extract(YEAR FROM hp_birthdate) yob, ") \
		_T("           get_syssel_desc('hms_rank', DECODE(0, hd_rank, hp_rank, hp_rank)) rank, ") \
		_T("           NVL(hp_workplace, hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid))) address, ") \
		_T("           hcr_sumtreat numbertr, ") \
		_T("           hcr_admitdate admit_date, ") \
		_T("           hcr_dischargedate discharge_date, ") \
		_T("           get_username(hcr_treatdoctor) doctor_name, ") \
		_T("           hcr_maindisease diagnostic ") \
		_T(" FROM      hms_patient ") \
		_T(" LEFT JOIN hms_doc ON ( hp_patientno = hd_patientno ) ") \
		_T(" LEFT JOIN hms_clinical_record ON ( hcr_docno = hd_docno ) ") \
		_T(" WHERE     hd_docno = %ld"), nDocNo);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);
		rptHeader->SetValue(_T("Department"), rs.GetValue(_T("dept")));
		rptHeader->SetValue(_T("DocNo"), rs.GetValue(_T("doc_no")));
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("record_no")));
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("patient_name")));
		rptHeader->SetValue(_T("yearofbirth"), rs.GetValue(_T("yob")));
		rptHeader->SetValue(_T("rank"), rs.GetValue(_T("rank")));
		rptHeader->SetValue(_T("address"), rs.GetValue(_T("address")));
		rptHeader->SetValue(_T("numbertreat"), rs.GetValue(_T("numbertr")));
		rptHeader->SetValue(_T("admitdate"), CDate::Convert(rs.GetValue(_T("admit_date")), yyyymmdd, ddmmyyyy));
		rptHeader->SetValue(_T("dischargedate"), CDate::Convert(rs.GetValue(_T("discharge_date")), yyyymmdd, ddmmyyyy));
		rptHeader->SetValue(_T("doctorname"), rs.GetValue(_T("doctor_name")));
		rptHeader->SetValue(_T("diagnostic"), rs.GetValue(_T("diagnostic")));
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rpt.GetReportHeader()->SetValue(_T("ReportDate"), tmpStr);
	}
	szSQL.Format(_T(" SELECT   product_name, product_uomname, sum(qty) qty, ") \
		_T("		   pol_price, group_id, sum(amount) amount") \
		_T(" FROM (SELECT    hfe_desc                         product_name, ") \
		_T("           hfe_unit                         product_uomname, ") \
		_T("           hfe_quantity                qty, ") \
		_T("           case when hfe_polprice > 0 then hfe_polprice else product_saleprice3 end pol_price, ") \
		_T("           hfe_group group_id, ") \
		_T("           case when hfe_polprice > 0 then hfe_polprice * hfe_quantity else product_saleprice3*hfe_quantity end amount ") \
		_T(" FROM      hms_clinical_record ") \
		_T(" LEFT JOIN hms_fee ON (hcr_docno = hfe_docno)") \
		_T(" LEFT JOIN m_productitem_view ON (product_item_id= hfe_itemid)") \
		_T(" LEFT JOIN hms_fee_group ON (hfg_id = hfe_group)") \
		_T(" WHERE     hfe_docno = %ld ") \
		_T("	   AND hfe_treattime = %d") \
		_T("       AND hfe_object IN ( 1, 3, 8, 13 ) ") \
		_T("	   AND hfe_category <> 'Y'") \
		_T("       AND hfg_type_id = 800 ") \
		_T("       AND hcrf_acceptedfee IN ( 'Y', 'P' ) )") \
		_T(" GROUP BY	  product_name, ") \
		_T("              product_uomname, ") \
		_T("              pol_price, ") \
		_T("              group_id ") \
		_T(" ORDER     BY group_id, ") \
		_T("              product_name"), nDocNo, nRefIdx);
	int nCount = rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		if (nCount < 0)
			_msg(_T("%s"), szSQL);
		else
			_fmsg(_T("%s"), szSQL);
		return;
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("product_name")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("product_uomname")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("qty")));
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("pol_price")));
			rs.GetValue(_T("amount"), nTmp);
			nTotal += nTmp;
			rptDetail->SetValue(_T("6"), double2str(nTmp));
		}
		rs.MoveNext();
	}
	szTemp.Format(_T("%f"), nTotal);
	FormatCurrency(nTotal, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.PrintPreview();
}

void CPrintForms::HMS_InwardDrugUsage(long nDocNo, int nRefIdx) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	/*Declaration Section*/
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL;
	double nTmp = 0;
	int nIdx = 1;
	CString szSQL, tmpStr, szReportName, szDate, szTemp;
	double nTotal = 0;
	szReportName = _T("Reports\\HMS\\TM_THONGKESUDUNGTHUOCNOITRU.RPT");
	if (!rpt.Init(szReportName))
		return;
	if (nRefIdx < 0)
	{
		AfxMessageBox(_T("No reference idx"));
		return;
	}
	szSQL.Format(_T(" SELECT    get_departmentname(hcr_dischargedept) dept, ") \
		_T("           hcr_recordno record_no, ") \
		_T("		   hd_docno doc_no,") \
		_T("           Get_patientname(hd_docno) patient_name, ") \
		_T("           Extract(YEAR FROM hp_birthdate) yob, ") \
		_T("           get_syssel_desc('hms_rank', DECODE(0, hd_rank, hp_rank, hp_rank)) rank, ") \
		_T("           NVL(hp_workplace, hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid))) address, ") \
		_T("           hcr_sumtreat numbertr, ") \
		_T("           hcr_admitdate admit_date, ") \
		_T("           hcr_dischargedate discharge_date, ") \
		_T("           get_username(hcr_treatdoctor) doctor_name, ") \
		_T("           hcr_maindisease diagnostic ") \
		_T(" FROM      hms_patient ") \
		_T(" LEFT JOIN hms_doc ON ( hp_patientno = hd_patientno ) ") \
		_T(" LEFT JOIN hms_clinical_record ON ( hcr_docno = hd_docno ) ") \
		_T(" WHERE     hd_docno = %ld"), nDocNo);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);
		rptHeader->SetValue(_T("Department"), rs.GetValue(_T("dept")));
		rptHeader->SetValue(_T("DocNo"), rs.GetValue(_T("doc_no")));
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("record_no")));
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("patient_name")));
		rptHeader->SetValue(_T("yearofbirth"), rs.GetValue(_T("yob")));
		rptHeader->SetValue(_T("rank"), rs.GetValue(_T("rank")));
		rptHeader->SetValue(_T("address"), rs.GetValue(_T("address")));
		rptHeader->SetValue(_T("numbertreat"), rs.GetValue(_T("numbertr")));

		szSQL.Format(_T(" SELECT MIN(htr_admitdate) AS admit_date,") \
			_T("   MAX(htr_dischargedate)  AS discharge_date") \
			_T(" FROM hms_treatment_record") \
			_T(" WHERE htr_docno  = %ld") \
			_T(" AND htr_treattime=%d "), nDocNo, nRefIdx);
		CRecord rsx(&pMF->m_db);
		rsx.ExecSQL(szSQL);
		if (!rsx.IsEOF())
		{
			rptHeader->SetValue(_T("admitdate"), CDate::Convert(rsx.GetValue(_T("admit_date")), yyyymmdd, ddmmyyyy));
			rptHeader->SetValue(_T("dischargedate"), CDate::Convert(rsx.GetValue(_T("discharge_date")), yyyymmdd, ddmmyyyy));
		}
		else
		{
			rptHeader->SetValue(_T("admitdate"), CDate::Convert(rs.GetValue(_T("admit_date")), yyyymmdd, ddmmyyyy));
			rptHeader->SetValue(_T("dischargedate"), CDate::Convert(rs.GetValue(_T("discharge_date")), yyyymmdd, ddmmyyyy));
		}
		rptHeader->SetValue(_T("doctorname"), rs.GetValue(_T("doctor_name")));
		rptHeader->SetValue(_T("diagnostic"), rs.GetValue(_T("diagnostic")));
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rpt.GetReportHeader()->SetValue(_T("ReportDate"), tmpStr);
	}
	if (nRefIdx > 0)
		szSQL.Format(_T(" SELECT   product_name, product_uomname, sum(qty) qty, ") \
			_T("		   pol_price, group_id, sum(amount) amount") \
			_T(" FROM (SELECT    hfe_desc                         product_name, ") \
			_T("           hfe_unit                         product_uomname, ") \
			_T("           hfe_quantity                qty, ") \
			_T("           case when hfe_polprice > 0 then hfe_polprice else product_saleprice3 end pol_price, ") \
			_T("           hfe_group group_id, ") \
			_T("           case when hfe_polprice > 0 then hfe_polprice * hfe_quantity else product_saleprice3*hfe_quantity end amount ") \
			_T(" FROM      hms_clinical_record") \
			_T(" LEFT JOIN hms_treatment_record ON (hcr_docno = htr_docno)") \
			_T(" LEFT JOIN hms_fee ON (hcr_docno = hfe_docno)") \
			_T(" LEFT JOIN m_productitem_view ON (product_item_id = hfe_itemid)") \
			_T(" LEFT JOIN hms_fee_group ON (hfg_id = hfe_group)") \
			_T(" WHERE     hfe_docno = %ld ") \
			_T("	   AND htr_treattime = %d") \
			_T("	   AND hfe_treattime = %d") \
			_T("       AND hfe_object IN ( 1, 3, 8, 13 ) ") \
			_T("	   AND hfe_category <> 'Y'") \
			_T("       AND hfg_type_id = 800 ") \
			_T("       AND htrf_acceptedfee IN ( 'Y', 'P' ) )") \
			_T(" GROUP BY	  product_name, ") \
			_T("              product_uomname, ") \
			_T("              pol_price, ") \
			_T("              group_id ") \
			_T(" ORDER     BY group_id, ") \
			_T("              product_name"), nDocNo, nRefIdx, nRefIdx);
	else
		szSQL.Format(_T(" SELECT   product_name, product_uomname, sum(qty) qty, ") \
			_T("		   pol_price, group_id, sum(amount) amount") \
			_T(" FROM (SELECT    hfe_desc                         product_name, ") \
			_T("           hfe_unit                         product_uomname, ") \
			_T("           hfe_quantity                qty, ") \
			_T("           case when hfe_polprice > 0 then hfe_polprice else product_saleprice3 end pol_price, ") \
			_T("           hfe_group group_id, ") \
			_T("           case when hfe_polprice > 0 then hfe_polprice * hfe_quantity else product_saleprice3*hfe_quantity end amount ") \
			_T(" FROM      hms_clinical_record") \
			_T(" LEFT JOIN hms_fee ON (hcr_docno = hfe_docno)") \
			_T(" LEFT JOIN m_productitem_view ON (product_item_id = hfe_itemid)") \
			_T(" LEFT JOIN hms_fee_group ON (hfg_id = hfe_group)") \
			_T(" WHERE     hfe_docno = %ld ") \
			_T("	   AND hfe_treattime = %d") \
			_T("       AND hfe_object IN ( 1, 3, 8, 13 ) ") \
			_T("	   AND hfe_category <> 'Y'") \
			_T("       AND hfg_type_id = 800 ") \
			_T("       AND hcrf_acceptedfee IN ( 'Y', 'P' ) )") \
			_T(" GROUP BY	  product_name, ") \
			_T("              product_uomname, ") \
			_T("              pol_price, ") \
			_T("              group_id ") \
			_T(" ORDER     BY group_id, ") \
			_T("              product_name"), nDocNo, nRefIdx);

	_fmsg(_T("%s"), szSQL);
	int nCount = rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		if (nCount < 0)
			_msg(_T("%s"), szSQL);
		else
			_fmsg(_T("%s"), szSQL);
		return;
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("product_name")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("product_uomname")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("qty")));
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("pol_price")));
			rs.GetValue(_T("amount"), nTmp);
			nTotal += nTmp;
			rptDetail->SetValue(_T("6"), double2str(nTmp));
		}
		rs.MoveNext();
	}
	szTemp.Format(_T("%f"), nTotal);
	FormatCurrency(nTotal, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.PrintPreview();
}

void CPrintForms::OnPrintCabinetReturnOrder(long nOrderID) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr;
	CString szSysDte;
	int nIdx = 0;
	double nS7 = 0, nS8 = 0;
	CReportSection* rptDetail, * rptHeader, * rptFooter;
	m_szReportName = _T("Reports\\HMS\\MA_RETURNORDERVOTE.RPT");
	if (!rpt.Init(m_szReportName))
		return;
	szSQL.Format(_T(" SELECT") \
		_T("   mt_orderno       AS orderno,") \
		_T("   get_username(mt_approvedby)    AS clerk,") \
		_T("   get_partnername(mt_partner_id) as deliverto,") \
		_T("   trunc(mt_approveddate)  AS dte,") \
		_T("   get_storagename(mt_storage_id) AS stock,") \
		_T("   get_departmentname(mt_department_id) AS dept,") \
		_T("   mt_description   AS descr,") \
		_T("   mt_documentno documentno") \
		_T(" FROM m_transaction") \
		_T(" WHERE mt_transaction_id = %ld"), nOrderID);
	int nRet = rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"), MB_ICONASTERISK | MB_OK);
		if (nRet < 0)
			_msg(_T("%s"), szSQL);
		return;
	}
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("OrderID"), rs.GetValue(_T("orderno")));
	rptHeader->SetValue(_T("DeliverBy"), rs.GetValue(_T("clerk")));
	rptHeader->SetValue(_T("FromStock"), rs.GetValue(_T("stock")));
	rptHeader->SetValue(_T("Comment"), rs.GetValue(_T("descr")));
	rs.GetValue(_T("dte"), szSysDte);
	rptHeader->SetValue(_T("OrderDate"), CDate::Convert(szSysDte, yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("Department"), rs.GetValue(_T("dept")));
	rptHeader->SetValue(_T("DeliveryTo"), rs.GetValue(_T("deliverto")));
	rptHeader->SetValue(_T("ReferenceNo"), rs.GetValue(_T("documentno")));
	szSQL.Format(_T(" SELECT") \
		_T("   product_name   AS pname,") \
		_T("   mtl_qtydelivery	AS qty,") \
		_T("   product_uomname	AS uom,") \
		_T("   product_expdate	AS expdte,") \
		_T("   mtl_saleprice AS price,") \
		_T("   product_lotno	AS lot,") \
		_T("   mtl_qtydelivery*mtl_saleprice AS amt") \
		_T(" FROM m_transactionline") \
		_T(" LEFT JOIN m_productitem_view ON (product_item_id=mtl_product_item_id)") \
		_T(" WHERE mtl_transaction_id = %ld"), nOrderID);
	nRet = rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		if (nRet < 0)
			_msg(_T("%s"), szSQL);
		return;
	}
	while (!rs.IsEOF())
	{
		nIdx++;
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("pname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("uom")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("qty")));
		rptDetail->SetValue(_T("8"), rs.GetValue(_T("price")));
		rs.GetValue(_T("amt"), tmpStr);
		nS8 += str2double(tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);
		rs.MoveNext();
	}
	rptFooter = rpt.AddDetail(rpt.GetGroupFooter(1));
	rptFooter->SetValue(_T("TotalItem"), int2str(nIdx));
	rptFooter->SetValue(_T("TotalAmount"), double2str(nS8));
	MoneyToString(ToString(nS8), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		tmpStr += _T(" \x111\x1ED3ng");
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
	}
	szSysDte = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDte.Right(2), szSysDte.Mid(5, 2), szSysDte.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::FM_OnPrintServiceIncomeList(CString szReceiptIDStr) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();

	CReport rpt;
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szWhere1;
	CString szSysDate, szReceiptStr;
	//Get Report Date
	szSQL.Format(_T("SELECT min(fac_createddate) from_date, max(fac_createddate) to_date FROM fa_cash WHERE fac_cash_id IN (%s)"), szReceiptIDStr);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rs.GetValue(_T("from_date"), m_szFromDate);
		rs.GetValue(_T("to_date"), m_szToDate);
	}
	//Get Receipt String
	szSQL.Format(_T("SELECT fac_invoiceno invoice_no FROM fa_cash WHERE fac_cash_id IN (%s)"), szReceiptIDStr);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF())
	{
		if (!szReceiptStr.IsEmpty())
			szReceiptStr += _T(", ");
		szReceiptStr += rs.GetValue(_T("invoice_no"));
		rs.MoveNext();
	}
	szWhere.Format(_T(" AND hfe_cash_id IN (%s) AND hfe_status = 'P' AND hfe_objectid = 7"), szReceiptIDStr);
	szWhere1.Format(_T(" AND hfe_cash_id IN (%s) AND hfe_status IN ('P', 'R') AND hfe_objectid = 7"), szReceiptIDStr);
	szSQL.Format(_T(" SELECT docno, ") \
		_T("		get_patientname(docno) pname,") \
		_T("		hcr_recordno recordno,") \
		_T("		ho_type object_type,") \
		_T("        deptid, ") \
		_T("		hfe_date,") \
		_T("        SUM(patpaid)               AS eamount, ") \
		_T("        SUM(deposit)               AS deposit, ") \
		_T("        SUM(inpatient_cost)        AS iamount, ") \
		_T("        SUM(inpatient_depositpaid) AS inpatient_deposit_paid, ") \
		_T("        SUM(inpatient_payment)     AS inpatient_payment, ") \
		_T("		SUM(patpaid+inpatient_payment+deposit) AS totalamount") \
		_T(" FROM   (SELECT hfe_docno   AS docno, ") \
		_T("				hfe_objectid,") \
		_T("                hfe_deptid  AS deptid, ") \
		_T("				hfe_date,") \
		_T("                hfe_patpaid AS patpaid, ") \
		_T("                hfe_deposit AS deposit, ") \
		_T("                0           AS inpatient_cost, ") \
		_T("                0           inpatient_depositpaid, ") \
		_T("                0           inpatient_payment ") \
		_T("         FROM   hms_fee_invoice ") \
		_T("         WHERE  hfe_class IN ('E', 'X') %s") \
		_T("         UNION ALL ") \
		_T("         SELECT hfe_docno, ") \
		_T("				hfe_objectid,") \
		_T("                hfe_deptid, ") \
		_T("				hfe_date,") \
		_T("                0, ") \
		_T("                hfe_amount, ") \
		_T("                0 AS inpatient_cost, ") \
		_T("                0 inpatient_depositpaid, ") \
		_T("                0 inpatient_payment ") \
		_T("         FROM   hms_fee_deposit ") \
		_T("         WHERE  hfe_class IN( 'I', 'A' ) %s") \
		_T("         UNION ALL ") \
		_T("         SELECT hfe_docno   AS docno, ") \
		_T("				hfe_objectid,") \
		_T("                hfe_deptid  AS deptid, ") \
		_T("				hfe_date,") \
		_T("                0, ") \
		_T("                0, ") \
		_T("                hfe_amount  AS inpatient_cost, ") \
		_T("                CASE WHEN hfe_deposit > hfe_patpaid THEN hfe_patpaid ") \
		_T("                ELSE hfe_deposit ") \
		_T("                END         AS inpatient_depositpaid, ") \
		_T("                hfe_payment AS inpatient_payment ") \
		_T("         FROM   hms_fee_invoice ") \
		_T("         WHERE  hfe_class IN( 'A', 'I' ) %s) ") \
		_T(" LEFT JOIN hms_clinical_record ON (hcr_docno = docno)")\
		_T(" LEFT JOIN hms_doc ON (hd_docno = docno) ") \
		_T(" LEFT JOIN hms_object ON (hfe_objectid = ho_id)") \
		_T(" WHERE 1=1") \
		_T(" GROUP  BY docno, ") \
		_T("		   hcr_recordno,") \
		_T("		   ho_type,") \
		_T("           deptid,") \
		_T("		   hfe_date ") \
		_T(" HAVING SUM(patpaid+inpatient_payment+deposit) > 0") \
		_T(" ORDER BY hfe_date"), szWhere, szWhere1, szWhere);
	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		ShowMessageBox(_T("No Data"), MB_OK | MB_ICONERROR);
		return;
	}

	if (!rpt.Init(_T("Reports/HMS/HF_BANGKETHUBNDICHVU.RPT")))
		return;

	StringUpper(pMF->m_szHealthService, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), tmpStr);

	StringUpper(pMF->m_szHospitalName, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), tmpStr);

	tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("ReportDate")),
		CDateTime::Convert(m_szFromDate, yyyymmdd | hhmm, ddmmyyyy | hhmm),
		CDateTime::Convert(m_szToDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));

	rpt.GetReportHeader()->SetValue(_T("ReportDate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ReceiptStr"), szReceiptStr);
	szTemp.Empty();
	//szTemp stores distinct object type
	while (!rs.IsEOF())
	{
		rs.GetValue(_T("object_type"), tmpStr);
		if (szTemp.Find(tmpStr) <= 0)
		{
			if (!szTemp.IsEmpty())
				szTemp += _T(", ");
			szTemp += tmpStr;
		}
		rs.MoveNext();
	}
	//Object Type Token
	tmpStr.Empty();
	CStringToken token(szTemp, _T(","));
	szTemp.Empty();
	for (int i = 0; i < token.GetSize(); i++)
	{
		if (!tmpStr.IsEmpty())
			tmpStr += _T(", ");
		token.GetAt(i, szTemp);
		tmpStr += pMF->GetObjectType();
	}
	rs.MoveFirst();
	CReportSection* rptDetail;
	CString szOldLine, szNewLine;
	CStringArray arrField;
	double nTotal[6];
	double nCost;
	int nIndex = 1;

	for (int i = 0; i < 6; i++)
	{
		nTotal[i] = 0;
	}
	arrField.Add(_T("eamount"));
	arrField.Add(_T("deposit"));
	arrField.Add(_T("iamount"));
	arrField.Add(_T("inpatient_deposit_paid"));
	arrField.Add(_T("inpatient_payment"));
	arrField.Add(_T("totalamount"));
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();

		tmpStr.Format(_T("%d"), nIndex++);
		rptDetail->SetValue(_T("1"), tmpStr);

		rs.GetValue(_T("pname"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);

		rs.GetValue(_T("docno"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);

		rs.GetValue(_T("recordno"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);

		//rs.GetValue(_T("deptid"), tmpStr);
		//rptDetail->SetValue(_T("5"), tmpStr);

		for (int j = 0; j < 6; j++)
		{
			rs.GetValue(arrField.GetAt(j), nCost);
			nTotal[j] += nCost;
			FormatCurrency(nCost, tmpStr);
			szTemp.Format(_T("%d"), j + 5);
			rptDetail->SetValue(szTemp, tmpStr);
		}
		rs.MoveNext();
	}

	if (nTotal[5] > 0)
	{
		for (int i = 0; i < 6; i++)
		{
			FormatCurrency(nTotal[i], tmpStr);
			szTemp.Format(_T("s%d"), i + 5);
			rpt.GetReportFooter()->SetValue(szTemp, tmpStr);
		}
	}

	szSysDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("User"), pMF->GetDoctorName(pMF->GetCurrentUser()));
	rpt.PrintPreview();
}

void CPrintForms::FM_OnPrintServiceOutlayList(CString szPaymentIDStr)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();

	CReport rpt;
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, szTemp, szWhere, szRefWhere, szRefWhere0;
	CString szSysDate, szPaymentStr;
	//Get Report Date
	szSQL.Format(_T("SELECT min(fac_createddate) from_date, max(fac_createddate) to_date FROM fa_cash WHERE fac_cash_id IN (%s)"), szPaymentIDStr);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rs.GetValue(_T("from_date"), m_szFromDate);
		rs.GetValue(_T("to_date"), m_szToDate);
	}
	//Get Receipt String
	szSQL.Format(_T("SELECT fac_invoiceno invoice_no FROM fa_cash WHERE fac_cash_id IN (%s)"), szPaymentIDStr);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF())
	{
		if (!szPaymentStr.IsEmpty())
			szPaymentStr += _T(", ");
		szPaymentStr += rs.GetValue(_T("invoice_no"));
		rs.MoveNext();
	}
	szWhere.Format(_T(" AND hfe_cash_id IN (%s) AND hfe_status = 'P'"), szPaymentIDStr);
	szRefWhere.Format(_T(" AND (r.hfe_cash_id IN (%s) AND r.hfe_status = 'P')"), szPaymentIDStr);
	szRefWhere0.Format(_T(" AND rf.hfe_cash_id IN (%s) AND rf.hfe_status = 'P'"), szPaymentIDStr);
	szSQL.Format(_T(" SELECT    Get_patientname(docno) pname, ") \
		_T("           hcr_recordno recordno, ") \
		_T("           docno, ") \
		_T("           deptid, ") \
		_T("		   hfe_date,") \
		_T("		   SUM(hitechreturn) hitechreturn,") \
		_T("           SUM(eamount) eamount, ") \
		_T("           SUM(iamount) iamount, ") \
		_T("           SUM(deposit) deposit, ") \
		_T("           SUM(refund)   AS refund, ") \
		_T("		   SUM(hitechreturn+eamount+refund) AS totalamount")
		_T(" FROM      (SELECT    rf.hfe_docno AS docno, ") \
		_T("                      rf.hfe_deptid AS deptid, ") \
		_T("                      rf.hfe_date hfe_date, ") \
		_T("                      SUM(CASE WHEN NVL(hfl_hitechmachine, 'X') = 'Y' THEN hfe_cost ELSE 0 END) AS hitechreturn, ") \
		_T("                      SUM(CASE WHEN NVL(hfl_hitechmachine, 'X') <> 'Y' THEN hfe_cost ELSE 0 END) AS eamount, ") \
		_T("                      0 AS iamount, ") \
		_T("                      0 AS deposit, ") \
		_T("                      0 AS refund") \
		_T("            FROM      hms_fee_refund rf ") \
		_T("            LEFT JOIN hms_fee_refundline rfl ON ( rf.hfe_docno = rfl.hfe_docno ") \
		_T("                                                  AND rf.hfe_invoiceno = rfl.hfe_invoiceno ) ") \
		_T("            LEFT JOIN hms_fee_list ON ( hfe_itemid = hfl_feeid ) ") \
		_T("            WHERE     rf.hfe_class IN ('E', 'X') %s") \
		_T("            GROUP     BY rf.hfe_docno, ") \
		_T("                         rf.hfe_deptid, ") \
		_T("                         rf.hfe_date ") \
		_T("			UNION ALL") \
		_T("			SELECT r.hfe_docno  AS docno, ") \
		_T("                   r.hfe_deptid AS deptid, ") \
		_T("                   r.hfe_date, ") \
		_T("				   0,") \
		_T("                   0		  AS eamount, ") \
		_T("                   0          AS iamount, ") \
		_T("                   0          AS deposit, ") \
		_T("                   r.hfe_amount AS refund ") \
		_T("            FROM   hms_fee_refund r") \
		_T("			LEFT JOIN hms_fee_deposit d ON (r.hfe_refidx = d.hfe_invoiceno)") \
		_T("            WHERE  r.hfe_class IN ( 'A', 'I' ) AND (d.hfe_status = 'R' OR r.hfe_type = 'E') %s") \
		_T("            UNION ALL ") \
		_T("            SELECT i.hfe_docno   AS docno, ") \
		_T("                   i.hfe_deptid  AS deptid, ") \
		_T("                   i.hfe_date, ") \
		_T("				   0,") \
		_T("                   0, ") \
		_T("                   i.hfe_amount, ") \
		_T("                   i.hfe_deposit, ") \
		_T("                   r.hfe_amount ") \
		_T("            FROM   hms_fee_refund r") \
		_T("			LEFT JOIN hms_fee_invoice i ON (i.hfe_docno = r.hfe_docno AND i.hfe_invoiceno = r.hfe_refidx)") \
		_T("            WHERE  r.hfe_class IN( 'A', 'I' ) AND r.hfe_type = 'F' AND i.hfe_refund > 0 %s) ") \
		_T(" LEFT JOIN hms_clinical_record ON ( hcr_docno = docno ) ") \
		_T(" LEFT JOIN hms_doc ON ( hd_docno = docno ) ") \
		_T(" WHERE     1 = 1") \
		_T(" GROUP     BY docno, ") \
		_T("              hcr_recordno, ") \
		_T("              deptid, ") \
		_T("              hfe_date ") \
		_T(" HAVING sum(hitechreturn+eamount+refund) > 0") \
		_T(" ORDER     BY hfe_date "), szRefWhere0, szRefWhere, szRefWhere);
	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		ShowMessageBox(_T("No Data"), MB_OK | MB_ICONERROR);
		return;
	}

	if (!rpt.Init(_T("Reports/HMS/HF_BANGKECHIBNDICHVU.RPT")))
		return;

	StringUpper(pMF->m_szHealthService, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), tmpStr);

	StringUpper(pMF->m_szHospitalName, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), tmpStr);

	tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("ReportDate")),
		CDateTime::Convert(m_szFromDate, yyyymmdd | hhmm, ddmmyyyy | hhmm),
		CDateTime::Convert(m_szToDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));

	rpt.GetReportHeader()->SetValue(_T("ReportDate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PaymentStr"), szPaymentStr);
	CReportSection* rptDetail;
	CString szOldLine, szNewLine;
	CStringArray arrField;
	double nTotal[6];
	double nCost;
	int nIndex = 1;

	for (int i = 0; i < 6; i++)
	{
		nTotal[i] = 0;
	}
	arrField.Add(_T("hitechreturn"));
	arrField.Add(_T("eamount"));
	arrField.Add(_T("iamount"));
	arrField.Add(_T("deposit"));
	arrField.Add(_T("refund"));
	arrField.Add(_T("totalamount"));
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();

		tmpStr.Format(_T("%d"), nIndex++);
		rptDetail->SetValue(_T("1"), tmpStr);

		rs.GetValue(_T("pname"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);

		rs.GetValue(_T("docno"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);

		rs.GetValue(_T("recordno"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);

		//rs.GetValue(_T("deptid"), tmpStr);
		//rptDetail->SetValue(_T("5"), tmpStr);

		for (int j = 0; j < 6; j++)
		{
			rs.GetValue(arrField.GetAt(j), nCost);
			nTotal[j] += nCost;
			FormatCurrency(nCost, tmpStr);
			szTemp.Format(_T("%d"), j + 5);
			rptDetail->SetValue(szTemp, tmpStr);
		}

		rs.MoveNext();
	}

	if (nTotal[5] > 0)
	{
		for (int i = 0; i < 6; i++)
		{
			FormatCurrency(nTotal[i], tmpStr);
			szTemp.Format(_T("s%d"), i + 5);
			rpt.GetReportFooter()->SetValue(szTemp, tmpStr);
		}
	}

	szSysDate = pMF->GetSysDate();    
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("User"), pMF->GetDoctorName(pMF->GetCurrentUser()));
	rpt.PrintPreview();
}

void CPrintForms::TM_OnPrintAppointmentSheet(long nDocNo, CString szDeptId, bool bPreview, bool bDirect, CString szAppointmentDate)
{
    
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
    CString szFormatAppointmentDate2;
    CString szFormatAppointmentDate = CDate(szAppointmentDate.Left(10));    

	CString year = szFormatAppointmentDate.Left(4); // "2025"
    CString month = szFormatAppointmentDate.Mid(5, 2); // "09"
    CString day = szFormatAppointmentDate.Right(2); 

    szFormatAppointmentDate2 = day + month + year + szDeptId;	
	
	CReport rpt;
    if (pMF->OnPostGenDocX(&rpt, _T("giayhen"), nDocNo, 0, _T("GIAYHEN_UT.RPT"),
                           szFormatAppointmentDate2))
		return;
	CReportSection* rptHeader;
	CRecord rs(&pMF->m_db), rsx(&pMF->m_db);
	CString szSQL, tmpStr, tmpStr2;

	if (pMF->GetModuleID() == _T("EM"))
	{
		szSQL.Format(_T(" SELECT hd_patientno as patientno, NULL record_no, ") \
			_T("	get_patientname(hd_docno) patient_name, ") \
			_T("	extract(year from hp_birthdate) yob, ") \
			_T("	to_char(hp_birthdate, 'dd/mm/yyyy') as dob,") \
			_T("   GET_SYSSEL_DESC('sys_sex', hp_sex) as sex, ") \
			_T("	get_objectname(hd_object) obj_name,") \
			_T("	NULL dischargedate,") \
			_T("	hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) address, NULL hcr_cancer, NULL hcr_cancer_time, ") \
			_T("   hc_cardno cardno, hc_regdate regdate, hc_expdate expdate, ") \
			_T("   (select distinct first_value(he_examdate) over (partition by he_docno) from hms_exam where he_docno = hd_docno) examdate, ") \
			_T("   NULL admitdate, ") \
			_T("   hd_conclusion diagnostic, hd_reldisease relationdisease,") \
			_T("   GET_APPOINTMENT_DATESTR(hd_docno, '%s') as appointmentdate") \
			_T(" FROM hms_doc") \
			_T(" LEFT JOIN hms_card ON (hc_patientno = hd_patientno AND hd_cardidx = hc_idx)") \
			_T(" LEFT JOIN hms_patient ON (hd_patientno = hp_patientno) ") \
			_T(" WHERE hd_docno = %ld")
			, pMF->GetModuleID(), nDocNo);
	}
	else if (pMF->GetModuleID() == _T("SOM") && 0 > 1)
	{
		szSQL.Format(_T(" SELECT hcr_patientno as patientno, hcr_recordno record_no, ") \
			_T("	get_patientname(hcr_docno) patient_name, ") \
			_T("	extract(year from hp_birthdate) yob, ") \
			_T("	to_char(hp_birthdate, 'dd/mm/yyyy') as dob,") \
			_T("   GET_SYSSEL_DESC('sys_sex', hp_sex) as sex, ") \
			_T("	get_objectname(hd_object) obj_name,") \
			_T("	hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) address, hcr_cancer, hcr_cancer_time, ") \
			_T("   hc_cardno cardno, hc_regdate regdate, hc_expdate expdate, ") \
			_T("   (select distinct first_value(he_examdate) over (partition by he_docno) from hms_exam where he_docno = hcr_docno) examdate, ") \

			_T("   case when NVL(hcr_cancer, 'N') = 'Y' then GET_CANCER_ADMITDATE(hcr_docno, hcr_refidx) else ") \
			_T("   (SELECT MIN(htr_admitdate) FROM hms_treatment_record WHERE htr_docno = hcr_docno AND htr_treattime = hcr_treattime) end as admitdate, ") \

			_T("   (SELECT MIN(htr_admitdate) FROM hms_treatment_record WHERE htr_docno = hcr_docno AND htr_treattime = hcr_treattime) as admitdate, ") \
			_T("	hcr_dischargedate dischargedate,") \

			/*_T("  (SELECT MAX(HRE_ADMITDATE) FROM hms_reexam WHERE hre_docno = hcr_docno") \
			_T("   ) as admitdate,") \
			_T("   ") \
			_T("   (SELECT MAX(HRE_DISCHARGEDATE) FROM hms_reexam WHERE hre_docno = hcr_docno") \
			_T("   ) as dischargedate,") \*/

			_T("   hcr_maindisease diagnostic, hcr_reldisease relationdisease, trim(hcr_gsuggestion2) y_kien_de_nghi,") \
			_T("   (select max(hre_date) from hms_reexam where hre_docno = hcr_docno) as appointmentdate_,") \
			_T("   GET_APPOINTMENT_DATESTR(hd_docno) as appointmentdate") \
			_T(" FROM hms_clinical_record ") \
			_T(" LEFT JOIN hms_doc ON (hd_docno = hcr_docno)") \
			_T(" LEFT JOIN hms_card ON (hc_patientno = hd_patientno AND hd_cardidx = hc_idx)") \
			_T(" LEFT JOIN hms_patient ON (hcr_patientno = hp_patientno) ") \
			_T(" LEFT JOIN hms_treatment_record ON (hcr_docno = htr_docno and hcr_refidx = htr_idx)") \
			_T(" WHERE hcr_docno = %ld")
			, pMF->GetModuleID(), nDocNo);
	}
	else
	{
		szSQL.Format(_T(" SELECT hcr_patientno as patientno, hcr_recordno record_no, ") \
			_T("	get_patientname(hcr_docno) patient_name, ") \
			_T("	extract(year from hp_birthdate) yob, ") \
			_T("	to_char(hp_birthdate, 'dd/mm/yyyy') as dob,") \
			_T("   GET_SYSSEL_DESC('sys_sex', hp_sex) as sex, ") \
			_T("	get_objectname(hd_object) obj_name,") \
			_T("	hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) address, hcr_cancer, hcr_cancer_time, ") \
			_T("   hc_cardno cardno, hc_regdate regdate, hc_expdate expdate, ") \
			_T("   (select distinct first_value(he_examdate) over (partition by he_docno) from hms_exam where he_docno = hcr_docno) examdate, ") \
			/*_T("   case when NVL(hcr_cancer, 'N') = 'Y' then GET_CANCER_ADMITDATE(hcr_docno, hcr_refidx) else ") \
			_T("   (SELECT MIN(htr_admitdate) FROM hms_treatment_record WHERE htr_docno = hcr_docno AND htr_treattime = hcr_treattime) end as admitdate, ") \*/

			//_T("   (SELECT MIN(htr_admitdate) FROM hms_treatment_record WHERE htr_docno = hcr_docno AND htr_treattime = hcr_treattime) as admitdate, ") \//
			//_T("	hcr_dischargedate dischargedate,") \//

			_T("  (SELECT MAX(HRE_ADMITDATE) FROM hms_reexam WHERE hre_docno = hcr_docno") \
			_T("   ) as admitdate,") \
			_T("   ") \
			_T("   (SELECT MAX(HRE_DISCHARGEDATE) FROM hms_reexam WHERE hre_docno = hcr_docno") \
			_T("   ) as dischargedate,") \

			_T("   hcr_maindisease diagnostic, hcr_reldisease relationdisease, trim(hcr_gsuggestion2) y_kien_de_nghi,") \
			_T("   (select max(hre_date) from hms_reexam where hre_docno = hcr_docno) as appointmentdate_,") \
			_T("   GET_APPOINTMENT_DATESTR(hd_docno, '%s') as appointmentdate") \
			_T(" FROM hms_clinical_record ") \
			_T(" LEFT JOIN hms_doc ON (hd_docno = hcr_docno)") \
			_T(" LEFT JOIN hms_card ON (hc_patientno = hd_patientno AND hd_cardidx = hc_idx)") \
			_T(" LEFT JOIN hms_patient ON (hcr_patientno = hp_patientno) ") \
			_T(" LEFT JOIN hms_treatment_record ON (hcr_docno = htr_docno and hcr_refidx = htr_idx)") \
			_T(" WHERE hcr_docno = %ld")
			, pMF->GetModuleID(), nDocNo);
	}

	int nRet = rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (nRet < 0)
	{
		_msg(_T("%s"), szSQL);
		return;
	}
	szSQL.Format(
		_T(" SELECT CASE WHEN hd_emergency = 'Y' THEN 'X'") \
		_T("        ELSE ''") \
		_T("        END AS capcuu,") \
		_T("        CASE WHEN hd_emergency = 'N' AND hd_insline = 'Y' and ho_type in ('I', 'C') THEN 'X'") \
		_T("        ELSE ''") \
		_T("        END AS khongdungtuyen,") \
		_T("        CASE WHEN hd_emergency = 'N' AND hd_insline = 'N' and ho_type in ('I', 'C') THEN 'X'") \
		_T("        ELSE ''") \
		_T("        END AS dungtuyen") \
		_T("   FROM hms_doc left join hms_object ON (ho_id = HD_OBJECT)") \
		_T("  WHERE hd_docno = %ld "), nDocNo);

	rsx.ExecSQL(szSQL);
	CString szCancer;
	int nCancerTime;
	rs.GetValue(_T("hcr_cancer"), szCancer);
	rs.GetValue(_T("hcr_cancer_time"), nCancerTime);



	if (szCancer == _T("Y"))
	{
		if (!rpt.Init(_T("Reports\\HMS\\GIAYHEN_UT.RPT")))
			return;
	}
	else
	{
		if (pMF->GetModuleID() == _T("TM") || pMF->GetModuleID() == _T("SOM"))
		{
			if (!rpt.Init(_T("Reports\\HMS\\GIAYHEN_UT.RPT")))
				return;
		}
		else
		{
			if (!rpt.Init(_T("Reports\\HMS\\GIAYHEN_KB.RPT")))
				return;
		}

	}

	rptHeader = rpt.GetReportHeader();
	for (int i = 0; i < rsx.GetFieldCount(); i++)
	{
		tmpStr = rsx.GetFieldName(i);
		rptHeader->SetValue(tmpStr, rsx.GetValue(tmpStr));
	}
	rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Department"), pMF->GetDepartmentName(szDeptId));
	rs.GetValue(_T("patientno"), tmpStr);
	rptHeader->SetValue(_T("patientno"), tmpStr);
	tmpStr.Format(_T("%ld"), nDocNo);
	rptHeader->SetValue(_T("documentno"), tmpStr);
	rs.GetValue(_T("record_no"), tmpStr);
	if (szCancer == _T("Y"))
	{
		tmpStr.AppendFormat(_T(" - %.3dK"), nCancerTime);
	}
	rptHeader->SetValue(_T("recordno"), tmpStr);
	rs.GetValue(_T("patient_name"), tmpStr2);
	StringUpper(tmpStr2, tmpStr);
	rptHeader->SetValue(_T("patientname"), tmpStr);
	//rptHeader->SetValue(_T("yearofbirth"), rs.GetValue(_T("yob")));
	rptHeader->SetValue(_T("yearofbirth"), rs.GetValue(_T("dob")));
	rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
	rptHeader->SetValue(_T("object"), rs.GetValue(_T("obj_name")));
	rptHeader->SetValue(_T("address"), rs.GetValue(_T("address")));
	//rptHeader->SetValue(_T("dischargedate"), CDate::Convert(rs.GetValue(_T("discharged_date")), yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("cardno"), rs.GetValue(_T("cardno")));
	tmpStr = CDate::Convert(rs.GetValue(_T("regdate")), yyyymmdd, ddmmyyyy);
	rptHeader->SetValue(_T("regdate"), tmpStr);
	tmpStr = CDate::Convert(rs.GetValue(_T("expdate")), yyyymmdd, ddmmyyyy);
	rptHeader->SetValue(_T("expdate"), tmpStr);
	tmpStr = CDate::Convert(rs.GetValue(_T("examdate")), yyyymmdd, ddmmyyyy);
	rptHeader->SetValue(_T("examdate"), tmpStr);
	tmpStr = CDate::Convert(rs.GetValue(_T("admitdate")), yyyymmdd, ddmmyyyy);
	rptHeader->SetValue(_T("admitdate"), tmpStr);
	tmpStr = CDate::Convert(rs.GetValue(_T("dischargedate")), yyyymmdd, ddmmyyyy);
	rptHeader->SetValue(_T("dischargedate"), tmpStr);
	rptHeader->SetValue(_T("diagnostic"), rs.GetValue(_T("diagnostic")));
	rptHeader->SetValue(_T("relationdisease"), rs.GetValue(_T("relationdisease")));
	_tprintf(_T("\nszAppointmentDate:%s"), szAppointmentDate);
	if (!szAppointmentDate.IsEmpty())
		tmpStr.Format(_T("ng\xE0y %s th\xE1ng %s n\x103m %s"), szAppointmentDate.Mid(8, 2), szAppointmentDate.Mid(5, 2), szAppointmentDate.Left(4));
	else
	{
		//tmpStr.Format(_T("%s"), CDate::Convert(rs.GetValue(_T("appointmentdate")), yyyymmdd, ddmmyyyy));
		tmpStr.Format(_T("%s"), rs.GetValue(_T("appointmentdate")));
	}
	if (tmpStr.IsEmpty())
		tmpStr.Format(_T("ng\xE0y ...... th\xE1ng ..... n\x103m......"));
	tmpStr2.Format(rptHeader->GetValue(_T("appointmentdate")), tmpStr);
	//tmpStr2.Format(
	//	_T("     Hẹn khám lại vào %s , hoặc đến bất kỳ thời gian nào trước ngày ") \
		//	_T(" được hẹn khám lại nếu có dấu hiệu (triệu chứng) bất thường."), tmpStr);
	rptHeader->SetValue(_T("appointmentdate"), tmpStr2);
    rptHeader->SetValue(_T("appointmentdate2"), szFormatAppointmentDate2);
	rptHeader->SetValue(_T("y_kien_de_nghi"), rs.GetValue(_T("y_kien_de_nghi")));
	CString szSysDate = pMF->GetSysDateTime();
	CString szDate;

	//szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")),szSysDate.Mid(11,5),szSysDate.Mid(8,2),szSysDate.Mid(5,2),szSysDate.Left(4));
	szDate = CDate::Convert(rs.GetValue(_T("dischargedate")), yyyymmdd, ddmmyyyy);
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("dischargedate1")), szDate.Left(2), szDate.Mid(3, 2), szDate.Mid(6, 4));
	rpt.GetReportFooter()->SetValue(_T("dischargedate1"), szDate);




	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(bDirect);


	//if (!rpt.Init(_T("Reports\\HMS\\GIAYHEN_UT_TO2.RPT")))
	//		return;
	//rpt.PrintPreview();


	if (!szAppointmentDate.IsEmpty())
	{
		if (pMF->GetModuleID() == _T("EM"))
		{

		}
		else
		{
			szSQL.Format(_T("HMS_APPOINTMENT_CREATE_V2(%d, TO_DATE('%s','YYYY-MM-DD'), %d)")
				, nDocNo, szAppointmentDate.Left(10), pMF->GetCurrentRoomID());
			pMF->ExecDML(szSQL);
		}
	}
}


void CPrintForms::TM_OnPrintAppointmentSheet_V2(long nDocNo, CString szDeptId, bool bPreview, bool bDirect, CString szAppointmentDate)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CReportSection* rptHeader;
	CRecord rs(&pMF->m_db), rsx(&pMF->m_db);
	CString szSQL, tmpStr, tmpStr2;

	if (pMF->GetModuleID() == _T("EM"))
	{
		szSQL.Format(_T(" SELECT hd_patientno as patientno, NULL record_no, ") \
			_T("	get_patientname(hd_docno) patient_name, ") \
			_T("	extract(year from hp_birthdate) yob, ") \
			_T("	to_char(hp_birthdate, 'dd/mm/yyyy') as dob,") \
			_T("   GET_SYSSEL_DESC('sys_sex', hp_sex) as sex, ") \
			_T("	get_objectname(hd_object) obj_name,") \
			_T("	NULL dischargedate,") \
			_T("	hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) address, NULL hcr_cancer, NULL hcr_cancer_time, ") \
			_T("   hc_cardno cardno, hc_regdate regdate, hc_expdate expdate, ") \
			_T("   (select distinct first_value(he_examdate) over (partition by he_docno) from hms_exam where he_docno = hd_docno) examdate, ") \
			_T("   NULL admitdate, ") \
			_T("   hd_conclusion diagnostic, hd_reldisease relationdisease,") \
			_T("   GET_APPOINTMENT_DATESTR(hd_docno, '%s') as appointmentdate") \
			_T(" FROM hms_doc") \
			_T(" LEFT JOIN hms_card ON (hc_patientno = hd_patientno AND hd_cardidx = hc_idx)") \
			_T(" LEFT JOIN hms_patient ON (hd_patientno = hp_patientno) ") \
			_T(" WHERE hd_docno = %ld")
			, pMF->GetModuleID(), nDocNo);
	}
	else if (pMF->GetModuleID() == _T("SOM") && 0 > 1)
	{
		szSQL.Format(_T(" SELECT hcr_patientno as patientno, hcr_recordno record_no, ") \
			_T("	get_patientname(hcr_docno) patient_name, ") \
			_T("	extract(year from hp_birthdate) yob, ") \
			_T("	to_char(hp_birthdate, 'dd/mm/yyyy') as dob,") \
			_T("   GET_SYSSEL_DESC('sys_sex', hp_sex) as sex, ") \
			_T("	get_objectname(hd_object) obj_name,") \
			_T("	hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) address, hcr_cancer, hcr_cancer_time, ") \
			_T("   hc_cardno cardno, hc_regdate regdate, hc_expdate expdate, ") \
			_T("   (select distinct first_value(he_examdate) over (partition by he_docno) from hms_exam where he_docno = hcr_docno) examdate, ") \

			_T("   case when NVL(hcr_cancer, 'N') = 'Y' then GET_CANCER_ADMITDATE(hcr_docno, hcr_refidx) else ") \
			_T("   (SELECT MIN(htr_admitdate) FROM hms_treatment_record WHERE htr_docno = hcr_docno AND htr_treattime = hcr_treattime) end as admitdate, ") \

			_T("   (SELECT MIN(htr_admitdate) FROM hms_treatment_record WHERE htr_docno = hcr_docno AND htr_treattime = hcr_treattime) as admitdate, ") \
			_T("	hcr_dischargedate dischargedate,") \

			/*_T("  (SELECT MAX(HRE_ADMITDATE) FROM hms_reexam WHERE hre_docno = hcr_docno") \
			_T("   ) as admitdate,") \
			_T("   ") \
			_T("   (SELECT MAX(HRE_DISCHARGEDATE) FROM hms_reexam WHERE hre_docno = hcr_docno") \
			_T("   ) as dischargedate,") \*/

			_T("   hcr_maindisease diagnostic, hcr_reldisease relationdisease, hcr_gsuggestion2 y_kien_de_nghi,") \
			_T("   (select max(hre_date) from hms_reexam where hre_docno = hcr_docno) as appointmentdate_,") \
			_T("   GET_APPOINTMENT_DATESTR(hd_docno) as appointmentdate") \
			_T(" FROM hms_clinical_record ") \
			_T(" LEFT JOIN hms_doc ON (hd_docno = hcr_docno)") \
			_T(" LEFT JOIN hms_card ON (hc_patientno = hd_patientno AND hd_cardidx = hc_idx)") \
			_T(" LEFT JOIN hms_patient ON (hcr_patientno = hp_patientno) ") \
			_T(" LEFT JOIN hms_treatment_record ON (hcr_docno = htr_docno and hcr_refidx = htr_idx)") \
			_T(" WHERE hcr_docno = %ld")
			, pMF->GetModuleID(), nDocNo);
	}
	else
	{
		szSQL.Format(_T(" SELECT hcr_patientno as patientno, hcr_recordno record_no, ") \
			_T("	get_patientname(hcr_docno) patient_name, ") \
			_T("	extract(year from hp_birthdate) yob, ") \
			_T("	to_char(hp_birthdate, 'dd/mm/yyyy') as dob,") \
			_T("   GET_SYSSEL_DESC('sys_sex', hp_sex) as sex, ") \
			_T("	get_objectname(hd_object) obj_name,") \
			_T("	hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) address, hcr_cancer, hcr_cancer_time, ") \
			_T("   hc_cardno cardno, hc_regdate regdate, hc_expdate expdate, ") \
			_T("   (select distinct first_value(he_examdate) over (partition by he_docno) from hms_exam where he_docno = hcr_docno) examdate, ") \
			/*_T("   case when NVL(hcr_cancer, 'N') = 'Y' then GET_CANCER_ADMITDATE(hcr_docno, hcr_refidx) else ") \
			_T("   (SELECT MIN(htr_admitdate) FROM hms_treatment_record WHERE htr_docno = hcr_docno AND htr_treattime = hcr_treattime) end as admitdate, ") \*/

			//_T("   (SELECT MIN(htr_admitdate) FROM hms_treatment_record WHERE htr_docno = hcr_docno AND htr_treattime = hcr_treattime) as admitdate, ") \//
			//_T("	hcr_dischargedate dischargedate,") \//

			_T("  (SELECT MAX(HRE_ADMITDATE) FROM hms_reexam WHERE hre_docno = hcr_docno") \
			_T("   ) as admitdate,") \
			_T("   ") \
			_T("   (SELECT MAX(HRE_DISCHARGEDATE) FROM hms_reexam WHERE hre_docno = hcr_docno") \
			_T("   ) as dischargedate,") \

			_T("   hcr_maindisease diagnostic, hcr_reldisease relationdisease, hcr_gsuggestion2 y_kien_de_nghi,") \
			_T("   (select max(hre_date) from hms_reexam where hre_docno = hcr_docno) as appointmentdate_,") \
			_T("   GET_APPOINTMENT_DATESTR(hd_docno, '%s') as appointmentdate") \
			_T(" FROM hms_clinical_record ") \
			_T(" LEFT JOIN hms_doc ON (hd_docno = hcr_docno)") \
			_T(" LEFT JOIN hms_card ON (hc_patientno = hd_patientno AND hd_cardidx = hc_idx)") \
			_T(" LEFT JOIN hms_patient ON (hcr_patientno = hp_patientno) ") \
			_T(" LEFT JOIN hms_treatment_record ON (hcr_docno = htr_docno and hcr_refidx = htr_idx)") \
			_T(" WHERE hcr_docno = %ld")
			, pMF->GetModuleID(), nDocNo);
	}

	int nRet = rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (nRet < 0)
	{
		_msg(_T("%s"), szSQL);
		return;
	}
	szSQL.Format(
		_T(" SELECT CASE WHEN hd_emergency = 'Y' THEN 'X'") \
		_T("        ELSE ''") \
		_T("        END AS capcuu,") \
		_T("        CASE WHEN hd_emergency = 'N' AND hd_insline = 'Y' and ho_type in ('I', 'C') THEN 'X'") \
		_T("        ELSE ''") \
		_T("        END AS khongdungtuyen,") \
		_T("        CASE WHEN hd_emergency = 'N' AND hd_insline = 'N' and ho_type in ('I', 'C') THEN 'X'") \
		_T("        ELSE ''") \
		_T("        END AS dungtuyen") \
		_T("   FROM hms_doc left join hms_object ON (ho_id = HD_OBJECT)") \
		_T("  WHERE hd_docno = %ld "), nDocNo);

	rsx.ExecSQL(szSQL);
	CString szCancer;
	int nCancerTime;
	rs.GetValue(_T("hcr_cancer"), szCancer);
	rs.GetValue(_T("hcr_cancer_time"), nCancerTime);



	if (szCancer == _T("Y"))
	{
		if (!rpt.Init(_T("Reports\\HMS\\GIAYHEN_UT_TO1.RPT")))
			return;
	}
	else
	{
		if (pMF->GetModuleID() == _T("TM") || pMF->GetModuleID() == _T("SOM"))
		{
			if (!rpt.Init(_T("Reports\\HMS\\GIAYHEN_UT_TO1.RPT")))
				return;
		}
		else
		{
			if (!rpt.Init(_T("Reports\\HMS\\GIAYHEN_KB.RPT")))
				return;
		}

	}

	rptHeader = rpt.GetReportHeader();
	for (int i = 0; i < rsx.GetFieldCount(); i++)
	{
		tmpStr = rsx.GetFieldName(i);
		rptHeader->SetValue(tmpStr, rsx.GetValue(tmpStr));
	}
	rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Department"), pMF->GetDepartmentName(szDeptId));
	rs.GetValue(_T("patientno"), tmpStr);
	rptHeader->SetValue(_T("patientno"), tmpStr);
	tmpStr.Format(_T("%ld"), nDocNo);
	rptHeader->SetValue(_T("documentno"), tmpStr);
	rs.GetValue(_T("record_no"), tmpStr);
	if (szCancer == _T("Y"))
	{
		tmpStr.AppendFormat(_T(" - %.3dK"), nCancerTime);
	}
	rptHeader->SetValue(_T("recordno"), tmpStr);
	rs.GetValue(_T("patient_name"), tmpStr2);
	StringUpper(tmpStr2, tmpStr);
	rptHeader->SetValue(_T("patientname"), tmpStr);
	//rptHeader->SetValue(_T("yearofbirth"), rs.GetValue(_T("yob")));
	rptHeader->SetValue(_T("yearofbirth"), rs.GetValue(_T("dob")));
	rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
	rptHeader->SetValue(_T("object"), rs.GetValue(_T("obj_name")));
	rptHeader->SetValue(_T("address"), rs.GetValue(_T("address")));
	//rptHeader->SetValue(_T("dischargedate"), CDate::Convert(rs.GetValue(_T("discharged_date")), yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("cardno"), rs.GetValue(_T("cardno")));
	tmpStr = CDate::Convert(rs.GetValue(_T("regdate")), yyyymmdd, ddmmyyyy);
	rptHeader->SetValue(_T("regdate"), tmpStr);
	tmpStr = CDate::Convert(rs.GetValue(_T("expdate")), yyyymmdd, ddmmyyyy);
	rptHeader->SetValue(_T("expdate"), tmpStr);
	tmpStr = CDate::Convert(rs.GetValue(_T("examdate")), yyyymmdd, ddmmyyyy);
	rptHeader->SetValue(_T("examdate"), tmpStr);
	tmpStr = CDate::Convert(rs.GetValue(_T("admitdate")), yyyymmdd, ddmmyyyy);
	rptHeader->SetValue(_T("admitdate"), tmpStr);
	tmpStr = CDate::Convert(rs.GetValue(_T("dischargedate")), yyyymmdd, ddmmyyyy);
	rptHeader->SetValue(_T("dischargedate"), tmpStr);
	rptHeader->SetValue(_T("diagnostic"), rs.GetValue(_T("diagnostic")));
	rptHeader->SetValue(_T("relationdisease"), rs.GetValue(_T("relationdisease")));
	_tprintf(_T("\nszAppointmentDate:%s"), szAppointmentDate);
	if (!szAppointmentDate.IsEmpty())
		tmpStr.Format(_T("ng\xE0y %s th\xE1ng %s n\x103m %s"), szAppointmentDate.Mid(8, 2), szAppointmentDate.Mid(5, 2), szAppointmentDate.Left(4));
	else
	{
		//tmpStr.Format(_T("%s"), CDate::Convert(rs.GetValue(_T("appointmentdate")), yyyymmdd, ddmmyyyy));
		tmpStr.Format(_T("%s"), rs.GetValue(_T("appointmentdate")));
	}
	if (tmpStr.IsEmpty())
		tmpStr.Format(_T("ng\xE0y ...... th\xE1ng ..... n\x103m......"));
	tmpStr2.Format(rptHeader->GetValue(_T("appointmentdate")), tmpStr);
	//tmpStr2.Format(
	//	_T("     Hẹn khám lại vào %s , hoặc đến bất kỳ thời gian nào trước ngày ") \
		//	_T(" được hẹn khám lại nếu có dấu hiệu (triệu chứng) bất thường."), tmpStr);
	rptHeader->SetValue(_T("appointmentdate"), tmpStr2);
	rptHeader->SetValue(_T("y_kien_de_nghi"), rs.GetValue(_T("y_kien_de_nghi")));
	CString szSysDate = pMF->GetSysDateTime();
	CString szDate;

	//szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")),szSysDate.Mid(11,5),szSysDate.Mid(8,2),szSysDate.Mid(5,2),szSysDate.Left(4));
	szDate = CDate::Convert(rs.GetValue(_T("dischargedate")), yyyymmdd, ddmmyyyy);
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("dischargedate1")), szDate.Left(2), szDate.Mid(3, 2), szDate.Mid(6, 4));
	rpt.GetReportFooter()->SetValue(_T("dischargedate1"), szDate);




	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(bDirect);


	if (!rpt.Init(_T("Reports\\HMS\\GIAYHEN_UT_TO2.RPT")))
		return;
	rpt.PrintPreview();


	if (!szAppointmentDate.IsEmpty())
	{
		if (pMF->GetModuleID() == _T("EM"))
		{

		}
		else
		{
			szSQL.Format(_T("HMS_APPOINTMENT_CREATE_V2(%d, TO_DATE('%s','YYYY-MM-DD'), %d)")
				, nDocNo, szAppointmentDate.Left(10), pMF->GetCurrentRoomID());
			pMF->ExecDML(szSQL);
		}
	}
}


void CPrintForms::PrintHMSAppointmentScheduleSheet(long nDocumentNo, long nOrderId)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptHeader = NULL;
	CString szSQL, szFilePath, tmpStr;
	szFilePath.Format(_T("Reports\\HMS\\GIAYHEN_TYC.RPT"));
	if (!rpt.Init(szFilePath))
	{
		return;
	}
	rptHeader = rpt.GetReportHeader();
	szSQL.Format(_T(" SELECT '%s' as hospitalname, '%s' as department, ") \
		_T("	hd_docno as documentno,") \
		_T("	hd_patientno as patientno, ") \
		_T("	get_patientname(hd_docno) patientname, ") \
		_T("	extract(year from hp_birthdate) yearofbirth, ") \
		_T("    GET_SYSSEL_DESC('sys_sex', hp_sex) as sex, ") \
		_T("	hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) address, ") \
		_T("   HD_CONCLUSION diagnostic, to_char(appointment_date, 'hh24:mi dd/mm/yyyy') as appointtime, note as content, HD_TELEPHONE as mobile ") \
		_T(" FROM hms_doc ") \
		_T(" LEFT JOIN hms_patient ON (hd_patientno = hp_patientno) ") \
		_T(" LEFT JOIN HMS_APPOINTMENT_SCHEDULE ON (hd_docno = docno AND HMS_APPOINTMENT_ID = %ld)") \
		_T(" WHERE hd_docno = %ld"), pMF->m_CompanyInfo.sc_name, pMF->GetCurrentDepartmentName(), nOrderId, nDocumentNo);
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
	{
		ShowMessageBox(_T("No Data."));
		return;
	}
	for (int i = 0; i < rs.GetFieldCount(); i++)
	{
		rptHeader->SetValue(rs.GetFieldName(i), rs.GetValue(i));
	}
	rs.GetValue(_T("documentno"), tmpStr);
	rptHeader->SetValue(_T("Barcode[128A]"), tmpStr);
	rptHeader->SetValue(_T("Barcode[128B]"), tmpStr);
	rptHeader->SetValue(_T("Barcode[128C]"), tmpStr);
	rptHeader->SetValue(_T("Barcode[39]"), tmpStr);
	rptHeader->SetValue(_T("Barcode[93]"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Printdate"), FormatPrintDate());
	rpt.PrintPreview();
}

CString CPrintForms::FormatPrintDate(bool bHaveTime)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CString szPrintDate, szSysDate = pMF->GetSysDate(), szSysTime = pMF->GetSysTime(), tmpStr;
	_tprintf(_T("\nszSysTime: %s"), szSysTime);
	szPrintDate.Empty();
	if (bHaveTime)
	{
		szPrintDate.Format(_T("%s, "), szSysTime);
	}
	tmpStr.Format(_T("Ngày %s tháng %s năm %s"), szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	szPrintDate += tmpStr;
	return szPrintDate;
}

void CPrintForms::TM_OnPrintOperationMinutes(long nOrderID) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString szSQL, tmpStr;
	CRecord rs(&pMF->m_db);
	CString szDate, szSysDate, szAdmit, szPerformDate, szDiagnostic, szReportName, szPath;
	szSysDate = pMF->GetSysDateTime();
	bool bRet = false;
	CString szId = _T("phieuphauthuat"), szItemID = _T("");
	szReportName = _T("HMS_OPERATIONSHEET.RPT");
	bRet = pMF->OnPostGenDocX(&rpt, szId, pMF->m_nDocumentNo, nOrderID, szReportName, szItemID);
	if (bRet)
	{
		return;
	}
	if (pMF->GetModuleID() == _T("EM") && !pMF->CheckPermission(_T("04.04")))
	{
		ShowMessageBox(_T("Permission Denined."), 0);
		return;
	}

	if (pMF->GetModuleID() == _T("TM") && !pMF->CheckPermission(_T("06.04")))
	{
		ShowMessageBox(_T("Permission Denined."), 0);
		return;
	}

	if (pMF->GetCurrentRoomID() == 52 || pMF->GetCurrentDepartmentID() == _T("B10"))
	{
		szDiagnostic.Format(_T(" (SELECT he_diagnostic FROM hms_exam WHERE he_docno = hd_docno AND he_deptid = 'C1.1' AND he_roomid = 52 AND rownum = 1) as Diagnostic, "));
	}
	else
	{
		szDiagnostic.Format(_T(" hd_diagnostic as Diagnostic, "));
	}

	szSQL.Format(_T(" SELECT 	hd_docno as docno,") \
		_T("  UPPER(trim(hp_surname||' '||hp_midname||' '||hp_firstname)) as PatientName,") \
		_T("  trunc_date(hp_birthdate) as birthdate,") \
		_T("  hms_getage(trunc_date(hd_admitdate), hp_birthdate) as Age,") \
		_T("  hp_sex as sexid,") \
		_T("  sys_sel_getname('sys_sex', hp_sex) as Sex,") \
		_T("  ho_deptid as deptid,") \
		_T("  ho_roomid as roomid,") \
		_T("  ho_bedid as bedid,") \
		_T("  (select sd_name from sys_dept where sd_id=ho_deptid) as Department,") \
		_T("  hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) as address,") \
		_T("  hd_cardno as cardno,") \
		_T("  hd_cardidx as cardidx, ") \
		_T("  hc_expdate as expdate,") \
		_T("  hd_admitdate as admitdate, ") \
		_T("  ho_beforeopera  as  BeforeOpera, ho_afteropera  as  AfterOpera, ") \
		_T("  ho_performdate as PerformDate,") \
		_T("  ho_practitioner as practitioner, ho_assistant as assistant,") \
		_T("  ho_anesthetist as anesthetist, %s") \
		_T("  CASE WHEN ho_anes_method IS NOT NULL THEN (SELECT ham_name FROM hms_anesthesia_method WHERE ham_idx = ho_anes_method") \
		_T("  ) ELSE ho_inmethod END AS InMethod, ") \
		_T("  ho_itemid as itemid, ho_diagnostic,") \
		_T("  hfl_name as operationname, ") \
		_T("  (SELECT hfg_name FROM hms_fee_group WHERE hfg_id = hfl_groupid) AS operationtype,") \
		_T("  Get_objectname(hd_object) AS objname ") \
		_T("  FROM hms_operation") \
		_T("  RIGHT JOIN hms_patient ON(hp_patientno=ho_patientno)") \
		_T("  RIGHT JOIN hms_doc on (hd_docno=ho_docno) ") \
		_T("  LEFT JOIN hms_card ON (hd_patientno=hc_patientno AND hd_cardno = hc_cardno AND hd_cardidx=hc_idx)") \
		_T("  LEFT JOIN hms_fee_list ON(hfl_feeid=ho_itemid)") \
		_T("  WHERE ho_idx=%ld"), szDiagnostic, nOrderID);
	int ret = rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		ShowMessageBox(_T("Patient not found"));
		return;
	}
	szReportName = _T("HMS_OPERATIONSHEET");

	if (pMF->GetCurrentRoomID() == 52 || pMF->GetCurrentDepartmentID() == _T("B10"))
	{
		szReportName = _T("HMS_OPERATIONSHEETB10");
	}
	else if (pMF->GetModuleID() == _T("IVF") || pMF->GetCurrentDepartmentID() == _T("TTHTSS"))
	{
		szReportName = _T("IVF_OPERATIONSHEET");
	}
	szPath.Format(_T("Reports/HMS/%s.RPT"), szReportName);
	if (!rpt.Init(szPath))
		return;
	//Report Header

	//StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HEALTH_SERVICE"), pMF->m_CompanyInfo.sc_pname);
	//StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HOSPITAL_NAME"), pMF->m_CompanyInfo.sc_name);
	rs.GetValue(_T("docno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("docno"), tmpStr);
	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("orderid"), tmpStr);

	rs.GetValue(_T("PatientName"), tmpStr); //benh nhan
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), tmpStr);
	rs.GetValue(_T("Age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	rs.GetValue(_T("Sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);

	rs.GetValue(_T("CardNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	rs.GetValue(_T("InMethod"), tmpStr);// pp vo cam
	rpt.GetReportHeader()->SetValue(_T("InMethod"), tmpStr);
	rs.GetValue(_T("ExpDate"), tmpStr);// ngay het han
	rpt.GetReportHeader()->SetValue(_T("ExpDate"), CDate::Convert(rs.GetValue(_T("ExpDate")), yyyymmdd, ddmmyyyy));
	rs.GetValue(_T("Practitioner"), tmpStr);// bac sy phau thuat
	rpt.GetReportHeader()->SetValue(_T("Practitioner"), pMF->GetDoctorName(tmpStr));
	rs.GetValue(_T("Assistant"), tmpStr);// thu thuat vien
	rpt.GetReportHeader()->SetValue(_T("Assistant"), pMF->GetDoctorName(tmpStr));
	rs.GetValue(_T("Anesthetist"), tmpStr);//bac sy gay me
	rpt.GetReportHeader()->SetValue(_T("Anesthetist"), pMF->GetDoctorName(tmpStr));
	rs.GetValue(_T("address"), tmpStr);//dia chi
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);
	rs.GetValue(_T("Department"), tmpStr);//khoa
	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
	rs.GetValue(_T("roomid"), tmpStr);// ten phong
	rpt.GetReportHeader()->SetValue(_T("Room"), tmpStr);
	rs.GetValue(_T("bedid"), tmpStr);//giuong
	rpt.GetReportHeader()->SetValue(_T("Bed"), tmpStr);
	rs.GetValue(_T("objname"), tmpStr);//doituong
	rpt.GetReportHeader()->SetValue(_T("object"), tmpStr);

	tmpStr = rpt.GetReportHeader()->GetValue(_T("AdmitDate"));
	rs.GetValue(_T("AdmitDate"), szAdmit);// vao khoa luc			
	szAdmit.Format(tmpStr, szAdmit.Mid(11, 2), szAdmit.Mid(14, 2), CDate::Convert(szAdmit.Left(10), yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("AdmitDate"), szAdmit);//

	tmpStr = rpt.GetReportHeader()->GetValue(_T("PerformDate"));
	rs.GetValue(_T("PerformDate"), szPerformDate);// thuc hien luc		
	szDate.Format(tmpStr, szPerformDate.Mid(11, 2), szPerformDate.Mid(14, 2), CDate::Convert(szPerformDate.Left(10), yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("PerformDate"), szDate);//
	rs.GetValue(_T("Diagnostic"), tmpStr);// chan doan
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	rs.GetValue(_T("BeforeOpera"), tmpStr);// truoc phau thuat thu thuat
	rpt.GetReportHeader()->SetValue(_T("BeforeOpera"), tmpStr);
	rs.GetValue(_T("AfterOpera"), tmpStr);// sau phau thuat thu thuat
	rpt.GetReportHeader()->SetValue(_T("AfterOpera"), tmpStr);
	rs.GetValue(_T("operationname"), tmpStr);// phuong phap phau thuat thu thuat
	rpt.GetReportHeader()->SetValue(_T("OperationName"), tmpStr);
	rs.GetValue(_T("operationtype"), tmpStr);// loai phau thuat thu thuat
	rpt.GetReportHeader()->SetValue(_T("OperationType"), tmpStr);

	//Page Header
	//Report Detail
	CReportSection* rptDetail = rpt.GetDetail(0);

	//Page Footer
	//Report Footer

	if (pMF->GetCurrentRoomID() == 52 || pMF->GetCurrentDepartmentID() == _T("B10"))
	{
		rs.GetValue(_T("Practitioner"), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("Assistant"), pMF->GetDoctorName(tmpStr));
		szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szPerformDate.Mid(11, 5), szPerformDate.Mid(8, 2), szPerformDate.Mid(5, 2), szPerformDate.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	}
	else
	{
		rs.GetValue(_T("Assistant"), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("Assistant"), pMF->GetDoctorName(tmpStr));
		szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Mid(11, 5), szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	}

	rpt.GetReportFooter()->SetValue(_T("LDphauthuat_thuthuat"), rs.GetValue(_T("ho_diagnostic")));
	rpt.PrintPreview();

}

void CPrintForms::TM_OnPrintOperationIVF(long nOrderID)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString szSQL, tmpStr, szivffree;
	int nivffree = 0;
	CRecord rs(&pMF->m_db);
	CString szDate, szSysDate, szAdmit, szPerformDate, szDiagnostic;
	szSysDate = pMF->GetSysDateTime();
	bool bRet = false;
	CString szId = _T("phieuyeucaupttt_108"), szItemID = _T("");
	CString szReportName = _T("HMS_OPERATIONSHEETIVF.RPT");
	bRet = pMF->OnPostGenDocX(&rpt, szId, pMF->m_nDocumentNo, nOrderID, szReportName, szItemID);
	if (bRet)
	{
		return;
	}
	CString szFilePath;
	szFilePath.Format(_T("Reports/HMS/%s"), szReportName);
	szDiagnostic.Format(_T(" hd_diagnostic as Diagnostic, "));


	szSQL.Format(_T(" SELECT 	hd_docno as docno, 'P' || '' ||hd_patientno as patno,") \
		_T("  UPPER(trim(hp_surname||' '||hp_midname||' '||hp_firstname)) as PatientName,") \
		_T("  trunc_date(hp_birthdate) as birthdate,") \
		_T("  hms_getage(trunc_date(hd_admitdate), hp_birthdate) as Age,") \
		_T("  extract(year from hp_birthdate) yob,") \
		_T("  hp_sex as sexid,") \
		_T("  sys_sel_getname('sys_sex', hp_sex) as Sex,") \
		_T("  ho_deptid as deptid,") \
		_T("  ho_roomid as roomid,") \
		_T("  ho_bedid as bedid,") \
		_T("  (select sd_name from sys_dept where sd_id=ho_deptid) as Department,") \
		_T("  hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) as address,") \
		_T("  hd_cardno as cardno,") \
		_T("  hd_cardidx as cardidx, ") \
		_T("  hc_expdate as expdate,") \
		_T("  hd_admitdate as admitdate, ") \
		_T("  ho_beforeopera  as  BeforeOpera, ho_afteropera  as  AfterOpera, ") \
		_T("  ho_performdate as PerformDate,") \
		_T("  ho_practitioner as practitioner, ho_assistant as assistant,") \
		_T("  ho_anesthetist as anesthetist, %s") \
		_T("  CASE WHEN ho_anes_method IS NOT NULL THEN (SELECT ham_name FROM hms_anesthesia_method WHERE ham_idx = ho_anes_method") \
		_T("  ) ELSE ho_inmethod END AS InMethod, ") \
		_T("  ho_itemid as itemid, ho_diagnostic,") \
		_T("  ho_idx||'-'||hfl_name as operationname, ") \
		_T("  (SELECT hfg_name FROM hms_fee_group WHERE hfg_id = hfl_groupid) AS operationtype,") \
		_T("  Get_objectname(hd_object) AS objname,IVF_ISDISCOUNT,IVF_GIAYGIOITHIEU, HO_ISIVFFREE,  DC_PERCENTAGE ") \
		_T("  FROM hms_operation") \
		_T("  RIGHT JOIN hms_patient ON(hp_patientno=ho_patientno)") \
		_T("  RIGHT JOIN hms_doc on (hd_docno=ho_docno) ") \
		_T("  LEFT JOIN RM_IVF_DISCOUNT_INFOR ON(hd_docno=IVF_DOCNO)") \
		_T("  LEFT JOIN hms_card ON (hd_patientno=hc_patientno AND hd_cardno = hc_cardno AND hd_cardidx=hc_idx)") \
		_T("  LEFT JOIN hms_fee_list ON(hfl_feeid=ho_itemid)") \
		_T("  LEFT JOIN M_DISCOUNT_FEE_LIST ON (HO_ITEMID = dc_code)  ") \
		_T("  WHERE ho_idx=%ld"), szDiagnostic, nOrderID);
	int ret = rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	if (rs.IsEOF())
	{
		ShowMessageBox(_T("Patient not found"));
		return;
	}

	if (!rpt.Init(szFilePath))
		return;
	//Report Header

//StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HEALTH_SERVICE"), pMF->m_CompanyInfo.sc_pname);
	//StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HOSPITAL_NAME"), pMF->m_CompanyInfo.sc_name);
	rs.GetValue(_T("docno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("docno"), tmpStr);

	rs.GetValue(_T("patno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("patno"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("patno2"), tmpStr);

	rpt.GetReportFooter()->SetValue(_T("Barcode2[128A]"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Barcode2[128B]"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Barcode2[128C]"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Barcode2[39]"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Barcode2[93]"), tmpStr);



	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("orderid"), tmpStr);

	rs.GetValue(_T("PatientName"), tmpStr); //benh nhan
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), tmpStr);
	rs.GetValue(_T("Age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	rs.GetValue(_T("Sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);

	rs.GetValue(_T("yob"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("yearofbirth"), tmpStr);

	rs.GetValue(_T("CardNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	rs.GetValue(_T("InMethod"), tmpStr);// pp vo cam
	rpt.GetReportHeader()->SetValue(_T("InMethod"), tmpStr);
	rs.GetValue(_T("ExpDate"), tmpStr);// ngay het han
	rpt.GetReportHeader()->SetValue(_T("ExpDate"), CDate::Convert(rs.GetValue(_T("ExpDate")), yyyymmdd, ddmmyyyy));
	rs.GetValue(_T("Practitioner"), tmpStr);// bac sy phau thuat
	rpt.GetReportHeader()->SetValue(_T("Practitioner"), pMF->GetDoctorName(tmpStr));
	rs.GetValue(_T("Assistant"), tmpStr);// thu thuat vien
	rpt.GetReportHeader()->SetValue(_T("Assistant"), pMF->GetDoctorName(tmpStr));
	rs.GetValue(_T("Anesthetist"), tmpStr);//bac sy gay me
	rpt.GetReportHeader()->SetValue(_T("Anesthetist"), pMF->GetDoctorName(tmpStr));
	rs.GetValue(_T("address"), tmpStr);//dia chi
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);
	rs.GetValue(_T("Department"), tmpStr);//khoa
	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
	rs.GetValue(_T("roomid"), tmpStr);// ten phong
	rpt.GetReportHeader()->SetValue(_T("Room"), tmpStr);
	rs.GetValue(_T("bedid"), tmpStr);//giuong
	rpt.GetReportHeader()->SetValue(_T("Bed"), tmpStr);
	rs.GetValue(_T("objname"), tmpStr);//doituong
	rpt.GetReportHeader()->SetValue(_T("object"), tmpStr);

	tmpStr = rpt.GetReportHeader()->GetValue(_T("AdmitDate"));
	rs.GetValue(_T("AdmitDate"), szAdmit);// vao khoa luc			
	szAdmit.Format(tmpStr, szAdmit.Mid(11, 2), szAdmit.Mid(14, 2), CDate::Convert(szAdmit.Left(10), yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("AdmitDate"), szAdmit);//

	tmpStr = rpt.GetReportHeader()->GetValue(_T("PerformDate"));
	rs.GetValue(_T("PerformDate"), szPerformDate);// thuc hien luc		
	szDate.Format(tmpStr, szPerformDate.Mid(11, 2), szPerformDate.Mid(14, 2), CDate::Convert(szPerformDate.Left(10), yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("PerformDate"), szDate);//
	rs.GetValue(_T("Diagnostic"), tmpStr);// chan doan
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	rs.GetValue(_T("BeforeOpera"), tmpStr);// truoc phau thuat thu thuat
	rpt.GetReportHeader()->SetValue(_T("BeforeOpera"), tmpStr);
	rs.GetValue(_T("AfterOpera"), tmpStr);// sau phau thuat thu thuat
	rpt.GetReportHeader()->SetValue(_T("AfterOpera"), tmpStr);

	rs.GetValue(_T("HO_ISIVFFREE"), szivffree);
	rs.GetValue(_T("DC_PERCENTAGE"), nivffree);

	rs.GetValue(_T("operationname"), tmpStr);// phuong phap phau thuat thu thuat
	if (szivffree == _T('Y') && nivffree > 0)
	{
		tmpStr.AppendFormat(_T("(Được miễn giảm)"));
	}
	rpt.GetReportHeader()->SetValue(_T("OperationName"), tmpStr);


	rs.GetValue(_T("operationtype"), tmpStr);// loai phau thuat thu thuat
	rpt.GetReportHeader()->SetValue(_T("OperationType"), tmpStr);

	CString szIsDiscount, szGiayGioiThieu, tmpggt;
	rs.GetValue(_T("IVF_ISDISCOUNT"), szIsDiscount);
	rs.GetValue(_T("IVF_GIAYGIOITHIEU"), tmpggt);
	szGiayGioiThieu.AppendFormat(_T("Số quyết định: - %s"), tmpggt);
	//_msg(_T("%s"), szGiayGioiThieu);
	if (szIsDiscount == _T("1"))
	{
		rpt.GetReportHeader()->SetValue(_T("DiscountIVF"), _T("Ghi chú: Đối tượng được miễn giảm"));
		rpt.GetReportHeader()->SetValue(_T("SoQuyetDinh"), szGiayGioiThieu);
	}

	//Page Header
	//Report Detail
	CReportSection* rptDetail = rpt.GetDetail(0);

	//Page Footer
	//Report Footer

	if (pMF->GetCurrentRoomID() == 52 || pMF->GetCurrentDepartmentID() == _T("B10"))
	{
		rs.GetValue(_T("Practitioner"), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("Assistant"), pMF->GetDoctorName(tmpStr));
		szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szPerformDate.Mid(11, 5), szPerformDate.Mid(8, 2), szPerformDate.Mid(5, 2), szPerformDate.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	}
	else
	{
		rs.GetValue(_T("Assistant"), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("Assistant"), pMF->GetDoctorName(tmpStr));
		szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Mid(11, 5), szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	}

	rpt.GetReportFooter()->SetValue(_T("LDphauthuat_thuthuat"), rs.GetValue(_T("ho_diagnostic")));
	rpt.PrintPreview();

}

void CPrintForms::TM_OnPrintOperationSheet(long nOrderID) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CReportSection* rptHeader = NULL;
	CString szSQL, tmpStr;
	CRecord rs(&pMF->m_db);
	CRecord rs1(&pMF->m_db);
	CString szDate, szSysDate, szPerformDate;
	szSysDate = pMF->GetSysDateTime();


	if (pMF->GetModuleID() == _T("EM") && !pMF->CheckPermission(_T("04.04")))
	{
		ShowMessageBox(_T("Permission Denined."), 0);
		return;
	}

	if (pMF->GetModuleID() == _T("TM") && !pMF->CheckPermission(_T("06.04")))
	{
		ShowMessageBox(_T("Permission Denined."), 0);
		return;
	}
	if (pMF->OnPostGenDocX(&rpt, _T("phieumo_108"), pMF->m_nDocumentNo, nOrderID, _T("HMS_OPERATIONSHEET2"), _T("")))
	{
		return;
	}

	szSQL.Format(_T(" SELECT   hd_docno AS docno, ") \
		_T("           Trim(hp_surname||' '||hp_midname||' '||hp_firstname) AS PatientName, ") \
		_T("           Trunc_date(hp_birthdate) AS birthdate, ") \
		_T("           Hms_getage(Trunc_date(hd_admitdate), hp_birthdate) AS Age, ") \
		_T("           Sys_sel_getname('sys_sex', hp_sex) AS Sex, ") \
		_T("           ho_deptid AS deptid, ") \
		_T("           (SELECT sd_name FROM sys_dept WHERE  sd_id = ho_deptid)AS Department, ") \
		_T("           hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid))    AS address, ") \
		_T("           hcr_admitdate AS admitdate, ") \
		_T("           ho_performdate AS PerformDate, ") \
		_T("           ho_practitioner AS practitioner, ") \
		_T("           ho_assistant AS assistant, ") \
		_T("           ho_anesthetist AS anesthetist, ") \
		_T("           ho_diagnostic AS Diagnostic, ") \
		_T("           CASE WHEN ho_anes_method IS NOT NULL THEN (SELECT ham_name FROM hms_anesthesia_method WHERE ham_idx = ho_anes_method") \
		_T("           ) ELSE ho_inmethod END AS InMethod, ") \
		_T("           CASE WHEN length(ho_comment) > 0 THEN ho_comment ELSE hfl_name END AS operationname, ") \
		_T("           hcr_recordno record_no, ") \
		_T("           Extract (year FROM hp_birthdate) yob, ") \
		_T("           Get_objectname(hd_object) obj_name, ") \
		_T("           Get_syssel_desc('sys_occupation', hp_occupation) occupation, ") \
		_T("           hcr_dischargedate discharge_date, ") \
		_T("           hcr_reason reason ") \
		_T(" FROM      hms_operation ") \
		_T(" LEFT JOIN hms_clinical_record ON ( hcr_docno = ho_docno ) ") \
		_T(" LEFT JOIN hms_patient ON( hp_patientno = ho_patientno ) ") \
		_T(" LEFT JOIN hms_doc ON ( hd_docno = ho_docno ) ") \
		_T(" LEFT JOIN hms_fee_list ON ( hfl_feeid = ho_itemid ) ") \
		_T(" WHERE     ho_idx =% ld "), nOrderID);

	int ret = rs.ExecSQL(szSQL);


	if (rs.IsEOF())
	{
		ShowMessageBox(_T("Patient not found."));
		return;
	}

	if (pMF->GetCurrentDepartmentID() == _T("TMNT"))
	{
		if (!rpt.Init(_T("Reports/HMS/HMS_OPERATIONSHEET3.RPT")))
			return;
	}
	else
	{
		if (!rpt.Init(_T("Reports/HMS/HMS_OPERATIONSHEET2.RPT")))
			return;
	}
	//Report Header
	rptHeader = rpt.GetReportHeader();
	//StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rptHeader->SetValue(_T("HEALTH_SERVICE"), pMF->m_CompanyInfo.sc_pname);
	//StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rptHeader->SetValue(_T("HOSPITAL_NAME"), pMF->m_CompanyInfo.sc_name);
	rptHeader->SetValue(_T("docno"), rs.GetValue(_T("docno")));
	rptHeader->SetValue(_T("recordno"), rs.GetValue(_T("record_no")));
    rptHeader->SetValue(_T("orderid"), nOrderID);

	StringUpper(rs.GetValue(_T("PatientName")), tmpStr);
	rptHeader->SetValue(_T("PATIENTNAME"), tmpStr);
	rptHeader->SetValue(_T("Age"), rs.GetValue(_T("yob")));
	rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
	rptHeader->SetValue(_T("object"), rs.GetValue(_T("obj_name")));
	rptHeader->SetValue(_T("occupation"), rs.GetValue(_T("occupation")));
	rptHeader->SetValue(_T("Practitioner"), pMF->GetDoctorName(rs.GetValue(_T("practitioner"))));
	rptHeader->SetValue(_T("Address"), rs.GetValue(_T("address")));
	rptHeader->SetValue(_T("Department"), rs.GetValue(_T("Department")));

	rs.GetValue(_T("AdmitDate"), szDate);
	if (pMF->m_nTreatTime > 1)
	{
		szSQL.Format(_T("SELECT min(htr_admitdate) as tAmitdate from hms_treatment_record  where htr_docno= %s and htr_treattime =%d "), rs.GetValue(_T("docno")), pMF->m_nTreatTime);
		rs1.ExecSQL(szSQL);
		if (!rs1.IsEOF())
			rs1.GetValue(_T("tAmitdate"), szDate);
	}
	tmpStr.Format(rptHeader->GetValue(_T("admitdate")), szDate.Mid(11, 2), szDate.Mid(14, 2)
		, CDate::Convert(szDate, yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("AdmitDate"), tmpStr);
	rs.GetValue(_T("Discharge_date"), szDate);
	tmpStr.Format(rptHeader->GetValue(_T("DischargeDate")), szDate.Mid(11, 2), szDate.Mid(14, 2),
		CDate::Convert(szDate, yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("DischargeDate"), tmpStr);
	rs.GetValue(_T("PerformDate"), szDate);
	rptHeader->SetValue(_T("PerformDate"), CDate::Convert(szDate, yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("Diagnostic"), rs.GetValue(_T("diagnostic")));
	rs.GetValue(_T("operationname"), tmpStr);// cach mo
	rptHeader->SetValue(_T("TreatMethod"), tmpStr);
	rs.GetValue(_T("InMethod"), tmpStr);// phuong phap gay me
	rptHeader->SetValue(_T("InMethod"), tmpStr);
	rptHeader->SetValue(_T("Reason"), rs.GetValue(_T("reason")));

	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Mid(11, 5), szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	rpt.PrintPreview();
}

void CPrintForms::EM_OnPrintActivityTreatment(long nOrder_id) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	if (!rpt.Init(_T("Reports\\HMS\\DIEUTRIVANDONG.RPT")))
		return;
	CString szSQL, tmpStr, szCurDate;
	CReportSection* rptHeader = NULL, * rptGroup = NULL;
	CRecord rs(&pMF->m_db);
	szSQL.Format(_T(" SELECT get_patientname(ho_docno) patient_name, ho_docno doc_no, extract(year from hp_birthdate) yob, get_objectname(hd_object) object_name,") \
		_T("		get_syssel_desc('hms_rank', NVL(hd_rank, hp_rank)) rank, get_syssel_desc('sys_sex', hp_sex) sex, ") \
		_T("		hp_workplace work_place, hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) address, ") \
		_T("		hd_cardno card_no, hcr_admitdate admit_date, hd_suggestion, hcr_recordno record_no, hd_conclusion conclusion ") \
		_T(" FROM hms_operation ") \
		_T(" LEFT JOIN hms_doc ON (hd_docno = ho_docno) ") \
		_T(" LEFT JOIN hms_patient ON (hd_patientno = hp_patientno)") \
		_T(" LEFT JOIN hms_clinical_record ON (hcr_docno = hd_docno)") \
		_T(" WHERE ho_idx = %ld"), nOrder_id);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rptHeader = rpt.GetReportHeader();
		if (rptHeader)
		{
			//rptHeader->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
			//rptHeader->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);
			//rptHeader->SetValue(_T("Department"), pMF->GetCurrentDepartmentName());
			rptHeader->SetValue(_T("DocumentNo"), rs.GetValue(_T("doc_no")));
			StringUpper(rs.GetValue(_T("patient_name")), tmpStr);
			rptHeader->SetValue(_T("PatientName"), tmpStr);
			rptHeader->SetValue(_T("yearofbirth"), rs.GetValue(_T("yob")));
			rptHeader->SetValue(_T("rank"), rs.GetValue(_T("rank")));
			rptHeader->SetValue(_T("sex"), rs.GetValue(_T("sex")));
			rptHeader->SetValue(_T("Workplace"), rs.GetValue(_T("work_place")));
			rptHeader->SetValue(_T("address"), rs.GetValue(_T("address")));
			rptHeader->SetValue(_T("objectname"), rs.GetValue(_T("object_name")));
			rptHeader->SetValue(_T("cardno"), rs.GetValue(_T("card_no")));
			rs.GetValue(_T("hd_suggestion"), tmpStr);
			if (tmpStr == _T("C") || tmpStr == _T("D"))
			{
				rs.GetValue(_T("admit_date"), tmpStr);
				rptHeader->SetValue(_T("Admitdate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmmss, ddmmyyyy | hhmmss));
				//rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("RecordNo")));
			}
			else
			{
				rptHeader->SetValue(_T("Diagnostic"), rs.GetValue(_T("conclusion")));
			}
            rptHeader->SetValue(_T("orderid"), nOrder_id);
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
			rptGroup->SetPageBreak();
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(2));
		}
		else
		{
			_debug(_T("X"));
		}
	}
	else
		_debug(_T("Y"));

	rpt.PrintPreview();
}

void CPrintForms::EM_OnPrintPhysicalTreatment(long nOrder_id) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	if (!rpt.Init(_T("Reports\\HMS\\DIEUTRIVATLY.RPT")))
		return;
	CString szSQL, tmpStr, szCurDate;
	CReportSection* rptHeader = NULL, * rptGroup = NULL;
	CRecord rs(&pMF->m_db);
	szSQL.Format(_T(" SELECT get_patientname(ho_docno) patient_name, ho_docno doc_no, extract(year from hp_birthdate) yob, get_objectname(hd_object) object_name,") \
		_T("		get_syssel_desc('hms_rank', NVL(hd_rank, hp_rank)) rank, get_syssel_desc('sys_sex', hp_sex) sex, ") \
		_T("		hp_workplace work_place, hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) address, ") \
		_T("		hd_cardno card_no, hcr_admitdate admit_date, hd_suggestion, hcr_recordno record_no, hd_conclusion conclusion ") \
		_T(" FROM hms_operation ") \
		_T(" LEFT JOIN hms_doc ON (hd_docno = ho_docno) ") \
		_T(" LEFT JOIN hms_patient ON (hd_patientno = hp_patientno) ") \
		_T(" LEFT JOIN hms_clinical_record ON (hcr_docno = hd_docno) ") \
		_T(" WHERE ho_idx = %ld"), nOrder_id);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rptHeader = rpt.GetReportHeader();
		if (rptHeader)
		{
			//rptHeader->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
			//rptHeader->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);
			//rptHeader->SetValue(_T("Department"), pMF->GetCurrentDepartmentName());
			rptHeader->SetValue(_T("DocumentNo"), rs.GetValue(_T("doc_no")));
			StringUpper(rs.GetValue(_T("patient_name")), tmpStr);
			rptHeader->SetValue(_T("PatientName"), tmpStr);
			rptHeader->SetValue(_T("yearofbirth"), rs.GetValue(_T("yob")));
			rptHeader->SetValue(_T("rank"), rs.GetValue(_T("rank")));
			rptHeader->SetValue(_T("sex"), rs.GetValue(_T("sex")));
			rptHeader->SetValue(_T("Workplace"), rs.GetValue(_T("work_place")));
			rptHeader->SetValue(_T("address"), rs.GetValue(_T("address")));
			rptHeader->SetValue(_T("objectname"), rs.GetValue(_T("object_name")));
			rptHeader->SetValue(_T("cardno"), rs.GetValue(_T("card_no")));
			rs.GetValue(_T("hd_suggestion"), tmpStr);
			if (tmpStr == _T("C") || tmpStr == _T("D"))
			{
				rs.GetValue(_T("admit_date"), tmpStr);
				rptHeader->SetValue(_T("Admitdate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmmss, ddmmyyyy | hhmmss));
				//rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("RecordNo")));
			}
			else
			{
				rptHeader->SetValue(_T("Diagnostic"), rs.GetValue(_T("conclusion")));
			}
            rptHeader->SetValue(_T("orderid"), nOrder_id);
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(2));
			rptGroup->SetPageBreak();
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
		}
	}
	rpt.PrintPreview();

}

void CPrintForms::TM_OnPrintRadioactiveTreatmentFee(long nDocNo) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();

	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL;
	double nTmp = 0;
	int nIdx = 1;
	CString szSQL, tmpStr, szReportName, szDate, szTemp;
	double nTotal = 0;
	szReportName = _T("Reports\\HMS\\BANGKECHIPHIDICHVUKHAMDIEUTRIXATRIGIATOC.rpt");
	if (!rpt.Init(szReportName))
		return;

	szSQL.Format(_T("SELECT get_patientname(hd_docno) as patient_name, hd_docno as doc_no, hcr_recordno as record_no, ") \
		_T("		hd_conclusion as conclusion, ") \
		_T("		(select sp_name from sys_prov where sp_id = hp_provid) as address, hd_object obj, hd_cardno card_no, ") \
		_T("		extract(year from hp_birthdate) as yob") \
		_T(" FROM hms_doc ") \
		_T(" LEFT JOIN hms_patient ON (hp_patientno = hd_patientno) ") \
		_T(" LEFT JOIN hms_clinical_record ON (hcr_docno = hd_docno) ") \
		_T(" WHERE hd_docno = %ld"), nDocNo);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data."));
		return;
	}
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), rs.GetValue(_T("patient_name")));
	rpt.GetReportHeader()->SetValue(_T("Yearofbirth"), rs.GetValue(_T("yob")));
	rpt.GetReportHeader()->SetValue(_T("Address"), rs.GetValue(_T("address")));
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs.GetValue(_T("conclusion")));
	rpt.GetReportHeader()->SetValue(_T("Recordno"), rs.GetValue(_T("record_no")));
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), rs.GetValue(_T("doc_no")));
	rpt.GetReportHeader()->SetValue(_T("ObjectName"), rs.GetValue(_T("obj")));
	rpt.GetReportHeader()->SetValue(_T("CardNo"), rs.GetValue(_T("card_no")));

	szSQL.Format(_T("select hfe_desc, hfe_unit, hfe_quantity, hfe_unitprice, diff_cost from ") \
		_T(" (select hfe_desc, hfe_unit, hfe_quantity, hfe_unitprice, ") \
		_T(" case when hfe_type = 'X' then hfe_cost else hfe_diffcost end as diff_cost ") \
		_T(" from hms_fee ") \
		_T(" where hfe_docno = %ld ") \
		_T(" and hfe_type in ('X', 'O') and hfe_feegroup <> 'HITECH' and hfe_deptid = 'A6-C' and hfe_status in ('A','P') ") \
		_T(" and hfe_discount = 0) ") \
		_T(" where diff_cost > 0 "), nDocNo);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);
		//tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy), 
		//CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		//rpt.GetReportHeader()->SetValue(_T("ReportDate"), tmpStr);
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("hfe_desc")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("hfe_unit")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("hfe_quantity")));
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("hfe_unitprice")));
			rs.GetValue(_T("diff_cost"), nTmp);
			nTotal += nTmp;
			rptDetail->SetValue(_T("6"), double2str(nTmp));
		}
		rs.MoveNext();
	}
	tmpStr.Format(_T("%Lf"), nTotal);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	MoneyToString(tmpStr, szTemp);
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), szTemp + _T(" \x111\x1ED3ng."));
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.PrintPreview();
}

void CPrintForms::TM_OnPrintOutpatientTreatmentbyBicarbonat(long nDocNo, int nRefIdx) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL;
	CString szSQL, tmpStr, tmpStr2, szCurrent_date;
	int nDay_count = 0;
	struct TREATMENT_INFO {
		int nDate[31];
		int nCount[31];
	};
	TREATMENT_INFO treatment_info;
	for (int i = 0; i < 31; i++)
	{
		treatment_info.nDate[i] = 0;
		treatment_info.nCount[i] = 0;
	}
	if (!rpt.Init(_T("Reports\\HMS\\PHIEUTHEODOIBENHNHANDIEUTRINGOAITRU.RPT")))
		return;
	//Patient Info
	rptHeader = rpt.GetReportHeader();
	szSQL.Format(_T(" SELECT hd_docno doc_no, get_patientname(hd_docno) patient_name,") \
		_T("	hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) address,") \
		_T("	get_objectname(hd_object) object_name,") \
		_T("	hd_cardno card_no, extract(year from hp_birthdate) yob,") \
		_T("	to_char(HCR_ADMITDATE, 'DD/MM/YYYY') as ngayvaokhoa,") \
		_T("   to_char(hcr_dischargedate, 'DD/MM/YYYY') as ngayrakhoa") \
		_T(" FROM hms_doc ") \
		_T(" LEFT JOIN hms_patient ON (hd_patientno = hp_patientno) ") \
		_T(" LEFT JOIN hms_clinical_record_hist") \
		_T(" ON (hd_docno = hcr_docno)") \
		_T(" WHERE hd_docno = %ld and hcr_treattime in (0,%d)"), nDocNo, nRefIdx);
	int nRet = rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data."));
		if (nRet < 0)
			_msg(_T("%s"), szSQL);
		return;
	}
	if (rptHeader)
	{
		szCurrent_date = pMF->GetSysDate();
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		rptHeader->SetValue(_T("Department"), pMF->GetCurrentDepartmentName());
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), szCurrent_date.Mid(5, 2), szCurrent_date.Left(4));
		rptHeader->SetValue(_T("ReportDate"), tmpStr);
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("patient_name")));
		rptHeader->SetValue(_T("Yob"), rs.GetValue(_T("yob")));
		rptHeader->SetValue(_T("DocumentNo"), rs.GetValue(_T("doc_no")));
		rptHeader->SetValue(_T("Address"), rs.GetValue(_T("address")));
		rptHeader->SetValue(_T("ObjectName"), rs.GetValue(_T("object_name")));
		rptHeader->SetValue(_T("CardNo"), rs.GetValue(_T("card_no")));
		rptHeader->SetValue(_T("ngayvaokhoa"), rs.GetValue(_T("ngayvaokhoa")));
		rptHeader->SetValue(_T("ngayrakhoa"), rs.GetValue(_T("ngayrakhoa")));

	}
	//Treatment Info
	szSQL.Format(_T(" SELECT extract(day from ho_performdate) perform_date") \
		_T(" FROM hms_treatment_record ") \
		_T(" LEFT JOIN hms_operation ON (ho_docno = htr_docno AND (HO_REFIDX=HTR_IDX)) ") \
		_T(" WHERE ho_docno = %ld AND ho_treattime in (0,%d) AND htrf_acceptedfee IN ('Y', 'P', 'N')") \
		_T(" AND ho_itemid IN ('B40001699', 'B52004178')") \
		_T(" ORDER BY ho_performdate"), nDocNo, nRefIdx);
	nRet = rs.ExecSQL(szSQL);
	while (!rs.IsEOF())
	{
		treatment_info.nDate[nDay_count] = ToInt(rs.GetValue(_T("perform_date")));
		treatment_info.nCount[nDay_count] = nDay_count + 1;
		nDay_count++;
		rs.MoveNext();
	}
	for (int i = 0; i < 31; i++)
	{
		_debug(_T("%d"), treatment_info.nDate[i]);
		if (treatment_info.nDate[i] == 0)
			break;
		tmpStr.Format(_T("l%d"), i + 1);
		tmpStr2.Format(_T("%d"), treatment_info.nDate[i]);
		rptHeader->SetValue(tmpStr, tmpStr2);
		tmpStr.Format(_T("%d"), i + 1);
		tmpStr2.Format(_T("%d"), treatment_info.nCount[i]);
		rptHeader->SetValue(tmpStr, tmpStr2);
	}
	rpt.PrintPreview();
}

CString CPrintForms::GetDoctorDepartment(CString szDoctorID)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CString szSQL, szRet;
	CRecord rs(&pMF->m_db);
	szRet.Empty();
	szSQL.Format(_T("SELECT sd_id FROM sys_dept LEFT JOIN sys_user ON(sd_id = su_deptid) WHERE su_userid = '%s'"), szDoctorID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return _T("");
	rs.GetValue(_T("sd_id"), szRet);
	return szRet;
}
void CPrintForms::EM_OnPrintLaserReceiptList(long nDocNo, LPCTSTR lpszDoctor) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptDetail = NULL;
	CString szSQL, tmpStr, szMoney, szDate, szDoctorDept, szWhere, szSubSelect, szDoctor, szNewGroup, szOldGroup;
	double nFeeAmount = 0, nTtlAmt = 0, nTemp = 0;
	int nIdx = 1;
	szDoctorDept = GetDoctorDepartment(pMF->GetCurrentUser());
	if (pMF->GetCurrentRoomID() == 52)
	{
		if (!rpt.Init(_T("Reports\\HMS\\BANGKETHANHTOANVIENPHI_B10.RPT")))
			return;
		szSubSelect.AppendFormat(_T("(SELECT get_username(he_doctor) FROM hms_exam WHERE ") \
			_T(" he_docno = hd_docno AND he_roomid = %d) AS doctor, "), pMF->GetCurrentRoomID());
		//phi ngoai tru khong tinh tien kham
		szWhere.Format(_T("AND hfe_inspaid = 0 AND hfe_class = 'E' AND ( hfe_type = 'O' AND (ho_pdeptid = '%s' OR (ho_pdeptid = '%s' AND ho_roomid = %d)))"), szDoctorDept, pMF->GetCurrentDepartmentID(), pMF->GetCurrentRoomID());
	}
	else if (szDoctorDept == _T("TYC") || szDoctorDept == _T("PTTYC"))
	{
		if (!rpt.Init(_T("Reports\\HMS\\BANGKETHANHTOANVIENPHI.RPT")))
			return;
		//phi ngoai tru tinh tien kham
		szWhere.Format(_T("AND hfe_class = 'E' AND hfe_deptid IN('TYC', 'PTTYC')"));
	}
	else
	{
		if (!rpt.Init(_T("Reports\\HMS\\BANGKETHANHTOANVIENPHI.RPT")))
			return;
		//phi ngoai tru tinh tien kham
		//szWhere.Format(_T("AND hfe_class = 'E' AND ( hfe_type = 'E'  OR ( hfe_type = 'O' AND (ho_pdeptid = '%s' OR (ho_pdeptid = '%s' AND ho_roomid = %d))))"), szDoctorDept, pMF->GetCurrentDepartmentID(), pMF->GetCurrentRoomID());
		szWhere.Format(_T("AND hfe_class = 'E' AND hfe_type IN ('E', 'O') "), szDoctorDept, pMF->GetCurrentDepartmentID(), pMF->GetCurrentRoomID());
	}
	if (pMF->m_szModuleID == _T("EM"))
	{
		//chuan doan benh ngoai tru
		szSubSelect.AppendFormat(_T("(SELECT DISTINCT last_value(NVL(he_diagnostic,he_prediagnostic)) OVER (PARTITION BY he_docno) FROM hms_exam WHERE ") \
			_T(" he_docno = hd_docno AND he_roomid = %d) AS diagnostic, "), pMF->GetCurrentRoomID());
	}
	else
	{
		//phi noi tru
		szWhere.Format(_T("AND hfe_class = 'I' AND ( hfe_type = 'E'  OR ( hfe_type = 'O' AND ho_pdeptid = '%s' ) )"), szDoctorDept);
		//chuan doan benh noi tru
		szSubSelect.AppendFormat(_T("(SELECT DISTINCT last_value(hrt_maindisease) OVER (PARTITION BY hrt_docno) FROM hms_rehabilitation ") \
			_T(" WHERE hrt_docno = hd_docno) AS diagnostic, "));
		//so benh an
		szSubSelect.AppendFormat(_T("(SELECT DISTINCT htr_recordno FROM hms_treatment_record WHERE ") \
			_T(" htr_docno = hd_docno) AS record_no, "));
	}

	szSQL.Format(_T(" SELECT   hd_docno AS doc_no, ") \
		_T("		   %s ") \
		_T("           upper(Get_patientname(hd_docno)) AS patient_name, ") \
		_T("           Extract(year FROM hp_birthdate) AS yob, ") \
		_T("           get_syssel_desc('sys_sex', hp_sex) AS sex, ") \
		_T("           hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS addr, ") \
		_T("		   hd_recordno AS record_no, ") \
		_T("		   get_objectname(hd_object) AS obj, ") \
		_T("		   hd_cardno AS card_no, ") \
		_T("		   hd_admitdate AS admitdate, ") \
		_T("		   hd_enddate AS enddate ") \
		_T(" FROM      hms_doc ") \
		_T(" LEFT JOIN hms_patient ON ( hp_patientno = hd_patientno ) ") \
		_T(" WHERE hd_docno = %ld "), szSubSelect, nDocNo);

	rs.ExecSQL(szSQL);
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);
		rptHeader->SetValue(_T("Department"), pMF->GetDepartmentName(szDoctorDept));
		tmpStr.Format(_T("%ld"), nDocNo);
		rptHeader->SetValue(_T("DocumentNo"), tmpStr);
		rptHeader->SetValue(_T("PATIENTNAME"), rs.GetValue(_T("patient_name")));
		rptHeader->SetValue(_T("Yearofbirth"), rs.GetValue(_T("yob")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("Address"), rs.GetValue(_T("addr")));
		rptHeader->SetValue(_T("Diagnostic"), rs.GetValue(_T("diagnostic")));
		rptHeader->SetValue(_T("Recordno"), rs.GetValue(_T("record_no")));
		rptHeader->SetValue(_T("ObjectName"), rs.GetValue(_T("obj")));
		rptHeader->SetValue(_T("CardNo"), rs.GetValue(_T("card_no")));
		rs.GetValue(_T("admitdate"), tmpStr);
		rptHeader->SetValue(_T("InDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rs.GetValue(_T("enddate"), tmpStr);
		rptHeader->SetValue(_T("OutDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rs.GetValue(_T("doctor"), szDoctor);

	}

	if (szDoctorDept == _T("TYC") || szDoctorDept == _T("PTTYC"))
	{
		szSQL.Format(_T(" SELECT hfe_desc     AS descr,") \
			_T("   hfe_unitprice     AS unit_price,") \
			_T("   SUM(hfe_quantity) AS qty,") \
			_T("   SUM(hfe_patdebt)  AS amount,") \
			_T("   CASE WHEN hfe_type = 'E' THEN 1 WHEN hfe_type = 'T' THEN 2 WHEN hfe_type = 'P' THEN 3") \
			_T("   WHEN hfe_type = 'O' THEN 4 WHEN hfe_type IN 'D' THEN 5 WHEN hfe_type IN 'M' THEN 6") \
			_T("   ELSE 7 END AS hfe_type") \
			_T(" FROM hms_fee") \
			_T(" WHERE hfe_status = 'O' %s") \
			_T(" AND hfe_docno    = %ld AND hfe_patdebt > 0 AND hfe_type NOT IN ('D', 'M') ") \
			_T(" GROUP BY hfe_desc,") \
			_T("   hfe_unitprice,") \
			_T("   hfe_type,") \
			_T("   hfe_object") \
			_T(" ORDER BY hfe_type, hfe_desc"), szWhere, nDocNo);

		rs.ExecSQL(szSQL);
		if (rs.IsEOF())
			return;
		while (!rs.IsEOF())
		{
			rs.GetValue(_T("hfe_type"), szNewGroup);
			if (szNewGroup != szOldGroup && !szNewGroup.IsEmpty())
			{
				if (nFeeAmount > 0)
				{
					rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
					rptDetail->SetValue(_T("Total"), _T("T?ng nhóm"));
					rptDetail->SetValue(_T("s5"), ToString(nFeeAmount));
					nTtlAmt += nFeeAmount;
					nFeeAmount = 0;
				}
				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
				if (szNewGroup == _T("1"))
					rptDetail->SetValue(_T("GroupName"), _T("Tiền khám"));
				else if (szNewGroup == _T("2"))
					rptDetail->SetValue(_T("GroupName"), _T("Xét nghiệm"));
				else if (szNewGroup == _T("3"))
					rptDetail->SetValue(_T("GroupName"), _T("Chẩn đoán hình ảnh"));
				else if (szNewGroup == _T("4"))
					rptDetail->SetValue(_T("GroupName"), _T("Phẫu thuật thủ thuật"));
				else if (szNewGroup == _T("5"))
					rptDetail->SetValue(_T("GroupName"), _T("Thuốc"));
				else if (szNewGroup == _T("6"))
					rptDetail->SetValue(_T("GroupName"), _T("Vật tư"));
				else if (szNewGroup == _T("7"))
					rptDetail->SetValue(_T("GroupName"), _T("Khác"));
				nIdx = 1;
				szOldGroup = szNewGroup;
			}

			rptDetail = rpt.AddDetail();
			if (rptDetail)
			{
				rptDetail->SetValue(_T("1"), int2str(nIdx++));
				rptDetail->SetValue(_T("2"), rs.GetValue(_T("descr")));
				rptDetail->SetValue(_T("3"), rs.GetValue(_T("unit_price")));
				rptDetail->SetValue(_T("4"), rs.GetValue(_T("qty")));
				rptDetail->SetValue(_T("5"), rs.GetValue(_T("amount")));
				nFeeAmount += str2double(rs.GetValue(_T("amount")));
			}
			rs.MoveNext();
		}

		if (nFeeAmount > 0)
		{
			rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
			rptDetail->SetValue(_T("Total"), _T("Tổng nhóm"));
			rptDetail->SetValue(_T("s5"), ToString(nFeeAmount));
			nTtlAmt += nFeeAmount;
		}

		if (nTtlAmt > 0)
		{
			rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
			rptDetail->SetValue(_T("Total"), _T("Tổng cộng"));
			rptDetail->SetValue(_T("s5"), ToString(nTtlAmt));
		}

		MoneyToString(ToString(nTtlAmt), tmpStr);
		tmpStr += _T(" \x111\x1ED3ng.");
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
		szDate = pMF->GetSysDate();
		tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Mid(8, 2), szDate.Mid(5, 2), szDate.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
		tmpStr = GetDoctorName(pMF->GetCurrentUser());
		rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);
		rpt.PrintPreview();

	}
	else
	{
		szSQL.Format(_T(" SELECT    hfe_desc AS descr, ") \
			_T("           hfe_unitprice AS unit_price, ") \
			_T("           SUM(hfe_quantity) AS qty, ") \
			_T("           SUM(hfe_patdebt) AS amount") \
			_T(" FROM      hms_fee ") \
			_T(" LEFT JOIN hms_operation ON ( hfe_docno = ho_docno AND hfe_orderid = ho_idx AND hfe_type = 'O' ) ") \
			_T(" WHERE hfe_status = 'O' %s ") \
			_T(" AND hfe_docno = %ld ") \
			_T(" GROUP BY hfe_desc, hfe_unitprice, hfe_type, hfe_object ORDER BY hfe_type"), szWhere, nDocNo);

		rs.ExecSQL(szSQL);
		if (rs.IsEOF())
			return;
		while (!rs.IsEOF())
		{
			rptDetail = rpt.AddDetail();
			if (rptDetail)
			{
				rptDetail->SetValue(_T("1"), int2str(nIdx++));
				rptDetail->SetValue(_T("2"), rs.GetValue(_T("descr")));
				rptDetail->SetValue(_T("3"), rs.GetValue(_T("unit_price")));
				rptDetail->SetValue(_T("4"), rs.GetValue(_T("qty")));
				rptDetail->SetValue(_T("5"), rs.GetValue(_T("amount")));
				nFeeAmount += str2double(rs.GetValue(_T("amount")));
			}
			rs.MoveNext();
		}

		rpt.GetReportFooter()->SetValue(_T("s5"), ToString(nFeeAmount));


		MoneyToString(ToString(nFeeAmount), tmpStr);
		tmpStr += _T(" \x111\x1ED3ng.");
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
		szDate = pMF->GetSysDate();
		tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Mid(8, 2), szDate.Mid(5, 2), szDate.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
		if (pMF->GetCurrentRoomID() == 52)
		{
			rpt.GetReportFooter()->SetValue(_T("DoctorName"), szDoctor);
		}
		else
		{
			tmpStr = GetDoctorName(pMF->GetCurrentUser());
			rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);
		}
		rpt.PrintPreview();
	}
}

CString CPrintForms::GetNameUser(CString UserName, CString LastName) {
	CString szValue, tmpStr;
	int nIndex = 0;
	bool flag = true;
	CString szFind;
	szFind = _T(" ");
	if (UserName.GetLength() > 0)
	{
		for (int i = 1; i < UserName.GetLength(); i++)
		{
			tmpStr = UserName.Right(i);
			if (tmpStr.Find(szFind) == 1 && flag == true && i > 2)
			{
				nIndex = i;
				flag = false;
			}
		}
	}
	if (nIndex > 0)
	{
		szValue = UserName.Right(nIndex - 1);
	}
	return szValue;
}
void CPrintForms::EM_OnPrintPointedNote(long nDocNo, CString szFilter) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptDetail = NULL;
	CString szSQL, tmpStr, szDate, szWhere, szDoctorDept, szSubSelect;
	int nIdx = 1;

	CString szOrders = szFilter;
    szOrders.Replace(_T("-1,"), _T(""));
    szOrders.Replace(_T(","), _T("'_'"));
    szOrders.Replace(_T("'"), _T(""));   

	CString szSignID;
    
	szSignID.Format(L"%s_%ld", L"PHIEUCHIDINHC6", nDocNo);

	//Kiem tra neu ky so thi preview len
	szSQL.Format(L"SELECT hms_signature_id FROM hms_signature  "
                 L"WHERE docno=%ld and sign_id like('%s'||chr(37)||'%s'||chr(37)) ",
                 nDocNo, szSignID, szOrders);
    _tprintf(szSQL);
	rs.ExecSQL(szSQL);
    if (!rs.IsEOF())
    {
		CString szSignatureID;
		rs.GetValue(L"hms_signature_id", szSignatureID);
		if (!szSignatureID.IsEmpty())
		{
            CPdfSignature signer(pMF);
            signer.DownloadAndPreview(szSignatureID, true);
			return;
        }
	}

	if (!rpt.Init(_T("Reports\\HMS\\PHIEUCHIDINHC6.RPT")))
		return;

	

	

	if (pMF->m_szModuleID == _T("EM"))
	{
		//Khoa la phong kham
		szSubSelect.Format(_T(" 'PK' AS deptid, "));
		//Chuan doan benh ngoai tru
		szSubSelect.AppendFormat(
			_T(" get_diagnostic(%ld, 0, '%s', %ld) AS diagnostic, ")
			, nDocNo, pMF->m_szDept, pMF->GetCurrentRoomID());
	}
	else
	{
		//Khoa chuyen den noi tru
		szSubSelect.Format(_T("(SELECT htr_deptid FROM hms_treatment_record  ") \
			_T(" WHERE htr_docno = hd_docno AND htr_status = 'I') AS deptid, "));
		//Chuan doan benh noi tru
		szSubSelect.AppendFormat(_T("(SELECT DISTINCT last_value(hrt_maindisease) OVER (PARTITION BY hrt_docno) FROM hms_rehabilitation ") \
			_T(" WHERE hrt_docno = hd_docno) AS diagnostic, "));
	}
	szSQL.Format(_T(" SELECT   hd_docno AS doc_no, ") \
		_T("		   %s ") \
		_T("           upper(Get_patientname(hd_docno)) AS patient_name, ") \
		_T("           Extract(year FROM hp_birthdate) AS yob, ") \
		_T("           get_syssel_desc('sys_sex', hp_sex) AS sex, ") \
		_T("           hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS addr, ") \
		_T("		   hd_recordno AS record_no, ") \
		_T("		   get_objectname(hd_object) AS obj, ") \
		_T("		   hd_cardno AS card_no, ") \
		_T("		   hd_admitdate AS admitdate,") \
		_T("		   hd_enddate AS enddate ") \
		_T(" FROM      hms_doc ") \
		_T(" LEFT JOIN hms_patient ON ( hp_patientno = hd_patientno ) ") \
		_T(" WHERE hd_docno = %ld "), szSubSelect, nDocNo);

	rs.ExecSQL(szSQL);
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);
		tmpStr.Format(_T("%ld"), nDocNo);
		rptHeader->SetValue(_T("DocumentNo"), tmpStr);
		rptHeader->SetValue(_T("Barcode[128B]"), tmpStr);
		rptHeader->SetValue(_T("PATIENTNAME"), rs.GetValue(_T("patient_name")));
		rptHeader->SetValue(_T("Yearofbirth"), rs.GetValue(_T("yob")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("Address"), rs.GetValue(_T("addr")));
		rptHeader->SetValue(_T("Diagnostic"), rs.GetValue(_T("diagnostic")));
		rptHeader->SetValue(_T("Recordno"), rs.GetValue(_T("record_no")));
		rptHeader->SetValue(_T("ObjectName"), rs.GetValue(_T("obj")));
		rptHeader->SetValue(_T("CardNo"), rs.GetValue(_T("card_no")));
		rs.GetValue(_T("admitdate"), tmpStr);
		rptHeader->SetValue(_T("InDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rs.GetValue(_T("enddate"), tmpStr);
		rptHeader->SetValue(_T("OutDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rptHeader->SetValue(_T("Department1"), rs.GetValue(_T("deptid")));
		rptHeader->SetValue(_T("Department2"), pMF->GetDepartmentName(pMF->m_szDept));
		rptHeader->SetValue(_T("Department3"), pMF->GetDepartmentName(pMF->m_UserInfo.su_deptid));

		
		rptHeader->SetValue(_T("Orders"), szOrders);

	}

	if (!szFilter.IsEmpty())
	{
		szWhere.AppendFormat(_T(" and ho_idx in(%s) "), szFilter);
	}

	szSQL.Format(_T(" SELECT   TRIM(hfl_name || ho_note) AS hfl_name,") \
		_T(" get_username(ho_practitioner) AS practitioner ") \
		_T(" FROM  hms_operation ") \
		_T(" LEFT JOIN hms_fee_list ON (hfl_feeid=ho_itemid) ") \
		_T(" WHERE ho_docno = %ld ") \
		_T(" AND ho_status <> 'O' %s  ") \
		_T(" ORDER BY ho_idx "), nDocNo, szWhere);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("hfl_name")));
			rs.GetValue(_T("practitioner"), tmpStr);
			tmpStr = GetNameUser(tmpStr);
			rptDetail->SetValue(_T("3"), tmpStr);
		}
		rs.MoveNext();
	}
	szDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Mid(8, 2), szDate.Mid(5, 2), szDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	tmpStr = GetDoctorName(pMF->GetCurrentUser());
	rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);
	rpt.PrintPreview();
}
void CPrintForms::EM_OnPrintRehabilitation(long nDocNo, CString m_szItemIDS, CString szOptIDXS, CString szFilters) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptGroup = NULL, * rptDetail = NULL;
    CString szSQL, tmpStr, szDate, szWhere, szSubSelect, szJsonEntries;

	CString szOrders = szFilters;
    szOrders.Replace(_T("-1,"), _T(""));
    szOrders.Replace(_T(","), _T("'_'"));
    szOrders.Replace(_T("'"), _T(""));

    CString szSignID;

    szSignID.Format(L"%s_%ld", L"PHIEUPHUCHOICHUCNANG", nDocNo);

    // Kiem tra neu ky so thi preview len
    szSQL.Format(
        L"SELECT hms_signature_id FROM hms_signature  "
        L"WHERE docno=%ld and sign_id like('%s'||chr(37)||'%s'||chr(37)) ",
        nDocNo, szSignID, szOrders);
    _tprintf(szSQL);
    rs.ExecSQL(szSQL);
    if (!rs.IsEOF())
    {
        CString szSignatureID;
        rs.GetValue(L"hms_signature_id", szSignatureID);
        if (!szSignatureID.IsEmpty())
        {
            CPdfSignature signer(pMF);
            signer.DownloadAndPreview(szSignatureID, true);
            return;
        }
    }

	if (!rpt.Init(_T("Reports\\HMS\\PHIEUPHUCHOICHUCNANG.RPT")))
		return;

	if (pMF->m_szModuleID == _T("EM"))
	{
		//Khoa la phong kham
		szSubSelect.Format(_T(" 'PK' AS deptid, "));
		//Chuan doan benh ngoai tru
		szSubSelect.AppendFormat(
			_T(" get_diagnostic(%ld, 0, '%s', %ld) AS diagnostic, ")
			, nDocNo, pMF->m_szDept, pMF->GetCurrentRoomID());
		szSubSelect.AppendFormat(_T("hd_reldisease AS reldisease,"));
	}
	else
	{
		//Khoa chuyen den
		szSubSelect.Format(_T("(SELECT htr_deptid FROM hms_treatment_record WHERE ") \
			_T(" htr_docno = hd_docno AND htr_status = 'I') AS deptid, "));
		//So benh an
		szSubSelect.AppendFormat(_T("(SELECT DISTINCT htr_recordno FROM hms_treatment_record WHERE ") \
			_T(" htr_docno = hd_docno and rownum<2) AS record_no, "));
		//Chuan doan benh noi tru
		szSubSelect.AppendFormat(_T("hrt_maindisease AS diagnostic, hrt_relationdisease AS reldisease,"));
	}

	szSQL.Format(_T(" SELECT hd_docno                                   AS doc_no,") \
		_T("   %s ") \
		_T("   upper(Get_patientname(hd_docno))                AS patient_name,") \
		_T("   Extract(YEAR FROM hp_birthdate)                 AS yob,") \
		_T("   get_syssel_desc('sys_sex', hp_sex)              AS sex,") \
		_T("   hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS addr,") \
		_T("   get_objectname(hd_object)                       AS obj,") \
		_T("   hd_cardno                                       AS card_no,") \
		_T("   get_syssel_desc('hms_rank', hp_rank)            AS rank,") \
		_T("   hp_workplace                                    AS work_place,") \
		_T("   get_syssel_desc('hms_c6', hrt_bookno)           AS bookno,") \
		_T("   get_syssel_desc('hms_phieuc6', hrt_sheetno)     AS sheetno,") \
		_T("   hrt_regno                                       AS regno,") \
		_T("   hrt_diseasedate                                 AS diseasedate,") \
		_T("   hrt_diseasetime                                 AS diseasetime,") \
		_T("   hrt_desc                                        AS methodname,") \
		_T("   (SELECT fa_name FROM fam_asset_dept WHERE fa_assetno = hrt_machine") \
		_T("   )                        AS machine,") \
		_T("   hrt_dosage               AS dosage,") \
		_T("   hrt_body                 AS pbody,") \
		_T("   hrt_electrode            AS electrode,") \
		_T("   hrt_treatnum             AS treatnum,") \
		_T("   hrt_treattime			AS treattime,")
		_T("   get_username(hrt_doctor) AS doctor,") \
		_T("	hrt_extinfo AS extinfo,") \
		_T("   hrt_examdate AS examdate,") \
		_T("   hd_admitdate AS admitdate,") \
		_T("   (SELECT get_username(ho_practitioner) FROM hms_operation") \
		_T("   WHERE hrt_docno = ho_docno AND SUBSTR(hrt_optidx, 1, 10) = to_char(ho_idx)) AS username") \
		_T(" FROM hms_rehabilitation") \
		_T(" LEFT JOIN hms_patient") \
		_T(" ON ( hp_patientno = hrt_patientno )") \
		_T(" LEFT JOIN hms_doc") \
		_T(" ON ( hd_docno = hrt_docno )") \
		_T(" WHERE     hrt_docno = %ld AND hrt_optidx = '%s'"), szSubSelect, nDocNo, szOptIDXS);
	//_msg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);
		tmpStr.Format(_T("%ld"), nDocNo);
		rptHeader->SetValue(_T("DocumentNo"), tmpStr);
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("record_no")));
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("patient_name")));
		rptHeader->SetValue(_T("Rank"), rs.GetValue(_T("rank")));
		rptHeader->SetValue(_T("Yearofbirth"), rs.GetValue(_T("yob")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("WorkPlace"), rs.GetValue(_T("work_place")));
		rptHeader->SetValue(_T("Address"), rs.GetValue(_T("addr")));
		rptHeader->SetValue(_T("ObjectName"), rs.GetValue(_T("obj")));
		rptHeader->SetValue(_T("CardNo"), rs.GetValue(_T("card_no")));
		rptHeader->SetValue(_T("Diagnostic"), rs.GetValue(_T("diagnostic")));
		rptHeader->SetValue(_T("Reldisease"), rs.GetValue(_T("reldisease")));
		rptHeader->SetValue(_T("BookNo"), rs.GetValue(_T("bookno")));
		rptHeader->SetValue(_T("SheetNo"), rs.GetValue(_T("sheetno")));
		rptHeader->SetValue(_T("RegNo"), rs.GetValue(_T("regno")));
		rptHeader->SetValue(_T("DiseaseDate"), rs.GetValue(_T("diseasedate")));
		rptHeader->SetValue(_T("DiseaseTime"), rs.GetValue(_T("diseasetime")));
		rptHeader->SetValue(_T("MethodName"), rs.GetValue(_T("methodname")));
		rptHeader->SetValue(_T("Machine"), rs.GetValue(_T("machine")));
		rptHeader->SetValue(_T("Dosage"), rs.GetValue(_T("dosage")));
		rptHeader->SetValue(_T("Body"), rs.GetValue(_T("pbody")));
		rptHeader->SetValue(_T("Electrode"), rs.GetValue(_T("electrode")));
		rptHeader->SetValue(_T("TreatNum"), rs.GetValue(_T("treatnum")));
		rptHeader->SetValue(_T("TreatTime"), rs.GetValue(_T("treattime")));
		rptHeader->SetValue(_T("Doctor"), rs.GetValue(_T("doctor")));
        szJsonEntries = rs.GetValue(_T("extinfo"));
		rptHeader->SetValue(_T("Department1"), rs.GetValue(_T("deptid")));
		rptHeader->SetValue(_T("Department2"), pMF->GetDepartmentName(pMF->m_szDept));
		rptHeader->SetValue(_T("Department3"), pMF->GetDepartmentName(pMF->m_UserInfo.su_deptid));

		rs.GetValue(_T("examdate"), tmpStr);
		rptHeader->SetValue(_T("ExamDate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmmss, ddmmyyyy | hhmmss));
		rs.GetValue(_T("admitdate"), tmpStr);
		rptHeader->SetValue(_T("AdmitDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rpt.GetGroupHeader(1)->SetValue(_T("User"), rs.GetValue(_T("username")));
		
		/*
		rptGroup = rpt.AddDetail(rpt.GetGroupHeader(2));
        rptGroup->SetPageBreak();
        rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
        */
	}

	int nCount = 0;

    int nStartPos = 0;

    while (nStartPos < szJsonEntries.GetLength())
    {
        int nMarkerStart = szJsonEntries.Find(_T("--- "), nStartPos);
        if (nMarkerStart == -1)
            break;

        int nMarkerEnd = szJsonEntries.Find(_T(" ---"), nMarkerStart + 4);
        if (nMarkerEnd == -1)
            break;

        int nJsonStart = nMarkerEnd + 4;
        while (nJsonStart < szJsonEntries.GetLength() &&
               (szJsonEntries[nJsonStart] == _T('\r') ||
                szJsonEntries[nJsonStart] == _T('\n')))
        {
            nJsonStart++;
        }

        int nJsonEnd = szJsonEntries.Find(_T("\r\n--- "), nJsonStart);
        if (nJsonEnd == -1)
            nJsonEnd = szJsonEntries.GetLength();

        // Extract JSON string
        CString szJsonData =
            szJsonEntries.Mid(nJsonStart, nJsonEnd - nJsonStart);
        szJsonData.Trim();

        if (!szJsonData.IsEmpty())
        {
            try
            {
                JSONVALUE jData;
                std::wstring jsonStr = szJsonData.GetString();
                CString cstr(jsonStr.c_str());
                jData.Parse(cstr);

                CString szDate, szTreatment, szDosage, szTime, szComment,
                    szPerformer;
                long nCount = 0, nTreattime = 0;

                jData[_T("Date")].GetValue(szDate);
                jData[_T("Count")].GetValue(nCount);
                jData[_T("Treatment")].GetValue(szTreatment);
                jData[_T("Dosage")].GetValue(szDosage);
                jData[_T("Time")].GetValue(szTime);
                jData[_T("Treattime")].GetValue(nTreattime);
                jData[_T("Comment")].GetValue(szComment);
                jData[_T("Performer")].GetValue(szPerformer);

                CString szCountStr, szTreattimeStr;
                szCountStr.Format(_T("%ld"), nCount);
                szTreattimeStr.Format(_T("%ld"), nTreattime);
                rptDetail = rpt.AddDetail();
                if (rptDetail)
                {
                    rptDetail->SetValue(_T("1"), szDate);
                    rptDetail->SetValue(_T("2"), szCountStr);
                    rptDetail->SetValue(_T("3"), szTreatment);
                    rptDetail->SetValue(_T("4"), szDosage);
                    rptDetail->SetValue(_T("5"), szTime);
                    rptDetail->SetValue(_T("6"), szTreattimeStr);
                    rptDetail->SetValue(_T("7"), szComment);
                    rptDetail->SetValue(_T("8"), szPerformer);
                }
            
                nCount++;
            }
            catch (...)
            {
                _tprintf(_T("Error parsing JSON data: %s"), szJsonData);
            }
        }
        nStartPos = nJsonEnd;
    }

	rpt.PrintPreview();
}
void CPrintForms::FM_OnPrintServiceIncomeList2(CString szReceiptIDStr) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	/*Declaration Section*/
	CRecord rs(&pMF->m_db), rsx(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL, * rptFooter = NULL;
	double nTmp = 0;
	int nIdx = 1, nOldCashID = 0, nCashID = 0;
	CString szSQL, szWhere, tmpStr, szPos, szReportName, szDate, szReceiptStr, szUser;
	CString szInvoiceNo, szInvoiceDate, szUserID;
	double nTotal[9];
	double nFa = 0;
	szReportName = _T("Reports\\HMS\\HF_BANGKETHUBENHNHANDICHVUYTE.RPT");
	if (!rpt.Init(szReportName))
		return;
	//Get Report Date
	szSQL.Format(_T("SELECT min(fac_createddate) from_date, max(fac_createddate) to_date FROM fa_cash WHERE fac_cash_id IN (%s)"), szReceiptIDStr);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rs.GetValue(_T("from_date"), m_szFromDate);
		rs.GetValue(_T("to_date"), m_szToDate);
	}
	//Get Receipt String
	szSQL.Format(_T("SELECT fac_invoiceno invoice_no, get_username(fac_user_id) user_name FROM fa_cash WHERE fac_cash_id IN (%s)"), szReceiptIDStr);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF())
	{
		if (!szReceiptStr.IsEmpty())
			szReceiptStr += _T(", ");
		szReceiptStr += rs.GetValue(_T("invoice_no"));
		if (!szUser.IsEmpty())
			szUser += _T(", ");
		szUser += rs.GetValue(_T("user_name"));
		rs.MoveNext();
	}
	szWhere.Format(_T(" AND cash_id IN (%s)"), szReceiptIDStr);
	szSQL.Format(_T(" SELECT cash_id, trim(hp_surname") \
		_T("   ||' '") \
		_T("   ||hp_midname") \
		_T("   ||' '") \
		_T("   ||hp_firstname)                                   AS patient_name,") \
		_T("   hfe_docno                                         AS doc_no,") \
		_T("   hfe_deptid                                        AS dept_name,") \
		_T("   SUM(trichtamgui)                                  AS invoice_deposit,") \
		_T("   SUM(thuthem)                                      AS pat_paid,") \
		_T("   SUM(cackhoanphaithu-miengiam-tienthuoc-tienvattu-maycnc) AS invoice_amount,") \
		_T("   SUM(miengiam)                                     AS fa,") \
		_T("   SUM(tienthuoc)                                    AS invoice_drug,") \
		_T("   SUM(tienvattu)                                    AS invoice_material,") \
		_T("   SUM(maycnc)                                       AS cnc_amount,") \
		_T("   SUM(tamguibandau)                                 AS deposit,") \
		_T("   SUM(tamguibandau+thuthem)                         AS receipt_amount") \
		_T(" FROM") \
		_T("   (SELECT hfe_cash_id AS cash_id,") \
		_T("     hfe_patientno,") \
		_T("     hfe_docno,") \
		_T("     hfe_deptid,") \
		_T("     hfe_refidx,") \
		_T("     hfe_invoiceno,") \
		_T("     hfe_deposit AS trichtamgui,") \
		_T("     CASE") \
		_T("       WHEN hfe_payment > 0") \
		_T("       THEN hfe_payment") \
		_T("       ELSE 0") \
		_T("     END            AS thuthem,") \
		_T("     hfe_patpaid    AS cackhoanphaithu,") \
		_T("     hfe_freeamount AS miengiam,") \
		_T("     0              AS tamguibandau,") \
		_T("     CASE") \
		_T("       WHEN hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee f") \
		_T("         LEFT JOIN m_product_item ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("		 LEFT JOIN m_product ON (mpi_product_id = mp_product_id)") \
		_T("         WHERE f.hfe_docno     = i.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = i.hfe_invoiceno") \
		_T(" AND f.hfe_status in('P','R') ") \
		_T("         AND f.hfe_type       IN('D','M', 'R')") \
		_T("         AND f.hfe_category   <> 'Y'") \
		_T("         AND mp_org_id        ='PM'") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tienthuoc,") \
		_T("     CASE") \
		_T("       WHEN hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee f") \
		_T("         LEFT JOIN m_product_item ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("		 LEFT JOIN m_product ON (mpi_product_id = mp_product_id)") \
		_T("         WHERE f.hfe_docno     = i.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = i.hfe_invoiceno") \
		_T(" AND f.hfe_status in('P','R') ") \
		_T("         AND f.hfe_type       IN('D','M', 'R')") \
		_T("         AND f.hfe_category   <> 'Y'") \
		_T("         AND mp_org_id        ='MA'") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tienvattu,") \
		_T("     (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("     FROM hms_fee f") \
		_T("     LEFT JOIN hms_fee_list") \
		_T("     ON(hfl_feeid                   = hfe_itemid)") \
		_T("     WHERE f.hfe_docno              = i.hfe_docno") \
		_T("     AND f.hfe_invoiceno            = i.hfe_invoiceno") \
		_T("	 AND f.hfe_status in('P','R') ") \
		_T("     AND f.hfe_type                IN('P','T','O')") \
		_T("     AND f.hfe_category            <> 'Y'") \
		_T("     AND NVL(hfl_hitechmachine,'N') ='Y'") \
		_T("     ) AS maycnc") \
		_T("   FROM hms_fee_invoice i") \
		_T("   WHERE hfe_status IN('P','R')") \
		_T("   AND hfe_payment  >=0") \
		_T("   AND hfe_refund    = 0") \
		_T("   UNION ALL") \
		_T("   SELECT hfe_cash_id AS cash_id,") \
		_T("     hfe_patientno,") \
		_T("     hfe_docno,") \
		_T("     hfe_deptid,") \
		_T("     hfe_refidx,") \
		_T("     hfe_invoiceno,") \
		_T("     0          AS trichtamgui,") \
		_T("     0          AS cackhoanphaithu,") \
		_T("     0          AS miengiam,") \
		_T("     0          AS thuthem,") \
		_T("     hfe_amount AS tamguibandau,") \
		_T("     0          AS tienthuoc,") \
		_T("     0          AS tienvattu,") \
		_T("     0          AS cnc") \
		_T("   FROM hms_fee_deposit") \
		_T("   WHERE hfe_status IN('P','R')") \
		_T("   )") \
		_T(" LEFT JOIN hms_patient") \
		_T(" ON(hfe_patientno =hp_patientno)") \
		_T(" WHERE 1          =1") \
		_T(" %s ") \
		_T(" GROUP BY cash_id,") \
		_T("   hfe_patientno,") \
		_T("   hfe_docno,") \
		_T("   hfe_deptid,") \
		_T("   hp_surname,") \
		_T("   hp_midname,") \
		_T("   hp_firstname") \
		_T(" ORDER BY cash_id,") \
		_T("   patient_name"), szWhere);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	for (int i = 0; i < 9; i++)
		nTotal[i] = 0;
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ReportDate"), tmpStr);
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rs.GetValue(_T("cash_id"), nCashID);
		if (nOldCashID != nCashID)
		{
			szSQL.Format(_T("SELECT fac_invoiceno, TO_CHAR(fac_invoicedate,'DD/MM/YYYY') as invoicedate, fac_user_id FROM fa_cash WHERE fac_cash_id=%ld "), nCashID);
			rsx.ExecSQL(szSQL);
			rsx.GetValue(_T("fac_invoiceno"), szInvoiceNo);
			rsx.GetValue(_T("invoicedate"), szInvoiceDate);
			rsx.GetValue(_T("fac_user_id"), szUserID);
			tmpStr.Format(_T("S\x1ED1 phi\x1EBFu [%s] Ng\xE0y [%s] Ng\x1B0\x1EDDi thu [%s]"), szInvoiceNo, szInvoiceDate, szUserID);
			CReportSection* grp = NULL;
			grp = rpt.GetGroupHeader(1);
			if (grp)
			{
				rptDetail = rpt.AddDetail(grp);
				rptDetail->SetValue(_T("GroupName"), tmpStr);
			}
			nOldCashID = nCashID;

		}
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("patient_name")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("doc_no")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("dept_name")));
			rs.GetValue(_T("invoice_deposit"), nTmp);
			nTotal[0] += nTmp;
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("invoice_deposit")));
			rs.GetValue(_T("pat_paid"), nTmp);
			nTotal[1] += nTmp;
			rptDetail->SetValue(_T("6"), rs.GetValue(_T("pat_paid")));
			rs.GetValue(_T("invoice_amount"), nTmp);
			nTotal[2] += nTmp;
			rptDetail->SetValue(_T("7"), rs.GetValue(_T("invoice_amount")));
			rs.GetValue(_T("fa"), nTmp);
			nTotal[3] += nTmp;
			rptDetail->SetValue(_T("8"), rs.GetValue(_T("fa")));
			rs.GetValue(_T("invoice_drug"), nTmp);
			nTotal[4] += nTmp;
			rptDetail->SetValue(_T("9"), rs.GetValue(_T("invoice_drug")));
			rs.GetValue(_T("invoice_material"), nTmp);
			nTotal[5] += nTmp;
			rptDetail->SetValue(_T("10"), rs.GetValue(_T("invoice_material")));
			rs.GetValue(_T("cnc_amount"), nTmp);
			nTotal[6] += nTmp;
			rptDetail->SetValue(_T("11"), rs.GetValue(_T("cnc_amount")));
			rs.GetValue(_T("deposit"), nTmp);
			nTotal[7] += nTmp;
			rptDetail->SetValue(_T("12"), rs.GetValue(_T("deposit")));
			rs.GetValue(_T("receipt_amount"), nTmp);
			nTotal[8] += nTmp;
			rptDetail->SetValue(_T("13"), rs.GetValue(_T("receipt_amount")));
		}
		rs.MoveNext();
	}

	rptFooter = rpt.GetGroupFooter(1);
	if (rptFooter)
	{
		rptDetail = rpt.AddDetail(rptFooter);
	}
	else
	{
		rptDetail = rpt.GetReportFooter();

	}
	if (rptDetail)
	{
		for (int i = 0; i < 9; i++)
		{
			szPos.Format(_T("s%d"), i + 5);
			tmpStr.Format(_T("%f"), nTotal[i]);
			rptDetail->SetValue(szPos, tmpStr);
		}
	}
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.GetReportFooter()->SetValue(_T("User"), szUser);
	rpt.PrintPreview();
	return;
	//Old version
	szSQL.Format(_T(" SELECT * ") \
		_T(" FROM   (SELECT    doc_no, ") \
		_T("                   Get_patientname(doc_no) patient_name, ") \
		_T("                   dept_id dept_name, ") \
		_T("                   SUM(invoice_deposit) invoice_deposit, ") \
		_T("                   SUM(pat_paid - fa) pat_paid, ") \
		_T("                   SUM(invoice_amount - fa) invoice_amount, ") \
		_T("				   SUM(fa) fa,") \
		_T("                   SUM(invoice_drug) invoice_drug, ") \
		_T("                   SUM(invoice_material) invoice_material, ") \
		_T("                   SUM(CASE WHEN cash_id < invoice_cash  OR invoice_cash = 0 THEN deposit ") \
		_T("                       ELSE 0 ") \
		_T("                       END) deposit, ") \
		_T("                   SUM(pat_paid - fa + CASE WHEN cash_id < invoice_cash OR invoice_cash = 0 THEN deposit ELSE 0 END) receipt_amount ") \
		_T("         FROM      ( ") \
		_T("                   SELECT hfe_cash_id cash_id, ") \
		_T("						  hfe_staff clerk,") \
		_T("					      hfe_date invoice_date,") \
		_T("                          hfe_deptid dept_id, ") \
		_T("                          hfe_docno doc_no, ") \
		_T("						  hfe_objectid object_id,") \
		_T("                          hfe_deposit invoice_deposit, ") \
		_T("                          hfe_amount - hfe_deposit pat_paid, ") \
		_T("                          0 invoice_amount, ") \
		_T("						  hfe_freeamount fa,") \
		_T("                          0 invoice_drug, ") \
		_T("                          0 invoice_material, ") \
		_T("                          0 deposit, ") \
		_T("                          hfe_class invoice_class, ") \
		_T("                          0 invoice_cash ") \
		_T("                   FROM   hms_fee_invoice ") \
		_T("				   WHERE hfe_status IN ('P', 'R')") \
		_T("                   UNION ALL ") \
		_T("                   SELECT    hfe_cash_id, ") \
		_T("							 i.hfe_staff,") \
		_T("							 i.hfe_date,") \
		_T("                             i.hfe_deptid, ") \
		_T("                             i.hfe_docno, ") \
		_T("							 i.hfe_objectid,") \
		_T("                             0, ") \
		_T("                             0, ") \
		_T("                             CASE WHEN i.hfe_class = 'I' THEN hfe_cost ") \
		_T("                             ELSE ") \
		_T("                                 CASE WHEN f.hfe_type NOT IN ( 'D', 'M' ) THEN hfe_cost ") \
		_T("                                 ELSE 0 ") \
		_T("                                 END ") \
		_T("                             END, ") \
		_T("							 0,") \
		_T("                             CASE WHEN i.hfe_class <> 'I' AND product_org_id = 'PM' THEN hfe_cost ") \
		_T("                             ELSE 0 ") \
		_T("                             END, ") \
		_T("                             CASE WHEN i.hfe_class <> 'I' AND product_org_id = 'MA' THEN hfe_cost ") \
		_T("                             ELSE 0 ") \
		_T("                             END, ") \
		_T("                             0, ") \
		_T("                             i.hfe_class, ") \
		_T("                             0 ") \
		_T("                   FROM      hms_fee_invoice i ") \
		_T("                   LEFT JOIN hms_fee f ON ( i.hfe_docno = f.hfe_docno AND i.hfe_invoiceno = f.hfe_invoiceno ) ") \
		_T("                   LEFT JOIN m_productitem_view ON ( Cast(product_item_id AS NVARCHAR2(15)) = hfe_itemid ) ") \
		_T("                   WHERE     hfe_category <> 'Y' AND i.hfe_status IN ('P', 'R')") \
		_T("                    UNION ALL ") \
		_T("                    SELECT    d.hfe_cash_id, ") \
		_T("							  d.hfe_staff,") \
		_T("							  d.hfe_date,") \
		_T("                              d.hfe_deptid, ") \
		_T("                              d.hfe_docno, ") \
		_T("							  d.hfe_objectid,") \
		_T("                              0, ") \
		_T("                              0, ") \
		_T("                              0, ") \
		_T("							  0,") \
		_T("                              0, ") \
		_T("                              0, ") \
		_T("                              d.hfe_amount, ") \
		_T("                              Cast ('D' AS NVARCHAR2(1)), ") \
		_T("                              Coalesce(i.hfe_cash_id, 0) ") \
		_T("                    FROM      hms_fee_deposit d ") \
		_T("                    LEFT JOIN hms_fee_invoice i ON ( i.hfe_docno = d.hfe_docno AND d.hfe_refidx = i.hfe_invoiceno )") \
		_T("					WHERE d.hfe_status IN ('P', 'R')) tbl0") \
		_T("         WHERE     1=1 %s ") \
		_T("         GROUP     BY doc_no,dept_id,invoice_class ") \
		_T("         ORDER     BY ") \
		_T("        dept_id,  ") \
		_T("        doc_no) ") \
		_T(" WHERE  receipt_amount > 0"), szWhere);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	for (int i = 0; i < 7; i++)
		nTotal[i] = 0;
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ReportDate"), tmpStr);
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("patient_name")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("doc_no")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("dept_name")));
			rs.GetValue(_T("invoice_deposit"), nTmp);
			nTotal[0] += nTmp;
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("invoice_deposit")));
			rs.GetValue(_T("pat_paid"), nTmp);
			nTotal[1] += nTmp;
			rptDetail->SetValue(_T("6"), rs.GetValue(_T("pat_paid")));
			rs.GetValue(_T("invoice_amount"), nTmp);
			nTotal[2] += nTmp;
			rptDetail->SetValue(_T("7"), rs.GetValue(_T("invoice_amount")));
			rs.GetValue(_T("fa"), nTmp);
			nFa += nTmp;
			rptDetail->SetValue(_T("7.1"), rs.GetValue(_T("fa")));
			rs.GetValue(_T("invoice_drug"), nTmp);
			nTotal[3] += nTmp;
			rptDetail->SetValue(_T("8"), rs.GetValue(_T("invoice_drug")));
			rs.GetValue(_T("invoice_material"), nTmp);
			nTotal[4] += nTmp;
			rptDetail->SetValue(_T("9"), rs.GetValue(_T("invoice_material")));
			rs.GetValue(_T("deposit"), nTmp);
			nTotal[5] += nTmp;
			rptDetail->SetValue(_T("10"), rs.GetValue(_T("deposit")));
			rs.GetValue(_T("receipt_amount"), nTmp);
			nTotal[6] += nTmp;
			rptDetail->SetValue(_T("11"), rs.GetValue(_T("receipt_amount")));
		}
		rs.MoveNext();
	}
	rptFooter = rpt.GetReportFooter();
	if (rptFooter)
	{
		for (int i = 0; i < 7; i++)
		{
			szPos.Format(_T("s%d"), i + 5);
			tmpStr.Format(_T("%f"), nTotal[i]);
			rptFooter->SetValue(szPos, tmpStr);
		}
		tmpStr.Format(_T("%f"), nFa);
		rptFooter->SetValue(_T("s7.1"), tmpStr);
	}
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.GetReportFooter()->SetValue(_T("User"), szUser);

	rpt.PrintPreview();
}

void CPrintForms::FM_OnPrintServiceOutlayList2(CString szPaymentIDStr)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	/*Declaration Section*/
	CRecord rs(&pMF->m_db), rsx(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL, * rptFooter = NULL;
	double nTmp = 0;
	int nIdx = 1, nCount = 0, nOldCashID = 0, nCashID = 0;
	CString szSQL, szWhere, tmpStr, szPos, szReportName, szDate, szPaymentStr, szUser;
	CString szInvoiceNo, szInvoiceDate, szUserID;

	double nTotal[19];
	double nFa = 0;
	szReportName = _T("Reports\\HMS\\HF_DANHSACHCHITRATIENBENHNHANDICHVUYTE.RPT");
	if (!rpt.Init(szReportName))
		return;
	//Get Report Date
	szSQL.Format(_T("SELECT min(fac_createddate) from_date, max(fac_createddate) to_date FROM fa_cash WHERE fac_cash_id IN (%s)"), szPaymentIDStr);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rs.GetValue(_T("from_date"), m_szFromDate);
		rs.GetValue(_T("to_date"), m_szToDate);
	}
	//Get Receipt String
	szSQL.Format(_T("SELECT fac_invoiceno invoice_no, get_username(fac_user_id) user_name FROM fa_cash WHERE fac_cash_id IN (%s)"), szPaymentIDStr);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF())
	{
		if (!szPaymentStr.IsEmpty())
			szPaymentStr += _T(", ");
		szPaymentStr += rs.GetValue(_T("invoice_no"));
		if (!szUser.IsEmpty())
			szUser += _T(", ");
		szUser += rs.GetValue(_T("user_name"));
		rs.MoveNext();
	}
	szWhere.Format(_T(" AND cash_id IN (%s)"), szPaymentIDStr);

	/*szSQL.Format(_T(" SELECT cash_id,") \
	_T("   fac_invoiceno AS invoice_no,") \
	_T("   Get_patientname(hfe_docno) as pname, ") \
	_T("   hfe_deptid as deptid, ") \
	_T("   hfe_docno as docno,") \
	_T("   SUM(trichtamgui)                                         AS invoice_deposit,") \
	_T("   SUM(cackhoanphaithu-miengiam-tienthuoc-tienvattu-maycnc) AS invoice_amount,") \
	_T("   SUM(miengiam)                                            AS fa,") \
	_T("   SUM(tienthuoc)                                           AS invoice_drug,") \
	_T("   SUM(tienvattu)                                           AS invoice_material,") \
	_T("   SUM(maycnc)                                              AS cnc_amount,") \
	_T("   SUM(chitravienphi+tl_trichtamthu)                                       AS patient_return,") \
	_T("   SUM(tl_vienphi-tl_thuoc-tl_vattu-tl_cnc)					AS fee_return,") \
	_T("   SUM(tl_thuoc)                                            AS drug_return,") \
	_T("   SUM(tl_vattu)                                            AS material_return,") \
	_T("   SUM(tl_cnc)                                              AS cnc_return,") \
	_T("   SUM(chitravienphi+tl_vienphi+tl_trichtamthu)   AS total_return") \
	_T(" FROM fa_cash") \
	_T(" LEFT JOIN") \
	_T("   (SELECT r.hfe_cash_id AS cash_id,") \
	_T("     i.hfe_patientno,") \
	_T("     i.hfe_docno,") \
	_T("     i.hfe_deptid,") \
	_T("     i.hfe_refidx,") \
	_T("     i.hfe_invoiceno,") \
	_T("     i.hfe_deposit    AS trichtamgui,") \
	_T("     i.hfe_patpaid    AS cackhoanphaithu,") \
	_T("     i.hfe_freeamount AS miengiam,") \
	_T("     CASE") \
	_T("       WHEN i.hfe_class <> 'I'") \
	_T("       THEN") \
	_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
	_T("         FROM hms_fee f") \
	_T("         LEFT JOIN m_product_item ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
	_T("		 LEFT JOIN m_product ON (mpi_product_id = mp_product_id)") \
	_T("         WHERE f.hfe_docno     = i.hfe_docno") \
	_T("         AND f.hfe_invoiceno   = i.hfe_invoiceno") \
	_T(" AND f.hfe_status in('P','R') ") \
	_T("         AND f.hfe_type       IN('D','M','R')") \
	_T("         AND f.hfe_category   <> 'Y'") \
	_T("         AND mp_org_id        ='PM'") \
	_T("         )") \
	_T("       ELSE 0") \
	_T("     END AS tienthuoc,") \
	_T("     CASE") \
	_T("       WHEN i.hfe_class <> 'I'") \
	_T("       THEN") \
	_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
	_T("         FROM hms_fee f") \
	_T("         LEFT JOIN m_product_item ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
	_T("		 LEFT JOIN m_product ON (mpi_product_id = mp_product_id)") \
	_T("         WHERE f.hfe_docno     = i.hfe_docno") \
	_T("         AND f.hfe_invoiceno   = i.hfe_invoiceno") \
	_T(" AND f.hfe_status in('P','R') ") \
	_T("         AND f.hfe_type       IN('D','M','R')") \
	_T("         AND f.hfe_category   <> 'Y'") \
	_T("         AND mp_org_id        ='MA'") \
	_T("         )") \
	_T("       ELSE 0") \
	_T("     END AS tienvattu,") \
	_T("     (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
	_T("     FROM hms_fee f") \
	_T("     LEFT JOIN hms_fee_list") \
	_T("     ON(hfl_feeid                   = hfe_itemid)") \
	_T("     WHERE f.hfe_docno              = i.hfe_docno") \
	_T("     AND f.hfe_invoiceno            = i.hfe_invoiceno") \
	_T(" AND f.hfe_status in('P','R') ") \
	_T("     AND f.hfe_type                IN('P','T','O')") \
	_T("     AND f.hfe_category            <> 'Y'") \
	_T("     AND NVL(hfl_hitechmachine,'N') ='Y'") \
	_T("     )            AS maycnc,") \
	_T("     i.hfe_refund AS chitravienphi,") \
	_T("     0            AS tl_vienphi,") \
	_T("     0            AS tl_thuoc,") \
	_T("     0            AS tl_vattu,") \
	_T("     0            AS tl_cnc, 0 as tl_trichtamthu ") \
	_T("   FROM hms_fee_refund r") \
	_T("   LEFT JOIN hms_fee_invoice i") \
	_T("   ON(r.hfe_docno      = i.hfe_docno") \
	_T("   AND r.hfe_refidx    =i.hfe_invoiceno and trunc(r.hfe_amount)=i.hfe_refund)") \
	_T("   WHERE i.hfe_status IN('P','R')") \
	_T("   AND i.hfe_payment  <=0") \
	_T("   AND i.hfe_refund    > 0") \
	_T("   UNION ALL") \
	_T("   SELECT r.hfe_cash_id cash_id,	") \
	_T("     r.hfe_patientno,") \
	_T("     r.hfe_docno,") \
	_T("     r.hfe_deptid,") \
	_T("     r.hfe_refidx,") \
	_T("     r.hfe_invoiceno,") \
	_T("     r.hfe_amount    AS trichtamgui,") \
	_T("     0    AS cackhoanphaithu,") \
	_T("     0 AS miengiam,") \
	_T("     0 tienthuoc,") \
	_T("     0 tienvattu,") \
	_T("     0            AS maycnc,") \
	_T("     r.hfe_amount AS chitravienphi,") \
	_T("     0            AS tl_vienphi,") \
	_T("     0            AS tl_thuoc,") \
	_T("     0            AS tl_vattu,") \
	_T("     0            AS tl_cnc, 0 as tl_trichtamthu ") \
	_T("   FROM hms_fee_refund r") \
	_T("   WHERE r.hfe_status = 'P' AND r.hfe_type = 'G' AND r.hfe_isreq = 'Y' AND r.hfe_refidx = 0") \
	_T("   UNION ALL") \
	_T("   SELECT r.hfe_cash_id,") \
	_T("     r.hfe_patientno,") \
	_T("     r.hfe_docno,") \
	_T("     r.hfe_deptid,") \
	_T("     r.hfe_refidx,") \
	_T("     r.hfe_invoiceno,") \
	_T("     case when l.hfe_itemid is null then l.hfe_patpaid else 0 end             AS trichtamgui,") \
	_T("     0             AS cackhoanphaithu,") \
	_T("     0             AS miengiam,") \
	_T("     0             AS tienthuoc,") \
	_T("     0             AS tienvattu,") \
	_T("     0             AS maycnc,") \
	_T("     0             AS chtravp,") \
	_T("     case when l.hfe_itemid is null then 0 else l.hfe_patpaid end AS tl_vienphi,") \
	_T("     CASE") \
	_T("       WHEN r.hfe_class <> 'I'") \
	_T("       THEN") \
	_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
	_T("         FROM hms_fee_refundline f") \
	_T("         LEFT JOIN m_product_item") \
	_T("         ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
	_T("         WHERE f.hfe_docno     = r.hfe_docno") \
	_T("         AND f.hfe_invoiceno   = r.hfe_invoiceno") \
	_T("         AND f.hfe_type       IN('F')") \
	_T("		 AND SUBSTR(f.hfe_group, 1, 1) = 'A' ")\
	_T(" and f.hfe_itemid = l.hfe_itemid ") \
	_T("         AND mpi_org_id        ='PM'") \
	_T("         )") \
	_T("       ELSE 0") \
	_T("     END AS tl_tienthuoc,") \
	_T("     CASE") \
	_T("       WHEN r.hfe_class <> 'I'") \
	_T("       THEN") \
	_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
	_T("         FROM hms_fee_refundline f") \
	_T("         LEFT JOIN m_product_item") \
	_T("         ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
	_T("         WHERE f.hfe_docno     = r.hfe_docno") \
	_T("         AND f.hfe_invoiceno   = r.hfe_invoiceno") \
	_T("         AND f.hfe_type       IN('F')") \
	_T("		 AND SUBSTR(f.hfe_group, 1, 1) = 'A' ") \
	_T(" and f.hfe_itemid = l.hfe_itemid ") \
	_T("         AND mpi_org_id        ='MA'") \
	_T("         )") \
	_T("       ELSE 0") \
	_T("     END AS tl_tienvattu,") \
	_T("     (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
	_T("     FROM hms_fee_refundline f") \
	_T("     LEFT JOIN hms_fee_list") \
	_T("     ON(hfl_feeid                   = hfe_itemid)") \
	_T("     WHERE f.hfe_docno              = r.hfe_docno") \
	_T("     AND f.hfe_invoiceno            = r.hfe_invoiceno") \
	_T("     AND f.hfe_type                IN('F')") \
	_T(" and f.hfe_itemid = l.hfe_itemid ") \
	_T("     AND NVL(hfl_hitechmachine,'N') ='Y'") \
	_T("     ) AS tl_maycnc, ") \
	_T("     case when l.hfe_itemid is null then l.hfe_patpaid else 0 end  as tl_trichtamthu ") \
	_T("   FROM hms_fee_refund r,") \
	_T("     hms_fee_refundline l") \
	_T("   WHERE r.hfe_docno           = l.hfe_docno") \
	_T("   AND r.hfe_invoiceno         = l.hfe_invoiceno") \
	_T("   AND l.hfe_invoiceno         > 0") \
	_T("   AND r.hfe_status            ='P'") \
	_T(" UNION ALL ") \
	_T(" SELECT hfe_cash_id,") \
	_T("   hfe_patientno,") \
	_T("   hfe_docno,") \
	_T("   hfe_deptid,") \
	_T("   hfe_refidx,") \
	_T("   hfe_invoiceno,") \
	_T("   0 AS trichtamgui,") \
	_T("   0 AS cackhoanphaithu,") \
	_T("   0 AS miengiam,") \
	_T("   0 AS tienthuoc,") \
	_T("   0 AS tienvattu,") \
	_T("   0 AS maycnc,") \
	_T("   0 AS chtravp,") \
	_T("   hfe_amount AS tl_vienphi,") \
	_T("   0 AS tl_tienthuoc,") \
	_T("   0 AS tl_tienvattu,") \
	_T("   0 AS tl_maycnc,") \
	_T("   0 AS tl_trichtamthu") \
	_T(" FROM hms_fee_refund") \
	_T(" WHERE hfe_type in('G','S') AND (hfe_isreq <> 'Y' AND hfe_refidx <> 0)") \
	_T(" AND hfe_status='P'") \
	_T("   ) tblInvoice ON(fac_cash_id = cash_id)") \
	_T(" WHERE 1=1 %s ") \
	_T(" GROUP BY cash_id,") \
	_T(" hfe_deptid, ") \
	_T("   hfe_docno,") \
	_T("   fac_user_id,") \
	_T("   fac_invoiceno") \
	_T(" ORDER BY fac_user_id,") \
_T("   fac_invoiceno"), szWhere);*/
	szSQL.Format(_T(" SELECT cash_id,") \
		_T("   fac_invoiceno AS invoice_no,") \
		_T("   Get_patientname(hfe_docno) as pname, ") \
		_T("   hfe_deptid as deptid, ") \
		_T("   hfe_docno as docno,") \
		_T("   SUM(trichtamgui)                                         AS invoice_deposit,") \
		_T("   SUM(cackhoanphaithu-miengiam-tienthuoc-tienvattu-maycnc-hfe_packageamount) AS invoice_amount,") \
		//_T("   CASE WHEN SUM(cackhoanphaithu)-SUM(miengiam)=0 THEN 0 ELSE SUM(cackhoanphaithu-miengiam-tienthuoc-tienvattu-maycnc)  END AS invoice_amount,") \//
		_T("   SUM(miengiam)                                            AS fa,") \
		_T("   SUM(tienthuoc)                                           AS invoice_drug,") \
		_T("   SUM(tienvattu)                                           AS invoice_material,") \
		_T("   SUM(maycnc)                                              AS cnc_amount,") \
		_T("   SUM(hfe_packageamount)									AS thu_goidv,") \
		//_T("   CASE WHEN SUM(cackhoanphaithu)-SUM(miengiam)=0 THEN 0 ELSE SUM(tienthuoc)   END  AS invoice_drug,") \//
		//_T("   CASE WHEN SUM(cackhoanphaithu)-SUM(miengiam)=0 THEN 0 ELSE SUM(tienvattu)  END    AS invoice_material,") \//
		//_T("   CASE WHEN SUM(cackhoanphaithu)-SUM(miengiam)=0 THEN 0 ELSE SUM(maycnc) END     AS cnc_amount,") \//
		_T("   SUM(chitravienphi+tl_trichtamthu)                        AS patient_return,") \
		_T("   SUM(tl_vienphi-tl_thuoc-tl_vattu-tl_cnc-chi_goidv)	    AS fee_return,") \
		_T("   SUM(tl_thuoc)                                            AS drug_return,") \
		_T("   SUM(tl_vattu)                                            AS material_return,") \
		_T("   SUM(tl_cnc)                                              AS cnc_return,") \
		_T("   SUM(chi_goidv)                                           AS chi_goidv,") \
		_T("   SUM(chitravienphi+tl_vienphi+tl_trichtamthu)   AS total_return") \
		_T(" FROM fa_cash") \
		_T(" LEFT JOIN") \
		_T("   (SELECT r.hfe_cash_id AS cash_id,") \
		_T("     i.hfe_patientno,") \
		_T("     i.hfe_docno,") \
		_T("     i.hfe_deptid,") \
		_T("     i.hfe_refidx,") \
		_T("     i.hfe_invoiceno,") \
		_T("     i.hfe_deposit    AS trichtamgui,") \
		_T("     i.hfe_patpaid    AS cackhoanphaithu,") \
		_T("     i.hfe_freeamount AS miengiam,") \
		_T("     CASE") \
		_T("       WHEN i.hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee f") \
		_T("         LEFT JOIN m_product_item ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("		 LEFT JOIN m_product ON (mp_product_id = mpi_product_id)") \
		_T("         WHERE f.hfe_docno     = i.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = i.hfe_invoiceno") \
		_T("		 AND f.hfe_status in('P','R') ") \
		_T("         AND f.hfe_type       IN('D','M', 'R')") \
		_T("         AND f.hfe_category   <> 'Y'") \
		_T("         AND mp_org_id        ='PM'") \
		_T("         AND f.Hfe_itemid NOT IN (select Hfe_itemid from Hms_Fee_Discountline where hfe_docno=i.hfe_docno and  Hfe_Refidx=i.hfe_invoiceno)") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tienthuoc,") \
		_T("     CASE") \
		_T("       WHEN i.hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee f") \
		_T("         LEFT JOIN m_product_item ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("		 LEFT JOIN m_product ON (mp_product_id = mpi_product_id)") \
		_T("         WHERE f.hfe_docno     = i.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = i.hfe_invoiceno") \
		_T(" AND f.hfe_status in('P','R') ") \
		_T("         AND f.hfe_type       IN('D','M', 'R')") \
		_T("         AND f.hfe_category   <> 'Y'") \
		_T("         AND mp_org_id        ='MA'") \
		_T("         AND f.Hfe_itemid NOT IN (select Hfe_itemid from Hms_Fee_Discountline where hfe_docno=i.hfe_docno and  Hfe_Refidx=i.hfe_invoiceno)") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tienvattu,") \
		_T("     (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("     FROM hms_fee f") \
		_T("     LEFT JOIN hms_fee_list") \
		_T("     ON(hfl_feeid                   = hfe_itemid)") \
		_T("     WHERE f.hfe_docno              = i.hfe_docno") \
		_T("     AND f.hfe_invoiceno            = i.hfe_invoiceno") \
		_T("     AND f.hfe_status in('P','R') ") \
		_T("     AND f.hfe_type                IN('P','T','O')") \
		_T("     AND f.hfe_category            <> 'Y'") \
		_T("     AND NVL(hfl_hitechmachine,'N') ='Y'") \
		_T("     AND f.Hfe_itemid NOT IN (select Hfe_itemid from Hms_Fee_Discountline where hfe_docno=i.hfe_docno and  Hfe_Refidx=i.hfe_invoiceno)") \
		_T("     )            AS maycnc,") \

		_T(" (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("     FROM hms_fee f  ") \
		_T("     WHERE f.hfe_docno              = i.hfe_docno") \
		_T("     AND f.hfe_invoiceno            = i.hfe_invoiceno") \
		_T("     AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
		_T("     AND f.hfe_status              IN('P','R')") \
		_T("     AND f.hfe_type                IN('X')") \
		_T("     AND f.hfe_category            <> 'Y'    ") \
		_T("     AND f.Hfe_itemid NOT          IN") \
		_T("       (SELECT Hfe_itemid") \
		_T("       FROM Hms_Fee_Discountline") \
		_T("       WHERE hfe_docno                =i.hfe_docno") \
		_T("       AND Hfe_Refidx                 =i.hfe_invoiceno") \
		_T("        AND f.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')") \
		_T("       ) ) AS hfe_packageamount,") \

		_T("     i.hfe_refund AS chitravienphi,") \
		_T("     0            AS tl_vienphi,") \
		_T("     0            AS tl_thuoc,") \
		_T("     0            AS tl_vattu,") \
		_T("     0            AS tl_cnc, 0 AS chi_goidv,0 as tl_trichtamthu ") \
		_T("   FROM hms_fee_refund r") \
		_T("   LEFT JOIN hms_fee_invoice i") \
		_T("   ON(r.hfe_docno      = i.hfe_docno") \
		_T("   AND r.hfe_refidx    =i.hfe_invoiceno)") \
		_T("   WHERE i.hfe_status IN('P','R')") \
		_T("   AND i.hfe_payment  <=0") \
		_T("   AND i.hfe_refund    > 0") \
		_T("   AND (SELECT count(*) FROM hms_fee_refundline WHERE hfe_invoiceno = r.hfe_invoiceno AND hfe_docno = r.hfe_docno) = 0") \
		//Update ngay 18/06/2017: Xu ly truong hop BN tam gui, sau do duyet phi nhung chua thanh toan, so tien trich tam gui bi sai //
		//----------------------------------------------------------------------------------------------------------------------------//
		/*_T("    UNION ALL") \
		_T("   SELECT r.hfe_cash_id AS cash_id,") \
		_T("     i.hfe_patientno,") \
		_T("     i.hfe_docno,") \
		_T("     i.hfe_deptid,") \
		_T("     i.hfe_refidx,") \
		_T("     i.hfe_invoiceno,") \
		_T("     i.hfe_deposit    AS trichtamgui,") \
		_T("     i.hfe_patpaid    AS cackhoanphaithu,") \
		_T("     i.hfe_freeamount AS miengiam,") \
		_T("     CASE") \
		_T("       WHEN i.hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee f") \
		_T("         LEFT JOIN m_product_item ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("		 LEFT JOIN m_product ON (mp_product_id = mpi_product_id)") \
		_T("         WHERE f.hfe_docno     = i.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = i.hfe_invoiceno") \
		_T(" AND f.hfe_status in('P','R') ") \
		_T("         AND f.hfe_type       IN('D','M', 'R')") \
		_T("         AND f.hfe_category   <> 'Y'") \
		_T("         AND mp_org_id        ='PM'") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tienthuoc,") \
		_T("     CASE") \
		_T("       WHEN i.hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee f") \
		_T("         LEFT JOIN m_product_item ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("		 LEFT JOIN m_product ON (mp_product_id = mpi_product_id)") \
		_T("         WHERE f.hfe_docno     = i.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = i.hfe_invoiceno") \
		_T(" AND f.hfe_status in('P','R') ") \
		_T("         AND f.hfe_type       IN('D','M', 'R')") \
		_T("         AND f.hfe_category   <> 'Y'") \
		_T("         AND mp_org_id        ='MA'") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tienvattu,") \
		_T("     (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("     FROM hms_fee f") \
		_T("     LEFT JOIN hms_fee_list") \
		_T("     ON(hfl_feeid                   = hfe_itemid)") \
		_T("     WHERE f.hfe_docno              = i.hfe_docno") \
		_T("     AND f.hfe_invoiceno            = i.hfe_invoiceno") \
		_T(" AND f.hfe_status in('P','R') ") \
		_T("     AND f.hfe_type                IN('P','T','O')") \
		_T("     AND f.hfe_category            <> 'Y'") \
		_T("     AND NVL(hfl_hitechmachine,'N') ='Y'") \
		_T("     )            AS maycnc,") \
		_T("     i.hfe_refund AS chitravienphi,") \
		_T("     0            AS tl_vienphi,") \
		_T("     0            AS tl_thuoc,") \
		_T("     0            AS tl_vattu,") \
		_T("     0            AS tl_cnc, 0 as tl_trichtamthu ") \
		_T("   FROM hms_fee_refund r") \
		_T("   LEFT JOIN hms_fee_invoice i") \
		_T("   ON(r.hfe_docno      = i.hfe_docno)") \
		_T("   WHERE i.hfe_status IN('P','R')") \
		_T("   AND i.hfe_payment  <=0") \
		_T("   AND i.hfe_refund    = 0") \
		_T("   AND (SELECT count(*) FROM hms_fee_refundline WHERE hfe_invoiceno = r.hfe_invoiceno AND hfe_docno = r.hfe_docno) = 0") \
		//----------------------------------------------------------------------------------------------------------------------------//*/
		_T("   UNION ALL") \
		_T("   SELECT r.hfe_cash_id cash_id,	") \
		_T("     r.hfe_patientno,") \
		_T("     r.hfe_docno,") \
		_T("     r.hfe_deptid,") \
		_T("     r.hfe_refidx,") \
		_T("     r.hfe_invoiceno,") \
		_T("     r.hfe_amount    AS trichtamgui,") \
		_T("     0    AS cackhoanphaithu,") \
		_T("     0 AS miengiam,") \
		_T("     0 tienthuoc,") \
		_T("     0 tienvattu,") \
		_T("     0            AS maycnc,") \
		_T("     0            AS hfe_packageamount,") \
		_T("     r.hfe_amount AS chitravienphi,") \
		_T("     0            AS tl_vienphi,") \
		_T("     0            AS tl_thuoc,") \
		_T("     0            AS tl_vattu,") \
		_T("     0            AS tl_cnc, 0  AS chi_goidv,0 as tl_trichtamthu ") \
		_T("   FROM hms_fee_refund r") \
		//_T("   WHERE r.hfe_status = 'P' AND r.hfe_type = 'G' AND r.hfe_isreq = 'Y' AND r.hfe_refidx = 0") \//
		_T("   WHERE r.hfe_status = 'P' AND r.hfe_type = 'G' AND r.hfe_refidx = 0") \
		_T("   UNION ALL") \
		_T("   SELECT r.hfe_cash_id,") \
		_T("     r.hfe_patientno,") \
		_T("     r.hfe_docno,") \
		_T("     r.hfe_deptid,") \
		_T("     r.hfe_refidx,") \
		_T("     r.hfe_invoiceno,") \
		_T("     case when l.hfe_itemid is null then l.hfe_patpaid else 0 end             AS trichtamgui,") \
		_T("     0             AS cackhoanphaithu,") \
		_T("     0             AS miengiam,") \
		_T("     0             AS tienthuoc,") \
		_T("     0             AS tienvattu,") \
		_T("     0             AS maycnc,") \

		_T("     0             AS hfe_packageamount,") \

		_T("     0             AS chtravp,") \
		_T("     case when l.hfe_itemid is null then 0 else l.hfe_patpaid end AS tl_vienphi,") \
		_T("     CASE") \
		_T("       WHEN r.hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee_refundline f") \
		_T("         LEFT JOIN m_product_item") \
		_T("         ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("         WHERE f.hfe_docno     = r.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = r.hfe_invoiceno") \
		_T("         AND f.hfe_type       IN('F')") \
		_T("		 AND SUBSTR(f.hfe_group, 1, 1) = 'A' ")\
		_T("         and f.hfe_itemid = l.hfe_itemid ") \
		_T("         AND mpi_org_id        ='PM'") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tl_tienthuoc,") \
		_T("     CASE") \
		_T("       WHEN r.hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee_refundline f") \
		_T("         LEFT JOIN m_product_item") \
		_T("         ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("         WHERE f.hfe_docno     = r.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = r.hfe_invoiceno") \
		_T("         AND f.hfe_type       IN('F')") \
		_T("		 AND SUBSTR(f.hfe_group, 1, 1) = 'A' ") \
		_T(" and f.hfe_itemid = l.hfe_itemid ") \
		_T("         AND mpi_org_id        ='MA'") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tl_tienvattu,") \
		_T("     (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("     FROM hms_fee_refundline f") \
		_T("     LEFT JOIN hms_fee_list") \
		_T("     ON(hfl_feeid                   = hfe_itemid)") \
		_T("     WHERE f.hfe_docno              = r.hfe_docno") \
		_T("     AND f.hfe_invoiceno            = r.hfe_invoiceno") \
		_T("	 AND f.hfe_fee_refundline_id = l.hfe_fee_refundline_id") \
		_T("     AND f.hfe_type                IN('F')") \
		_T("	 and f.hfe_itemid = l.hfe_itemid ") \
		_T("     AND NVL(hfl_hitechmachine,'N') ='Y'") \
		_T("     ) AS tl_maycnc, ") \

		_T("  (SELECT COALESCE(SUM(hfe_cost), 0) ") \
		_T("     FROM hms_fee_refundline l  ") \
		_T("     WHERE l.hfe_invoiceno = r.hfe_invoiceno ") \
		_T("     AND l.hfe_docno = r.hfe_docno ") \
		_T("     AND l.hfe_itemid IN (select ss_code from sys_sel where ss_id='HMS_SERVICE_PACKAGE')) chi_goidv,") \


		_T("     case when l.hfe_itemid is null then l.hfe_patpaid else 0 end  as tl_trichtamthu ") \
		_T("   FROM hms_fee_refund r,") \
		_T("     hms_fee_refundline l") \
		_T("   WHERE r.hfe_docno           = l.hfe_docno") \
		_T("   AND r.hfe_invoiceno         = l.hfe_invoiceno") \
		_T("   AND l.hfe_invoiceno         > 0") \
		_T("   AND r.hfe_status            ='P'") \
		_T(" UNION ALL ") \

		_T(" SELECT r.hfe_cash_id,") \
		_T("     r.hfe_patientno,") \
		_T("     r.hfe_docno,") \
		_T("     r.hfe_deptid,") \
		_T("     r.hfe_refidx,") \
		_T("     r.hfe_invoiceno,") \
		_T("     0  trichtamgui,") \
		_T("     0   AS cackhoanphaithu,") \
		_T("     0   AS miengiam,") \
		_T("     0   AS tienthuoc,") \
		_T("     0   AS tienvattu,") \
		_T("     0   AS maycnc,") \
		_T("     0   AS hfe_packageamount,") \
		_T("     0   AS chtravp,") \
		_T("     0  AS tl_vienphi,") \
		_T("     0  AS tl_tienthuoc,") \
		_T("     0  AS tl_tienvattu,") \
		_T("     0 AS tl_maycnc,") \
		_T("     (SELECT COALESCE(SUM(hfe_cost), 0) ") \
		_T("     FROM hms_fee_refundline l  ") \
		_T("     WHERE l.hfe_invoiceno = r.hfe_invoiceno ") \
		_T("     AND l.hfe_docno = r.hfe_docno ") \
		_T("     AND l.hfe_itemid IN ('18', '19', '20')) chi_goidv,") \
		_T("     0 AS tl_trichtamthu") \
		_T("   FROM hms_fee_refund r,") \
		_T("     hms_fee_refundline l") \
		_T("   WHERE r.hfe_docno   = l.hfe_docno") \
		_T("   AND r.hfe_invoiceno = l.hfe_invoiceno") \
		_T("   AND l.hfe_invoiceno > 0") \
		_T("   AND r.hfe_status    ='P'") \
		_T(" UNION ALL ") \


		_T(" SELECT hfe_cash_id,") \
		_T("   hfe_patientno,") \
		_T("   hfe_docno,") \
		_T("   hfe_deptid,") \
		_T("   hfe_refidx,") \
		_T("   hfe_invoiceno,") \
		_T("   0 AS trichtamgui,") \
		_T("   0 AS cackhoanphaithu,") \
		_T("   0 AS miengiam,") \
		_T("   0 AS tienthuoc,") \
		_T("   0 AS tienvattu,") \
		_T("   0 AS maycnc,") \
		_T("   0            AS hfe_packageamount,") \
		_T("   0 AS chtravp,") \
		_T("   hfe_amount AS tl_vienphi,") \
		_T("   0 AS tl_tienthuoc,") \
		_T("   0 AS tl_tienvattu,") \
		_T("   0 AS tl_maycnc,0  AS chi_goidv,") \
		_T("   0 AS tl_trichtamthu") \
		_T(" FROM hms_fee_refund") \
		_T(" WHERE hfe_type in('G','S') AND (hfe_isreq <> 'Y' AND hfe_refidx <> 0)") \
		_T(" AND hfe_status='P'") \
		_T(" UNION ALL") \
		_T("   SELECT hfe_cash_id,") \
		_T("     hfe_patientno,") \
		_T("     hfe_docno,") \
		_T("     hfe_deptid,") \
		_T("     hfe_refidx,") \
		_T("     hfe_invoiceno,") \
		_T("     0          AS trichtamgui,") \
		_T("     0          AS cackhoanphaithu,") \
		_T("     0          AS miengiam,") \
		_T("     0          AS tienthuoc,") \
		_T("     0          AS tienvattu,") \
		_T("     0          AS maycnc,") \
		_T("     0          AS hfe_packageamount,") \
		_T("     0          AS chtravp,") \
		_T("     hfe_amount AS tl_vienphi,") \
		_T("     0          AS tl_tienthuoc,") \
		_T("     0          AS tl_tienvattu,") \
		_T("     0          AS tl_maycnc,0  AS chi_goidv,") \
		_T("     0          AS tl_trichtamthu") \
		_T("   FROM hms_fee_refund") \
		_T("   WHERE hfe_type             IN('V')") \
		_T("   AND hfe_status              ='P'") \
		_T("   ) tblInvoice ON(fac_cash_id = cash_id)") \
		_T(" WHERE 1=1 %s ") \
		_T(" GROUP BY cash_id,") \
		_T(" hfe_deptid, ") \
		_T("   hfe_docno,") \
		_T("   fac_user_id,") \
		_T("   fac_invoiceno") \
		_T(" ORDER BY fac_user_id,") \
		_T("   fac_invoiceno"), szWhere);

	nCount = rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		if (nCount < 0)
			_msg(_T("%s"), szSQL);
		else
			_fmsg(_T("%s"), szSQL);
		AfxMessageBox(_T("No Data"));
		return;
	}
	for (int i = 0; i < 19; i++)
		nTotal[i] = 0;
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ReportDate"), tmpStr);
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rs.GetValue(_T("cash_id"), nCashID);
		if (nOldCashID != nCashID)
		{
			szSQL.Format(_T("SELECT fac_invoiceno, TO_CHAR(fac_invoicedate,'DD/MM/YYYY') as invoicedate, fac_user_id FROM fa_cash WHERE fac_cash_id=%ld "), nCashID);
			rsx.ExecSQL(szSQL);
			rsx.GetValue(_T("fac_invoiceno"), szInvoiceNo);
			rsx.GetValue(_T("invoicedate"), szInvoiceDate);
			rsx.GetValue(_T("fac_user_id"), szUserID);
			tmpStr.Format(_T("S\x1ED1 phi\x1EBFu [%s] Ng\xE0y [%s] Ng\x1B0\x1EDDi chi [%s]"), szInvoiceNo, szInvoiceDate, szUserID);
			CReportSection* grp = NULL;
			grp = rpt.GetGroupHeader(1);
			if (grp)
			{
				rptDetail = rpt.AddDetail(grp);
				rptDetail->SetValue(_T("GroupName"), tmpStr);
			}
			nOldCashID = nCashID;

		}
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("pname")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("docno")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("deptid")));

			rs.GetValue(_T("invoice_deposit"), nTmp);
			nTotal[0] += nTmp;
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("invoice_deposit")));

			rs.GetValue(_T("invoice_amount"), nTmp);
			nTotal[1] += nTmp;
			rptDetail->SetValue(_T("6"), rs.GetValue(_T("invoice_amount")));

			rs.GetValue(_T("fa"), nTmp);
			nTotal[2] += nTmp;
			rptDetail->SetValue(_T("7"), rs.GetValue(_T("fa")));

			rs.GetValue(_T("invoice_drug"), nTmp);
			nTotal[3] += nTmp;
			rptDetail->SetValue(_T("8"), rs.GetValue(_T("invoice_drug")));

			rs.GetValue(_T("invoice_material"), nTmp);
			nTotal[4] += nTmp;
			rptDetail->SetValue(_T("9"), rs.GetValue(_T("invoice_material")));

			rs.GetValue(_T("cnc_amount"), nTmp);
			nTotal[5] += nTmp;
			rptDetail->SetValue(_T("10"), rs.GetValue(_T("cnc_amount")));

			rs.GetValue(_T("thu_goidv"), nTmp);
			nTotal[6] += nTmp;
			rptDetail->SetValue(_T("11"), rs.GetValue(_T("thu_goidv")));


			rs.GetValue(_T("patient_return"), nTmp);
			nTotal[7] += nTmp;
			rptDetail->SetValue(_T("12"), rs.GetValue(_T("patient_return")));


			rs.GetValue(_T("fee_return"), nTmp);
			nTotal[8] += nTmp;
			rptDetail->SetValue(_T("13"), rs.GetValue(_T("fee_return")));

			rs.GetValue(_T("drug_return"), nTmp);
			nTotal[9] += nTmp;
			rptDetail->SetValue(_T("14"), rs.GetValue(_T("drug_return")));

			rs.GetValue(_T("material_return"), nTmp);
			nTotal[10] += nTmp;
			rptDetail->SetValue(_T("15"), rs.GetValue(_T("material_return")));

			rs.GetValue(_T("cnc_return"), nTmp);
			nTotal[11] += nTmp;
			rptDetail->SetValue(_T("16"), rs.GetValue(_T("cnc_return")));

			rs.GetValue(_T("chi_goidv"), nTmp);
			nTotal[12] += nTmp;
			rptDetail->SetValue(_T("17"), rs.GetValue(_T("chi_goidv")));

			rs.GetValue(_T("total_return"), nTmp);
			nTotal[13] += nTmp;
			rptDetail->SetValue(_T("18"), rs.GetValue(_T("total_return")));

		}
		rs.MoveNext();
	}
	rptFooter = rpt.GetGroupFooter(1);
	if (rptFooter)
	{
		rptDetail = rpt.AddDetail(rptFooter);
	}
	else
	{
		rptDetail = rpt.GetReportFooter();

	}
	if (rptDetail)
	{
		for (int i = 0; i < 19; i++)
		{
			szPos.Format(_T("s%d"), i + 5);
			tmpStr.Format(_T("%f"), nTotal[i]);
			rptDetail->SetValue(szPos, tmpStr);
		}
	}
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.GetReportFooter()->SetValue(_T("User"), szUser);

	CString szValue;
	szValue.Format(_T("%.3f"), nTotal[13]);
	MoneyToString(szValue, tmpStr);
	tmpStr.AppendFormat(_T(" \x111\x1ED3ng."));
	rpt.GetReportFooter()->SetValue(_T("SuminWords"), tmpStr);


	rpt.PrintPreview();
	return;
	szSQL.Format(_T(" SELECT    doc_no, ") \
		_T("           Get_patientname(doc_no) patient_name, ") \
		_T("           dept_id dept_name, ") \
		_T("           SUM(invoice_deposit) invoice_deposit, ") \
		_T("           SUM(pat_paid + fa) pat_paid, ") \
		_T("           SUM(invoice_drug) invoice_drug, ") \
		_T("           SUM(invoice_material) invoice_material, ") \
		_T("           SUM(invoice_amount - fa) invoice_amount, ") \
		_T("		   SUM(fa) fa,") \
		_T("           SUM(hitech_return) hitech_return, ") \
		_T("           SUM(test_return) test_return, ") \
		_T("           SUM(drug_return) drug_return, ") \
		_T("           SUM(material_return) material_return, ") \
		_T("           SUM(pat_paid + fa + hitech_return + test_return ") \
		_T("               + drug_return + material_return) total_return ") \
		_T(" FROM      ( ") \
		_T("           SELECT rf.hfe_cash_id cash_id, ") \
		_T("				  rf.hfe_staff clerk,") \
		_T("				  rf.hfe_date invoice_date,") \
		_T("                  rf.hfe_docno doc_no, ") \
		_T("				  rf.hfe_objectid object_id,") \
		_T("                  rf.hfe_deptid dept_id, ") \
		_T("                  i.hfe_deposit invoice_deposit, ") \
		_T("                  CASE WHEN i.hfe_deposit > i.hfe_amount THEN i.hfe_deposit - i.hfe_amount ") \
		_T("                  ELSE 0 ") \
		_T("                  END pat_paid, ") \
		_T("                  0 invoice_drug, ") \
		_T("                  0 invoice_material, ") \
		_T("                  0 invoice_amount, ") \
		_T("				  hfe_freeamount fa, ") \
		_T("                  0 hitech_return, ") \
		_T("                  0 test_return, ") \
		_T("                  0 drug_return, ") \
		_T("                  0 material_return, ") \
		_T("                  rf. hfe_class invoice_class ") \
		_T("           FROM   hms_fee_refund rf ") \
		_T("		   LEFT JOIN hms_fee_invoice i ON (rf.hfe_refidx = i.hfe_invoiceno AND rf.hfe_docno = i.hfe_docno)") \
		_T("		   WHERE rf.hfe_type = 'F' AND rf.hfe_status = 'P'") \
		_T("           UNION ALL ") \
		_T("           SELECT    rf.hfe_cash_id cash_id, ") \
		_T("					 rf.hfe_staff,") \
		_T("					 rf.hfe_date,") \
		_T("                     rf.hfe_docno doc_no, ") \
		_T("					 rf.hfe_objectid,") \
		_T("                     rf.hfe_deptid dept_id, ") \
		_T("                     0 invoice_deposit, ") \
		_T("                     0 pat_paid, ") \
		_T("                     CASE WHEN i.hfe_class <> 'I' AND product_org_id = 'PM' THEN f.hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END invoice_drug, ") \
		_T("                     CASE WHEN i.hfe_class <> 'I' AND product_org_id = 'MA' THEN f.hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END invoice_material, ") \
		_T("                     CASE WHEN i.hfe_class = 'I' THEN f.hfe_cost ") \
		_T("                     ELSE ") \
		_T("                         CASE WHEN f.hfe_type NOT IN ( 'D', 'M' ) THEN f.hfe_cost ") \
		_T("                         ELSE 0 ") \
		_T("                         END ") \
		_T("                     END invoice_amount, ") \
		_T("				     0,") \
		_T("                     0 hitech, ") \
		_T("                     0 test_return, ") \
		_T("                     0 drug_return, ") \
		_T("                     0 material_return, ") \
		_T("                     i.hfe_class invoice_class ") \
		_T("           FROM      hms_fee_refund rf") \
		_T("		   LEFT JOIN hms_fee_invoice i ON (rf.hfe_refidx = i.hfe_invoiceno AND rf.hfe_docno = i.hfe_docno)") \
		_T("           LEFT JOIN hms_fee f ON ( i.hfe_docno = f.hfe_docno AND i.hfe_invoiceno = f.hfe_invoiceno ) ") \
		_T("           LEFT JOIN m_productitem_view ON ( Cast (product_item_id AS NVARCHAR2(15)) = f.hfe_itemid ) ") \
		_T("		   WHERE rf.hfe_status = 'P' AND rf.hfe_type = 'F' AND f.hfe_category <> 'Y'") \
		_T("           UNION ALL ") \
		_T("           SELECT    rf.hfe_cash_id cash_id, ") \
		_T("					 rf.hfe_staff,") \
		_T("					 rf.hfe_date,") \
		_T("                     rf.hfe_docno doc_no, ") \
		_T("					 rf.hfe_objectid,") \
		_T("                     i.hfe_deptid dept_id, ") \
		_T("                     0 invoice_deposit, ") \
		_T("                     0 pat_paid, ") \
		_T("                     0 invoice_drug, ") \
		_T("                     0 invoice_material, ") \
		_T("                     0 invoice_amount, ") \
		_T("					 0,") \
		_T("                     CASE WHEN Nvl(hfl_hitechmachine, 'N') = 'Y' THEN hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END hitech_return, ") \
		_T("                     CASE WHEN Nvl(product_org_id, 'XX') NOT IN ( 'PM', 'MA' ) AND Nvl(hfl_hitechmachine, 'N') <> 'Y' THEN hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END test_return, ") \
		_T("                     CASE WHEN product_org_id = 'PM' THEN hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END drug_return, ") \
		_T("                     CASE WHEN product_org_id = 'MA' THEN hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END material_return, ") \
		_T("                     hfe_class invoice_class ") \
		_T("           FROM      hms_fee_refund rf ") \
		_T("           LEFT JOIN hms_fee_refundline rfl ON ( rf.hfe_docno = rfl.hfe_docno AND rf.hfe_invoiceno = rfl.hfe_invoiceno ) ") \
		_T("           LEFT JOIN hms_fee_invoice i ON ( i.hfe_docno = rf.hfe_docno AND i.hfe_invoiceno = rf.hfe_refidx ) ") \
		_T("           LEFT JOIN hms_fee_list ON ( hfl_feeid = hfe_itemid ) ") \
		_T("           LEFT JOIN m_productitem_view ON ( Cast (product_item_id AS NVARCHAR2(15)) = hfe_itemid ) ") \
		_T("           WHERE     rf.hfe_status = 'P' AND rf.hfe_type = 'E' ") \
		_T("            UNION ALL ") \
		_T("            SELECT    rf.hfe_cash_id, ") \
		_T("					  rf.hfe_staff,") \
		_T("					  rf.hfe_date,") \
		_T("                      rf.hfe_docno, ") \
		_T("					  rf.hfe_objectid,") \
		_T("                      d.hfe_deptid, ") \
		_T("                      d.hfe_amount, ") \
		_T("                      0, ") \
		_T("                      0, ") \
		_T("                      0, ") \
		_T("                      0, ") \
		_T("					  0, ") \
		_T("                      0, ") \
		_T("                      d.hfe_amount, ") \
		_T("                      0, ") \
		_T("                      0, ") \
		_T("                      d.hfe_class ") \
		_T("            FROM      hms_fee_refund rf ") \
		_T("            LEFT JOIN hms_fee_deposit d ON ( rf.hfe_docno = d.hfe_docno AND rf.hfe_refidx = d.hfe_invoiceno ) ") \
		_T("            WHERE     d.hfe_status = 'R') tbl") \
		_T(" WHERE     1=1 %s") \
		_T(" GROUP     BY doc_no,dept_id,invoice_class ") \
		_T(" HAVING    SUM(pat_paid + fa+ hitech_return + test_return ") \
		_T("               + drug_return + material_return) > 0 ") \
		_T(" ORDER     BY doc_no "), szWhere);

	nCount = rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		if (nCount < 0)
			_msg(_T("%s"), szSQL);
		else
			_fmsg(_T("%s"), szSQL);
		AfxMessageBox(_T("No Data"));
		return;
	}
	for (int i = 0; i < 10; i++)
		nTotal[i] = 0;
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ReportDate"), tmpStr);
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("patient_name")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("doc_no")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("dept_name")));
			rs.GetValue(_T("invoice_deposit"), nTmp);
			nTotal[0] += nTmp;
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("invoice_deposit")));
			rs.GetValue(_T("invoice_amount"), nTmp);
			nTotal[1] += nTmp;
			rptDetail->SetValue(_T("6"), rs.GetValue(_T("invoice_amount")));
			rs.GetValue(_T("fa"), nTmp);
			nFa += nTmp;
			rptDetail->SetValue(_T("6.1"), rs.GetValue(_T("fa")));
			rs.GetValue(_T("invoice_drug"), nTmp);
			nTotal[2] += nTmp;
			rptDetail->SetValue(_T("7"), rs.GetValue(_T("invoice_drug")));
			rs.GetValue(_T("invoice_material"), nTmp);
			nTotal[3] += nTmp;
			rptDetail->SetValue(_T("8"), rs.GetValue(_T("invoice_material")));
			rs.GetValue(_T("pat_paid"), nTmp);
			nTotal[4] += nTmp;
			rptDetail->SetValue(_T("9"), rs.GetValue(_T("pat_paid")));
			rs.GetValue(_T("hitech_return"), nTmp);
			nTotal[5] += nTmp;
			rptDetail->SetValue(_T("10"), rs.GetValue(_T("hitech_return")));
			rs.GetValue(_T("test_return"), nTmp);
			nTotal[6] += nTmp;
			rptDetail->SetValue(_T("11"), rs.GetValue(_T("test_return")));
			rs.GetValue(_T("drug_return"), nTmp);
			nTotal[7] += nTmp;
			rptDetail->SetValue(_T("12"), rs.GetValue(_T("drug_return")));
			rs.GetValue(_T("material_return"), nTmp);
			nTotal[8] += nTmp;
			rptDetail->SetValue(_T("13"), rs.GetValue(_T("material_return")));
			rs.GetValue(_T("total_return"), nTmp);
			nTotal[9] += nTmp;
			rptDetail->SetValue(_T("14"), rs.GetValue(_T("total_return")));
		}
		rs.MoveNext();
	}
	rptFooter = rpt.GetReportFooter();
	if (rptFooter)
	{
		for (int i = 0; i < 10; i++)
		{
			szPos.Format(_T("s%d"), i + 5);
			tmpStr.Format(_T("%f"), nTotal[i]);
			rptFooter->SetValue(szPos, tmpStr);
		}
		tmpStr.Format(_T("%f"), nFa);
		rptFooter->SetValue(_T("s6.1"), tmpStr);
	}
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.GetReportFooter()->SetValue(_T("User"), szUser);
	rpt.PrintPreview();

}




void CPrintForms::FM_OnPrintInsuranceIncomeList2(CString szReceiptIDStr) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CString tmpStr, szTemp, szPos;
	CString szSysDate;


	CString szSQL, szWhere;
	CString szDepts, szObjects, szReceiptStr, szIESQL, szOutpatientSQL, szOrderBy;

	szWhere.Format(_T(" AND cash_id IN (%s)"), szReceiptIDStr);
	szOrderBy = _T(" ORDER BY patient_name ");

	szIESQL.Format(_T(" SELECT    i.hfe_docno doc_no, ") \
		_T("		   NVL(i.hfe_general_rank, 'N') general_rank,") \
		_T("           i.hfe_deptid dept_id, ") \
		_T("		   i.hfe_date invoice_date,") \
		_T("		   hcr_admitdate admit_date,") \
		_T("           Get_patientname(i.hfe_docno) patient_name, ") \
		_T("           i.hfe_deposit deposit, ") \
		_T("           i.hfe_amount total_amount, ") \
		_T("           i.hfe_discount inspaid, ") \
		_T("           i.hfe_inspaid - i.hfe_discount pat_paid, ") \
		_T("           f.fee_food, ") \
		_T("		   i.hfe_otherpaid other_paid,") \
		_T("		   CASE WHEN i.hfe_type = 'O' THEN hfe_amount ELSE 0 END other_receipt,") \
		_T("		   i.hfe_freeamount fa,") \
		_T("           CASE WHEN is_scoliosis > 0 THEN l_diffcost ELSE f.diff_cost END diff_cost, ") \
		_T("           i.hfe_patpaid total_patpaid, ") \
		_T("           i.hfe_payment receipt_amount, ") \
		_T("		   hc_cardno card_no,") \
		_T("		   i.hfe_status invoice_status,") \
		_T("		   NVL(hd_outpatient, 'N') is_outpatient,") \
		_T("		   i.hfe_objectid object_id,") \
		_T("		   i.hfe_cash_id cash_id,") \
		_T("		   i.hfe_lockeddate locked_date,") \
		_T("		   i.hfe_payment payment,") \
		_T("		   hcr_status as  clinical_status,") \
		_T("		   i.hfe_staff staff") \
		_T(" FROM      hms_fee_invoice i ") \
		_T(" LEFT JOIN hms_doc ON ( hd_docno = i.hfe_docno ) ") \
		_T(" LEFT JOIN hms_card ON ( hd_patientno = hc_patientno AND hd_cardidx = hc_idx ) ") \
		_T(" LEFT JOIN hms_clinical_record ON (hcr_docno = hd_docno)") \
		_T(" LEFT JOIN (SELECT hfe_docno, ") \
		_T("                   hfe_invoiceno, ") \
		_T("                   SUM(CASE WHEN hfe_type = 'F' THEN hfe_patpaid ") \
		_T("                       ELSE 0 ") \
		_T("                       END) fee_food, ") \
		_T("                   SUM(CASE WHEN hfe_type = 'F' THEN 0 ") \
		_T("                       ELSE ") \
		_T("                           CASE WHEN hfe_discount = 0 THEN hfe_patpaid ") \
		_T("                           ELSE ") \
		_T("							CASE WHEN hfe_feegroup IN ('OPT_L', 'HITECH_L') AND hfe_type <> 'V' THEN 0 ") \
		_T("								ELSE hfe_diffcost ") \
		_T("							END") \
		_T("                           END ") \
		_T("                       END) diff_cost, ") \
		_T("				   SUM(CASE WHEN NVL(ho_scoliosis, 'N') = 'Y' THEN 1 ELSE 0 END) is_scoliosis,") \
		_T("				   SUM(CASE WHEN hfe_type = 'V' THEN hfe_diffcost ELSE 0 END) l_diffcost") \
		_T("            FROM   hms_fee ") \
		_T("			LEFT JOIN hms_operation ON (ho_docno = hfe_docno AND ho_idx = hfe_orderid)") \
		_T("            WHERE  hfe_category <> 'Y' AND hfe_status IN ('P', 'R')") \
		_T("            GROUP  BY hfe_docno,hfe_invoiceno) f ON ( i.hfe_docno = f.hfe_docno AND i.hfe_invoiceno = f.hfe_invoiceno ) ") \
		_T(" WHERE NVL(hd_outpatient, 'N') <> 'Y' "));

	//Dieu tri ngoai tru trong khoa
	szOutpatientSQL.Format(_T(" SELECT    i.hfe_docno doc_no, ") \
		_T("		   NVL(i.hfe_general_rank, 'N'),") \
		_T("           i.hfe_deptid dept_id, ") \
		_T("		   i.hfe_date invoice_date,") \
		_T("		   htr_admitdate admit_date,") \
		_T("           Get_patientname(i.hfe_docno) patient_name, ") \
		_T("           i.hfe_deposit deposit, ") \
		_T("           i.hfe_amount total_amount, ") \
		_T("           i.hfe_discount inspaid, ") \
		_T("           i.hfe_inspaid - i.hfe_discount pat_paid, ") \
		_T("           f.fee_food, ") \
		_T("		   i.hfe_otherpaid,") \
		_T("		   CASE WHEN i.hfe_type = 'O' THEN hfe_amount ELSE 0 END other_receipt,") \
		_T("		   i.hfe_freeamount,") \
		_T("           CASE WHEN is_scoliosis > 0 THEN l_diffcost ELSE f.diff_cost END diff_cost, ") \
		_T("           i.hfe_patpaid total_patpaid, ") \
		_T("           i.hfe_payment receipt_amount, ") \
		_T("		   hc_cardno card_no,") \
		_T("		   i.hfe_status invoice_status,") \
		_T("		   NVL(hd_outpatient, 'N') is_outpatient,") \
		_T("		   i.hfe_objectid object_id,") \
		_T("		   i.hfe_cash_id cash_id,") \
		_T("		   i.hfe_lockeddate locked_date,") \
		_T("		   i.hfe_payment payment,") \
		_T("		   htr_status clinical_status,") \
		_T("		   i.hfe_staff staff") \
		_T(" FROM      hms_fee_invoice i ") \
		_T(" LEFT JOIN hms_doc ON ( hd_docno = i.hfe_docno ) ") \
		_T(" LEFT JOIN hms_card ON ( hd_patientno = hc_patientno AND hd_cardidx = hc_idx ) ") \
		_T(" LEFT JOIN hms_treatment_record ON (htr_docno = hd_docno AND htr_treattime = i.hfe_treattime)") \
		_T(" LEFT JOIN (SELECT hfe_docno, ") \
		_T("                   hfe_invoiceno, ") \
		_T("                   SUM(CASE WHEN hfe_type = 'F' THEN hfe_patpaid ") \
		_T("                       ELSE 0 ") \
		_T("                       END) fee_food, ") \
		_T("                   SUM(CASE WHEN hfe_type = 'F' THEN 0 ") \
		_T("                       ELSE ") \
		_T("                           CASE WHEN hfe_discount = 0 THEN hfe_patpaid ") \
		_T("                           ELSE ") \
		_T("							CASE WHEN hfe_feegroup IN ('OPT_L', 'HITECH_L') AND hfe_type <> 'V' THEN 0 ") \
		_T("								ELSE hfe_diffcost ") \
		_T("							END ") \
		_T("						   END ") \
		_T("					   END) diff_cost, ") \
		_T("				   SUM(CASE WHEN NVL(ho_scoliosis, 'N') = 'Y' THEN 1 ELSE 0 END) is_scoliosis,") \
		_T("				   SUM(CASE WHEN hfe_type = 'V' THEN hfe_diffcost ELSE 0 END) l_diffcost") \
		_T("            FROM   hms_fee ") \
		_T("			LEFT JOIN hms_operation ON (ho_docno = hfe_docno AND ho_idx = hfe_orderid)") \
		_T("            WHERE  hfe_category <> 'Y' AND hfe_status IN ('P', 'R')") \
		_T("            GROUP  BY hfe_docno,hfe_invoiceno) f ON ( i.hfe_docno = f.hfe_docno AND i.hfe_invoiceno = f.hfe_invoiceno ) ") \
		_T(" WHERE NVL(hd_outpatient, 'N') = 'Y'"));

	szSQL.Format(_T("SELECT * FROM (%s UNION ALL %s) WHERE 1=1 %s %s"), szIESQL, szOutpatientSQL, szWhere, szOrderBy);


	pMF->BeginWaitCursor();
	int nCount = rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		if (nCount < 0)
			_msg(_T("%s"), szSQL);
		else
			_fmsg(_T("%s"), szSQL);
		ShowMessageBox(_T("No Data"), MB_OK | MB_ICONERROR);
		return;
	}

	if (!rpt.Init(_T("Reports/HMS/HF_BANGKETHANHTOANTHUBENHNHANBHYT.RPT")))
		return;
	StringUpper(pMF->m_szHealthService, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), tmpStr);

	StringUpper(pMF->m_szHospitalName, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), tmpStr);

	tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("ReportDate")),
		CDateTime::Convert(m_szFromDate, yyyymmdd | hhmm, ddmmyyyy | hhmm),
		CDateTime::Convert(m_szToDate, yyyymmdd | hhmm, ddmmyyyy | hhmm));

	rpt.GetReportHeader()->SetValue(_T("ReportDate"), tmpStr);

	CReportSection* rptDetail = NULL, * rptTmp = NULL;
	CString szOldLine, szNewLine;
	CStringArray arrField;
	double nTotal[9], nGrpTotal[9], nGrpFa = 0, nGrpOtherReceipt = 0, nTotalFa = 0, nTotalOtherReceipt = 0;
	double nCost = 0, nFa = 0, nOther_receipt = 0;
	int nIndex = 1;

	for (int i = 0; i < 9; i++)
	{
		nTotal[i] = 0;
		nGrpTotal[i] = 0;
	}
	/*arrField.Add(_T("patient_name"));
	arrField.Add(_T("doc_no"));
	arrField.Add(_T("admit_date"));*/
	arrField.Add(_T("deposit"));
	arrField.Add(_T("total_amount"));
	arrField.Add(_T("inspaid"));
	arrField.Add(_T("pat_paid"));
	arrField.Add(_T("diff_cost"));
	arrField.Add(_T("fee_food"));
	arrField.Add(_T("other_paid"));
	arrField.Add(_T("total_patpaid"));
	arrField.Add(_T("receipt_amount"));
	while (!rs.IsEOF())
	{

		rptDetail = rpt.AddDetail();

		tmpStr.Format(_T("%d"), nIndex++);
		rptDetail->SetValue(_T("1"), tmpStr);

		rs.GetValue(_T("patient_name"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);

		rs.GetValue(_T("doc_no"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);

		rs.GetValue(_T("invoice_date"), tmpStr);
		rptDetail->SetValue(_T("4.1"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

		rs.GetValue(_T("admit_date"), tmpStr);
		rptDetail->SetValue(_T("4"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

		for (int j = 0; j < 9; j++)
		{
			rs.GetValue(arrField.GetAt(j), nCost);
			nGrpTotal[j] += nCost;
			FormatCurrency(nCost, tmpStr);
			szTemp.Format(_T("%d"), j + 5);
			rptDetail->SetValue(szTemp, tmpStr);
		}
		//Thu khac, mien giam
		rs.GetValue(_T("other_receipt"), nCost);
		nGrpOtherReceipt += nCost;
		FormatCurrency(nCost, tmpStr);
		rptDetail->SetValue(_T("11.1"), tmpStr);
		rs.GetValue(_T("fa"), nCost);
		nGrpFa += nCost;
		FormatCurrency(nCost, tmpStr);
		rptDetail->SetValue(_T("11.3"), tmpStr);
		rs.MoveNext();
	}

	if (nGrpTotal[8] > 0)
	{
		rptTmp = rpt.AddDetail(rpt.GetGroupFooter(1));
		if (rptTmp)
		{
			for (int i = 0; i < 9; i++)
			{
				szPos.Format(_T("s%d"), i + 5);
				tmpStr.Format(_T("%f"), nGrpTotal[i]);
				rptTmp->SetValue(szPos, tmpStr);
				nTotal[i] += nGrpTotal[i];
				nGrpTotal[i] = 0;
			}
			tmpStr.Format(_T("%f"), nGrpOtherReceipt);
			rptTmp->SetValue(_T("s11.1"), tmpStr);
			nTotalOtherReceipt += nGrpOtherReceipt;
			nGrpOtherReceipt = 0;
			tmpStr.Format(_T("%f"), nGrpFa);
			rptTmp->SetValue(_T("s11.3"), tmpStr);
			nTotalFa += nGrpFa;
			nGrpFa = 0;
		}
	}
	if (nTotal[8] > 0)
	{
		for (int i = 0; i < 9; i++)
		{
			//FormatCurrency(nTotal[i], tmpStr);
			tmpStr.Format(_T("%f"), nTotal[i]);
			szTemp.Format(_T("t%d"), i + 5);
			rpt.GetReportFooter()->SetValue(szTemp, tmpStr);
		}
		tmpStr.Format(_T("%f"), nTotalOtherReceipt);
		rpt.GetReportFooter()->SetValue(_T("t11.1"), tmpStr);
		tmpStr.Format(_T("%f"), nTotalFa);
		rpt.GetReportFooter()->SetValue(_T("t11.3"), tmpStr);
	}

	szSysDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	tmpStr.Format(_T("%f"), nTotal[8]);
	rpt.GetReportFooter()->SetValue(_T("TT13"), tmpStr);
	szTemp.Format(_T("%2.f"), nTotal[8]);
	MoneyToString(szTemp, tmpStr);
	tmpStr += _T(" \x111\x1ED3ng.");
	rpt.GetReportFooter()->SetValue(_T("SumInWords"), tmpStr);
	pMF->EndWaitCursor();
	rpt.PrintPreview();
}

void CPrintForms::FM_OnPrintInsuranceOutlayList2(CString szPaymentIDStr) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	/*Declaration Section*/
	CRecord rs(&pMF->m_db), rsx(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL, * rptFooter = NULL;
	double nTmp = 0;
	int nIdx = 1, nCount = 0, nOldCashID = 0, nCashID = 0;
	CString szSQL, szWhere, tmpStr, szPos, szReportName, szDate, szPaymentStr, szUser;
	CString szInvoiceNo, szInvoiceDate, szUserID;

	double nTotal[12];
	double nFa = 0;
	szReportName = _T("Reports\\HMS\\HF_DANHSACHCHITRATIENBENHNHANDICHVUYTE.RPT");
	if (!rpt.Init(szReportName))
		return;
	//Get Report Date
	szSQL.Format(_T("SELECT min(fac_createddate) from_date, max(fac_createddate) to_date FROM fa_cash WHERE fac_cash_id IN (%s)"), szPaymentIDStr);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rs.GetValue(_T("from_date"), m_szFromDate);
		rs.GetValue(_T("to_date"), m_szToDate);
	}
	//Get Receipt String
	szSQL.Format(_T("SELECT fac_invoiceno invoice_no, get_username(fac_user_id) user_name FROM fa_cash WHERE fac_cash_id IN (%s)"), szPaymentIDStr);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF())
	{
		if (!szPaymentStr.IsEmpty())
			szPaymentStr += _T(", ");
		szPaymentStr += rs.GetValue(_T("invoice_no"));
		if (!szUser.IsEmpty())
			szUser += _T(", ");
		szUser += rs.GetValue(_T("user_name"));
		rs.MoveNext();
	}
	szWhere.Format(_T(" AND cash_id IN (%s)"), szPaymentIDStr);
	szSQL.Format(_T(" SELECT cash_id,") \
		_T("   fac_invoiceno AS invoice_no,") \
		_T("   Get_patientname(hfe_docno) as pname, ") \
		_T("   hfe_deptid as deptid, ") \
		_T("   hfe_docno as docno,") \
		_T("   SUM(trichtamgui)                                         AS invoice_deposit,") \
		_T("   SUM(cackhoanphaithu-miengiam-tienthuoc-tienvattu-maycnc) AS invoice_amount,") \
		_T("   SUM(miengiam)                                            AS fa,") \
		_T("   SUM(tienthuoc)                                           AS invoice_drug,") \
		_T("   SUM(tienvattu)                                           AS invoice_material,") \
		_T("   SUM(maycnc)                                              AS cnc_amount,") \
		_T("   SUM(chitravienphi+tl_trichtamthu)                                       AS patient_return,") \
		_T("   SUM(tl_vienphi-tl_thuoc-tl_vattu-tl_cnc)					AS fee_return,") \
		_T("   SUM(tl_thuoc)                                            AS drug_return,") \
		_T("   SUM(tl_vattu)                                            AS material_return,") \
		_T("   SUM(tl_cnc)                                              AS cnc_return,") \
		_T("   SUM(chitravienphi+tl_vienphi+tl_trichtamthu)   AS total_return") \
		_T(" FROM fa_cash") \
		_T(" LEFT JOIN") \
		_T("   (SELECT r.hfe_cash_id AS cash_id,") \
		_T("     i.hfe_patientno,") \
		_T("     i.hfe_docno,") \
		_T("     i.hfe_deptid,") \
		_T("     i.hfe_refidx,") \
		_T("     i.hfe_invoiceno,") \
		_T("     i.hfe_deposit    AS trichtamgui,") \
		_T("     i.hfe_patpaid    AS cackhoanphaithu,") \
		_T("     i.hfe_freeamount AS miengiam,") \
		_T("     CASE") \
		_T("       WHEN i.hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee f") \
		_T("         LEFT JOIN m_product_item") \
		_T("         ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("         WHERE f.hfe_docno     = i.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = i.hfe_invoiceno") \
		_T(" AND f.hfe_status in('P','R') ") \
		_T("         AND f.hfe_type       IN('D','M')") \
		_T("         AND f.hfe_category   <> 'Y'") \
		_T("         AND mpi_org_id        ='PM'") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tienthuoc,") \
		_T("     CASE") \
		_T("       WHEN i.hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee f") \
		_T("         LEFT JOIN m_product_item") \
		_T("         ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("         WHERE f.hfe_docno     = i.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = i.hfe_invoiceno") \
		_T(" AND f.hfe_status in('P','R') ") \
		_T("         AND f.hfe_type       IN('D','M')") \
		_T("         AND f.hfe_category   <> 'Y'") \
		_T("         AND mpi_org_id        ='MA'") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tienvattu,") \
		_T("     (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("     FROM hms_fee f") \
		_T("     LEFT JOIN hms_fee_list") \
		_T("     ON(hfl_feeid                   = hfe_itemid)") \
		_T("     WHERE f.hfe_docno              = i.hfe_docno") \
		_T("     AND f.hfe_invoiceno            = i.hfe_invoiceno") \
		_T(" AND f.hfe_status in('P','R') ") \
		_T("     AND f.hfe_type                IN('P','T','O')") \
		_T("     AND f.hfe_category            <> 'Y'") \
		_T("     AND NVL(hfl_hitechmachine,'N') ='Y'") \
		_T("     )            AS maycnc,") \
		_T("     i.hfe_refund AS chitravienphi,") \
		_T("     0            AS tl_vienphi,") \
		_T("     0            AS tl_thuoc,") \
		_T("     0            AS tl_vattu,") \
		_T("     0            AS tl_cnc, 0 as tl_trichtamthu ") \
		_T("   FROM hms_fee_invoice i") \
		_T(" LEFT JOIN hms_fee_refund r ") \
		_T("   ON(r.hfe_docno      = i.hfe_docno") \
		_T("   AND r.hfe_refidx    =i.hfe_invoiceno and r.hfe_amount=i.hfe_refund)") \
		_T("   WHERE i.hfe_status IN('P','R')") \
		_T("   AND i.hfe_payment  <=0") \
		_T("   AND i.hfe_refund    > 0 and r.hfe_type='F' ") \
		_T(" UNION ALL") \
		_T("   SELECT r.hfe_cash_id,") \
		_T("     r.hfe_patientno,") \
		_T("     r.hfe_docno,") \
		_T("     r.hfe_deptid,") \
		_T("     r.hfe_refidx,") \
		_T("     r.hfe_invoiceno,") \
		_T("     case when l.hfe_itemid is null then l.hfe_patpaid else 0 end             AS trichtamgui,") \
		_T("     0             AS cackhoanphaithu,") \
		_T("     0             AS miengiam,") \
		_T("     0             AS tienthuoc,") \
		_T("     0             AS tienvattu,") \
		_T("     0             AS maycnc,") \
		_T("     0             AS chtravp,") \
		_T("     case when l.hfe_itemid is null then 0 else l.hfe_patpaid end AS tl_vienphi,") \
		_T("     CASE") \
		_T("       WHEN r.hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee_refundline f") \
		_T("         LEFT JOIN m_product_item") \
		_T("         ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("         WHERE f.hfe_docno     = r.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = r.hfe_invoiceno") \
		_T("         AND f.hfe_type       IN('F')") \
		_T("		 AND SUBSTR(f.hfe_group, 1, 1) = 'A' ")\
		_T(" and f.hfe_itemid = l.hfe_itemid ") \
		_T("         AND mpi_org_id        ='PM'") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tl_tienthuoc,") \
		_T("     CASE") \
		_T("       WHEN r.hfe_class <> 'I'") \
		_T("       THEN") \
		_T("         (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("         FROM hms_fee_refundline f") \
		_T("         LEFT JOIN m_product_item") \
		_T("         ON(mpi_product_item_id=CAST(hfe_itemid AS INTEGER) )") \
		_T("         WHERE f.hfe_docno     = r.hfe_docno") \
		_T("         AND f.hfe_invoiceno   = r.hfe_invoiceno") \
		_T("         AND f.hfe_type       IN('F')") \
		_T("		 AND SUBSTR(f.hfe_group, 1, 1) = 'A' ") \
		_T(" and f.hfe_itemid = l.hfe_itemid ") \
		_T("         AND mpi_org_id        ='MA'") \
		_T("         )") \
		_T("       ELSE 0") \
		_T("     END AS tl_tienvattu,") \
		_T("     (SELECT COALESCE(SUM(hfe_patpaid), 0)") \
		_T("     FROM hms_fee_refundline f") \
		_T("     LEFT JOIN hms_fee_list") \
		_T("     ON(hfl_feeid                   = hfe_itemid)") \
		_T("     WHERE f.hfe_docno              = r.hfe_docno") \
		_T("     AND f.hfe_invoiceno            = r.hfe_invoiceno") \
		_T("     AND f.hfe_type                IN('F')") \
		_T(" and f.hfe_itemid = l.hfe_itemid ") \
		_T("     AND NVL(hfl_hitechmachine,'N') ='Y'") \
		_T("     ) AS tl_maycnc, ") \
		_T("     case when l.hfe_itemid is null then l.hfe_patpaid else 0 end  as tl_trichtamthu ") \
		_T("   FROM hms_fee_refund r,") \
		_T("     hms_fee_refundline l") \
		_T("   WHERE r.hfe_docno           = l.hfe_docno") \
		_T("   AND r.hfe_invoiceno         = l.hfe_invoiceno") \
		_T("   AND l.hfe_invoiceno         > 0") \
		_T("   AND r.hfe_status            ='P'") \
		_T(" UNION ALL ") \
		_T(" SELECT hfe_cash_id,") \
		_T("   hfe_patientno,") \
		_T("   hfe_docno,") \
		_T("   hfe_deptid,") \
		_T("   hfe_refidx,") \
		_T("   hfe_invoiceno,") \
		_T("   0 AS trichtamgui,") \
		_T("   0 AS cackhoanphaithu,") \
		_T("   0 AS miengiam,") \
		_T("   0 AS tienthuoc,") \
		_T("   0 AS tienvattu,") \
		_T("   0 AS maycnc,") \
		_T("   0 AS chtravp,") \
		_T("   hfe_amount AS tl_vienphi,") \
		_T("   0 AS tl_tienthuoc,") \
		_T("   0 AS tl_tienvattu,") \
		_T("   0 AS tl_maycnc,") \
		_T("   0 AS tl_trichtamthu") \
		_T(" FROM hms_fee_refund") \
		_T(" WHERE hfe_type in('G','S')") \
		_T(" AND hfe_status='P'") \
		_T("   ) tblInvoice ON(fac_cash_id = cash_id)") \
		_T(" WHERE 1=1 %s ") \
		_T(" GROUP BY cash_id,") \
		_T(" hfe_deptid, ") \
		_T("   hfe_docno,") \
		_T("   fac_user_id,") \
		_T("   fac_invoiceno") \
		_T(" ORDER BY fac_user_id,") \
		_T("   fac_invoiceno"), szWhere);

	nCount = rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		if (nCount < 0)
			_msg(_T("%s"), szSQL);
		else
			_fmsg(_T("%s"), szSQL);
		AfxMessageBox(_T("No Data"));
		return;
	}
	for (int i = 0; i < 12; i++)
		nTotal[i] = 0;
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ReportDate"), tmpStr);
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rs.GetValue(_T("cash_id"), nCashID);
		if (nOldCashID != nCashID)
		{
			szSQL.Format(_T("SELECT fac_invoiceno, TO_CHAR(fac_invoicedate,'DD/MM/YYYY') as invoicedate, fac_user_id FROM fa_cash WHERE fac_cash_id=%ld "), nCashID);
			rsx.ExecSQL(szSQL);
			rsx.GetValue(_T("fac_invoiceno"), szInvoiceNo);
			rsx.GetValue(_T("invoicedate"), szInvoiceDate);
			rsx.GetValue(_T("fac_user_id"), szUserID);
			tmpStr.Format(_T("S\x1ED1 phi\x1EBFu [%s] Ng\xE0y [%s] Ng\x1B0\x1EDDi chi [%s]"), szInvoiceNo, szInvoiceDate, szUserID);
			CReportSection* grp = NULL;
			grp = rpt.GetGroupHeader(1);
			if (grp)
			{
				rptDetail = rpt.AddDetail(grp);
				rptDetail->SetValue(_T("GroupName"), tmpStr);
			}
			nOldCashID = nCashID;

		}
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("pname")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("docno")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("deptid")));
			rs.GetValue(_T("invoice_deposit"), nTmp);
			nTotal[0] += nTmp;
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("invoice_deposit")));
			rs.GetValue(_T("invoice_amount"), nTmp);
			nTotal[1] += nTmp;
			rptDetail->SetValue(_T("6"), rs.GetValue(_T("invoice_amount")));
			rs.GetValue(_T("fa"), nTmp);
			nTotal[2] += nTmp;
			rptDetail->SetValue(_T("7"), rs.GetValue(_T("fa")));
			rs.GetValue(_T("invoice_drug"), nTmp);
			nTotal[3] += nTmp;
			rptDetail->SetValue(_T("8"), rs.GetValue(_T("invoice_drug")));
			rs.GetValue(_T("invoice_material"), nTmp);
			nTotal[4] += nTmp;
			rptDetail->SetValue(_T("9"), rs.GetValue(_T("invoice_material")));
			rs.GetValue(_T("cnc_amount"), nTmp);
			nTotal[5] += nTmp;
			rptDetail->SetValue(_T("10"), rs.GetValue(_T("cnc_amount")));
			rs.GetValue(_T("patient_return"), nTmp);
			nTotal[6] += nTmp;
			rptDetail->SetValue(_T("11"), rs.GetValue(_T("patient_return")));
			rs.GetValue(_T("fee_return"), nTmp);
			nTotal[7] += nTmp;
			rptDetail->SetValue(_T("12"), rs.GetValue(_T("fee_return")));
			rs.GetValue(_T("drug_return"), nTmp);
			nTotal[8] += nTmp;
			rptDetail->SetValue(_T("13"), rs.GetValue(_T("drug_return")));
			rs.GetValue(_T("material_return"), nTmp);
			nTotal[9] += nTmp;
			rptDetail->SetValue(_T("14"), rs.GetValue(_T("material_return")));
			rs.GetValue(_T("cnc_return"), nTmp);
			nTotal[10] += nTmp;
			rptDetail->SetValue(_T("15"), rs.GetValue(_T("cnc_return")));
			rs.GetValue(_T("total_return"), nTmp);
			nTotal[11] += nTmp;
			rptDetail->SetValue(_T("16"), rs.GetValue(_T("total_return")));
		}
		rs.MoveNext();
	}
	rptFooter = rpt.GetGroupFooter(1);
	if (rptFooter)
	{
		rptDetail = rpt.AddDetail(rptFooter);
	}
	else
	{
		rptDetail = rpt.GetReportFooter();

	}
	if (rptDetail)
	{
		for (int i = 0; i < 12; i++)
		{
			szPos.Format(_T("s%d"), i + 5);
			tmpStr.Format(_T("%f"), nTotal[i]);
			rptDetail->SetValue(szPos, tmpStr);
		}
	}
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.GetReportFooter()->SetValue(_T("User"), szUser);
	rpt.PrintPreview();
	return;
	szSQL.Format(_T(" SELECT    doc_no, ") \
		_T("           Get_patientname(doc_no) patient_name, ") \
		_T("           dept_id dept_name, ") \
		_T("           SUM(invoice_deposit) invoice_deposit, ") \
		_T("           SUM(pat_paid + fa) pat_paid, ") \
		_T("           SUM(invoice_drug) invoice_drug, ") \
		_T("           SUM(invoice_material) invoice_material, ") \
		_T("           SUM(invoice_amount - fa) invoice_amount, ") \
		_T("		   SUM(fa) fa,") \
		_T("           SUM(hitech_return) hitech_return, ") \
		_T("           SUM(test_return) test_return, ") \
		_T("           SUM(drug_return) drug_return, ") \
		_T("           SUM(material_return) material_return, ") \
		_T("           SUM(pat_paid + fa + hitech_return + test_return ") \
		_T("               + drug_return + material_return) total_return ") \
		_T(" FROM      ( ") \
		_T("           SELECT rf.hfe_cash_id cash_id, ") \
		_T("				  rf.hfe_staff clerk,") \
		_T("				  rf.hfe_date invoice_date,") \
		_T("                  rf.hfe_docno doc_no, ") \
		_T("				  rf.hfe_objectid object_id,") \
		_T("                  rf.hfe_deptid dept_id, ") \
		_T("                  i.hfe_deposit invoice_deposit, ") \
		_T("                  CASE WHEN i.hfe_deposit > i.hfe_amount THEN i.hfe_deposit - i.hfe_amount ") \
		_T("                  ELSE 0 ") \
		_T("                  END pat_paid, ") \
		_T("                  0 invoice_drug, ") \
		_T("                  0 invoice_material, ") \
		_T("                  0 invoice_amount, ") \
		_T("				  hfe_freeamount fa, ") \
		_T("                  0 hitech_return, ") \
		_T("                  0 test_return, ") \
		_T("                  0 drug_return, ") \
		_T("                  0 material_return, ") \
		_T("                  rf. hfe_class invoice_class ") \
		_T("           FROM   hms_fee_refund rf ") \
		_T("		   LEFT JOIN hms_fee_invoice i ON (rf.hfe_refidx = i.hfe_invoiceno AND rf.hfe_docno = i.hfe_docno)") \
		_T("		   WHERE rf.hfe_type = 'F' AND rf.hfe_status = 'P'") \
		_T("           UNION ALL ") \
		_T("           SELECT    rf.hfe_cash_id cash_id, ") \
		_T("					 rf.hfe_staff,") \
		_T("					 rf.hfe_date,") \
		_T("                     rf.hfe_docno doc_no, ") \
		_T("					 rf.hfe_objectid,") \
		_T("                     rf.hfe_deptid dept_id, ") \
		_T("                     0 invoice_deposit, ") \
		_T("                     0 pat_paid, ") \
		_T("                     CASE WHEN i.hfe_class <> 'I' AND product_org_id = 'PM' THEN f.hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END invoice_drug, ") \
		_T("                     CASE WHEN i.hfe_class <> 'I' AND product_org_id = 'MA' THEN f.hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END invoice_material, ") \
		_T("                     CASE WHEN i.hfe_class = 'I' THEN f.hfe_cost ") \
		_T("                     ELSE ") \
		_T("                         CASE WHEN f.hfe_type NOT IN ( 'D', 'M' ) THEN f.hfe_cost ") \
		_T("                         ELSE 0 ") \
		_T("                         END ") \
		_T("                     END invoice_amount, ") \
		_T("				     0,") \
		_T("                     0 hitech, ") \
		_T("                     0 test_return, ") \
		_T("                     0 drug_return, ") \
		_T("                     0 material_return, ") \
		_T("                     i.hfe_class invoice_class ") \
		_T("           FROM      hms_fee_refund rf") \
		_T("		   LEFT JOIN hms_fee_invoice i ON (rf.hfe_refidx = i.hfe_invoiceno AND rf.hfe_docno = i.hfe_docno)") \
		_T("           LEFT JOIN hms_fee f ON ( i.hfe_docno = f.hfe_docno AND i.hfe_invoiceno = f.hfe_invoiceno ) ") \
		_T("           LEFT JOIN m_productitem_view ON ( Cast (product_item_id AS NVARCHAR2(15)) = f.hfe_itemid ) ") \
		_T("		   WHERE rf.hfe_status = 'P' AND rf.hfe_type = 'F' AND f.hfe_category <> 'Y'") \
		_T("           UNION ALL ") \
		_T("           SELECT    rf.hfe_cash_id cash_id, ") \
		_T("					 rf.hfe_staff,") \
		_T("					 rf.hfe_date,") \
		_T("                     rf.hfe_docno doc_no, ") \
		_T("					 rf.hfe_objectid,") \
		_T("                     i.hfe_deptid dept_id, ") \
		_T("                     0 invoice_deposit, ") \
		_T("                     0 pat_paid, ") \
		_T("                     0 invoice_drug, ") \
		_T("                     0 invoice_material, ") \
		_T("                     0 invoice_amount, ") \
		_T("					 0,") \
		_T("                     CASE WHEN Nvl(hfl_hitechmachine, 'N') = 'Y' THEN hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END hitech_return, ") \
		_T("                     CASE WHEN Nvl(product_org_id, 'XX') NOT IN ( 'PM', 'MA' ) AND Nvl(hfl_hitechmachine, 'N') <> 'Y' THEN hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END test_return, ") \
		_T("                     CASE WHEN product_org_id = 'PM' THEN hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END drug_return, ") \
		_T("                     CASE WHEN product_org_id = 'MA' THEN hfe_cost ") \
		_T("                     ELSE 0 ") \
		_T("                     END material_return, ") \
		_T("                     hfe_class invoice_class ") \
		_T("           FROM      hms_fee_refund rf ") \
		_T("           LEFT JOIN hms_fee_refundline rfl ON ( rf.hfe_docno = rfl.hfe_docno AND rf.hfe_invoiceno = rfl.hfe_invoiceno ) ") \
		_T("           LEFT JOIN hms_fee_invoice i ON ( i.hfe_docno = rf.hfe_docno AND i.hfe_invoiceno = rf.hfe_refidx ) ") \
		_T("           LEFT JOIN hms_fee_list ON ( hfl_feeid = hfe_itemid ) ") \
		_T("           LEFT JOIN m_productitem_view ON ( Cast (product_item_id AS NVARCHAR2(15)) = hfe_itemid ) ") \
		_T("           WHERE     rf.hfe_status = 'P' AND rf.hfe_type = 'E' ") \
		_T("            UNION ALL ") \
		_T("            SELECT    rf.hfe_cash_id, ") \
		_T("					  rf.hfe_staff,") \
		_T("					  rf.hfe_date,") \
		_T("                      rf.hfe_docno, ") \
		_T("					  rf.hfe_objectid,") \
		_T("                      d.hfe_deptid, ") \
		_T("                      d.hfe_amount, ") \
		_T("                      0, ") \
		_T("                      0, ") \
		_T("                      0, ") \
		_T("                      0, ") \
		_T("					  0, ") \
		_T("                      0, ") \
		_T("                      d.hfe_amount, ") \
		_T("                      0, ") \
		_T("                      0, ") \
		_T("                      d.hfe_class ") \
		_T("            FROM      hms_fee_refund rf ") \
		_T("            LEFT JOIN hms_fee_deposit d ON ( rf.hfe_docno = d.hfe_docno AND rf.hfe_refidx = d.hfe_invoiceno ) ") \
		_T("            WHERE     d.hfe_status = 'R') tbl") \
		_T(" WHERE     1=1 %s") \
		_T(" GROUP     BY doc_no,dept_id,invoice_class ") \
		_T(" HAVING    SUM(pat_paid + fa+ hitech_return + test_return ") \
		_T("               + drug_return + material_return) > 0 ") \
		_T(" ORDER     BY doc_no "), szWhere);

	nCount = rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		if (nCount < 0)
			_msg(_T("%s"), szSQL);
		else
			_fmsg(_T("%s"), szSQL);
		AfxMessageBox(_T("No Data"));
		return;
	}
	for (int i = 0; i < 10; i++)
		nTotal[i] = 0;
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ReportDate"), tmpStr);
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("patient_name")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("doc_no")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("dept_name")));
			rs.GetValue(_T("invoice_deposit"), nTmp);
			nTotal[0] += nTmp;
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("invoice_deposit")));
			rs.GetValue(_T("invoice_amount"), nTmp);
			nTotal[1] += nTmp;
			rptDetail->SetValue(_T("6"), rs.GetValue(_T("invoice_amount")));
			rs.GetValue(_T("fa"), nTmp);
			nFa += nTmp;
			rptDetail->SetValue(_T("6.1"), rs.GetValue(_T("fa")));
			rs.GetValue(_T("invoice_drug"), nTmp);
			nTotal[2] += nTmp;
			rptDetail->SetValue(_T("7"), rs.GetValue(_T("invoice_drug")));
			rs.GetValue(_T("invoice_material"), nTmp);
			nTotal[3] += nTmp;
			rptDetail->SetValue(_T("8"), rs.GetValue(_T("invoice_material")));
			rs.GetValue(_T("pat_paid"), nTmp);
			nTotal[4] += nTmp;
			rptDetail->SetValue(_T("9"), rs.GetValue(_T("pat_paid")));
			rs.GetValue(_T("hitech_return"), nTmp);
			nTotal[5] += nTmp;
			rptDetail->SetValue(_T("10"), rs.GetValue(_T("hitech_return")));
			rs.GetValue(_T("test_return"), nTmp);
			nTotal[6] += nTmp;
			rptDetail->SetValue(_T("11"), rs.GetValue(_T("test_return")));
			rs.GetValue(_T("drug_return"), nTmp);
			nTotal[7] += nTmp;
			rptDetail->SetValue(_T("12"), rs.GetValue(_T("drug_return")));
			rs.GetValue(_T("material_return"), nTmp);
			nTotal[8] += nTmp;
			rptDetail->SetValue(_T("13"), rs.GetValue(_T("material_return")));
			rs.GetValue(_T("total_return"), nTmp);
			nTotal[9] += nTmp;
			rptDetail->SetValue(_T("14"), rs.GetValue(_T("total_return")));
		}
		rs.MoveNext();
	}
	rptFooter = rpt.GetReportFooter();
	if (rptFooter)
	{
		for (int i = 0; i < 10; i++)
		{
			szPos.Format(_T("s%d"), i + 5);
			tmpStr.Format(_T("%f"), nTotal[i]);
			rptFooter->SetValue(szPos, tmpStr);
		}
		tmpStr.Format(_T("%f"), nFa);
		rptFooter->SetValue(_T("s6.1"), tmpStr);
	}
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.GetReportFooter()->SetValue(_T("User"), szUser);
	rpt.PrintPreview();

}


void CPrintForms::FM_OnPrintPolicyIncomeList2(CString szReceiptIDStr) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	/*Declaration Section*/
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL, * rptFooter = NULL;
	CMap<CString, LPCTSTR, CString, LPCTSTR> m_mIndex;
	double nTmp = 0;
	int nIdx = 1;
	CString szSQL, tmpStr, tmpStr2, szPos, szReportName, szDate, szNewLev1, szOldLev1, szNewLev2, szOldLev2, szNewLev3, szOldLev3;
	CString szWhere, szGroupBy;
	double nTotal[10], nGroupTotal1[10], nGroupTotal2[10], nGroupTotal3[10];
	szReportName = _T("Reports\\HMS\\HF_BANGKECHUNGTUGHISOTHUBNBDCS.RPT");
	if (!rpt.Init(szReportName))
		return;
	m_mIndex[_T("I")] = _T("Thu t\x1EA1m g\x1EEDi");
	m_mIndex[_T("II")] = _T("Thu ph\xED ngo\x1EA1i tr\xFA");
	m_mIndex[_T("III")] = _T("Thu th\x61nh to\xE1n r\x61 vi\x1EC7n");
	//Get Report Date
	szSQL.Format(_T("SELECT min(fac_createddate) from_date, max(fac_createddate) to_date FROM fa_cash WHERE fac_cash_id IN (%s)"), szReceiptIDStr);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rs.GetValue(_T("from_date"), m_szFromDate);
		rs.GetValue(_T("to_date"), m_szToDate);
	}
	szWhere.AppendFormat(_T(" AND fac_cash_id IN (%s)"), szReceiptIDStr);

	//if (m_szGroupByKey == _T("01"))
	szGroupBy = _T(" staff, fac_invoiceno");
	/*if (m_szGroupByKey == _T("02"))
		szGroupBy = _T(" dept_id");*/

	szSQL.Format(_T(" SELECT    invoice_class, Get_patientname(hfe_docno) patient_name, ") \
		_T("		   obj_class, staff, fac_invoiceno invoice_no, dept_id,") \
		_T("		   hfe_docno doc_no,") \
		_T("		   (select hp_workplace from hms_patient, hms_doc where hd_patientno = hp_patientno and hd_docno = hfe_docno) work_place,") \
		_T("		   case when patient_type = 'N' then (select hcr_admitdate from hms_clinical_record where hcr_docno = hfe_docno) ") \
		_T("					 else (select max(htr_admitdate) from hms_treatment_record where htr_docno = hfe_docno and htr_treattime = treattime) end admit_date,") \
		_T("		   case when patient_type = 'N' then (select hcr_dischargedate from hms_clinical_record where hcr_docno = hfe_docno) ") \
		_T("					 else (select max(htr_dischargedate) from hms_treatment_record where htr_docno = hfe_docno and htr_treattime = treattime) end discharge_date,") \
		_T("		   SUM(ngay_dt) ngay_dt,") \
		_T("           SUM(trich_tam_gui) trich_tam_gui, ") \
		_T("           SUM(phi_an) phi_an, ") \
		_T("           SUM(thu_chenh - phi_an) phi_ranggia, ") \
		_T("           0 thu_khac, ") \
		_T("		   SUM(thu_chenh + 0) phai_thu,") \
		_T("		   SUM(thu_chenh + 0 - trich_tam_gui) thu_them,") \
		_T("           SUM(tam_gui) tam_gui, ") \
		_T("		   0 thu_khac_,") \
		_T("           SUM(thu_chenh + 0 - trich_tam_gui + tam_gui + 0) tong_thu ") \
		_T(" FROM      (SELECT    hfe_cash_id cash_id, hfe_staff staff, hfe_deptid dept_id,") \
		_T("					  (select NVL(hd_outpatient, 'N') from hms_doc where hd_docno = hfe_docno) patient_type,") \
		_T("					  hfe_treattime treattime,") \
		_T("                      hfe_docno, ") \
		_T("					  CASE WHEN hfe_class = 'I' THEN 'III' ELSE 'II' END invoice_class,") \
		_T("					  CASE WHEN hfe_class = 'I' THEN CASE WHEN hfe_objectid = 1 THEN 0 ELSE 1 END ELSE NULL END obj_class,") \
		_T("                      hfe_deposit trich_tam_gui, ") \
		_T("					  hfe_diffcost thu_chenh,") \
		_T("                      (select coalesce(sum(hfe_cost), 0) from hms_fee f where f.hfe_docno = i.hfe_docno and f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_type = 'F' AND NVL(f.hfe_category, 'N') = 'N' AND f.hfe_status NOT IN ('O', 'C')) ") \
		_T("						phi_an, ") \
		_T("					  (select coalesce(sum(hfe_quantity), 0) from hms_fee f where f.hfe_docno = i.hfe_docno and f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_type = 'B' AND f.hfe_status NOT IN ('O', 'C')) ") \
		_T("					    ngay_dt,") \
		_T("                      0 phi_ranggia, ") \
		_T("					  0 tam_gui ") \
		_T("            FROM      hms_fee_invoice i ") \
		_T("            WHERE     hfe_type <> 'O' AND hfe_status NOT IN ('O', 'C') AND hfe_cash_id > 0 ") \
		_T("			AND hfe_payment > 0") \
		_T("		  UNION ALL") \
		_T("		  SELECT   d.hfe_cash_id, d.hfe_staff staff, hfe_deptid dept_id,") \
		_T("				   (select NVL(hd_outpatient, 'N') from hms_doc where hd_docno = d.hfe_docno) patient_type,") \
		_T("				   d.hfe_treattime treattime,") \
		_T("                   d.hfe_docno, ") \
		_T("				   'I' invoice_class,") \
		_T("				   NULL obj_class,") \
		_T("                   0 trich_tam_gui, ") \
		_T("				   0 thu_chenh,") \
		_T("                   0 phi_an, ") \
		_T("				   0 ngay_dt,") \
		_T("                   0 phi_ranggia, ") \
		_T("                   d.hfe_amount tam_gui ") \
		_T("            FROM   hms_fee_deposit d") \
		_T("            WHERE  d.hfe_cash_id > 0 ") \
		_T("			AND d.hfe_status NOT IN ('O', 'C')) tbl ") \
		_T("	LEFT JOIN fa_cash ON ( fac_cash_id = cash_id ) ") \
		_T(" WHERE     1 = 1 %s") \
		_T(" GROUP BY invoice_class, hfe_docno, obj_class, fac_postedby, staff, fac_invoiceno, dept_id, patient_type, treattime") \
		_T(" ORDER BY invoice_class, obj_class, %s"), szWhere, szGroupBy);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	for (int i = 0; i < 10; i++)
	{
		nTotal[i] = 0;
		nGroupTotal1[i] = 0;
		nGroupTotal2[i] = 0;
		nGroupTotal3[i] = 0;
	}
	TCHAR* dat[] = { _T("ngay_dt"), _T("trich_tam_gui"), _T("phi_an"), _T("phi_ranggia"), _T("thu_khac"), _T("phai_thu"),
					_T("thu_them"), _T("tam_gui"), _T("thu_khac_"), _T("tong_thu") };
	int nStart = 7;
	int nSumPos = 10 - 1;
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ReportDate"), tmpStr);
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rs.GetValue(_T("invoice_class"), szNewLev3);
		rs.GetValue(_T("staff"), szNewLev1);
		//if (m_szGroupByKey == _T("02"))
			//rs.GetValue(_T("dept_id"), szNewLev1);
		rs.GetValue(_T("obj_class"), szNewLev2);
		if (szNewLev3 != szOldLev3 && (!szNewLev3.IsEmpty()))
		{
			if (nGroupTotal1[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m:"));
					for (int i = 0; i <= nSumPos; i++)
					{
						szPos.Format(_T("s%d"), i + nStart);
						tmpStr.Format(_T("%f"), nGroupTotal1[i]);
						rptGroup->SetValue(szPos, tmpStr);
						nGroupTotal2[i] += nGroupTotal1[i];
						nGroupTotal1[i] = 0;
					}
				}
			}
			if (nGroupTotal2[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m \x111\x1ED1i t\x1B0\x1EE3ng:"));
					for (int i = 0; i <= nSumPos; i++)
					{
						szPos.Format(_T("s%d"), i + nStart);
						tmpStr.Format(_T("%f"), nGroupTotal2[i]);
						rptGroup->SetValue(szPos, tmpStr);
						nGroupTotal3[i] += nGroupTotal2[i];
						nGroupTotal2[i] = 0;
					}
				}
			}
			if (nGroupTotal3[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m ph\xED:"));
					for (int i = 0; i <= nSumPos; i++)
					{
						szPos.Format(_T("s%d"), i + nStart);
						tmpStr.Format(_T("%f"), nGroupTotal3[i]);
						rptGroup->SetValue(szPos, tmpStr);
						nTotal[i] += nGroupTotal3[i];
						nGroupTotal3[i] = 0;
					}
				}
			}
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
			if (rptGroup)
			{
				rptGroup->GetItem(_T("GroupName"))->SetTextAlign(ES_CENTER);
				m_mIndex.Lookup(szNewLev3, tmpStr);
				rptGroup->SetValue(_T("GroupName"), tmpStr);
			}
			szOldLev3 = szNewLev3;
			szOldLev2.Empty();
			szOldLev1.Empty();
			nIdx = 1;
		}
		if (szNewLev2 != szOldLev2 && (!szNewLev2.IsEmpty()))
		{
			if (nGroupTotal1[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m:"));
					for (int i = 0; i <= nSumPos; i++)
					{
						szPos.Format(_T("s%d"), i + nStart);
						tmpStr.Format(_T("%f"), nGroupTotal1[i]);
						rptGroup->SetValue(szPos, tmpStr);
						nGroupTotal2[i] += nGroupTotal1[i];
						nGroupTotal1[i] = 0;
					}
				}
			}
			if (nGroupTotal2[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m \x111\x1ED1i t\x1B0\x1EE3ng:"));
					for (int i = 0; i <= nSumPos; i++)
					{
						szPos.Format(_T("s%d"), i + nStart);
						tmpStr.Format(_T("%f"), nGroupTotal2[i]);
						rptGroup->SetValue(szPos, tmpStr);
						nTotal[i] += nGroupTotal2[i];
						nGroupTotal2[i] = 0;
					}
				}
			}
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
			if (rptGroup)
			{
				rptGroup->GetItem(_T("GroupName"))->SetTextAlign(ES_CENTER);
				rptGroup->SetValue(_T("GroupName"),
					szNewLev2 == _T("0") ? _T("\x42\x1EC6NH NH\xC2N \x42\x1ED8 \x110\x1ED8I") : _T("\x42\x1EC6NH NH\xC2N \x43H\xCDNH S\xC1\x43H- \x42\x1EA0N"));
			}
			szOldLev2 = szNewLev2;
			szOldLev1.Empty();
		}
		szNewLev1.Format(_T("%s - %s"), pMF->GetDoctorName(rs.GetValue(_T("staff"))), rs.GetValue(_T("invoice_no")));
		//if (m_szGroupByKey == _T("02"))
			//szNewLev1.Format(_T("Kho\x61 %s"), rs.GetValue(_T("dept_id")));
		if (szOldLev1 != szNewLev1 && (!szNewLev1.IsEmpty()))
		{
			if (nGroupTotal1[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m:"));
					for (int i = 0; i <= nSumPos; i++)
					{
						szPos.Format(_T("s%d"), i + 7);
						tmpStr.Format(_T("%f"), nGroupTotal1[i]);
						rptGroup->SetValue(szPos, tmpStr);
						nGroupTotal2[i] += nGroupTotal1[i];
						nGroupTotal1[i] = 0;
					}
				}
			}
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
			if (rptGroup)
			{
				rptGroup->GetItem(_T("GroupName"))->SetTextAlign(ES_LEFT);
				rptGroup->SetValue(_T("GroupName"), szNewLev1);
			}
			szOldLev1 = szNewLev1;
		}
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("patient_name")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("work_place")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("doc_no")));

			rs.GetValue(_T("admit_date"), tmpStr);
			rptDetail->SetValue(_T("5"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rs.GetValue(_T("discharge_date"), tmpStr);
			rptDetail->SetValue(_T("6"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			for (int i = 0; i <= nSumPos; i++)
			{
				rs.GetValue(dat[i], nTmp);
				tmpStr.Format(_T("%f"), nTmp);
				szPos.Format(_T("%d"), i + 7);
				rptDetail->SetValue(szPos, tmpStr);
				nGroupTotal1[i] += nTmp;
			}
		}
		rs.MoveNext();
	}
	if (nGroupTotal1[nSumPos] > 0)
	{
		rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
		if (rptGroup)
		{
			rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m:"));
			for (int i = 0; i <= nSumPos; i++)
			{
				szPos.Format(_T("s%d"), i + nStart);
				tmpStr.Format(_T("%f"), nGroupTotal1[i]);
				rptGroup->SetValue(szPos, tmpStr);
				nGroupTotal2[i] += nGroupTotal1[i];
				nGroupTotal1[i] = 0;
			}
		}
	}
	if (nGroupTotal2[nSumPos] > 0)
	{
		rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
		if (rptGroup)
		{
			rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m \x111\x1ED1i t\x1B0\x1EE3ng:"));
			for (int i = 0; i <= nSumPos; i++)
			{
				szPos.Format(_T("s%d"), i + nStart);
				tmpStr.Format(_T("%f"), nGroupTotal2[i]);
				rptGroup->SetValue(szPos, tmpStr);
				nTotal[i] += nGroupTotal2[i];
				nGroupTotal2[i] = 0;
			}
		}
	}
	if (nGroupTotal3[nSumPos] > 0)
	{
		rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
		if (rptGroup)
		{
			rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m ph\xED:"));
			for (int i = 0; i <= nSumPos; i++)
			{
				szPos.Format(_T("s%d"), i + nStart);
				tmpStr.Format(_T("%f"), nGroupTotal3[i]);
				rptGroup->SetValue(szPos, tmpStr);
				nTotal[i] += nGroupTotal3[i];
				nGroupTotal3[i] = 0;
			}
		}
	}
	rptFooter = rpt.GetGroupFooter(1);
	if (rptFooter)
	{
		rptDetail = rpt.AddDetail(rptFooter);
	}
	else
	{
		rptDetail = rpt.GetReportFooter();
	}

	if (rptDetail)
	{
		rptDetail->SetValue(_T("TotalGroup"), _T("T\x1ED5ng \x63\x1ED9ng:"));
		for (int i = 0; i <= nSumPos; i++)
		{
			szPos.Format(_T("s%d"), i + nStart);
			tmpStr.Format(_T("%.2f"), nTotal[i]);
			rptDetail->SetValue(szPos, tmpStr);
		}
		//		tmpStr.Format(_T("%f"), nFa);
		//		rptFooter->SetValue(_T("s6.1"), tmpStr);
	}
	/*
		szSQL = GetQueryString1();
		rs.ExecSQL(szSQL);
		if (!rs.IsEOF())
		{
			rs.GetValue(_T("eamount"), m_nEAmount);
			if (m_nEAmount > 0)
			{
				FormatCurrency(m_nEAmount, tmpStr2);
				tmpStr.Format(_T("Ngo\x1EA1i tr\xFA: %s"), tmpStr2);
			}
			rs.GetValue(_T("iamount"), m_nIAmount);
			if (m_nIAmount > 0)
			{
				FormatCurrency(m_nIAmount, tmpStr2);
				tmpStr.AppendFormat(_T("N\x1ED9i tr\xFA: %s"), tmpStr2);
			}
			if (!tmpStr.IsEmpty())
				rptFooter->SetValue(_T("cnc"), tmpStr);
			nTmp = nTotal[2] - m_nIAmount - m_nEAmount;
			FormatCurrency(nTmp, tmpStr2);
			rptFooter->SetValue(_T("vienphi"), tmpStr2);
		}
		*/
	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.PrintPreview();
}

void CPrintForms::FM_OnPrintPolicyOutlayList2(CString szPaymentIDStr) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	/*Declaration Section*/
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL, * rptFooter = NULL;
	double nTmp = 0;
	int nIdx = 1;
	//Control variable
	int nStart = 0, nSumPos = 0;
	CString szSQL, tmpStr, tmpStr2, szPos, szReportName, szDate, szOldLev1, szNewLev1, szOldLev2, szNewLev2, szNewLev3, szOldLev3;
	CString szWhere, szGroupBy;
	double nTotal[15];
	double nGroupTotal1[15], nGroupTotal2[15], nGroupTotal3[15];
	CMap<CString, LPCTSTR, CString, LPCTSTR> m_mIndex;
	szReportName = _T("Reports\\HMS\\HF_BANGKECHUNGTUGHISOCHIBNBDCS.RPT");
	if (!rpt.Init(szReportName))
		return;
	m_mIndex[_T("I")] = _T("Thu t\x1EA1m g\x1EEDi");
	m_mIndex[_T("II")] = _T("Thu ph\xED ngo\x1EA1i tr\xFA");
	m_mIndex[_T("III")] = _T("Thu th\x61nh to\xE1n r\x61 vi\x1EC7n");
	//Get Report Date
	szSQL.Format(_T("SELECT min(fac_createddate) from_date, max(fac_createddate) to_date FROM fa_cash WHERE fac_cash_id IN (%s)"), szPaymentIDStr);
	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rs.GetValue(_T("from_date"), m_szFromDate);
		rs.GetValue(_T("to_date"), m_szToDate);
	}
	szWhere.Format(_T(" and fac_cash_id in(%s)"), szPaymentIDStr);

	//if(m_szGroupByKey == _T("01"))
	{
		szGroupBy.Format(_T(", staff, fac_invoiceno"));
	}
	/*if (m_szGroupByKey == _T("02"))
	{
		szGroupBy.Format(_T(", dept_id"));
	}*/

	szSQL.Format(_T(" SELECT    invoice_class, Get_patientname(hfe_docno) patient_name, dept_id,") \
		_T("		   obj_class, staff, fac_invoiceno invoice_no,") \
		_T("		   hfe_docno doc_no,") \
		_T("		   (select hp_workplace from hms_patient, hms_doc where hd_patientno = hp_patientno and hd_docno = hfe_docno) work_place,") \
		_T("		   case when patient_type = 'N' then (select hcr_admitdate from hms_clinical_record where hcr_docno = hfe_docno) ") \
		_T("					 else (select max(htr_admitdate) from hms_treatment_record where htr_docno = hfe_docno and htr_treattime = treattime) end admit_date,") \
		_T("		   case when patient_type = 'N' then (select hcr_dischargedate from hms_clinical_record where hcr_docno = hfe_docno) ") \
		_T("					 else (select max(htr_dischargedate) from hms_treatment_record where htr_docno = hfe_docno and htr_treattime = treattime) end discharge_date,") \
		_T("		   SUM(ngay_dt) ngay_dt,") \
		_T("           SUM(trich_tam_gui) trich_tam_gui, ") \
		_T("           SUM(chi_luong) chi_luong, ") \
		_T("           SUM(chi_an) chi_an, ") \
		_T("           SUM(chi_letet) chi_letet, ") \
		_T("           SUM(chi_tem) chi_tem, ") \
		_T("           SUM(chi_tauxe) chi_tauxe, ") \
		_T("           SUM(chi_khac) chi_khac, ") \
		_T("		   SUM(chi_khac_) chi_khac_,") \
		_T("           SUM(phi_an) phi_an, ") \
		_T("           SUM(thu_chenh - phi_an) phi_ranggia, ") \
		_T("           0 thu_khac, ") \
		_T("		   SUM(thu_chenh + 0) phai_thu,") \
		_T("		   SUM(trich_tam_gui - thu_chenh - 0) con_lai,") \
		_T("           SUM(trich_tam_gui - thu_chenh - 0 + chi_luong + chi_an + chi_letet + chi_tem + chi_tauxe + chi_khac + chi_khac_ + tra_tam_gui) tong_chi ") \
		_T(" FROM      fa_cash ") \
		_T(" LEFT JOIN (SELECT    rf.hfe_cash_id cash_id, rf.hfe_staff staff, 0 treattime, rf.hfe_deptid dept_id,") \
		_T("					  (select NVL(hd_outpatient, 'N') from hms_doc where hd_docno = rf.hfe_docno) patient_type, ") \
		_T("                      rf.hfe_docno, ") \
		_T("					  CASE WHEN rf.hfe_class = 'I' THEN 'III' ELSE 'II' END invoice_class,") \
		_T("					  CASE WHEN rf.hfe_objectid = 1 THEN 0 ELSE 1 END obj_class,") \
		_T("                      i.hfe_deposit trich_tam_gui, ") \
		_T("					  i.hfe_diffcost thu_chenh,") \
		_T("                      (SELECT coalesce(SUM(hfe_cost), 0) FROM hms_fee f WHERE f.hfe_docno = i.hfe_docno AND f.hfe_invoiceno = i.hfe_invoiceno AND f.hfe_status NOT IN ('O', 'C') AND f.hfe_type = 'F' AND NVL(f.hfe_category, 'N') = 'N') ") \
		_T("						phi_an, ") \
		_T("					  (select coalesce(sum(hfe_quantity), 0) from hms_fee f where f.hfe_docno = i.hfe_docno and f.hfe_invoiceno = i.hfe_invoiceno and f.hfe_type = 'B' AND f.hfe_status NOT IN ('O', 'C')) ") \
		_T("					    ngay_dt,") \
		_T("					  0 chi_luong,") \
		_T("                      0 chi_an, ") \
		_T("					  0 chi_letet, ") \
		_T("                      0 chi_tem, ") \
		_T("                      0 chi_tauxe, ") \
		_T("					  0 chi_khac,") \
		_T("					  0 tra_tam_gui,") \
		_T("					  0 chi_khac_") \
		_T("				FROM hms_fee_refund rf") \
		_T("				LEFT JOIN hms_fee_invoice i ON (rf.hfe_docno = i.hfe_docno AND rf.hfe_refidx = i.hfe_invoiceno)") \
		_T("				WHERE rf.hfe_type = 'F' AND rf.hfe_status NOT IN ('O', 'C') AND rf.hfe_cash_id > 0 AND i.hfe_refund > 0") \
		_T("				UNION ALL") \
		_T("				SELECT    r.hfe_cash_id cash_id, r.hfe_staff staff, r.hfe_treattime treattime, r.hfe_deptid dept_id,") \
		_T("					  (select NVL(hd_outpatient, 'N') from hms_doc where hd_docno = r.hfe_docno) patient_type, ") \
		_T("                      r.hfe_docno, ") \
		_T("					  CASE WHEN r.hfe_type = 'V' AND l.hfe_itemid IN ('07', '08', '09') THEN 'I' ELSE CASE WHEN r.hfe_class = 'I' THEN 'III' ELSE 'II' END END invoice_class,") \
		_T("					  CASE WHEN r.hfe_objectid = 1 THEN 0 ELSE 1 END obj_class,") \
		_T("                      0 trich_tam_gui, ") \
		_T("					  0 thu_chenh,") \
		_T("                      0 phi_an, ") \
		_T("					  0 ngay_dt,") \
		_T("                      CASE WHEN l.hfe_itemid = '01' THEN l.hfe_cost ELSE 0 END chi_luong, ") \
		_T("                      CASE WHEN l.hfe_itemid = '05' THEN l.hfe_cost ELSE 0 END chi_an, ") \
		_T("					  CASE WHEN l.hfe_itemid = '04' THEN l.hfe_cost ELSE 0 END chi_letet, ") \
		_T("					  CASE WHEN l.hfe_itemid = '03' THEN l.hfe_cost ELSE 0 END chi_tem,") \
		_T("					  CASE WHEN l.hfe_itemid = '02' THEN l.hfe_cost ELSE 0 END chi_tauxe,") \
		_T("					  CASE WHEN (l.hfe_itemid = '06' OR r.hfe_type NOT IN ('G', 'S', 'V', 'F')) THEN l.hfe_cost ELSE 0 END chi_khac,") \
		_T("					  CASE WHEN r.hfe_type = 'F' THEN l.hfe_cost ELSE 0 END tra_tam_gui,") \
		_T("					  CASE WHEN l.hfe_itemid IN ('07', '08', '09') THEN l.hfe_cost ELSE 0 END chi_khac_") \
		_T("				FROM hms_fee_refund r") \
		_T("				LEFT JOIN hms_fee_refundline l ON (r.hfe_docno = l.hfe_docno AND r.hfe_invoiceno = l.hfe_invoiceno)") \
		_T("				WHERE (r.hfe_type <> 'F' OR (r.hfe_type='F' and r.hfe_serialno is not null)) AND r.hfe_cash_id > 0 ") \
		_T("				AND r.hfe_status NOT IN ('O', 'C')) tbl ON (fac_cash_id = cash_id)") \
		_T(" WHERE 1=1 %s") \
		_T(" GROUP BY invoice_class, hfe_docno, obj_class, fac_postedby, fac_invoiceno, staff, treattime, patient_type, dept_id") \
		_T(" ORDER BY invoice_class, obj_class %s"), szWhere, szGroupBy);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	TCHAR* dat[] = { _T("ngay_dt"),_T("trich_tam_gui"), _T("phi_an"), _T("phi_ranggia"), _T("thu_khac"), _T("phai_thu"),
					_T("con_lai"),_T("chi_luong"), _T("chi_tauxe"), _T("chi_tem"), _T("chi_letet"), _T("chi_an"), _T("chi_khac"),
					_T("chi_khac_"),_T("tong_chi") };
	nStart = 7;
	nSumPos = 15 - 1;
	for (int i = 0; i < 15; i++)
	{
		nTotal[i] = 0;
		nGroupTotal1[i] = 0;
		nGroupTotal2[i] = 0;
		nGroupTotal3[i] = 0;
	}
	/*m_nHitechEAmount = 0;
	m_nHitechIAmount = 0;*/
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
		tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(m_szFromDate, yyyymmdd, ddmmyyyy),
			CDate::Convert(m_szToDate), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ReportDate"), tmpStr);
	}
	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rs.GetValue(_T("staff"), szNewLev1);
		//if (m_szGroupByKey == _T("02"))
			//rs.GetValue(_T("dept_id"), szNewLev1);
		rs.GetValue(_T("obj_class"), szNewLev2);
		rs.GetValue(_T("invoice_class"), szNewLev3);

		if (szNewLev3 != szOldLev3 && (!szNewLev3.IsEmpty()))
		{
			if (nGroupTotal1[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m:"));
					for (int i = 0; i <= nSumPos; i++)
					{
						szPos.Format(_T("s%d"), i + nStart);
						tmpStr.Format(_T("%f"), nGroupTotal1[i]);
						rptGroup->SetValue(szPos, tmpStr);
						nGroupTotal2[i] += nGroupTotal1[i];
						nGroupTotal1[i] = 0;
					}
				}
			}
			if (nGroupTotal2[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m \x111\x1ED1i t\x1B0\x1EE3ng:"));
					for (int i = 0; i <= nSumPos; i++)
					{
						szPos.Format(_T("s%d"), i + nStart);
						tmpStr.Format(_T("%f"), nGroupTotal2[i]);
						rptGroup->SetValue(szPos, tmpStr);
						nGroupTotal3[i] += nGroupTotal2[i];
						nGroupTotal2[i] = 0;
					}
				}
			}
			if (nGroupTotal3[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m ph\xED:"));
					for (int i = 0; i <= nSumPos; i++)
					{
						szPos.Format(_T("s%d"), i + nStart);
						tmpStr.Format(_T("%f"), nGroupTotal3[i]);
						rptGroup->SetValue(szPos, tmpStr);
						nTotal[i] += nGroupTotal3[i];
						nGroupTotal3[i] = 0;
					}
				}
			}
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
			if (rptGroup)
			{
				rptGroup->GetItem(_T("GroupName"))->SetTextAlign(ES_CENTER);
				m_mIndex.Lookup(szNewLev3, tmpStr);
				rptGroup->SetValue(_T("GroupName"), tmpStr);
			}
			szOldLev3 = szNewLev3;
			szOldLev2.Empty();
			szOldLev1.Empty();
			nIdx = 1;
		}

		if (szNewLev2 != szOldLev2)
		{
			if (nGroupTotal1[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m: "));
					for (int i = 0; i <= nSumPos; i++)
					{
						tmpStr.Format(_T("%f"), nGroupTotal1[i]);
						szPos.Format(_T("s%d"), i + nStart);
						rptGroup->SetValue(szPos, tmpStr);
						nGroupTotal2[i] += nGroupTotal1[i];
						nGroupTotal1[i] = 0;
					}
				}

			}
			if (nGroupTotal2[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m \x111\x1ED1i t\x1B0\x1EE3ng: "));
					for (int i = 0; i <= nSumPos; i++)
					{
						tmpStr.Format(_T("%f"), nGroupTotal2[i]);
						szPos.Format(_T("s%d"), i + nStart);
						rptGroup->SetValue(szPos, tmpStr);
						nGroupTotal3[i] += nGroupTotal2[i];
						nGroupTotal2[i] = 0;
					}
				}

			}
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
			if (rptGroup)
			{
				rptGroup->GetItem(_T("GroupName"))->SetTextAlign(ES_CENTER);
				rptGroup->SetValue(_T("GroupName"),
					szNewLev2 == _T("0") ? _T("\x42\x1EC6NH NH\xC2N \x42\x1ED8 \x110\x1ED8I") : _T("\x42\x1EC6NH NH\xC2N \x43H\xCDNH S\xC1\x43H- \x42\x1EA0N"));
			}
			szOldLev2 = szNewLev2;
			szOldLev1.Empty();
			nIdx = 1;
		}
		szNewLev1.Format(_T("%s - %s"), pMF->GetDoctorName(rs.GetValue(_T("staff"))), rs.GetValue(_T("invoice_no")));
		//if (m_szGroupByKey == _T("02"))
			//szNewLev1.Format(_T("Khoa %s"), rs.GetValue(_T("dept_id")));
		if (szOldLev1 != szNewLev1)
		{
			if (nGroupTotal1[nSumPos] > 0)
			{
				rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
				if (rptGroup)
				{
					rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m: "));
					for (int i = 0; i <= nSumPos; i++)
					{
						tmpStr.Format(_T("%f"), nGroupTotal1[i]);
						szPos.Format(_T("s%d"), i + nStart);
						rptGroup->SetValue(szPos, tmpStr);
						nGroupTotal2[i] += nGroupTotal1[i];
						nGroupTotal1[i] = 0;
					}
				}

			}
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
			if (rptGroup)
			{
				rptGroup->GetItem(_T("GroupName"))->SetTextAlign(ES_LEFT);
				rptGroup->SetValue(_T("GroupName"), szNewLev1);
			}
			szOldLev1 = szNewLev1;
		}
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("patient_name")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("work_place")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("doc_no")));
			rs.GetValue(_T("admit_date"), tmpStr);
			rptDetail->SetValue(_T("5"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rs.GetValue(_T("discharge_date"), tmpStr);
			rptDetail->SetValue(_T("6"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			for (int i = 0; i <= nSumPos; i++)
			{
				rs.GetValue(dat[i], nTmp);
				tmpStr.Format(_T("%f"), nTmp);
				szPos.Format(_T("%d"), i + nStart);
				rptDetail->SetValue(szPos, tmpStr);
				nGroupTotal1[i] += nTmp;
			}
		}
		rs.MoveNext();
	}
	if (nGroupTotal1[nSumPos] > 0)
	{
		rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
		if (rptGroup)
		{
			rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng phi\x1EBFu: "));
			for (int i = 0; i <= nSumPos; i++)
			{
				tmpStr.Format(_T("%f"), nGroupTotal1[i]);
				szPos.Format(_T("s%d"), i + nStart);
				rptGroup->SetValue(szPos, tmpStr);
				nGroupTotal2[i] += nGroupTotal1[i];
				nGroupTotal1[i] = 0;
			}
		}

	}
	if (nGroupTotal2[nSumPos] > 0)
	{
		rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
		if (rptGroup)
		{
			rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m \x111\x1ED1i t\x1B0\x1EE3ng: "));
			for (int i = 0; i <= nSumPos; i++)
			{
				tmpStr.Format(_T("%f"), nGroupTotal2[i]);
				szPos.Format(_T("s%d"), i + nStart);
				rptGroup->SetValue(szPos, tmpStr);
				nTotal[i] += nGroupTotal2[i];
				nGroupTotal2[i] = 0;
			}
		}
	}
	if (nGroupTotal3[nSumPos] > 0)
	{
		rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
		if (rptGroup)
		{
			rptGroup->SetValue(_T("TotalGroup"), _T("T\x1ED5ng nh\xF3m ph\xED:"));
			for (int i = 0; i <= nSumPos; i++)
			{
				szPos.Format(_T("s%d"), i + nStart);
				tmpStr.Format(_T("%f"), nGroupTotal3[i]);
				rptGroup->SetValue(szPos, tmpStr);
				nTotal[i] += nGroupTotal3[i];
				nGroupTotal3[i] = 0;
			}
		}
	}
	rptFooter = rpt.GetGroupFooter(1);
	if (rptFooter)
	{
		rptDetail = rpt.AddDetail(rptFooter);
	}
	else
	{
		rptDetail = rpt.GetReportFooter();
	}

	if (rptDetail)
	{
		rptDetail->SetValue(_T("TotalGroup"), _T("T\x1ED5ng \x63\x1ED9ng:"));
		for (int i = 0; i <= nSumPos; i++)
		{
			szPos.Format(_T("s%d"), i + nStart);
			tmpStr.Format(_T("%f"), nTotal[i]);
			rptDetail->SetValue(szPos, tmpStr);
		}
		/*
				tmpStr.Format(_T("%f"), nFa);
				rptFooter->SetValue(_T("s6.1"), tmpStr);
				szSQL = GetQueryString1();
				rs.ExecSQL(szSQL);
				if (!rs.IsEOF())
				{
					rs.GetValue(_T("iamount"), m_nHitechIAmount);
					if (m_nHitechIAmount > 0)
					{
						FormatCurrency(m_nHitechIAmount, tmpStr2);
						tmpStr.Format(_T("Ngo\x1EA1i tr\xFA: %s"), tmpStr2);
					}
					m_nHitechEAmount = nTotal[5] - m_nHitechIAmount;
					if (m_nHitechEAmount > 0)
					{
						FormatCurrency(m_nHitechEAmount, tmpStr2);
						tmpStr.AppendFormat(_T("N\x1ED9i tr\xFA: %s"), tmpStr2);
					}
					if (!tmpStr.IsEmpty())
						rptFooter->SetValue(_T("cnc"), tmpStr);
					nTmp = nTotal[1] - nTotal[5];
					FormatCurrency(nTmp, tmpStr2);
					rptFooter->SetValue(_T("vienphi"), tmpStr2);
				}
		*/
	}

	tmpStr = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Right(2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.PrintPreview();
}
void CPrintForms::FM_OnPrintDepositRequest(long nDocNo, long nMoney) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptDetail = NULL;
	CString szSQL, tmpStr, szDate, szWhere;
	if (!rpt.Init(_T("Reports\\HMS\\HF_PHIEUYEUCAUTG.RPT")))
		return;
	szSQL.Format(_T(" SELECT hd_docno AS doc_no, ") \
		_T("        upper(Get_patientname(hd_docno)) AS patient_name ") \
		_T(" FROM hms_doc ") \
		_T(" LEFT JOIN hms_patient ON(hp_patientno = hd_patientno) ") \
		_T(" WHERE hd_docno = %ld "), nDocNo);
	rs.ExecSQL(szSQL);
	rptHeader = rpt.GetReportHeader();
	if (rptHeader)
	{
		rptHeader->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
		rptHeader->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);
		tmpStr.Format(_T("%ld"), nDocNo);
		rptHeader->SetValue(_T("DocNo"), tmpStr);
		rptHeader->SetValue(_T("PATIENTNAME"), rs.GetValue(_T("patient_name")));
		tmpStr.Format(_T("%ld"), nMoney);
		//tmpStr.Empty();
		rptHeader->SetValue(_T("Money"), tmpStr);
	}

	szDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Mid(8, 2), szDate.Mid(5, 2), szDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}
void CPrintForms::EM_OnPrintAppointmentList(CString szFromDate, CString szToDate)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL, * rptFooter = NULL;
	CString szSQL, tmpStr, szDate, szWhere, szOldGroup, szNewGroup, szOldHour, szNewHour;
	int nIdx = 1;
	if (!rpt.Init(_T("Reports\\HMS\\DANHSACHBENHNHANHENKHAMLAI.RPT")))
		return;
	szSQL.Format(_T(" SELECT TO_CHAR(ha_date,'DD/MM/YYYY') AS appointment_date,") \
		_T("   TO_CHAR(ha_date, 'HH24:MI')        AS appointment_time,") \
		_T("   ha_roomid,") \
		_T("   hd_patientno AS patientno,") \
		_T("   ha_docno,") \
		_T("   trim(hp_surname") \
		_T("   ||' '") \
		_T("   ||hp_midname") \
		_T("   ||' '") \
		_T("   ||hp_firstname)         AS pname,") \
		_T("   GET_USERNAME(hd_doctor) AS doctor,") \
		_T("   ha_note,") \
		_T("   hd_admitdate  AS examdate,") \
		_T("   hd_conclusion AS conclusion") \
		_T(" FROM hms_appointment") \
		_T(" LEFT JOIN hms_doc") \
		_T(" ON(hd_docno = ha_docno)") \
		_T(" LEFT JOIN hms_patient") \
		_T(" ON(hp_patientno = hd_patientno)") \
		_T(" WHERE TRUNC(ha_date) BETWEEN TO_DATE('%s','YYYY-MM-DD HH24:MI:SS') AND TO_DATE('%s','YYYY-MM-DD HH24:MI:SS')") \
		_T(" ORDER BY ha_date,") \
		_T("   ha_roomid"), szFromDate, szToDate);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(szFromDate, yyyymmdd, ddmmyyyy),
		CDate::Convert(szToDate, yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("ReportDate"), tmpStr);

	while (!rs.IsEOF())
	{
		rs.GetValue(_T("appointment_date"), szNewGroup);
		rs.GetValue(_T("appointment_time"), szNewHour);
		if (szNewGroup != szOldGroup && !szNewGroup.IsEmpty())
		{
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
			tmpStr.Format(_T("Ng\xE0y %s"), szNewGroup);
			rptGroup->SetValue(_T("GroupName"), tmpStr);
			nIdx = 1;
			szOldGroup = szNewGroup;
		}
		if (szNewHour != szOldHour && !szNewHour.IsEmpty())
		{
			rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
			tmpStr.Format(_T("Gi\x1EDD %s"), szNewHour);
			rptGroup->SetValue(_T("GroupName"), tmpStr);
			nIdx = 1;
			szOldHour = szNewHour;
		}
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("ha_roomid")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("patientno")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("ha_docno")));
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("pname")));
			rs.GetValue(_T("examdate"), tmpStr);
			rptDetail->SetValue(_T("6"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rptDetail->SetValue(_T("7"), rs.GetValue(_T("doctor")));
			rptDetail->SetValue(_T("8"), rs.GetValue(_T("conclusion")));
			rptDetail->SetValue(_T("9"), rs.GetValue(_T("ha_note")));
		}
		rs.MoveNext();
	}

	szDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szDate.Mid(8, 2), szDate.Mid(5, 2), szDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::EM_OnPrintRehabilitationCertify(long nDocNo, CString szEndDate) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptDetail = NULL;
	CString szSQL, tmpStr, szDate, szWhere, szDoctorDept, szSubSelect, szFromDate, szToDate;
	int nIdx = 1;
	if (!rpt.Init(_T("Reports\\HMS\\PHIEUDIEUTRIVLTL.RPT")))
		return;

	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	tmpStr.Format(rptHeader->GetValue(_T("ReportDate")), CDate::Convert(szFromDate, yyyymmdd, ddmmyyyy),
		CDate::Convert(szToDate, yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("ReportDate"), tmpStr);

	szSQL.Format(_T(" SELECT trim(hp_surname") \
		_T(" ||' '") \
		_T(" ||hp_midname") \
		_T(" ||' '") \
		_T(" ||hp_firstname)                                    AS PatientName,") \
		_T(" hms_getage(trunc_date(hd_admitdate), hp_birthdate) AS Age,") \
		_T(" Get_SysSel_desc('sys_sex', hp_sex)                 AS Sex,") \
		_T(" hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid))    AS Address,") \
		_T(" hd_contactaddr                                     AS dtladdress,") \
		_T(" hp_workplace                                       AS workplace,") \
		_T(" CASE") \
		_T(" WHEN LENGTH(hd_icd) > 0") \
		_T(" THEN") \
		_T(" (SELECT DISTINCT hi_name FROM hms_icd WHERE hi_icd=hd_icd") \
		_T(" )") \
		_T(" ELSE CAST('' AS NVARCHAR2(1))") \
		_T(" END          AS diagnostic,") \
		_T(" hd_admitdate AS examdate,") \
		_T(" hd_enddate AS enddate,") \
		_T(" hd_rank,") \
		_T(" GET_SYSSEL_DESC('hms_rank', hp_rank)         AS ranks,") \
		_T(" GET_SYSSEL_DESC('hms_position', hp_position) AS position,") \
		_T(" hd_doctor                                    AS doctor,") \
		_T(" hc_cardno                                    AS cardno,") \
		_T(" ho_desc                                      AS objname,") \
		_T(" hp_patientno                                 AS patientno,") \
		_T(" hd_admitdept") \
		_T(" FROM hms_patient") \
		_T(" LEFT JOIN hms_doc") \
		_T(" ON(hd_patientno=hp_patientno)") \
		_T(" LEFT JOIN hms_object") \
		_T(" ON(ho_id=hd_object)") \
		_T(" LEFT JOIN hms_card") \
		_T(" ON(hc_patientno=hp_patientno") \
		_T(" AND hc_idx     =hd_cardidx") \
		_T(" AND hc_cardno  =hd_cardno)") \
		_T(" WHERE hd_docno =%ld"), nDocNo);
	rs.ExecSQL(szSQL);
	szDate.Format(rptHeader->GetValue(_T("ExamDate")), CDate::Convert(rs.GetValue(_T("examdate")), yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("ExamDate"), szDate);
	tmpStr.Format(_T("%ld"), nDocNo);
	rptHeader->SetValue(_T("DocumentNo"), tmpStr);
	rptHeader->SetValue(_T("Barcode[128B]"), tmpStr);
	rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("PatientName")));
	rptHeader->SetValue(_T("Age"), rs.GetValue(_T("Age")));
	rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("Sex")));
	rptHeader->SetValue(_T("Address"), rs.GetValue(_T("Address")));
	rptHeader->SetValue(_T("Object"), rs.GetValue(_T("objname")));
	rptHeader->SetValue(_T("CardNo"), rs.GetValue(_T("cardno")));
	rptHeader->SetValue(_T("Workplace"), rs.GetValue(_T("workplace")));
	rptHeader->SetValue(_T("Rank"), rs.GetValue(_T("ranks")));
	rptHeader->SetValue(_T("Diagnostic"), rs.GetValue(_T("diagnostic")));
	rs.GetValue(_T("examdate"), tmpStr);
	rptHeader->SetValue(_T("StartDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rptHeader->SetValue(_T("EndDate"), CDate::Convert(szEndDate, yyyymmdd, ddmmyyyy));

	szSQL.Format(_T(" SELECT DISTINCT") \
		_T(" ho_idx AS orderid,") \
		_T(" (SELECT hfl_name FROM hms_fee_list WHERE hfl_feeid = ho_itemid) AS pname") \
		_T(" FROM hms_operation WHERE ((ho_deptid = 'C1.1' AND ho_roomid IN (54, 147, 148))") \
		_T(" OR ho_deptid = 'C6') AND ho_docno = %ld") \
		_T(" ORDER BY ho_idx"), nDocNo);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("Pname"), rs.GetValue(_T("pname")));
		rs.MoveNext();
	}

	szSQL.Format(_T(" SELECT he_roomid,") \
		_T("   he_deptid,") \
		_T("   trim(he_medical) AS medical,") \
		_T("   trim(he_examine) AS examine,") \
		_T("   he_diagnostic") \
		_T(" FROM hms_exam") \
		_T(" WHERE he_docno=%ld AND he_roomid IN (54, 147, 148)") \
		_T(" ORDER BY he_receptidx"), nDocNo);
	rs.ExecSQL(szSQL);
	rpt.GetReportFooter()->SetValue(_T("Conclusion"), rs.GetValue(_T("he_diagnostic")));

	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	tmpStr = GetDoctorName(pMF->GetCurrentUser());
	rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);
	rpt.PrintPreview();
}
void CPrintForms::BB_PrintOtherExport(long nSheetID) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr;
	CString szSysDte;
	int nIdx = 0;
	double nS7 = 0, nS8 = 0;
	CReportSection* rptDetail, * rptHeader, * rptFooter;
	m_szReportName = _T("Reports\\HMS\\BB_PHIEUXUATKHAC.RPT");
	if (!rpt.Init(m_szReportName))
		return;
	szSQL.Format(_T(" SELECT") \
		_T("   mt_orderno       AS orderno,") \
		_T("   get_username(mt_approvedby)    AS clerk,") \
		_T("   get_partnername(mt_partner_id) as deliverto,") \
		_T("   trunc(mt_approveddate)  AS dte,") \
		_T("   get_storagename(mt_storage_id) AS stock,") \
		_T("   get_departmentname(mt_department_id) AS dept,") \
		_T("   mt_description   AS descr,") \
		_T("   mt_documentno documentno,") \
		_T("   get_doctype(mt_doctype) AS doctype") \
		_T(" FROM m_transaction") \
		_T(" WHERE mt_transaction_id = %ld"), nSheetID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"), MB_ICONASTERISK | MB_OK);
		return;
	}
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Invoiceno"), rs.GetValue(_T("orderno")));
	rptHeader->SetValue(_T("Note"), rs.GetValue(_T("descr")));
	rptHeader->SetValue(_T("StockName"), rs.GetValue(_T("stock")));
	rptHeader->SetValue(_T("Reason"), rs.GetValue(_T("doctype")));
	rs.GetValue(_T("dte"), szSysDte);
	rptHeader->SetValue(_T("Department"), rs.GetValue(_T("dept")));
	rptHeader->SetValue(_T("DeliveryTo"), rs.GetValue(_T("deliverto")));
	rptHeader->SetValue(_T("ReferenceNo"), rs.GetValue(_T("documentno")));
	szSQL.Format(_T(" SELECT product_name                AS pname,") \
		_T("   mtl_qtydelivery                  AS qty,") \
		_T("   product_uomname                  AS uom,") \
		_T("   product_expdate                  AS expdte,") \
		_T("   product_taxprice                 AS price,") \
		_T("   product_lotno                    AS lot,") \
		_T("   mtl_qtydelivery*product_taxprice AS amt,") \
		_T("   mbd_package_id                   AS packageid,") \
		_T("   mbd_blood_type                   AS bloodtype") \
		_T(" FROM m_transactionline") \
		_T(" LEFT JOIN m_productitem_view") \
		_T(" ON (product_item_id = mtl_product_item_id)") \
		_T(" LEFT JOIN m_blood_donation") \
		_T(" ON (mbd_product_item_id  = mtl_product_item_id)") \
		_T(" WHERE mtl_transaction_id = %ld"), nSheetID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	while (!rs.IsEOF())
	{
		nIdx++;
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("pname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("packageid")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("bloodtype")));
		rs.GetValue(_T("expdte"), tmpStr);
		rptDetail->SetValue(_T("5"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("price")));
		rs.GetValue(_T("qty"), tmpStr);
		nS7 += str2double(tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rs.GetValue(_T("amt"), tmpStr);
		nS8 += str2double(tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		rs.MoveNext();
	}
	rptFooter = rpt.AddDetail(rpt.GetGroupFooter(1));
	rptFooter->SetValue(_T("s7"), double2str(nS7));
	rptFooter->SetValue(_T("s8"), double2str(nS8));
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), int2str(nIdx));
	MoneyToString(ToString(nS8), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		tmpStr += _T(" \x111\x1ED3ng");
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
	}
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDte.Mid(8, 2), szSysDte.Mid(5, 2), szSysDte.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::BB_PrintExport(long nDocumentNo, long nSheetID) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr;
	CString szSysDte;
	int nIdx = 0;
	double nS7 = 0, nS8 = 0;
	CReportSection* rptDetail, * rptHeader, * rptFooter;
	m_szReportName = _T("Reports\\HMS\\BB_PHIEUXUATKHO.RPT");
	if (!rpt.Init(m_szReportName))
		return;
	szSQL.Format(_T(" SELECT hd_patientno AS patientno,") \
		_T("   hd_docno          AS docno,") \
		_T("   hcr_recordno      AS recordno,") \
		_T("   hp_surname") \
		_T("   ||' '") \
		_T("   ||hp_midname") \
		_T("   ||' '") \
		_T("   ||hp_firstname               AS pname,") \
		_T("   hms_getobjectname(hd_object) AS objectname,") \
		_T("   hd_cardno                    AS cardno,") \
		_T("   CASE") \
		_T("     WHEN (hd_isinpatient='Y'") \
		_T("     OR htr_idx          > 0)") \
		_T("     THEN htr_deptid") \
		_T("     ELSE hd_admitdept") \
		_T("   END            AS deptid,") \
		_T("   hd_isinpatient AS inpatient,") \
		_T("   hcr_refidx     AS refidx,") \
		_T("   hd_status,") \
		_T("   hcr_status") \
		_T(" FROM hms_patient") \
		_T(" LEFT JOIN hms_doc") \
		_T(" ON(hd_patientno = hp_patientno)") \
		_T(" LEFT JOIN hms_clinical_record") \
		_T(" ON(hcr_docno = hd_docno)") \
		_T(" LEFT JOIN hms_treatment_record") \
		_T(" ON(htr_docno      = hcr_docno") \
		_T(" AND (htr_idx      =hcr_refidx") \
		_T(" OR htr_status     ='I' ) )") \
		_T(" WHERE (hd_status <> 'T'") \
		_T(" OR hcr_status    IN('I','T') )") \
		_T(" AND hd_docno      = %ld"), nDocumentNo);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"), MB_ICONASTERISK | MB_OK);
		return;
	}
	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("pname")));
	rptHeader->SetValue(_T("DocNo"), rs.GetValue(_T("docno")));
	rptHeader->SetValue(_T("Object"), rs.GetValue(_T("objectname")));
	rptHeader->SetValue(_T("CardNo"), rs.GetValue(_T("cardno")));
	rptHeader->SetValue(_T("Deptid"), rs.GetValue(_T("deptid")));

	szSQL.Format(_T(" SELECT") \
		_T(" orderid,") \
		_T(" orderdate,") \
		_T(" get_storagename(storageid) AS storagename") \
		_T(" FROM") \
		_T("   (SELECT hpo_docno,") \
		_T("     hpo_orderid AS orderid,") \
		_T("     hpo_orderdate AS orderdate,") \
		_T("     hpo_approvedate,") \
		_T("     hpo_orderstatus,") \
		_T("     hpo_storage_id AS storageid,") \
		_T("     hpo_reference_id,") \
		_T("     hpo_refitem_id") \
		_T("   FROM hms_ipharmaorder") \
		_T("   UNION ALL") \
		_T("   SELECT hpo_docno,") \
		_T("     hpo_orderid,") \
		_T("     hpo_orderdate,") \
		_T("     hpo_approvedate,") \
		_T("     hpo_orderstatus,") \
		_T("     hpo_storage_id,") \
		_T("     hpo_reference_id,") \
		_T("     hpo_refitem_id") \
		_T("   FROM hms_pharmaorder") \
		_T("   ) tbl") \
		_T(" WHERE orderid = %ld"), nSheetID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"), MB_ICONASTERISK | MB_OK);
		return;
	}

	rs.GetValue(_T("orderdate"), szSysDte);
	rptHeader->SetValue(_T("Invoiceno"), rs.GetValue(_T("orderid")));
	rptHeader->SetValue(_T("StockName"), rs.GetValue(_T("storagename")));
	rptHeader->SetValue(_T("Department"), _T("Kho\x61 Ti\x1EBFp Huy\x1EBFt"));

	szSQL.Format(_T(" SELECT product_name                AS pname,") \
		_T("   hpol_qtyorder                    AS qty,") \
		_T("   product_uomname                  AS uom,") \
		_T("   product_expdate                  AS expdte,") \
		_T("   product_taxprice                 AS price,") \
		_T("   product_lotno                    AS lot,") \
		_T("   hpol_qtyorder*hpol_unitprice AS amt,") \
		_T("   mbd_package_id                   AS packageid,") \
		_T("   mbd_blood_type                   AS bloodtype") \
		_T(" FROM") \
		_T("   (SELECT hpol_orderid,") \
		_T("     hpol_line,") \
		_T("     hpol_product_item_id,") \
		_T("     hpol_qtyissue,") \
		_T("     hpol_qtyorder,") \
		_T("     hpol_unitprice,") \
		_T("     CAST('' AS NVARCHAR2(254)) AS hpol_dousage") \
		_T("   FROM hms_pharmaorderline") \
		_T("   UNION ALL") \
		_T("   SELECT hpol_orderid,") \
		_T("     hpol_line,") \
		_T("     hpol_product_item_id,") \
		_T("     hpol_qtyissue,") \
		_T("     hpol_qtyorder,") \
		_T("     hpol_unitprice,") \
		_T("     hpol_dousage") \
		_T("   FROM hms_ipharmaorderline") \
		_T("   ) tbl") \
		_T(" LEFT JOIN m_productitem_view") \
		_T(" ON(product_item_id=hpol_product_item_id)") \
		_T(" LEFT JOIN m_blood_donation") \
		_T(" ON(mbd_product_item_id = hpol_product_item_id)") \
		_T(" WHERE hpol_orderid     = %ld") \
		_T(" ORDER BY hpol_line"), nSheetID);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	while (!rs.IsEOF())
	{
		nIdx++;
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("pname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("packageid")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("bloodtype")));
		rs.GetValue(_T("expdte"), tmpStr);
		rptDetail->SetValue(_T("5"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("price")));
		rs.GetValue(_T("qty"), tmpStr);
		nS7 += str2double(tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rs.GetValue(_T("amt"), tmpStr);
		nS8 += str2double(tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		rs.MoveNext();
	}
	rptFooter = rpt.AddDetail(rpt.GetGroupFooter(1));
	rptFooter->SetValue(_T("s7"), double2str(nS7));
	rptFooter->SetValue(_T("s8"), double2str(nS8));
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), int2str(nIdx));
	MoneyToString(ToString(nS8), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		tmpStr += _T(" \x111\x1ED3ng");
		rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);
	}
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDte.Mid(8, 2), szSysDte.Mid(5, 2), szSysDte.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
}


void CPrintForms::TM_OnPrintGiveBirthRecord(long nPatientNo, long nDocno) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CReport rpt2;
	CRecord rs(&pMF->m_db);
	CString szSQL, tmpStr, tmpStr2, szPrintDate;
	CString szSysDte, m_szReportName2;
	int nIdx = 0;
	long m_nReference_DocNo;
	CReportSection* rptDetail, * rptHeader, * rptFooter;
	CReportSection* rptDetail2, * rptHeader2, * rptFooter2;
	m_szReportName = _T("Reports\\HMS\\BENHAN\\B11.1_SOSINH.RPT");
	if (!rpt.Init(m_szReportName))
		return;

	m_szReportName2 = _T("Reports\\HMS\\BENHAN\\B11.2_SOSINH.RPT");
	if (!rpt2.Init(m_szReportName2))
		return;

	szSQL.Format(_T(" SELECT hd_patientno patient_no,") \
		_T("   hcr_recordno record_no,") \
		_T("   get_patientname(hd_docno) patient_name,") \
		_T("   hms_getsex(hp_sex) sex,") \
		_T("   hp_birthdate birthdate,") \
		_T("   hnr_fathername fathername,") \
		_T("   hnr_fatherage fatherage,") \
		_T("   hnr_reference_docno reference_docno,") \
		_T("   hcr_admitdate ngay_vao,") \
		_T("   hcr_dischargedate ngay_ra,") \
		_T("   hcr_sumtreat ngay_dieutri,") \
		_T("   hcr_result ketqua,") \
		_T("   hcr_suggestion suggestion,") \
		_T("   hcr_conclusion diagnostic,") \
		_T("   hcr_maindisease disease_process,") \
		_T("   hcr_tests paraclinic_result,") \
		_T("   hcr_pathological pathology,") \
		_T("   hcr_reldisease related_disease,") \
		_T("   hcr_gmethod treatment_method,") \
		_T("   get_syssel_desc('hms_result', hcr_result) status,") \
		_T("   hcr_goutstate chuyen_vien,") \
		_T("   hcr_motherdisease benh_me,") \
		_T("   hcr_diedate die_date") \
		_T(" FROM hms_patient,") \
		_T("   hms_doc,") \
		_T("   hms_clinical_record,") \
		_T("   hms_newborn_record") \
		_T(" WHERE hd_patientno = hp_patientno") \
		_T(" AND hd_docno       = hcr_docno") \
		_T(" AND hnr_docno      = hd_docno") \
		_T(" AND hd_docno       = %ld"), nDocno);
	rs.ExecSQL(szSQL);

	if (!rs.IsEOF())
	{
		rptHeader = rpt.GetReportHeader();
		rptHeader->SetValue(_T("so_luu_tru"), rs.GetValue(_T("record_no")));
		rptHeader->SetValue(_T("patientname"), rs.GetValue(_T("patient_name")));
		rptHeader->SetValue(_T("sex"), rs.GetValue(_T("sex")));
		rs.GetValue(_T("birthdate"), tmpStr);
		rptHeader->SetValue(_T("birthdate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		rptHeader->SetValue(_T("tai"), rs.GetValue(_T("khoa_vao")));
		tmpStr = CDate::Convert(rs.GetValue(_T("ngay_vao")), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ngayvao"), tmpStr);
		tmpStr = CDate::Convert(rs.GetValue(_T("ngay_ra")), yyyymmdd, ddmmyyyy);
		rptHeader->SetValue(_T("ngayravien"), tmpStr);
		rptHeader->SetValue(_T("c61"), tmpStr);
		rptHeader->SetValue(_T("songaydt"), rs.GetValue(_T("ngay_dieutri")));

		rs.GetValue(_T("suggestion"), tmpStr);
		if (tmpStr == _T("F"))
		{
			rptHeader->SetValue(_T("c65"), _T("X"));
			tmpStr = CDate::Convert(rs.GetValue(_T("ngay_ra")), yyyymmdd, ddmmyyyy);
			rptHeader->SetValue(_T("c62"), tmpStr);
		}

		rs.GetValue(_T("ketqua"), tmpStr);
		rs.GetValue(_T("diagnostic"), tmpStr2);
		if (str2int(tmpStr) == 1)
			rptHeader->SetValue(_T("c66"), _T("X"));
		else if (str2int(tmpStr) == 2)
			rptHeader->SetValue(_T("c67"), _T("X"));
		else if (str2int(tmpStr) == 5 || str2int(tmpStr) == 6)
		{
			rptHeader->SetValue(_T("c68"), _T("X"));
			rptHeader->SetValue(_T("chandoantuvong"), tmpStr2);
			rs.GetValue(_T("die_date"), tmpStr);
			rptHeader->SetValue(_T("c63"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
		}
		else if (str2int(tmpStr) == 7)
			rptHeader->SetValue(_T("c69"), _T("X"));

		rptHeader->SetValue(_T("chandoanravien"), tmpStr2);
		rptHeader->SetValue(_T("c56"), tmpStr2);
		rptHeader->SetValue(_T("c57"), tmpStr2);
		rptHeader->SetValue(_T("c58"), rs.GetValue(_T("pathology")));
		rptHeader->SetValue(_T("c59"), rs.GetValue(_T("benh_me")));
		rptHeader->SetValue(_T("c60"), rs.GetValue(_T("treatment_method")));
		rptHeader->SetValue(_T("c64"), rs.GetValue(_T("status")));
		rs.GetValue(_T("reference_docno"), m_nReference_DocNo);
		rptHeader2 = rpt2.GetReportHeader();
		rptHeader2->SetValue(_T("patientname"), rs.GetValue(_T("patient_name")));
		rptHeader2->SetValue(_T("c70"), rs.GetValue(_T("diagnostic")));
	}

	szSQL.Format(_T(" SELECT hcr_recordno benh_an_me, hnr_docno so_ho_so, hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) dia_chi,") \
		_T(" (select hb_roomid from hms_bed where hb_docno = hd_docno and hb_status = 'O') phong, ") \
		_T(" (select hb_bedid from hms_bed where hb_docno = hd_docno and hb_status = 'O') giuong, ") \
		_T(" get_patientname(hd_docno) ten_me, hms_getagebydoc(hd_docno) tuoi_me, get_syssel_desc('sys_occupation', hp_occupation) nghe_me,") \
		_T(" hd_telephone so_dt, hnr_fathername father_name, hnr_fatherage father_age") \
		_T(" FROM hms_patient, hms_doc, hms_clinical_record, hms_newborn_record ") \
		_T(" WHERE hd_patientno = hp_patientno AND hcr_docno = hd_docno AND hd_docno = hnr_reference_docno AND hd_docno = %ld"), m_nReference_DocNo);

	rs.ExecSQL(szSQL);
	if (!rs.IsEOF())
	{
		rptHeader = rpt.GetReportHeader();
		rptHeader->SetValue(_T("healthservice"), pMF->m_szHealthService);
		rptHeader->SetValue(_T("hospitalname"), pMF->m_szHospitalName);
		rptHeader->SetValue(_T("benh_an_me"), rs.GetValue(_T("benh_an_me")));
		rptHeader->SetValue(_T("docno"), rs.GetValue(_T("so_ho_so")));
		rptHeader->SetValue(_T("phong"), rs.GetValue(_T("phong")));
		rptHeader->SetValue(_T("giuong"), rs.GetValue(_T("giuong")));
		rptHeader->SetValue(_T("hotenme"), rs.GetValue(_T("ten_me")));
		rptHeader->SetValue(_T("tuoime"), rs.GetValue(_T("tuoi_me")));
		rptHeader->SetValue(_T("ngheme"), rs.GetValue(_T("nghe_me")));
		rptHeader->SetValue(_T("diachi"), rs.GetValue(_T("dia_chi")));
		rptHeader->SetValue(_T("sodienthoai"), rs.GetValue(_T("so_dt")));
		tmpStr.Format(rptHeader->GetValue(_T("PrintDate")), szPrintDate.Mid(11, 5), szPrintDate.Mid(8, 2), szPrintDate.Mid(5, 2), szPrintDate.Left(4));
		rptHeader->SetValue(_T("PrintDate"), tmpStr);
		rptHeader->SetValue(_T("hotenbo"), rs.GetValue(_T("father_name")));
		rptHeader->SetValue(_T("tuoibo"), rs.GetValue(_T("father_age")));
	}

	CMap<int, int, CString, CString> m_mName;
	m_mName[1] = _T("CD_SOBO");
	m_mName[2] = _T("DIAG_DATE1");
	m_mName[3] = _T("DOCTOR1");
	m_mName[4] = _T("CD_PHANBIET");
	m_mName[5] = _T("DIAG_DATE2");
	m_mName[6] = _T("DOCTOR2");
	m_mName[7] = _T("CD_XACDINH");
	m_mName[8] = _T("DIAG_DATE3");
	m_mName[9] = _T("DOCTOR3");
	m_mName[10] = _T("TOAN_TRANG");
	m_mName[11] = _T("MACH");
	m_mName[12] = _T("HUYET_AP");
	m_mName[13] = _T("NHIET_DO");
	m_mName[14] = _T("OI_VO");
	m_mName[15] = _T("TIENG");
	m_mName[16] = _T("NUOC_OI");
	m_mName[17] = _T("CACH_DE");
	m_mName[18] = _T("LUC");
	m_mName[19] = _T("LY_DO");
	m_mName[20] = _T("NU_HO_SINH");
	m_mName[21] = _T("APGAR_1P");
	m_mName[22] = _T("APGAR_5P");
	m_mName[23] = _T("CAN_NANG");
	m_mName[24] = _T("YES1");
	m_mName[25] = _T("YES2");
	m_mName[26] = _T("YES3");
	m_mName[27] = _T("YES4");
	m_mName[28] = _T("YES5");
	m_mName[29] = _T("YES6");
	m_mName[30] = _T("YES7");
	m_mName[31] = _T("YES8");
	m_mName[32] = _T("CO_THE");
	m_mName[33] = _T("NU_HO_SINH2");
	m_mName[34] = _T("CAN");
	m_mName[35] = _T("CHIEU_DAI");
	m_mName[36] = _T("VONG_DAU");
	m_mName[37] = _T("VONG_NGUC");
	m_mName[38] = _T("TOAN_THAN");
	m_mName[39] = _T("NHIET_DO2");
	m_mName[40] = _T("HONG_HAO");
	m_mName[41] = _T("XANH_TAI");
	m_mName[42] = _T("VANG");
	m_mName[43] = _T("TIM");
	m_mName[44] = _T("NHIP_THO");
	m_mName[45] = _T("NHIP_PHOI");
	m_mName[46] = _T("SILVERMAN");
	m_mName[47] = _T("NHIP_TIM");
	m_mName[48] = _T("BUNG");
	m_mName[49] = _T("CQ_SINHDUC");
	m_mName[50] = _T("XUONG_KHOP");
	m_mName[51] = _T("PHAN_XA");
	m_mName[52] = _T("TL_CO");
	m_mName[53] = _T("CAC_BPKHAC");
	m_mName[54] = _T("KET_LUAN");
	m_mName[55] = _T("TUOI_THAI");
	m_mName[56] = _T("THEO_DOI");

	for (int i = 1; i < m_mName.GetCount() + 1; i++)
	{
		m_mName.Lookup(i, tmpStr2);
		szSQL.Format(_T("SELECT to_char(hde_value) as hde_value FROM hms_doc_emr WHERE hde_type = 'BENHAN_SOSINH' AND hde_patientno = %d AND hde_docno = %d AND hde_name = '%s'"), nPatientNo, nDocno, tmpStr2);
		rs.ExecSQL(szSQL);
		if (!rs.IsEOF())
		{
			tmpStr = rs.GetValue(_T("hde_value"));
			rptHeader = rpt.GetReportHeader();
			rptHeader2 = rpt2.GetReportHeader();
			if (i == 1)
				rptHeader->SetValue(_T("chandoansobo"), tmpStr);
			if (i == 2)
				rptHeader->SetValue(_T("ngaycdsb"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			if (i == 3)
				rptHeader->SetValue(_T("bscdsb"), tmpStr);
			if (i == 4)
				rptHeader->SetValue(_T("chandoanphanbiet"), tmpStr);
			if (i == 5)
				rptHeader->SetValue(_T("ngaycdpb"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			if (i == 6)
				rptHeader->SetValue(_T("bscdpb"), tmpStr);
			if (i == 7)
				rptHeader->SetValue(_T("chandoanxacdinh"), tmpStr);
			if (i == 8)
				rptHeader->SetValue(_T("ngaycdxd"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			if (i == 9)
				rptHeader->SetValue(_T("bscdxd"), tmpStr);
			if (i == 10)
				rptHeader2->SetValue(_T("c1"), tmpStr);
			if (i == 11)
				rptHeader2->SetValue(_T("c2"), tmpStr);
			if (i == 12)
				rptHeader2->SetValue(_T("c3"), tmpStr);
			if (i == 13)
				rptHeader2->SetValue(_T("c4"), tmpStr);
			if (i == 14)
				rptHeader2->SetValue(_T("c5"), tmpStr);
			if (i == 15)
				rptHeader2->SetValue(_T("c6"), tmpStr);
			if (i == 16)
				rptHeader2->SetValue(_T("c7"), tmpStr);
			if (i == 17)
				rptHeader2->SetValue(_T("c8"), tmpStr);
			if (i == 18)
				rptHeader2->SetValue(_T("c9"), tmpStr);
			if (i == 19)
				rptHeader2->SetValue(_T("c10"), tmpStr);
			if (i == 20)
				rptHeader2->SetValue(_T("c11"), tmpStr);
			if (i == 21)
				rptHeader2->SetValue(_T("c12"), tmpStr);
			if (i == 22)
				rptHeader2->SetValue(_T("c13"), tmpStr);
			if (i == 23)
				rptHeader2->SetValue(_T("c14"), tmpStr);
			if (i == 24)
				if (tmpStr == _T("Y"))
					rptHeader2->SetValue(_T("c15"), _T("X"));
				else
					rptHeader2->SetValue(_T("c16"), _T("X"));
			if (i == 25)
				if (tmpStr == _T("Y"))
					rptHeader2->SetValue(_T("c17"), _T("X"));
				else
					rptHeader2->SetValue(_T("c18"), _T("X"));
			if (i == 26)
				if (tmpStr == _T("Y"))
					rptHeader2->SetValue(_T("c19"), _T("X"));
				else
					rptHeader2->SetValue(_T("c20"), _T("X"));
			if (i == 27)
				if (tmpStr == _T("Y"))
					rptHeader2->SetValue(_T("c21"), _T("X"));
				else
					rptHeader2->SetValue(_T("c22"), _T("X"));
			if (i == 28)
				if (tmpStr == _T("Y"))
					rptHeader2->SetValue(_T("c23"), _T("X"));
				else
					rptHeader2->SetValue(_T("c24"), _T("X"));
			if (i == 29)
				if (tmpStr == _T("Y"))
					rptHeader2->SetValue(_T("c25"), _T("X"));
				else
					rptHeader2->SetValue(_T("c26"), _T("X"));
			if (i == 30)
				if (tmpStr == _T("Y"))
					rptHeader2->SetValue(_T("c27"), _T("X"));
				else
					rptHeader2->SetValue(_T("c28"), _T("X"));
			if (i == 31)
				if (tmpStr == _T("Y"))
					rptHeader2->SetValue(_T("c29"), _T("X"));
				else
					rptHeader2->SetValue(_T("c30"), _T("X"));
			if (i == 32)
				rptHeader2->SetValue(_T("c31"), tmpStr);
			if (i == 33)
				rptHeader2->SetValue(_T("c32"), tmpStr);
			if (i == 34)
				rptHeader2->SetValue(_T("c33"), tmpStr);
			if (i == 35)
				rptHeader2->SetValue(_T("c34"), tmpStr);
			if (i == 36)
				rptHeader2->SetValue(_T("c35"), tmpStr);
			if (i == 37)
				rptHeader2->SetValue(_T("c36"), tmpStr);
			if (i == 38)
				rptHeader2->SetValue(_T("c37"), tmpStr);
			if (i == 39)
				rptHeader2->SetValue(_T("c38"), tmpStr);
			if (i == 40)
				if (tmpStr == _T("0"))
					rptHeader2->SetValue(_T("c39"), _T("X"));
			if (i == 41)
				if (tmpStr == _T("0"))
					rptHeader2->SetValue(_T("c40"), _T("X"));
			if (i == 42)
				if (tmpStr == _T("0"))
					rptHeader2->SetValue(_T("c41"), _T("X"));
			if (i == 43)
				if (tmpStr == _T("0"))
					rptHeader2->SetValue(_T("c42"), _T("X"));
			if (i == 44)
				rptHeader2->SetValue(_T("c43"), tmpStr);
			if (i == 45)
				rptHeader2->SetValue(_T("c44"), tmpStr);
			if (i == 46)
				rptHeader2->SetValue(_T("c45"), tmpStr);
			if (i == 47)
				rptHeader2->SetValue(_T("c46"), tmpStr);
			if (i == 48)
				rptHeader2->SetValue(_T("c47"), tmpStr);
			if (i == 49)
				rptHeader2->SetValue(_T("c48"), tmpStr);
			if (i == 50)
				rptHeader2->SetValue(_T("c49"), tmpStr);
			if (i == 51)
				rptHeader2->SetValue(_T("c50"), tmpStr);
			if (i == 52)
				rptHeader2->SetValue(_T("c51"), tmpStr);
			if (i == 53)
				rptHeader2->SetValue(_T("c52"), tmpStr);
			if (i == 54)
				rptHeader2->SetValue(_T("c53"), tmpStr);
			if (i == 55)
				rptHeader2->SetValue(_T("c54"), tmpStr);
			if (i == 56)
				rptHeader2->SetValue(_T("c55"), tmpStr);
		}
	}
	rpt.PrintPreview();
	rpt2.PrintPreview();
}

void CPrintForms::TM_OnPrintAssignPathology(long nOrderID) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptGroup = NULL, * rptDetail = NULL;
	CString szSQL, tmpStr, szDate, szWhere;

	szSQL.Format(_T("SELECT COUNT(*) FROM hms_assignpathology WHERE hap_orderid = %d"), nOrderID);
	rs.ExecSQL(szSQL);
	if (rs.GetIntValue() <= 0)
		return;

	if (!rpt.Init(_T("Reports\\HMS\\LAB_XNGIAIPHAUBENH.RPT")))
		return;

	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Department"), pMF->GetDepartmentName(pMF->GetDepartmentID()));

	szSQL.Format(_T(" SELECT") \
		_T(" htr_recordno AS recordno,") \
		_T(" docno,") \
		_T(" orderid,") \
		_T(" get_patientname(docno) AS patientname,") \
		_T(" hms_getagebydoc(docno) AS age,") \
		_T(" hms_getsex(hp_sex) AS sex,") \
		_T(" hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS address,") \
		_T(" hms_getobjectname(hd_object) AS pobject,") \
		_T(" hd_cardno AS cardno,") \
		_T(" (SELECT ss_desc FROM sys_sel WHERE ss_id = 'hms_rank' AND ss_code = hp_rank) AS prank,") \
		_T(" hp_workplace AS workplace,") \
		_T(" hms_getroomname(deptid, roomid) AS roomname,") \
		_T(" bedid AS bedid,") \
		_T(" htr_maindisease AS maindisease,") \
		_T(" pname") \
		_T(" FROM") \
		_T(" (") \
		_T(" SELECT") \
		_T(" hpc_docno AS docno,") \
		_T(" hpc_orderid AS orderid,") \
		_T(" hpc_deptid AS deptid,") \
		_T(" hpc_refidx AS refidx,") \
		_T(" hpc_roomid AS roomid,") \
		_T(" hpc_bedid AS bedid,") \
		_T(" LISTAGG(CAST(hfl_name AS VARCHAR2(1024)), ', ') WITHIN GROUP (ORDER BY hpcl_orderlineid) AS pname") \
		_T(" FROM hms_testorder") \
		_T(" LEFT JOIN hms_testorderline") \
		_T(" ON(hpc_orderid = hpcl_orderid)") \
		_T(" LEFT JOIN hms_fee_list") \
		_T(" ON(hpcl_itemid = hfl_feeid)") \
		_T(" WHERE hpc_orderid = %d") \
		_T(" GROUP BY") \
		_T(" hpc_docno,") \
		_T(" hpc_orderid,") \
		_T(" hpc_deptid,") \
		_T(" hpc_refidx,") \
		_T(" hpc_roomid,") \
		_T(" hpc_bedid") \
		_T(" UNION ALL") \
		_T(" SELECT") \
		_T(" hpc_docno AS docno,") \
		_T(" hpc_orderid AS orderid,") \
		_T(" hpc_deptid AS deptid,") \
		_T(" hpc_refidx AS refidx,") \
		_T(" hpc_roomid AS roomid,") \
		_T(" hpc_bedid AS bedid,") \
		_T(" LISTAGG(CAST(hfl_name AS VARCHAR2(1024)), ', ') WITHIN GROUP (ORDER BY hpcl_orderlineid) AS pname") \
		_T(" FROM hms_pacsorder") \
		_T(" LEFT JOIN hms_pacsorderline") \
		_T(" ON(hpc_orderid = hpcl_orderid)") \
		_T(" LEFT JOIN hms_fee_list") \
		_T(" ON(hpcl_itemid = hfl_feeid)") \
		_T(" WHERE hpc_orderid = %d") \
		_T(" GROUP BY") \
		_T(" hpc_docno,") \
		_T(" hpc_orderid,") \
		_T(" hpc_deptid,") \
		_T(" hpc_refidx,") \
		_T(" hpc_roomid,") \
		_T(" hpc_bedid") \
		_T(" )") \
		_T(" LEFT JOIN hms_doc") \
		_T(" ON(hd_docno = docno)") \
		_T(" LEFT JOIN hms_patient") \
		_T(" ON(hp_patientno = hd_patientno)") \
		_T(" LEFT JOIN hms_treatment_record") \
		_T(" ON(htr_docno = hd_docno AND htr_deptid = deptid AND htr_idx = refidx)"), nOrderID, nOrderID);
	rs.ExecSQL(szSQL);

	while (!rs.IsEOF())
	{
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("recordno")));
		rptHeader->SetValue(_T("DocumentNo"), rs.GetValue(_T("docno")));
		rptHeader->SetValue(_T("SheetNo"), rs.GetValue(_T("orderid")));
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("patientname")));
		rptHeader->SetValue(_T("Age"), rs.GetValue(_T("age")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("Address"), rs.GetValue(_T("address")));
		rptHeader->SetValue(_T("Object"), rs.GetValue(_T("pobject")));
		rptHeader->SetValue(_T("CardNo"), rs.GetValue(_T("cardno")));
		rptHeader->SetValue(_T("Rank"), rs.GetValue(_T("prank")));
		rptHeader->SetValue(_T("Workplace"), rs.GetValue(_T("workplace")));
		rptHeader->SetValue(_T("RoomName"), rs.GetValue(_T("roomname")));
		rptHeader->SetValue(_T("BedName"), rs.GetValue(_T("bedid")));
		rptHeader->SetValue(_T("Diagnostic"), rs.GetValue(_T("maindisease")));
		rptHeader->SetValue(_T("OrderName"), rs.GetValue(_T("pname")));
		rs.MoveNext();
	}

	szSQL.Format(_T(" SELECT hpc_docno             AS docno,") \
		_T("   get_patientname(hpc_docno) AS patientname,") \
		_T("   hpc_orderid                AS orderid,") \
		_T("   hap_diagnostic             AS diagnostic,") \
		_T("   hap_testsummarize          AS testsummarize,") \
		_T("   hap_treatmentprocess       AS treatmentprocess,") \
		_T("   hap_testrequest            AS testrequest,") \
		_T("   hap_medicalwaste           AS medicalwaste,") \
		_T("   hap_comment                AS pcomment,") \
		_T("   hap_solution               AS solution,") \
		_T("   hap_date                   AS pdate,") \
		_T("   hap_prevresult             AS prevresult,") \
		_T("   hap_totaltest              AS totaltest") \
		_T(" FROM hms_testorder") \
		_T(" LEFT JOIN hms_assignpathology") \
		_T(" ON(hpc_orderid    = hap_orderid)") \
		_T(" WHERE hpc_orderid = %d") \
		_T(" UNION ALL") \
		_T(" SELECT hpc_docno             AS docno,") \
		_T("   get_patientname(hpc_docno) AS patientname,") \
		_T("   hpc_orderid                AS orderid,") \
		_T("   hap_diagnostic             AS diagnostic,") \
		_T("   hap_testsummarize          AS testsummarize,") \
		_T("   hap_treatmentprocess       AS treatmentprocess,") \
		_T("   hap_testrequest            AS testrequest,") \
		_T("   hap_medicalwaste           AS medicalwaste,") \
		_T("   hap_comment                AS pcomment,") \
		_T("   hap_solution               AS solution,") \
		_T("   hap_date                   AS pdate,") \
		_T("   hap_prevresult             AS prevresult,") \
		_T("   hap_totaltest              AS totaltest") \
		_T(" FROM hms_pacsorder") \
		_T(" LEFT JOIN hms_assignpathology") \
		_T(" ON(hpc_orderid    = hap_orderid)") \
		_T(" WHERE hpc_orderid = %d"), nOrderID, nOrderID);
	rs.ExecSQL(szSQL);

	while (!rs.IsEOF())
	{
		rpt.GetReportFooter()->SetValue(_T("chandoan"), rs.GetValue(_T("diagnostic")));
		rpt.GetReportFooter()->SetValue(_T("tomtat"), rs.GetValue(_T("testsummarize")));
		rpt.GetReportFooter()->SetValue(_T("quatrinh"), rs.GetValue(_T("treatmentprocess")));
		rpt.GetReportFooter()->SetValue(_T("yeucau"), rs.GetValue(_T("testrequest")));
		rpt.GetReportFooter()->SetValue(_T("benhpham"), rs.GetValue(_T("medicalwaste")));
		rpt.GetReportFooter()->SetValue(_T("nhanxet"), rs.GetValue(_T("pcomment")));
		rpt.GetReportFooter()->SetValue(_T("codinh"), rs.GetValue(_T("solution")));
		rs.GetValue(_T("pdate"), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("luc"), CDateTime::Convert(tmpStr, yyyymmdd | hhmmss, ddmmyyyy | hhmmss));
		rpt.GetReportFooter()->SetValue(_T("ketqua"), rs.GetValue(_T("prevresult")));
		rpt.GetReportFooter()->SetValue(_T("tongso"), rs.GetValue(_T("totaltest")));
		rs.MoveNext();
	}
	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5),tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	tmpStr = GetDoctorName(pMF->GetCurrentUser());
	rpt.GetReportFooter()->SetValue(_T("Practitioner"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::TM_OnPrintAssignPathologyEX(long nOrderlineID)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptGroup = NULL, * rptDetail = NULL;
	CString szSQL, tmpStr, tmpStr2, szDate, szWhere;
	long nDocumentNo;

	szSQL.Format(_T("SELECT COUNT(*) FROM HMS_YEUCAUGIAIPHAUBENH WHERE HAP_ORDERLINEID = %d AND HAP_DOCNO=%ld AND HAP_phanloai = 'XNGPB'"), nOrderlineID, pMF->m_nDocumentNo);
	rs.ExecSQL(szSQL);
	if (rs.GetIntValue() <= 0)
		return;

	if (!rpt.Init(_T("Reports\\HMS\\LAB_XNGIAIPHAUBENH.RPT")))
		return;

	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Department"), pMF->GetDepartmentName(pMF->GetDepartmentID()));

	szSQL.Format(_T(" SELECT hpcl_docno             AS docno,") \
		_T("   hpcl_orderlineid            AS orderid,") \
		_T("   hpcl_orderid                AS orderidcode,") \
		_T("   get_patientname(hpcl_docno) AS patientname,") \
		_T("   CAST(TO_CHAR(hp_birthdate, 'YYYY') as integer) as YearOfBirth,") \
		_T("   sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T("   hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS Address,") \
		_T("   Hms_getobjectname(hd_object)                    AS Object,") \
		_T("   HAP_DIAGNOSTIC            AS chandoan,") \
		_T("   hfl_name                  AS tenxetnghiem,  ") \
		_T("   HAP_SINHTHIETDUOCNHAPTU   AS SINHTHIETDUOCNHAPTU,") \
		_T("   ss_desc				     AS codinhbangdungdich,") \
		_T("   hap_date                  AS ngayyeucau,") \
		_T("   HAP_TOMTATDAUHIEULAMSANG  AS tomtatdauhieulamsang,") \
		_T("   HAP_QUATRINHDIEUTRI       AS quatrinhdieutri,") \
		_T("   HAP_NHANXETDAITHE_PHIEUMO AS nhanxetdaithe_phieumo,") \
		_T("   HAP_NHANXETDAITHE_NOISOI  AS nhanxetdaithe_noisoi,") \
		_T("   HAP_NHANXETDAITHE_PHIEUMO") \
		_T("   ||' '") \
		_T("   || HAP_NHANXETDAITHE_NOISOI AS nhanxetdaithe,") \
		_T("   HAP_KETQUASINHTHIETLANTRUOC AS ketquasinhthietlantruoc,") \
		_T("   HAP_TONGSOXETNGHIEM         AS tongsoxetnghiem,") \
		_T("   get_username(hpc_doctor)    AS DoctorName") \
		_T(" FROM HMS_GPB_VIEW_LINE") \
		_T(" LEFT JOIN HMS_GPB_VIEW ON (hpcl_orderid=hpc_orderid)") \
		_T(" LEFT JOIN HMS_YEUCAUGIAIPHAUBENH") \
		_T(" ON (hpcl_orderlineid=hap_orderlineid)") \
		_T(" LEFT JOIN hms_fee_list") \
		_T(" ON (hpcl_itemid=hfl_feeid)") \
		_T(" LEFT JOIN hms_doc") \
		_T(" ON (hpcl_docno=hd_docno)") \
		_T(" LEFT JOIN hms_patient ON (hd_patientno=hp_patientno)") \
		_T(" LEFT JOIN sys_sel") \
		_T(" ON (ss_code           =hap_codinhbangdungdich") \
		_T(" AND ss_id             ='gpb_phanloai_dungdich')") \
		_T(" WHERE hpcl_orderlineid=%ld AND hpcl_docno=%ld"), nOrderlineID, pMF->m_nDocumentNo);

	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	while (!rs.IsEOF())
	{
		rptHeader->SetValue(_T("DocumentNo"), rs.GetValue(_T("docno")));
		rs.GetValue(_T("docno"), nDocumentNo);
		tmpStr.Format(_T("%ld"), nDocumentNo);
		rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);


		rptHeader->SetValue(_T("SheetNo"), rs.GetValue(_T("orderid")));
		rptHeader->SetValue(_T("SheetNo1"), rs.GetValue(_T("orderidcode")));
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("patientname")));
		rptHeader->SetValue(_T("YearOfBirth"), rs.GetValue(_T("YearOfBirth")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("Address"), rs.GetValue(_T("address")));
		rptHeader->SetValue(_T("Object"), rs.GetValue(_T("Object")));
		rptHeader->SetValue(_T("chandoan"), rs.GetValue(_T("chandoan")));
		rptHeader->SetValue(_T("tenxetnghiem"), rs.GetValue(_T("tenxetnghiem")));

		rpt.GetReportFooter()->SetValue(_T("SINHTHIETDUOCNHAPTU"), rs.GetValue(_T("SINHTHIETDUOCNHAPTU")));
		rpt.GetReportFooter()->SetValue(_T("codinhbangdungdich"), rs.GetValue(_T("codinhbangdungdich")));
		rs.GetValue(_T("ngayyeucau"), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("ngayyeucau"), CDateTime::Convert(tmpStr, yyyymmdd | hhmmss, ddmmyyyy | hhmmss));

		rpt.GetReportFooter()->SetValue(_T("tomtatdauhieulamsang"), rs.GetValue(_T("tomtatdauhieulamsang")));
		rpt.GetReportFooter()->SetValue(_T("quatrinhdieutri"), rs.GetValue(_T("quatrinhdieutri")));
		rpt.GetReportFooter()->SetValue(_T("nhanxetdaithe"), rs.GetValue(_T("nhanxetdaithe")));
		rpt.GetReportFooter()->SetValue(_T("ketquasinhthietlantruoc"), rs.GetValue(_T("ketquasinhthietlantruoc")));
		rpt.GetReportFooter()->SetValue(_T("tongsoxetnghiem"), rs.GetValue(_T("tongsoxetnghiem")));
		rpt.GetReportFooter()->SetValue(_T("DoctorName"), rs.GetValue(_T("DoctorName")));

		rs.MoveNext();
	}

	//szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	//rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	tmpStr = pMF->GetSysDateTime();
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PrintDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	/*tmpStr = GetDoctorName(pMF->GetCurrentUser());
	rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);*/
	rpt.PrintPreview();
}

void CPrintForms::TM_OnPrintAssignPathologywithcell(long nOrderlineID)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptGroup = NULL, * rptDetail = NULL;
	CString szSQL, tmpStr, tmpStr2, szDate, szWhere;
	long nDocumentNo;

	szSQL.Format(_T("SELECT COUNT(*) FROM HMS_YEUCAUGIAIPHAUBENH WHERE HAP_ORDERLINEID = %d AND HAP_DOCNO=%ld AND HAP_phanloai = 'XNGPBTB'"), nOrderlineID, pMF->m_nDocumentNo);
	rs.ExecSQL(szSQL);
	if (rs.GetIntValue() <= 0)
		return;

	if (!rpt.Init(_T("Reports\\HMS\\LAB_XNGIAIPHAUBENHTEBAO.RPT")))
		return;

	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Department"), pMF->GetDepartmentName(pMF->GetDepartmentID()));

	szSQL.Format(_T(" SELECT hpcl_docno             AS docno,") \
		_T("   hpcl_orderlineid            AS orderid,") \
		_T("   hpcl_orderid                AS orderidcode,") \
		_T("   get_patientname(hpcl_docno) AS patientname,") \
		_T("   CAST(TO_CHAR(hp_birthdate, 'YYYY') as integer) as YearOfBirth,") \
		_T("   sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T("   hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS Address,") \
		_T("   Hms_getobjectname(hd_object)                    AS Object,") \
		_T("   HAP_DIAGNOSTIC            AS chandoan,") \
		_T("   hfl_name                  AS tenxetnghiem,  ") \
		_T("   HAP_vitri				 AS vitri,") \
		_T("   HAP_TOMTATDAUHIEULAMSANG  AS tomtatdauhieulamsang,") \
		_T("   HAP_QUATRINHDIEUTRI       AS quatrinhdieutri,") \
		_T("   HAP_ketquatebaolantruoc   AS ketquatebaolantruoc,") \
		_T("   get_username(hpc_doctor)    AS DoctorName") \
		_T(" FROM HMS_GPB_VIEW_LINE") \
		_T(" LEFT JOIN HMS_GPB_VIEW ON (hpcl_orderid=hpc_orderid)") \
		_T(" LEFT JOIN HMS_YEUCAUGIAIPHAUBENH") \
		_T(" ON (hpcl_orderlineid=hap_orderlineid)") \
		_T(" LEFT JOIN hms_fee_list") \
		_T(" ON (hpcl_itemid=hfl_feeid)") \
		_T(" LEFT JOIN hms_doc") \
		_T(" ON (hpcl_docno=hd_docno)") \
		_T(" LEFT JOIN hms_patient ON (hd_patientno=hp_patientno)") \
		_T(" LEFT JOIN sys_sel") \
		_T(" ON (ss_code           =hap_codinhbangdungdich") \
		_T(" AND ss_id             ='gpb_phanloai_dungdich')") \
		_T(" WHERE hpcl_orderlineid=%ld AND hpcl_docno=%ld"), nOrderlineID, pMF->m_nDocumentNo);


	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	while (!rs.IsEOF())
	{
		rptHeader->SetValue(_T("DocumentNo"), rs.GetValue(_T("docno")));

		rs.GetValue(_T("docno"), nDocumentNo);
		tmpStr.Format(_T("%ld"), nDocumentNo);
		rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);
		rptHeader->SetValue(_T("SheetNo"), rs.GetValue(_T("orderid")));
		rptHeader->SetValue(_T("SheetNo1"), rs.GetValue(_T("orderidcode")));
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("patientname")));
		rptHeader->SetValue(_T("YearOfBirth"), rs.GetValue(_T("YearOfBirth")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("Address"), rs.GetValue(_T("address")));
		rptHeader->SetValue(_T("Object"), rs.GetValue(_T("Object")));
		rptHeader->SetValue(_T("chandoan"), rs.GetValue(_T("chandoan")));
		rptHeader->SetValue(_T("tenxetnghiem"), rs.GetValue(_T("tenxetnghiem")));

		rpt.GetReportFooter()->SetValue(_T("vitri"), rs.GetValue(_T("vitri")));
		rpt.GetReportFooter()->SetValue(_T("tomtatdauhieulamsang"), rs.GetValue(_T("tomtatdauhieulamsang")));
		rpt.GetReportFooter()->SetValue(_T("quatrinhdieutri"), rs.GetValue(_T("quatrinhdieutri")));
		rpt.GetReportFooter()->SetValue(_T("ketquatebaolantruoc"), rs.GetValue(_T("ketquatebaolantruoc")));
		rpt.GetReportFooter()->SetValue(_T("DoctorName"), rs.GetValue(_T("DoctorName")));

		rs.MoveNext();
	}

	//szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	//rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	tmpStr = pMF->GetSysDateTime();
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PrintDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	/*tmpStr = GetDoctorName(pMF->GetCurrentUser());
	rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);*/
	rpt.PrintPreview();
}

void CPrintForms::TM_OnPrintAssignPathologycoldcut(long nOrderlineID)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptGroup = NULL, * rptDetail = NULL;
	CString szSQL, tmpStr, tmpStr2, szDate, szWhere;
	long nDocumentNo;

	szSQL.Format(_T("SELECT COUNT(*) FROM HMS_YEUCAUGIAIPHAUBENH WHERE HAP_ORDERLINEID = %d AND HAP_DOCNO=%ld AND HAP_phanloai = 'XNGPBCL'"), nOrderlineID, pMF->m_nDocumentNo);
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"),szSQL);
	if (rs.GetIntValue() <= 0)
		return;

	if (!rpt.Init(_T("Reports\\HMS\\LAB_XNGIAIPHAUBENH_CATLANH.RPT")))
		return;

	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Department"), pMF->GetDepartmentName(pMF->GetDepartmentID()));

	szSQL.Format(_T(" SELECT hpcl_docno             AS docno,") \
		_T("   hpcl_orderlineid            AS orderid,") \
		_T("   hpcl_orderid                AS orderidcode,") \
		_T("   get_patientname(hpcl_docno) AS patientname,") \
		_T("   CAST(TO_CHAR(hp_birthdate, 'YYYY') as integer) as YearOfBirth,") \
		_T("   sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T("   hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS Address,") \
		_T("   Hms_getobjectname(hd_object)                    AS Object,") \
		_T("   HAP_DIAGNOSTIC            AS chandoan,") \
		_T("   hfl_name                  AS tenxetnghiem,  ") \
		_T("   HAP_SINHTHIETDUOCNHAPTU   AS SINHTHIETDUOCNHAPTU,") \
		_T("   ss_desc				     AS codinhbangdungdich,") \
		_T("   hap_date                  AS ngayyeucau,") \
		_T("   HAP_TOMTATDAUHIEULAMSANG  AS tomtatdauhieulamsang,") \
		_T("   HAP_QUATRINHDIEUTRI       AS quatrinhdieutri,") \
		_T("   HAP_NHANXETDAITHE_PHIEUMO AS nhanxetdaithe_phieumo,") \
		_T("   HAP_NHANXETDAITHE_NOISOI  AS nhanxetdaithe_noisoi,") \
		_T("   HAP_NHANXETDAITHE_PHIEUMO") \
		_T("   ||' '") \
		_T("   || HAP_NHANXETDAITHE_NOISOI AS nhanxetdaithe,") \
		_T("   HAP_KETQUASINHTHIETLANTRUOC AS ketquasinhthietlantruoc,") \
		_T("   HAP_TONGSOXETNGHIEM         AS tongsoxetnghiem,") \
		_T("   get_username(hpc_doctor)    AS DoctorName") \
		_T(" FROM HMS_GPB_VIEW_LINE") \
		_T(" LEFT JOIN HMS_GPB_VIEW ON (hpcl_orderid=hpc_orderid)") \
		_T(" LEFT JOIN HMS_YEUCAUGIAIPHAUBENH") \
		_T(" ON (hpcl_orderlineid=hap_orderlineid)") \
		_T(" LEFT JOIN hms_fee_list") \
		_T(" ON (hpcl_itemid=hfl_feeid)") \
		_T(" LEFT JOIN hms_doc") \
		_T(" ON (hpcl_docno=hd_docno)") \
		_T(" LEFT JOIN hms_patient ON (hd_patientno=hp_patientno)") \
		_T(" LEFT JOIN sys_sel") \
		_T(" ON (ss_code           =hap_codinhbangdungdich") \
		_T(" AND ss_id             ='gpb_phanloai_dungdich')") \
		_T(" WHERE hpcl_orderlineid=%ld AND hpcl_docno=%ld"), nOrderlineID, pMF->m_nDocumentNo);


	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	while (!rs.IsEOF())
	{
		rptHeader->SetValue(_T("DocumentNo"), rs.GetValue(_T("docno")));
		rs.GetValue(_T("docno"), nDocumentNo);
		tmpStr.Format(_T("%ld"), nDocumentNo);
		rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);

		rptHeader->SetValue(_T("SheetNo"), rs.GetValue(_T("orderid")));
		rptHeader->SetValue(_T("SheetNo1"), rs.GetValue(_T("orderidcode")));
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("patientname")));
		rptHeader->SetValue(_T("YearOfBirth"), rs.GetValue(_T("YearOfBirth")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("Address"), rs.GetValue(_T("address")));
		rptHeader->SetValue(_T("Object"), rs.GetValue(_T("Object")));
		rptHeader->SetValue(_T("chandoan"), rs.GetValue(_T("chandoan")));
		rptHeader->SetValue(_T("tenxetnghiem"), rs.GetValue(_T("tenxetnghiem")));

		rpt.GetReportFooter()->SetValue(_T("SINHTHIETDUOCNHAPTU"), rs.GetValue(_T("SINHTHIETDUOCNHAPTU")));
		rpt.GetReportFooter()->SetValue(_T("codinhbangdungdich"), rs.GetValue(_T("codinhbangdungdich")));
		rs.GetValue(_T("ngayyeucau"), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("ngayyeucau"), CDateTime::Convert(tmpStr, yyyymmdd | hhmmss, ddmmyyyy | hhmmss));

		rpt.GetReportFooter()->SetValue(_T("tomtatdauhieulamsang"), rs.GetValue(_T("tomtatdauhieulamsang")));
		rpt.GetReportFooter()->SetValue(_T("quatrinhdieutri"), rs.GetValue(_T("quatrinhdieutri")));
		rpt.GetReportFooter()->SetValue(_T("nhanxetdaithe"), rs.GetValue(_T("nhanxetdaithe")));
		rpt.GetReportFooter()->SetValue(_T("ketquasinhthietlantruoc"), rs.GetValue(_T("ketquasinhthietlantruoc")));
		rpt.GetReportFooter()->SetValue(_T("tongsoxetnghiem"), rs.GetValue(_T("tongsoxetnghiem")));
		rpt.GetReportFooter()->SetValue(_T("DoctorName"), rs.GetValue(_T("DoctorName")));

		rs.MoveNext();
	}

	//szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	//rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	tmpStr = pMF->GetSysDateTime();
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PrintDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	/*tmpStr = GetDoctorName(pMF->GetCurrentUser());
	rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);*/
	rpt.PrintPreview();}


void CPrintForms::TM_OnPrintDecoctionPrescription(long nDocNo, long nBatchID) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptGroup = NULL, * rptDetail = NULL, * rptFooter = NULL;
	CString szSQL, tmpStr, szDate, szWhere, szThang, szFromDate, szToDate, szOrderID;
	int nIdx = 1;
	if (!rpt.Init(_T("Reports\\HMS\\PMS_TREATMENTDRUG.RPT")))
		return;

	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Department"), pMF->GetDepartmentName(pMF->GetDepartmentID()));

	szSQL.Format(_T(" SELECT htr_recordno            AS recordno,") \
		_T("   hpo_docno                    AS docno,") \
		_T("   get_patientname(hpo_docno)       AS patientname,") \
		_T("   hms_getagebydoc(hpo_docno)       AS age,") \
		_T("   hms_getsex(hp_sex)           AS sex,") \
		_T("   hms_getobjectname(hd_object) AS pobject,") \
		_T("   (SELECT ss_desc FROM sys_sel WHERE ss_id = 'hms_rank' AND ss_code = hp_rank") \
		_T("   )                               AS prank,") \
		_T("   hp_workplace                    AS workplace,") \
		_T("   hms_getroomname(hpo_deptid, hpo_roomid) AS roomname,") \
		_T("   hpo_bedid                           AS bedid,") \
		_T("   htr_maindisease                 AS maindisease,") \
		_T("   hd_reldisease                   AS reldisease,") \
		_T("   COUNT(hpo_orderdate)            AS thang,") \
		_T("   MIN(hpo_orderdate)              AS minorder,") \
		_T("   MAX(hpo_orderdate)              AS maxorder,") \
		_T("   MIN(hpo_orderid)                AS orderid") \
		_T(" FROM hms_ipharmaorder") \
		_T(" LEFT JOIN hms_doc") \
		_T(" ON(hd_docno = hpo_docno)") \
		_T(" LEFT JOIN hms_patient") \
		_T(" ON(hd_patientno = hp_patientno)") \
		_T(" LEFT JOIN hms_treatment_record") \
		_T(" ON(htr_docno        = hpo_docno") \
		_T(" AND htr_deptid      = hpo_deptid") \
		_T(" AND htr_idx         = hpo_refidx)") \
		_T(" WHERE hpo_ordertype = 'D'") \
		_T(" AND hpo_docno       = %d") \
		_T(" AND hpo_batch_id    = %d") \
		_T(" GROUP BY htr_recordno,") \
		_T("   hpo_docno,") \
		_T("   hp_sex,") \
		_T("   hd_object,") \
		_T("   hp_rank,") \
		_T("   hp_workplace,") \
		_T("   hpo_deptid, hpo_roomid,") \
		_T("   hpo_bedid,") \
		_T("   htr_maindisease,") \
		_T("   hd_reldisease"), nDocNo, nBatchID);
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	while (!rs.IsEOF())
	{
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("recordno")));
		rptHeader->SetValue(_T("DocumentNo"), rs.GetValue(_T("docno")));
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("patientname")));
		rptHeader->SetValue(_T("Age"), rs.GetValue(_T("age")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("Object"), rs.GetValue(_T("pobject")));
		rptHeader->SetValue(_T("Rank"), rs.GetValue(_T("prank")));
		rptHeader->SetValue(_T("Workplace"), rs.GetValue(_T("workplace")));
		rptHeader->SetValue(_T("RoomName"), rs.GetValue(_T("roomname")));
		rptHeader->SetValue(_T("BedName"), rs.GetValue(_T("bedid")));
		rptHeader->SetValue(_T("Diagnostic"), rs.GetValue(_T("maindisease")));
		rptHeader->SetValue(_T("RelationDisease"), rs.GetValue(_T("reldisease")));
		rs.GetValue(_T("thang"), szThang);
		rs.GetValue(_T("minorder"), szFromDate);
		rs.GetValue(_T("maxorder"), szToDate);
		rs.GetValue(_T("orderid"), szOrderID);
		rs.MoveNext();
	}

	szSQL.Format(_T(" SELECT") \
		_T(" product_name AS product_name,") \
		_T(" hpol_qtyissue AS qty") \
		_T(" FROM hms_ipharmaorderline") \
		_T(" LEFT JOIN m_productitem_view") \
		_T(" ON(product_item_id = hpol_product_item_id)") \
		_T(" WHERE hpol_orderid = '%s'") \
		_T(" ORDER BY  ") \
		_T(" hpol_line,") \
		_T(" product_name,") \
		_T(" product_uomname"), szOrderID);
	rs.ExecSQL(szSQL);

	while (!rs.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx++));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("product_name")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("qty")));
		rs.MoveNext();
	}

	rptFooter = rpt.GetReportFooter();
	rptFooter->SetValue(_T("Total"), int2str(nIdx - 1));
	rptFooter->SetValue(_T("numberdate"), szThang);
	rptFooter->SetValue(_T("mindate"), CDate::Convert(szFromDate, yyyymmdd, ddmmyyyy));
	rptFooter->SetValue(_T("maxdate"), CDate::Convert(szToDate, yyyymmdd, ddmmyyyy));

	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rptFooter->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rptFooter->SetValue(_T("PrintDate"), szDate);
	tmpStr = GetDoctorName(pMF->GetCurrentUser());
	rptFooter->SetValue(_T("Practitioner"), tmpStr);
	rpt.PrintPreview();
}

void CPrintForms::TM_OnPrintDailyDrugEx(long nDocNo, long nOID, CString szOrderDate)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();//mainFramePointer//pGuiMnFrm//UDT:MF=MainFrame, rs=RecordSet, p=Pointer, tmp=temp 
	CReport rpt;
	CRecord rsReport(&pMF->m_db);//tmpRecord//tmpRec
	CRecord rs(&pMF->m_db);//transactionRecord//transactionRecd//trsactionRecord//tstRcd
	CRecord rs2(&pMF->m_db);//itemRecord
	CRecord rst(&pMF->m_db);//typeSortRecord
	CRecord rsp(&pMF->m_db);//qtyPsychoRecord
	CString szGroup, szTitle, szNote;
	CString tmpStr, tmpStr2, szSQL, szDesc, szDate, szOrderBy, szStorageCategory, szOrderType;//orderTypeStr, storageCategoryStr(storgCatgryStr, stoCat),
	//orderByStr, tmpStr2, tmpStr, sqlStr
	int nStorage_id = 0, nBreak = 0;//int storageIndex = 0;
	CString szID;
	long nProductID = 0, nProductItemID = 0;//productIndex, productItemIndex

	szID.Format(_T("%ld"), nOID);

	double	nTotalAmount = 0, nAmount = 0, nAmountServ = 0, nTotalAmountServ = 0;//amountTotal, amountServiceTotal//amntServcTotal//amntServTotal//amountServiceTotl
	int		nQty, nTotalItem = 1;//itemCount 
	//int		nPrint=0;
	//bool bDirect = false;

	szOrderBy.Format(_T(" ORDER BY name, unit, price "));
	szSQL.Format(_T(" SELECT distinct mt_orderno, ") \
		_T("        mt_orderdate, ") \
		_T("        mt_approveddate, ") \
		_T("        mt_postedby, ") \
		_T("        mt_storage_id, ") \
		_T("        Get_storagename(mt_storage_id)          AS mt_storage_name, ") \
		_T("        Get_storagename(mt_storage_to_id)       AS mt_storageto_name, ") \
		_T("        Get_departmentname(mt_department_id)    AS mt_department_name, ") \
		_T("        Get_departmentname(mt_department_to_id) AS mt_departmentto_name, ") \
		_T("        mt_doctype, ") \
		_T("        mt_description, ") \
		_T("		mt_objecttype, ")
		_T("		hpo_ordertype, mt_documentno, mtb_ordertype,  ") \
		_T("   GET_PATIENTNAME(hpo_docno) as PatientName,") \
		_T("   CAST(TO_CHAR(hp_birthdate, 'YYYY') as integer) as YearOfBirth,  ") \
		_T("   hpo_docno as DocumentNo,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex") \
		_T(" FROM   m_transaction ") \
		_T(" LEFT JOIN m_transaction_batch ON(mtb_orderno = mt_orderno) ") \
		_T(" LEFT JOIN hms_ipharmaorder ON (mt_doctype = 'DMO' AND hpo_transaction_id = mt_transaction_id)") \
		_T(" LEFT JOIN hms_doc ON (hpo_docno=hd_docno)") \
		_T(" LEFT JOIN HMS_PATIENT ON (hd_patientno=hp_patientno)") \
		_T(" WHERE  MTB_TRANSACTION_BATCH_ID = %ld AND hpo_docno = %ld") \
		_T(" AND mt_status NOT IN ('O', 'C')"), nOID, nDocNo);

	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
		return;
	CString szType, szReportName, szSendBy, szObjectType;//reportNameStr, sendByStr, objectTypeStr
	CString szOrderCategory;

	rs.GetValue(_T("mt_doctype"), szType);
	rs.GetValue(_T("mt_orderno"), szID);
	rs.GetValue(_T("hpo_ordertype"), szOrderType);
	if (szType == _T("DPO") || szType == _T("DMO") || szType == _T("CSO"))
	{
		szOrderBy.Format(_T(" ORDER BY product_uomindex, product_name, product_uomname "));
	}
	else if (szType == _T("DDO"))
	{
		szOrderBy.Format(_T(" ORDER BY product_name, product_uomname "));
	}
	rs.GetValue(_T("mt_postedby"), szSendBy);
	rs.GetValue(_T("mt_description"), szDesc);

	rs.GetValue(_T("mt_storage_id"), nStorage_id);
	rs.GetValue(_T("mt_objecttype"), szObjectType);


	//Kiem tra kho dich vu
	if (szObjectType == _T("S"))
		szStorageCategory = _T("S");
	else
	{
		szSQL.Format(_T("SELECT msl_category category FROM m_storagelist WHERE msl_storage_id = %d"), nStorage_id);
		rsReport.ExecSQL(szSQL);
		rsReport.GetValue(_T("category"), szStorageCategory);
	}
	rs.GetValue(_T("mtb_ordertype"), szOrderCategory);



	if (szType == _T("DPO") || szType == _T("DMO") || szType == _T("DDO") || szType == _T("CSO"))
	{
		szSQL.Format(_T(" SELECT DISTINCT pmdt_name,") \
			_T("   pmdt_desc,") \
			_T("   pmdt_reportname, pmdt_index, pmdt_printtype  ") \
			_T(" FROM pms_drugtype, M_TRANSACTION,") \
			_T("   m_transactionline, M_TRANSACTION_BATCH,HMS_IPHARMAORDER,") \
			_T("   m_productitem_view") \
			_T(" WHERE MTB_TRANSACTION_BATCH_ID =%ld AND hpo_docno=%ld") \
			_T(" AND MTL_TRANSACTION_ID = HPO_TRANSACTION_ID AND mt_transaction_id = MTL_TRANSACTION_ID AND mtb_orderno = mt_orderno") \
			_T(" AND mtl_product_item_id  =product_item_id") \
			_T(" AND instr(pmdt_desc, product_producttype) > 0") \
			_T(" ORDER BY pmdt_index "), nOID, nDocNo);
		rst.ExecSQL(szSQL);
		//_msg(_T("%s"), szSQL);
		while (!rst.IsEOF())
		{
			rst.GetValue(_T("pmdt_name"), tmpStr);
			StringUpper(tmpStr, szTitle);
			rst.GetValue(_T("pmdt_desc"), szGroup);
			szGroup.Trim();

			rst.GetValue(_T("pmdt_reportname"), tmpStr);
			//_msg(_T("%s"), szStorageCategory);
			if (!tmpStr.IsEmpty())
				if (szStorageCategory == _T("S"))
					szReportName.Format(_T("Reports/HMS/PMS_DRUGORDER2TBDV_A3A.RPT"), tmpStr);
				else
					szReportName.Format(_T("Reports/HMS/PMS_DRUGORDER2TBBH_A3A.RPT"), tmpStr);

			if (!rpt.Init(szReportName))
				return;

			//Report Header
			rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
			rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
			if (szStorageCategory != _T("S"))
				rpt.GetReportHeader()->Format(_T("TITLE"), szTitle);
			rs.GetValue(_T("mt_orderdate"), tmpStr);
			szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);
			rpt.GetReportHeader()->SetValue(_T("OrderID"), szID);
			if (szOrderType == _T("M"))
				rpt.GetReportHeader()->SetValue(_T("Purpose"), _T("\x44\xE0nh \x63ho \x63\xE1\x63 \x63\x61 ph\x1EABu thu\x1EADt, th\x1EE7 thu\x1EADt"));
			rs.GetValue(_T("mt_statusdesc"), tmpStr);
			//tmpStr = GetStatusString(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
			rs.GetValue(_T("mt_storage_name"), tmpStr);
			//tmpStr = GetStorageName(ToInt(tmpStr));
			rpt.GetReportHeader()->SetValue(_T("FromStock"), tmpStr);
			rpt.GetReportHeader()->SetValue(_T("Comment"), szDesc);

			rs.GetValue(_T("mt_storageto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("ToStock"), tmpStr);

			rs.GetValue(_T("mt_department_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

			rs.GetValue(_T("mt_departmentto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("DepartmentTo"), tmpStr);
			tmpStr.Empty();

			rs.GetValue(_T("PatientName"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);


			rs.GetValue(_T("YearOfBirth"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

			rs.GetValue(_T("DocumentNo"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);

			rs.GetValue(_T("sex"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("sex"), tmpStr);

			rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

			if (pMF->GetModuleID() == _T("MA"))
			{
				rs.GetValue(_T("mt_documentno"), tmpStr);
				rpt.GetReportHeader()->SetValue(_T("ReferenceNo"), tmpStr);
			}

			if (szOrderCategory == _T("C"))
			{
				rpt.GetReportHeader()->SetValue(_T("OrderCategory"), _T("Phiếu lĩnh thuốc, hóa chất pha chế"));
			}
			else
			{
				rpt.GetReportHeader()->SetValue(_T("OrderCategory"), _T(""));
			}

			//*?Lay gia ban tu line thuoc
			//Page Header
			//Report Detail
			if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
				szSQL.Format(_T(" SELECT product_id                             AS id, ") \
					_T("		product_item_id item_id,") \
					_T("        product_name                           AS name, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					_T("        Sum(mtl_qtyservice)                    AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        mtl_saleprice                      AS price, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN M_TRANSACTION ON (mt_transaction_id = MTL_TRANSACTION_ID) ") \
					_T(" LEFT JOIN M_TRANSACTION_BATCH ON (mtb_orderno = mt_orderno)") \
					_T(" LEFT JOIN hms_ipharmaorder ON (MTL_TRANSACTION_ID = HPO_TRANSACTION_ID)") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  MTB_TRANSACTION_BATCH_ID = %ld and hpo_docno= %ld") \
					_T("        AND trunc(hpo_orderdate) = to_date('%s','yyyy/mm/dd')") \
					_T("        AND product_producttype NOT IN('A1130', 'A1140') ") \
					_T(" GROUP  BY product_id, ") \
					_T("		   product_item_id,") \
					_T("           product_name, ") \
					_T("           product_uomname, ") \
					_T("		   mtl_saleprice,") \
					_T("           product_uomindex ") \
					_T("		   %s "), nOID, nDocNo, szOrderDate, szOrderBy);
			else
				szSQL.Format(_T(" SELECT product_id                AS id, ") \
					_T("		product_item_id                        AS item_id, ") \
					_T("        product_name                           AS name, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					_T("        Sum(mtl_qtyservice)                    AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        mtl_saleprice                      AS price, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount, ") \
					_T("        product_lotno                          AS lotno, ") \
					_T("        product_expdate                        AS expdate ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN M_TRANSACTION ON (mt_transaction_id = MTL_TRANSACTION_ID) ") \
					_T(" LEFT JOIN M_TRANSACTION_BATCH ON (mtb_orderno = mt_orderno)") \
					_T(" LEFT JOIN hms_ipharmaorder ON (MTL_TRANSACTION_ID = HPO_TRANSACTION_ID)") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  MTB_TRANSACTION_BATCH_ID = %ld and hpo_docno= %ld") \
					_T("        AND trunc(hpo_orderdate) = to_date('%s','yyyy/mm/dd')") \
					_T("        AND product_producttype IN(%s) ") \
					_T(" GROUP  BY product_id, ") \
					_T("		   product_item_id,") \
					_T("           product_name, ") \
					_T("           product_uomname, ") \
					_T("           mtl_saleprice, ") \
					_T("           product_uomindex, ") \
					_T("           product_lotno, ") \
					_T("           product_expdate ") \
					_T("		   %s "), nOID, nDocNo, szOrderDate, szGroup, szOrderBy);

			rs2.ExecSQL(szSQL);
			//_msg(_T("%s"), szSQL);
			if (rs2.IsEOF()) {
				rst.MoveNext();
				continue;

			}
			if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
			{
				nBreak++;
			}
			CReportSection* rptDetail = rpt.GetDetail(0);
			rpt.ResetContent();
			nTotalItem = 1;
			nTotalAmount = 0;
			CString szItemId;
			while (!rs2.IsEOF())
			{
				rptDetail = rpt.AddDetail();
				rs2.GetValue(_T("id"), nProductID);
				rs2.GetValue(_T("item_id"), nProductItemID);
				tmpStr.Format(_T("%d"), nTotalItem++);
				rptDetail->SetValue(_T("1"), tmpStr);
				rs2.GetValue(_T("name"), tmpStr);
				rptDetail->SetValue(_T("2"), tmpStr);
				rs2.GetValue(_T("unit"), tmpStr);
				rptDetail->SetValue(_T("3"), tmpStr);
				rs2.GetValue(_T("qtyorder"), nQty);

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 || szGroup.Find(_T("'A2000'")) != -1 || szOrderType == _T("M"))
					MoneyToString(ToString(nQty), szNote);
				else
					szNote.Empty();
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4"), tmpStr2);

				rs2.GetValue(_T("qtysold"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.1"), tmpStr2);

				rs2.GetValue(_T("qtypolicy"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.2"), tmpStr2);

				rs2.GetValue(_T("qtysoldins"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.3"), tmpStr2);
				rs2.GetValue(_T("qtyotherins"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.4"), tmpStr2);

				rs2.GetValue(_T("qtyservice"), nQty);
				FormatCurrency(nQty, tmpStr2);
				_tprintf(_T("\r\nnStorageId: %d"), nStorage_id);
				rptDetail->SetValue(_T("4.5"), nStorage_id == 14 ? rs2.GetValue(_T("qtyorder")) : tmpStr2);

				rs2.GetValue(_T("qtyother"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.6"), tmpStr2);

				rs2.GetValue(_T("price"), tmpStr);
				rs2.GetValue(_T("amount"), nAmount);

				FormatCurrencyStr(tmpStr, tmpStr2);
				rptDetail->SetValue(_T("5"), tmpStr2);

				rptDetail->SetValue(_T("8"), tmpStr2);
				nTotalAmount += nAmount;

				FormatCurrency(nAmount, tmpStr2);
				rptDetail->SetValue(_T("7"), tmpStr2);

				rptDetail->SetValue(_T("9"), tmpStr2);

				rptDetail->SetValue(_T("6"), szNote);

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1)
				{
					rs2.GetValue(_T("lotno"), tmpStr);
					rptDetail->SetValue(_T("10"), tmpStr);

					rs2.GetValue(_T("expdate"), tmpStr);
					rptDetail->SetValue(_T("11"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
				}

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 ||
					szGroup.Find(_T("'A2000'")) != -1 || szOrderType == _T("M"))
				{
					szSQL.Format(_T(" SELECT    hpo_docno            AS docno, ") \
						_T("           get_patientname(hpo_docno) AS pname, ") \
						_T("           SUM(hpol_qtyorder)   AS orderqty ") \
						_T(" FROM      hms_ipharmaorder ") \
						_T(" LEFT JOIN hms_ipharmaorderline ON( hpo_orderid = hpol_orderid ) ") \
						_T(" LEFT JOIN m_transactionline ON (MTL_TRANSACTION_ID = HPO_TRANSACTION_ID)") \

						_T(" LEFT JOIN M_TRANSACTION ON (mt_transaction_id = MTL_TRANSACTION_ID) ") \
						_T(" LEFT JOIN M_TRANSACTION_BATCH ON (mtb_orderno = mt_orderno) ") \


						_T(" WHERE     MTB_TRANSACTION_BATCH_ID = %ld and hpo_docno= %ld AND trunc(hpo_orderdate) = to_date('%s','yyyy/mm/dd')") \
						_T("       AND hpol_product_item_id = %ld ") \
						_T(" GROUP     BY hpo_docno ") \
						_T(" ORDER     BY pname "), nOID, nDocNo, szOrderDate, nProductItemID);
					rsp.ExecSQL(szSQL);
					//_msg(_T("%s"), szSQL);
					while (!rsp.IsEOF()) {
						rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
						rptDetail->SetValue(_T("1"), _T(""));
						rsp.GetValue(_T("pname"), tmpStr);
						rptDetail->SetValue(_T("2"), tmpStr);
						rsp.GetValue(_T("docno"), tmpStr);
						rptDetail->SetValue(_T("3"), tmpStr);
						rsp.GetValue(_T("orderqty"), nQty);
						FormatCurrency(nQty, tmpStr);
						rptDetail->SetValue(_T("4"), tmpStr);
						rptDetail->SetValue(_T("5"), _T(""));
						MoneyToString(ToString(nQty), szNote);
						rptDetail->SetValue(_T("6"), szNote);
						rsp.MoveNext();
					}
				}
				rs2.MoveNext();
			}
			//Page Footer
			//Report Footer
			rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
			tmpStr.Format(_T("%d"), nTotalItem - 1);
			rptDetail->SetValue(_T("TotalItem"), tmpStr);
			tmpStr.Format(_T("%.0f"), nTotalAmount);
			FormatCurrencyStr(tmpStr, tmpStr2);
			rptDetail->SetValue(_T("TotalAmount"), tmpStr2);

			MoneyToString(tmpStr, tmpStr2);
			tmpStr.Format(_T("%s \x111\x1ED3ng."), tmpStr2);
			rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);

			CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
			if (img)
			{
				//img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
				//img->SetFixedHeight(false);
			}

			rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

			tmpStr = pMF->GetSysDate();
			szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
			rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

			rpt.PrintPreview();
			//_msg(_T("%s %s"), GroupStr, szGroup);
			if (nBreak > 0)
				break;
			rst.MoveNext();
		}
	}
}

void CPrintForms::TM_OnPrintBenhTrinhDieuTriHoLy(long nDocNo, long nRefIdx, bool isPrintActive)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CTMChoosePrintDateDlg dlg(pMF, _T("PRINT_BENHTRINH"));
	dlg.m_nRefIdx = nRefIdx;
	dlg.m_nDocNo = nDocNo;
	if (isPrintActive)
		dlg.OnPrintBenhTrinhDieuTriSelect(true);
	else
		dlg.DoModal();
}

//Phieu truyen dich su dung cong khai thuoc
void CPrintForms::TM_OnPrintPhieuTDSDCongKhaiThuoc(long nBatchID, long nDocNo, CString szDate, long nTreatIdx)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();

	//Kiem tra neu khong phai in trong phieu du tru thi cho phep chon nhieu phieu in
	if (nBatchID <= 0)
	{
		CTMChoosePrintDateDlg dlg(pMF, _T("PRINT_PHIEUCONGKHAITHUOC"));
		dlg.m_nRefIdx = nTreatIdx;
		dlg.m_nDocNo = nDocNo;
        //dlg.PrintPhieuCongKhaiThuoc(nTreatIdx);
		dlg.DoModal();
		return;
	}


	CReport rpt;
	CRecord rs(&pMF->m_db);
	CRecord rsTDSD(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptDetail = NULL, * rptFooter = NULL;
	CString szSQL, szSQLTDSD, tmpStr, szWhere, szIDx, szDateStr;
	int nIdx = 1;

	if (!rpt.Init(_T("Reports\\HMS\\TM_TDSDCONGKHAITHUOC.RPT")))
		return;

	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Department"), pMF->GetDepartmentName(pMF->GetDepartmentID()));

	szSQL.Format(_T("SELECT hd_docno                                        AS fdocno, ") \
		_T("       htr_recordno                                    AS frecord, ") \
		_T("       Trim(hp_surname ") \
		_T("            || ' ' ") \
		_T("            || hp_midname ") \
		_T("            || ' ' ") \
		_T("            || hp_firstname)                           AS fname, ") \
		_T("       Hms_getobjectname(hd_object)                    AS doituong, ") \
		_T("       Sys_sel_getname('sys_sex', hp_sex)              AS fsex, ") \
		_T("       extract (year from hp_birthdate)               AS fage, ") \
		_T("       htr_admitdate                                   AS ngayvaovien, ") \
		_T("       Extract(year FROM hp_birthdate)                 AS fyear, ") \
		_T("       hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS faddress, ") \
		_T("       htr_deptid                                      AS fdeptid, ") \
		_T("       hms_getactivebed(htr_docno, '%s')          AS buong, ") \
		_T("       htr_maindisease                                 AS fDiagnostic ") \
		_T("FROM   hms_treatment_record ") \
		_T("       LEFT JOIN hms_doc ") \
		_T("              ON( htr_docno = hd_docno ) ") \
		_T("       LEFT JOIN hms_patient ") \
		_T("              ON( hp_patientno = hd_patientno ) ") \
		_T("       LEFT JOIN hms_bed ") \
		_T("              ON( hb_docno = hd_docno ) ") \
		_T("WHERE  htr_docno = %ld ")
		, pMF->GetDepartmentID(), nDocNo);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	if (!rs.IsEOF())
	{
		rptHeader->SetValue(_T("Department"), rs.GetValue(_T("fdeptid")));
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("frecord")));
		rptHeader->SetValue(_T("DocNo"), rs.GetValue(_T("fdocno")));
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("frecord")));
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("fname")));
		rptHeader->SetValue(_T("YearOfBirth"), rs.GetValue(_T("fyear")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("fsex")));
		rptHeader->SetValue(_T("Room"), rs.GetValue(_T("buong")));
		rptHeader->SetValue(_T("Object"), rs.GetValue(_T("doituong")));
		rptHeader->SetValue(_T("Diagnostic"), rs.GetValue(_T("fDiagnostic")));
		rptHeader->SetValue(_T("NgayVao"), CDate::Convert(rs.GetValue(_T("ngayvaovien")), yyyymmdd, ddmmyyyy));
	}


	if (nTreatIdx > 0)
	{
		szWhere.Format(_T(" and hpo_treatidx=%ld"), nTreatIdx);
		szSQL.Format(_T("SELECT hsie_diet, hsie_nurseassistance FROM hms_siexam WHERE hsie_idx=%ld AND hsie_docno=%ld"), nTreatIdx, nDocNo);
		rs2.ExecSQL(szSQL);
		//		_fmsg(_T("%s"), szSQL);
		rs2.GetValue(_T("hsie_nurseassistance"), tmpStr);
		if (IsDigit(tmpStr))
		{
			tmpStr = pMF->GetSelectionString(_T("HMS_CHEDOHOLY"), tmpStr);
		}
		rpt.GetReportFooter()->SetValue(_T("chedoholy"), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("chedoan"), rs2.GetValue(_T("hsie_diet")));
	}
	else
	{
		szWhere.Format(_T(" AND hpo_batch_id = %ld and trunc(hpo_orderdate) = to_date('%s','yyyy/mm/dd')"), nBatchID, szDate);
	}
	szSQLTDSD.Format(_T("SELECT mp_name                    AS tenthuoc, ") \
		_T("       hpol_qtyorder              AS soluong, ") \
		_T("       Get_uomname(mp_uom_id)     AS donvi, ") \
		_T("       hpou_dousage               AS duongdung, ") \
		_T("       Get_username(hpou_user_id) AS bschidinh, ") \
		_T("       hpou_speed                 AS tocdo, GET_USERNAME(hsie_nurse) AS nurse ") \
		_T("FROM   hms_ipharmaorderline ") \
		_T("	   LEFT JOIN hms_ipharmaorder ON(hpo_orderid = hpol_orderid and hpo_docno = hpol_docno) ") \
		_T("       LEFT JOIN m_product ") \
		_T("              ON( mp_product_id = hpol_product_id ) ") \
		_T("       LEFT JOIN hms_ipharmaorder_usage ") \
		_T("              ON( hpou_orderid = hpol_orderid ") \
		_T("                  AND hpou_product_id = hpol_product_id ) ") \
		_T("	   LEFT JOIN hms_siexam ON (hsie_docno = hpo_docno AND hsie_idx = hpo_treatidx) ") \
		_T(" WHERE  hpo_docno = %ld %s ") \
		_T(" ORDER BY hpo_orderid, hpol_line"), nDocNo, szWhere);

	rsTDSD.ExecSQL(szSQLTDSD);

	int nCount = 0;
	int nTongKhoan = 0;
	while (!rsTDSD.IsEOF())
	{
		rptDetail = rpt.AddDetail();

		szIDx.Format(_T("%d"), nIdx);
		rptDetail->SetValue(_T("1"), szIDx);
		nCount = ToInt(rsTDSD.GetValue(_T("soluong")));
		nTongKhoan += nCount;
		rptDetail->SetValue(_T("2"), rsTDSD.GetValue(_T("tenthuoc")));
		rptDetail->SetValue(_T("3"), rsTDSD.GetValue(_T("donvi")));
		rptDetail->SetValue(_T("4"), rsTDSD.GetValue(_T("soluong")));
		rptDetail->SetValue(_T("5"), rsTDSD.GetValue(_T("duongdung")));
		rptDetail->SetValue(_T("6"), rsTDSD.GetValue(_T("bschidinh")));
		rptDetail->SetValue(_T("7"), rsTDSD.GetValue(_T("tocdo")));
		rptDetail->SetValue(_T("tendd"), rsTDSD.GetValue(_T("nurse")));
		nIdx++;
		rsTDSD.MoveNext();

	}

	rptFooter = rpt.GetReportFooter();
	tmpStr = pMF->GetSysDateTime();
	szDateStr.Format(_T("Ng\xE0y %s th\xE1ng %s n\x103m %s"), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rptFooter->SetValue(_T("PrintDate"), szDateStr);
	rptFooter->SetValue(_T("tongkhoanthuoc"), nTongKhoan);
	rpt.PrintPreview();
}
void CPrintForms::TM_OnPrintPhieuTDSDCongKhaiThuocEX(long nBatchID, long nDocNo, CString szDate, long nTreatIdx)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();


	//Kiem tra neu khong phai in trong phieu du tru thi cho phep chon nhieu phieu in
	if (nBatchID <= 0)
	{
        
		CTMChoosePrintDateDlg dlg(pMF, _T("PRINT_PHIEUCONGKHAITHUOCEX"));
		dlg.m_nRefIdx = nTreatIdx;
		dlg.m_nDocNo = nDocNo;
//        dlg.PrintPhieuCongKhaiThuocEx(nTreatIdx);
		dlg.DoModal();
		return;
	}


	CReport rpt;
	CRecord rs(&pMF->m_db);
	CRecord rsTDSD(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CReportSection* rptHeader = NULL, * rptDetail = NULL, * rptFooter = NULL;
	CString szSQL, szSQLTDSD, tmpStr, szWhere, szIDx, szDateStr;


	if (!rpt.Init(_T("Reports\\HMS\\TM_TDSDCONGKHAITHUOCEX.RPT")))
		return;

	rptHeader = rpt.GetReportHeader();
	rptHeader->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptHeader->SetValue(_T("Department"), pMF->GetDepartmentName(pMF->GetDepartmentID()));

	szSQL.Format(_T("SELECT hd_docno                                        AS fdocno, ") \
		_T("       htr_recordno                                    AS frecord, ") \
		_T("       Trim(hp_surname ") \
		_T("            || ' ' ") \
		_T("            || hp_midname ") \
		_T("            || ' ' ") \
		_T("            || hp_firstname)                           AS fname, ") \
		_T("       Hms_getobjectname(hd_object)                    AS doituong, ") \
		_T("       Sys_sel_getname('sys_sex', hp_sex)              AS fsex, ") \
		_T("       extract (year from hp_birthdate)               AS fage, ") \
		_T("       htr_admitdate                                   AS ngayvaovien, ") \
		_T("       Extract(year FROM hp_birthdate)                 AS fyear, ") \
		_T("       hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS faddress, ") \
		_T("       htr_deptid                                      AS fdeptid, ") \
		_T("       Hms_getroomname(htr_deptid, hb_roomid)          AS buong, ") \
		_T("       htr_maindisease                                 AS fDiagnostic, ") \
		_T(" SELECT CASE WHEN hd_hasallergy='Y' THEN cast('Có' as nvarchar2(8))") \
		_T(" ELSE cast('Không' as nvarchar2(8)) END as tiensudiung") \
		_T("FROM   hms_treatment_record ") \
		_T("       LEFT JOIN hms_doc ") \
		_T("              ON( htr_docno = hd_docno ) ") \
		_T("       LEFT JOIN hms_patient ") \
		_T("              ON( hp_patientno = hd_patientno ) ") \
		_T("       LEFT JOIN hms_bed ") \
		_T("              ON( hb_docno = hd_docno ) ") \
		_T("WHERE  htr_docno = %ld "), nDocNo);
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	if (!rs.IsEOF())
	{
		rptHeader->SetValue(_T("Department"), rs.GetValue(_T("fdeptid")));
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("frecord")));
		rptHeader->SetValue(_T("DocNo"), rs.GetValue(_T("fdocno")));
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("frecord")));
		rptHeader->SetValue(_T("PatientName"), rs.GetValue(_T("fname")));
		rptHeader->SetValue(_T("YearOfBirth"), rs.GetValue(_T("fyear")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("fsex")));
		rptHeader->SetValue(_T("Room"), rs.GetValue(_T("buong")));
		rptHeader->SetValue(_T("Object"), rs.GetValue(_T("doituong")));
		rptHeader->SetValue(_T("Diagnostic"), rs.GetValue(_T("fDiagnostic")));
		rptHeader->SetValue(_T("NgayVao"), CDate::Convert(rs.GetValue(_T("ngayvaovien")), yyyymmdd, ddmmyyyy));
		rptHeader->SetValue(_T("Tiensudiung"), rs.GetValue(_T("tiensudiung")));
	}


	if (nTreatIdx > 0)
	{
		szWhere.Format(_T(" and hpo_treatidx=%ld"), nTreatIdx);
		szSQL.Format(_T("SELECT hsie_diet, hsie_nurseassistance FROM hms_siexam WHERE hsie_idx=%ld AND hsie_docno=%ld"), nTreatIdx, nDocNo);
		rs2.ExecSQL(szSQL);
		//		_fmsg(_T("%s"), szSQL);
		rs2.GetValue(_T("hsie_nurseassistance"), tmpStr);
		if (IsDigit(tmpStr))
		{
			tmpStr = pMF->GetSelectionString(_T("HMS_CHEDOHOLY"), tmpStr);
		}
		rpt.GetReportFooter()->SetValue(_T("chedoholy"), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("chedoan"), rs2.GetValue(_T("hsie_diet")));
	}
	else
	{
		szWhere.Format(_T(" AND hpo_batch_id = %ld and trunc(hpo_orderdate) = to_date('%s','yyyy/mm/dd')"), nBatchID, szDate);
	}
	//_msg(_T("%s"), szSQL);
	szSQLTDSD.Format(_T("SELECT mp_name                    AS tenthuoc, ") \
		_T("       hpol_qtyorder              AS soluong, ") \
		_T("       Get_uomname(mp_uom_id)     AS donvi, ") \
		_T("       hpou_dousage               AS duongdung, ") \
		_T("       Get_username(hpou_user_id) AS bschidinh, ") \
		_T("       hpou_speed                 AS tocdo, GET_USERNAME(hsie_nurse) AS nurse, hpou_time as thoi_gian_su_dung ") \
		_T(" FROM   hms_ipharmaorderline ") \
		_T("	   LEFT JOIN hms_ipharmaorder ON(hpo_orderid = hpol_orderid and hpo_docno = hpol_docno) ") \
		_T("       LEFT JOIN m_product ") \
		_T("              ON( mp_product_id = hpol_product_id ) ") \
		_T("       LEFT JOIN hms_ipharmaorder_usage ") \
		_T("              ON( hpou_orderid = hpol_orderid ") \
		_T("                  AND hpou_product_id = hpol_product_id ) ") \
		_T("	   LEFT JOIN hms_siexam ON (hsie_docno = hpo_docno AND hsie_idx = hpo_treatidx) ") \
		_T(" WHERE  hpo_docno = %ld %s ") \
		_T(" ORDER BY hpo_orderid, hpol_line"), nDocNo, szWhere);

	rsTDSD.ExecSQL(szSQLTDSD);

	int nCount = 0;
	int nTongKhoan = 0;
	int nIdx = 1;
	while (!rsTDSD.IsEOF())
	{
		rptDetail = rpt.AddDetail();

		szIDx.Format(_T("%d"), nIdx++);

		rptDetail->SetValue(_T("1"), szIDx);
		nCount = ToInt(rsTDSD.GetValue(_T("soluong")));
		nTongKhoan += nCount;
		rptDetail->SetValue(_T("2"), rsTDSD.GetValue(_T("tenthuoc")));
		rptDetail->SetValue(_T("3"), rsTDSD.GetValue(_T("donvi")));
		rptDetail->SetValue(_T("4"), rsTDSD.GetValue(_T("soluong")));
		rptDetail->SetValue(_T("5"), rsTDSD.GetValue(_T("duongdung")));
		rptDetail->SetValue(_T("6"), rsTDSD.GetValue(_T("bschidinh")));
		rptDetail->SetValue(_T("7"), rsTDSD.GetValue(_T("tocdo")));
		rptDetail->SetValue(_T("8"), rsTDSD.GetValue(_T("thoi_gian_su_dung")));
		rptDetail->SetValue(_T("tendd"), rsTDSD.GetValue(_T("nurse")));
		//nIdx++;
		rsTDSD.MoveNext();

	}

	rptFooter = rpt.GetReportFooter();
	tmpStr = pMF->GetSysDateTime();
	szDateStr.Format(_T("Ng\xE0y %s th\xE1ng %s n\x103m %s"), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rptFooter->SetValue(_T("PrintDate"), szDateStr);
	rptFooter->SetValue(_T("tongkhoanthuoc"), nTongKhoan);
	rpt.PrintPreview();
}


void CPrintForms::TM_OnPrintPhieuChamSoc(long m_nDocNo, long m_nRefIDx, bool isPrintOne)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CTMChooseCareDateDlg dlg(pMF);
	dlg.m_nRefIdx = m_nRefIDx;
	dlg.m_nDocNo = m_nDocNo;
	if (isPrintOne)
		dlg.OnPrintSelect(true);
	else
		dlg.DoModal();

}

void CPrintForms::EM_OnPrintPhieuChamSoc(long m_nDocNo, long m_nRefIDx)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();

	CEMChooseCareDateDlg dlg(pMF);
	dlg.m_nRefIdx = m_nRefIDx;
	dlg.m_nDocNo = m_nDocNo;
	dlg.DoModal();
}

void CPrintForms::TM_OnPrintDonHoaTriLieu1(long m_nDocNo, long m_nRefIDx)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, szTemp, tmpStr, szSQLPI, szSTT, szDateStr;
	long nOrderID;
	CReport rpt;
	CReportSection* rptHeader = NULL, * rptDetail = NULL, * rptFooter = NULL;

	if (!rpt.Init(_T("Reports/HMS/DonHoaTriLieu.RPT")))
	{
		return;
	}

	szSQLPI.Format(_T(" SELECT get_patientname(hco_docno) as pname, hco_deptid, hms_getsex(hp_sex) AS sex, hco_weight, hco_height, extract(year from hp_birthdate) as yob,") \
		_T(" hco_area as Sbemat, htr_recordno as recordno, '' as room, get_objectname(hd_object) as object, hco_cycle as chuky, ") \
		_T(" hco_cycledate as ngaychuky, hco_diagnostic, hco_treatdiagram, hco_cancer_order_id ") \
		_T(" FROM hms_cancer_order ") \
		_T(" LEFT JOIN hms_treatment_record ON (htr_docno = hco_docno AND htr_deptid = hco_deptid) ") \
		_T(" LEFT JOIN hms_doc ON (hd_docno = hco_docno) ") \
		_T(" LEFT JOIN hms_patient ON (hp_patientno = hd_patientno) ") \
		_T(" WHERE hco_docno = %ld and hco_treatidx = %ld"), m_nDocNo, m_nRefIDx);
	rs.ExecSQL(szSQLPI);
	_debug(_T("%s"), szSQLPI);
	rptHeader = rpt.GetReportHeader();
	if (!rs.IsEOF())
	{
		rptHeader->SetValue(_T("PatientNamme"), rs.GetValue(_T("pname")));
		rptHeader->SetValue(_T("Age"), rs.GetValue(_T("yob")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("Height"), rs.GetValue(_T("hco_height")));
		rptHeader->SetValue(_T("Weight"), rs.GetValue(_T("hco_weight")));
		rptHeader->SetValue(_T("Sbody"), rs.GetValue(_T("Sbemat")));
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("recordno")));
		rptHeader->SetValue(_T("Room"), rs.GetValue(_T("room")));
		rptHeader->SetValue(_T("Object"), rs.GetValue(_T("object")));
		rptHeader->SetValue(_T("ChuKy"), rs.GetValue(_T("chuky")));
		rptHeader->SetValue(_T("NgayChuKy"), rs.GetValue(_T("ngaychuky")));
		rptHeader->SetValue(_T("BenhLy"), rs.GetValue(_T("hco_diagnostic")));
		rptHeader->SetValue(_T("PhacDo"), rs.GetValue(_T("hco_treatdiagram")));
		nOrderID = ToLong(rs.GetValue(_T("hco_cancer_order_id")));
	}

	szSQL.Format(_T(" SELECT hcol_tenthuoc, hcol_lieudung_m2, hcol_lieudung_bn, hcol_soluong_linh, hcol_dungmoi, ") \
		_T(" hcol_thetich, hcol_thoigian_sudung ") \
		_T(" FROM hms_cancer_orderline ") \
		_T(" WHERE hcol_cancer_order_id= %ld"), nOrderID);
	rs.ExecSQL(szSQL);
	_debug(_T("%s"), szSQL);
	rptDetail = rpt.AddDetail();
	int nTongKhoan = 0;
	int nStt = 1;

	while (!rs.IsEOF())
	{
		szSTT.Format(_T("%d"), nStt);
		rptDetail->SetValue(_T("1"), szSTT);
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("hcol_tenthuoc")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("hcol_lieudung_m2")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("hcol_lieudung_bn")));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("hcol_soluong_linh")));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("hcol_dungmoi")));
		rptDetail->SetValue(_T("7"), rs.GetValue(_T("hcol_thetich")));
		rptDetail->SetValue(_T("8"), rs.GetValue(_T("hcol_thoigian_sudung")));
		nTongKhoan++;
		nStt++;
		rs.MoveNext();
	}

	rptFooter = rpt.GetReportFooter();
	tmpStr = pMF->GetSysDateTime();
	szDateStr.Format(_T("Ng\xE0y %s th\xE1ng %s n\x103m %s"), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rptFooter->SetValue(_T("PrintDate"), szDateStr);
	rptFooter->SetValue(_T("total"), nTongKhoan);
	rpt.PrintPreview();
}

void CPrintForms::TM_OnPrintPhieuDieuChe(long m_nDocNo, long m_nRefIDx)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, szTemp, tmpStr, szSQLPI, szSTT, szDateStr;
	long nOrderID;
	CReport rpt;
	CReportSection* rptHeader = NULL, * rptDetail = NULL, * rptFooter = NULL;

	if (!rpt.Init(_T("Reports/HMS/PhieuDieuChe.RPT")))
	{
		return;
	}

	szSQLPI.Format(_T(" SELECT get_patientname(hco_docno) as pname, hco_deptid, hms_getsex(hp_sex) AS sex, hco_weight, hco_height, extract(year from hp_birthdate) as yob,") \
		_T(" hco_area as Sbemat, htr_recordno as recordno, '' as room, get_objectname(hd_object) as object, hco_cycle as chuky, ") \
		_T(" hco_cycledate as ngaychuky, hco_diagnostic, hco_treatdiagram, hco_cancer_order_id ") \
		_T(" FROM hms_cancer_order ") \
		_T(" LEFT JOIN hms_treatment_record ON (htr_docno = hco_docno AND htr_deptid = hco_deptid) ") \
		_T(" LEFT JOIN hms_doc ON (hd_docno = hco_docno) ") \
		_T(" LEFT JOIN hms_patient ON (hp_patientno = hd_patientno) ") \
		_T(" WHERE hco_docno = %ld and hco_treatidx = %ld"), m_nDocNo, m_nRefIDx);
	rs.ExecSQL(szSQLPI);
	_debug(_T("%s"), szSQLPI);
	rptHeader = rpt.GetReportHeader();
	if (!rs.IsEOF())
	{
		rptHeader->SetValue(_T("PatientNamme"), rs.GetValue(_T("pname")));
		rptHeader->SetValue(_T("Age"), rs.GetValue(_T("yob")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("Height"), rs.GetValue(_T("hco_height")));
		rptHeader->SetValue(_T("Weight"), rs.GetValue(_T("hco_weight")));
		rptHeader->SetValue(_T("Sbody"), rs.GetValue(_T("Sbemat")));
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("recordno")));
		rptHeader->SetValue(_T("Room"), rs.GetValue(_T("room")));
		rptHeader->SetValue(_T("Object"), rs.GetValue(_T("object")));
		rptHeader->SetValue(_T("ChuKy"), rs.GetValue(_T("chuky")));
		rptHeader->SetValue(_T("NgayChuKy"), rs.GetValue(_T("ngaychuky")));
		rptHeader->SetValue(_T("BenhLy"), rs.GetValue(_T("hco_diagnostic")));
		rptHeader->SetValue(_T("PhacDo"), rs.GetValue(_T("hco_treatdiagram")));
		nOrderID = ToLong(rs.GetValue(_T("hco_cancer_order_id")));
	}

	szSQL.Format(_T(" SELECT hcol_tenthuoc, hcol_soluong_mg, hcol_nacl, hcol_glucose, hcol_thetich_ml,'' as note ") \
		_T(" FROM hms_cancer_orderline ") \
		_T(" WHERE hcol_cancer_order_id= %ld"), nOrderID);
	rs.ExecSQL(szSQL);
	_debug(_T("%s"), szSQL);
	rptDetail = rpt.AddDetail();
	int nTongKhoan = 0;
	int nStt = 1;
	while (!rs.IsEOF())
	{
		szSTT.Format(_T("%d"), nStt);
		rptDetail->SetValue(_T("1"), szSTT);
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("hcol_tenthuoc")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("hcol_soluong_mg")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("hcol_nacl")));
		rptDetail->SetValue(_T("5"), rs.GetValue(_T("hcol_glucose")));
		rptDetail->SetValue(_T("6"), rs.GetValue(_T("hcol_thetich_ml")));
		rptDetail->SetValue(_T("7"), rs.GetValue(_T("note")));
		nTongKhoan++;
		nStt++;
		rs.MoveNext();
	}

	rptFooter = rpt.GetReportFooter();
	tmpStr = pMF->GetSysDateTime();
	szDateStr.Format(_T("Ng\xE0y %s th\xE1ng %s n\x103m %s"), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rptFooter->SetValue(_T("PrintDate"), szDateStr);
	rptFooter->SetValue(_T("total"), nTongKhoan);
	rpt.PrintPreview();
}

void CPrintForms::TM_OnPrintDonHoaTriLieu2(long m_nDocNo, long m_nRefIDx)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, szTemp, tmpStr, szSQLPI, szDateStr;
	int nOrderID;
	CReport rpt;
	CReportSection* rptHeader = NULL, * rptDetail = NULL, * rptFooter = NULL;

	if (!rpt.Init(_T("Reports/HMS/DonHoaTriLieu2.RPT")))
	{
		return;
	}

	szSQLPI.Format(_T(" SELECT get_patientname(hco_docno) as pname, hco_deptid, hms_getsex(hp_sex) AS sex, hco_weight, hco_height, extract(year from hp_birthdate) as yob,") \
		_T(" hco_area as Sbemat, htr_recordno as recordno, '' as room, get_objectname(hd_object) as object, hco_cycle as chuky, ") \
		_T(" hco_cycledate as ngaychuky, hco_diagnostic, hco_treatdiagram, hco_cancer_order_id ") \
		_T(" FROM hms_cancer_order ") \
		_T(" LEFT JOIN hms_treatment_record ON (htr_docno = hco_docno AND htr_deptid = hco_deptid) ") \
		_T(" LEFT JOIN hms_doc ON (hd_docno = hco_docno) ") \
		_T(" LEFT JOIN hms_patient ON (hp_patientno = hd_patientno) ") \
		_T(" WHERE hco_docno = %ld and hco_treatidx = %ld"), m_nDocNo, m_nRefIDx);
	rs.ExecSQL(szSQLPI);
	rptHeader = rpt.GetReportHeader();
	if (!rs.IsEOF())
	{
		rptHeader->SetValue(_T("PatientNamme"), rs.GetValue(_T("pname")));
		rptHeader->SetValue(_T("Age"), rs.GetValue(_T("yob")));
		rptHeader->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
		rptHeader->SetValue(_T("Height"), rs.GetValue(_T("hco_height")));
		rptHeader->SetValue(_T("Weight"), rs.GetValue(_T("hco_weight")));
		rptHeader->SetValue(_T("Sbody"), rs.GetValue(_T("Sbemat")));
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("recordno")));
		rptHeader->SetValue(_T("Room"), rs.GetValue(_T("room")));
		rptHeader->SetValue(_T("Object"), rs.GetValue(_T("object")));
		rptHeader->SetValue(_T("ChuKy"), rs.GetValue(_T("chuky")));
		rptHeader->SetValue(_T("NgayChuKy"), rs.GetValue(_T("ngaychuky")));
		rptHeader->SetValue(_T("BenhLy"), rs.GetValue(_T("hco_diagnostic")));
		rptHeader->SetValue(_T("PhacDo"), rs.GetValue(_T("hco_treatdiagram")));
		rs.GetValue(_T("hco_cancer_order_id"), nOrderID);
		//
		//cong thuc ???
		rptHeader->SetValue(_T("1_0"), rs.GetValue(_T("ct1")));
		rptHeader->SetValue(_T("2_0"), rs.GetValue(_T("ct2")));
		rptHeader->SetValue(_T("3_0"), rs.GetValue(_T("ct3")));
		rptHeader->SetValue(_T("4_0"), rs.GetValue(_T("ct4")));
		rptHeader->SetValue(_T("1_1"), rs.GetValue(_T("hc1")));
		rptHeader->SetValue(_T("2_1"), rs.GetValue(_T("hc2")));
		rptHeader->SetValue(_T("3_1"), rs.GetValue(_T("hc3")));
		rptHeader->SetValue(_T("4_1"), rs.GetValue(_T("hc4")));
		//
		rptHeader->SetValue(_T("songaydk"), rs.GetValue(_T("songay")));
		rptHeader->SetValue(_T("ngaydau"), rs.GetValue(_T("ngaydau")));
		rptHeader->SetValue(_T("ngaytiep"), rs.GetValue(_T("ngaytiep")));
	}

	szSQL.Format(_T(""));
	rs.ExecSQL(szSQL);

	rptDetail = rpt.AddDetail();
	while (!rs.IsEOF())
	{
		rptDetail->SetValue(_T("d1"), rs.GetValue(_T("tenthuoc")));
		rptDetail->SetValue(_T("d2"), rs.GetValue(_T("ngay1")));
		rptDetail->SetValue(_T("d3"), rs.GetValue(_T("ngay2")));
		rptDetail->SetValue(_T("d4"), rs.GetValue(_T("ngay3")));
		rptDetail->SetValue(_T("d5"), rs.GetValue(_T("ngay4")));
		rptDetail->SetValue(_T("d6"), rs.GetValue(_T("ngay5")));
		rptDetail->SetValue(_T("d7"), rs.GetValue(_T("duongdung")));
		rptDetail->SetValue(_T("d8"), rs.GetValue(_T("dm1")));
		rptDetail->SetValue(_T("d9"), rs.GetValue(_T("dm2")));
		rptDetail->SetValue(_T("d10"), rs.GetValue(_T("dm3")));
		rptDetail->SetValue(_T("d11"), rs.GetValue(_T("tocdo1")));
		rptDetail->SetValue(_T("d12"), rs.GetValue(_T("tocdo2")));
		rs.MoveNext();
	}

	rptFooter = rpt.GetReportFooter();
	tmpStr = pMF->GetSysDateTime();
	szDateStr.Format(_T("Ng\xE0y %s th\xE1ng %s n\x103m %s"), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rptFooter->SetValue(_T("PrintDate"), szDateStr);

	rpt.PrintPreview();
}

void CPrintForms::TM_OnPrintPhieuSo3(long m_nDocNo, long m_nRefIdx)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, szTemp, tmpStr, szSQLPI, szDateStr;

	CReport rpt;
	CReportSection* rptHeader = NULL, * rptDetail = NULL, * rptFooter = NULL;

	if (!rpt.Init(_T("Reports/HMS/DuocTriLieu1.RPT")))
	{
		return;
	}

	szSQLPI.Format(_T(" SELECT get_patientname(hco_docno) as pname, hco_deptid, hms_getsex(hp_sex) AS sex, hco_weight, hco_height, extract(year from hp_birthdate) as yob,") \
		_T(" hco_area as Sbemat, htr_recordno as recordno, '' as room, get_objectname(hd_object) as object, hco_cycle as chuky, ") \
		_T(" hco_cycledate as ngaychuky, hco_diagnostic, hco_treatdiagram, hco_cancer_order_id, get_username(hco_doctor) AS nguoithuchien ") \
		_T(" FROM hms_cancer_order ") \
		_T(" LEFT JOIN hms_treatment_record ON (htr_docno = hco_docno AND htr_deptid = hco_deptid) ") \
		_T(" LEFT JOIN hms_doc ON (hd_docno = hco_docno) ") \
		_T(" LEFT JOIN hms_patient ON (hp_patientno = hd_patientno) ") \
		_T(" WHERE hco_docno = %ld and hco_treatidx = %ld"), m_nDocNo, m_nRefIdx);
	rs.ExecSQL(szSQLPI);
	rptHeader = rpt.GetReportHeader();
	if (!rs.IsEOF())
	{
		rptHeader->SetValue(_T("PatientNamme"), rs.GetValue(_T("pname")));
		rptHeader->SetValue(_T("RecordNo"), rs.GetValue(_T("recordno")));
		rptHeader->SetValue(_T("buong"), rs.GetValue(_T("room")));
		rptHeader->SetValue(_T("NgayPha"), rs.GetValue(_T("ngaypha")));
		rptHeader->SetValue(_T("nguoithuchien"), rs.GetValue(_T("nguoithuchien")));
		rptHeader->SetValue(_T("CK"), rs.GetValue(_T("chuky")));
		rptHeader->SetValue(_T("gio"), rs.GetValue(_T("giohtsf")));
		rptHeader->SetValue(_T("congthuc"), rs.GetValue(_T("congthuc")));
		rptHeader->SetValue(_T("dungmoi"), rs.GetValue(_T("dungmoi")));
	}

	rpt.PrintPreview();
}

void CPrintForms::EM_OnPrintEmergencyReceipt(long m_nDocNo, long m_nReceptIdx)
{
    CHMSMainFrame *pMF = (CHMSMainFrame *)AfxGetMainWnd();
    CRecord rs(&pMF->m_db);
    CRecord rss(&pMF->m_db);
    CString szSQL;
    CString tmpStr, tmpStr2, tmpStr3, tmpStr4, tmpStr5, tmpStr6, tmpStr7,
        tmpStr8, tmpStr9, szTemp;
    CString szDate, strTmp, szSysDate;
    long nOrderID, oldOrderID = 0;

    CRecord rsr(&pMF->m_db);
    CRecord rsi(&pMF->m_db);
    CRecord rsf(&pMF->m_db);
    CRecord rsu(&pMF->m_db);

    CReportSection *detail = NULL;
    CReportSection *testDetail = NULL;
    CReportSection *grp = NULL;
    CReportSection *grpt2 = NULL, *rptHeader = NULL;
    CString szDiagnotic, szSex, szDoctorRs;
    CString szRemark, szConclusion, szResult, szID;
    CString szPathological, szPartBody, szBody, szOwner, szFamily,
        szSummarizeTest, szFNorm, szMNorm, szUnit;
    bool bShowLine = true;

	//Nếu đã có bản ghi được ký rồi thì download về
    szSQL.Format(_T("select hms_signature_id ")
             _T("	from hms_signature WHERE docno = %ld ")            
             _T(" and status ='S' and form_id = 'MB_HC_PCC' "), m_nDocNo); 

    rs.ExecSQL(szSQL);

    if (!rs.IsEOF())
    {
        CString szSignatureID = rs.GetValue(_T("hms_signature_id"));

        CPdfSignature signer(pMF);

        if (signer.DownloadAndPreview(szSignatureID, true))
        {
           
        }
        return;
      
    }

    int nLine = 0;
    int nIndex = 1;

    CString szSummaryResult;
    szSummaryResult.Empty();

    szSysDate = pMF->GetSysDate();
    CReport rpt;

    if (!rpt.Init(_T("Reports/HMS/HE_PHIEUCAPCUU.RPT")))
    {
        return;
    }
    rptHeader = rpt.GetReportHeader();
    rptHeader->SetValue(_T("HEALTHSERVICE"),
                                    pMF->m_szHealthService);
    rptHeader->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);

	szSQL.Format(_T("    SELECT hd_admitdate AS examdate,")
                 _T("           hd_reldisease AS reldisease,")
                 _T("           Get_username(j.he_doctor) AS doctorname,")
                 _T("           i.he_workplace AS he_workplace,")
                 _T("           i.he_transplace AS he_transplace,")
                 _T("           i.he_starttime AS he_starttime,")
                 _T("           i.he_transdiagn AS he_transdiagn,")
                 _T("           i.he_diseasetype AS he_diseasetype,")
                 _T("           i.he_patientstatus AS he_patientstatus,")
                 _T("           i.he_examine AS he_examine,")
                 _T("           i.he_test AS he_test,")
                 _T("           i.he_diagnostic AS he_diagnostic,")
                 _T("           i.he_treatment AS he_treatment,")
                 _T("           hd_suggestion AS he_suggestion,")
                 _T("           hd_indept AS he_indept,")
                 _T("           j.he_examtype3 AS he_examtype3,")
                 _T("           j.he_detail_examtype3 AS he_detail_examtype3,")
                 _T("           CASE WHEN hd_insline = 'Y' THEN 'X'")
                 _T("           ELSE NULL")
                 _T("           END AS insline,")
                 _T("           CASE WHEN hd_insline = 'N' THEN 'X'")
                 _T("           ELSE NULL")
                 _T("           END AS dung_tuyen,")
                 _T("           CASE WHEN hd_emergency = 'Y' THEN 'X'")
                 _T("           ELSE NULL")
                 _T("           END AS emergency,")
                 _T("           To_char(hd_over5yearapplydate, 'dd/mm/yyyy') ")
                 _T("AS over5yearapplydate,")
                 _T("           To_char(hd_over5yeardiscountapplydate, ")
                 _T("'dd/mm/yyyy') AS over5yeardiscountapplydate,")
                 _T("           To_char(hd_over5yeardiscounttodate, ")
                 _T("'dd/mm/yyyy') AS over5yeardiscounttodate,")
				_T(" case when hd_hasfeepaper = 'Y' then 'X' else null end as hasfeepaper,")
                 _T("           CASE WHEN hd_over5year = 'Y' THEN 'X'")
                 _T("           ELSE NULL")
                 _T("           END AS over5year")
                 _T("      FROM hms_emergency i")
                 _T(" LEFT JOIN hms_doc ON ( he_docno = hd_docno )")
                 _T(" LEFT JOIN hms_exam j ON ( i.he_docno = j.he_docno AND ")
                 _T("i.he_receptidx = j.he_receptidx )")
                 _T("     WHERE i.he_docno = %ld AND i.he_receptidx = %ld")
        , m_nDocNo, m_nReceptIdx);
    rs.ExecSQL(szSQL);

    if (rs.IsEOF())
    {
        return;
    }

    szSQL.Format(
        _T(" SELECT trim(hp_surname||' '||hp_midname||' '||hp_firstname) as ")
        _T("pname,")
        _T("        hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age,")
        _T("        extract(year from hp_birthdate) as yob,")
        _T("        hp_sex,")
        _T("        hms_getsex(hp_sex) as sex,")
        _T("        hms_getobjectname(hd_object) as objectname, ")
        _T("        sys_sel_getname('hms_rank', hp_rank) as rank,")
        _T("        hc_cardno as cardno,")
        _T("		replace(to_char(hd_enddate, 'hh24:mi, dd/mm/yyyy'), ',', ")
        _T("', Ngày') as end_date ")
        _T(" FROM hms_patient")
        _T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno)")
        _T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND ")
        _T("hc_idx=hd_cardidx)")
        _T(" WHERE hd_docno=%ld"),
        m_nDocNo);
    rss.ExecSQL(szSQL);

    if (!rs.IsEOF())
    {
        tmpStr.Format(_T("%ld"), m_nDocNo);
        rptHeader->SetValue(_T("DocNo"), tmpStr);

        rs.GetValue(_T("examdate"), tmpStr);
        szTemp = rptHeader->GetValue(_T("OrderDate"));

        strTmp.Format(_T("%s/%s/%s"), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2),
                      tmpStr.Left(4));

        szDate.Format(szTemp, tmpStr.Mid(11, 2), tmpStr.Mid(14, 2), strTmp);
        rptHeader->SetValue(_T("OrderDate"), szDate);

        rs.GetValue(_T("he_workplace"), tmpStr);
        rptHeader->SetValue(_T("Workplace"), tmpStr);

        rs.GetValue(_T("he_transplace"), tmpStr);
        szTemp.Format(_T("ov%d"), str2int(tmpStr) - 3);
        rptHeader->SetValue(szTemp, _T("X"));

        rs.GetValue(_T("he_starttime"), tmpStr);
        szTemp.Format(_T("ov%d_%d"), str2int(tmpStr), str2int(tmpStr) + 4);
        rptHeader->SetValue(szTemp, _T("X"));

        rs.GetValue(_T("he_transdiagn"), tmpStr);
        rptHeader->SetValue(_T("TransDiagn"), tmpStr);
        // In ra thông tin phân loại bệnh cấp cứu

        rs.GetValue(_T("he_examtype3"), tmpStr8);
        rs.GetValue(_T("he_detail_examtype3"), tmpStr9);

        if ((!tmpStr8.IsEmpty()) || (!tmpStr9.IsEmpty()))
        {
            szTemp.Format(_T("ov2_6_%d"), str2int(tmpStr8));
            rptHeader->SetValue(szTemp, _T("X"));

            szTemp.Format(_T("ov2_6_%d"), str2int(tmpStr9));
            rptHeader->SetValue(szTemp, _T("X"));
        }
        else
        {
            rs.GetValue(_T("he_diseasetype"), tmpStr);
            szTemp.Format(_T("ov2_6_%d"), str2int(tmpStr));
            rptHeader->SetValue(szTemp, _T("X"));
        }

        rs.GetValue(_T("he_patientstatus"), tmpStr);
        szTemp.Format(_T("ov2_6_6_%d"), str2int(tmpStr));
        rptHeader->SetValue(szTemp, _T("X"));

        rs.GetValue(_T("he_examine"), tmpStr);
        rptHeader->SetValue(_T("Pathological"), tmpStr);

        rs.GetValue(_T("he_test"), tmpStr);
        rptHeader->SetValue(_T("Summarize"), tmpStr);

        rs.GetValue(_T("he_diagnostic"), tmpStr2);
        rs.GetValue(_T("reldisease"), tmpStr3);
        rs.GetValue(_T("he_treatment"), tmpStr4);
        rs.GetValue(_T("he_suggestion"), tmpStr5);
        rs.GetValue(_T("he_indept"), tmpStr6);
        rs.GetValue(_T("doctorname"), tmpStr7);
    }

    if (!rss.IsEOF())
    {
        rss.GetValue(_T("pname"), tmpStr);
        StringUpper(tmpStr, szTemp);
        rptHeader->SetValue(_T("PatientName"), szTemp);

        rss.GetValue(_T("yob"), tmpStr);
        rptHeader->SetValue(_T("YearOfBirth"), tmpStr);

        rss.GetValue(_T("sex"), tmpStr);
        rptHeader->SetValue(_T("Sex"), tmpStr);

        rss.GetValue(_T("objectname"), tmpStr);
        rptHeader->SetValue(_T("Object"), tmpStr);

        rss.GetValue(_T("rank"), tmpStr);
        rptHeader->SetValue(_T("Rank"), tmpStr);

        rss.GetValue(_T("cardno"), tmpStr);
        rptHeader->SetValue(_T("CardNo"), tmpStr);
    }

	/*TT thẻ thêm*/
    
    
    rptHeader->SetValue(L"over5yearapplydate", rs.GetValue(L"over5yearapplydate"));
    rptHeader->SetValue(L"over5yeardiscountapplydate", rs.GetValue(L"over5yeardiscountapplydate"));
    rptHeader->SetValue(L"over5yeardiscounttodate", rs.GetValue(L"over5yeardiscounttodate"));
    rptHeader->SetValue(L"hasfeepaper",
                        rs.GetValue(L"hasfeepaper"));
    rs.GetValue(L"emergency", tmpStr);
    rptHeader->SetValue(L"emergency", tmpStr);
    if (tmpStr == L"X")
        bShowLine = false;
    if (pMF->m_szObject == L"12" || pMF->m_szObject == L"7" ||
        pMF->m_szObject == L"8")
        bShowLine = false;
    
	if (bShowLine)
	{
        rptHeader->SetValue(L"dung_tuyen", rs.GetValue(L"dung_tuyen"));
        rptHeader->SetValue(L"insline", rs.GetValue(L"insline"));
	}
    rptHeader->SetValue(L"over5year", rs.GetValue(L"over5year"));
    // Phan cho xet nghiem

    szSQL.Format(
        _T("SELECT distinct hfg_name as groupname, to_char(hpc_orderdate, ")
        _T("'HH24:MI DD/MM/YYYY') order_date, to_char(hpc_performdate, ")
        _T("'HH24:MI DD/MM/YYYY') perform_date,")
        _T("hfg_id as groupid, hpc_status ")
        _T("FROM hms_testorder ")
        _T("LEFT JOIN hms_fee_group ON(hfg_id=hpc_groupid) ")
        _T("WHERE hpc_docno=%ld ")
        _T("and hpc_status IN('T','S') "),
        m_nDocNo);

    rs.ExecSQL(szSQL);

    int lineIdx = -1;
    CString szPrintMethod, szStatusOrder;
    if (!rs.IsEOF())
    {
        grp = rpt.GetGroupHeader(0);
        detail = rpt.AddDetail(grp);
        tmpStr.Format(_T("%d. \x58\xE9t nghi\x1EC7m"), nIndex++);
        detail->SetValue(_T("OrderName2"), tmpStr);

        nLine = 1;
        // xet nghiem cap 2
        while (!rs.IsEOF())
        {
            szPrintMethod = rs.GetValue(_T("printmethod"));
            tmpStr.Format(_T(" * %s   (%s- %s)"), rs.GetValue(_T("GroupName")),
                          rs.GetValue(_T("order_date")),
                          rs.GetValue(_T("perform_date")));
            grp = rpt.GetGroupHeader(0);
            detail = rpt.AddDetail(grp);

            rs.GetValue(_T("hpc_status"), szStatusOrder);

            detail->SetValue(_T("OrderName2"), tmpStr);
            // 			szSQL.Format(_T("SELECT hfl_groupid as groupid, hfl_name as name ") \
// 				_T("FROM hms_testorder LEFT JOIN hms_testorderline ON(hpcl_orderid=hpc_orderid) ") \
// 				_T("LEFT JOIN hms_fee_list ON(hfl_typeid='T' AND hpcl_itemid=hfl_feeid) ") \
// 				_T("WHERE hpc_docno=%ld AND hpc_groupid='%s' AND hfl_subgroup = 'N' ORDER BY hfl_groupid, hpcl_orderlineid"),m_nDocNo,  rs.GetValue(_T("groupid")));
            // 			nLine=1;
            // 			rsf.ExecSQL(szSQL);
            // 			// print result
            // 			while(!rsf.IsEOF())
            // 			{
            // 				grp = rpt.GetGroupHeader(1);
            // 				detail = rpt.AddDetail(grp);
            // 				tmpStr.Format(_T("%d"), nLine++);
            // 				detail->SetValue(_T("1"), tmpStr);
            // 				detail->SetValue(_T("2"), rsf.GetValue(_T("name")));
            // 				rsf.MoveNext();
            // 			}
            rs.MoveNext();
        }
    }

    szSQL.Format(
        _T(" SELECT hpc_orderid, to_char(hpc_orderdate, 'HH24:MI DD/MM/YYYY') ")
        _T("order_date, to_char(hpc_performdate, 'HH24:MI DD/MM/YYYY') ")
        _T("perform_date,")
        _T("         hfg_id as groupid, ")
        _T("         hfg_name as group_name ")
        _T("  FROM hms_pacsorder")
        _T("  LEFT JOIN hms_pacsorderline ON(hpc_orderid=hpcl_orderid)")
        _T("  LEFT JOIN")
        _T("  (")
        _T("     SELECT * FROM hms_pacs_result")
        _T("     WHERE lower(trim(hpr_name))='conclusion'")
        _T("  ) Tbl ON(Tbl.hpr_orderid=hpcl_orderid AND ")
        _T("Tbl.hpr_itemid=hpcl_itemid)")
        _T("  LEFT JOIN hms_fee_group ON(hfg_id=hpc_groupid)")
        _T("  LEFT JOIN hms_fee_list ON(hfl_typeid='T' and ")
        _T("hfl_feeid=hpcl_itemid)")
        _T("  WHERE hpc_docno=%ld AND hpc_status<>'O' AND substr(hfg_id, 1, ")
        _T("3) IN('B1E','B1F','B1G') ")
        _T("  ORDER by hpc_orderid, hfg_id"),
        m_nDocNo);

    rs.ExecSQL(szSQL);

    grpt2 = rpt.GetGroupHeader(1);
    grp = rpt.GetGroupHeader(0);

    nOrderID = oldOrderID = 0;

    CString szNewGroup, szOldGroup;
    szOldGroup.Empty();
    while (!rs.IsEOF())
    {
        rs.GetValue(_T("groupid"), szNewGroup);
        if (szNewGroup != szOldGroup)
        {
            szNewGroup = szOldGroup;
            tmpStr.Format(_T(" * %s   (%s- %s)"), rs.GetValue(_T("GroupName")),
                          rs.GetValue(_T("order_date")),
                          rs.GetValue(_T("perform_date")));
            detail = rpt.AddDetail(grp);
            detail->SetValue(_T("OrderName2"), tmpStr);
        }
        detail = rpt.AddDetail(grp);
        tmpStr.Format(_T(" - %s"), rs.GetValue(_T("ordername")));
        detail->SetValue(_T("OrderName2"), tmpStr);
        rs.MoveNext();
    }

    szSQL.Format(
        _T(" SELECT hpc_orderid, to_char(hpc_orderdate, 'HH24:MI DD/MM/YYYY') ")
        _T("order_date, to_char(hpc_performdate, 'HH24:MI DD/MM/YYYY') ")
        _T("perform_date,")
        _T("         hfg_id as groupid, ")
        _T("         hfl_name as ordername")
        _T("  FROM hms_pacsorder")
        _T("  LEFT JOIN hms_pacsorderline ON(hpc_orderid=hpcl_orderid)")
        _T("  LEFT JOIN")
        _T("  (")
        _T("     SELECT * FROM hms_pacs_result")
        _T("     WHERE lower(trim(hpr_name))='conclusion'")
        _T("  ) Tbl ON(Tbl.hpr_orderid=hpcl_orderid AND ")
        _T("Tbl.hpr_itemid=hpcl_itemid)")
        _T("  LEFT JOIN hms_fee_group ON(hfg_id=hpc_groupid)")
        _T("  LEFT JOIN hms_fee_list ON(hfl_typeid='T' and ")
        _T("hfl_feeid=hpcl_itemid)")
        _T("  WHERE hpc_docno=%ld AND hpc_status<>'O' AND substr(hfg_id, 1, ")
        _T("2)='B2' ")
        _T("  ORDER by hpc_orderid, hfg_id"),
        m_nDocNo);

    rs.ExecSQL(szSQL);

    grpt2 = rpt.GetGroupHeader(1);
    grp = rpt.GetGroupHeader(0);

    nOrderID = oldOrderID = 0;

    if (!rs.IsEOF())
    {
        grp = rpt.GetGroupHeader(0);
        detail = rpt.AddDetail(grp);
        tmpStr.Format(_T("%d. \x43h\x1EA9n \x111o\xE1n h\xECnh \x1EA3nh"),
                      nIndex++);
        detail->SetValue(_T("OrderName2"), tmpStr);
    }

    while (!rs.IsEOF())
    {
        detail = rpt.AddDetail(grp);
        tmpStr.Format(_T(" * %s   (%s- %s)"), rs.GetValue(_T("ordername")),
                      rs.GetValue(_T("order_date")),
                      rs.GetValue(_T("perform_date")));
        detail->SetValue(_T("OrderName2"), tmpStr);
        rs.MoveNext();
    }

    szSQL.Format(
        _T(" SELECT hpc_orderid, to_char(hpc_orderdate, 'HH24:MI DD/MM/YYYY') ")
        _T("order_date, to_char(hpc_performdate, 'HH24:MI DD/MM/YYYY') ")
        _T("perform_date,")
        _T("         hfg_id as groupid, ")
        _T("         hfl_name as ordername")
        _T("  FROM hms_pacsorder")
        _T("  LEFT JOIN hms_pacsorderline ON(hpc_orderid=hpcl_orderid)")
        _T("  LEFT JOIN")
        _T("  (")
        _T("     SELECT * FROM hms_pacs_result")
        _T("     WHERE lower(trim(hpr_name))='conclusion'")
        _T("  ) Tbl ON(Tbl.hpr_orderid=hpcl_orderid AND ")
        _T("Tbl.hpr_itemid=hpcl_itemid)")
        _T("  LEFT JOIN hms_fee_group ON(hfg_id=hpc_groupid)")
        _T("  LEFT JOIN hms_fee_list ON(hfl_typeid='T' and ")
        _T("hfl_feeid=hpcl_itemid)")
        _T("  WHERE hpc_docno=%ld AND hpc_status<>'O' AND substr(hfg_id, 1, ")
        _T("2)='B3'")
        _T("  ORDER by hpc_orderid, hfg_id"),
        m_nDocNo);

    rs.ExecSQL(szSQL);
    grpt2 = rpt.GetGroupHeader(1);
    grp = rpt.GetGroupHeader(0);

    if (!rs.IsEOF())
    {
        grp = rpt.GetGroupHeader(0);
        detail = rpt.AddDetail(grp);
        tmpStr.Format(_T("%d. Th\x103m \x64\xF2 \x63h\x1EE9\x63 n\x103ng"),
                      nIndex++);
        detail->SetValue(_T("OrderName2"), tmpStr);
    }

    while (!rs.IsEOF())
    {
        detail = rpt.AddDetail(grp);
        tmpStr.Format(_T(" * %s   (%s- %s)"), rs.GetValue(_T("ordername")),
                      rs.GetValue(_T("order_date")),
                      rs.GetValue(_T("perform_date")));
        detail->SetValue(_T("OrderName2"), tmpStr);
        rs.MoveNext();
    }

    grp = rpt.GetGroupHeader(2);
    detail = rpt.AddDetail(grp);
    detail->SetValue(_T("Diagnostic"), tmpStr2);

    grp = rpt.GetGroupHeader(3);
    detail = rpt.AddDetail(grp);
    detail->SetValue(_T("RelationDisease"), tmpStr3);

    grp = rpt.GetGroupHeader(4);
    detail = rpt.AddDetail(grp);
    detail->SetValue(_T("Drugs"), tmpStr4);

    grp = rpt.GetGroupHeader(5);
    detail = rpt.AddDetail(grp);
    if (tmpStr5 == _T("D") || tmpStr5 == _T("C"))
    {
        detail->SetValue(_T("ov2_1"), _T("X"));
    }
    else if (tmpStr5 == _T("F"))
    {
        detail->SetValue(_T("ov2_2"), _T("X"));
    }
    else if (tmpStr5 == _T("A") || tmpStr5 == _T("E"))
    {
        detail->SetValue(_T("ov2_3"), _T("X"));
    }
    else if (tmpStr5 == _T("X") || tmpStr5 == _T("Y"))
    {
        detail->SetValue(_T("ov2_4"), _T("X"));
    }

    detail->SetValue(_T("AdmitDept"), pMF->GetDepartmentName(tmpStr6));

    // Phan ket qua xet nghiem

    // 	nIndex = 1;
    //
    // 	szSQL.Format(_T("SELECT distinct hfg_name as groupname,
    // to_char(hpc_orderdate, 'HH24:MI DD/MM/YYYY') order_date,
    // to_char(hpc_performdate, 'HH24:MI DD/MM/YYYY') perform_date,") \
// 		_T("hfg_id as groupid, hpc_status ") \
// 		_T("FROM hms_testorder ") \
// 		_T("LEFT JOIN hms_fee_group ON(hfg_id=hpc_groupid) ") \
// 		_T("WHERE hpc_docno=%ld ") \
// 		_T("and hpc_status IN('T','S') "), m_nDocNo);
    //
    // 	rs.ExecSQL(szSQL);
    //
    // 	if(!rs.IsEOF())
    // 	{
    // 		grp = rpt.GetGroupHeader(2);
    // 		detail = rpt.AddDetail(grp);
    //
    // 		grp = rpt.GetGroupHeader(3);
    // 		detail = rpt.AddDetail(grp);
    // 		detail->GetItem(_T("OrderName"))->SetBold(true);
    // 		tmpStr.Format(_T("%d. \x58\xE9t nghi\x1EC7m"), nIndex++);
    // 		detail->SetValue(_T("OrderName"), tmpStr);
    //
    // 		nLine = 1;
    // 		//xet nghiem cap 2
    // 		while(!rs.IsEOF())
    // 		{
    // 			szPrintMethod = rs.GetValue(_T("printmethod"));
    // 			tmpStr.Format(_T(" * %s   (%s- %s)"),
    // rs.GetValue(_T("GroupName")), rs.GetValue(_T("order_date")),
    // rs.GetValue(_T("perform_date"))); 			grp = rpt.GetGroupHeader(3); 			detail =
    // rpt.AddDetail(grp); 			detail->GetItem(0)->SetStyle(REPORT_BORDER);
    //
    // 			rs.GetValue(_T("hpc_status"), szStatusOrder);
    //
    // 			detail->SetValue(_T("OrderName"), tmpStr);
    // 			szSQL.Format(_T("SELECT hfl_groupid as groupid, hfl_name as
    // name, hfl_unit as unit, ") \
// 				_T(" hfl_index1 as fnorm, hfl_index2 as mnorm, hpcl_result
    // as result, hpcl_note as note ") \
// 				_T("FROM hms_testorder LEFT JOIN hms_testorderline
    // ON(hpcl_orderid=hpc_orderid) ") \
// 				_T("LEFT JOIN hms_fee_list ON(hfl_typeid='T' AND
    // hpcl_itemid=hfl_feeid) ") \
 				_T("WHERE hpc_docno=%ld AND hpc_groupid='%s'
    // ORDER BY hfl_groupid, hpcl_orderlineid"),m_nDocNo,
    // rs.GetValue(_T("groupid"))); 			nLine=1; 			rsf.ExecSQL(szSQL);
    // 			// print result
    // 			while(!rsf.IsEOF())
    // 			{
    // 				grp = rpt.GetGroupHeader(5);
    // 				detail = rpt.AddDetail(grp);
    // 				tmpStr.Format(_T("%d"), nLine++);
    // 				detail->SetValue(_T("Col1"), tmpStr);
    // 				rsf.GetValue(_T("fnorm"), szFNorm);
    // 				rsf.GetValue(_T("mnorm"), szMNorm);
    // 				rsf.GetValue(_T("unit"), szUnit);
    //
    // 				if (szFNorm.IsEmpty() || szMNorm.IsEmpty() &&
    // szUnit.IsEmpty()) 					tmpStr.Empty(); 				else{ 					if(szSex == _T("F"))
    // 						tmpStr.Format(_T("%s"), rsf.GetValue(_T("fnorm")));
    // 					else
    // 						tmpStr.Format(_T("%s"), rsf.GetValue(_T("mnorm")));
    // 				}
    //
    // 				detail->SetValue(_T("Col4"), tmpStr);
    // 				detail->SetValue(_T("Col2"), rsf.GetValue(_T("name")));
    // 				detail->SetValue(_T("Col3"), rsf.GetValue(_T("unit")));
    //
    // 				if(szStatusOrder == _T("T")){
    // 					detail->SetValue(_T("Col5"),
    // rsf.GetValue(_T("result"))); 					detail->SetValue(_T("Col6"),
    // rsf.GetValue(_T("note")));
    // 				}
    // 				else
    // 				{
    // 					detail->SetValue(_T("Col5"), _T(""));
    // 					detail->SetValue(_T("Col6"), _T(""));
    // 				}
    //
    // 				rsf.MoveNext();
    // 			}
    //
    // 			rs.MoveNext();
    // 		}
    // 	}
    //
    // 	szSQL.Format(_T(" SELECT hpc_orderid, to_char(hpc_orderdate, 'HH24:MI
    // DD/MM/YYYY') order_date, to_char(hpc_performdate, 'HH24:MI DD/MM/YYYY')
    // perform_date,") \
// 		_T("         hfg_id as groupid, ") \
// 		_T("         hfg_name as group_name, ") \
// 		_T("         hpcl_note as note,") \
// 		_T("         hfl_name as ordername,") \
// 		_T("         Tbl.hpr_desc as result") \
// 		_T("  FROM hms_pacsorder") \
// 		_T("  LEFT JOIN hms_pacsorderline ON(hpc_orderid=hpcl_orderid)") \
// 		_T("  LEFT JOIN") \
// 		_T("  (") \
// 		_T("     SELECT * FROM hms_pacs_result") \
// 		_T("     WHERE lower(trim(hpr_name))='conclusion'") \
// 		_T("  ) Tbl ON(Tbl.hpr_orderid=hpcl_orderid AND
    // Tbl.hpr_itemid=hpcl_itemid)") \
// 		_T("  LEFT JOIN hms_fee_group ON(hfg_id=hpc_groupid)") \
// 		_T("  LEFT JOIN hms_fee_list ON(hfl_typeid='T' and
    // hfl_feeid=hpcl_itemid)") \
// 		_T("  WHERE hpc_docno=%ld AND hpc_status<>'O' AND substr(hfg_id, 1,
    // 3) IN('B1E','B1F','B1G') ") \
 		_T("  ORDER by hpc_orderid, hfg_id"),
    // m_nDocNo);
    //
    // 	rs.ExecSQL(szSQL);
    //
    // 	grpt2 = rpt.GetGroupHeader(4);
    // 	grp = rpt.GetGroupHeader(3);
    //
    // 	szRemark.Empty();
    // 	szConclusion.Empty();
    //
    // 	nOrderID = oldOrderID = 0;
    //
    // 	szOldGroup.Empty();
    // 	while(!rs.IsEOF())
    // 	{
    // 		rs.GetValue(_T("groupid"), szNewGroup);
    // 		if(szNewGroup != szOldGroup)
    // 		{
    // 			szNewGroup = szOldGroup;
    // 			tmpStr.Format(_T(" * %s   (%s- %s)"),
    // rs.GetValue(_T("GroupName")), rs.GetValue(_T("order_date")),
    // rs.GetValue(_T("perform_date"))); 			detail = rpt.AddDetail(grp);
    // 			detail->GetItem(0)->SetStyle(REPORT_BORDER);
    // 			detail->SetValue(_T("OrderName"), tmpStr);
    // 		}
    // 		szResult.Empty();
    // 		detail = rpt.AddDetail(grp);
    // 		tmpStr.Format(_T(" - %s"), rs.GetValue(_T("ordername")));
    // 		detail->SetValue(_T("OrderName"), tmpStr);
    //
    // 		rs.GetValue(_T("result"), szResult);
    //
    // 		if(!szResult.IsEmpty())
    // 		{
    // 			detail = rpt.AddDetail(grpt2);
    // 			detail->SetValue(_T("TestResult"), szResult);
    // 		}
    // 		rs.MoveNext();
    // 	}
    //
    // 	szSQL.Format(_T(" SELECT hpc_orderid, to_char(hpc_orderdate, 'HH24:MI
    // DD/MM/YYYY') order_date, to_char(hpc_performdate, 'HH24:MI DD/MM/YYYY')
    // perform_date,") \
// 		_T("         hfg_id as groupid, ") \
// 		_T("         hpcl_note as note,") \
// 		_T("         hfl_name as ordername,") \
// 		_T("         Tbl.hpr_desc as result") \
// 		_T("  FROM hms_pacsorder") \
// 		_T("  LEFT JOIN hms_pacsorderline ON(hpc_orderid=hpcl_orderid)") \
// 		_T("  LEFT JOIN") \
// 		_T("  (") \
// 		_T("     SELECT * FROM hms_pacs_result") \
// 		_T("     WHERE lower(trim(hpr_name))='conclusion'") \
// 		_T("  ) Tbl ON(Tbl.hpr_orderid=hpcl_orderid AND
    // Tbl.hpr_itemid=hpcl_itemid)") \
// 		_T("  LEFT JOIN hms_fee_group ON(hfg_id=hpc_groupid)") \
// 		_T("  LEFT JOIN hms_fee_list ON(hfl_typeid='T' and
    // hfl_feeid=hpcl_itemid)") \
// 		_T("  WHERE hpc_docno=%ld AND hpc_status<>'O' AND substr(hfg_id, 1,
    // 2)='B2' ") \
 		_T("  ORDER by hpc_orderid, hfg_id"), m_nDocNo);
    //
    // 	rs.ExecSQL(szSQL);
    //
    // 	grpt2 = rpt.GetGroupHeader(4);
    // 	grp = rpt.GetGroupHeader(3);
    //
    // 	szRemark.Empty();
    // 	szConclusion.Empty();
    //
    // 	nOrderID = oldOrderID = 0;
    //
    // 	if (!rs.IsEOF())
    // 	{
    // 		grp = rpt.GetGroupHeader(3);
    // 		detail = rpt.AddDetail(grp);
    // 		detail->GetItem(_T("OrderName"))->SetBold(true);
    // 		tmpStr.Format(_T("%d. \x43h\x1EA9n \x111o\xE1n h\xECnh \x1EA3nh"),
    // nIndex++); 		detail->SetValue(_T("OrderName"), tmpStr);
    // 	}
    //
    // 	while(!rs.IsEOF())
    // 	{
    // 		szResult.Empty();
    // 		detail = rpt.AddDetail(grp);
    // 		tmpStr.Format(_T(" * %s   (%s- %s)"), rs.GetValue(_T("ordername")),
    // rs.GetValue(_T("order_date")), rs.GetValue(_T("perform_date")));
    // 		detail->SetValue(_T("OrderName"), tmpStr);
    //
    // 		rs.GetValue(_T("result"), szResult);
    //
    // 		if(!szResult.IsEmpty())
    // 		{
    // 			detail = rpt.AddDetail(grpt2);
    // 			detail->SetValue(_T("TestResult"), szResult);
    //
    // 			if (!szSummaryResult.IsEmpty())
    // 			{
    // 				szSummaryResult.AppendFormat(_T("\r\n"));
    // 			}
    // 			szSummaryResult.AppendFormat(_T("+ %s: %s"),
    // rs.GetValue(_T("ordername")), szResult);
    // 		}
    // 		rs.MoveNext();
    // 	}
    //
    // 	szSQL.Format(_T(" SELECT hpc_orderid, to_char(hpc_orderdate, 'HH24:MI
    // DD/MM/YYYY') order_date, to_char(hpc_performdate, 'HH24:MI DD/MM/YYYY')
    // perform_date,") \
// 		_T("         hfg_id as groupid, ") \
// 		_T("         hpcl_note as note,") \
// 		_T("         hfl_name as ordername,") \
// 		_T("         Tbl.hpr_desc as result") \
// 		_T("  FROM hms_pacsorder") \
// 		_T("  LEFT JOIN hms_pacsorderline ON(hpc_orderid=hpcl_orderid)") \
// 		_T("  LEFT JOIN") \
// 		_T("  (") \
// 		_T("     SELECT * FROM hms_pacs_result") \
// 		_T("     WHERE lower(trim(hpr_name))='conclusion'") \
// 		_T("  ) Tbl ON(Tbl.hpr_orderid=hpcl_orderid AND
    // Tbl.hpr_itemid=hpcl_itemid)") \
// 		_T("  LEFT JOIN hms_fee_group ON(hfg_id=hpc_groupid)") \
// 		_T("  LEFT JOIN hms_fee_list ON(hfl_typeid='T' and
    // hfl_feeid=hpcl_itemid)") \
// 		_T("  WHERE hpc_docno=%ld AND hpc_status<>'O' AND substr(hfg_id, 1,
    // 2)='B3'") \
 		_T("  ORDER by hpc_orderid, hfg_id"), m_nDocNo);
    //
    // 	rs.ExecSQL(szSQL);
    // 	grpt2 = rpt.GetGroupHeader(4);
    // 	grp = rpt.GetGroupHeader(3);
    //
    // 	szRemark.Empty();
    // 	szConclusion.Empty();
    //
    // 	if(!rs.IsEOF())
    // 	{
    // 		grp = rpt.GetGroupHeader(3);
    // 		detail = rpt.AddDetail(grp);
    // 		detail->GetItem(_T("OrderName"))->SetBold(true);
    // 		tmpStr.Format(_T("%d. Th\x103m \x64\xF2 \x63h\x1EE9\x63 n\x103ng"),
    // nIndex++); 		detail->SetValue(_T("OrderName"), tmpStr);
    // 	}
    //
    // 	while (!rs.IsEOF())
    // 	{
    // 		szResult.Empty();
    //
    // 		detail = rpt.AddDetail(grp);
    // 		tmpStr.Format(_T(" * %s   (%s- %s)"), rs.GetValue(_T("ordername")),
    // rs.GetValue(_T("order_date")), rs.GetValue(_T("perform_date")));
    // 		detail->SetValue(_T("OrderName"), tmpStr);
    //
    // 		rs.GetValue(_T("result"), szResult);
    //
    // 		if (!szResult.IsEmpty())
    // 		{
    // 			detail = rpt.AddDetail(grpt2);
    // 			detail->SetValue(_T("TestResult"), szResult);
    // 			if (!szSummaryResult.IsEmpty())
    // 			{
    // 				szSummaryResult.AppendFormat(_T("\r\n"));
    // 			}
    // 			szSummaryResult.AppendFormat(_T("+ %s: %s"),
    // rs.GetValue(_T("ordername")), szResult);
    // 		}
    // 		rs.MoveNext();
    // 	}
    //
    // 	if (!szSummaryResult.IsEmpty() && testDetail)
    // 	{
    // 		testDetail->SetValue(_T("SumTestResult"), szSummaryResult);
    // 	}

    grp = rpt.GetGroupHeader(6);
    detail = rpt.AddDetail(grp);
    szDate.Format(detail->GetValue(_T("PrintDate")), szSysDate.Right(2),
                  szSysDate.Mid(5, 2), szSysDate.Left(4));
    detail->SetValue(_T("PrintDate"), szDate);
    detail->SetValue(_T("doctorname"), tmpStr7);
    detail->SetValue(_T("end_date"), rss.GetValue(_T("end_date")));

    szSQL.Format(
        _T(" SELECT to_char(hci_date, 'dd/mm/yyyy hh24:mi:ss') AS thoi_gian,")
        _T("        hci_disease AS dien_bien,")
        _T("        hci_care AS xu_tri")
        _T(" FROM   hms_careinfo")
        _T(" WHERE  hci_docno = %ld")
        _T(" and hci_deptid = '%s'"),
        m_nDocNo, pMF->GetCurrentDepartmentID());

    rs.ExecSQL(szSQL);
    while (!rs.IsEOF())
    {
        detail = rpt.AddDetail(rpt.GetGroupHeader(7));
        detail->SetValue(_T("1"), rs.GetValue(_T("thoi_gian")));
        detail->SetValue(_T("2"), rs.GetValue(_T("dien_bien")));
        detail->SetValue(_T("3"), rs.GetValue(_T("xu_tri")));
        rs.MoveNext();
    }
    // for (int i = 0; i < 41; i++) rpt.AddDetail(rpt.GetGroupHeader(8));
    // rpt.AddDetail(rpt.GetGroupHeader(9));
    rpt.PrintPreview();
}


void CPrintForms::OnPrintFooterUser(CReportSection* rptFooter, CString szFieldEx, CString szFieldSkip) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CString szSQL, szWhere;
	szWhere.Format(_T(" AND fpf_module_id = '%s'"), pMF->GetModuleID());
	szWhere.AppendFormat(_T(" AND (fpf_type IS NULL OR fpf_type = '%s')"), szFieldEx);
	if (!szFieldSkip.IsEmpty())
		szWhere.AppendFormat(_T(" AND fpf_position NOT IN (%s)"), szFieldSkip);
	szSQL.Format(_T("SELECT fpf_position field_name, fpf_title title FROM fm_print_footer WHERE 1=1 %s"), szWhere);
	rs.ExecSQL(szSQL);
	while (!rs.IsEOF()) {
		rptFooter->SetValue(rs.GetValue(_T("field_name")), rs.GetValue(_T("title")));
		rs.MoveNext();
	}
}

void CPrintForms::E10_TrackItem(long nInvoiceNo, long nProductItemID) {
	CE10_TrackItem ti(nInvoiceNo, nProductItemID);
	return;
}


void CPrintForms::PrintMedicalFile(CStringArray& info, bool bPreview)
{

	//_msg(_T("Hi %s"), info[6]);
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rsb(&pMF->m_db);
	CReport rpt;
	long nDocumentNo = str2long(info[0]);
	CString szDept = info[1];
	CString szHealthService = info[2];
	CString szHospitalName = info[3];
	CString szCancer = L"";
	//CString szCancer = info[4];
	int nTreatTime = str2int(info[5]);
	int nCancerTime = str2int(info[6]);
	CString szForm = info[6];

	if (nDocumentNo <= 0)
		return;
	CString szSQL, tmpStr, szReportName, szTemp, szNumber, szFoodMode, szDate, szPTTYCDept, tmpStr1, szTitle;

	szSQL.Format(_T(" SELECT htr_ward FROM hms_treatment_record WHERE htr_docno = %ld AND rownum = 1 "), nDocumentNo);
	rs.ExecSQL(szSQL);
	rs.GetValue(_T("htr_ward"), szPTTYCDept);
	if (szPTTYCDept == _T(""))
	{
		szPTTYCDept.AppendFormat(_T("%s"), szDept);
	}
	else
	{
		szPTTYCDept.AppendFormat(_T(" - %s"), szDept);
	}


	/*
		szSQL.Format(_T(" SELECT    Trunc(hfo_orderdate) orderdate, ") \
					_T("           hfl_name             modename, ") \
					_T("           hfol_type type") \
					_T(" FROM      hms_feefood ") \
					_T(" LEFT JOIN hms_feefoodline ON ( hfo_orderid = hfol_orderid ) ") \
					_T(" LEFT JOIN hms_fee_list ON ( hfl_feeid = hfol_itemid ) ") \
					_T(" WHERE     hfo_docno = %ld ") \
					_T("       AND hfo_deptid = '%s'"), nDocumentNo, szDept);
		rs.ExecSQL(szSQL);
		while (!rs.IsEOF())
		{
			rs.GetValue(_T("type"), tmpStr);
			if (tmpStr == _T("T"))
			{
				rs.GetValue(_T("modename"), tmpStr);
				rs.GetValue(_T("orderdate"), szDate);
				szFoodMode.AppendFormat(_T("\x102n tr\x1B0\x61: %s %s"), CDate::Convert(szDate, yyyymmdd, ddmmyyyy).Left(5), tmpStr);
			}
			else if (tmpStr == _T("C"))
			{
				rs.GetValue(_T("modename"), tmpStr);
				rs.GetValue(_T("orderdate"), szDate);
				szFoodMode.AppendFormat(_T(" \x102n t\x1ED1i: %s %s"), CDate::Convert(szDate, yyyymmdd, ddmmyyyy).Left(5), tmpStr);
			}
			rs.MoveNext();
		}
		if (szFoodMode.IsEmpty())
			szFoodMode = _T("T\x1EF1 t\xFA\x63");
	*/
	szSQL.Format(_T(" SELECT hp_patientno as patientno, trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname, ") \
				_T("        extract(year from hp_birthdate) as yob, ") \
				_T("		case when hfe_amount > 0 and hfe_date > hd_enddate then 'Y' else 'N' end AS checkstt, ") \
				_T("        (select ss_desc from sys_sel where ss_id= 'sys_sex' and ss_code =  hp_sex) as sex, ") \
				_T("        (select ss_desc from sys_sel where ss_id ='hms_rank' and cast(ss_code as integer)=hp_rank) as rank, ") \
				_T("        (select ss_desc from sys_sel where ss_id ='hms_position' and cast(ss_code as integer)=hp_position) as position, ") \
				_T("        hp_workplace as unit, ") \
				_T("        hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) as address, ") \
				_T("        nvl(hd_dtladdr, hp_dtladdr) as dtladdress, ") \
				_T("        hd_relative as relative, ") \
				_T("        (select ss_desc from sys_sel where ss_id = 'hrm_relation' and ss_code = hd_relation) as relation, ") \
				_T("        hd_contactaddr as reladdress, ") \
				_T("        hd_contacttel as relphone, ") \
				_T("        hd_transdiagn as trdisease, ") \
				_T("        (select hi_name from hms_icd where hi_icd=hd_transicd) as icd10, ") \
				_T("        hd_conclusion as disease, ") \
				_T("        hd_suggestion as suggestion, ") \
				_T("        trunc(hd_admitdate) as examdte, ") \
				_T("		CASE WHEN hcr_cancer = 'Y' THEN (select min(htr_admitdate) from hms_treatment_record where htr_docno=hcr_docno AND htr_treattime = %d)  ") \
				_T("        ELSE hcr_admitdate END as admitdate,") \
				_T("        hd_indept as deptid, ") \
				_T("        (select sd_name from sys_dept where sd_id=hcr_admitdept) as facname, ") \
				_T("        hcr_recordno as numinward, hcr_treattime as inwardtime, ") \
				_T("        hcr_foodmode as foodmode, ") \
				_T("        (select ho_desc from hms_object where ho_id=hd_object) as policydesc, ") \
				_T("        (select hc_cardno from hms_card where hc_patientno=hd_patientno and hc_idx=hd_cardidx) as cardno, ") \
				_T("  hcr_cancer, ") \
				_T("  hcr_cancer_time, ") \
				//_T("  hd_disrate, ") \//
				_T("   case when NVL(HD_INSLINE, 'N') = 'Y' AND NVL(HD_EMERGENCY,'N')='N' THEN HC_DISCOUNT*(select HMS_INSOFFLINE from hms_config)/100 else cast(hd_disrate as integer) end as disrate, ") \
				_T("  hd_emergency, ") \
				_T("   hcr_dischargedate,") \
				_T("   hcr_sumtreat,") \
				_T("   hcr_result,") \
				_T("   case when hcr_status='T' then hcr_maindisease else cast('' as nvarchar2(254)) end as maindisease, ") \
				_T("   hcr_conclusion") \
				_T(" FROM hms_patient ") \
				_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno) ") \
				_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
				_T(" LEFT JOIN hms_clinical_record_hist ON(hcr_docno=hd_docno AND hcr_treattime = %d) ") \
				_T(" LEFT JOIN hms_fee_deposit ON(hfe_patientno = hp_patientno AND hfe_docno = hd_docno) ") \
				_T(" WHERE hd_docno=%ld and hd_status in('P','T') and rownum < 2")
		, nTreatTime, nTreatTime, nDocumentNo);
	//_msg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		ShowMessageBox(_T("Patient not found"));
		return;

	}


	//CString szCancer;
	//rs.GetValue(_T("hcr_cancer"), szCancer);

	if (szCancer == _T("Y"))
	{
		//rs.GetValue(_T("hcr_cancer_time"), nCancerTime);
		szReportName.Format(_T("Reports\\HMS\\BENHAN\\BENHANUNGTHU.RPT"));
		if (nCancerTime > 1)
		{
			szReportName.Format(_T("Reports\\HMS\\BENHAN\\BENHANUNGTHU_TULAN2.RPT"));
		}
	}
	else
	{
		/*
				CString szDeptID, szRptName;
				rs.GetValue(_T("deptid"), szDeptID);
				szSQL.Format(_T("SELECT hafc_reportname as reportname, hafc_desc as reportdesc FROM hms_admissionfile_config WHERE hafc_deptid='%s' "), szDept);
				CRecord rsx(&pMF->m_db);
				rsx.ExecSQL(szSQL);
				if(!rsx.IsEOF()){
					if (rsx.GetRecordCount() == 1){
						rsx.GetValue(_T("reportname"), szRptName);
						if(szRptName.IsEmpty())
							szRptName = _T("BA.RPT");
						szReportName.Format(_T("Reports\\HMS\\BENHAN\\%s"), szRptName);
					}
					else{
						CARReportOptionDlg dlg(pMF);
						dlg.m_szDeptID = szDeptID;
						if (dlg.DoModal() == IDOK){
							szReportName.Format(_T("Reports\\HMS\\BENHAN\\%s"), dlg.m_szReportNameKey);
						}
						else{
							return;
						}

					}
				}
				else
					szReportName.Format(_T("Reports\\HMS\\BENHAN\\BA.RPT"));
		*/
		szTitle = _T("BENHANVAOVIEN");
		if (pMF->IsOutPatient() && pMF->GetCurrentDepartmentID() == _T("A10"))
		{
			szTitle = _T("BENHANVAOVIEN_NGT");
		}
		szReportName.Format(_T("Reports\\HMS\\BENHAN\\%s.RPT"), szTitle);
	}
	//szReportName.Format(_T("Reports\\HMS\\BENHAN\\Khoa B4.m.RPT"));
	if (!rpt.Init(szReportName))
	{
		return;
	}
	//rpt.SetMargins(200, 200, 200, 200);


	CString szExportFile;
	CString szPatientName = pMF->GetProp(L"patient_name");
	TCHAR szName[128];
	UnMarkString(szPatientName, szName);
	szExportFile.Format(L"%ld_%s_%s", nDocumentNo, szName, pMF->m_szDeptID);
	rpt.SetExportFile(szExportFile);


	rpt.GetReportHeader()->SetValue(_T("_health_service"), szHealthService);
	rpt.GetReportHeader()->SetValue(_T("_HOSPITAL_NAME"), pMF->m_szHospitalName);

	if (pMF->GetCurrentDepartmentID() == _T("PTTYC"))
	{
		rpt.GetReportHeader()->SetValue(_T("_faculty_name"), szPTTYCDept);
	}
	else
		rpt.GetReportHeader()->SetValue(_T("_faculty_name"), pMF->GetDepartmentName(szDept));

	StringUpper(rs.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_name"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_y_of_birth"), rs.GetValue(_T("yob")));
	rpt.GetReportHeader()->SetValue(_T("_sex"), rs.GetValue(_T("sex")));
	if (rs.GetValue(_T("checkstt")) == _T("Y"))
	{
		rpt.GetReportHeader()->SetValue(_T("DaNopTamGui"), _T("\x110\xE3 n\x1ED9p t\x1EA1m g\x1EEDi"));
	}
	tmpStr.Format(_T("%s"), rs.GetValue(_T("dtladdress")));
	if (!tmpStr.IsEmpty())
		tmpStr.AppendFormat(_T(" - "));
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("address")));
	rpt.GetReportHeader()->SetValue(_T("_native_vill"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_unit"), rs.GetValue(_T("unit")));
	rpt.GetReportHeader()->SetValue(_T("_rank"), rs.GetValue(_T("rank")));
	rpt.GetReportHeader()->SetValue(_T("_position"), rs.GetValue(_T("position")));
	rs.GetValue(_T("examdte"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_infect_date"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	tmpStr.Format(_T("%s"), CDateTime::Convert(rs.GetValue(_T("admitdate")), yyyymmdd | hhmmss, ddmmyyyy | hhmmss));
	//rs.GetValue(_T("admitdate"), tmpStr);
	//_debug(_T("%s:%s"), rs.GetValue(_T("admitdate")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_enter_date"), tmpStr);
	szTemp = rs.GetValue(_T("suggestion"));
	tmpStr.Empty();
	//if (szTemp == _T("C"))
	//	tmpStr.Format(_T("NT- "));
	CString szRecordNo;
	szTemp = rs.GetValue(_T("numinward"));
	szRecordNo = szTemp;

	if (szTemp == _T("0"))
		tmpStr.Empty();
	//else if(m_nPolicy == 7)
	//	tmpStr.AppendFormat(_T("%s- DV"), szTemp);
	else
		tmpStr += szTemp;
	rpt.GetReportHeader()->GetItem(_T("_number"))->SetFaceSize(9);

	if (szCancer == _T("Y"))
	{
		tmpStr.AppendFormat(_T(" - %.3dK"), nCancerTime);
	}

	rpt.GetReportHeader()->SetValue(_T("_number"), tmpStr);
	if (nCancerTime > 1)
	{
		tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("ReportTitle")), nCancerTime);
		rpt.GetReportHeader()->SetValue(_T("ReportTitle"), tmpStr);

	}
	rs.GetValue(_T("inwardtime"), tmpStr);
	if (tmpStr == _T("0"))
		tmpStr.Empty();
	if (szCancer == _T("Y"))
	{
		// 		int nHtrIdx = 0;
		// 		rs.GetValue(_T("hcr_cancer_time"), nHtrIdx);
		tmpStr.Format(_T("%d"), nCancerTime);
	}
	rpt.GetReportHeader()->SetValue(_T("_times"), tmpStr);

	long nPatientNo;
	rs.GetValue(_T("patientno"), nPatientNo);
	tmpStr.Format(_T("%d"), nPatientNo);
	rpt.GetReportHeader()->SetValue(_T("_patientno"), tmpStr);

	tmpStr.Format(_T("%d"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("_docno"), tmpStr);
	tmpStr.Format(_T("%s"), rs.GetValue(_T("policydesc")));
	rpt.GetReportHeader()->SetValue(_T("_policydesc"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_relatives"), rs.GetValue(_T("relative")));
	rpt.GetReportHeader()->SetValue(_T("_relation"), rs.GetValue(_T("relation")));

	rpt.GetReportHeader()->SetValue(_T("_phone"), rs.GetValue(_T("relphone")));
	rpt.GetReportHeader()->SetValue(_T("_address"), rs.GetValue(_T("reladdress")));
	rpt.GetReportHeader()->SetValue(_T("_unit_diag.1"), rs.GetValue(_T("trdisease")));

	tmpStr.Format(_T("%s\r\n%s"), rs.GetValue(_T("icd10")), rs.GetValue(_T("disease")));
	rpt.GetReportHeader()->SetValue(_T("_exam_diag.1"), tmpStr);

	rs.GetValue(_T("hcr_dischargedate"), tmpStr);
	if (!tmpStr.IsEmpty())
		rpt.GetReportHeader()->SetValue(_T("ngayravien"), tmpStr);
	//Lấy ra số ngày điều trị thực tế -> các ô cần thiết
	szSQL.Format(_T(" SELECT hms_get_bed_qty(%ld, %ld) as totalbedday FROM dual "), nDocumentNo, nTreatTime);
	rsb.ExecSQL(szSQL);
	rpt.GetReportHeader()->SetValue(_T("songaydt"), rsb.GetValue(_T("totalbedday")));

	rs.GetValue(_T("hcr_result"), tmpStr);

	if (tmpStr == _T("1"))
		rpt.GetReportHeader()->SetValue(_T("ov2"), _T("X"));
	if (tmpStr == _T("2"))
		rpt.GetReportHeader()->SetValue(_T("ov3"), _T("X"));
	if (tmpStr == _T("5") || tmpStr == _T("6"))
	{
		rpt.GetReportHeader()->SetValue(_T("ov4"), _T("X"));
		rpt.GetReportHeader()->SetValue(_T("chandoantuvong"), rs.GetValue(_T("hcr_conclusion")));
	}
	if (tmpStr == _T("7"))
		rpt.GetReportHeader()->SetValue(_T("ov5"), _T("X"));

	rpt.GetReportHeader()->SetValue(_T("chandoanravien"), rs.GetValue(_T("maindisease")));

	CReportSection* rptDtl = rpt.GetDetail();
	rptDtl = rpt.AddDetail(rpt.GetGroupFooter(1));
	rptDtl->SetPageBreak(true);

	tmpStr.Empty();
	rs.GetValue(_T("cardno"), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		CString szCardDesc;

		szCardDesc.Format(_T("S\x1ED1 th\x1EBB: %s"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("_cardno"), szCardDesc);
	}

	tmpStr = pMF->GetSysTime();
	//	tmpStr.Format("Lµm bÖnh ¸n lóc: %s %s"), tmpStr.Left(5), pMF->getSysDte());
	//	rpt.GetReportHeader()->SetValue(_T("_printdate"), tmpStr);
	CReportItem* obj = NULL;
	obj = rpt.GetReportHeader()->GetItem(_T("_foodmode"));
	if (obj)
		obj->SetFixedHeight(false);
	rpt.GetReportHeader()->SetValue(_T("_foodmode"), szFoodMode);
	rpt.GetReportFooter()->Format(_T("PrintDate"), _T(""), _T("...."), _T("...."), _T("...."));

	rs.GetValue(_T("hd_emergency"), szTemp);
	if (szTemp == _T("Y"))
		rpt.GetReportHeader()->SetValue(_T("_emergency"), _T("X"));

	int nDisrate;
	rs.GetValue(_T("disrate"), nDisrate);
	if (nDisrate > 0)
		tmpStr.Format(_T("%d%s"), nDisrate, _T("%"));
	else
		tmpStr.Empty();
	rpt.GetReportHeader()->SetValue(_T("_disrate"), tmpStr);

	//rpt.AddDetail();
// 	if (nTreatTime > 1)
// 	{
// 		CReportSection *rptGroup = NULL;
// 		rptGroup = rpt.AddDetail(rpt.GetGroupHeader(2));
// 		rptGroup->SetPageBreak();
// 		rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
// 	}

	CRecord rsl(&pMF->m_db);
	CString szExamInfo;
	CReportSection* rptDetail = rpt.GetDetail(0);
	JSONVALUE jData;
	CString szFilter;
	CString szWhere;
	if (nTreatTime <= 1)
		szWhere.Format(_T(" and (hde_treattime=%d or hde_treattime=0) "), nTreatTime);
	else
		szWhere.Format(_T(" and (hde_treattime=%d ) "), nTreatTime);


	if (szCancer == _T("Y") && nCancerTime > 1)
	{
		//Load thong tin ket luan benh an ung thu lan 2
		szExamInfo.Empty();

		CString szFilter;
		//and hde_refidx=%d ,nHtrIdx
		//szFilter.Format(_T(" and hde_roomid=%d "), nCancerTime);
		szFilter.Empty();
		bool res = pMF->GetEMRData(nDocumentNo, nTreatTime, _T("BENH_AN_KL_UTTL2"), szRecordNo, szFilter, szExamInfo);
		if (!res)
		{
			//Truong hơp dữ liệu cũ
			szSQL.Format(_T("SELECT to_char(hde_value) as hde_value, hde_createdby FROM hms_doc_emr ") \
				_T(" WHERE hde_docno=%ld and hde_type IN('BENH_AN_KL_UTTL2') ") \
				_T(" %s ") \
				_T(" ORDER BY hde_type, hde_refidx "), nDocumentNo, szWhere);
			szExamInfo.Empty();
			rsl.ExecSQL(szSQL);
			while (!rsl.IsEOF())
			{
				rsl.GetValue(_T("hde_value"), tmpStr);
				szExamInfo.AppendFormat(_T("%s"), tmpStr);
				rsl.MoveNext();
			}
		}

		if (!szExamInfo.IsEmpty())
		{
			jData.Clear();
			jData.Parse(szExamInfo);
			tmpStr.Empty();

			jData[_T("kham_benh")].GetValue(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("kham_benh"), tmpStr);
			jData[_T("danh_gia_ket_qua")].GetValue(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("danh_gia_ket_qua"), tmpStr);
			jData[_T("chan_doan")].GetValue(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("chan_doan"), tmpStr);
			jData[_T("ke_hoach_xet_nghiem")].GetValue(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("ke_hoach_xet_nghiem"), tmpStr);
			jData[_T("ke_hoach_dieu_tri")].GetValue(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("ke_hoach_dieu_tri"), tmpStr);
			jData[_T("tien_luong")].GetValue(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("tien_luong"), tmpStr);
		}
	}
	else
	{
		//Load thong tin ket luan
		szExamInfo.Empty();
		//szFilter.Format(_T(" and hde_refidx=%d  "), nHtrIdx);
		szFilter.Empty();
		bool res = pMF->GetEMRData(nDocumentNo, nTreatTime, _T("BENH_AN_KL"), szRecordNo, szFilter, szExamInfo);
		if (!res)
		{
			szSQL.Format(_T("SELECT to_char(hde_value) as hde_value, hde_createdby FROM hms_doc_emr ") \
				_T(" WHERE hde_docno=%ld and hde_type IN('BENH_AN_KL') ") \
				_T(" %s ") \
				_T(" ORDER BY hde_type, hde_refidx "), nDocumentNo, szWhere);
			szExamInfo.Empty();
			rsl.ExecSQL(szSQL);
			while (!rsl.IsEOF())
			{
				rsl.GetValue(_T("hde_value"), tmpStr);
				szExamInfo.AppendFormat(_T("%s"), tmpStr);
				rsl.MoveNext();
			}
		}

		if (!szExamInfo.IsEmpty())
		{
			jData.Clear();
			jData.Parse(szExamInfo);
			tmpStr.Empty();

			jData[_T("chan_doan_so_bo")].GetValue(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("chandoansobo"), tmpStr);
			jData[_T("chan_doan_phan_biet")].GetValue(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("chandoanphanbiet"), tmpStr);
			jData[_T("chan_doan_xac_dinh")].GetValue(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("chandoanxacdinh"), tmpStr);
		}
	}

	//Load thong tin hoi benh
	szExamInfo.Empty();

	//szFilter.Format(_T(" and hde_refidx=%d  "), nHtrIdx);
	szFilter.Empty();
	bool res = pMF->GetEMRData(nDocumentNo, nTreatTime, _T("BENH_AN_HB"), szRecordNo, szFilter, szExamInfo);
	if (!res)
	{

		szSQL.Format(_T("SELECT to_char(hde_value) as hde_value FROM hms_doc_emr ") \
			_T(" WHERE hde_docno=%ld and hde_type IN('BENH_AN_HB') ") \
			_T(" %s ")
			_T(" ORDER BY hde_type, hde_refidx "), nDocumentNo, szWhere);

		rsl.ExecSQL(szSQL);
		szExamInfo.Empty();
		while (!rsl.IsEOF())
		{
			rsl.GetValue(_T("hde_value"), tmpStr);
			szExamInfo.AppendFormat(_T("%s"), tmpStr);
			rsl.MoveNext();
		}
	}

	if (!szExamInfo.IsEmpty())
	{
		jData.Parse(szExamInfo);
		tmpStr.Empty();
		//gan rptDetail = rpt.GetGroupHeader(xxx);
		//Tam thoi gan = reportheader de test
		rptDetail = rpt.GetGroupHeader(1);
		if (rptDetail)
		{

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));

			jData[_T("vaoluc")].GetValue(tmpStr);
			szTemp.Format(rptDetail->GetValue(_T("vaoluc")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
			rptDetail->SetValue(_T("vaoluc"), szTemp);
			long vao_ngay_thu;
			jData[_T("vaongay")].GetValue(vao_ngay_thu);
			tmpStr.Format(_T("%ld"), vao_ngay_thu);
			rptDetail->SetValue(_T("vaongay"), tmpStr);
			jData[_T("ly_do_vao_vien")].GetValue(tmpStr);

			rptDetail->SetValue(_T("ly_do_vao_vien"), tmpStr);
			jData[_T("benhsu")].GetValue(tmpStr);
			//rptDetail->SetValue(_T("benhsu"), tmpStr);
			/*Split*/
			rptDetail = rpt.GetGroupHeader(12);
			_tprintf(_T("\nbenhsu:%s"), tmpStr);
			SplitParagraph(&rpt, rptDetail, tmpStr, _T("single_line"));

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(2));
			jData[_T("tien_su_ban_than")].GetValue(tmpStr);
			rptDetail->SetValue(_T("tien_su_ban_than"), tmpStr);

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));

			jData[_T("tien_su_gia_dinh")].GetValue(tmpStr);
			rptDetail->SetValue(_T("tien_su_gia_dinh"), tmpStr);
		}

	}

	//Load thong tin kham benh
	szExamInfo.Empty();
	//szFilter.Format(_T(" and hde_refidx=%d  "), nHtrIdx);
	szFilter.Empty();
	res = pMF->GetEMRData(nDocumentNo, nTreatTime, _T("BENH_AN_KB"), szRecordNo, szFilter, szExamInfo);
	if (!res)
	{

		szSQL.Format(_T("SELECT to_char(hde_value) as hde_value FROM hms_doc_emr ") \
			_T(" WHERE hde_docno=%ld and hde_type IN('BENH_AN_KB') ") \
			_T(" %s ") \
			_T(" ORDER BY hde_type, hde_refidx "), nDocumentNo, szWhere);
		rsl.ExecSQL(szSQL);
		while (!rsl.IsEOF())
		{
			rsl.GetValue(_T("hde_value"), tmpStr);
			szExamInfo.AppendFormat(_T("%s"), tmpStr);
			rsl.MoveNext();
		}

	}


	if (!szExamInfo.IsEmpty())
	{
		//if(szCancer == _T("Y") && nTreatTime > 1)
		if (szCancer == _T("Y") && nCancerTime > 1)

		{
			jData.Clear();
			jData.Parse(szExamInfo);
			tmpStr.Empty();
			int n = 0;
			jData[_T("mach")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("mach")), n);
			rpt.GetReportHeader()->SetValue(_T("mach"), tmpStr);

			float nd = 0;
			jData[_T("nhiet_do")].GetValue(nd);
			tmpStr.Empty();
			if (nd > 0)
				tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("nhiet_do")), nd);
			rpt.GetReportHeader()->SetValue(_T("nhiet_do"), tmpStr);

			int m = 0; n = 0;
			jData[_T("huyet_ap")].GetValue(n);
			tmpStr.Empty();
			jData[_T("huyet_ap2")].GetValue(m);
			tmpStr.Empty();

			if (m + n > 0)
				tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("huyet_ap")), n, m);

			rpt.GetReportHeader()->SetValue(_T("huyet_ap"), tmpStr);

			n = 0;
			jData[_T("nhip_tho")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("nhip_tho")), n);
			rpt.GetReportHeader()->SetValue(_T("nhip_tho"), tmpStr);

			n = 0;
			jData[_T("can_nang")].GetValue(n);
			tmpStr.Empty();
			tmpStr1.Empty();
			if (n > 0)
				tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("can_nang")), n);
			rpt.GetReportHeader()->SetValue(_T("can_nang"), tmpStr);

			n = 0;
			jData[_T("chieu_cao")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("chieu_cao")), n);
			rpt.GetReportHeader()->SetValue(_T("chieu_cao"), tmpStr);

			n = 0;
			jData[_T("dinh_duong")].GetValue(tmpStr1);
			tmpStr.Empty();
			tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("dinh_duong")), tmpStr1);
			if (!tmpStr.IsEmpty());
			rpt.GetReportHeader()->SetValue(_T("dinh_duong"), tmpStr);

		}
		else
		{
			rptDetail = rpt.GetGroupHeader(4);
			if (rptDetail)
			{
				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(4));
				jData.Clear();
				jData.Parse(szExamInfo);
				tmpStr.Empty();

				jData[_T("toan_than")].GetValue(tmpStr);
				rptDetail->SetValue(_T("toan_than"), tmpStr);

				int n = 0;
				jData[_T("mach")].GetValue(n);
				tmpStr.Empty();
				if (n > 0)
					tmpStr.Format(_T("%d"), n);
				rptDetail->SetValue(_T("mach"), tmpStr);

				float nd = 0;
				jData[_T("nhiet_do")].GetValue(nd);
				tmpStr.Empty();
				if (nd > 0)
					tmpStr.Format(_T("%.2f"), nd);
				rptDetail->SetValue(_T("nhiet_do"), tmpStr);

				n = 0;
				jData[_T("huyet_ap")].GetValue(n);
				tmpStr.Empty();
				if (n > 0)
					tmpStr.Format(_T("%d"), n);

				rptDetail->SetValue(_T("huyet_ap"), tmpStr);

				n = 0;
				jData[_T("huyet_ap2")].GetValue(n);
				tmpStr.Empty();
				if (n > 0)
					tmpStr.Format(_T("%d"), n);

				rptDetail->SetValue(_T("huyet_ap2"), tmpStr);

				n = 0;
				jData[_T("nhip_tho")].GetValue(n);
				tmpStr.Empty();
				if (n > 0)
					tmpStr.Format(_T("%d"), n);
				rptDetail->SetValue(_T("nhip_tho"), tmpStr);

				n = 0;
				jData[_T("chieu_cao")].GetValue(n);
				tmpStr.Empty();
				if (n > 0)
					tmpStr.Format(_T("%d"), n);
				rptDetail->SetValue(_T("chieu_cao"), tmpStr);

				n = 0;
				jData[_T("can_nang")].GetValue(n);
				tmpStr.Empty();
				if (n > 0)
					tmpStr.Format(_T("%d"), n);
				rptDetail->SetValue(_T("can_nang"), tmpStr);

				jData[_T("dinh_duong")].GetValue(tmpStr);
				rptDetail->SetValue(_T("dinhduong"), tmpStr);

				jData[_T("dien_tich_da")].GetValue(tmpStr);
				rptDetail->SetValue(_T("dientichda"), tmpStr);

				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(5));
				/*
				jData[_T("tuan_hoan")].GetValue(tmpStr);
				rptDetail->SetValue(_T("tuan_hoan"), tmpStr);

				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(6));

				jData[_T("ho_hap")].GetValue(tmpStr);
				rptDetail->SetValue(_T("ho_hap"), tmpStr);

				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(7));

				jData[_T("tieu_hoa")].GetValue(tmpStr);
				rptDetail->SetValue(_T("tieu_hoa"), tmpStr);

				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(8));

				jData[_T("tiet_nieu")].GetValue(tmpStr);
				rptDetail->SetValue(_T("tiet_nieu"), tmpStr);

				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(9));

				jData[_T("than_kinh")].GetValue(tmpStr);
				rptDetail->SetValue(_T("than_kinh"), tmpStr);

				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(10));

				jData[_T("co_xuong_khop")].GetValue(tmpStr);
				rptDetail->SetValue(_T("co_xuong_khop"), tmpStr);

				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(11));

				jData[_T("chuyen_khoa_khac")].GetValue(tmpStr);
				rptDetail->SetValue(_T("chuyen_khoa_khac"), tmpStr);
				*/
				/*Split*/
				rptDetail = rpt.GetGroupHeader(12);
				SplitParagraph(&rpt, rptDetail, jData, _T("tuan_hoan"), _T("single_line"));
				SplitParagraph(&rpt, rptDetail, jData, _T("ho_hap"), _T("single_line"));
				SplitParagraph(&rpt, rptDetail, jData, _T("tieu_hoa"), _T("single_line"));
				SplitParagraph(&rpt, rptDetail, jData, _T("tiet_nieu"), _T("single_line"));
				SplitParagraph(&rpt, rptDetail, jData, _T("than_kinh"), _T("single_line"));
				SplitParagraph(&rpt, rptDetail, jData, _T("co_xuong_khop"), _T("single_line"));
				SplitParagraph(&rpt, rptDetail, jData, _T("chuyen_khoa_khac"), _T("single_line"));
				//CString tmpStr2, tmpStr3;
				//jData[_T("xet_nghiem")].GetValue(tmpStr2);
				//tmpStr3.Format(_T("%s %s"), tmpStr, tmpStr2);
				//rptDetail = rpt.AddDetail(rpt.GetGroupHeader(12));
				//rptDetail->SetValue(_T("xet_nghiem"), tmpStr3);

			}
			/*
			rptDetail = rpt.GetGroupHeader(12);
			jData[_T("toan_than")].GetValue(tmpStr);
			rptDetail->SetValue(_T("toan_than"), tmpStr);
			SplitParagraph(&rpt, rptDetail, tmpStr, _T("toan_than"));
			*/
		}
		/*
		rptDetail = rpt.AddDetail(rpt.GetGroupHeader(12));
		//rptDetail = rpt.AddDetail();
		jData[_T("xet_nghiem")].GetValue(tmpStr);
		rptDetail->SetValue(_T("xet_nghiem"), tmpStr);
		*/
	}




	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print();

	if (szCancer != _T("Y") || nCancerTime < 2)
	{
		PrintMedicalFile_Page2(nDocumentNo, szDept, bPreview, nTreatTime, szForm);
	}
}
void CPrintForms::PrintMedicalFile_Page2(long nDocumentNo, CString szDept, bool bPreview, int nTreatTime, CString szForm)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CReport rpt;

	CString szReportName, szRptName;
	CString szSQL, tmpStr, szDSQL, szDoctorID;
	CString szWhere;
	if (nTreatTime <= 1)
		szWhere.Format(_T(" and (hde_treattime=%d or hde_treattime=0) "), nTreatTime);
	else
		szWhere.Format(_T(" and (hde_treattime=%d) "), nTreatTime);


	//szWhere.AppendFormat(_T(" and hde_deptid='%s' "), szDept);

//	szSQL.Format(_T("SELECT hafc_reportname as reportname, hafc_desc as reportdesc FROM hms_admissionfile_config WHERE hafc_deptid='%s' "), szDept);

	//Truong hop benh nhan chuyen khoa thi lay ho so trong hms_doc_emr va du lieu trong hms_doc_emrline
	szSQL.Format(_T(" SELECT hafc_reportname as reportname, hafc_html as ishtml ") \
		_T(" FROM hms_doc_emr,") \
		_T("   hms_admissionfile_config") \
		_T(" WHERE hde_docno   = %ld") \
		_T(" AND hde_type      ='BENH_AN_CHUYEN_KHOA'") \
		_T(" AND hafc_form     =hde_name") \
		_T(" AND hafc_deptid   = hde_deptid %s "), nDocumentNo, szWhere);

	if (!szForm.IsEmpty())
	{
		szSQL.AppendFormat(_T(" and hde_name='%s' "), szForm);

	}
	CRecord rsx(&pMF->m_db);
	rsx.ExecSQL(szSQL);
	_tprintf(_T("\r\n%s"), szSQL);
	CString szHtml;
	szHtml.Empty();
	if (!rsx.IsEOF()) {
		if (rsx.GetRecordCount() == 1) {
			rsx.GetValue(_T("reportname"), szRptName);
			rsx.GetValue(_T("ishtml"), szHtml);
			if (szRptName.IsEmpty())
				szRptName = _T("BA.RPT");
			szReportName.Format(_T("Reports\\HMS\\BENHAN\\PAGE2_%s"), szRptName);
		}
		else {
			CARReportOptionDlg dlg(pMF, nDocumentNo);
			//dlg.m_szDeptID = szDept;
			if (dlg.DoModal() == IDOK) {
				szReportName.Format(_T("Reports\\HMS\\BENHAN\\PAGE2_%s"), dlg.m_szReportNameKey);
			}
			else {
				return;
			}

		}
	}
	else
		szReportName.Format(_T("Reports\\HMS\\BENHAN\\PAGE2_BA.RPT"));
	szReportName.MakeUpper();
	if (szHtml == _T("Y"))
	{
		szReportName.Replace(_T(".RPT"), _T(".HTML"));
	}
	_tprintf(_T("\nszReportName: %s"), szReportName);
	if (!rpt.Init(szReportName))
	{
		return;
	}

	CRecord rsl(&pMF->m_db);


	CString szExamInfo;
	CString szRecordNo;
	CString szSpecialInfo;

	szExamInfo.Empty();
	szSpecialInfo.Empty();
	CString szFilter;

	szSQL.Format(_T("SELECT hcr_recordno FROM hms_clinical_record WHERE hcr_docno=%ld "), nDocumentNo);
	rsl.ExecSQL(szSQL);
	rsl.GetValue(_T("hcr_recordno"), szRecordNo);


	//Voi benh an chuyen khoa phai lay theo form_id
	CString szFormId = szForm;
	if (szForm.IsEmpty())
	{
		szSQL.Format(_T("SELECT hde_name FROM hms_doc_emr ") \
			_T(" WHERE hde_docno=%ld and hde_deptid='%s' and hde_type='BENH_AN_CHUYEN_KHOA' %s "), nDocumentNo, szDept, szWhere);
		rsl.ExecSQL(szSQL);
		if (!rsl.IsEOF())
		{
			rsl.GetValue(_T("hde_name"), szFormId);
		}
	}
	//szFilter.Format(_T(" and hde_refidx=%d  "), nHtrIdx);
	szFilter.Empty();
	bool res = pMF->GetEMRData(nDocumentNo, nTreatTime, _T("BENH_AN_CHUYEN_KHOA"), szFormId, szFilter, szSpecialInfo);
	if (!res)
	{
		szSQL.Format(_T("SELECT to_char(hde_value) as hde_value FROM hms_doc_emr ") \
			_T(" WHERE hde_docno=%ld and hde_type IN('BENH_AN_CHUYEN_KHOA') ") \
			_T(" %s ") \
			_T(" ORDER BY hde_type, hde_refidx "), nDocumentNo, szWhere);
		rsl.ExecSQL(szSQL);

		while (!rsl.IsEOF())
		{
			rsl.GetValue(_T("hde_value"), tmpStr);
			szSpecialInfo.AppendFormat(_T("%s"), tmpStr);
			rsl.MoveNext();
		}
	}

	JSONVALUE jsData;
	jsData.Parse(szSpecialInfo);
	if (!szSpecialInfo.IsEmpty())
	{
		for (int i = 0; i < jsData.Size(); i++)
		{

			std::wstring name;
			name = jsData.order[i];
			tmpStr.Empty();
			jsData[name.c_str()].GetValue(tmpStr);
			_tprintf(_T("\r\n%s: %s"), name.c_str(), tmpStr);
			CReportItem* obj = rpt.GetReportHeader()->GetItem(name.c_str());
			if (obj && obj->GetType() == REPORT_CHECKBOX)
			{
				if (tmpStr == _T("Y"))
					obj->SetCheck(true);
				else
					obj->SetCheck(false);
			}
			else
				rpt.GetReportHeader()->SetValue(name.c_str(), tmpStr);
		}
	}
	JSONVALUE jData;
	CReportSection* rptDetail = NULL, * rptFooter = NULL;

	szExamInfo.Empty();
	//szFilter.Format(_T(" and hde_refidx=%d  "), nHtrIdx);
	szFilter.Empty();

	res = pMF->GetEMRData(nDocumentNo, nTreatTime, _T("BENH_AN_KB"), szRecordNo, szFilter, szExamInfo);
	if (!res)
	{

		szSQL.Format(_T("SELECT to_char(hde_value) as hde_value FROM hms_doc_emr ") \
			_T(" WHERE hde_docno=%ld and hde_type IN('BENH_AN_KB') ") \
			_T(" %s ") \
			_T(" ORDER BY hde_type, hde_refidx "), nDocumentNo, szWhere);
		rsl.ExecSQL(szSQL);
		while (!rsl.IsEOF())
		{
			rsl.GetValue(_T("hde_value"), tmpStr);
			szExamInfo.AppendFormat(_T("%s"), tmpStr);
			rsl.MoveNext();
		}
	}


	if (!szExamInfo.IsEmpty())
	{
		rptDetail = rpt.GetGroupHeader(4);
		if (rptDetail == NULL)
			rptDetail = rpt.GetReportHeader();

		if (rptDetail)
		{
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(0));
			rptDetail->SetPageBreak();
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(4));

			jData.Clear();
			jData.Parse(szExamInfo);
			tmpStr.Empty();

			jData[_T("benh_ly_khac")].GetValue(tmpStr);
			rptDetail->SetValue(_T("benh_ly_khac"), tmpStr);

			jData[_T("xet_nghiem")].GetValue(tmpStr);
			rptDetail->SetValue(_T("xet_nghiem"), tmpStr);

		}
	}

	szExamInfo.Empty();
	//szFilter.Format(_T(" and hde_refidx=%d  "), nHtrIdx);
	szFilter.Empty();
	res = pMF->GetEMRData(nDocumentNo, nTreatTime, _T("BENH_AN_KL"), szRecordNo, szFilter, szExamInfo);
	if (!res)
	{

		szSQL.Format(_T("SELECT to_char(hde_value) as hde_value, hde_createdby FROM hms_doc_emr ") \
			_T(" WHERE hde_docno=%ld and hde_type IN('BENH_AN_KL') ") \
			_T(" %s ") \
			_T(" ORDER BY hde_type, hde_refidx "), nDocumentNo, szWhere);
		szExamInfo.Empty();
		rsl.ExecSQL(szSQL);
		while (!rsl.IsEOF())
		{
			rsl.GetValue(_T("hde_createdby"), szDoctorID);
			rsl.GetValue(_T("hde_value"), tmpStr);
			szExamInfo.AppendFormat(_T("%s"), tmpStr);
			rsl.MoveNext();
		}
	}

	if (!szExamInfo.IsEmpty())
	{
		jData.Clear();
		jData.Parse(szExamInfo);
		tmpStr.Empty();
		//gan rptDetail = rpt.GetGroupHeader(xxx);
		//Tam thoi gan = reportheader de test
		rptDetail = rpt.GetGroupHeader(0);

		if (rptDetail)
		{
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));

			jData[_T("benhan")].GetValue(tmpStr);
			rptDetail->SetValue(_T("benhan"), tmpStr);


			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(2));

			jData[_T("chan_doan_so_bo")].GetValue(tmpStr);
			rptDetail->SetValue(_T("chan_doan_so_bo"), tmpStr);
			jData[_T("chan_doan_phan_biet")].GetValue(tmpStr);
			rptDetail->SetValue(_T("chan_doan_phan_biet"), tmpStr);
			jData[_T("chan_doan_xac_dinh")].GetValue(tmpStr);
			rptDetail->SetValue(_T("chan_doan_xac_dinh"), tmpStr);


			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));

			jData[_T("ke_hoach_xet_nghiem")].GetValue(tmpStr);
			rptDetail->SetValue(_T("ke_hoach_xet_nghiem"), tmpStr);
			jData[_T("ke_hoach_dieu_tri")].GetValue(tmpStr);
			rptDetail->SetValue(_T("ke_hoach_dieu_tri"), tmpStr);
			jData[_T("tien_luong")].GetValue(tmpStr);
			rptDetail->SetValue(_T("tien_luong"), tmpStr);
		}



	}
	//giangdh them Doctor Name vao mau cuoi Benh An
	if (pMF->m_UserInfo.su_groupid == _T("A") && pMF->CheckPermission(_T("admin.TM.100.1")))
	{
		szSQL.Format(_T("SELECT hde_createdby FROM hms_doc_emr_trace ") \
			_T(" WHERE hde_docno=%ld and hde_type IN('BENH_AN_KL') and rownum<=1 ") \
			_T(" %s ") \
			_T(" ORDER BY hde_type, hde_refidx "), nDocumentNo, szWhere);
	}
	else
	{
		szSQL.Format(_T("SELECT hde_createdby FROM hms_doc_emr ") \
			_T(" WHERE hde_docno=%ld and hde_type IN('BENH_AN_KL') ") \
			_T(" %s ") \
			_T(" ORDER BY hde_type, hde_refidx "), nDocumentNo, szWhere);
	}
	rsl.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (!rsl.IsEOF())
	{
		rsl.GetValue(_T("hde_createdby"), szDoctorID);
	}
	szDSQL.Format(_T("select su_name from sys_user where su_userid = '%s'"), szDoctorID);
	rs2.ExecSQL(szDSQL);
	rptFooter = rpt.GetReportFooter();
	rptFooter->SetValue(_T("DoctorName"), rs2.GetValue(_T("su_name")));
	//_msg(_T("%s"), szSQL);

	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print();


}
void CPrintForms::PrintMedicalFileEx(CStringArray& info, bool bPreview)
{

	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CReport rpt;
	long nDocumentNo = str2long(info[0]);
	CString szDept = info[1];
	CString szHealthService = info[2];
	CString szHospitalName = info[3];

	int nCancerTime = 0;
	if (nDocumentNo <= 0)
		return;
	CString szSQL, tmpStr, szReportName, szTemp, szNumber, szFoodMode, szDate;



	/*
		szSQL.Format(_T(" SELECT    Trunc(hfo_orderdate) orderdate, ") \
					_T("           hfl_name             modename, ") \
					_T("           hfol_type type") \
					_T(" FROM      hms_feefood ") \
					_T(" LEFT JOIN hms_feefoodline ON ( hfo_orderid = hfol_orderid ) ") \
					_T(" LEFT JOIN hms_fee_list ON ( hfl_feeid = hfol_itemid ) ") \
					_T(" WHERE     hfo_docno = %ld ") \
					_T("       AND hfo_deptid = '%s'"), nDocumentNo, szDept);
		rs.ExecSQL(szSQL);
		while (!rs.IsEOF())
		{
			rs.GetValue(_T("type"), tmpStr);
			if (tmpStr == _T("T"))
			{
				rs.GetValue(_T("modename"), tmpStr);
				rs.GetValue(_T("orderdate"), szDate);
				szFoodMode.AppendFormat(_T("\x102n tr\x1B0\x61: %s %s"), CDate::Convert(szDate, yyyymmdd, ddmmyyyy).Left(5), tmpStr);
			}
			else if (tmpStr == _T("C"))
			{
				rs.GetValue(_T("modename"), tmpStr);
				rs.GetValue(_T("orderdate"), szDate);
				szFoodMode.AppendFormat(_T(" \x102n t\x1ED1i: %s %s"), CDate::Convert(szDate, yyyymmdd, ddmmyyyy).Left(5), tmpStr);
			}
			rs.MoveNext();
		}
		if (szFoodMode.IsEmpty())
			szFoodMode = _T("T\x1EF1 t\xFA\x63");
	*/
	szSQL.Format(_T(" SELECT hp_patientno as patientno, trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname, ") \
		_T("        extract(year from hp_birthdate) as yob, ") \
		_T("		case when hfe_amount > 0 and hfe_date > hd_enddate then 'Y' else 'N' end AS checkstt, ") \
		_T("        (select ss_desc from sys_sel where ss_id= 'sys_sex' and ss_code =  hp_sex) as sex, ") \
		_T("        (select ss_desc from sys_sel where ss_id ='hms_rank' and cast(ss_code as integer)=hp_rank) as rank, ") \
		_T("        (select ss_desc from sys_sel where ss_id ='hms_position' and cast(ss_code as integer)=hp_position) as position, ") \
		_T("        hp_workplace as unit, ") \
		_T("        hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) as address, ") \
		_T("        nvl(hd_dtladdr, hp_dtladdr) as dtladdress, ") \
		_T("        hd_relative as relative, ") \
		_T("        (select ss_desc from sys_sel where ss_id = 'hrm_relation' and ss_code = hd_relation) as relation, ") \
		_T("        hd_contactaddr as reladdress, ") \
		_T("        hd_contacttel as relphone, ") \
		_T("        hd_transdiagn as trdisease, ") \
		_T("        (select hi_name from hms_icd where hi_icd=hd_transicd) as icd10, ") \
		_T("        hd_conclusion as disease, ") \
		_T("        hd_suggestion as suggestion, ") \
		_T("        trunc(hd_admitdate) as examdte, ") \
		_T("		'' as admitdate,") \
		_T("        hd_indept as deptid, ") \
		_T("        '' as facname, ") \
		_T("        hcr_recordno as numinward, hcr_treattime as inwardtime, ") \
		_T("        hcr_foodmode as foodmode, ") \
		_T("        (select ho_desc from hms_object where ho_id=hd_object) as policydesc, ") \
		_T("        (select hc_cardno from hms_card where hc_patientno=hd_patientno and hc_idx=hd_cardidx) as cardno, ") \
		_T("  hcr_cancer, ") \
		_T("  hcr_cancer_time, ") \
		_T("  hd_disrate, ") \
		_T("  hd_emergency ") \
		_T(" FROM hms_patient ") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno) ") \
		_T(" LEFT JOIN hms_exam on (he_docno = hd_docno and he_hasfee = 'Y')") \
		_T(" LEFT JOIN hms_clinical_record ON (hcr_docno = hd_docno)") \
		_T(" LEFT JOIN hms_fee_deposit ON(hfe_patientno = hp_patientno AND hfe_docno = hd_docno) ") \
		_T(" WHERE hd_docno=%ld AND NVL(hd_suggestion, 'N') IN ('N') and he_status in('P','T') and rownum < 2"), nDocumentNo);
	//_msg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		ShowMessageBox(_T("Patient not found"));
		return;

	}


	CString szCancer, szRecordNo;
	rs.GetValue(_T("hcr_cancer"), szCancer);
	rs.GetValue(_T("numinward"), szRecordNo);

	if (szCancer == _T("Y"))
	{
		rs.GetValue(_T("hcr_cancer_time"), nCancerTime);
		szReportName.Format(_T("Reports\\HMS\\BENHAN\\BENHANUNGTHU.RPT"));
		if (nCancerTime > 1)
		{
			szReportName.Format(_T("Reports\\HMS\\BENHAN\\BENHANUNGTHU_TULAN2.RPT"));
		}
	}
	else
	{
		/*
				CString szDeptID, szRptName;
				rs.GetValue(_T("deptid"), szDeptID);
				szSQL.Format(_T("SELECT hafc_reportname as reportname, hafc_desc as reportdesc FROM hms_admissionfile_config WHERE hafc_deptid='%s' "), szDept);
				CRecord rsx(&pMF->m_db);
				rsx.ExecSQL(szSQL);
				if(!rsx.IsEOF()){
					if (rsx.GetRecordCount() == 1){
						rsx.GetValue(_T("reportname"), szRptName);
						if(szRptName.IsEmpty())
							szRptName = _T("BA.RPT");
						szReportName.Format(_T("Reports\\HMS\\BENHAN\\%s"), szRptName);
					}
					else{
						CARReportOptionDlg dlg(pMF);
						dlg.m_szDeptID = szDeptID;
						if (dlg.DoModal() == IDOK){
							szReportName.Format(_T("Reports\\HMS\\BENHAN\\%s"), dlg.m_szReportNameKey);
						}
						else{
							return;
						}

					}
				}
				else
					szReportName.Format(_T("Reports\\HMS\\BENHAN\\BA.RPT"));
		*/
		szReportName.Format(_T("Reports\\HMS\\BENHAN\\BENHANVAOVIEN.RPT"));
	}
	//szReportName.Format(_T("Reports\\HMS\\BENHAN\\Khoa B4.m.RPT"));
	if (!rpt.Init(szReportName))
	{
		return;
	}
	//rpt.SetMargins(200, 200, 200, 200);


	rpt.GetReportHeader()->SetValue(_T("_health_service"), szHealthService);
	rpt.GetReportHeader()->SetValue(_T("_HOSPITAL_NAME"), pMF->m_szHospitalName);
	rpt.GetReportHeader()->SetValue(_T("_faculty_name"), szDept);
	StringUpper(rs.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_name"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_y_of_birth"), rs.GetValue(_T("yob")));
	rpt.GetReportHeader()->SetValue(_T("_sex"), rs.GetValue(_T("sex")));
	if (rs.GetValue(_T("checkstt")) == _T("Y"))
	{
		rpt.GetReportHeader()->SetValue(_T("DaNopTamGui"), _T("\x110\xE3 n\x1ED9p t\x1EA1m g\x1EEDi"));
	}
	tmpStr.Format(_T("%s"), rs.GetValue(_T("dtladdress")));
	if (!tmpStr.IsEmpty())
		tmpStr.AppendFormat(_T(" - "));
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("address")));
	rpt.GetReportHeader()->SetValue(_T("_native_vill"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_unit"), rs.GetValue(_T("unit")));
	rpt.GetReportHeader()->SetValue(_T("_rank"), rs.GetValue(_T("rank")));
	rpt.GetReportHeader()->SetValue(_T("_position"), rs.GetValue(_T("position")));
	rs.GetValue(_T("examdte"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_infect_date"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	tmpStr.Format(_T("%s"), CDateTime::Convert(rs.GetValue(_T("admitdate")), yyyymmdd | hhmmss, ddmmyyyy | hhmmss));
	//rs.GetValue(_T("admitdate"), tmpStr);
	//_debug(_T("%s:%s"), rs.GetValue(_T("admitdate")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_enter_date"), tmpStr);
	szTemp = rs.GetValue(_T("suggestion"));
	tmpStr.Empty();
	//if (szTemp == _T("C"))
	//	tmpStr.Format(_T("NT- "));
	szTemp = rs.GetValue(_T("numinward"));
	if (szTemp == _T("0"))
		tmpStr.Empty();
	//else if(m_nPolicy == 7)
	//	tmpStr.AppendFormat(_T("%s- DV"), szTemp);
	else
		tmpStr += szTemp;
	rpt.GetReportHeader()->GetItem(_T("_number"))->SetFaceSize(9);

	if (szCancer == _T("Y"))
	{
		tmpStr.AppendFormat(_T(" - %.3dK"), nCancerTime);
	}

	rpt.GetReportHeader()->SetValue(_T("_number"), tmpStr);
	if (nCancerTime > 1)
	{
		tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("ReportTitle")), nCancerTime);
		rpt.GetReportHeader()->SetValue(_T("ReportTitle"), tmpStr);

	}
	rs.GetValue(_T("inwardtime"), tmpStr);
	if (tmpStr == _T("0"))
		tmpStr.Empty();
	if (szCancer == _T("Y"))
	{
		int nCancerTime = 0;
		rs.GetValue(_T("hcr_cancer_time"), nCancerTime);
		tmpStr.Format(_T("%d"), nCancerTime);
	}
	rpt.GetReportHeader()->SetValue(_T("_times"), tmpStr);

	long nPatientNo;
	rs.GetValue(_T("patientno"), nPatientNo);
	tmpStr.Format(_T("%d"), nPatientNo);
	rpt.GetReportHeader()->SetValue(_T("_patientno"), tmpStr);

	tmpStr.Format(_T("%d"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("_docno"), tmpStr);
	tmpStr.Format(_T("%s"), rs.GetValue(_T("policydesc")));
	rpt.GetReportHeader()->SetValue(_T("_policydesc"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_relatives"), rs.GetValue(_T("relative")));
	rpt.GetReportHeader()->SetValue(_T("_relation"), rs.GetValue(_T("relation")));

	rpt.GetReportHeader()->SetValue(_T("_phone"), rs.GetValue(_T("relphone")));
	rpt.GetReportHeader()->SetValue(_T("_address"), rs.GetValue(_T("reladdress")));
	rpt.GetReportHeader()->SetValue(_T("_unit_diag.1"), rs.GetValue(_T("trdisease")));

	tmpStr.Format(_T("%s\r\n%s"), rs.GetValue(_T("icd10")), rs.GetValue(_T("disease")));
	rpt.GetReportHeader()->SetValue(_T("_exam_diag.1"), tmpStr);

	CReportSection* rptDtl = rpt.GetDetail();
	rptDtl = rpt.AddDetail(rpt.GetGroupFooter(1));
	rptDtl->SetPageBreak(true);

	tmpStr.Empty();
	rs.GetValue(_T("cardno"), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		CString szCardDesc;

		szCardDesc.Format(_T("S\x1ED1 th\x1EBB: %s"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("_cardno"), szCardDesc);
	}

	tmpStr = pMF->GetSysTime();
	//	tmpStr.Format("Lµm bÖnh ¸n lóc: %s %s"), tmpStr.Left(5), pMF->getSysDte());
	//	rpt.GetReportHeader()->SetValue(_T("_printdate"), tmpStr);
	CReportItem* obj = NULL;
	obj = rpt.GetReportHeader()->GetItem(_T("_foodmode"));
	if (obj)
		obj->SetFixedHeight(false);
	rpt.GetReportHeader()->SetValue(_T("_foodmode"), szFoodMode);
	rpt.GetReportFooter()->Format(_T("PrintDate"), _T(""), _T("...."), _T("...."), _T("...."));

	rs.GetValue(_T("hd_emergency"), szTemp);
	if (szTemp == _T("Y"))
		rpt.GetReportHeader()->SetValue(_T("_emergency"), _T("X"));

	int nDisrate;
	rs.GetValue(_T("hd_disrate"), nDisrate);
	if (nDisrate > 0)
		tmpStr.Format(_T("%d%s"), nDisrate, _T("%"));
	else
		tmpStr.Empty();
	rpt.GetReportHeader()->SetValue(_T("_disrate"), tmpStr);

	//rpt.AddDetail();
	if (nCancerTime > 1)
	{
		CReportSection* rptGroup = NULL;
		rptGroup = rpt.AddDetail(rpt.GetGroupHeader(2));
		rptGroup->SetPageBreak();
		rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
	}


	CRecord rsl(&pMF->m_db);
	CString szExamInfo, szFilter;
	szExamInfo.Empty();

	szFilter.Empty();
	bool res = pMF->GetEMRData(nDocumentNo, 0, _T("BENH_AN_HB"), szRecordNo, szFilter, szExamInfo);
	if (!res)
	{

		szSQL.Format(_T("SELECT to_char(hde_value) as hde_value FROM hms_doc_emr WHERE hde_docno=%ld AND hde_type IN('BENH_AN_HB') and hde_treattime=0 ORDER BY hde_type, hde_refidx "), nDocumentNo);
		rsl.ExecSQL(szSQL);

		szExamInfo.Empty();
		while (!rsl.IsEOF())
		{
			rsl.GetValue(_T("hde_value"), tmpStr);
			szExamInfo.AppendFormat(_T("%s"), tmpStr);
			rsl.MoveNext();
		}
	}

	CReportSection* rptDetail = rpt.GetDetail(0);
	JSONVALUE jData;
	if (!szExamInfo.IsEmpty())
	{
		jData.Parse(szExamInfo);
		tmpStr.Empty();
		//gan rptDetail = rpt.GetGroupHeader(xxx);
		//Tam thoi gan = reportheader de test
		rptDetail = rpt.GetGroupHeader(1);
		if (rptDetail)
		{

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));

			jData[_T("vaoluc")].GetValue(tmpStr);
			szTemp.Format(rptDetail->GetValue(_T("vaoluc")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
			rptDetail->SetValue(_T("vaoluc"), szTemp);
			long vao_ngay_thu;
			jData[_T("vaongay")].GetValue(vao_ngay_thu);
			tmpStr.Format(_T("%ld"), vao_ngay_thu);
			rptDetail->SetValue(_T("vaongay"), tmpStr);
			jData[_T("ly_do_vao_vien")].GetValue(tmpStr);

			rptDetail->SetValue(_T("ly_do_vao_vien"), tmpStr);
			jData[_T("benhsu")].GetValue(tmpStr);
			rptDetail->SetValue(_T("benhsu"), tmpStr);

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(2));

			jData[_T("tien_su_ban_than")].GetValue(tmpStr);
			rptDetail->SetValue(_T("tien_su_ban_than"), tmpStr);

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));

			jData[_T("tien_su_gia_dinh")].GetValue(tmpStr);
			rptDetail->SetValue(_T("tien_su_gia_dinh"), tmpStr);
		}

	}

	szFilter.Empty();
	szExamInfo.Empty();
	res = pMF->GetEMRData(nDocumentNo, 0, _T("BENH_AN_KB"), szRecordNo, szFilter, szExamInfo);
	if (!res)
	{
		szSQL.Format(_T("SELECT to_char(hde_value) as hde_value FROM hms_doc_emr WHERE hde_docno=%ld and hde_type IN('BENH_AN_KB') and hde_treattime=0 ORDER BY hde_type, hde_refidx "), nDocumentNo);
		rsl.ExecSQL(szSQL);
		szExamInfo.Empty();
		while (!rsl.IsEOF())
		{
			rsl.GetValue(_T("hde_value"), tmpStr);
			szExamInfo.AppendFormat(_T("%s"), tmpStr);
			rsl.MoveNext();
		}

	}
	if (!szExamInfo.IsEmpty())
	{
		rptDetail = rpt.GetGroupHeader(4);
		if (rptDetail)
		{
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(4));
			jData.Clear();
			jData.Parse(szExamInfo);
			tmpStr.Empty();

			jData[_T("toan_than")].GetValue(tmpStr);
			rptDetail->SetValue(_T("toan_than"), tmpStr);
			int n = 0;
			jData[_T("mach")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);
			rptDetail->SetValue(_T("mach"), tmpStr);

			float nd = 0;
			jData[_T("nhiet_do")].GetValue(nd);
			tmpStr.Empty();
			if (nd > 0)
				tmpStr.Format(_T("%.2f"), nd);
			rptDetail->SetValue(_T("nhiet_do"), tmpStr);

			n = 0;
			jData[_T("huyet_ap")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);

			rptDetail->SetValue(_T("huyet_ap"), tmpStr);

			n = 0;
			jData[_T("huyet_ap2")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);

			rptDetail->SetValue(_T("huyet_ap2"), tmpStr);

			n = 0;
			jData[_T("nhip_tho")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);
			rptDetail->SetValue(_T("nhip_tho"), tmpStr);

			n = 0;
			jData[_T("chieu_cao")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);
			rptDetail->SetValue(_T("chieu_cao"), tmpStr);

			n = 0;
			jData[_T("can_nang")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);
			rptDetail->SetValue(_T("can_nang"), tmpStr);

			jData[_T("dinh_duong")].GetValue(tmpStr);
			rptDetail->SetValue(_T("dinhduong"), tmpStr);

			jData[_T("dien_tich_da")].GetValue(tmpStr);
			rptDetail->SetValue(_T("dientichda"), tmpStr);

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(5));

			jData[_T("tuan_hoan")].GetValue(tmpStr);
			rptDetail->SetValue(_T("tuan_hoan"), tmpStr);

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(6));

			jData[_T("ho_hap")].GetValue(tmpStr);
			rptDetail->SetValue(_T("ho_hap"), tmpStr);

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(7));

			jData[_T("tieu_hoa")].GetValue(tmpStr);
			rptDetail->SetValue(_T("tieu_hoa"), tmpStr);

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(8));

			jData[_T("tiet_nieu")].GetValue(tmpStr);
			rptDetail->SetValue(_T("tiet_nieu"), tmpStr);

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(9));

			jData[_T("than_kinh")].GetValue(tmpStr);
			rptDetail->SetValue(_T("than_kinh"), tmpStr);

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(10));

			jData[_T("co_xuong_khop")].GetValue(tmpStr);
			rptDetail->SetValue(_T("co_xuong_khop"), tmpStr);

			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(11));

			jData[_T("chuyen_khoa_khac")].GetValue(tmpStr);
			rptDetail->SetValue(_T("chuyen_khoa_khac"), tmpStr);
		}
	}

	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print();

	// 	if(szCancer != _T("Y"))
	// 	{
	// 		PrintMedicalFile_Page2(nDocumentNo, szDept, bPreview);
	// 	}
}

void CPrintForms::InGiayBaoTu(long nDocumentNo) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CRecord rs(&pMF->m_db);
	CString szSQL;
	if (!rpt.Init(_T("Reports\\HMS\\TM_GIAYBAOTU_TO1.RPT")))
	{
		return;
	}
	if (pMF->GetModuleID() == _T("TM"))
	{
		szSQL.Format(_T("SELECT    hcr_docno so_ho_so, Get_departmentname(hcr_dischargedept) khoa, ") \
			_T(" hcr_recordno so, UPPER(Get_patientname(hcr_docno)) AS ho_ten, To_char(hp_birthdate, 'dd/mm/yyyy') nam_sinh,") \
			_T("          Get_syssel_desc('sys_sex', hp_sex) gioi_tinh, Get_syssel_desc('hms_rank', hp_rank) quan_ham, ") \
			_T(" hp_workplace don_vi, hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) dia_chi,") \
			_T("    (select to_char(min(htr_admitdate), 'dd/mm/yyyy') ") \
			_T("	from hms_treatment_record ") \
			_T("	where htr_docno = hcr_docno and htr_treattime = hcr_treattime) ngay_vao, ") \
			_T("	To_char(hcr_dischargedate, 'dd/mm/yyyy hh24:mi') ngay_ra, ") \
			_T("	hcr_admitdisease as chan_doan_vao, htr_maindisease  AS chan_doan_khoa, hcr_maindisease as chan_doan_tu_vong,") \
			_T("          hcr_gmethod pp_dt, hpd_diereason nn_tu_vong, hcr_gsuggestion2 ykdn, ") \
			_T("	extract(year from hp_birthdate) nam_sinh_2, hpd_dtladdr dia_chi_chi_tiet, get_syssel_desc('sys_ethnic', hp_ethnic) as dan_toc ") \
			_T(" FROM      hms_clinical_record left join HMS_TREATMENT_RECORD ON (hcr_docno=htr_docno AND hcr_refidx=htr_idx)") \
			_T(" left join hms_patient ON ( hcr_patientno = hp_patientno )") \
			_T(" LEFT JOIN hms_doc ON (hcr_patientno=hd_patientno AND hcr_docno=hd_docno)") \
			_T(" left join hms_patientdeath on (hpd_patientno = hcr_patientno)") \
			_T("WHERE     hcr_docno = %ld"), nDocumentNo);
	}
	else
	{
		szSQL.Format(_T("SELECT    hd_docno so_ho_so, Get_departmentname(hd_enddept) khoa, hd_recordno so, ") \
			_T(" UPPER(Get_patientname(hd_docno)) AS ho_ten, To_char(hp_birthdate, 'dd/mm/yyyy') nam_sinh,") \
			_T("          Get_syssel_desc('sys_sex', hp_sex) gioi_tinh, Get_syssel_desc('hms_rank', hp_rank) quan_ham, hp_workplace don_vi, hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) dia_chi,") \
			_T("          To_char(hd_admitdate, 'dd/mm/yyyy') ngay_vao, To_char(hd_enddate, 'dd/mm/yyyy hh24:mi') ngay_ra, hd_conclusion chan_doan_vao, hd_conclusion as chan_doan_tu_vong,") \
			_T("          '' pp_dt, hpd_diereason nn_tu_vong, '' ykdn, extract(year from hp_birthdate) nam_sinh_2, hpd_dtladdr dia_chi_chi_tiet, get_syssel_desc('sys_ethnic', hp_ethnic) as dan_toc") \
			_T(" FROM      hms_doc") \
			_T(" left join hms_patient ON ( hd_patientno = hp_patientno )") \
			_T(" left join hms_patientdeath on (hpd_patientno = hd_patientno)") \
			_T("WHERE     hd_docno = %ld"), nDocumentNo);
	}
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF()) {
		AfxMessageBox(_T("No Data!"));
		return;
	}
	for (int i = 0; i < rs.GetFieldCount(); i++)
		rpt.GetReportHeader()->SetValue(rs.GetFieldName(i), rs.GetValue(rs.GetFieldName(i)));
	rpt.PrintPreview();
	if (!rpt.Init(_T("Reports\\HMS\\TM_GIAYBAOTU_TO2.RPT"))) return;
	for (int i = 0; i < rs.GetFieldCount(); i++)
		rpt.GetReportHeader()->SetValue(rs.GetFieldName(i), rs.GetValue(rs.GetFieldName(i)));
	rpt.PrintPreview();
}

static long _patientNo = 0;
static void _OnAfterPrintCardInfoFnc(CWnd* pMain)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CString szSQL;
	szSQL.Format(_T("UPDATE hms_smartcard SET hsc_printed='Y' WHERE hsc_patientno=%ld"), _patientNo);
	pMF->ExecSQL(szSQL);
}

void CPrintForms::RM_PrintCardInfo(long nPatientNo) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	static CReport rpt;
	CReport rpt2;
	CString szSQL, tmpStr, szWhere, tmpStr2;
	CString szCardId;
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db);

	_patientNo = nPatientNo;

	szSQL.Format(_T("SELECT count(*) FROM hms_smartcard") \
		_T(" WHERE hsc_patientno=%ld and hsc_active='Y' and hsc_printed='Y' "), nPatientNo);
	rs.ExecSQL(szSQL);
	if (rs.GetIntValue() > 0)
	{
		ShowMessageBox(_T("Bệnh nhân đã được in thẻ. Không cho phép in lại"));
		return;
	}

	//if (!rpt.Init(_T("Reports/HMS/HR_SMARTCARD.RPT")))
	if (!rpt.Init(_T("Reports/HMS/HR_SMARTCARD2.RPT")))
	{
		return;
	}

	szSQL.Format(_T(" SELECT ") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	date_part('year', hp_birthdate) as yob, hsc_cardid as cardid ") \
		_T(" FROM hms_patient, hms_smartcard") \
		_T(" WHERE hp_patientno=%ld and hp_patientno = hsc_patientno"), nPatientNo);

	//	_msg(_T("%s"), szSQL);
	int ret = rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		ShowMessageBox(_T("Không tìm thấy thông tin bệnh nhân"));
		return;
	}


	//Report Header
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_CompanyInfo.sc_name);
	tmpStr.Format(_T("%ld"), nPatientNo);
	rpt.GetReportHeader()->SetValue(_T("PatientNo"), tmpStr);
	StringUpper(rs.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("yearofbirth"), rs.GetValue(_T("yob")));
	rpt.GetReportHeader()->SetValue(_T("cardid"), rs.GetValue(_T("cardid")));
	HBITMAP hbm = GetPatientImage(nPatientNo);
	if (hbm != NULL)
	{
		CReportItem* rI = rpt.GetReportHeader()->GetItem(L"Image");
		if (rI)
		{
			rI->SetHBITMAP(hbm);
		}
		else
		{
			printf("\nNull rI\n");
		}
	}
	else
	{
		printf("\nNull hbm\n");
	}
	tmpStr.Format(_T("%s"), CDate::Convert(pMF->GetSysDate(), yyyymmdd, ddmmyyyy).Left(5));
	printf("\nDate: %s\n", tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ReleaseDate"), tmpStr);
	rpt.SetPrintCallback(_OnAfterPrintCardInfoFnc);
	rpt.PrintPreview();

}


void CPrintForms::EM_OnPrintDetailOperation(long nDocNo)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString szSQL, tmpStr;
	CRecord rs(&pMF->m_db);
	CString szDate, szSysDate, szAdmit, szPerformDate, szDiagnostic;
	szSysDate = pMF->GetSysDateTime();

	szSQL.Format(_T(" SELECT hd_docno AS docno,") \
		_T("   UPPER(trim(hp_surname") \
		_T("   ||' '") \
		_T("   ||hp_midname") \
		_T("   ||' '") \
		_T("   ||hp_firstname))                                   AS PatientName,") \
		_T("   trunc_date(hp_birthdate)                           AS birthdate,") \
		_T("   hms_getage(trunc_date(hd_admitdate), hp_birthdate) AS Age,") \
		_T("   hp_sex                                             AS sexid,") \
		_T("   sys_sel_getname('sys_sex', hp_sex)                 AS Sex,") \
		_T("   hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid))    AS address,") \
		_T("   hd_cardno                                          AS cardno,") \
		_T("   hd_cardidx                                         AS cardidx,") \
		_T("   hc_expdate                                         AS expdate,") \
		_T("   hd_admitdate                                       AS admitdate,") \
		_T("   (SELECT he_diagnostic") \
		_T("   FROM hms_exam") \
		_T("   WHERE he_docno = hd_docno") \
		_T("   AND he_deptid  = 'C1.1'") \
		_T("   AND he_roomid  = 52") \
		_T("   AND rownum     = 1") \
		_T("   )                         AS Diagnostic,") \
		_T("   Get_objectname(hd_object) AS objname,") \
		_T("   (SELECT LISTAGG(CAST(hfl_name AS VARCHAR2(1024)), ', ') WITHIN GROUP (") \
		_T("   ORDER BY ho_idx)") \
		_T("   FROM hms_operation") \
		_T("   LEFT JOIN hms_fee_list") \
		_T("   ON(ho_itemid   = hfl_feeid)") \
		_T("   WHERE ho_docno = hd_docno") \
		_T("   AND (ho_deptid = 'B10'") \
		_T("   OR (ho_deptid  = 'C1.1'") \
		_T("   AND ho_roomid  = 52))") \
		_T("   ) AS operationname") \
		_T(" FROM hms_doc") \
		_T(" RIGHT JOIN hms_patient") \
		_T(" ON(hp_patientno=hd_patientno)") \
		_T(" LEFT JOIN hms_card") \
		_T(" ON (hd_patientno=hc_patientno") \
		_T(" AND hd_cardno   = hc_cardno") \
		_T(" AND hd_cardidx  =hc_idx)") \
		_T(" WHERE hd_docno  =%ld"), nDocNo);
	_fmsg(_T("%s"), szSQL);
	int ret = rs.ExecSQL(szSQL);

	if (rs.IsEOF())
	{
		ShowMessageBox(_T("Patient not found."));
		return;
	}

	if (!rpt.Init(_T("Reports/HMS/HMS_DETAILOPERATIONB10.RPT")))
		return;
	//Report Header

	//StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HEALTH_SERVICE"), pMF->m_CompanyInfo.sc_pname);
	//StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HOSPITAL_NAME"), pMF->m_CompanyInfo.sc_name);
	rs.GetValue(_T("docno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("docno"), tmpStr);

	rs.GetValue(_T("PatientName"), tmpStr); //benh nhan
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), tmpStr);
	rs.GetValue(_T("Age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	rs.GetValue(_T("Sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);

	rs.GetValue(_T("CardNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	// 	rs.GetValue(_T("InMethod"),tmpStr);// pp vo cam
	// 	rpt.GetReportHeader()->SetValue(_T("InMethod"), tmpStr);
	rs.GetValue(_T("ExpDate"), tmpStr);// ngay het han
	rpt.GetReportHeader()->SetValue(_T("ExpDate"), CDate::Convert(rs.GetValue(_T("ExpDate")), yyyymmdd, ddmmyyyy));
	// 	rs.GetValue(_T("Practitioner"),tmpStr);// bac sy phau thuat
	// 	rpt.GetReportHeader()->SetValue(_T("Practitioner"), pMF->GetDoctorName(tmpStr));
	// 	rs.GetValue(_T("Assistant"),tmpStr);// thu thuat vien
	// 	rpt.GetReportHeader()->SetValue(_T("Assistant"), pMF->GetDoctorName(tmpStr));
	// 	rs.GetValue(_T("Anesthetist"),tmpStr);//bac sy gay me
	// 	rpt.GetReportHeader()->SetValue(_T("Anesthetist"), pMF->GetDoctorName(tmpStr));
	rs.GetValue(_T("address"), tmpStr);//dia chi
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);
	// 	rs.GetValue(_T("Department"),tmpStr);//khoa
	// 	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
	// 	rs.GetValue(_T("roomid"),tmpStr);// ten phong
	// 	rpt.GetReportHeader()->SetValue(_T("Room"), tmpStr);
	// 	rs.GetValue(_T("bedid"),tmpStr);//giuong
	// 	rpt.GetReportHeader()->SetValue(_T("Bed"), tmpStr);
	rs.GetValue(_T("objname"), tmpStr);//doituong
	rpt.GetReportHeader()->SetValue(_T("object"), tmpStr);

	tmpStr = rpt.GetReportHeader()->GetValue(_T("AdmitDate"));
	rs.GetValue(_T("AdmitDate"), szAdmit);// vao khoa luc			
	szAdmit.Format(tmpStr, szAdmit.Mid(11, 2), szAdmit.Mid(14, 2), CDate::Convert(szAdmit.Left(10), yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("AdmitDate"), szAdmit);//

	// 	tmpStr=rpt.GetReportHeader()->GetValue(_T("PerformDate"));
	// 	rs.GetValue(_T("PerformDate"),szPerformDate);// thuc hien luc		
	// 	szDate.Format(tmpStr,szPerformDate.Mid(11,2),szPerformDate.Mid(14,2),CDate::Convert(szPerformDate.Left(10), yyyymmdd, ddmmyyyy));
	// 	rpt.GetReportHeader()->SetValue(_T("PerformDate"), szDate);//
	rs.GetValue(_T("Diagnostic"), tmpStr);// chan doan
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	// 	rs.GetValue(_T("BeforeOpera"),tmpStr);// truoc phau thuat thu thuat
	// 	rpt.GetReportHeader()->SetValue(_T("BeforeOpera"), tmpStr);
	// 	rs.GetValue(_T("AfterOpera"),tmpStr);// sau phau thuat thu thuat
	// 	rpt.GetReportHeader()->SetValue(_T("AfterOpera"), tmpStr);
	rs.GetValue(_T("operationname"), tmpStr);// phuong phap phau thuat thu thuat
	rpt.GetReportHeader()->SetValue(_T("OperationName"), tmpStr);
	// 	rs.GetValue(_T("operationtype"),tmpStr);// loai phau thuat thu thuat
	// 	rpt.GetReportHeader()->SetValue(_T("OperationType"), tmpStr);		

		//Page Header
		//Report Detail 

	if (pMF->GetCurrentRoomID() == 52)
	{
		szSQL.Format(_T(" SELECT he_examdate AS examdate, he_medical AS medical, get_username(he_doctor) AS doctor") \
			_T("  FROM hms_exam WHERE he_deptid = 'C1.1' AND he_roomid = 52") \
			_T("  AND he_docno = %ld"), nDocNo);
	}
	else if (pMF->GetCurrentDepartmentID() == _T("B10"))
	{
		szSQL.Format(_T(" SELECT hsie_date AS examdate, hsie_desc AS medical, get_username(hsie_doctor) AS doctor") \
			_T("  FROM hms_siexam WHERE hsie_deptid = 'B10'") \
			_T("  AND hsie_docno = %ld"), nDocNo);
	}

	rs.ExecSQL(szSQL);

	CReportSection* rptDetail;

	rs.GetValue(_T("examdate"), szPerformDate);// ngay kham
	rpt.GetReportFooter()->SetValue(_T("ExamDate"), CDate::Convert(szPerformDate, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("medical"), tmpStr);// cac buoc dieu tri
	rpt.GetReportFooter()->SetValue(_T("Treatment"), tmpStr);

	//Page Footer
	//Report Footer

	rs.GetValue(_T("doctor"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Assistant"), tmpStr);
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szPerformDate.Mid(11, 5), szPerformDate.Mid(8, 2), szPerformDate.Mid(5, 2), szPerformDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	rpt.PrintPreview();

}

void CPrintForms::PrintServicePackage(long nDocumentNo, long nOrderId, bool bPrintCamket, long nBatchId, long nInvoiceNo, CString szPrintBarCode)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	//UpdateData(true);
	//UpdateData(TRUE);

	static CReport rpt;
	CReport rpt2;
	CString szSQL, tmpStr, szWhere;
	CString szCardId;
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	CRecord rsl2(&pMF->m_db);

	if (pMF->GetModuleID() == _T("VPM") && szPrintBarCode == _T("Y"))
	{
		if (!rpt.Init(_T("Reports/HMS/PHIEUDANGKYVACAMKETDICHVUVPM.RPT"), false, false, 1))
		{
			return;
		}
	}

	else
	{

		if (!rpt.Init(_T("Reports/HMS/PHIEUDANGKYVACAMKETDICHVU.RPT"), false, false, 1))
		{
			return;
		}
	}
	if (pMF->GetModuleID() != _T("VPM"))
	{
		szSQL.Format(_T(" SELECT hp_surname") \
			_T("   ||' '") \
			_T("   ||hp_midname") \
			_T("   ||' '") \
			_T("   ||hp_firstname                                  AS pname,") \
			_T("   TO_CHAR(hp_birthdate, 'YYYY')                   AS yob,") \
			_T("   hms_getsex(hp_sex)                              AS sex,") \
			_T("   hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS address,") \
			_T("   tbl.*,") \
			_T("   hd_telephone as phone,") \
			_T("   hr_name as relative,") \
			_T("   hr_phone as relphone,") \
			_T("   hr_reference as reference") \
			_T(" FROM") \
			_T("   (SELECT hfe_patientno AS patientno,") \
			_T("     hfe_docno           AS docno,") \
			_T("     hfe_fee_extra_id    AS idx,") \
			_T(" hfe_deptid as deptid, ") \
			_T("     hfe_status          AS status,") \
			_T("     hfe_relative_id     AS relative_id,") \
			_T("     hfe_smartcard_id    AS smartcard_id,") \
			_T("     hfe_cardnumber      AS cardnumber,") \
			_T("     to_char(hfe_orderdate,'HH24:MI DD/MM/YYYY') AS begindate,") \
			_T("     to_char(hfe_enddate , 'HH24:MI DD/MM/YYYY') AS enddate,") \
			_T("     hfel_quantity       AS quantity,") \
			_T("     hfel_unitprice       AS unitprice,") \
			_T("     hfl_name            AS pkgname,") \
			_T("     hfel_itemid         AS itemid,") \
			_T("     hfel_cost           AS amount") \
			_T("   FROM hms_fee_extra,") \
			_T("     hms_fee_extraline,") \
			_T("     hms_fee_list") \
			_T("   WHERE") \
			_T("   hfe_docno=%ld and   hfe_batch_id=%ld and HFE_TREATTIME=%d") \
			_T("   AND  hfel_docno         = hfe_docno") \
			_T("   AND hfe_fee_extra_id = hfel_fee_extra_id") \
			_T("   AND hfel_itemid      = hfl_feeid") \
			_T("   ) tbl") \
			_T(" LEFT JOIN hms_relative") \
			_T(" ON(hr_relative_id = relative_id)") \
			_T(" LEFT JOIN hms_patient ON(hp_patientno = patientno)") \
			_T(" LEFT JOIN hms_doc") \
			_T(" ON(hd_patientno = patientno and hd_docno=HR_DOCNO) "), nDocumentNo, nOrderId, pMF->m_nTreatTime);
	}
	else
		szSQL.Format(_T(" SELECT hp_surname") \
			_T("   ||' '") \
			_T("   ||hp_midname") \
			_T("   ||' '") \
			_T("   ||hp_firstname                                  AS pname,") \
			_T("   TO_CHAR(hp_birthdate, 'YYYY')                   AS yob,") \
			_T("   hms_getsex(hp_sex)                              AS sex,") \
			_T("   hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) AS address,") \
			_T("   tbl.*,") \
			_T("   hd_telephone as phone,") \
			_T("   hr_name as relative,") \
			_T("   hr_phone as relphone,") \
			_T("   hr_reference as reference") \
			_T(" FROM") \
			_T("   (SELECT hfe_patientno AS patientno,") \
			_T("     hfe_docno           AS docno,") \
			_T("     hfe_fee_extra_id    AS idx,") \
			_T(" hfe_deptid as deptid, ") \
			_T("     hfe_status          AS status,") \
			_T("     hfe_relative_id     AS relative_id,") \
			_T("     hfe_smartcard_id    AS smartcard_id,") \
			_T("     hfe_cardnumber      AS cardnumber,") \
			_T("     to_char(hfe_orderdate,'HH24:MI DD/MM/YYYY') AS begindate,") \
			_T("     to_char(hfe_enddate , 'HH24:MI DD/MM/YYYY') AS enddate,") \
			_T("     hfel_quantity       AS quantity,") \
			_T("     hfel_unitprice       AS unitprice,") \
			_T("     hfl_name            AS pkgname,") \
			_T("     hfel_itemid         AS itemid,") \
			_T("     hfel_cost           AS amount") \
			_T("   FROM hms_fee_extra,") \
			_T("     hms_fee_extraline,") \
			_T("     hms_fee_list") \
			_T("   WHERE") \
			_T("   hfe_docno=%ld and   hfe_batch_id=%ld ") \
			_T("   AND  hfel_docno         = hfe_docno") \
			_T("   AND hfe_fee_extra_id = hfel_fee_extra_id") \
			_T("   AND hfel_itemid      = hfl_feeid") \
			_T("   ) tbl") \
			_T(" LEFT JOIN hms_relative") \
			_T(" ON(hr_relative_id = relative_id)") \
			_T(" LEFT JOIN hms_patient ON(hp_patientno = patientno)") \
			_T(" LEFT JOIN hms_doc") \
			_T(" ON(hd_patientno = patientno and hd_docno=HR_DOCNO) "), nDocumentNo, nOrderId);
	int ret = rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	if (rs.IsEOF())
	{
		ShowMessageBox(_T("Không tìm thấy thông tin bệnh nhân"));
		return;
	}

	//Report Header
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_CompanyInfo.sc_name);

	rs.GetValue(_T("deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

	rs.GetValue(_T("docno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);

	tmpStr.Format(_T("%ld"), nOrderId);
	rpt.GetReportHeader()->SetValue(_T("OrderId"), tmpStr);

	tmpStr.Format(_T("%ld"), pMF->GetTreatTime());
    rpt.GetReportHeader()->SetValue(_T("TreatTime"), tmpStr);

	CString szRelative;
	rs.GetValue(_T("relative"), szRelative);
	if (szRelative.IsEmpty())
		rs.GetValue(_T("pname"), tmpStr);
	else
		tmpStr = szRelative;
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);

	rs.GetValue(_T("yob"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Yob"), tmpStr);

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("sex"), tmpStr);


	rs.GetValue(_T("begindate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("begindate"), tmpStr);
	rs.GetValue(_T("enddate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("enddate"), tmpStr);

	rs.GetValue(_T("relative"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Relative"), tmpStr);

	rs.GetValue(_T("Address"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);

	CString szPhone;
	rs.GetValue(_T("relphone"), szPhone);
	if (szPhone.IsEmpty())
		rs.GetValue(_T("phone"), tmpStr);
	else
		tmpStr = szPhone;

	rpt.GetReportHeader()->SetValue(_T("Phone"), tmpStr);

	rs.GetValue(_T("reference"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Reference"), tmpStr);


	rs.GetValue(_T("Description"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Description"), tmpStr);
	//In ra qrcode ở đây	
	szSQL.Format(_T(" SELECT hfb_qrcode") \
		_T(" FROM hms_fee_invoice_mb ") \
		_T(" LEFT JOIN hms_fee_invoice") \
		_T(" ON (hfe_docno =hfb_docno and hfe_invoiceno = hfb_invoiceno)") \
		_T(" WHERE hfb_docno        = %ld") \
		_T(" AND hfe_invoiceno     = %ld") \
		_T(" AND LENGTH(hfb_qrcode) > 10 "), pMF->m_nDocumentNo, nInvoiceNo);

	CString szQRCode;

	rsl2.ExecSQL(szSQL);

	if (!rsl2.IsEOF())
	{
		rsl2.GetValue(_T("hfb_qrcode"), szQRCode);
	}

	if (szQRCode.IsEmpty())
		szQRCode = _T("err: 99");
	rpt.GetReportHeader()->SetValue(_T("Barcodemb"), szQRCode);
	rpt.GetReportFooter()->SetValue(_T("Barcode"), szQRCode);
	double nTtlAmount = 0;
	CReportSection* pDetail = NULL;

	int nIndex = 0;
	CString szBeginDate, szEndDate;
	while (!rs.IsEOF())
	{
		tmpStr.Format(_T("%d"), ++nIndex);
		pDetail = rpt.AddDetail();
		pDetail->SetValue(_T("1"), tmpStr);

		rs.GetValue(_T("pkgname"), tmpStr);
		pDetail->SetValue(_T("2"), tmpStr);
		pDetail->SetValue(_T("3"), _T(""));
		rs.GetValue(_T("begindate"), szBeginDate);
		rs.GetValue(_T("enddate"), szEndDate);
		tmpStr.Format(_T("%s - %s"),
			szBeginDate, szEndDate);
		pDetail->SetValue(_T("4"), tmpStr);

		rs.GetValue(_T("quantity"), tmpStr);
		pDetail->SetValue(_T("5"), tmpStr);
		rs.GetValue(_T("unitprice"), tmpStr);
		pDetail->SetValue(_T("6"), tmpStr);
		rs.GetValue(_T("Amount"), tmpStr);
		pDetail->SetValue(_T("7"), tmpStr);

		nTtlAmount += str2float(tmpStr);
		rs.MoveNext();
	}

	CString szSumInWord;
	tmpStr.Format(_T("%f"), nTtlAmount);
	MoneyToString(tmpStr, szSumInWord);
	szSumInWord.AppendFormat(_T(" đồng."));
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), nTtlAmount);
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), szSumInWord);

	rs.GetValue(_T("CreatedBy"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CreatedBy"), tmpStr);

	CString szSysDate = pMF->GetSysDate();
	tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.PrintPreview();
	return;

	if (!bPrintCamket)
		return;

	if (!rpt2.Init(_T("Reports/HMS/PHIEUCAMKETDICHVU.RPT")))
	{
		return;
	}

	rs.MoveFirst();
	//Report Header
	rpt2.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_CompanyInfo.sc_name);

	rs.GetValue(_T("deptid"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("Department"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("Department2"), tmpStr);

	rs.GetValue(_T("docno"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);

	tmpStr.Format(_T("%ld"), nOrderId);
	rpt2.GetReportHeader()->SetValue(_T("OrderId"), tmpStr);

	CString szRelative1;
	rs.GetValue(_T("relative"), szRelative1);
	if (szRelative1.IsEmpty())
		rs.GetValue(_T("pname"), tmpStr);
	else
		tmpStr = szRelative1;

	rpt2.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);

	rs.GetValue(_T("yob"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("Yob"), tmpStr);

	rs.GetValue(_T("sex"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("sex"), tmpStr);


	rs.GetValue(_T("begindate"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("begindate"), tmpStr);
	rs.GetValue(_T("enddate"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("enddate"), tmpStr);

	rs.GetValue(_T("Address"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("Address"), tmpStr);

	rs.GetValue(_T("phone"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("Phone"), tmpStr);

	rs.GetValue(_T("reference"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("Reference"), tmpStr);

	rs.GetValue(_T("Description"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("Description"), tmpStr);

	rs.GetValue(_T("pkgname"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("PackageName"), tmpStr);
	rs.GetValue(_T("quantity"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("Quantity"), tmpStr);
	rs.GetValue(_T("Amount"), tmpStr);
	rpt2.GetReportHeader()->SetValue(_T("Amount"), tmpStr);


	szSysDate = pMF->GetSysDate();
	tmpStr.Format(rpt2.GetReportHeader()->GetValue(_T("PrintDate")), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt2.GetReportHeader()->SetValue(_T("PrintDate"), tmpStr);
	rpt2.PrintPreview();
}
void CPrintForms::PrintHealthVote(long nDocumentNo, bool bPreview, bool bDirect) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szGroupID, szSex, szStatus;
	CString szReportName, szOrderName;
	CString szSQL;
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db), rsd(&pMF->m_db);
	int nNumberOrder = 0;
	CString tmpStr2, szDeptType;
	CString szFormID;


	szSQL.Format(_T(" select get_patientname(hee_docno) as pname,") \
		_T("       hwp_name as WorkPlace,") \
		_T("       get_objectname(hd_object) as ObjectName,") \
		_T("       hee_docno as docno,") \
		_T("       hdh_owner as tien_su,") \
		_T("       hdh_drugallergy as di_ung,") \
		_T("       hdh_family as ts_giadinh,") \
		_T("       TO_CHAR(hd_admitdate, 'DD/MM/YYYY') as examdate,") \
		_T("		hd_admitdept as deptid, hee_dept, hee_position_desc ") \
		_T(" from hms_exm_employee") \
		_T(" LEFT JOIN hms_doc ON (hd_docno = hee_docno)") \
		_T(" LEFT JOIN hms_disease_hist ON (hdh_patientno= hd_patientno)") \
		_T(" LEFT JOIN hms_workplace ON (hwp_idx= hee_company_id)") \
		_T(" where hee_docno=%ld"), nDocumentNo);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		return;
	}


	if (!rpt.Init(_T("REPORTS/HMS/TYC_KHAMSUCKHOE_DINHKY.RPT")))
	{
		return;
	}

	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);

	CString szDeptID;

	rs.GetValue(_T("deptid"), szDeptID);
	rpt.GetReportHeader()->SetValue(_T("Department"), pMF->GetDepartmentName(szDeptID));

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);


	rs.GetValue(_T("pname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);
	rs.GetValue(_T("pname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName1"), tmpStr);
	//Chi In ra nam sinh.
	rs.GetValue(_T("yob"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("examdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("examdate"), tmpStr);



	rs.GetValue(_T("WorkPlace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("WorkPlace"), tmpStr);

	rs.GetValue(_T("hee_dept"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PhongBan"), tmpStr);
	rs.GetValue(_T("hee_position_desc"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ChucVu"), tmpStr);

	rs.GetValue(_T("ObjectName"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ObjectName"), tmpStr);


	rs.GetValue(_T("tien_su"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("tien_su"), tmpStr);

	rs.GetValue(_T("di_ung"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("di_ung"), tmpStr);

	rs.GetValue(_T("ts_giadinh"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ts_giadinh"), tmpStr);

	CString szRoomName;
	szRoomName.Empty();
	szSQL.Format(_T("select hrl_name as roomname ") \
		_T("	from hms_exam  ") \
		_T("	left join hms_roomlist ON (hrl_deptid= he_deptid and hrl_id = he_roomid) ") \
		_T("	where he_docno=%ld  ") \
		_T("	order by he_receptidx "), nDocumentNo);

	rsd.ExecSQL(szSQL);
	while (!rsd.IsEOF())
	{
		rsd.GetValue(_T("hrl_name"), tmpStr);
		if (!szRoomName.IsEmpty())
			szRoomName.AppendFormat(_T("\r\n"));
		szRoomName.AppendFormat(_T("%s"), tmpStr);
		rsd.MoveNext();

	}

	rpt.GetReportHeader()->SetValue(_T("EX_PACKAGE"), szRoomName);





	CString szDate;
	rs.GetValue(_T("orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PrintDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	rs.GetValue(_T("doctorname"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);

	rs.GetValue(_T("hpc_class"), tmpStr);
	if (tmpStr == _T("E"))
	{
		rs.GetValue(_T("hd_diagnostic"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	}


	szSQL.Format(_T(" SELECT ss_desc as pkg_exam") \
		_T(" FROM hms_exm_contract,") \
		_T("   sys_sel,") \
		_T("   hms_exm_employee") \
		_T(" WHERE ss_id        ='HMS_EXM_CONTRACT_TYPE'") \
		_T(" AND ss_code        =hec_type") \
		_T(" AND hec_contract_id = hee_contract_id") \
		_T(" and hee_docno = %ld"), nDocumentNo);
	CRecord rsx(&pMF->m_db);
	rsx.ExecSQL(szSQL);
	if (!rsx.IsEOF())
	{
		rsx.GetValue(_T("pkg_exam"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("PKG_EXAM"), tmpStr);
	}




	szSQL.Format(_T("SELECT hfl_name,hfl_groupid, hfg_name from (   ") \
		_T("	select hpcl_itemid,hpcl_orderid   ") \
		_T("	from hms_testorderline  ") \
		_T("	where hpcl_docno=%ld and hpcl_hasfee='Y' ") \
		_T("	UNION  ") \
		_T("	select hpcl_itemid,hpcl_orderid  from VIMES.hms_pacsorderline  ") \
		_T("	where hpcl_docno=%ld and hpcl_hasfee='Y' ") \
		_T("	)  tbl ") \
		_T("	LEFT JOIN hms_fee_list ON (hfl_feeid= hpcl_itemid) ") \
		_T("	LEFT JOIN hms_fee_group ON (hfg_id= hfl_groupid) ") \
		_T("	order by hfl_groupid,hpcl_itemid,hpcl_orderid "), nDocumentNo, nDocumentNo);

	rsl.ExecSQL(szSQL);

	CReportSection* rptDetail = NULL;
	int nItem = 1;
	int nQty;
	CString szNote, szUnit;
	CString szNewGrp, szOldGrp;
	while (!rsl.IsEOF())
	{
		rsl.GetValue(_T("hfl_groupid"), szNewGrp);
		if (!szNewGrp.IsEmpty() && szNewGrp != szOldGrp)
		{
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
			rptDetail->SetValue(_T("GroupName"), rsl.GetValue(_T("hfg_name")));
			szOldGrp = szNewGrp;
		}

		rptDetail = rpt.AddDetail();
		tmpStr.Format(_T("%d"), nItem++);
		rptDetail->SetValue(_T("IDX"), tmpStr);
		rsl.GetValue(_T("hfl_name"), tmpStr);

		rptDetail->SetValue(_T("1"), tmpStr);
		rsl.MoveNext();
	}

	//Page Footer
	//Report Footer


	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print(bDirect);
}

void CPrintForms::PrintTreatPackage(long nDocumentNo, long nPackageID) {
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rsg(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail;
	CString szSQL, tmpStr;
	CString szRecvDate;
	CString	szObjectType;
	CString	szDescription;
	CString	szOutPatient;

	if (!rpt.Init(_T("REPORTS/HMS/hf_dischargepaymenttreatpackage.RPT")))
	{
		return;
	}

	szSQL.Format(_T(" SELECT *") \
		_T(" FROM") \
		_T("   (SELECT hd_patientno AS patientno,") \
		_T("     hd_docno           AS docno,") \
		_T("     trim(hp_surname") \
		_T("     ||' '") \
		_T("     ||hp_midname") \
		_T("     ||' '") \
		_T("     ||hp_firstname)                                AS pname,") \
		_T("     hp_birthdate                                   AS birthdate,") \
		_T("     hms_getage(TRUNC(hd_admitdate), hp_birthdate)  AS age,") \
		_T("     extract(YEAR FROM hp_birthdate)                AS yearofbirth,") \
		_T("     Get_Selection_Desc('sys_sex', hp_sex)          AS sex,") \
		_T("     hp_sex                                         AS sex_id,") \
		_T("     hp_ethnic                                      AS ethnic,") \
		_T("     Get_Selection_Desc('sys_ethnic', hp_ethnic)    AS ethnicdesc,") \
		_T("     hp_dtladdr                                     AS detailaddress,") \
		_T("     hms_getaddress(hp_provid,hp_distid, hp_villid) AS address,") \
		_T("     hp_workplace                                   AS workplace,") \
		_T("     hd_rank                                        AS rank,") \
		_T("     get_selection_desc('hms_rank', hd_rank)        AS rankname,") \
		_T("     hd_doctor                                      AS doctor,") \
		_T("     hd_createdby                                   AS createdby,") \
		_T("     hd_icd                                         AS icd10,") \
		_T("     hd_diagnostic                                  AS diagnostic,") \
		_T("     hd_reldisease                                  AS reldisease,") \
		_T("     hd_xobject                                     AS xobject,") \
		_T("     hd_xcardno                                     AS xcardno,") \
		_T("     hd_xissuedate                                  AS xissuedate,") \
		_T("     hd_emergency                                   AS emergency,") \
		_T("     Get_Selection_Desc('hms_result',hd_result)     AS result,") \
		_T("     hd_admitdate                                   AS examdate,") \
		_T("     hd_enddate                                     AS enddate,") \
		_T("     hd_outpatient,") \
		_T("     htr_admitdate                                AS admitdate_out,") \
		_T("     htr_dischargedate                            AS dischargedate_out,") \
		_T("     hcr_admitdate                                AS admitdate,") \
		_T("     hcr_dischargedate                            AS dischargedate,") \
		_T("     hcr_recordno                                 AS recordno ,") \
		_T("     hcr_sumtreat                                 AS TreatmentDay,") \
		_T("     hcr_mainicd                                  AS mainicd ,") \
		_T("     hcr_maindisease                              AS maindisease ,") \
		_T("     hcr_treatdoctor                              AS treatdoctor,") \
		_T("     hcr_reldisease                               AS ireldisease,") \
		_T("     hcr_suggestion                               AS isuggestion,") \
		_T("     hd_suggestion                                AS esuggestion,") \
		_T("     Get_Selection_Desc('hms_result' ,hcr_result) AS iresult,") \
		_T("     Hms_GetObjectType(hd_object)                 AS objecttype,") \
		_T("     CAST(hd_disrate AS INTEGER)                  AS disrate,") \
		_T("     hd_insline                                   AS insline,") \
		_T("     hd_insregdate                                AS insregdate,") \
		_T("     hd_transplace                                AS transplace,") \
		_T("     hc_cardno                                    AS cardno,") \
		_T("     hc_regdate                                   AS regdate,") \
		_T("     hc_expdate                                   AS expdate,") \
		_T("     hc_regcode                                   AS regcode,") \
		_T("     HMS_GETHOSPITALNAME(hc_regcode)              AS regplace,") \
		_T("     row_number() over (partition BY hd_docno order by hd_docno) AS dn") \
		_T("   FROM hms_doc") \
		_T("   LEFT JOIN hms_patient") \
		_T("   ON(hp_patientno=hd_patientno)") \
		_T("   LEFT JOIN hms_clinical_record") \
		_T("   ON(hcr_docno=hd_docno)") \
		_T("   LEFT JOIN hms_treatment_record") \
		_T("   ON(hd_docno=htr_docno)") \
		_T("   LEFT JOIN hms_card") \
		_T("   ON(hc_patientno=hd_patientno") \
		_T("   AND hc_idx     =hd_cardidx)") \
		_T("   WHERE hd_docno=%ld") \
		_T("   ) Tbl") \
		_T(" WHERE dn=1"), pMF->m_nDocumentNo);

	_fmsg(_T("%s"), szSQL);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		return;
	}

	rs.GetValue(_T("objecttype"), szObjectType);
	rs.GetValue(_T("hd_outpatient"), szOutPatient);

	tmpStr.Empty();
	rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	tmpStr.Format(_T("%s-%s-%s"), rs.GetValue(_T("serialno")), rs.GetValue(_T("bookno")), rs.GetValue(_T("recvno")));
	rpt.GetReportHeader()->SetValue(_T("ReceiptNo"), tmpStr);

	CString szDate;
	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);

	rs.GetValue(_T("recordno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RecordNo"), tmpStr);

	CString szPatientName;
	StringUpper(rs.GetValue(_T("pname")), szPatientName);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), szPatientName);
	rs.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	rs.GetValue(_T("yearofbirth"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("birthdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("BirthDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);

	rs.GetValue(_T("sex_id"), tmpStr);
	if (tmpStr == _T("F"))
		rpt.GetReportHeader()->SetValue(_T("Female"), _T("X"));
	else
		rpt.GetReportHeader()->SetValue(_T("Male"), _T("X"));

	rs.GetValue(_T("ethnic"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ethnic"), tmpStr);

	rs.GetValue(_T("ethnicdesc"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ethnicdesc"), tmpStr);

	rs.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);

	rs.GetValue(_T("rankname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RankName"), tmpStr);

	CString szAddress;
	rs.GetValue(_T("detailaddress"), tmpStr);
	szAddress = tmpStr;
	rs.GetValue(_T("address"), tmpStr);
	if (!szAddress.IsEmpty())
		szAddress += _T(" - ");
	szAddress += tmpStr;
	rpt.GetReportHeader()->SetValue(_T("Address"), szAddress);

	rs.GetValue(_T("transplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TransferHospital"), tmpStr);

	rs.GetValue(_T("rankame"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Rank"), tmpStr);

	rs.GetValue(_T("objecttype"), szObjectType);

	CString szxCardNo, szCard;
	rs.GetValue(_T("cardno"), tmpStr);
	rs.GetValue(_T("xcardno"), szxCardNo);
	szCard = tmpStr.Left(15);
	if (!szxCardNo.IsEmpty())
	{
		szCard.AppendFormat(_T("; %s"), szxCardNo);
	}
	rpt.GetReportHeader()->SetValue(_T("CardNo"), szCard);
	if (!tmpStr.IsEmpty())
	{
		rpt.GetReportHeader()->SetValue(_T("HasCardNo"), _T("X"));
	}
	else
	{
		rpt.GetReportHeader()->SetValue(_T("NoCardNo"), _T("X"));
	}

	rs.GetValue(_T("disrate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Insrate"), tmpStr);

	rs.GetValue(_T("insline"), tmpStr);
	if (tmpStr == _T("Y"))
	{
		rpt.GetReportHeader()->SetValue(_T("InsLine"), _T("X"));
		rpt.GetReportHeader()->SetValue(_T("NotInsLine"), _T(""));
	}
	else
	{
		rpt.GetReportHeader()->SetValue(_T("InsLine"), _T(""));
		rpt.GetReportHeader()->SetValue(_T("NotInsLine"), _T("X"));
	}

	rs.GetValue(_T("insregdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("InsRegDate"), CDate::Convert(tmpStr));

	rs.GetValue(_T("regdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("expdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExpiryDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("regplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegistrationPlace"), tmpStr);

	CString szRegCode;
	rs.GetValue(_T("regcode"), szRegCode);
	rpt.GetReportHeader()->SetValue(_T("RegCode"), szRegCode);

	CReportItem* obj = rpt.GetReportHeader()->GetItem(_T("InsuranceCompany"));
	if (obj)
	{
		CString insname;
		CRecord rsx(&pMF->m_db);

		tmpStr.Format(_T("select sp_name as insname ") \
			_T("from sys_prov left join hms_hospital on(hh_provid=sp_id or hh_newprov_id=sp_id) where trim(hh_id)=trim('%s') "), szRegCode);
		rsx.ExecSQL(tmpStr);
		if (!rsx.IsEOF())
		{
			rsx.GetValue(_T("insname"), tmpStr);
			rpt.GetReportHeader()->Format(_T("InsuranceCompany"), tmpStr);
		}
	}

	rs.GetValue(_T("emergency"), tmpStr);
	if (tmpStr == _T("Y"))
	{
		tmpStr = _T("X");
		rpt.GetReportHeader()->SetValue(_T("InsLine"), _T(""));
		rpt.GetReportHeader()->SetValue(_T("NotInsLine"), _T(""));
	}
	else
		tmpStr.Empty();

	rpt.GetReportHeader()->SetValue(_T("Emergency"), tmpStr);
	rs.GetValue(_T("maindisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	rs.GetValue(_T("ireldisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RelationDisease"), tmpStr);
	rs.GetValue(_T("mainicd"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ICD10"), tmpStr);
	rs.GetValue(_T("iresult"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Result"), tmpStr);
	rs.GetValue(_T("isuggestion"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Suggestion"), pMF->GetSelectionString(_T("hms_suggestion"), tmpStr));

	CString szDischargeDate;
	if (szOutPatient == _T("Y"))
	{
		rs.GetValue(_T("admitdate_out"), tmpStr);

		rpt.GetReportHeader()->SetValue(_T("admitdate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));

		rs.GetValue(_T("dischargedate_out"), tmpStr);
		szDischargeDate = tmpStr;

		if (szDischargeDate.Left(4) != _T("1752"))
			rpt.GetReportHeader()->SetValue(_T("dischargedate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));
		else
			rpt.GetReportHeader()->SetValue(_T("dischargedate"), _T(""));
	}
	else
	{
		rs.GetValue(_T("admitdate"), tmpStr);

		rpt.GetReportHeader()->SetValue(_T("admitdate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));

		rs.GetValue(_T("dischargedate"), tmpStr);
		szDischargeDate = tmpStr;

		if (szDischargeDate.Left(4) != _T("1752"))
			rpt.GetReportHeader()->SetValue(_T("dischargedate"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));
		else
			rpt.GetReportHeader()->SetValue(_T("dischargedate"), _T(""));
	}

	rs.GetValue(_T("TreatmentDay"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("TreatmentDay"), tmpStr);

	CRecord rsx2(&pMF->m_db);
	tmpStr.Format(_T(" SELECT htp_description FROM hms_treat_package WHERE htp_treat_package_id = %ld "), nPackageID);
	rsx2.ExecSQL(tmpStr);
	if (!rsx2.IsEOF())
	{
		rsx2.GetValue(_T("htp_description"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("TreatPackageName"), tmpStr);
	}

	szSQL.Format(_T(" SELECT hfg_type_id    AS type_id, hfe_type, ") \
		_T("   hfe_itemid          AS itemid,") \
		_T("   hfe_desc            AS description,") \
		_T("   hfe_unitprice       AS unitprice,") \
		_T("   hfe_insprice        AS insprice,") \
		_T("   hfe_treat_inpackage AS inpackage,") \
		_T("   SUM(hfe_quantity)   AS quantity,") \
		_T("   SUM(hfe_cost)       AS amount,") \
		_T("   SUM(hfe_inspaid)    AS inscost,") \
		_T("   hfe_deptid,") \
		_T("   hfe_date") \
		_T(" FROM hms_fee") \
		_T(" LEFT JOIN hms_fee_group") \
		_T(" ON(hfg_id       = hfe_group)") \
		_T(" WHERE hfe_docno = %ld and hfe_treat_package_id=%ld ") \
		_T(" GROUP BY hfg_type_id, hfe_type, ") \
		_T("   hfe_itemid,") \
		_T("   hfe_desc ,") \
		_T("   hfe_unitprice,") \
		_T("   hfe_insprice,") \
		_T("   hfe_treat_inpackage,") \
		_T("   hfe_deptid,") \
		_T("   hfe_date") \
		_T(" ORDER BY type_id,") \
		_T("   hfe_deptid,") \
		_T("   hfe_date,") \
		_T("   description,") \
		_T("   unitprice"),
		pMF->m_nDocumentNo, nPackageID);
	_fmsg(_T("%s"), szSQL);
	int nCount = 0;
	int nItem;
	int nIndex = 0;
	CString szOldType = _T("XX"), szNewType, szInpackage;
	double ttl_cost[2], ttl_cost2[2], ttl_cost3[2];
	ttl_cost[0] = ttl_cost[1] = ttl_cost2[0] = ttl_cost2[1] = ttl_cost3[0] = ttl_cost3[1] = 0;
	double amount = 0;
	nCount = rs2.ExecSQL(szSQL);
	while (!rs2.IsEOF()) {
		rs2.GetValue(_T("type_id"), szNewType);
		if (szNewType != szOldType)
		{
			if (ttl_cost[1] + ttl_cost2[1] + ttl_cost3[1] > 0)
			{
				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
				rptDetail->SetValue(_T("GroupTotal"), _T("Cộng"));
				rptDetail->SetValue(_T("s6"), ttl_cost[1] > 0 ? double2str(ttl_cost[1]) : _T(""));
				rptDetail->SetValue(_T("s7"), ttl_cost2[1] > 0 ? double2str(ttl_cost2[1]) : _T(""));
				rptDetail->SetValue(_T("s8"), ttl_cost3[1] > 0 ? double2str(ttl_cost3[1]) : _T(""));
			}
			ttl_cost[1] = ttl_cost2[1] = ttl_cost3[1] = 0;
			szSQL.Format(_T("SELECT hft_name from hms_fee_type where hft_id=%ld"), str2int(szNewType));
			rsg.ExecSQL(szSQL);
			rsg.GetValue(_T("hft_name"), tmpStr);
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(2));
			rptDetail->SetValue(_T("GroupName"), tmpStr);
			szOldType = szNewType;
		}

		rptDetail = rpt.AddDetail();
		rs2.GetValue(_T("amount"), amount);
		rs2.GetValue(_T("inpackage"), szInpackage);
		rs2.GetValue(_T("InPkg"), tmpStr);

		tmpStr.Format(_T("%d"), nIndex++);
		rptDetail->SetValue(_T("1"), tmpStr);
		rs2.GetValue(_T("Description"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rs2.GetValue(_T("Quantity"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rs2.GetValue(_T("UnitPrice"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rs2.GetValue(_T("InsPrice"), tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		rptDetail->SetValue(_T("6"), szInpackage == _T("Y") ? double2str(amount) : _T(""));
		rptDetail->SetValue(_T("7"), szInpackage != _T("Y") ? double2str(amount) : _T(""));

		rs2.GetValue(_T("InsCost"), tmpStr);
		ttl_cost3[0] += str2double(tmpStr);
		ttl_cost3[1] += str2double(tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		rs2.GetValue(_T("hfe_date"), tmpStr);
		rptDetail->SetValue(_T("9"), CDateTime::Convert(tmpStr, yyyymmdd | hhmm, ddmmyyyy | hhmm));
		rs2.GetValue(_T("hfe_deptid"), tmpStr);
		rptDetail->SetValue(_T("10"), tmpStr);

		if (szInpackage == _T("Y"))
		{
			ttl_cost[0] += amount;
			ttl_cost[1] += amount;
		}
		else
		{
			ttl_cost2[0] += amount;
			ttl_cost2[1] += amount;
		}

		rs2.MoveNext();
	}

	if (ttl_cost[1] + ttl_cost2[1] + ttl_cost3[1] > 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
		rptDetail->SetValue(_T("GroupTotal"), _T("Cộng"));
		rptDetail->SetValue(_T("s6"), ttl_cost[1] > 0 ? double2str(ttl_cost[1]) : _T(""));
		rptDetail->SetValue(_T("s7"), ttl_cost2[1] > 0 ? double2str(ttl_cost2[1]) : _T(""));
		rptDetail->SetValue(_T("s8"), ttl_cost3[1] > 0 ? double2str(ttl_cost3[1]) : _T(""));
	}

	if (ttl_cost[0] + ttl_cost2[0] + ttl_cost3[0] > 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
		rptDetail->SetValue(_T("GroupTotal"), _T("Tổng cộng"));
		rptDetail->SetValue(_T("s6"), ttl_cost[0] > 0 ? double2str(ttl_cost[0]) : _T(""));
		rptDetail->SetValue(_T("s7"), ttl_cost2[0] > 0 ? double2str(ttl_cost2[0]) : _T(""));
		rptDetail->SetValue(_T("s8"), ttl_cost3[0] > 0 ? double2str(ttl_cost3[0]) : _T(""));
	}

	rpt.GetReportFooter()->SetValue(_T("SumAmount"), double2str(ttl_cost2[0]));
	CString szMoney;
	double nTtlAmount = 0;
	MoneyToString(double2str(ttl_cost2[0]), szMoney);
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), szMoney);
	nTtlAmount = ttl_cost[0] + ttl_cost2[0];
	rpt.GetReportFooter()->SetValue(_T("SumTreatpackageAmount"), double2str(nTtlAmount));
	rpt.GetReportFooter()->SetValue(_T("SumPatPaid"), double2str(ttl_cost[0]));


	CString szTime, szSysDate;
	szTime = pMF->GetSysDateTime();
	szSysDate = pMF->GetSysDate();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("ReceiptDate")),
		szTime.Right(8), szSysDate.Right(2), szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("ReceiptDate"), szDate);
	rpt.PrintPreview();
}

void CPrintForms::LIMS_PrintUnapprovalOrder(long nOrderID)
{
	CLIMSCancelledOrderDlg dlg(AfxGetMainWnd());
	dlg.m_nOrderId = nOrderID;
	dlg.DoModal();
}
void CPrintForms::PrintDrugDeliveryin(long nOrderID, bool bPreview, bool bDirect, int nNumberPage) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr;

	//Report Header

	CString szSQL, szUsage, szDeptType;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	long nDocumentNo;
	int nRefIndex;
	double dblTotalAmount = 0;

	szSQL.Format(_T(" SELECT 	hd_patientno as patientno,  ") \
		_T(" 	hd_docno as docno,") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	TO_CHAR(hp_birthdate, 'YYYY') as birthyear,") \
		_T(" 	hms_getage(trunc(hd_admitdate), hp_birthdate) as age,") \
		_T(" 	hp_sex as sexid,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T(" 	sys_sel_getname('hms_rank', hp_rank) as rank,") \
		_T(" 	hp_occupation as occupationid,") \
		_T(" 	nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T(" 	hms_getaddress(hp_provid,hp_distid, hp_villid) as address,") \
		_T(" 	hp_workplaceid as workplaceid,") \
		_T(" 	hp_workplace as workplace,") \
		_T(" 	hd_object as objectid,") \
		_T(" 	ho_desc as objectname,") \
		_T(" 	ho_type as objecttype,") \
		_T(" 	hd_cardno as cardno,") \
		_T(" 	hd_cardidx as cardidx, ") \
		_T("	hd_reldisease as relationdisease, ") \
		_T("	hd_diagnostic ||' ['||hd_icd||']' as diagnostic, ") \
		_T(" 	hd_status, ") \
		_T(" 	hdf_acceptedfee, ") \
		_T("	trunc(hd_admitdate) as examdate, ") \
		_T(" 	hpo_orderdate as orderdate, ") \
		_T(" 	hpo_doctor as doctor, ") \
		_T(" 	hpo_storage_id as stockid, ") \
		_T(" 	GET_STORAGENAME(hpo_storage_id) as stockname, ") \
		_T(" 	hpo_deptid as deptid, ") \
		_T(" 	hpo_roomid as roomid, ") \
		_T(" 	HMS_GETROOMNAME(hpo_deptid, hpo_roomid)  as roomname, ") \
		_T(" 	hpo_bedid as bedid, ") \
		_T(" 	hpo_depttype as depttype, ") \
		_T(" 	hpo_refidx as refidx, ") \
		_T(" 	hpo_printed as printed ") \
		_T(" FROM hms_ipharmaorder") \
		_T(" LEFT JOIN hms_patient ON(hp_patientno=hpo_patientno)") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno and hd_docno=hpo_docno)") \
		_T(" LEFT JOIN hms_object ON(ho_id=hd_object) ") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hpo_orderid=%ld AND hpo_orderstatus NOT IN('O','C') "), nOrderID);

	rs.ExecSQL(szSQL);
	_msg(_T("%s"), szSQL);

	if (rs.IsEOF())
	{
		_tprintf(_T("Order not found."));
		return;
	}

	szSQL.Format(_T(" SELECT hpol_line,") \
		_T("   hpol_product_id,") \
		_T("   hpol_productcode,") \
		_T("   hpol_productname,") \
		_T("   hpol_productuom,") \
		_T("   hpol_unitprice,") \
		_T("   SUM(hpol_qtyissue) AS hpol_qtyissue,") \
		_T("   SUM(hpol_qtyissue*hpol_unitprice) AS hpol_amount,") \
		_T("   hpol_productcountry, ") \
		_T(" HMS_GETDOUSAGEIN(hpol_orderid, hpol_product_id) as hpol_usage ") \
		_T(" FROM hms_ipharmaorderline_view") \
		_T(" WHERE hpol_orderid =%ld and hpol_qtyissue > 0 AND hpol_producttype not in('A1130','A1140') ") \
		_T(" GROUP BY hpol_orderid, hpol_line,") \
		_T("   hpol_product_id,") \
		_T("   hpol_productcode,") \
		_T("   hpol_productname,") \
		_T("   hpol_productuom,") \
		_T("   hpol_unitprice,") \
		_T("   hpol_productcountry ") \
		_T(" HAVING SUM(hpol_qtyissue) > 0 ")\
		_T(" ORDER BY hpol_productname,hpol_line"), nOrderID);

	rsl.ExecSQL(szSQL);
	if (rsl.IsEOF()) {

		_tprintf(_T("\r\nData not found"));
		return;
	}

	CString szReportName;
	if (rs.GetValue(_T("objectid")) == _T("7"))
		szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTE_DV.RPT"));
	else
		if (rs.GetValue(_T("objectid")) == _T("1") || rs.GetValue(_T("objectid")) == _T("3") ||
			rs.GetValue(_T("objectid")) == _T("8"))
			szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTE_D.RPT"));
		else
			szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTE.RPT"));



	if (!rpt.Init(szReportName, false, false, nNumberPage))
	{
		_msg(_T(" Cant not open file report: %s"), szReportName);
		return;

	}
	_tprintf(_T("\r\n%s"), szReportName);
	long gOrderID = 0;
	gOrderID = nOrderID;


	tmpStr.Empty();
	StringUpper(pMF->m_szHealthService, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_szHospitalName, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);
	rs.GetValue(_T("deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("deptid")));
	rs.GetValue(_T("roomname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);

	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("OrderID"), tmpStr);

	CString szPatientName;
	rs.GetValue(_T("pname"), szPatientName);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), szPatientName);
	//In ra tuoi	
	rs.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	//Chi In ra nam sinh.
	rs.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	rs.GetValue(_T("address"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);
	rs.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);
	rs.GetValue(_T("objectname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Object"), tmpStr);

	rs.GetValue(_T("examdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExamDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("rank"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Rank"), tmpStr);

	rs.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	int nStockId;
	rs.GetValue(_T("stockname"), tmpStr);


	rpt.GetReportHeader()->SetValue(_T("Stock"), (tmpStr));
	//	rs.GetValue(_T("refidx"), nRefIndex);
	//	rs.GetValue(_T("roomid"), m_nRoomID);
	//tmpStr.Format(_T("%d"), m_nRoomID);
	rpt.GetReportHeader()->SetValue(_T("RoomID"), tmpStr);
	rs.GetValue(_T("bedid"), tmpStr);
	rs.GetValue(_T("depttype"), szDeptType);
	szDeptType.Trim();


	szSQL.Format(_T("SELECT hcr_mainicd as Icd,hcr_maindisease || ' [' || hcr_mainicd || ']' as Diagnostic, hcr_reldisease as reldisease FROM hms_clinical_record WHERE hcr_docno=%ld "), nDocumentNo);
	rs2.ExecSQL(szSQL);

	if (!rs2.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs2.GetValue(_T("Diagnostic")));

	}
	else
	{
		rs.GetValue(_T("Diagnostic"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	}
	rs2.GetValue(_T("reldisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);




	//Page Header
	//Report Detail
	CReportSection* rptDetail = rpt.GetDetail(0);
	int nItem = 1;

	CString szWhere, tmpStr2, szQty;

	nItem = 1;
	dblTotalAmount = 0;
	double money = 0;
	while (!rsl.IsEOF()) {
		rptDetail = rpt.AddDetail();
		rsl.GetValue(_T("hpol_usage"), szUsage);

		rsl.GetValue(_T("hpol_amount"), money);
		dblTotalAmount += money;
		tmpStr.Format(_T("%d"), nItem);
		rptDetail->SetValue(_T("1"), tmpStr);
		rsl.GetValue(_T("hpol_productname"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rsl.GetValue(_T("hpol_productuom"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rsl.GetValue(_T("hpol_qtyissue"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rptDetail->SetValue(_T("4.1"), _T(""));

		rsl.GetValue(_T("hpol_unitprice"), tmpStr);
		FormatCurrencyStr(tmpStr, tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		rsl.GetValue(_T("hpol_amount"), tmpStr);
		FormatCurrencyStr(tmpStr, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rsl.GetValue(_T("hpol_productcountry"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rsl.MoveNext();
	}

	//Page Footer
	//Report Footer
	CString tmpVal;
	tmpStr.Format(_T("%d"), nItem - 1);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(dblTotalAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	tmpVal.Format(_T("%2.f"), dblTotalAmount);
	MoneyToString(tmpVal, tmpStr);
#ifdef UNICODE
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr + _T(" \x111\x1ED3ng"));
#endif
	CString szDate;
	//rs.GetValue(_T("orderdate"), tmpStr);

	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);


	rpt.GetReportFooter()->SetValue(_T("PatientSign"), szPatientName);

	rs.GetValue(_T("doctorname"), tmpStr);

	rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);
	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{

	}
	CString szStatus;
	CString szAcceptedFee;
	CString szObjectType;
	int nPrinted = 0;

	rs.GetValue(_T("hd_status"), szStatus);
	rs.GetValue(_T("objecttype"), szObjectType);
	rs.GetValue(_T("printed"), nPrinted);
	rs.GetValue(_T("hd_acceptedfee"), szAcceptedFee);

	if (pMF->CheckPermission(_T("10.10")) || pMF->GetModuleID() == _T("FM"))
	{
		if (bPreview)
			rpt.PrintPreview();
		else
		{
			rpt.Print(bDirect);
		}
	}
	else
	{
		if (bPreview)
		{
			if ((szObjectType == _T("I") || szObjectType == _T("C")) && (szAcceptedFee != _T("Y")))
			{
				nPrinted = 1;
			}

			if (szObjectType == _T("D") && szStatus != _T("T"))
				nPrinted = 1;

			if (nPrinted > 0 && !pMF->CheckPermission(_T("10.10")))
				rpt.PrintPreview(false);
			else
				rpt.PrintPreview();

		}
		else
		{

			if (nPrinted > 0) {

				CString szMsg;
				szMsg.Format(_T("\x110\x1A1n thu\x1ED1\x63 \x111\xE3 \x111\x1B0\x1EE3\x63 in [%\x64] l\x1EA7n. Kh\xF4ng th\x1EC3 in l\x1EA1i!"), nPrinted);
				ShowMessageBox(szMsg, MB_OK);

				return;
			}
			if (szObjectType == _T("D") && szStatus != _T("T"))
			{
				ShowMessageBox(_T("Patient profile not finish. Cannot allow print prescription"));
				return;
			}

			if ((szObjectType == _T("I") || szObjectType == _T("C")) && (szAcceptedFee != _T("Y")) && pMF->GetModuleID() != _T("FM"))
			{
				ShowMessageBox(_T("\x42\x1EC7nh nh\xE2n \x42HYT \x63h\x1B0\x61 \x64uy\x1EC7t ph\xED. Kh\xF4ng \x111\x1B0\x1EE3\x63 in \x111\x1A1n thu\x1ED1\x63!"));
				return;
			}


			rpt.Print(bDirect);
		}
	}
}


void CPrintForms::PrintDrugDeliveryin_GN(long nOrderID, bool bPreview, bool bDirect, int nNumberPage) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr;

	//Report Header

	CString szSQL, szUsage, szDeptType;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	long nDocumentNo;
	int nRefIndex;
	double dblTotalAmount = 0;

	szSQL.Format(_T(" SELECT 	hd_patientno as patientno,  ") \
		_T(" 	hd_docno as docno,") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	TO_CHAR(hp_birthdate, 'YYYY') as birthyear,") \
		_T(" 	hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age,") \
		_T(" 	hp_sex as sexid,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T(" 	sys_sel_getname('hms_rank', hp_rank) as rank,") \
		_T(" 	hp_occupation as occupationid,") \
		_T(" 	nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T(" 	hms_getaddress(hp_provid,hp_distid, hp_villid) as address,") \
		_T(" 	hp_workplaceid as workplaceid,") \
		_T(" 	hp_workplace as workplace,") \
		_T(" 	hd_object as objectid,") \
		_T(" 	ho_desc as objectname,") \
		_T(" 	ho_type as objecttype,") \
		_T(" 	hd_cardno as cardno,") \
		_T(" 	hd_cardidx as cardidx, ") \
		_T("	hd_reldisease as relationdisease, ") \
		_T("	hd_diagnostic ||' ['||hd_icd||']' as diagnostic, ") \
		_T(" 	hd_status, ") \
		_T(" 	hdf_acceptedfee, ") \
		_T("	trunc_date(hd_admitdate) as examdate, ") \
		_T(" 	hc_regdate as regdate, ") \
		_T(" 	hc_expdate as expdate, ") \
		_T(" 	hpo_orderdate as orderdate, ") \
		_T(" 	hpo_doctor as doctor,,GET_USERNAME(hpo_doctor) as doctorname, ") \
		_T(" 	hpo_storage_id as stockid, ") \
		_T("	GET_STORAGENAME(hpo_STORAGE_ID) as stockname, ") \
		_T(" 	hpo_deptid as deptid, ") \
		_T(" 	hpo_roomid as roomid, ") \
		_T(" 	HMS_GETROOMNAME(hpo_deptid, hpo_roomid)  as roomname, ") \
		_T(" 	hpo_bedid as bedid, ") \
		_T(" 	hpo_depttype as depttype, ") \
		_T(" 	hpo_refidx as refidx, ") \
		_T(" 	hpo_printed as printed ") \
		_T(" FROM hms_ipharmaorder") \
		_T(" LEFT JOIN hms_patient ON(hp_patientno=hpo_patientno)") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno and hd_docno=hpo_docno)") \
		_T(" LEFT JOIN hms_object ON(ho_id=hd_object) ") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hpo_orderid=%ld AND hpo_orderstatus NOT IN('O','C') "), nOrderID);

	rs.ExecSQL(szSQL);
	////_fmsg(_T("%s"), szSQL);

	if (rs.IsEOF())
	{
		_tprintf(_T("Order not found."));
		return;
	}

	szSQL.Format(_T(" SELECT hpol_line,") \
		_T("   hpol_product_id,") \
		_T("   hpol_productcode,") \
		_T("   hpol_productname,") \
		_T("   hpol_productuom,") \
		_T("   hpol_unitprice,") \
		_T("   SUM(hpol_qtyissue) AS hpol_qtyissue,") \
		_T("   SUM(hpol_qtyissue*hpol_unitprice) AS hpol_amount,") \
		_T("   hpol_productcountry, ") \
		_T(" HMS_GETDOUSAGEIN(hpol_orderid, hpol_product_id) as hpol_usage ") \
		_T(" FROM hms_ipharmaorderline_view") \
		_T(" WHERE hpol_orderid =%ld and hpol_qtyissue > 0 AND hpol_producttype  in('A1130') ") \
		_T(" GROUP BY hpol_orderid, hpol_line,") \
		_T("   hpol_product_id,") \
		_T("   hpol_productcode,") \
		_T("   hpol_productname,") \
		_T("   hpol_productuom,") \
		_T("   hpol_unitprice,") \
		_T("   hpol_productcountry ") \
		_T(" HAVING SUM(hpol_qtyissue) > 0 ")\
		_T(" ORDER BY hpol_productname,hpol_line"), nOrderID);

	rsl.ExecSQL(szSQL);
	if (rsl.IsEOF()) {

		_tprintf(_T("\r\nData not found"));
		return;
	}

	CString szReportName;
	if (rs.GetValue(_T("objectid")) == _T("7"))
		szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTEIN_GN_DV.RPT"));
	else
		if (rs.GetValue(_T("objectid")) == _T("1") || rs.GetValue(_T("objectid")) == _T("3") || rs.GetValue(_T("objectid")) == _T("8"))
			szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTE_D.RPT"));
		else
			szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTEIN_GN.RPT"));

	if (!rpt.Init(szReportName, false, false, nNumberPage))
	{
		_msg(_T(" cant not oprn file report : %s"), szReportName);
		return;
	}
	_tprintf(_T("\r\n%s"), szReportName);
	long gOrderID = 0;
	gOrderID = nOrderID;


	tmpStr.Empty();
	StringUpper(pMF->m_szHealthService, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_szHospitalName, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);
	rs.GetValue(_T("deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
	rs.GetValue(_T("roomname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);

	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("OrderID"), tmpStr);

	CString szPatientName;
	rs.GetValue(_T("pname"), szPatientName);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), szPatientName);
	//In ra tuoi	
	rs.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	//Chi In ra nam sinh.
	rs.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	rs.GetValue(_T("address"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);
	rs.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);
	rs.GetValue(_T("objectname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Object"), tmpStr);

	rs.GetValue(_T("examdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExamDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("rank"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Rank"), tmpStr);

	rs.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	int nStockId;
	rs.GetValue(_T("stockname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Stock"), (tmpStr));
	rs.GetValue(_T("refidx"), nRefIndex);
	//	rs.GetValue(_T("roomid"), m_nRoomID);
	//	tmpStr.Format(_T("%d"), m_nRoomID);
	rpt.GetReportHeader()->SetValue(_T("RoomID"), tmpStr);
	rs.GetValue(_T("bedid"), tmpStr);
	rs.GetValue(_T("depttype"), szDeptType);
	szDeptType.Trim();

	szSQL.Format(_T("SELECT hcr_mainicd as Icd,hcr_maindisease || ' [' || hcr_mainicd || ']' as Diagnostic, hcr_reldisease as reldisease FROM hms_clinical_record WHERE hcr_docno=%ld "), nDocumentNo);
	rs2.ExecSQL(szSQL);

	if (!rs2.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs2.GetValue(_T("Diagnostic")));

	}
	else
	{
		rs.GetValue(_T("Diagnostic"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	}
	rs2.GetValue(_T("reldisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);






	//Page Header
	//Report Detail
	CReportSection* rptDetail = rpt.GetDetail(0);
	int nItem = 1;

	CString szWhere, tmpStr2, szQty;

	nItem = 1;
	dblTotalAmount = 0;
	double money = 0;
	while (!rsl.IsEOF()) {
		rptDetail = rpt.AddDetail();
		rsl.GetValue(_T("hpol_usage"), szUsage);

		rsl.GetValue(_T("hpol_amount"), money);
		dblTotalAmount += money;
		tmpStr.Format(_T("%d"), nItem);
		rptDetail->SetValue(_T("1"), tmpStr);
		rsl.GetValue(_T("hpol_productname"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rsl.GetValue(_T("hpol_productuom"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rsl.GetValue(_T("hpol_qtyissue"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rptDetail->SetValue(_T("4.1"), _T(""));

		rsl.GetValue(_T("hpol_unitprice"), tmpStr);
		FormatCurrencyStr(tmpStr, tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		rsl.GetValue(_T("hpol_amount"), tmpStr);
		FormatCurrencyStr(tmpStr, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rsl.GetValue(_T("hpol_productcountry"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rsl.MoveNext();
	}

	//Page Footer
	//Report Footer
	CString tmpVal;
	tmpStr.Format(_T("%d"), nItem - 1);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(dblTotalAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	tmpVal.Format(_T("%2.f"), dblTotalAmount);
	MoneyToString(tmpVal, tmpStr);
#ifdef UNICODE
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr + _T(" \x111\x1ED3ng"));
#endif
	CString szDate;
	//rs.GetValue(_T("orderdate"), tmpStr);

	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);


	rpt.GetReportFooter()->SetValue(_T("PatientSign"), szPatientName);

	rs.GetValue(_T("doctor"), tmpStr);

	rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{

	}

	CString szStatus;
	CString szAcceptedFee;
	CString szObjectType;
	int nPrinted = 0;

	rs.GetValue(_T("hd_status"), szStatus);
	rs.GetValue(_T("objecttype"), szObjectType);
	rs.GetValue(_T("printed"), nPrinted);
	rs.GetValue(_T("hd_acceptedfee"), szAcceptedFee);

	if (pMF->CheckPermission(_T("10.10")) || pMF->GetModuleID() == _T("FM"))
	{
		if (bPreview)
			rpt.PrintPreview();
		else
		{
			rpt.Print(bDirect);
		}
	}
	else
	{
		if (bPreview)
		{
			if ((szObjectType == _T("I") || szObjectType == _T("C")) && (szAcceptedFee != _T("Y")))
			{
				nPrinted = 1;
			}

			if (szObjectType == _T("D") && szStatus != _T("T"))
				nPrinted = 1;

			if (nPrinted > 0 && !pMF->CheckPermission(_T("10.10")))
				rpt.PrintPreview(false);
			else
				rpt.PrintPreview();

		}
		else
		{

			if (nPrinted > 0) {

				CString szMsg;
				szMsg.Format(_T("\x110\x1A1n thu\x1ED1\x63 \x111\xE3 \x111\x1B0\x1EE3\x63 in [%\x64] l\x1EA7n. Kh\xF4ng th\x1EC3 in l\x1EA1i!"), nPrinted);
				ShowMessageBox(szMsg, MB_OK);

				return;
			}
			if (szObjectType == _T("D") && szStatus != _T("T"))
			{
				ShowMessageBox(_T("Patient profile not finish. Cannot allow print prescription"));
				return;
			}

			if ((szObjectType == _T("I") || szObjectType == _T("C")) && (szAcceptedFee != _T("Y")) && pMF->GetModuleID() != _T("FM"))
			{
				ShowMessageBox(_T("\x42\x1EC7nh nh\xE2n \x42HYT \x63h\x1B0\x61 \x64uy\x1EC7t ph\xED. Kh\xF4ng \x111\x1B0\x1EE3\x63 in \x111\x1A1n thu\x1ED1\x63!"));
				return;
			}


			rpt.Print(bDirect);
		}
	}
}


void CPrintForms::PrintDrugDeliveryin_HT(long nOrderID, bool bPreview, bool bDirect, int nNumberPage) {
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr;

	//Report Header

	CString szSQL, szUsage, szDeptType;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	long nDocumentNo;
	int nRefIndex;
	double dblTotalAmount = 0;

	szSQL.Format(_T(" SELECT 	hd_patientno as patientno,  ") \
		_T(" 	hd_docno as docno,") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	TO_CHAR(hp_birthdate, 'YYYY') as birthyear,") \
		_T(" 	hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age,") \
		_T(" 	hp_sex as sexid,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T(" 	sys_sel_getname('hms_rank', hp_rank) as rank,") \
		_T(" 	hp_occupation as occupationid,") \
		_T(" 	nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T(" 	hms_getaddress(hp_provid,hp_distid, hp_villid) as address,") \
		_T(" 	hp_workplaceid as workplaceid,") \
		_T(" 	hp_workplace as workplace,") \
		_T(" 	hd_object as objectid,") \
		_T(" 	ho_desc as objectname,") \
		_T(" 	ho_type as objecttype,") \
		_T(" 	hd_cardno as cardno,") \
		_T(" 	hd_cardidx as cardidx, ") \
		_T("	hd_reldisease as relationdisease, ") \
		_T("	hd_diagnostic ||' ['||hd_icd||']' as diagnostic, ") \
		_T(" 	hd_status, ") \
		_T(" 	hdf_acceptedfee, ") \
		_T("	trunc_date(hd_admitdate) as examdate, ") \
		_T(" 	hc_regdate as regdate, ") \
		_T(" 	hc_expdate as expdate, ") \
		_T(" 	hpo_orderdate as orderdate, ") \
		_T(" 	hpo_doctor as doctor, ") \
		_T(" 	hpo_storage_id as stockid, ") \
		_T("	GET_STORAGENAME(hpo_storage_id) as stockname	, ") \
		_T(" 	hpo_deptid as deptid, ") \
		_T(" 	hpo_roomid as roomid, ") \
		_T(" 	HMS_GETROOMNAME(hpo_deptid, hpo_roomid)  as roomname, ") \
		_T(" 	hpo_bedid as bedid, ") \
		_T(" 	hpo_depttype as depttype, ") \
		_T(" 	hpo_refidx as refidx, ") \
		_T(" 	hpo_printed as printed ") \
		_T(" FROM hms_ipharmaorder") \
		_T(" LEFT JOIN hms_patient ON(hp_patientno=hpo_patientno)") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno and hd_docno=hpo_docno)") \
		_T(" LEFT JOIN hms_object ON(ho_id=hd_object) ") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hpo_orderid=%ld AND hpo_orderstatus NOT IN('O','C') "), nOrderID);

	rs.ExecSQL(szSQL);
	////_fmsg(_T("%s"), szSQL);

	if (rs.IsEOF())
	{
		_tprintf(_T("Order not found."));
		return;
	}

	szSQL.Format(_T(" SELECT hpol_line,") \
		_T("   hpol_product_id,") \
		_T("   hpol_productcode,") \
		_T("   hpol_productname,") \
		_T("   hpol_productuom,") \
		_T("   hpol_unitprice,") \
		_T("   SUM(hpol_qtyissue) AS hpol_qtyissue,") \
		_T("   SUM(hpol_qtyissue*hpol_unitprice) AS hpol_amount,") \
		_T("   hpol_productcountry, ") \
		_T(" HMS_GETDOUSAGEIN(hpol_orderid, hpol_product_id) as hpol_usage ") \
		_T(" FROM hms_ipharmaorderline_view") \
		_T(" WHERE hpol_orderid =%ld and hpol_qtyissue > 0 AND hpol_producttype  in('A1140') ") \
		_T(" GROUP BY hpol_orderid, hpol_line,") \
		_T("   hpol_product_id,") \
		_T("   hpol_productcode,") \
		_T("   hpol_productname,") \
		_T("   hpol_productuom,") \
		_T("   hpol_unitprice,") \
		_T("   hpol_productcountry ") \
		_T(" HAVING SUM(hpol_qtyissue) > 0 ")\
		_T(" ORDER BY hpol_productname,hpol_line"), nOrderID);

	rsl.ExecSQL(szSQL);
	if (rsl.IsEOF()) {

		_tprintf(_T("\r\nData not found"));
		return;
	}

	CString szReportName;
	if (rs.GetValue(_T("objectid")) == _T("7"))
		szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTEIN_HT_DV.RPT"));
	else
		if (rs.GetValue(_T("objectid")) == _T("1") || rs.GetValue(_T("objectid")) == _T("3") ||
			rs.GetValue(_T("objectid")) == _T("8"))
			szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTE_D.RPT"));
		else
			szReportName.Format(_T("Reports/HMS/PMS_DRUGDELIVERYVOTEIN_HT.RPT"));


	if (!rpt.Init(szReportName, false, false, nNumberPage))
	{
		_msg(_T(" cant not oprn file report : %s"), szReportName);
		return;
	}
	_tprintf(_T("\r\n%s"), szReportName);
	long gOrderID = 0;
	gOrderID = nOrderID;


	tmpStr.Empty();
	StringUpper(pMF->m_szHealthService, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_szHospitalName, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);
	rs.GetValue(_T("deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
	rs.GetValue(_T("roomname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);

	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("OrderID"), tmpStr);

	CString szPatientName;
	rs.GetValue(_T("pname"), szPatientName);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), szPatientName);
	//In ra tuoi	
	rs.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	//Chi In ra nam sinh.
	rs.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	rs.GetValue(_T("address"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);
	rs.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);
	rs.GetValue(_T("objectname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Object"), tmpStr);

	rs.GetValue(_T("examdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExamDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("rank"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Rank"), tmpStr);

	rs.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	int nStockId;
	rs.GetValue(_T("stockname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Stock"), (tmpStr));
	rs.GetValue(_T("refidx"), nRefIndex);
	//	rs.GetValue(_T("roomid"), m_nRoomID);
	//tmpStr.Format(_T("%d"), m_nRoomID);
	rpt.GetReportHeader()->SetValue(_T("RoomID"), tmpStr);
	rs.GetValue(_T("bedid"), tmpStr);
	rs.GetValue(_T("depttype"), szDeptType);
	szDeptType.Trim();


	szSQL.Format(_T("SELECT hcr_mainicd as Icd,hcr_maindisease || ' [' || hcr_mainicd || ']' as Diagnostic, hcr_reldisease as reldisease FROM hms_clinical_record WHERE hcr_docno=%ld "), nDocumentNo);
	rs2.ExecSQL(szSQL);

	if (!rs2.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs2.GetValue(_T("Diagnostic")));

	}
	else
	{
		rs.GetValue(_T("Diagnostic"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	}
	rs2.GetValue(_T("reldisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);




	//Page Header
	//Report Detail
	CReportSection* rptDetail = rpt.GetDetail(0);
	int nItem = 1;

	CString szWhere, tmpStr2, szQty;

	nItem = 1;
	dblTotalAmount = 0;
	double money = 0;
	while (!rsl.IsEOF()) {
		rptDetail = rpt.AddDetail();
		rsl.GetValue(_T("hpol_usage"), szUsage);

		rsl.GetValue(_T("hpol_amount"), money);
		dblTotalAmount += money;
		tmpStr.Format(_T("%d"), nItem);
		rptDetail->SetValue(_T("1"), tmpStr);
		rsl.GetValue(_T("hpol_productname"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rsl.GetValue(_T("hpol_productuom"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rsl.GetValue(_T("hpol_qtyissue"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rptDetail->SetValue(_T("4.1"), _T(""));

		rsl.GetValue(_T("hpol_unitprice"), tmpStr);
		FormatCurrencyStr(tmpStr, tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		rsl.GetValue(_T("hpol_amount"), tmpStr);
		FormatCurrencyStr(tmpStr, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rsl.GetValue(_T("hpol_productcountry"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rsl.MoveNext();
	}

	//Page Footer
	//Report Footer
	CString tmpVal;
	tmpStr.Format(_T("%d"), nItem - 1);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(dblTotalAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	tmpVal.Format(_T("%2.f"), dblTotalAmount);
	MoneyToString(tmpVal, tmpStr);
#ifdef UNICODE
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr + _T(" \x111\x1ED3ng"));
#endif
	CString szDate;
	//rs.GetValue(_T("orderdate"), tmpStr);

	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);


	rpt.GetReportFooter()->SetValue(_T("PatientSign"), szPatientName);

	rs.GetValue(_T("doctor"), tmpStr);

	rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if (img)
	{

	}

	CString szStatus;
	CString szAcceptedFee;
	CString szObjectType;
	int nPrinted = 0;

	rs.GetValue(_T("hd_status"), szStatus);
	rs.GetValue(_T("objecttype"), szObjectType);
	rs.GetValue(_T("printed"), nPrinted);
	rs.GetValue(_T("hd_acceptedfee"), szAcceptedFee);

	if (pMF->CheckPermission(_T("10.10")) || pMF->GetModuleID() == _T("FM"))
	{
		if (bPreview)
			rpt.PrintPreview();
		else
		{
			rpt.Print(bDirect);
		}
	}
	else
	{
		if (bPreview)
		{
			if ((szObjectType == _T("I") || szObjectType == _T("C")) && (szAcceptedFee != _T("Y")))
			{
				nPrinted = 1;
			}

			if (szObjectType == _T("D") && szStatus != _T("T"))
				nPrinted = 1;

			if (nPrinted > 0 && !pMF->CheckPermission(_T("10.10")))
				rpt.PrintPreview(false);
			else
				rpt.PrintPreview();

		}
		else
		{

			if (nPrinted > 0) {

				CString szMsg;
				szMsg.Format(_T("\x110\x1A1n thu\x1ED1\x63 \x111\xE3 \x111\x1B0\x1EE3\x63 in [%\x64] l\x1EA7n. Kh\xF4ng th\x1EC3 in l\x1EA1i!"), nPrinted);
				ShowMessageBox(szMsg, MB_OK);

				return;
			}
			if (szObjectType == _T("D") && szStatus != _T("T"))
			{
				ShowMessageBox(_T("Patient profile not finish. Cannot allow print prescription"));
				return;
			}

			if ((szObjectType == _T("I") || szObjectType == _T("C")) && (szAcceptedFee != _T("Y")) && pMF->GetModuleID() != _T("FM"))
			{
				ShowMessageBox(_T("\x42\x1EC7nh nh\xE2n \x42HYT \x63h\x1B0\x61 \x64uy\x1EC7t ph\xED. Kh\xF4ng \x111\x1B0\x1EE3\x63 in \x111\x1A1n thu\x1ED1\x63!"));
				return;
			}


			rpt.Print(bDirect);
		}
	}
}

void CPrintForms::OnPrintPhieuLinhMau(long nOrderID)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, tmpStr1, szGroupID, szSex, szStatus;
	CString szReportName, szOrderName;
	CString szSQL;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rs3(&pMF->m_db);
	CRecord rs4(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	CRecord rsal(&pMF->m_db);
	long nPatientNo;
	long nDocumentNo;
	long nsophieu = 0;
	int nRefIndex, nRoomID;
	int nNumberOrder = 0;
	CString tmpStr2, szDeptType, szDeptTypeE, szLastPrintDate;
	CString szFormID;
	CString szCurrentDept;


	szSQL.Format(_T("SELECT hms_testorder.*, NVL(hpc_sample_status, 'Tốt') as sample_status, GET_USERNAME(NGUOILAYMAU) sample_by, to_char(THOIGIANLAYMAU, 'DD/MM/YYYY HH24:MI') sample_date, ") \
		_T(" get_username(NGUOINHANMAU) receive_by, to_char(THOIGIANNHANMAU, 'DD/MM/YYYY HH24:MI') receive_date ") \
		_T(" FROM hms_testorder ") \
		_T(" LEFT JOIN lims_result on (hpc_orderid = SOPHIEU)") \
		_T(" WHERE rownum=1 AND hpc_orderid=%ld "), nOrderID);

	rs.ExecSQL(szSQL);

	if (rs.IsEOF())
		return;

	CString szSID;
	CString szTelephone;
	rs.GetValue(_T("hpc_groupid"), szGroupID);
	rs.GetValue(_T("hpc_docno"), nPatientNo);
	rs.GetValue(_T("hpc_docno"), nDocumentNo);
	rs.GetValue(_T("hpc_refidx"), nRefIndex);
	rs.GetValue(_T("hpc_roomid"), nRoomID);
	rs.GetValue(_T("hpc_status"), szStatus);
	rs.GetValue(_T("hpc_depttype"), szDeptType);
	rs.GetValue(_T("hpc_sid"), szSID);
	rs.GetValue(_T("hpc_deptid"), szCurrentDept);
	rs.GetValue(_T("hpc_lastprintdate"), szLastPrintDate);


	szSQL.Format(_T("SELECT hfg_report as reportname FROM hms_fee_group WHERE hfg_id='%s' "), szGroupID);
	rs2.ExecSQL(szSQL);

	if (!rs2.IsEOF() && szGroupID != _T("B1G00"))
		return;

	szReportName.Format(_T("Reports/HMS/LAB_PHIEULINHMAU_VER1.0.RPT"));

	szReportName.Trim();
	//Neu muon in so trang 1/10, 2/10, 3/10 thi truyen 'true' vao sau ten report

	if (!rpt.Init(szReportName, true))
	{
		return;
	}
	szSQL.Format(_T(" SELECT 	hd_patientno as patientno,  ") \
		_T(" 	hd_docno as docno,") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	CAST(TO_CHAR(hp_birthdate, 'YYYY') as integer) as birthyear,") \
		_T(" 	hp_sex as sexid,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T(" 	hp_occupation as occupationid,") \
		_T(" 	sys_sel_getname('sys_occupation', cast(hp_occupation as varchar(15))) as occupation,") \
		_T(" 	nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T(" 	hms_getaddress(hp_provid,hp_distid,hp_villid) as address,") \
		_T(" 	hp_workplaceid as workplaceid,") \
		_T(" 	hp_workplace as workplace,") \
		_T(" 	hd_object as objectid,") \
		_T(" 	(SELECT ho_desc FROM hms_object WHERE ho_id=hd_object) as objectname,") \
		_T(" 	hd_cardno as cardno,") \
		_T(" 	hd_cardidx as cardidx, ") \
		_T(" 	hd_reldisease as relationdisease, ") \
		_T("	CASE WHEN hcr_recordno is null then trim(hd_diagnostic) ||' ['||trim(hd_icd)||']' else hcr_maindisease end as diagnostic, ") \
		_T("	hcr_maindisease as diagnosticex, ") \
		_T(" 	hc_regdate as regdate, ") \
		_T(" 	hc_expdate as expdate,  ") \
		_T(" hd_telephone as phone, hd_isinpatient, hd_status, hd_suggestion ") \
		_T(" FROM hms_patient") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno)") \
		_T(" LEFT JOIN HMS_CLINICAL_RECORD ON(HCR_PATIENTNO=hp_patientno AND hd_docno = hcr_docno)") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" LEFT JOIN hms_testorder ON (hd_docno = hpc_docno)") \
		_T(" WHERE hpc_docno = %ld AND hpc_orderid=%ld "), pMF->m_nDocumentNo, nOrderID);
	//_msg(_T("%s"), szSQL);
	int ret = rs2.ExecSQL(szSQL);
	if (rs2.IsEOF())
	{
		ShowMessageBox(_T("Patient not found."));
		return;
	}
	//Report Header
	tmpStr.Empty();
	rs2.GetValue(_T("sexid"), szSex);
	StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Sid"), szSID);
	rs2.GetValue(_T("phone"), szTelephone);
	rpt.GetReportHeader()->SetValue(_T("Telephone"), szTelephone);
	rpt.GetReportHeader()->SetValue(_T("sample_status"), rs.GetValue(_T("sample_status")));

	rs.GetValue(_T("hpc_pdeptid"), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		CString szPerformDept;
		StringUpper(pMF->GetDepartmentName(tmpStr), szPerformDept);
		rpt.GetReportHeader()->SetValue(_T("Faculty"), szPerformDept);
	}
	else
		rpt.GetReportHeader()->SetValue(_T("Faculty"), _T(""));


	CString szInPatient, szDocStatus, szSuggestion;
	rs2.GetValue(_T("hd_isinpatient"), szInPatient);
	rs2.GetValue(_T("hd_status"), szDocStatus);
	rs2.GetValue(_T("hd_suggestion"), szSuggestion);
	if (szInPatient == _T("Y") || (szDocStatus == _T("T") && szSuggestion == _T("D")))
	{
		CRecord rsc(&pMF->m_db);
		szSQL.Format(_T("SELECT htr_deptid FROM hms_treatment_record WHERE htr_docno =%ld and htr_status IN('I','A') "), nDocumentNo);
		rsc.ExecSQL(szSQL);
		if (!rsc.IsEOF())
		{
			rsc.GetValue(_T("htr_deptid"), szCurrentDept);
		}
	}

	if (!szCurrentDept.IsEmpty())
	{
		CString szDeptName;
		szDeptName = pMF->GetDepartmentName(szCurrentDept);
		tmpStr.Format(_T("[%s] %s"), szCurrentDept, szDeptName);
		rpt.GetReportHeader()->SetValue(_T("CurrentDept"), tmpStr);
	}
	else
		rpt.GetReportHeader()->SetValue(_T("CurrentDept"), _T(""));

	rpt.GetReportHeader()->SetValue(_T("PatientNo"), nPatientNo);
	rs.GetValue(_T("hpc_docno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);



	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("SheetNo"), tmpStr);
	StringUpper(rs2.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);
	rs2.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);

	//Chi In ra nam sinh.
	rs2.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);
	//	_msg(_T("%s"), tmpStr);
	rs2.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	tmpStr.Format(_T("%s - %s"), rs2.GetValue(_T("detailaddress")), rs2.GetValue(_T("address")));
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);

	rs2.GetValue(_T("objectname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("objectname"), tmpStr);

	rs2.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);

	rs2.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	rs2.GetValue(_T("regdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RegDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	rs2.GetValue(_T("expdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExpiryDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));


	CString szDate;
	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportHeader()->GetValue(_T("OrderDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);

	rs.GetValue(_T("hpc_doctor"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));

	CString szDept;
	CRecord rsd(&pMF->m_db);
	rs.GetValue(_T("hpc_roomid"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Room"), nRoomID);
	rs.GetValue(_T("hpc_deptid"), szDept);
	szSQL.Format(_T("SELECT hrl_name as roomname FROM hms_roomlist WHERE hrl_deptid='%s' AND hrl_id=%d"), szDept, nRoomID);
	rsd.ExecSQL(szSQL);
	if (!rsd.IsEOF())
	{
		rsd.GetValue(_T("roomname"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);
	}

	rs.GetValue(_T("hpc_deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("OrderDept"), pMF->GetDepartmentName(tmpStr));

	rs.GetValue(_T("hpc_bedid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Bed"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("BedName"), _T(""));


	szSQL.Format(_T("SELECT he_prediagnostic as Diagnostic FROM hms_exam WHERE he_docno=%ld AND he_roomid=%d"), nDocumentNo, nRoomID);
	rs3.ExecSQL(szSQL);
	if (!rs3.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs3.GetValue(_T("Diagnostic")));
	}

	rs2.GetValue(_T("diagnostic"), tmpStr);
	rs2.GetValue(_T("diagnosticex"), tmpStr1);


	if (tmpStr.GetLength() > 5)

		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("diagnosticex"), tmpStr1);
	rs2.GetValue(_T("relationdisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("sample_by"), rs.GetValue(_T("sample_by")));
	rpt.GetReportHeader()->SetValue(_T("sample_date"), rs.GetValue(_T("sample_date")));
	rpt.GetReportHeader()->SetValue(_T("RECEIVE_BY"), rs.GetValue(_T("RECEIVE_BY")));
	rpt.GetReportHeader()->SetValue(_T("RECEIVE_DATE"), rs.GetValue(_T("RECEIVE_DATE")));

	//Lấy ra thông tin truyền máu
	szSQL.Format(_T(" SELECT ") \
		_T(" hbo_reason as Lydo,") \
		_T(" HBO_TRANSFUSIONS_NUMBER as SolanTruyen,") \
		_T(" HBO_BLOOD_TYPE as NhomMau") \
		_T(" from hms_blood_order ") \
		_T(" where hbo_orderid=%ld"), nOrderID);
	rsal.ExecSQL(szSQL);
	rpt.GetReportHeader()->SetValue(_T("Lydo"), rsal.GetValue(_T("Lydo")));
	rpt.GetReportHeader()->SetValue(_T("SolanTruyen"), rsal.GetValue(_T("SolanTruyen")));
	rpt.GetReportHeader()->SetValue(_T("NhomMau"), rsal.GetValue(_T("NhomMau")));

	//Đoạn này in ra tên chế phẩm, số lượng //
	szSQL.Format(_T(" SELECT") \
		_T("     mp_product_id as Idx,") \
		_T("     mp_name as Description,") \
		_T("     hbol_qty as Qty,") \
		_T("     cast(ss_vndesc as int) AS limitno,") \
		_T("     cast(ss_vndesc as int)* hbol_qty as total,") \
		_T("     ss_desc as groupid ") \
		_T(" FROM") \
		_T("     hms_blood_orderline left") \
		_T("     JOIN m_product ON ( mp_product_id = hbol_itemid )") \
		_T("     LEFT JOIN sys_sel ON (ss_code=mp_product_id and ss_id='hms_blood_checkvalue')") \
		_T(" WHERE") \
		_T("     hbol_orderid = %ld ") \
		_T(" ORDER BY") \
		_T("     hbol_orderlineid"), nOrderID);
	rsl.ExecSQL(szSQL);

	//_msg(_T("%s"), szSQL);

	CReportSection* rptDetail;
	int nIndex = 0;
	while (!rsl.IsEOF())
	{
		tmpStr.Format(_T("%d"), ++nIndex);
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), tmpStr);
		rptDetail->SetValue(_T("2"), rsl.GetValue(_T("Idx")));
		rptDetail->SetValue(_T("3"), rsl.GetValue(_T("Description")));
		rptDetail->SetValue(_T("4"), rsl.GetValue(_T("Qty")));
		rsl.MoveNext();
	}

	//Page Footer
	//Report Footer

	rs.GetValue(_T("hpc_orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("OrderDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("OrderDate"), szDate);

	rs.GetValue(_T("hpc_doctor"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	rs.GetValue(_T("hpc_performdate"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PerformDate"));
	if (CDateTime::IsValid(tmpStr))
		szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	else
		szDate.Format(tmpStr2, _T("....."), _T("....."), _T("........"));
	rpt.GetReportFooter()->SetValue(_T("PerformDate"), szDate);
	rs.GetValue(_T("hpc_practitioner"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Practitioner"), GetDoctorName(tmpStr));

	rs.GetValue(_T("hpc_lastprintdate"), tmpStr2);
	if (!tmpStr2.IsEmpty())
	{
		tmpStr.Format(rpt.GetReportFooter()->GetValue(_T("last_print_date")),
			CDateTime::Convert(tmpStr2, yyyymmdd | hhmm, ddmmyyyy | hhmm));
	}
	else
	{
		tmpStr.Empty();
	}
	rpt.GetReportFooter()->SetValue(_T("last_print_date"), tmpStr);
	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	rpt.PrintPreview();

}

void CPrintForms::InVongDeoTay(bool bNewborn)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr, szGroupID, szSex, szStatus;
	CString szReportName, szOrderName, szDeptID, szInfo, szFilePath, szFileName;
	CString szSQL;
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db), rsd(&pMF->m_db), rs2(&pMF->m_db);

	long nDocumentNo;
	int nNumberOrder = 0;
	CString tmpStr2, szDeptType;
	CString szFormID;
	if (bNewborn)
	{
	}
	else
	{
		szSQL.Format(_T(" SELECT    Count(*)") \
			_T(" FROM      hms_pharmaorder_view") \
			_T(" left join HMS_PHARMAORDERLINE_VIEW2 ON ( hpo_docno = hpol_docno AND") \
			_T("                                          hpo_orderid = hpol_orderid )") \
			_T(" WHERE     hpo_docno = %ld AND hpol_producttype IN ('A9600', 'A9000') AND hpo_orderstatus = 'A' "),
			pMF->m_nDocumentNo);
		rs.ExecSQL(szSQL);
		//_msg(_T("%s"), szSQL);
		if (rs.GetIntValue() <= 0)
		{
			ShowMessageBox(_T("Bệnh nhân chưa có đơn cấp vòng đeo tay!"));
			return;
		}
	}
	if (bNewborn)
	{
		szSQL.Format(_T(" SELECT    *") \
			_T(" FROM v_vong_deo_tay_so_sinh ") \
			_T(" WHERE DocumentNo = %ld "), pMF->m_nDocumentNo);

	}
	else
	{
		szSQL.Format(_T(" SELECT hd_patientno as mabenhnhan,") \
			_T("   hd_docno as DocumentNo,") \
			_T("   nvl(hd_indept, hd_admitdept) as khoavao,") \
			_T("   trim(hp_surname") \
			_T("   ||' '") \
			_T("   ||hp_midname") \
			_T("   ||' '") \
			_T("   ||hp_firstname) AS pname,") \
			_T("   to_char(hp_birthdate, 'DD/MM/YYYY') as namsinh,") \
			_T("   date_part('year', hp_birthdate) as nam, ") \
			_T("   HMS_GETSEX(hp_sex) as Gender,") \
			_T("   hd_contacttel as phone,  ") \
			_T("   hms_geticdname(hd_icd) as icd")		
			_T(" FROM hms_doc") \
			_T(" LEFT JOIN hms_patient ON (hd_patientno=hp_patientno)") \
			_T(" WHERE hd_docno           =%ld") \
			_T(" AND hd_status  <> 'C' "), pMF->m_nDocumentNo);
	}
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	if (rs.IsEOF())
	{
		return;
	}
	if (bNewborn)
	{
		szFileName = _T("HMS_INVONGDEOTAY_CON");
	}
	else
	{
		szFileName = _T("HMS_INVONGDEOTAY_V2");
	}
	szFilePath.Format(_T("REPORTS/HMS/%s.RPT"), szFileName);
	if (!rpt.Init(szFilePath))
	{
		return;
	}
	//_msg(_T("%s"), szFileName);

	//rs.GetValue(_T("khoavao"), szDeptID);
	//rpt.GetReportHeader()->SetValue(_T("Department"), szDeptID);

	for (int i = 0; i < rs.GetFieldCount(); i++)
	{
		rpt.GetReportHeader()->SetValue(rs.GetFieldName(i), rs.GetValue(i));
	}

	tmpStr.Format(_T("%s %s"), _T("Khoa"), rs.GetValue(_T("khoavao")));
	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

	rs.GetValue(_T("DocumentNo"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);

	/*build qrcode*/
	CMap<CString, LPCTSTR, CString, LPCTSTR> mData;
	CMap<CString, LPCTSTR, CString, LPCTSTR>::CPair* pPair;
	mData[_T("shs")] = rs.GetValue(_T("DocumentNo"));
	mData[_T("ht")] = rs.GetValue(_T("pname"));
	mData[_T("ns")] = rs.GetValue(_T("namsinh"));
	mData[_T("k")] = rs.GetValue(_T("khoavao"));
	mData[_T("gt")] = rs.GetValue(_T("Gender"));
	mData[_T("p")] = rs.GetValue(_T("phone"));
	mData[_T("m")] = rs.GetValue(_T("icd"));
	pPair = mData.PGetFirstAssoc();
	while (pPair != NULL)
	{
		if (!szInfo.IsEmpty())
		{
			szInfo += _T("&");
		}
		szInfo.AppendFormat(_T("%s=%s"), pPair->key, pPair->value);
		pPair = mData.PGetNextAssoc(pPair);
	}
	szInfo.Replace(_T(" "), _T("+"));
	szInfo.Replace(_T("/"), _T("-"));
	tmpStr.Format(_T("https://cntt108.com/nhandienbn/?%s"), szInfo);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);

	/*set value*/
	rs.GetValue(_T("pname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PatientName"), tmpStr);


	rs.GetValue(_T("namsinh"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);



	rs.GetValue(_T("nam"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth1"), tmpStr);

	rs.GetValue(_T("Gender"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Gender"), tmpStr);



	rs.GetValue(_T("phone"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("phone"), tmpStr);

	rs.GetValue(_T("icd"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("icd"), tmpStr);


	//if(bPreview)
	//rpt.PrintPreview();
	//else
	rpt.Print();
}
void CPrintForms::PARA_PrintDrugDelivery(long nOrderID, bool bPreview, bool bDirect)
{
	CMainFrame_E10* pMF = (CMainFrame_E10*)AfxGetMainWnd();
	CReport rpt;
	CString tmpStr;

	//Report Header

	CString szSQL, szUsage, szDeptType;
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	long nDocumentNo;
	int nRefIndex;
	double dblTotalAmount = 0;

	szSQL.Format(_T(" SELECT 	hd_patientno as patientno,  ") \
		_T(" 	hd_docno as docno,") \
		_T(" 	trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname,") \
		_T(" 	TO_CHAR(hp_birthdate, 'YYYY') as birthyear,") \
		_T(" 	hms_getage(trunc_date(hd_admitdate), hp_birthdate) as age,") \
		_T(" 	hp_sex as sexid,") \
		_T(" 	sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T(" 	sys_sel_getname('hms_rank', hp_rank) as rank,") \
		_T(" 	hp_occupation as occupationid,") \
		_T(" 	nvl(hd_dtladdr, hp_dtladdr) as detailaddress,") \
		_T(" 	hms_getaddress(hp_provid,hp_distid, hp_villid) as address,") \
		_T(" 	hp_workplaceid as workplaceid,") \
		_T(" 	hp_workplace as workplace,") \
		_T(" 	hd_object as objectid,") \
		_T(" 	ho_desc as objectname,") \
		_T(" 	ho_type as objecttype,") \
		_T(" 	hd_cardno as cardno,") \
		_T(" 	hd_cardidx as cardidx, ") \
		_T("	hd_reldisease as relationdisease, ") \
		_T("	hd_diagnostic ||' ['||hd_icd||']' as diagnostic, ") \
		_T(" 	hd_status, ") \
		_T(" 	hdf_acceptedfee, ") \
		_T("	trunc_date(hd_admitdate) as examdate, ") \
		_T(" 	hc_regdate as regdate, ") \
		_T(" 	hc_expdate as expdate, ") \
		_T(" 	hpo_orderdate as orderdate, ") \
		_T(" 	hpo_doctor as doctor,GET_USERNAME(hpo_doctor) as doctorname,  ") \
		_T(" 	hpo_storage_id as stockid, ") \
		_T("	GET_STORAGENAME(hpo_storage_id) as stockname	, ") \
		_T(" 	hpo_deptid as deptid, ") \
		_T(" 	hpo_roomid as roomid, ") \
		_T(" 	HMS_GETROOMNAME(hpo_deptid, hpo_roomid)  as roomname, ") \
		_T(" 	hpo_bedid as bedid, ") \
		_T(" 	hpo_depttype as depttype, ") \
		_T(" 	hpo_refidx as refidx, ") \
		_T(" 	hpo_printed as printed ") \
		_T(" FROM HMS_PHARMAORDER_VIEW") \
		_T(" LEFT JOIN hms_patient ON(hp_patientno=hpo_patientno)") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno and hd_docno=hpo_docno)") \
		_T(" LEFT JOIN hms_object ON(ho_id=hd_object) ") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" WHERE hpo_orderid=%ld AND hpo_orderstatus NOT IN('O','C') "), nOrderID);
	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	if (rs.IsEOF())
	{
		_debug(_T("Order not found."));
		return;
	}

	szSQL.Format(_T(" SELECT hpol_line,") \
		_T("   hpol_product_id,") \
		_T("   hpol_productcode,") \
		_T("   hpol_productname,") \
		_T("   hpol_productuom,") \
		_T("   hpol_unitprice,") \
		_T("   SUM(hpol_qtyissue) AS hpol_qtyissue,") \
		_T("   SUM(hpol_qtyissue*hpol_unitprice) AS hpol_amount,") \
		_T("   hpol_productcountry, ") \
		_T(" HMS_GETDOUSAGE(hpol_orderid, hpol_product_id) as hpol_usage ") \
		_T(" FROM HMS_PHARMAORDERLINE_VIEW2") \
		_T(" WHERE hpol_orderid =%ld ") \
		_T(" GROUP BY hpol_orderid, hpol_line,") \
		_T("   hpol_product_id,") \
		_T("   hpol_productcode,") \
		_T("   hpol_productname,") \
		_T("   hpol_productuom,") \
		_T("   hpol_unitprice,") \
		_T("   hpol_productcountry ") \
		_T(" HAVING SUM(hpol_qtyissue) > 0 ")\
		_T(" ORDER BY hpol_productname,hpol_line"), nOrderID);

	rsl.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rsl.IsEOF())
	{

		_debug(_T("\r\nData not found"));
		return;
	}

	CString szReportName;
	szReportName.Format(_T("Reports/HMS/C2_MATERIALDELIVERYVOTE_DV.RPT"));
	if (!rpt.Init(szReportName, false, false, 1))
		return;
	_tprintf(_T("\r\n%s"), szReportName);

	//rpt.SetPrintCallback(_OnCheckPrintPrescriptionFnc);


	/*rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
	rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);*/

	tmpStr.Empty();
	StringUpper(pMF->m_szHealthService, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HealthService"), tmpStr);
	StringUpper(pMF->m_szHospitalName, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), tmpStr);
	rs.GetValue(_T("deptid"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("deptid")));
	rs.GetValue(_T("roomname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("RoomName"), tmpStr);

	rs.GetValue(_T("docno"), nDocumentNo);
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Barcode[128A]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128B]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[128C]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[39]"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Barcode[93]"), tmpStr);

	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("OrderID"), tmpStr);

	CString szPatientName;
	rs.GetValue(_T("pname"), szPatientName);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), szPatientName);
	//In ra tuoi	
	rs.GetValue(_T("age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	//Chi In ra nam sinh.
	rs.GetValue(_T("birthyear"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("YearOfBirth"), tmpStr);

	rs.GetValue(_T("sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);
	rs.GetValue(_T("address"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);
	rs.GetValue(_T("workplace"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Workplace"), tmpStr);
	rs.GetValue(_T("objectname"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Object"), tmpStr);

	rs.GetValue(_T("examdate"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("ExamDate"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));

	rs.GetValue(_T("rank"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Rank"), tmpStr);

	rs.GetValue(_T("cardno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	int nStockId;
	rs.GetValue(_T("stockname"), tmpStr);


	rpt.GetReportHeader()->SetValue(_T("Stock"), (tmpStr));
	//	rs.GetValue(_T("refidx"), nRefIndex);
	//	rs.GetValue(_T("roomid"), m_nRoomID);
	//tmpStr.Format(_T("%d"), m_nRoomID);
	rpt.GetReportHeader()->SetValue(_T("RoomID"), tmpStr);
	rs.GetValue(_T("bedid"), tmpStr);
	rs.GetValue(_T("depttype"), szDeptType);
	szDeptType.Trim();


	szSQL.Format(_T("SELECT hcr_mainicd as Icd,hcr_maindisease || ' [' || hcr_mainicd || ']' as Diagnostic, hcr_reldisease as reldisease FROM hms_clinical_record WHERE hcr_docno=%ld "), nDocumentNo);
	rs2.ExecSQL(szSQL);

	if (!rs2.IsEOF())
	{
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs2.GetValue(_T("Diagnostic")));

	}
	else
	{
		rs.GetValue(_T("Diagnostic"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	}
	rs2.GetValue(_T("reldisease"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("relationdisease"), tmpStr);

	//Page Header
	//Report Detail
	CReportSection* rptDetail = rpt.GetDetail(0);
	int nItem = 1;

	CString szWhere, tmpStr2, szQty;

	nItem = 1;
	dblTotalAmount = 0;
	double money = 0;
	while (!rsl.IsEOF())
	{
		rptDetail = rpt.AddDetail();
		rsl.GetValue(_T("hpol_usage"), szUsage);

		rsl.GetValue(_T("hpol_amount"), money);
		dblTotalAmount += money;
		tmpStr.Format(_T("%d"), nItem++);
		rptDetail->SetValue(_T("1"), tmpStr);
		rsl.GetValue(_T("hpol_productname"), tmpStr);
		rptDetail->SetValue(_T("2"), tmpStr);
		rsl.GetValue(_T("hpol_productuom"), tmpStr);
		rptDetail->SetValue(_T("3"), tmpStr);
		rsl.GetValue(_T("hpol_qtyissue"), tmpStr);
		rptDetail->SetValue(_T("4"), tmpStr);
		rptDetail->SetValue(_T("4.1"), _T(""));

		rsl.GetValue(_T("hpol_unitprice"), tmpStr);
		FormatCurrencyStr(tmpStr, tmpStr);
		rptDetail->SetValue(_T("5"), tmpStr);
		rsl.GetValue(_T("hpol_amount"), tmpStr);
		FormatCurrencyStr(tmpStr, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);
		rsl.GetValue(_T("hpol_productcountry"), tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);
		rsl.MoveNext();
	}

	//Page Footer
	//Report Footer
	CString tmpVal;
	tmpStr.Format(_T("%d"), nItem - 1);
	rpt.GetReportFooter()->SetValue(_T("TotalItem"), tmpStr);
	FormatCurrency(dblTotalAmount, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	tmpVal.Format(_T("%2.f"), dblTotalAmount);
	MoneyToString(tmpVal, tmpStr);
#ifdef UNICODE
	rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr + _T(" \x111\x1ED3ng"));
#endif
	CString szDate;
	//rs.GetValue(_T("orderdate"), tmpStr);

	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);


	rpt.GetReportFooter()->SetValue(_T("PatientSign"), szPatientName);

	rs.GetValue(_T("doctor"), tmpStr);

	/*rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(tmpStr));
	CReportItem *img = rpt.GetReportFooter()->GetItem(_T("Signature"));
	if(img)
	{
		img->SetHBITMAP(pMF->GetSignatureImage(tmpStr));
		img->SetFixedHeight(false);
	}*/

	//rpt.GetReportFooter()->SetValue(_T("IssueBy"), pMF->GetDoctorName(GetCurrentUser()));
	CString szStatus;
	CString szAcceptedFee;
	CString szObjectType;
	int nPrinted = 0;

	rs.GetValue(_T("hd_status"), szStatus);
	rs.GetValue(_T("objecttype"), szObjectType);
	rs.GetValue(_T("printed"), nPrinted);
	rs.GetValue(_T("hd_acceptedfee"), szAcceptedFee);

	//if(CheckPermission(_T("10.10")))
	//{
	//	if(bPreview)
	//		rpt.PrintPreview();
	//	else
	//	{
	//		rpt.Print(bDirect);		
	//	}
	//}
	//else
	//{
	//	if(bPreview)
	//	{
	//		if((szObjectType == _T("I") || szObjectType == _T("C")) && (szAcceptedFee != _T("Y")) )
	//		{
	//			nPrinted = 1;
	//		}

	//		if(szObjectType == _T("D") && szStatus != _T("T"))
	//			nPrinted = 1;

	//		if(nPrinted > 0 && !CheckPermission(_T("10.10")))
	//			rpt.PrintPreview(false);
	//		else
	//			rpt.PrintPreview();

	//	}
	//	else
	//	{
	//		
	//		if(nPrinted > 0){
	//			
	//			CString szMsg;
	//			szMsg.Format(_T("\x110\x1A1n thu\x1ED1\x63 \x111\xE3 \x111\x1B0\x1EE3\x63 in [%\x64] l\x1EA7n. Kh\xF4ng th\x1EC3 in l\x1EA1i!"), nPrinted);
	//			ShowMessageBox(szMsg, MB_OK);

	//			return;
	//		}
	//		if(szObjectType == _T("D") && szStatus != _T("T"))
	//		{
	//			ShowMessageBox(_T("Patient profile not finish. Cannot allow print prescription"));
	//			return;
	//		}

	//		if((szObjectType == _T("I") || szObjectType == _T("C")) && (szAcceptedFee != _T("Y"))  && GetModuleID() != _T("FM") )
	//		{
	//			ShowMessageBox(_T("\x42\x1EC7nh nh\xE2n \x42HYT \x63h\x1B0\x61 \x64uy\x1EC7t ph\xED. Kh\xF4ng \x111\x1B0\x1EE3\x63 in \x111\x1A1n thu\x1ED1\x63!"));
	//			return;
	//		}
	//		

	//		rpt.Print(bDirect);		
	//	}
	//}

	rpt.PrintPreview(true);
}
void CPrintForms::PrintMedicalFile_Cancer_2(CStringArray& info, bool bPreview)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CRecord rs2(&pMF->m_db);
	CReport rpt;
	CReportSection* rptHeader = NULL, * rptGrpHeader = NULL;
	long nDocumentNo = str2long(info[0]);
	CString szDept = info[1];
	CString szHealthService = info[2];
	CString szHospitalName = info[3];
	CString szCancer = info[4];
	int nTreatTime = str2int(info[5]);
	int nCancerTime = str2int(info[6]);
	CString szForm = info[7];

	if (nDocumentNo <= 0)
		return;
	CString szSQL, tmpStr, tmpStr2, szReportName, szTemp, szNumber, szFoodMode, szDate, szPTTYCDept, tmpStr1, szTitle;

	szSQL.Format(_T(" SELECT htr_ward FROM hms_treatment_record WHERE htr_docno = %ld AND rownum = 1 "), nDocumentNo);
	rs.ExecSQL(szSQL);
	rs.GetValue(_T("htr_ward"), szPTTYCDept);
	if (szPTTYCDept == _T(""))
	{
		szPTTYCDept.AppendFormat(_T("%s"), szDept);
	}
	else
	{
		szPTTYCDept.AppendFormat(_T(" - %s"), szDept);
	}
	szSQL.Format(_T(" SELECT hp_patientno as patientno, trim(hp_surname||' '||hp_midname||' '||hp_firstname) as pname, ") \
		_T("        extract(year from hp_birthdate) as yob, ") \
		_T("		case when hfe_amount > 0 and hfe_date > hd_enddate then 'Y' else 'N' end AS checkstt, ") \
		_T("        (select ss_desc from sys_sel where ss_id= 'sys_sex' and ss_code =  hp_sex) as sex, ") \
		_T("        (select ss_desc from sys_sel where ss_id ='hms_rank' and cast(ss_code as integer)=hp_rank) as rank, ") \
		_T("        (select ss_desc from sys_sel where ss_id ='hms_position' and cast(ss_code as integer)=hp_position) as position, ") \
		_T("        hp_workplace as unit, ") \
		_T("        hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) as address, ") \
		_T("        nvl(hd_dtladdr, hp_dtladdr) as dtladdress, ") \
		_T("        hd_relative as relative, ") \
		_T("        (select ss_desc from sys_sel where ss_id = 'hrm_relation' and ss_code = hd_relation) as relation, ") \
		_T("        hd_contactaddr as reladdress, ") \
		_T("        hd_contacttel as relphone, ") \
		_T("        hd_transdiagn as trdisease, ") \
		_T("        (select hi_name from hms_icd where hi_icd=hd_transicd) as icd10, ") \
		_T("        hd_conclusion as disease, ") \
		_T("        hd_suggestion as suggestion, ") \
		_T("        trunc(hd_admitdate) as examdte, ") \
		_T("		CASE WHEN hcr_cancer = 'Y' THEN (select min(htr_admitdate) from hms_treatment_record where htr_docno=hcr_docno AND htr_treattime = %d)  ") \
		_T("        ELSE hcr_admitdate END as admitdate,") \
		_T("        hd_indept as deptid, ") \
		_T("        (select sd_name from sys_dept where sd_id=hcr_admitdept) as facname, ") \
		_T("        hcr_recordno as numinward, hcr_treattime as inwardtime, ") \
		_T("        hcr_foodmode as foodmode, ") \
		_T("        (select ho_desc from hms_object where ho_id=hd_object) as policydesc, ") \
		_T("        (select hc_cardno from hms_card where hc_patientno=hd_patientno and hc_idx=hd_cardidx) as cardno, ") \
		_T("  hcr_cancer, ") \
		_T("  hcr_cancer_time, ") \
		_T("   case when NVL(HD_INSLINE, 'N') = 'Y' AND NVL(HD_EMERGENCY,'N')='N' THEN HC_DISCOUNT*(select HMS_INSOFFLINE from hms_config)/100 else cast(hd_disrate as integer) end as disrate, ") \
		_T("  hd_emergency, ") \
		_T("   hcr_dischargedate,") \
		_T("   hcr_sumtreat,") \
		_T("   hcr_result,") \
		_T("   case when hcr_status='T' then hcr_maindisease else cast('' as nvarchar2(254)) end as maindisease, ") \
		_T("   hcr_conclusion") \
		_T(" FROM hms_patient ") \
		_T(" LEFT JOIN hms_doc ON(hd_patientno=hp_patientno) ") \
		_T(" LEFT JOIN hms_card ON(hc_patientno=hd_patientno AND hc_idx=hd_cardidx) ") \
		_T(" LEFT JOIN hms_clinical_record ON(hcr_docno=hd_docno) ") \
		_T(" LEFT JOIN hms_fee_deposit ON(hfe_patientno = hp_patientno AND hfe_docno = hd_docno) ") \
		_T(" WHERE hd_docno=%ld and hd_status in('P','T') and rownum < 2"), nTreatTime, nDocumentNo);
	//_msg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		ShowMessageBox(_T("Patient not found"));
		return;
	}

	if (szCancer == _T("Y"))
	{
		if (nCancerTime > 1)
		{
			szReportName.Format(_T("Reports\\HMS\\BENHAN\\BENHANUNGTHU_TULAN2_TROLEN.RPT"));
		}
	}

	if (!rpt.Init(szReportName))
	{
		return;
	}

	CString szExportFile;
	CString szPatientName = pMF->GetProp(L"patient_name");
	TCHAR szName[128];
	UnMarkString(szPatientName, szName);
	szExportFile.Format(L"%ld_%s_%s", nDocumentNo, szName, pMF->m_szDeptID);
	rpt.SetExportFile(szExportFile);



	rpt.GetReportHeader()->SetValue(_T("_health_service"), szHealthService);
	rpt.GetReportHeader()->SetValue(_T("_HOSPITAL_NAME"), pMF->m_szHospitalName);

	if (pMF->GetCurrentDepartmentID() == _T("PTTYC"))
	{
		rpt.GetReportHeader()->SetValue(_T("_faculty_name"), szPTTYCDept);
	}
	else
		rpt.GetReportHeader()->SetValue(_T("_faculty_name"), pMF->GetDepartmentName(szDept));

	StringUpper(rs.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_name"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_y_of_birth"), rs.GetValue(_T("yob")));
	rpt.GetReportHeader()->SetValue(_T("_sex"), rs.GetValue(_T("sex")));
	if (rs.GetValue(_T("checkstt")) == _T("Y"))
	{
		rpt.GetReportHeader()->SetValue(_T("DaNopTamGui"), _T("\x110\xE3 n\x1ED9p t\x1EA1m g\x1EEDi"));
	}
	tmpStr.Format(_T("%s"), rs.GetValue(_T("dtladdress")));
	if (!tmpStr.IsEmpty())
		tmpStr.AppendFormat(_T(" - "));
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("address")));
	rpt.GetReportHeader()->SetValue(_T("_native_vill"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_unit"), rs.GetValue(_T("unit")));
	rpt.GetReportHeader()->SetValue(_T("_rank"), rs.GetValue(_T("rank")));
	rpt.GetReportHeader()->SetValue(_T("_position"), rs.GetValue(_T("position")));
	rs.GetValue(_T("examdte"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_infect_date"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
	tmpStr.Format(_T("%s"), CDateTime::Convert(rs.GetValue(_T("admitdate")), yyyymmdd | hhmmss, ddmmyyyy | hhmmss));
	rpt.GetReportHeader()->SetValue(_T("_enter_date"), tmpStr);
	szTemp = rs.GetValue(_T("suggestion"));
	tmpStr.Empty();
	CString szRecordNo;
	szTemp = rs.GetValue(_T("numinward"));
	szRecordNo = szTemp;

	if (szTemp == _T("0"))
		tmpStr.Empty();
	else
		tmpStr += szTemp;
	rpt.GetReportHeader()->GetItem(_T("_number"))->SetFaceSize(9);

	if (szCancer == _T("Y"))
	{
		tmpStr.AppendFormat(_T(" - %.3dK"), nCancerTime);
	}

	rpt.GetReportHeader()->SetValue(_T("_number"), tmpStr);
	if (nCancerTime > 1)
	{
		tmpStr.Format(rpt.GetReportHeader()->GetValue(_T("ReportTitle")), nCancerTime);
		rpt.GetReportHeader()->SetValue(_T("ReportTitle"), tmpStr);

	}
	rs.GetValue(_T("inwardtime"), tmpStr);
	if (tmpStr == _T("0"))
		tmpStr.Empty();
	if (szCancer == _T("Y"))
	{
		tmpStr.Format(_T("%d"), nCancerTime);
	}
	rpt.GetReportHeader()->SetValue(_T("_times"), tmpStr);

	long nPatientNo;
	rs.GetValue(_T("patientno"), nPatientNo);
	tmpStr.Format(_T("%d"), nPatientNo);
	rpt.GetReportHeader()->SetValue(_T("_patientno"), tmpStr);

	tmpStr.Format(_T("%d"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("_docno"), tmpStr);
	tmpStr.Format(_T("%s"), rs.GetValue(_T("policydesc")));
	rpt.GetReportHeader()->SetValue(_T("_policydesc"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("_relatives"), rs.GetValue(_T("relative")));
	rpt.GetReportHeader()->SetValue(_T("_relation"), rs.GetValue(_T("relation")));

	rpt.GetReportHeader()->SetValue(_T("_phone"), rs.GetValue(_T("relphone")));
	rpt.GetReportHeader()->SetValue(_T("_address"), rs.GetValue(_T("reladdress")));
	rpt.GetReportHeader()->SetValue(_T("_unit_diag.1"), rs.GetValue(_T("trdisease")));

	tmpStr.Format(_T("%s\r\n%s"), rs.GetValue(_T("icd10")), rs.GetValue(_T("disease")));
	rpt.GetReportHeader()->SetValue(_T("_exam_diag.1"), tmpStr);

	rs.GetValue(_T("hcr_dischargedate"), tmpStr);
	if (!tmpStr.IsEmpty())
		rpt.GetReportHeader()->SetValue(_T("ngayravien"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("songaydt"), rs.GetValue(_T("hcr_sumtreat")));

	rs.GetValue(_T("hcr_result"), tmpStr);

	if (tmpStr == _T("1"))
		rpt.GetReportHeader()->SetValue(_T("ov2"), _T("X"));
	if (tmpStr == _T("2"))
		rpt.GetReportHeader()->SetValue(_T("ov3"), _T("X"));
	if (tmpStr == _T("5") || tmpStr == _T("6"))
	{
		rpt.GetReportHeader()->SetValue(_T("ov4"), _T("X"));
		rpt.GetReportHeader()->SetValue(_T("chandoantuvong"), rs.GetValue(_T("hcr_conclusion")));
	}
	if (tmpStr == _T("7"))
		rpt.GetReportHeader()->SetValue(_T("ov5"), _T("X"));

	rpt.GetReportHeader()->SetValue(_T("chandoanravien"), rs.GetValue(_T("maindisease")));

	CReportSection* rptDtl = rpt.GetDetail();
	rptDtl = rpt.AddDetail(rpt.GetGroupFooter(1));
	//rptDtl->SetPageBreak(true);

	tmpStr.Empty();
	rs.GetValue(_T("cardno"), tmpStr);
	if (!tmpStr.IsEmpty())
	{
		CString szCardDesc;

		szCardDesc.Format(_T("S\x1ED1 th\x1EBB: %s"), tmpStr);
		rpt.GetReportHeader()->SetValue(_T("_cardno"), szCardDesc);
	}

	tmpStr = pMF->GetSysTime();
	CReportItem* obj = NULL;
	obj = rpt.GetReportHeader()->GetItem(_T("_foodmode"));
	if (obj)
		obj->SetFixedHeight(false);
	rpt.GetReportHeader()->SetValue(_T("_foodmode"), szFoodMode);
	rpt.GetReportFooter()->Format(_T("PrintDate"), _T(""), _T("...."), _T("...."), _T("...."));

	rs.GetValue(_T("hd_emergency"), szTemp);
	if (szTemp == _T("Y"))
		rpt.GetReportHeader()->SetValue(_T("_emergency"), _T("X"));

	int nDisrate;
	rs.GetValue(_T("disrate"), nDisrate);
	if (nDisrate > 0)
		tmpStr.Format(_T("%d%s"), nDisrate, _T("%"));
	else
		tmpStr.Empty();
	rpt.GetReportHeader()->SetValue(_T("_disrate"), tmpStr);


	CRecord rsl(&pMF->m_db);
	CString szExamInfo;
	CReportSection* rptDetail = rpt.GetDetail(0);
	JSONVALUE jData;
	CString szFilter;
	CString szWhere;
	if (nTreatTime <= 1)
		szWhere.Format(_T(" and (hde_treattime=%d or hde_treattime=0) "), nTreatTime);
	else
		szWhere.Format(_T(" and (hde_treattime=%d ) "), nTreatTime);


	if (szCancer == _T("Y") && nCancerTime > 1)
	{
		//Load thong tin ket luan benh an ung thu lan 2
		szExamInfo.Empty();

		CString szFilter;
		//and hde_refidx=%d ,nHtrIdx
		//szFilter.Format(_T(" and hde_roomid=%d "), nCancerTime);
		szFilter.Empty();
		/*TH nhiều BA trong cùng 1 đợt điều trị*/
		szFilter.Format(_T(" and hde_deptid = '%s'")
			, pMF->GetCurrentDepartmentID());

		bool res = pMF->GetEMRData(nDocumentNo, nTreatTime, _T("BENH_AN_KL_UTTL2"), szRecordNo, szFilter, szExamInfo);
		if (!res)
		{
			//Truong hơp dữ liệu cũ
			szSQL.Format(_T("SELECT to_char(hde_value) as hde_value, hde_createdby FROM hms_doc_emr ") \
				_T(" WHERE hde_docno=%ld and hde_type IN('BENH_AN_KL_UTTL2') ") \
				_T(" %s ") \
				_T(" ORDER BY hde_type, hde_refidx "), nDocumentNo, szWhere);
			szExamInfo.Empty();
			rsl.ExecSQL(szSQL);
			while (!rsl.IsEOF())
			{
				rsl.GetValue(_T("hde_value"), tmpStr);
				szExamInfo.AppendFormat(_T("%s"), tmpStr);
				rsl.MoveNext();
			}
		}

		if (!szExamInfo.IsEmpty())
		{
			jData.Clear();
			jData.Parse(szExamInfo);
			tmpStr.Empty();
			tmpStr2.Empty();

			jData[_T("kham_benh")].GetValue(tmpStr);
			rptGrpHeader = rpt.AddDetail(rpt.GetGroupHeader(1));
			if (rptGrpHeader)
			{
				rptGrpHeader->SetValue(_T("kham_benh"), tmpStr);
			}

			jData[_T("danh_gia_ket_qua")].GetValue(tmpStr);
			rptGrpHeader = rpt.AddDetail(rpt.GetGroupHeader(2));
			if (rptGrpHeader)
			{
				rptGrpHeader->SetValue(_T("danh_gia_ket_qua"), tmpStr);
			}
			jData[_T("chan_doan")].GetValue(tmpStr);
			rptGrpHeader = rpt.AddDetail(rpt.GetGroupHeader(3));
			if (rptGrpHeader)
			{
				rptGrpHeader->SetValue(_T("chan_doan"), tmpStr);
			}

			jData[_T("ke_hoach_xet_nghiem")].GetValue(tmpStr);
			rptGrpHeader = rpt.AddDetail(rpt.GetGroupHeader(4));
			if (rptGrpHeader)
			{
				rptGrpHeader->SetValue(_T("ke_hoach_xet_nghiem"), tmpStr);
			}

			jData[_T("ke_hoach_dieu_tri")].GetValue(tmpStr);
			rptGrpHeader = rpt.AddDetail(rpt.GetGroupHeader(5));
			if (rptGrpHeader)
			{
				rptGrpHeader->SetValue(_T("ke_hoach_dieu_tri"), tmpStr);
			}

			jData[_T("tien_luong")].GetValue(tmpStr);
			rptGrpHeader = rpt.AddDetail(rpt.GetGroupHeader(6));
			if (rptGrpHeader)
			{
				rptGrpHeader->SetValue(_T("tien_luong"), tmpStr);
			}
		}
	}

	//Load thong tin kham benh
	szExamInfo.Empty();
	//szFilter.Format(_T(" and hde_refidx=%d  "), nHtrIdx);
	szFilter.Empty();
	bool res = pMF->GetEMRData(nDocumentNo, nTreatTime, _T("BENH_AN_KB"), szRecordNo, szFilter, szExamInfo);
	if (!res)
	{

		szSQL.Format(_T("SELECT to_char(hde_value) as hde_value FROM hms_doc_emr ") \
			_T(" WHERE hde_docno=%ld and hde_type IN('BENH_AN_KB') ") \
			_T(" %s ") \
			_T(" ORDER BY hde_type, hde_refidx "), nDocumentNo, szWhere);
		rsl.ExecSQL(szSQL);
		while (!rsl.IsEOF())
		{
			rsl.GetValue(_T("hde_value"), tmpStr);
			szExamInfo.AppendFormat(_T("%s"), tmpStr);
			rsl.MoveNext();
		}

	}

	if (!szExamInfo.IsEmpty())
	{
		if (szCancer == _T("Y") && nCancerTime > 1)

		{
			jData.Clear();
			jData.Parse(szExamInfo);
			tmpStr.Empty();

			jData[_T("toan_than")].GetValue(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("toan_than"), tmpStr);

			int n = 0;
			jData[_T("mach")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);
			rpt.GetReportHeader()->SetValue(_T("mach"), tmpStr);

			float nd = 0;
			jData[_T("nhiet_do")].GetValue(nd);
			tmpStr.Empty();
			if (nd > 0)
				tmpStr.Format(_T("%.2f"), nd);
			rpt.GetReportHeader()->SetValue(_T("nhiet_do"), tmpStr);

			n = 0;
			jData[_T("huyet_ap")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);

			rpt.GetReportHeader()->SetValue(_T("huyet_ap"), tmpStr);

			n = 0;
			jData[_T("huyet_ap2")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);

			rpt.GetReportHeader()->SetValue(_T("huyet_ap2"), tmpStr);

			n = 0;
			jData[_T("nhip_tho")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);
			rpt.GetReportHeader()->SetValue(_T("nhip_tho"), tmpStr);

			n = 0;
			jData[_T("chieu_cao")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);
			rpt.GetReportHeader()->SetValue(_T("chieu_cao"), tmpStr);

			n = 0;
			jData[_T("can_nang")].GetValue(n);
			tmpStr.Empty();
			if (n > 0)
				tmpStr.Format(_T("%d"), n);
			rpt.GetReportHeader()->SetValue(_T("can_nang"), tmpStr);

			jData[_T("dinh_duong")].GetValue(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("dinhduong"), tmpStr);
		}
	}
	if (bPreview)
		rpt.PrintPreview();
	else
		rpt.Print();

}
void CPrintForms::PrintDDO2_ATDEPT(long nOID, bool bPreviewOnly)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();//mainFramePointer//pGuiMnFrm//UDT:MF=MainFrame, rs=RecordSet, p=Pointer, tmp=temp 
	CReport rpt;
	CRecord rsReport(&pMF->m_db);//tmpRecord//tmpRec
	CRecord rs(&pMF->m_db);//transactionRecord//transactionRecd//trsactionRecord//tstRcd
	CRecord rs2(&pMF->m_db);//itemRecord
	CRecord rst(&pMF->m_db);//typeSortRecord
	CRecord rsp(&pMF->m_db);//qtyPsychoRecord
	CString szGroup, szTitle, szNote;
	CString tmpStr, tmpStr2, szDate, szSQL, szDesc, szOrderBy, szStorageCategory, szOrderType;//orderTypeStr, storageCategoryStr(storgCatgryStr, stoCat),
	//orderByStr, tmpStr2, tmpStr, sqlStr
	int nStorage_id = 0, nBreak = 0;//int storageIndex = 0;
	CString szID;
	long nProductID = 0, nProductItemID = 0;//productIndex, productItemIndex

	szID.Format(_T("%ld"), nOID);

	double	nTotalAmount = 0, nAmount = 0, nAmountServ = 0, nTotalAmountServ = 0;//amountTotal, amountServiceTotal//amntServcTotal//amntServTotal//amountServiceTotl
	int		nQty, nTotalItem = 1;//itemCount 
	//int		nPrint=0;
	//bool bDirect = false;

	szOrderBy.Format(_T(" ORDER BY name, unit, price "));
	szSQL.Format(_T(" SELECT distinct mt_orderno, ") \
		_T("        mt_orderdate, ") \
		_T("        mt_approveddate, ") \
		_T("        mt_postedby, ") \
		_T("        mt_storage_id, ") \
		_T("        Get_storagename(mt_storage_id)          AS mt_storage_name, ") \
		_T("        Get_storagename(mt_storage_to_id)       AS mt_storageto_name, ") \
		_T("        Get_departmentname(mt_department_id)    AS mt_department_name, ") \
		_T("        Get_departmentname(mt_department_to_id) AS mt_departmentto_name, ") \
		_T("        mt_doctype, ") \
		_T("        mt_description, ") \
		_T("		mt_objecttype, ")
		_T("		hpo_ordertype, mt_documentno, mtb_ordertype,  ") \
		_T("		mt_status as status, ") \
		_T("		get_syssel_desc('HMS_TREAT_ZONE', mt_zone) as zone,") \
		_T("		(select count(*) from hms_ipharmaorder ") \
		_T("		where hpo_transaction_id = mt_transaction_id and hpo_orderstatus not in ('O', 'C')) ") \
		_T("		as so_phieu") \
		_T(" FROM   m_transaction ") \
		_T(" LEFT JOIN m_transaction_batch ON(mtb_orderno = mt_orderno) ") \
		_T(" LEFT JOIN hms_ipharmaorder ON (mt_doctype = 'DMO' AND hpo_transaction_id = mt_transaction_id)") \
		_T(" WHERE  mt_transaction_id = %ld ") \
		_T(" AND mt_status NOT IN ('O', 'C')"), nOID);

	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
		return;
	if (rs.GetValue(_T("status")) == _T("A"))
	{
		ShowMessageBox(_T("Phiếu trạng thái đã duyệt. Tới khoa cấp phát để in lại!"));
		//return;
	}
	CString szType, szReportName, szSendBy, szObjectType;//reportNameStr, sendByStr, objectTypeStr
	CString szOrderCategory;

	rs.GetValue(_T("mt_doctype"), szType);
	rs.GetValue(_T("mt_orderno"), szID);
	rs.GetValue(_T("hpo_ordertype"), szOrderType);
	if (szType == _T("DPO") || szType == _T("DMO") || szType == _T("CSO"))
	{
		szOrderBy.Format(_T(" ORDER BY product_uomindex, product_name, product_uomname "));
	}
	else if (szType == _T("DDO"))
	{
		szOrderBy.Format(_T(" ORDER BY product_name, product_uomname "));
	}
	rs.GetValue(_T("mt_postedby"), szSendBy);
	rs.GetValue(_T("mt_description"), szDesc);

	rs.GetValue(_T("mt_storage_id"), nStorage_id);
	rs.GetValue(_T("mt_objecttype"), szObjectType);


	//Kiem tra kho dich vu
	if (szObjectType == _T("S"))
		szStorageCategory = _T("S");
	else
	{
		szSQL.Format(_T("SELECT msl_category category FROM m_storagelist WHERE msl_storage_id = %d"), nStorage_id);
		rsReport.ExecSQL(szSQL);
		rsReport.GetValue(_T("category"), szStorageCategory);
	}
	rs.GetValue(_T("mtb_ordertype"), szOrderCategory);



	if (szType == _T("DPO") || szType == _T("DMO") || szType == _T("DDO") || szType == _T("CSO"))
	{
		szSQL.Format(_T(" SELECT DISTINCT pmdt_name,") \
			_T("   pmdt_desc,") \
			_T("   pmdt_reportname, pmdt_index, pmdt_printtype  ") \
			_T(" FROM pms_drugtype,") \
			_T("   m_transactionline,") \
			_T("   m_productitem_view") \
			_T(" WHERE mtl_transaction_id =%ld") \
			_T(" AND mtl_product_item_id  =product_item_id") \
			_T(" AND instr(pmdt_desc, product_producttype) > 0") \
			_T(" ORDER BY pmdt_index "), nOID);
		rst.ExecSQL(szSQL);
		//_msg(_T("%s"), szSQL);
		while (!rst.IsEOF())
		{
			rst.GetValue(_T("pmdt_name"), tmpStr);
			StringUpper(tmpStr, szTitle);
			rst.GetValue(_T("pmdt_desc"), szGroup);
			szGroup.Trim();

			rst.GetValue(_T("pmdt_reportname"), tmpStr);
			//_msg(_T("%s"), szStorageCategory);
			if (!tmpStr.IsEmpty())
				if (szStorageCategory == _T("S"))
					szReportName.Format(_T("Reports/HMS/%sDV.RPT"), tmpStr);
				else
					szReportName.Format(_T("Reports/HMS/%s.RPT"), tmpStr);

			if (!rpt.Init(szReportName))
				return;
			rpt.GetReportHeader()->SetValue(_T("so_phieu"), rs.GetValue(_T("so_phieu")));
			rpt.GetReportHeader()->SetValue(_T("Zone"), rs.GetValue(_T("zone")));
			//Report Header
			rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
			rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
			if (szStorageCategory != _T("S"))
				rpt.GetReportHeader()->Format(_T("TITLE"), szTitle);
			rs.GetValue(_T("mt_orderdate"), tmpStr);
			szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);
			rpt.GetReportHeader()->SetValue(_T("OrderID"), szID);
			if (szOrderType == _T("M"))
				rpt.GetReportHeader()->SetValue(_T("Purpose"), _T("\x44\xE0nh \x63ho \x63\xE1\x63 \x63\x61 ph\x1EABu thu\x1EADt, th\x1EE7 thu\x1EADt"));
			rs.GetValue(_T("mt_statusdesc"), tmpStr);
			//tmpStr = GetStatusString(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
			rs.GetValue(_T("mt_storage_name"), tmpStr);
			//tmpStr = GetStorageName(ToInt(tmpStr));
			rpt.GetReportHeader()->SetValue(_T("FromStock"), tmpStr);
			rpt.GetReportHeader()->SetValue(_T("Comment"), szDesc);

			rs.GetValue(_T("mt_storageto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("ToStock"), tmpStr);

			rs.GetValue(_T("mt_department_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

			rs.GetValue(_T("mt_departmentto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("DepartmentTo"), tmpStr);
			tmpStr.Empty();
			rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

			if (pMF->GetModuleID() == _T("MA"))
			{
				rs.GetValue(_T("mt_documentno"), tmpStr);
				rpt.GetReportHeader()->SetValue(_T("ReferenceNo"), tmpStr);
			}

			if (szOrderCategory == _T("C"))
			{
				rpt.GetReportHeader()->SetValue(_T("OrderCategory"), _T("Phiếu lĩnh thuốc, hóa chất pha chế"));
			}
			else
			{
				rpt.GetReportHeader()->SetValue(_T("OrderCategory"), _T(""));
			}

			//*?Lay gia ban tu line thuoc
			//Page Header
			//Report Detail
			if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
				szSQL.Format(_T(" SELECT product_id                             AS id, ") \
					_T("		product_item_id item_id,") \
					_T("        product_name                           AS name, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					_T("        Sum(mtl_qtyservice)                    AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        mtl_saleprice                      AS price, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount, ") \
					_T("        product_expdate                        AS expdate ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  mtl_transaction_id = %ld ") \
					_T("        AND product_producttype NOT IN('A1130', 'A1140') ") \
					_T("        AND product_producttype  NOT IN (select ss_code from sys_sel WHERE ss_id='nhom_phieulinh') ") \
					_T(" GROUP  BY product_id, ") \
					_T("		   product_item_id,") \
					_T("           product_name, ") \
					_T("           product_uomname, ") \
					_T("		   mtl_saleprice,") \
					_T("           product_uomindex,product_expdate ") \
					_T("		   %s "), nOID, szOrderBy);
			else
				szSQL.Format(_T(" SELECT product_id                AS id, ") \
					_T("		product_item_id                        AS item_id, ") \
					_T("        product_name                           AS name, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					_T("        Sum(mtl_qtyservice)                    AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        mtl_saleprice                      AS price, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount, ") \
					_T("        product_lotno                          AS lotno, ") \
					_T("        product_expdate                        AS expdate ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  mtl_transaction_id = %ld ") \
					_T("        AND product_producttype IN(%s) ") \
					_T("        AND product_producttype  NOT IN (select ss_code from sys_sel WHERE ss_id='nhom_phieulinh') ") \
					_T(" GROUP  BY product_id, ") \
					_T("		   product_item_id,") \
					_T("           product_name, ") \
					_T("           product_uomname, ") \
					_T("           mtl_saleprice, ") \
					_T("           product_uomindex, ") \
					_T("           product_lotno, ") \
					_T("           product_expdate ") \
					_T("		   %s "), nOID, szGroup, szOrderBy);

			rs2.ExecSQL(szSQL);
			//_msg(_T("%s"), szSQL);
			if (rs2.IsEOF()) {
				rst.MoveNext();
				continue;

			}
			if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
			{
				nBreak++;
			}
			CReportSection* rptDetail = rpt.GetDetail(0);
			rpt.ResetContent();
			nTotalItem = 1;
			nTotalAmount = 0;
			CString szItemId;
			while (!rs2.IsEOF())
			{
				rptDetail = rpt.AddDetail();
				rs2.GetValue(_T("id"), nProductID);
				rs2.GetValue(_T("item_id"), nProductItemID);
				tmpStr.Format(_T("%d"), nTotalItem++);
				rptDetail->SetValue(_T("1"), tmpStr);
				rs2.GetValue(_T("name"), tmpStr);
				rptDetail->SetValue(_T("2"), tmpStr);
				rs2.GetValue(_T("unit"), tmpStr);
				rptDetail->SetValue(_T("3"), tmpStr);
				rs2.GetValue(_T("qtyorder"), nQty);

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 || szGroup.Find(_T("'A2000'")) != -1 || szOrderType == _T("M"))
					MoneyToString(ToString(nQty), szNote);
				else
					szNote.Empty();
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4"), tmpStr2);

				rs2.GetValue(_T("qtysold"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.1"), tmpStr2);

				rs2.GetValue(_T("qtypolicy"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.2"), tmpStr2);

				rs2.GetValue(_T("qtysoldins"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.3"), tmpStr2);
				rs2.GetValue(_T("qtyotherins"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.4"), tmpStr2);

				rs2.GetValue(_T("qtyservice"), nQty);
				FormatCurrency(nQty, tmpStr2);
				_tprintf(_T("\r\nnStorageId: %d"), nStorage_id);
				rptDetail->SetValue(_T("4.5"), nStorage_id == 14 ? rs2.GetValue(_T("qtyorder")) : tmpStr2);

				rs2.GetValue(_T("qtyother"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.6"), tmpStr2);

				rs2.GetValue(_T("price"), tmpStr);
				rs2.GetValue(_T("amount"), nAmount);

				FormatCurrencyStr(tmpStr, tmpStr2);
				rptDetail->SetValue(_T("5"), tmpStr2);

				rptDetail->SetValue(_T("8"), tmpStr2);
				nTotalAmount += nAmount;

				FormatCurrency(nAmount, tmpStr2);
				rptDetail->SetValue(_T("7"), tmpStr2);

				rptDetail->SetValue(_T("9"), tmpStr2);

				rptDetail->SetValue(_T("6"), szNote);

				//if(szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1)
				{
					rs2.GetValue(_T("lotno"), tmpStr);
					rptDetail->SetValue(_T("10"), tmpStr);

					rs2.GetValue(_T("expdate"), tmpStr);
					rptDetail->SetValue(_T("11"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
				}

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 ||
					szGroup.Find(_T("'A2000'")) != -1 || szOrderType == _T("M"))
				{
					szSQL.Format(_T(" SELECT    hpo_docno            AS docno, ") \
						_T("           get_patientname(hpo_docno) AS pname, ") \
						_T("           SUM(hpol_qtyorder)   AS orderqty ") \
						_T(" FROM      hms_ipharmaorder ") \
						_T(" LEFT JOIN hms_ipharmaorderline ON( hpo_orderid = hpol_orderid ) ") \
						_T(" WHERE     hpo_transaction_id = %ld ") \
						_T("       AND hpol_product_item_id = %ld ") \
						_T(" GROUP     BY hpo_docno ") \
						_T(" ORDER     BY pname "), nOID, nProductItemID);
					rsp.ExecSQL(szSQL);
					while (!rsp.IsEOF()) {
						rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
						rptDetail->SetValue(_T("1"), _T(""));
						rsp.GetValue(_T("pname"), tmpStr);
						rptDetail->SetValue(_T("2"), tmpStr);
						rsp.GetValue(_T("docno"), tmpStr);
						rptDetail->SetValue(_T("3"), tmpStr);
						rsp.GetValue(_T("orderqty"), nQty);
						FormatCurrency(nQty, tmpStr);
						rptDetail->SetValue(_T("4"), tmpStr);
						rptDetail->SetValue(_T("5"), _T(""));
						MoneyToString(ToString(nQty), szNote);
						rptDetail->SetValue(_T("6"), szNote);
						rsp.MoveNext();
					}
				}
				rs2.MoveNext();
			}
			//Page Footer
			//Report Footer
			rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
			tmpStr.Format(_T("%d"), nTotalItem - 1);
			rptDetail->SetValue(_T("TotalItem"), tmpStr);
			tmpStr.Format(_T("%.0f"), nTotalAmount);
			FormatCurrencyStr(tmpStr, tmpStr2);
			rptDetail->SetValue(_T("TotalAmount"), tmpStr2);

			MoneyToString(tmpStr, tmpStr2);
			tmpStr.Format(_T("%s \x111\x1ED3ng."), tmpStr2);
			rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);

			CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
			if (img)
			{
				//img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
				//img->SetFixedHeight(false);
			}

			rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

			tmpStr = pMF->GetSysDate();
			szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
			rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

			rpt.PrintPreview(bPreviewOnly);
			//_msg(_T("%s %s"), GroupStr, szGroup);
			if (nBreak > 0)
				break;
			rst.MoveNext();
		}
	}
}

void CPrintForms::PrintDDO2_ATDEPT_SUB(long nOID, bool bPreviewOnly)
{
	CGuiMainFrame* pMF = (CGuiMainFrame*)AfxGetMainWnd();//mainFramePointer//pGuiMnFrm//UDT:MF=MainFrame, rs=RecordSet, p=Pointer, tmp=temp 
	CReport rpt;
	CRecord rsReport(&pMF->m_db);//tmpRecord//tmpRec
	CRecord rs(&pMF->m_db);//transactionRecord//transactionRecd//trsactionRecord//tstRcd
	CRecord rs2(&pMF->m_db);//itemRecord
	CRecord rst(&pMF->m_db);//typeSortRecord
	CRecord rsp(&pMF->m_db);//qtyPsychoRecord
	CString szGroup, szTitle, szNote;
	CString tmpStr, tmpStr2, szDate, szSQL, szDesc, szOrderBy, szStorageCategory, szOrderType;//orderTypeStr, storageCategoryStr(storgCatgryStr, stoCat),
	//orderByStr, tmpStr2, tmpStr, sqlStr
	int nStorage_id = 0, nBreak = 0;//int storageIndex = 0;
	CString szID;
	long nProductID = 0, nProductItemID = 0;//productIndex, productItemIndex

	szID.Format(_T("%ld"), nOID);

	double	nTotalAmount = 0, nAmount = 0, nAmountServ = 0, nTotalAmountServ = 0;//amountTotal, amountServiceTotal//amntServcTotal//amntServTotal//amountServiceTotl
	int		nQty, nTotalItem = 1;//itemCount 
	//int		nPrint=0;
	//bool bDirect = false;

	szOrderBy.Format(_T(" ORDER BY name, unit, price "));
	szSQL.Format(_T(" SELECT distinct mt_orderno, ") \
		_T("        mt_orderdate, ") \
		_T("        mt_approveddate, ") \
		_T("        mt_postedby, ") \
		_T("        mt_storage_id, ") \
		_T("        Get_storagename(mt_storage_id)          AS mt_storage_name, ") \
		_T("        Get_storagename(mt_storage_to_id)       AS mt_storageto_name, ") \
		_T("        Get_departmentname(mt_department_id)    AS mt_department_name, ") \
		_T("        Get_departmentname(mt_department_to_id) AS mt_departmentto_name, ") \
		_T("        mt_doctype, ") \
		_T("        mt_description, ") \
		_T("		mt_objecttype, ")
		_T("		hpo_ordertype, mt_documentno, mtb_ordertype,  ") \
		_T("		mt_status as status, ") \
		_T("		get_syssel_desc('HMS_TREAT_ZONE', mt_zone) as zone,") \
		_T("		(select count(*) from hms_ipharmaorder ") \
		_T("		where hpo_transaction_id = mt_transaction_id and hpo_orderstatus not in ('O', 'C')) ") \
		_T("		as so_phieu") \
		_T(" FROM   m_transaction ") \
		_T(" LEFT JOIN m_transaction_batch ON(mtb_orderno = mt_orderno) ") \
		_T(" LEFT JOIN hms_ipharmaorder ON (mt_doctype = 'DMO' AND hpo_transaction_id = mt_transaction_id)") \
		_T(" WHERE  mt_transaction_id = %ld ") \
		_T(" AND mt_status NOT IN ('O', 'C')"), nOID);

	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
		return;
	if (rs.GetValue(_T("status")) == _T("A"))
	{
		ShowMessageBox(_T("Phiếu trạng thái đã duyệt. Tới khoa cấp phát để in lại!"));
		//return;
	}
	CString szType, szReportName, szSendBy, szObjectType;//reportNameStr, sendByStr, objectTypeStr
	CString szOrderCategory;

	rs.GetValue(_T("mt_doctype"), szType);
	rs.GetValue(_T("mt_orderno"), szID);
	rs.GetValue(_T("hpo_ordertype"), szOrderType);
	if (szType == _T("DPO") || szType == _T("DMO") || szType == _T("CSO"))
	{
		szOrderBy.Format(_T(" ORDER BY product_uomindex, product_name, product_uomname "));
	}
	else if (szType == _T("DDO"))
	{
		szOrderBy.Format(_T(" ORDER BY product_name, product_uomname "));
	}
	rs.GetValue(_T("mt_postedby"), szSendBy);
	rs.GetValue(_T("mt_description"), szDesc);

	rs.GetValue(_T("mt_storage_id"), nStorage_id);
	rs.GetValue(_T("mt_objecttype"), szObjectType);


	//Kiem tra kho dich vu
	if (szObjectType == _T("S"))
		szStorageCategory = _T("S");
	else
	{
		szSQL.Format(_T("SELECT msl_category category FROM m_storagelist WHERE msl_storage_id = %d"), nStorage_id);
		rsReport.ExecSQL(szSQL);
		rsReport.GetValue(_T("category"), szStorageCategory);
	}
	rs.GetValue(_T("mtb_ordertype"), szOrderCategory);



	if (szType == _T("DPO") || szType == _T("DMO") || szType == _T("DDO") || szType == _T("CSO"))
	{
		szSQL.Format(_T(" SELECT DISTINCT pmdt_name,") \
			_T("   pmdt_desc,") \
			_T("   pmdt_reportname, pmdt_index, pmdt_printtype  ") \
			_T(" FROM pms_drugtype,") \
			_T("   m_transactionline,") \
			_T("   m_productitem_view") \
			_T(" WHERE mtl_transaction_id =%ld") \
			_T(" AND mtl_product_item_id  =product_item_id") \
			_T(" AND instr(pmdt_desc, product_producttype) > 0") \
			_T(" ORDER BY pmdt_index "), nOID);
		rst.ExecSQL(szSQL);
		//_msg(_T("%s"), szSQL);
		while (!rst.IsEOF())
		{
			rst.GetValue(_T("pmdt_name"), tmpStr);
			StringUpper(tmpStr, szTitle);
			rst.GetValue(_T("pmdt_desc"), szGroup);
			szGroup.Trim();

			rst.GetValue(_T("pmdt_reportname"), tmpStr);
			//_msg(_T("%s"), szStorageCategory);
			if (!tmpStr.IsEmpty())
				if (szStorageCategory == _T("S"))
					szReportName.Format(_T("Reports/HMS/%sDV.RPT"), tmpStr);
				else
					szReportName.Format(_T("Reports/HMS/%s.RPT"), tmpStr);

			if (!rpt.Init(szReportName))
				return;
			rpt.GetReportHeader()->SetValue(_T("so_phieu"), rs.GetValue(_T("so_phieu")));
			rpt.GetReportHeader()->SetValue(_T("Zone"), rs.GetValue(_T("zone")));
			//Report Header
			rpt.GetReportHeader()->SetValue(_T("HEALTHSERVICE"), pMF->m_szHealthService);
			rpt.GetReportHeader()->SetValue(_T("HOSPITALNAME"), pMF->m_szHospitalName);
			if (szStorageCategory != _T("S"))
				rpt.GetReportHeader()->Format(_T("TITLE"), szTitle);
			rs.GetValue(_T("mt_orderdate"), tmpStr);
			szDate.Format(rpt.GetReportHeader()->GetValue(_T("OrderDate")), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
			rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);
			rpt.GetReportHeader()->SetValue(_T("OrderID"), szID);
			if (szOrderType == _T("M"))
				rpt.GetReportHeader()->SetValue(_T("Purpose"), _T("\x44\xE0nh \x63ho \x63\xE1\x63 \x63\x61 ph\x1EABu thu\x1EADt, th\x1EE7 thu\x1EADt"));
			rs.GetValue(_T("mt_statusdesc"), tmpStr);
			//tmpStr = GetStatusString(tmpStr);
			rpt.GetReportHeader()->SetValue(_T("Status"), tmpStr);
			rs.GetValue(_T("mt_storage_name"), tmpStr);
			//tmpStr = GetStorageName(ToInt(tmpStr));
			rpt.GetReportHeader()->SetValue(_T("FromStock"), tmpStr);
			rpt.GetReportHeader()->SetValue(_T("Comment"), szDesc);

			rs.GetValue(_T("mt_storageto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("ToStock"), tmpStr);

			rs.GetValue(_T("mt_department_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);

			rs.GetValue(_T("mt_departmentto_name"), tmpStr);
			if (!tmpStr.IsEmpty())
				rpt.GetReportHeader()->SetValue(_T("DepartmentTo"), tmpStr);
			tmpStr.Empty();
			rpt.GetReportHeader()->SetValue(_T("Sheet"), _T("1"));

			if (pMF->GetModuleID() == _T("MA"))
			{
				rs.GetValue(_T("mt_documentno"), tmpStr);
				rpt.GetReportHeader()->SetValue(_T("ReferenceNo"), tmpStr);
			}

			if (szOrderCategory == _T("C"))
			{
				rpt.GetReportHeader()->SetValue(_T("OrderCategory"), _T("Phiếu lĩnh thuốc, hóa chất pha chế"));
			}
			else
			{
				rpt.GetReportHeader()->SetValue(_T("OrderCategory"), _T(""));
			}

			//*?Lay gia ban tu line thuoc
			//Page Header
			//Report Detail
			if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
				szSQL.Format(_T(" SELECT product_id                             AS id, ") \
					_T("		product_item_id item_id,") \
					_T("        product_name                           AS name, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					_T("        Sum(mtl_qtyservice)                    AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        mtl_saleprice                      AS price, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount, ") \
					_T("        product_expdate                        AS expdate ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  mtl_transaction_id = %ld ") \
					_T("        AND product_producttype NOT IN('A1130', 'A1140') ") \
					_T("        AND product_producttype  IN (select ss_code from sys_sel WHERE ss_id='nhom_phieulinh') ") \
					_T(" GROUP  BY product_id, ") \
					_T("		   product_item_id,") \
					_T("           product_name, ") \
					_T("           product_uomname, ") \
					_T("		   mtl_saleprice,") \
					_T("           product_uomindex,product_expdate ") \
					_T("		   %s "), nOID, szOrderBy);
			else
				szSQL.Format(_T(" SELECT product_id                AS id, ") \
					_T("		product_item_id                        AS item_id, ") \
					_T("        product_name                           AS name, ") \
					_T("        product_uomname                        AS unit, ") \
					_T("        Sum(mtl_qtyorder)                      AS qtyorder, ") \
					_T("        Sum(mtl_qtysold)                       AS qtysold, ") \
					_T("        Sum(mtl_qtypolicy)                     AS qtypolicy, ") \
					_T("        Sum(mtl_qtysoldins)                    AS qtysoldins, ") \
					_T("        Sum(mtl_qtyotherins)                   AS qtyotherins, ") \
					_T("        Sum(mtl_qtyservice)                    AS qtyservice, ") \
					_T("        Sum(mtl_qtyother)                      AS qtyother, ") \
					_T("        mtl_saleprice                      AS price, ") \
					_T("        Sum(mtl_qtyorder * mtl_saleprice) AS amount, ") \
					_T("        product_lotno                          AS lotno, ") \
					_T("        product_expdate                        AS expdate ") \
					_T(" FROM   m_transactionline ") \
					_T(" LEFT JOIN m_productitem_view ON( product_item_id = mtl_product_item_id ) ") \
					_T(" WHERE  mtl_transaction_id = %ld ") \
					_T("        AND product_producttype IN(%s) ") \
					_T("        AND product_producttype IN (select ss_code from sys_sel WHERE ss_id='nhom_phieulinh') ") \
					_T(" GROUP  BY product_id, ") \
					_T("		   product_item_id,") \
					_T("           product_name, ") \
					_T("           product_uomname, ") \
					_T("           mtl_saleprice, ") \
					_T("           product_uomindex, ") \
					_T("           product_lotno, ") \
					_T("           product_expdate ") \
					_T("		   %s "), nOID, szGroup, szOrderBy);

			rs2.ExecSQL(szSQL);
			//_msg(_T("%s"), szSQL);
			if (rs2.IsEOF()) {
				rst.MoveNext();
				continue;

			}
			if (szStorageCategory == _T("S") && (szGroup.Find(_T("'A1130'")) == -1 && szGroup.Find(_T("'A1140'")) == -1))
			{
				nBreak++;
			}
			CReportSection* rptDetail = rpt.GetDetail(0);
			rpt.ResetContent();
			nTotalItem = 1;
			nTotalAmount = 0;
			CString szItemId;
			while (!rs2.IsEOF())
			{
				rptDetail = rpt.AddDetail();
				rs2.GetValue(_T("id"), nProductID);
				rs2.GetValue(_T("item_id"), nProductItemID);
				tmpStr.Format(_T("%d"), nTotalItem++);
				rptDetail->SetValue(_T("1"), tmpStr);
				rs2.GetValue(_T("name"), tmpStr);
				rptDetail->SetValue(_T("2"), tmpStr);
				rs2.GetValue(_T("unit"), tmpStr);
				rptDetail->SetValue(_T("3"), tmpStr);
				rs2.GetValue(_T("qtyorder"), nQty);

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 || szGroup.Find(_T("'A2000'")) != -1 || szOrderType == _T("M"))
					MoneyToString(ToString(nQty), szNote);
				else
					szNote.Empty();
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4"), tmpStr2);

				rs2.GetValue(_T("qtysold"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.1"), tmpStr2);

				rs2.GetValue(_T("qtypolicy"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.2"), tmpStr2);

				rs2.GetValue(_T("qtysoldins"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.3"), tmpStr2);
				rs2.GetValue(_T("qtyotherins"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.4"), tmpStr2);

				rs2.GetValue(_T("qtyservice"), nQty);
				FormatCurrency(nQty, tmpStr2);
				_tprintf(_T("\r\nnStorageId: %d"), nStorage_id);
				rptDetail->SetValue(_T("4.5"), nStorage_id == 14 ? rs2.GetValue(_T("qtyorder")) : tmpStr2);

				rs2.GetValue(_T("qtyother"), nQty);
				FormatCurrency(nQty, tmpStr2);
				rptDetail->SetValue(_T("4.6"), tmpStr2);

				rs2.GetValue(_T("price"), tmpStr);
				rs2.GetValue(_T("amount"), nAmount);

				FormatCurrencyStr(tmpStr, tmpStr2);
				rptDetail->SetValue(_T("5"), tmpStr2);

				rptDetail->SetValue(_T("8"), tmpStr2);
				nTotalAmount += nAmount;

				FormatCurrency(nAmount, tmpStr2);
				rptDetail->SetValue(_T("7"), tmpStr2);

				rptDetail->SetValue(_T("9"), tmpStr2);

				rptDetail->SetValue(_T("6"), szNote);

				//if(szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1)
				{
					rs2.GetValue(_T("lotno"), tmpStr);
					rptDetail->SetValue(_T("10"), tmpStr);

					rs2.GetValue(_T("expdate"), tmpStr);
					rptDetail->SetValue(_T("11"), CDate::Convert(tmpStr, yyyymmdd, ddmmyyyy));
				}

				if (szGroup.Find(_T("'A1130'")) != -1 || szGroup.Find(_T("'A1140'")) != -1 ||
					szGroup.Find(_T("'A2000'")) != -1 || szOrderType == _T("M"))
				{
					szSQL.Format(_T(" SELECT    hpo_docno            AS docno, ") \
						_T("           get_patientname(hpo_docno) AS pname, ") \
						_T("           SUM(hpol_qtyorder)   AS orderqty ") \
						_T(" FROM      hms_ipharmaorder ") \
						_T(" LEFT JOIN hms_ipharmaorderline ON( hpo_orderid = hpol_orderid ) ") \
						_T(" WHERE     hpo_transaction_id = %ld ") \
						_T("       AND hpol_product_item_id = %ld ") \
						_T(" GROUP     BY hpo_docno ") \
						_T(" ORDER     BY pname "), nOID, nProductItemID);
					rsp.ExecSQL(szSQL);
					while (!rsp.IsEOF()) {
						rptDetail = rpt.AddDetail(rpt.GetGroupHeader(1));
						rptDetail->SetValue(_T("1"), _T(""));
						rsp.GetValue(_T("pname"), tmpStr);
						rptDetail->SetValue(_T("2"), tmpStr);
						rsp.GetValue(_T("docno"), tmpStr);
						rptDetail->SetValue(_T("3"), tmpStr);
						rsp.GetValue(_T("orderqty"), nQty);
						FormatCurrency(nQty, tmpStr);
						rptDetail->SetValue(_T("4"), tmpStr);
						rptDetail->SetValue(_T("5"), _T(""));
						MoneyToString(ToString(nQty), szNote);
						rptDetail->SetValue(_T("6"), szNote);
						rsp.MoveNext();
					}
				}
				rs2.MoveNext();
			}
			//Page Footer
			//Report Footer
			rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
			tmpStr.Format(_T("%d"), nTotalItem - 1);
			rptDetail->SetValue(_T("TotalItem"), tmpStr);
			tmpStr.Format(_T("%.0f"), nTotalAmount);
			FormatCurrencyStr(tmpStr, tmpStr2);
			rptDetail->SetValue(_T("TotalAmount"), tmpStr2);

			MoneyToString(tmpStr, tmpStr2);
			tmpStr.Format(_T("%s \x111\x1ED3ng."), tmpStr2);
			rpt.GetReportFooter()->SetValue(_T("SumInWord"), tmpStr);

			CReportItem* img = rpt.GetReportFooter()->GetItem(_T("Signature"));
			if (img)
			{
				//img->SetHBITMAP(pMF->GetSignatureImage(szSendBy));
				//img->SetFixedHeight(false);
			}

			rpt.GetReportFooter()->SetValue(_T("DoctorName"), GetDoctorName(szSendBy));

			tmpStr = pMF->GetSysDate();
			szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
			rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

			rpt.PrintPreview(bPreviewOnly);
			//_msg(_T("%s %s"), GroupStr, szGroup);
			if (nBreak > 0)
				break;
			rst.MoveNext();
		}
	}
}

void CPrintForms::TM_OnPrintOperationRM(long nOrderID, bool bPreview, bool bDirect)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CReport rpt;
	CString szSQL, tmpStr, szivffree;
	int nivffree = 0;
	CRecord rs(&pMF->m_db);
	CString szDate, szSysDate, szAdmit, szPerformDate, szDiagnostic;
	szSysDate = pMF->GetSysDateTime();


	szDiagnostic.Format(_T(" hd_diagnostic as Diagnostic, "));


	szSQL.Format(_T(" SELECT 	hd_docno as docno, hd_patientno as patno, ") \
		_T("  UPPER(trim(hp_surname||' '||hp_midname||' '||hp_firstname)) as PatientName,") \
		_T("  trunc_date(hp_birthdate) as birthdate,") \
		_T("  hms_getage(trunc_date(hd_admitdate), hp_birthdate) as Age,") \
		_T("  extract(year from hp_birthdate) yob,") \
		_T("  hp_sex as sexid,") \
		_T("  sys_sel_getname('sys_sex', hp_sex) as Sex,") \
		_T("  ho_deptid as deptid,") \
		_T("  ho_roomid as roomid,") \
		_T("  ho_bedid as bedid,") \
		_T("  (select sd_name from sys_dept where sd_id=ho_deptid) as Department,") \
		_T("  hms_getaddress(nvl(hd_provid, hp_provid), nvl(hd_distid, hp_distid), nvl(hd_villid, hp_villid)) as address,") \
		_T("  hd_cardno as cardno,") \
		_T("  hd_cardidx as cardidx, ") \
		_T("  hc_expdate as expdate,") \
		_T("  hd_admitdate as admitdate, ") \
		_T("  ho_beforeopera  as  BeforeOpera, ho_afteropera  as  AfterOpera, ") \
		_T("  ho_performdate as PerformDate,") \
		_T("  ho_practitioner as practitioner, ho_assistant as assistant,") \
		_T("  ho_anesthetist as anesthetist, %s") \
		_T("  CASE WHEN ho_anes_method IS NOT NULL THEN (SELECT ham_name FROM hms_anesthesia_method WHERE ham_idx = ho_anes_method") \
		_T("  ) ELSE ho_inmethod END AS InMethod, ") \
		_T("  ho_itemid as itemid, ho_diagnostic,") \
		_T("  ho_idx||'-'||hfl_name as operationname, ") \
		_T("  (SELECT hfg_name FROM hms_fee_group WHERE hfg_id = hfl_groupid) AS operationtype,") \
		_T("  Get_objectname(hd_object) AS objname,IVF_ISDISCOUNT,IVF_GIAYGIOITHIEU, HO_ISIVFFREE,  DC_PERCENTAGE ") \
		_T("  FROM hms_operation") \
		_T("  RIGHT JOIN hms_patient ON(hp_patientno=ho_patientno)") \
		_T("  RIGHT JOIN hms_doc on (hd_docno=ho_docno) ") \
		_T("  LEFT JOIN RM_IVF_DISCOUNT_INFOR ON(hd_docno=IVF_DOCNO)") \
		_T("  LEFT JOIN hms_card ON (hd_patientno=hc_patientno AND hd_cardno = hc_cardno AND hd_cardidx=hc_idx)") \
		_T("  LEFT JOIN hms_fee_list ON(hfl_feeid=ho_itemid)") \
		_T("  LEFT JOIN M_DISCOUNT_FEE_LIST ON (HO_ITEMID = dc_code)  ") \
		_T("  WHERE ho_idx=%ld"), szDiagnostic, nOrderID);
	int ret = rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);

	if (rs.IsEOF())
	{
		ShowMessageBox(_T("Patient not found"));
		return;
	}

	if (!rpt.Init(_T("Reports/HMS/HMS_OPERATIONSHEETIVF.RPT")))
		return;
	//Report Header

//StringUpper(pMF->m_CompanyInfo.sc_pname, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HEALTH_SERVICE"), pMF->m_CompanyInfo.sc_pname);
	//StringUpper(pMF->m_CompanyInfo.sc_name, tmpStr);
	rpt.GetReportHeader()->SetValue(_T("HOSPITAL_NAME"), pMF->m_CompanyInfo.sc_name);
	rs.GetValue(_T("docno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("docno"), tmpStr);

	rs.GetValue(_T("patno"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("patno"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("patno2"), tmpStr);

	rpt.GetReportFooter()->SetValue(_T("Barcode2[128A]"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Barcode2[128B]"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Barcode2[128C]"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Barcode2[39]"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("Barcode2[93]"), tmpStr);


	tmpStr.Format(_T("%ld"), nOrderID);
	rpt.GetReportHeader()->SetValue(_T("orderid"), tmpStr);

	rs.GetValue(_T("PatientName"), tmpStr); //benh nhan
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), tmpStr);
	rs.GetValue(_T("Age"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Age"), tmpStr);
	rs.GetValue(_T("Sex"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("Sex"), tmpStr);

	rs.GetValue(_T("yob"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("yearofbirth"), tmpStr);

	rs.GetValue(_T("CardNo"), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("CardNo"), tmpStr);
	rs.GetValue(_T("InMethod"), tmpStr);// pp vo cam
	rpt.GetReportHeader()->SetValue(_T("InMethod"), tmpStr);
	rs.GetValue(_T("ExpDate"), tmpStr);// ngay het han
	rpt.GetReportHeader()->SetValue(_T("ExpDate"), CDate::Convert(rs.GetValue(_T("ExpDate")), yyyymmdd, ddmmyyyy));
	rs.GetValue(_T("Practitioner"), tmpStr);// bac sy phau thuat
	rpt.GetReportHeader()->SetValue(_T("Practitioner"), pMF->GetDoctorName(tmpStr));
	rs.GetValue(_T("Assistant"), tmpStr);// thu thuat vien
	rpt.GetReportHeader()->SetValue(_T("Assistant"), pMF->GetDoctorName(tmpStr));
	rs.GetValue(_T("Anesthetist"), tmpStr);//bac sy gay me
	rpt.GetReportHeader()->SetValue(_T("Anesthetist"), pMF->GetDoctorName(tmpStr));
	rs.GetValue(_T("address"), tmpStr);//dia chi
	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);
	rs.GetValue(_T("Department"), tmpStr);//khoa
	rpt.GetReportHeader()->SetValue(_T("Department"), tmpStr);
	rs.GetValue(_T("roomid"), tmpStr);// ten phong
	rpt.GetReportHeader()->SetValue(_T("Room"), tmpStr);
	rs.GetValue(_T("bedid"), tmpStr);//giuong
	rpt.GetReportHeader()->SetValue(_T("Bed"), tmpStr);
	rs.GetValue(_T("objname"), tmpStr);//doituong
	rpt.GetReportHeader()->SetValue(_T("object"), tmpStr);

	tmpStr = rpt.GetReportHeader()->GetValue(_T("AdmitDate"));
	rs.GetValue(_T("AdmitDate"), szAdmit);// vao khoa luc			
	szAdmit.Format(tmpStr, szAdmit.Mid(11, 2), szAdmit.Mid(14, 2), CDate::Convert(szAdmit.Left(10), yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("AdmitDate"), szAdmit);//

	tmpStr = rpt.GetReportHeader()->GetValue(_T("PerformDate"));
	rs.GetValue(_T("PerformDate"), szPerformDate);// thuc hien luc		
	szDate.Format(tmpStr, szPerformDate.Mid(11, 2), szPerformDate.Mid(14, 2), CDate::Convert(szPerformDate.Left(10), yyyymmdd, ddmmyyyy));
	rpt.GetReportHeader()->SetValue(_T("PerformDate"), szDate);//
	rs.GetValue(_T("Diagnostic"), tmpStr);// chan doan
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), tmpStr);
	rs.GetValue(_T("BeforeOpera"), tmpStr);// truoc phau thuat thu thuat
	rpt.GetReportHeader()->SetValue(_T("BeforeOpera"), tmpStr);
	rs.GetValue(_T("AfterOpera"), tmpStr);// sau phau thuat thu thuat
	rpt.GetReportHeader()->SetValue(_T("AfterOpera"), tmpStr);

	rs.GetValue(_T("HO_ISIVFFREE"), szivffree);
	rs.GetValue(_T("DC_PERCENTAGE"), nivffree);

	rs.GetValue(_T("operationname"), tmpStr);// phuong phap phau thuat thu thuat
	if (szivffree == _T('Y') && nivffree > 0)
	{
		tmpStr.AppendFormat(_T("(Được miễn giảm)"));
	}
	rpt.GetReportHeader()->SetValue(_T("OperationName"), tmpStr);


	rs.GetValue(_T("operationtype"), tmpStr);// loai phau thuat thu thuat
	rpt.GetReportHeader()->SetValue(_T("OperationType"), tmpStr);

	CString szIsDiscount, szGiayGioiThieu, tmpggt;
	rs.GetValue(_T("IVF_ISDISCOUNT"), szIsDiscount);
	rs.GetValue(_T("IVF_GIAYGIOITHIEU"), tmpggt);
	szGiayGioiThieu.AppendFormat(_T("Số quyết định: - %s"), tmpggt);
	//_msg(_T("%s"), szGiayGioiThieu);
	if (szIsDiscount == _T("1"))
	{
		rpt.GetReportHeader()->SetValue(_T("DiscountIVF"), _T("Ghi chú: Đối tượng được miễn giảm"));
		rpt.GetReportHeader()->SetValue(_T("SoQuyetDinh"), szGiayGioiThieu);
	}

	//Page Header
	//Report Detail
	CReportSection* rptDetail = rpt.GetDetail(0);

	//Page Footer
	//Report Footer

	if (pMF->GetCurrentRoomID() == 52 || pMF->GetCurrentDepartmentID() == _T("B10"))
	{
		rs.GetValue(_T("Practitioner"), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("Assistant"), pMF->GetDoctorName(tmpStr));
		szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szPerformDate.Mid(11, 5), szPerformDate.Mid(8, 2), szPerformDate.Mid(5, 2), szPerformDate.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	}
	else
	{
		rs.GetValue(_T("Assistant"), tmpStr);
		rpt.GetReportFooter()->SetValue(_T("Assistant"), pMF->GetDoctorName(tmpStr));
		szDate.Format(rpt.GetReportFooter()->GetValue(_T("PrintDate")), szSysDate.Mid(11, 5), szSysDate.Mid(8, 2), szSysDate.Mid(5, 2), szSysDate.Left(4));
		rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);
	}

	rpt.GetReportFooter()->SetValue(_T("LDphauthuat_thuthuat"), rs.GetValue(_T("ho_diagnostic")));

	/*if (bPreview)
	{
		rpt.PrintPreview();
	}
	else*/
	{
		rpt.Print(bDirect);
	}

}

void CPrintForms::OnPrintPhieuYeuCauTraLaiDichVu(long nDocNo, long nInvoiceNo)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();

	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL;
	double nthanhtien, nTotalthanhtien = 0;
	double nbntra, nTotalbntra = 0;
	int nIdx = 1;
	CString szSQL, szReportName, szDate, szTemp, tmpStr, tmpStr2;
	CString szGroupName = _T("I. Các dịch vụ / mặt hàng hoàn trả");

	szReportName = _T("Reports\\HMS\\HF_PHIEUYEUCAU_TRALAI_DICHVU.rpt");
	if (!rpt.Init(szReportName))
		return;

	szSQL.Format(_T(" SELECT get_patientname(hfe_docno) as patient_name,") \
		_T(" to_char(hp_birthdate, 'DD/MM/YYYY') as yob,") \
		_T(" HMS_GETSEX(hp_sex) as sex,") \
		_T(" hfe_deptid as Department,") \
		_T(" hfe_patientno as PatientNo,") \
		_T(" hfe_docno as doc_no,") \
		_T(" hfe_invoiceno as InvoiceNo,") \
		_T(" hms_getusername(HFE_CREATEDBY) as OrderPerson,") \
		_T(" hfe_date as orderdate,") \
		_T(" GET_DEPARTMENTNAME(hfe_deptid) as OrderDept") \
		_T(" from hms_fee_refund ") \
		_T(" left join hms_patient ON (hfe_patientno = hp_patientno)") \
		_T(" where hfe_docno=%ld") \
		_T(" and hfe_invoiceno=%ld"), nDocNo, nInvoiceNo);

	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data."));
		return;
	}
	rpt.GetReportHeader()->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);
	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("Department")));

	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), rs.GetValue(_T("doc_no")));
	rpt.GetReportHeader()->SetValue(_T("InvoiceNo"), rs.GetValue(_T("InvoiceNo")));

	rpt.GetReportHeader()->SetValue(_T("OrderPerson"), rs.GetValue(_T("OrderPerson")));
	rpt.GetReportFooter()->SetValue(_T("OrderPerson2"), rs.GetValue(_T("OrderPerson")));

	rpt.GetReportHeader()->SetValue(_T("OrderDept"), rs.GetValue(_T("OrderDept")));


	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), rs.GetValue(_T("patient_name")));
	rpt.GetReportHeader()->SetValue(_T("Yearofbirth"), rs.GetValue(_T("yob")));
	rpt.GetReportHeader()->SetValue(_T("Sex"), rs.GetValue(_T("sex")));

	rpt.GetReportHeader()->SetValue(_T("PatientNo"), rs.GetValue(_T("PatientNo")));
	rpt.GetReportHeader()->SetValue(_T("DocumentNo2"), rs.GetValue(_T("doc_no")));

	rs.GetValue(_T("orderdate"), tmpStr);
	tmpStr2 = rpt.GetReportHeader()->GetValue(_T("OrderDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("OrderDate"), szDate);

	szSQL.Format(_T(" SELECT ln.hfe_desc as ten,") \
		_T("     ln.hfe_unit as donvi,") \
		_T("     ln.hfe_quantity as soluong,") \
		_T("     ln.hfe_unitprice as dongia,") \
		_T("     ln.hfe_cost as thanhtien,") \
		_T("     ln.hfe_patpaid as bntra,") \
		_T("     SYS_SEL_GETNAME('hms_refund_desc', rf.hfe_desc) as lydotra ") \
		_T("   FROM hms_fee_refundline ln") \
		_T("   LEFT JOIN hms_fee_refund rf") \
		_T("   ON (rf.hfe_docno = ln.hfe_docno and rf.hfe_invoiceno = ln.hfe_invoiceno)") \
		_T("   WHERE hfe_client_id = 'PRE_REFUND' and rf.hfe_docno   = %ld") \
		_T("   AND rf.hfe_invoiceno = %ld"), nDocNo, nInvoiceNo);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data"));
		return;
	}
	rptGroup = rpt.AddDetail(rpt.GetGroupHeader(1));
	if (rptGroup)
		rptGroup->SetValue(_T("GroupName"), szGroupName);

	while (!rs.IsEOF())
	{
		/*Group Seperation*/
		rptDetail = rpt.AddDetail();
		if (rptDetail)
		{
			rptDetail->SetValue(_T("1"), int2str(nIdx++));
			rptDetail->SetValue(_T("2"), rs.GetValue(_T("ten")));
			rptDetail->SetValue(_T("3"), rs.GetValue(_T("donvi")));
			rptDetail->SetValue(_T("4"), rs.GetValue(_T("soluong")));
			rptDetail->SetValue(_T("5"), rs.GetValue(_T("dongia")));
			rptDetail->SetValue(_T("6"), rs.GetValue(_T("lydotra")));
			rptDetail->SetValue(_T("7"), rs.GetValue(_T("thanhtien")));
			rptDetail->SetValue(_T("8"), rs.GetValue(_T("bntra")));

			rs.GetValue(_T("thanhtien"), nthanhtien);
			nTotalthanhtien += nthanhtien;

			rs.GetValue(_T("bntra"), nbntra);
			nTotalbntra += nbntra;
		}
		rs.MoveNext();
	}
	/*tmpStr.Format(_T("%Lf"), nTotalthanhtien);
	rpt.GetGroupFooter(1)->SetValue(_T("s7"), tmpStr);*/

	rptGroup = rpt.AddDetail(rpt.GetGroupFooter(1));
	if (rptGroup)
	{
		tmpStr.Format(_T("%Lf"), nTotalthanhtien);
		rptGroup->SetValue(_T("s7"), tmpStr);

		tmpStr.Format(_T("%Lf"), nTotalbntra);
		rptGroup->SetValue(_T("s8"), tmpStr);
	}

	tmpStr = pMF->GetSysDateTime();
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("PrintDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), szDate);

	rpt.PrintPreview();
}

void CPrintForms::InVienPhiTienMat(CString szClerk, CString szPaymentMethod, CString szFromDate, CString szToDate)
{
	/*
	Steps
	-Load form
	-Print
	 +Line Change
	  .New Group (object, fee)
	 +Line
	 +Footer
	*/
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptGroupObject = NULL, * rptGroupFee = NULL, * rptDetail = NULL;
	CString szFilePath, szSQL, tmpStr, szSysDate
		, szNewGroupObject, szPrevGroupObject, szNewGroupFee, szPrevGroupFee, szReportTitle, szTotal, szNguoithu;
	double nGroupObjectTotal = 0, nGroupFeeTotal = 0, nTotal = 0, nAmt = 0;
	bool bNewGroupObject = false, bNewGroupFee = false;
	int nIdx = 1;

	if (szPaymentMethod == _T("TM"))
	{
		szReportTitle = _T("BẢNG KÊ CHI TIẾT VIỆN PHÍ TIỀN MẶT THEO NGƯỜI THU");
	}
	else if (szPaymentMethod == _T("ATM"))
	{
		szReportTitle = _T("BẢNG KÊ CHI TIẾT VIỆN PHÍ THU QUA THẺ THEO NGƯỜI THU");
	}
	else
	{
		szReportTitle = _T("BẢNG KÊ CHI TIẾT VIỆN PHÍ THU QUA CHUYỂN KHOẢN THEO NGƯỜI THU");
	}


	if (szPaymentMethod == _T("TM"))
	{
		szNguoithu = _T("THỦ QUỸ");
	}
	else
	{
		szNguoithu = _T("KẾ TOÁN NGÂN HÀNG");
	}


	szFilePath = _T("Reports\\HMS\\FM_CHITIET_TIENMAT_THEONGUOITHU.RPT");
	if (!rpt.Init(szFilePath))
	{
		return;
	}
	szSQL.Format(_T(" SELECT docno,") \
		_T("   patname,") \
		_T("   sohoadon,") \
		_T("   objectid,") \
		_T("   CASE") \
		_T("     WHEN objectid = 7") \
		_T("     THEN 'A'") \
		_T("     ELSE 'B'") \
		_T("   END AS object_index,") \
		_T("   CASE") \
		_T("     WHEN objectid = 7") \
		_T("     THEN 'Bệnh nhân dịch vụ (I+II-III-IV)'") \
		_T("     ELSE 'Bệnh nhân bảo hiểm y tế (I+II-III-IV)'") \
		_T("   END AS object_desc,") \
		_T("   hinhthuctt,") \
		_T("   ly_do,") \
		_T("   ma_ly_do,") \
		_T("   nguoithu,") \
		_T("   ngaythu,") \
		_T("   sotien") \
		_T(" FROM") \
		_T("   (SELECT hfe_docno             AS docno,") \
		_T("     Get_patientname (hfe_docno) AS patname,") \
		_T("     hfe_invoiceno               AS sohoadon,") \
		_T("     hfe_objectid                AS objectid,") \
		_T("     CASE") \
		_T("       WHEN hfe_objectid = 7") \
		_T("       THEN 1") \
		_T("       ELSE 2") \
		_T("     END                                              AS objectindex,") \
		_T("     case when hfe_payment_method = 'TM1' then 'TM'") \
		_T("     when hfe_payment_method IN ('TTD', 'ATM') then 'ATM'") \
		_T("     else 'CK' end AS hinhthuctt,") \
		_T("     CAST ('Tổng hợp thu viện phí' AS NVARCHAR2 (65)) AS ly_do,") \
		_T("     'I'                                              AS ma_ly_do,") \
		_T("     hfe_staff                                        AS nguoithu,") \
		_T("     fac_updateddate                                     as ngaythu,") \
		_T("     hfe_payment                                      AS sotien") \
		_T("   FROM hms_fee_invoice") \
		_T(" LEFT JOIN fa_cash ON (hfe_cash_id = fac_cash_id)") \
		_T("   WHERE 1=1") \
		_T("   AND hfe_status  = 'P'") \
		_T("   UNION ALL") \
		_T("   SELECT hfe_docno              AS docno,") \
		_T("     Get_patientname (hfe_docno) AS patname,") \
		_T("     hfe_invoiceno               AS sohoadon,") \
		_T("     hfe_objectid                AS objectid,") \
		_T("     CASE") \
		_T("       WHEN hfe_objectid = 7") \
		_T("       THEN 1") \
		_T("       ELSE 2") \
		_T("     END                                                      AS objectindex,") \
		_T("     case when hfe_payment_method = 'TM1' then 'TM'") \
		_T("     when hfe_payment_method IN ('TTD', 'ATM') then 'ATM'") \
		_T("     else 'CK' end AS hinhthuctt,") \
		_T("     CAST ('Tổng hợp thu tạm ứng viện phí' AS NVARCHAR2 (65)) AS ly_do,") \
		_T("     'II'                                                     AS ma_ly_do,") \
		_T("     hfe_staff                                                AS nguoithu,") \
		_T("     fac_updateddate											  as ngaythu,") \
		_T("     hfe_amount                                               AS sotien") \
		_T("   FROM hms_fee_deposit") \
		_T(" LEFT JOIN fa_cash ON (hfe_cash_id = fac_cash_id)") \
		_T("   WHERE 1=1") \
		_T("   AND hfe_status <> 'C'") \
		_T("   UNION ALL") \
		_T("   SELECT hfe_docno              AS docno,") \
		_T("     Get_patientname (hfe_docno) AS patname,") \
		_T("     hfe_invoiceno               AS sohoadon,") \
		_T("     hfe_objectid                AS objectid,") \
		_T("     CASE") \
		_T("       WHEN hfe_objectid = 7") \
		_T("       THEN 1") \
		_T("       ELSE 2") \
		_T("     END                                                      AS objectindex,") \
		_T("     case when hfe_payment_method = 'TM1' then 'TM'") \
		_T("     when hfe_payment_method IN ('TTD', 'ATM') then 'ATM'") \
		_T("     else 'CK' end AS hinhthuctt,") \
		_T("     CAST ('Tổng hợp chi hoàn trả dịch vụ' AS NVARCHAR2 (65)) AS ly_do,") \
		_T("     'IV'                                                      AS ma_ly_do,") \
		_T("     hfe_staff                                                AS nguoithu,") \
		_T("     fac_updateddate                                             as ngaythu,") \
		_T("     hfe_amount                                               AS sotien") \
		_T("   FROM hms_fee_refund") \
		_T(" LEFT JOIN fa_cash ON (hfe_cash_id = fac_cash_id)") \
		_T("   WHERE 1=1") \
		_T("   AND hfe_status                = 'P'") \
		_T("   AND hfe_type                  = 'F'") \
		_T("   AND NVL (hfe_serialno, 'XX') = 'XX'") \
		_T("   UNION ALL") \
		_T("   SELECT hfe_docno              AS docno,") \
		_T("     Get_patientname (hfe_docno) AS patname,") \
		_T("     hfe_invoiceno               AS sohoadon,") \
		_T("     hfe_objectid                AS objectid,") \
		_T("     CASE") \
		_T("       WHEN hfe_objectid = 7") \
		_T("       THEN 1") \
		_T("       ELSE 2") \
		_T("     END                                                     AS objectindex,") \
		_T("     case when hfe_payment_method = 'TM1' then 'TM'") \
		_T("     when hfe_payment_method IN ('TTD', 'ATM') then 'ATM'") \
		_T("     else 'CK' end AS hinhthuctt,") \
		_T("     CAST ('Tổng hợp chi trả lại tạm gửi' AS NVARCHAR2 (65)) AS ly_do,") \
		_T("    'III'                                                     AS ma_ly_do,") \
		_T("     hfe_staff                                               AS nguoithu,") \
		_T("     fac_updateddate                                         as ngaythu,") \
		_T("     hfe_amount                                              AS sotien") \
		_T("   FROM hms_fee_refund") \
		_T(" LEFT JOIN fa_cash ON (hfe_cash_id = fac_cash_id)") \
		_T("   WHERE 1=1") \
		_T("   AND hfe_status               = 'P'") \
		_T("   AND hfe_type                 IN ('F', 'G', 'V')") \
		_T("   AND NVL (hfe_serialno, 'XX') <> 'XX'") \
		_T("   )") \
		_T(" WHERE sotien > 0 ") \
		_T(" and ngaythu BETWEEN to_timestamp('%s', 'yyyy/mm/dd hh24:mi:ss') ") \
		_T(" AND to_timestamp('%s', 'yyyy/mm/dd hh24:mi:ss')") \
		_T(" and nguoithu = '%s'") \
		_T(" and hinhthuctt = '%s'") \
		_T(" ORDER BY object_index,") \
		_T("   ma_ly_do "), szFromDate, szToDate, szClerk, szPaymentMethod);


	rs.ExecSQL(szSQL);

	//_msg(_T("%s"), szSQL);

	if (rs.IsEOF())
	{
		return;
	}
	szPrevGroupObject.Empty();
	szPrevGroupFee.Empty();
	rptDetail = rpt.GetReportHeader();
	rptDetail->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptDetail->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptDetail->SetValue(_T("titlereport"), szReportTitle);
	//rptDetail->SetValue(_T("ReportDate"), _T(""));

	tmpStr.Format(rptDetail->GetValue(_T("ReportDate")), CDate::Convert(szFromDate, yyyymmdd, ddmmyyyy), CDate::Convert(szToDate, yyyymmdd, ddmmyyyy));
	rptDetail->SetValue(_T("ReportDate"), tmpStr);

	while (!rs.IsEOF())
	{
		rs.GetValue(_T("object_index"), szNewGroupObject);
		rs.GetValue(_T("ma_ly_do"), szNewGroupFee);
		if (szNewGroupObject != szPrevGroupObject)
		{
			bNewGroupObject = true;
		}
		if (szNewGroupFee != szPrevGroupFee)
		{
			bNewGroupFee = true;
		}
		if (bNewGroupObject == true)
		{
			bNewGroupFee = true;
		}
		if (bNewGroupObject)
		{
			if (nGroupObjectTotal != 0)
			{
				nAmt = Round(nGroupObjectTotal);
				nTotal += nAmt;
				FormatCurrency(nAmt, szTotal);
				if (nGroupObjectTotal < 0)
					tmpStr.Format(_T("(%s)"), szTotal);
				else
					tmpStr.Format(_T("%s"), szTotal);
				rptGroupObject->SetValue(_T("s5"), tmpStr);
				nGroupObjectTotal = 0;
			}
			rptGroupObject = rpt.AddDetail(rpt.GetGroupHeader(0));
			if (rptGroupObject == NULL)
			{
				_tprintf(_T("\nNULL rptGroupObject"));
				return;
			}
			rptGroupObject->SetValue(_T("STT"), szNewGroupObject);
			rptGroupObject->SetValue(_T("GroupName"), rs.GetValue(_T("object_desc")));
			szPrevGroupObject = szNewGroupObject;
			bNewGroupObject = false;
		}
		if (bNewGroupFee)
		{
			_tprintf(_T("\nnGroupFeeTotal:%f"), nGroupFeeTotal);
			if (nGroupFeeTotal != 0)
			{
				FormatCurrency(nGroupFeeTotal, szTotal);
				if (nGroupFeeTotal < 0)
					tmpStr.Format(_T("(%s)"), szTotal);
				else
					tmpStr.Format(_T("%s"), szTotal);
				_tprintf(_T("\nnGroupFeeTotal:%f|szTotal:%s|tmpstr:%s")
					, nGroupFeeTotal, szTotal, tmpStr);
				rptGroupFee->SetValue(_T("s5"), tmpStr);
				nGroupFeeTotal = 0;
			}
			rptGroupFee = rpt.AddDetail(rpt.GetGroupHeader(0));
			if (rptGroupFee == NULL)
			{
				_tprintf(_T("\nNULL rptGroupFee"));
				return;
			}
			rptGroupFee->SetValue(_T("STT"), szNewGroupFee);
			rptGroupFee->SetValue(_T("GroupName"), rs.GetValue(_T("ly_do")));
			szPrevGroupFee = szNewGroupFee;
			bNewGroupFee = false;
			nIdx = 1;
		}
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx++));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("patname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("docno")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("sohoadon")));
		rs.GetValue(_T("sotien"), nAmt);
		rptDetail->SetValue(_T("5"), double2str(nAmt));
		nGroupFeeTotal += nAmt;
		if (szNewGroupFee == _T("I") || szNewGroupFee == _T("II"))
		{
			nGroupObjectTotal += nAmt;
		}
		else
		{
			nGroupObjectTotal -= nAmt;
		}
		rs.MoveNext();
	}
	if (nGroupObjectTotal != 0)
	{
		nAmt = Round(nGroupObjectTotal);
		nTotal += nAmt;
		FormatCurrency(nAmt, szTotal);
		if (nGroupObjectTotal < 0)
			tmpStr.Format(_T("(%s)"), szTotal);
		else
			tmpStr.Format(_T("%s"), szTotal);
		rptGroupObject->SetValue(_T("s5"), tmpStr);
	}
	if (nGroupFeeTotal != 0)
	{
		FormatCurrency(nGroupFeeTotal, szTotal);
		if (nGroupFeeTotal < 0)
			tmpStr.Format(_T("(%s)"), szTotal);
		else
			tmpStr.Format(_T("%s"), szTotal);
		rptGroupFee->SetValue(_T("s5"), tmpStr);
	}
	if (nTotal != 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
		if (rptDetail)
		{
			rptDetail->SetValue(_T("TotalGroup"), _T("Cộng (A+B)"));
			FormatCurrency(nTotal, szTotal);
			if (nTotal < 0)
				tmpStr.Format(_T("(%s)"), szTotal);
			else
				tmpStr.Format(_T("%s"), szTotal);
			rptDetail->SetValue(_T("t5"), tmpStr);
		}
	}
	szSysDate = pMF->GetSysDateTime();
	tmpStr.Format(
		_T("%s Giờ, Ngày %s tháng %s năm %s")
		, szSysDate.Mid(11, 5), szSysDate.Mid(8, 2),
		szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("nguoi_thu"), szNguoithu);

	rpt.GetReportFooter()->SetValue(_T("LockedBy"), pMF->GetDoctorName(pMF->GetCurrentUser()));

	rpt.PrintPreview();
}

void CPrintForms::OnPrintPhieuDangKyHoanUng(long nDocNo, long nIdx)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();

	CRecord rs(&pMF->m_db);
    CString szSQL;
	CReport rpt;
	CReportSection* rptDetail = NULL, * rptHeader = NULL, * rptGroup = NULL;
	double nthanhtien, nTotalthanhtien = 0;
	double nbntra, nTotalbntra = 0;
	int nId = 1;

	//Nếu đã có bản ghi được ký rồi thì download về
    szSQL.Format(_T("select hms_signature_id ")
             _T("	from hms_signature WHERE docno = %ld and orderid = %ld ")            
             _T(" and status ='S' and form_id = 'MB_DANGKY_HOANLAI' "), nDocNo, nIdx); 

    rs.ExecSQL(szSQL);

    if (!rs.IsEOF())
    {
        CString szSignatureID = rs.GetValue(_T("hms_signature_id"));

        CPdfSignature signer(pMF);

        if (signer.DownloadAndPreview(szSignatureID, true))
        {
           
        }
        return;
      
    }

	CString szReportName, szDate, szTemp, tmpStr, tmpStr2, szbyqr;
	CString szGroupName = _T("I. Các dịch vụ / mặt hàng hoàn trả");

	szReportName = _T("Reports\\HMS\\HF_REFUNDFEESHOLDER.RPT");
	if (!rpt.Init(szReportName))
		return;

	szSQL.Format(_T(" SELECT") \
		_T("      HBCL_NAME as nguoilamdon_ten,") \
		_T("      to_char(hbcl_yob, 'DD/MM/YYYY') as birthdate,") \
		_T("      HBCL_ADDRESS as Address,") \
		_T("      HBCL_PHONE as Phone,") \
		_T("      HBCL_IDCARD as cccd,") \
		_T("      to_char(hd_icard_issuedate, 'DD/MM/YYYY') as ngaycap,") \
		_T("      (select sp_name from sys_prov where hd_icard_issueplace = sp_id) as noicap,") \
		_T("      (select ss_desc from sys_sel where ss_code = hbcl_relation and ss_id ='hrm_relation') AS quanhenguoibenh,") \
		_T("      GET_PATIENTNAME(hbcl_docno) as patientname,") \
		_T("      to_char(hp_birthdate, 'DD/MM/YYYY') as patbirthdate,     ") \
		_T("      sys_sel_getname('sys_sex', hp_sex) as sex,") \
		_T("      hd_patientno as masonguoibenh,") \
		_T("      hd_docno as sohoso,") \
		_T("      hbcl_id as sothutu,") \
		_T("      (select SD_ID_ALIAS from sys_dept where hbcl_deptid= sd_id) as Department,") \
		_T("      HBCL_ACCOUNTNUMBER as accountnumber,") \
		_T("      HBCL_ACCOUNTHOLDER as Useaccount,") \
		_T("      (select ADB_NAME from ad_bank where HBCL_BANKNAME = adb_bank_id) as bankname,") \
		_T("      HBCL_BRANCHNAME as chinhanhpgd,") \
		_T("      HBCL_CREATEDDATE as ngaytao,") \
		_T("      GET_USERNAME(HBCL_CREATEDBY) nguoitao,") \
		_T("      NVL(hbcl_isqr, 'N') byqr") \
		_T(" FROM") \
		_T("       hms_bankcustomerlist") \
		_T(" LEFT JOIN hms_doc ON (hbcl_docno = hd_docno)") \
		_T(" LEFT JOIN hms_patient ON (hd_patientno = hp_patientno)") \
		_T(" WHERE") \
		_T("       hbcl_docno = %ld") \
		_T("       and hbcl_id=%ld"), nDocNo, nIdx);

	rs.ExecSQL(szSQL);
	//_msg(_T("%s"), szSQL);
	if (rs.IsEOF())
	{
		AfxMessageBox(_T("No Data."));
		return;
	}
	rpt.GetReportHeader()->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);

	rpt.GetReportHeader()->SetValue(_T("nguoilamdon_ten"), rs.GetValue(_T("nguoilamdon_ten")));
	rpt.GetReportHeader()->SetValue(_T("birthdate"), rs.GetValue(_T("birthdate")));
	rpt.GetReportHeader()->SetValue(_T("Address"), rs.GetValue(_T("Address"))); \
		rpt.GetReportHeader()->SetValue(_T("Phone"), rs.GetValue(_T("Phone")));
	rpt.GetReportHeader()->SetValue(_T("cccd"), rs.GetValue(_T("cccd")));
	rpt.GetReportHeader()->SetValue(_T("ngaycap"), rs.GetValue(_T("ngaycap")));
	rpt.GetReportHeader()->SetValue(_T("noicap"), rs.GetValue(_T("noicap")));
	rpt.GetReportHeader()->SetValue(_T("quanhenguoibenh"), rs.GetValue(_T("quanhenguoibenh")));
	rpt.GetReportHeader()->SetValue(_T("patientname"), rs.GetValue(_T("patientname")));

	rpt.GetReportHeader()->SetValue(_T("patbirthdate"), rs.GetValue(_T("patbirthdate")));
	rpt.GetReportHeader()->SetValue(_T("sex"), rs.GetValue(_T("sex")));
	rpt.GetReportHeader()->SetValue(_T("masonguoibenh"), rs.GetValue(_T("masonguoibenh")));

	rpt.GetReportHeader()->SetValue(_T("sohoso"), rs.GetValue(_T("sohoso")));
	rpt.GetReportHeader()->SetValue(_T("sothutu"), rs.GetValue(_T("sothutu")));
	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("Department")));

	rpt.GetReportHeader()->SetValue(_T("accountnumber"), rs.GetValue(_T("accountnumber")));
	rpt.GetReportHeader()->SetValue(_T("Useaccount"), rs.GetValue(_T("Useaccount")));
	rpt.GetReportHeader()->SetValue(_T("bankname"), rs.GetValue(_T("bankname")));
	rpt.GetReportHeader()->SetValue(_T("chinhanhpgd"), rs.GetValue(_T("chinhanhpgd")));
	rpt.GetReportHeader()->SetValue(_T("nguoitao"), rs.GetValue(_T("nguoitao")));
	rpt.GetReportHeader()->SetValue(_T("nguoilamdon_ten"), rs.GetValue(_T("nguoilamdon_ten")));
	rs.GetValue(_T("byqr"), szbyqr);

	if (szbyqr == _T("Y"))
	{
		rpt.GetReportHeader()->SetValue(_T("chuyenkhoan"), _T("X"));
	}
	else
	{
		rpt.GetReportHeader()->SetValue(_T("tienmat"), _T("X"));
	}

	rs.GetValue(_T("ngaytao"), tmpStr);
	tmpStr2 = rpt.GetReportFooter()->GetValue(_T("ngaytao"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportFooter()->SetValue(_T("ngaytao"), szDate);

	tmpStr = pMF->GetSysDateTime();
	tmpStr2 = rpt.GetReportHeader()->GetValue(_T("PrintDate"));
	szDate.Format(tmpStr2, tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);

	rpt.PrintPreview();
}void CPrintForms::InVienPhiQR(CString szClerk, CString szPaymentMethod, CString szFromDate, CString szToDate)
{
	//Hàm này dùng để in ra danh sách các user duyệt qr nhưng không phải user qronline!
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CReport rpt;
	CReportSection* rptGroupObject = NULL, * rptGroupFee = NULL, * rptDetail = NULL;
	CString szFilePath, szSQL, tmpStr, szSysDate
		, szNewGroupObject, szPrevGroupObject, szNewGroupFee, szPrevGroupFee, szReportTitle, szTotal, szNguoithu;
	double nGroupObjectTotal = 0, nGroupFeeTotal = 0, nTotal = 0, nAmt = 0;
	bool bNewGroupObject = false, bNewGroupFee = false;
	int nIdx = 1;

	if (szPaymentMethod == _T("TM"))
	{
		szReportTitle = _T("BẢNG KÊ CHI TIẾT VIỆN PHÍ TIỀN MẶT THEO NGƯỜI THU");
	}
	else if (szPaymentMethod == _T("ATM"))
	{
		szReportTitle = _T("BẢNG KÊ CHI TIẾT VIỆN PHÍ THU QUA THẺ THEO NGƯỜI THU");
	}
	else if (szPaymentMethod == _T("CK"))

	{
		szReportTitle = _T("BẢNG KÊ CHI TIẾT VIỆN PHÍ THU QUA CHUYỂN KHOẢN THEO NGƯỜI THU");
	}
	else
	{
		szReportTitle = _T("BẢNG KÊ CHI TIẾT VIỆN PHÍ THU QUA QR THEO NGƯỜI THU");
	}


	if (szPaymentMethod == _T("TM"))
	{
		szNguoithu = _T("THỦ QUỸ");
	}
	else
	{
		szNguoithu = _T("KẾ TOÁN NGÂN HÀNG");
	}


	szFilePath = _T("Reports\\HMS\\FM_CHITIET_QR_THEONGUOITHU.RPT");
	if (!rpt.Init(szFilePath))
	{
		return;
	}
	szSQL.Format(_T(" SELECT docno,") \
		_T("   patname,") \
		_T("   sohoadon,") \
		_T("   objectid,") \
		_T("   CASE") \
		_T("     WHEN objectid = 7") \
		_T("     THEN 'A'") \
		_T("     ELSE 'B'") \
		_T("   END AS object_index,") \
		_T("   CASE") \
		_T("     WHEN objectid = 7") \
		_T("     THEN 'Bệnh nhân dịch vụ (I+II-III-IV)'") \
		_T("     ELSE 'Bệnh nhân bảo hiểm y tế (I+II-III-IV)'") \
		_T("   END AS object_desc,") \
		_T("   hinhthuctt,") \
		_T("   ly_do,") \
		_T("   ma_ly_do,") \
		_T("   nguoithu,") \
		_T("   ngaythu,") \
		_T("   sotien") \
		_T(" FROM") \
		_T("   (SELECT hfe_docno             AS docno,") \
		_T("     Get_patientname (hfe_docno) AS patname,") \
		_T("     hfe_invoiceno               AS sohoadon,") \
		_T("     hfe_objectid                AS objectid,") \
		_T("     CASE") \
		_T("       WHEN hfe_objectid = 7") \
		_T("       THEN 1") \
		_T("       ELSE 2") \
		_T("     END                                              AS objectindex,") \
		_T("     hfe_payment_method AS hinhthuctt,") \
		_T("     CAST ('Tổng hợp thu viện phí' AS NVARCHAR2 (65)) AS ly_do,") \
		_T("     'I'                                              AS ma_ly_do,") \
		_T("     hfe_staff                                        AS nguoithu,") \
		_T("     hfe_date                                     as ngaythu,") \
		_T("     hfe_payment                                      AS sotien") \
		_T("   FROM hms_fee_invoice") \
		_T(" LEFT JOIN fa_cash ON (hfe_cash_id = fac_cash_id)") \
		_T("   WHERE 1=1") \
		_T("   AND hfe_status  = 'P'") \
		_T("   UNION ALL") \
		_T("   SELECT hfe_docno              AS docno,") \
		_T("     Get_patientname (hfe_docno) AS patname,") \
		_T("     hfe_invoiceno               AS sohoadon,") \
		_T("     hfe_objectid                AS objectid,") \
		_T("     CASE") \
		_T("       WHEN hfe_objectid = 7") \
		_T("       THEN 1") \
		_T("       ELSE 2") \
		_T("     END                                                      AS objectindex,") \
		_T("     hfe_payment_method AS hinhthuctt,") \
		_T("     CAST ('Tổng hợp thu tạm ứng viện phí' AS NVARCHAR2 (65)) AS ly_do,") \
		_T("     'II'                                                     AS ma_ly_do,") \
		_T("     hfe_staff                                                AS nguoithu,") \
		_T("     hfe_date											  as ngaythu,") \
		_T("     hfe_amount                                               AS sotien") \
		_T("   FROM hms_fee_deposit") \
		_T(" LEFT JOIN fa_cash ON (hfe_cash_id = fac_cash_id)") \
		_T("   WHERE 1=1") \
		_T("   AND hfe_status <> 'C'") \
		_T("   UNION ALL") \
		_T("   SELECT hfe_docno              AS docno,") \
		_T("     Get_patientname (hfe_docno) AS patname,") \
		_T("     hfe_invoiceno               AS sohoadon,") \
		_T("     hfe_objectid                AS objectid,") \
		_T("     CASE") \
		_T("       WHEN hfe_objectid = 7") \
		_T("       THEN 1") \
		_T("       ELSE 2") \
		_T("     END                                                      AS objectindex,") \
		_T("     hfe_payment_method AS hinhthuctt,") \
		_T("     CAST ('Tổng hợp chi hoàn trả dịch vụ' AS NVARCHAR2 (65)) AS ly_do,") \
		_T("     'IV'                                                      AS ma_ly_do,") \
		_T("     hfe_staff                                                AS nguoithu,") \
		_T("     hfe_date                                             as ngaythu,") \
		_T("     hfe_amount                                               AS sotien") \
		_T("   FROM hms_fee_refund") \
		_T(" LEFT JOIN fa_cash ON (hfe_cash_id = fac_cash_id)") \
		_T("   WHERE 1=1") \
		_T("   AND hfe_status                = 'P'") \
		_T("   AND hfe_type                  = 'F'") \
		_T("   AND NVL (hfe_serialno, 'XX') = 'XX'") \
		_T("   UNION ALL") \
		_T("   SELECT hfe_docno              AS docno,") \
		_T("     Get_patientname (hfe_docno) AS patname,") \
		_T("     hfe_invoiceno               AS sohoadon,") \
		_T("     hfe_objectid                AS objectid,") \
		_T("     CASE") \
		_T("       WHEN hfe_objectid = 7") \
		_T("       THEN 1") \
		_T("       ELSE 2") \
		_T("     END                                                     AS objectindex,") \
		_T("     hfe_payment_method AS hinhthuctt,") \
		_T("     CAST ('Tổng hợp chi trả lại tạm gửi' AS NVARCHAR2 (65)) AS ly_do,") \
		_T("    'III'                                                     AS ma_ly_do,") \
		_T("     hfe_staff                                               AS nguoithu,") \
		_T("     hfe_date                                         as ngaythu,") \
		_T("     hfe_amount                                              AS sotien") \
		_T("   FROM hms_fee_refund") \
		_T(" LEFT JOIN fa_cash ON (hfe_cash_id = fac_cash_id)") \
		_T("   WHERE 1=1") \
		_T("   AND hfe_status               = 'P'") \
		_T("   AND hfe_type                 IN ('F', 'G', 'V')") \
		_T("   AND NVL (hfe_serialno, 'XX') <> 'XX'") \
		_T("   )") \
		_T(" WHERE sotien > 0 ") \
		_T(" and ngaythu BETWEEN to_timestamp('%s', 'yyyy/mm/dd hh24:mi:ss') ") \
		_T(" AND to_timestamp('%s', 'yyyy/mm/dd hh24:mi:ss')") \
		_T(" and NVL(nguoithu, 'XX') <> '%s'") \
		_T(" and hinhthuctt = '%s'") \
		_T(" ORDER BY object_index,") \
		_T("   ma_ly_do "), szFromDate, szToDate, szClerk, szPaymentMethod);

	//_msg(_T("%s"), szSQL);
	rs.ExecSQL(szSQL);



	if (rs.IsEOF())
	{
		ShowMessageBox(_T("No Data"), MB_OK);
		return;
	}
	szPrevGroupObject.Empty();
	szPrevGroupFee.Empty();
	rptDetail = rpt.GetReportHeader();
	rptDetail->SetValue(_T("HealthService"), pMF->m_szHealthService);
	rptDetail->SetValue(_T("HospitalName"), pMF->m_szHospitalName);
	rptDetail->SetValue(_T("titlereport"), szReportTitle);
	//rptDetail->SetValue(_T("ReportDate"), _T(""));

	tmpStr.Format(rptDetail->GetValue(_T("ReportDate")), CDate::Convert(szFromDate, yyyymmdd, ddmmyyyy), CDate::Convert(szToDate, yyyymmdd, ddmmyyyy));
	rptDetail->SetValue(_T("ReportDate"), tmpStr);

	while (!rs.IsEOF())
	{
		rs.GetValue(_T("object_index"), szNewGroupObject);
		rs.GetValue(_T("ma_ly_do"), szNewGroupFee);
		if (szNewGroupObject != szPrevGroupObject)
		{
			bNewGroupObject = true;
		}
		if (szNewGroupFee != szPrevGroupFee)
		{
			bNewGroupFee = true;
		}
		if (bNewGroupObject == true)
		{
			bNewGroupFee = true;
		}
		if (bNewGroupObject)
		{
			if (nGroupObjectTotal != 0)
			{
				nAmt = Round(nGroupObjectTotal);
				nTotal += nAmt;
				FormatCurrency(nAmt, szTotal);
				if (nGroupObjectTotal < 0)
					tmpStr.Format(_T("(%s)"), szTotal);
				else
					tmpStr.Format(_T("%s"), szTotal);
				rptGroupObject->SetValue(_T("s5"), tmpStr);
				nGroupObjectTotal = 0;
			}
			rptGroupObject = rpt.AddDetail(rpt.GetGroupHeader(0));
			if (rptGroupObject == NULL)
			{
				_tprintf(_T("\nNULL rptGroupObject"));
				return;
			}
			rptGroupObject->SetValue(_T("STT"), szNewGroupObject);
			rptGroupObject->SetValue(_T("GroupName"), rs.GetValue(_T("object_desc")));
			szPrevGroupObject = szNewGroupObject;
			bNewGroupObject = false;
		}
		if (bNewGroupFee)
		{
			_tprintf(_T("\nnGroupFeeTotal:%f"), nGroupFeeTotal);
			if (nGroupFeeTotal != 0)
			{
				FormatCurrency(nGroupFeeTotal, szTotal);
				if (nGroupFeeTotal < 0)
					tmpStr.Format(_T("(%s)"), szTotal);
				else
					tmpStr.Format(_T("%s"), szTotal);
				_tprintf(_T("\nnGroupFeeTotal:%f|szTotal:%s|tmpstr:%s")
					, nGroupFeeTotal, szTotal, tmpStr);
				rptGroupFee->SetValue(_T("s5"), tmpStr);
				nGroupFeeTotal = 0;
			}
			rptGroupFee = rpt.AddDetail(rpt.GetGroupHeader(0));
			if (rptGroupFee == NULL)
			{
				_tprintf(_T("\nNULL rptGroupFee"));
				return;
			}
			rptGroupFee->SetValue(_T("STT"), szNewGroupFee);
			rptGroupFee->SetValue(_T("GroupName"), rs.GetValue(_T("ly_do")));
			szPrevGroupFee = szNewGroupFee;
			bNewGroupFee = false;
			nIdx = 1;
		}
		rptDetail = rpt.AddDetail();
		rptDetail->SetValue(_T("1"), int2str(nIdx++));
		rptDetail->SetValue(_T("2"), rs.GetValue(_T("patname")));
		rptDetail->SetValue(_T("3"), rs.GetValue(_T("docno")));
		rptDetail->SetValue(_T("4"), rs.GetValue(_T("sohoadon")));
		rs.GetValue(_T("sotien"), nAmt);
		rptDetail->SetValue(_T("5"), double2str(nAmt));
		nGroupFeeTotal += nAmt;
		if (szNewGroupFee == _T("I") || szNewGroupFee == _T("II"))
		{
			nGroupObjectTotal += nAmt;
		}
		else
		{
			nGroupObjectTotal -= nAmt;
		}

		rptDetail->SetValue(_T("6"), rs.GetValue(_T("nguoithu")));
		rs.MoveNext();
	}
	if (nGroupObjectTotal != 0)
	{
		nAmt = Round(nGroupObjectTotal);
		nTotal += nAmt;
		FormatCurrency(nAmt, szTotal);
		if (nGroupObjectTotal < 0)
			tmpStr.Format(_T("(%s)"), szTotal);
		else
			tmpStr.Format(_T("%s"), szTotal);
		rptGroupObject->SetValue(_T("s5"), tmpStr);
	}
	if (nGroupFeeTotal != 0)
	{
		FormatCurrency(nGroupFeeTotal, szTotal);
		if (nGroupFeeTotal < 0)
			tmpStr.Format(_T("(%s)"), szTotal);
		else
			tmpStr.Format(_T("%s"), szTotal);
		rptGroupFee->SetValue(_T("s5"), tmpStr);
	}
	if (nTotal != 0)
	{
		rptDetail = rpt.AddDetail(rpt.GetGroupFooter(1));
		if (rptDetail)
		{
			rptDetail->SetValue(_T("TotalGroup"), _T("Cộng (A+B)"));
			FormatCurrency(nTotal, szTotal);
			if (nTotal < 0)
				tmpStr.Format(_T("(%s)"), szTotal);
			else
				tmpStr.Format(_T("%s"), szTotal);
			rptDetail->SetValue(_T("t5"), tmpStr);
		}
	}
	szSysDate = pMF->GetSysDateTime();
	tmpStr.Format(
		_T("%s Giờ, Ngày %s tháng %s năm %s")
		, szSysDate.Mid(11, 5), szSysDate.Mid(8, 2),
		szSysDate.Mid(5, 2), szSysDate.Left(4));
	rpt.GetReportFooter()->SetValue(_T("PrintDate"), tmpStr);
	rpt.GetReportFooter()->SetValue(_T("nguoi_thu"), szNguoithu);

	rpt.GetReportFooter()->SetValue(_T("LockedBy"), pMF->GetDoctorName(pMF->GetCurrentUser()));

	rpt.PrintPreview();
}

void CPrintForms::PrintSurgeryPayment(long nSOrderID, long nDocumentNo, CString szDeptID)
{
	CHMSMainFrame* pMF = (CHMSMainFrame*)AfxGetMainWnd();
	CRecord rs(&pMF->m_db);
	CRecord rsl(&pMF->m_db);
	CRecord rss(&pMF->m_db);	
	CString tmpStr, tmpStrIdx, szSQL, szGroups, szReportName, szReportName2, szObjectKey, szrecordno;

	szSQL.Format(_T(" SELECT    hd_patientno                    AS patientno, ") \
		_T("           hcr_recordno                    AS recordno, ") \
		_T("           Trim(hp_surname ") \
		_T("                ||' ' ") \
		_T("                ||hp_midname ") \
		_T("                ||' ' ") \
		_T("                ||hp_firstname)            AS pname, ") \
		_T("           Extract(YEAR FROM hp_birthdate) AS birthdate, ") \
		_T("           hp_birthdate                    AS birthdate1, ") \
		_T("           get_syssel_desc('sys_sex', hp_sex)                          AS sex, ") \
		_T("           sp_name                         AS provname, ") \
		_T("           sys_dist.sd_name                AS distname, ") \
		_T("           sv_name                         AS villname, ") \
		_T("           hp_dtladdr                      AS address, ") \
		_T("           hp_workplace                    AS workplace, ") \
		_T("           hp_rank                         AS rank, ") \
		_T("           hd_object                       AS obj, ") \
		_T("		   get_objectname(hd_object)	   AS objname,") \
		_T("           hd_doctor                       AS doctor, ") \
		_T("           hd_indept                       AS deptid, ") \
		_T("		   get_departmentname(hd_indept)   AS deptname,") \
		_T("           hc_cardno                       AS cardno, ") \
		_T("           hd_disrate                      AS insrate, ") \
		_T("           hd_isinpatient                  AS inpatient, ") \
		_T("           hcr_admitdate                   AS admitdate, ") \
		_T("           hd_diagnostic                   AS diagnostic ") \
		_T(" FROM      hms_patient ") \
		_T(" LEFT JOIN hms_doc ON( hd_patientno = hp_patientno ) ") \
		_T(" LEFT JOIN hms_clinical_record ON( hcr_docno = hd_docno ) ") \
		_T(" LEFT JOIN hms_card ON( hc_patientno = hp_patientno ") \
		_T("                        AND hc_idx = hd_cardidx ") \
		_T("                        AND hc_cardno = hd_cardno ) ") \
		_T(" LEFT JOIN sys_dept ON( sys_dept.sd_id = hd_indept ) ") \
		_T(" LEFT JOIN sys_prov ON( sp_id = hp_provid ) ") \
		_T(" LEFT JOIN sys_dist ON( sd_provid = hp_provid ") \
		_T("                        AND sys_dist.sd_id = hp_distid ) ") \
		_T(" LEFT JOIN sys_vill ON( sv_id = hp_villid ") \
		_T("                        AND sv_distid = hp_distid ") \
		_T("                        AND sv_id = hp_villid ) ") \
		_T(" WHERE     hd_docno = %ld "), nDocumentNo);
	
	rs.ExecSQL(szSQL);

	if (rs.IsEOF()) 
	{
		_tprintf(_T("\r\nNo Patient!"));
		return;
	}
	rs.GetValue(_T("obj"), szObjectKey);

	rs.GetValue(_T("recordno"), szrecordno);

	static CReport rpt;
	CReportSection *grp;
   

	TCHAR *lpszChapter[] = {_T("I"), _T("II"), _T("III"), _T("IV"), _T("V"),
		                    _T("VI"), _T("VII"), _T("VIII"), _T("IX"), _T("X"), _T("XI")};
	int nChapter = 0;
	
	
	if (szObjectKey == _T("1") || szObjectKey ==_T("7") || szObjectKey ==_T("8"))	
	{
		szReportName =_T("Reports/HMS/PTTT/HF_BANGKEPTTT_QUAN_DICHVU_B5.RPT");
        szReportName2 = _T("HF_BANGKEPTTT_QUAN_DICHVU_B5");
	}
	else
	{
		szReportName =_T("Reports/HMS/PTTT/HF_INSDISCHARGEPAYMENT_B5.RPT");
        szReportName2 = _T("HF_INSDISCHARGEPAYMENT_B5");
	}
		

	if (!rpt.Init(szReportName))
	{
		ShowMessageBox(_T("Can not open file report."), MB_OK);
		return;
	}
		
	CString szDate;	
	tmpStr = pMF->GetSysDateTime();
	szDate.Format(rpt.GetReportHeader()->GetValue(_T("PrintDate")),
		          tmpStr.Mid(11, 5), tmpStr.Mid(8, 2), tmpStr.Mid(5, 2), tmpStr.Left(4));
	rpt.GetReportHeader()->SetValue(_T("PrintDate"), szDate);

	rpt.GetReportHeader()->SetValue(_T("HealthService"), pMF->m_CompanyInfo.sc_pname);
	rpt.GetReportHeader()->SetValue(_T("HospitalName"), pMF->m_CompanyInfo.sc_name);	
	
	tmpStr.Format(_T("%ld"), nDocumentNo);
	rpt.GetReportHeader()->SetValue(_T("DocumentNo"), tmpStr);



	//tmpStr.Format(_T("%ld"), m_nRecordNo);
	tmpStr.Format(_T("%s"), szrecordno);

	rpt.GetReportHeader()->SetValue(_T("RecordNo"), tmpStr);

	StringUpper(rs.GetValue(_T("pname")), tmpStr);
	rpt.GetReportHeader()->SetValue(_T("PATIENTNAME"), tmpStr);

	rpt.GetReportHeader()->SetValue(_T("Age"), rs.GetValue(_T("birthdate")));

	rpt.GetReportHeader()->SetValue(_T("Sex"), rs.GetValue(_T("sex")));
	
	tmpStr.Empty();
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("villname")));
	if (!tmpStr.IsEmpty())
		tmpStr += _T(" - ");
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("distname")));
	if (!tmpStr.IsEmpty())
		tmpStr += _T(" - ");
	tmpStr.AppendFormat(_T("%s"), rs.GetValue(_T("provname")));

	rpt.GetReportHeader()->SetValue(_T("Address"), tmpStr);	

	rpt.GetReportHeader()->SetValue(_T("Object"), rs.GetValue(_T("obj")));

	
	rpt.GetReportHeader()->SetValue(_T("CardNo"), rs.GetValue(_T("cardno")));	

	rpt.GetReportHeader()->SetValue(_T("Department"), rs.GetValue(_T("deptname")));
		
	//Page Header
	//Report Detail

	int nIdx = 1, nIdxl = 1;
    int OperationNumber = 0;
    int j = 0;
	CReportSection* rptDetail = NULL;
	double optcost=0, inscost=0, patpaid=0, cost=0;	
	double grpoptcost=0, grpinscost=0, grppatpaid=0, grpcost=0;	
	double grp2optcost=0, grp2inscost=0, grp2patpaid=0, grp2cost=0;	
	double ttloptcost=0, ttlinscost=0, ttlpatpaid=0, ttlcost=0;	
	double unitprice=0, qty=0;
	long nOperationIdx;

	szGroups.Empty();
	CString szTmp;
	CString szOperationIdxs;
	szOperationIdxs.Empty();	

	tmpStr.Format(_T("%ld"), nSOrderID);
    rpt.GetReportHeader()->SetValue(_T("OperationIdxs"), tmpStr);

	tmpStr.Format(_T("%s"), szReportName2);
    rpt.GetReportHeader()->SetValue(_T("szReportName2"), tmpStr);

	szSQL.Format(_T("SELECT ho_idx, ho_docno, hfl_name, ho_comment, hfl_unit, hfl_servprice, ") \
				 _T(" ho_diagnostic diagnostic, (select hst_name from hms_surgery_table where hst_idx = ho_opera_table) table_name") \
				 _T(" FROM hms_operation ") \
				 _T(" LEFT JOIN hms_fee_list ON(hfl_feeid = ho_itemid)") \
				 _T(" WHERE ho_idx = %ld AND ho_status in('A','T') ") \
				 _T(" ORDER BY ho_idx"), nSOrderID);

	rs.ExecSQL(szSQL);
	if (rs.IsEOF())
		return;
	rpt.GetReportHeader()->SetValue(_T("room"), rs.GetValue(_T("table_name")));
	rpt.GetReportHeader()->SetValue(_T("Diagnostic"), rs.GetValue(_T("diagnostic")));

	CString szComment, szTotalComment;
	CString szPharmaTable;
	double ttlOperationCost=0;
	while (!rs.IsEOF())
	{	
		szComment.Empty();
		szGroups.Empty();
		nIdx = 0;

		grp = rpt.GetGroupHeader(1);
		rptDetail = rpt.AddDetail(grp);
		tmpStr.Format(_T("%s%s"), lpszChapter[nChapter], _T("."));
		rptDetail->SetValue(_T("SubGroupID"), tmpStr);		
		rs.GetValue(_T("ho_comment"), szComment);
		
		StringUpper(rs.GetValue(_T("hfl_name")), tmpStr);
		rptDetail->SetValue(_T("SubGroupName"), tmpStr);
		rs.GetValue(_T("hfl_servprice"), cost);
		ttlOperationCost += cost;
		FormatCurrency(cost, tmpStr);
		
		rptDetail->SetValue(_T("SubGroupCost"), tmpStr);

		if (!szComment.IsEmpty())
		{
			rptDetail = rpt.AddDetail(grp);
			tmpStr.Format(_T("* %s"), szComment);
			rptDetail->SetValue(_T("SubGroupName"), tmpStr);
		}

		rs.GetValue(_T("ho_idx"), nOperationIdx);

		
		if(pMF->IsInPatient())
			szPharmaTable = _T("hms_ipharmaorder");
		else
			szPharmaTable = _T("hms_pharmaorder");

_tprintf(_T("\nInPatient: %d\n"), pMF->IsInPatient());

		//Sửa lại lấy từ view thuốc ra, fix lỗi khi nhấn in bảng kê không có dữ liệu, lý do định nghĩa nội trú (ipharma)& ngoại trú (pharma), nhưng thực tế lại ngược lại//

		//if(pMF->IsInPatient())
		{
		szSQL.Format(_T(" WITH tbl") \
					_T("      AS (SELECT hfe_desc,") \
					_T("                 Cast(hfe_unit AS NVARCHAR2(2000)) AS hfe_unit,") \
					_T("                 hfe_category,") \
					_T("                 hfe_quantity,") \
					_T("                 hfe_cost,") \
					_T("                 hfe_inspaid,") \
					_T("                 hfe_diffcost,") \
					_T("                 hfe_group,") \
					_T("                 hfe_docno,") \
					_T("                 hfe_orderid,") \
					_T("                 hfe_orderline,") \
					_T("                 hfe_type") \
					_T("          FROM   hms_fee") \
					_T("          UNION ALL") \
					_T("          SELECT x.hfe_desc,") \
					_T("                 x.hfe_unit,") \
					_T("                 x.hfe_category,") \
					_T("                 x.hfe_quantity,") \
					_T("                 x.hfe_cost,") \
					_T("                 x.hfe_inspaid,") \
					_T("                 x.hfe_diffcost,") \
					_T("                 x.hfe_group,") \
					_T("                 x.hfe_docno,") \
					_T("                 x.hfe_orderid,") \
					_T("                 x.hfe_orderline,") \
					_T("                 x.hfe_type") \
					_T("          FROM   HMS_FEE_INOPERATION_X x") \
					_T("		  LEFT JOIN hms_fee f ") \
					_T("			ON (f.hfe_type IN ('D', 'M') and x.hfe_docno = f.hfe_docno ") \
					_T("				and x.hfe_orderid = f.hfe_orderid ") \
					_T("				and x.hfe_orderline = f.hfe_orderline) ") \
					_T("		  WHERE f.hfe_fee_id IS NULL)") \
					_T(" SELECT hsd_feeidx AS grpidx,") \
					_T("   hsd_name        AS grpname,") \
					_T("   hfe_desc,") \
					_T("   hfe_unit,") \
					_T("   hpol_unitprice as hfe_unitprice,") \
					_T("   hfe_category,") \
					_T("   SUM(hfe_quantity) AS qty,") \
					_T("   CASE") \
					_T("     WHEN hfe_category='Y'") \
					_T("     THEN SUM(hfe_cost)") \
					_T("     ELSE 0") \
					_T("   END AS optcost,") \
					_T("   CASE") \
					_T("     WHEN hfe_category='N'") \
					_T("     THEN SUM(hfe_inspaid)") \
					_T("     ELSE 0") \
					_T("   END                              AS inscost,") \
					_T("   SUM(hfe_diffcost)                AS diffcost,") \
					_T("   SUM(hfe_quantity*hpol_unitprice) AS cost") \
					_T(" FROM tbl") \
					_T(" LEFT JOIN hms_surgery_drugtype") \
					_T(" ON(hsd_id =hfe_group)") \
					_T(" LEFT JOIN HMS_PHARMAORDER_VIEW_PM") \
					_T(" ON(hfe_docno    = hpo_docno") \
					_T(" AND hfe_orderid = hpo_orderid)") \
					_T(" LEFT JOIN HMS_PHARMAORDERLINE_VIEW_PM") \
					_T(" ON(hpol_orderid      = hpo_orderid") \
					_T(" AND hpol_orderlineid = hfe_orderline)") \
					_T(" WHERE hfe_docno      =%ld") \
					_T(" AND hpo_reference_id =%ld") \
					_T(" AND hfe_type        IN('D','P','M')") \
					_T(" GROUP BY hsd_feeidx,") \
					_T("   hsd_name,") \
					_T("   hfe_desc,") \
					_T("   hfe_unit,") \
					_T("   hfe_category,") \
					_T("   hpol_unitprice") \
					_T(" ORDER BY hsd_feeidx,") \
					_T("   hfe_desc"), nDocumentNo, nSOrderID);

					}
		int nNewFeeIdx=0, nOldFeeIdx=0;
		rsl.ExecSQL(szSQL);
		_tprintf(_T("hello 3: %s"), szSQL);
		if(rsl.IsEOF())
			return;
		while(!rsl.IsEOF())
		{

			rsl.GetValue(_T("grpidx"), nNewFeeIdx);
			if(nNewFeeIdx != nOldFeeIdx)
			{
				if(grp2cost > 0)
				{
					rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
					tmpStr.Format(_T("\x43\x1ED9ng(%d):"), nIdx);
					rptDetail->SetValue(_T("TotalAmountLabel"), tmpStr);
					FormatCurrency(grp2optcost, tmpStr);
					rptDetail->SetValue(_T("6"), tmpStr);					
					FormatCurrency(grp2inscost, tmpStr);
					rptDetail->SetValue(_T("7"), tmpStr);					
					FormatCurrency(grp2patpaid, tmpStr);
					rptDetail->SetValue(_T("8"), tmpStr);
					FormatCurrency(grp2cost, tmpStr);
					rptDetail->SetValue(_T("9"), tmpStr);
					grp2cost = grp2inscost=grp2optcost=grp2patpaid = 0;
				}
	
				rptDetail = rpt.AddDetail(rpt.GetGroupHeader(2));
				tmpStr.Format(_T("%d"), ++nIdx);
				rptDetail->SetValue(_T("TypeID"), tmpStr);
				if(nNewFeeIdx == 1)
					tmpStr.Format(_T("Thu\x1ED1\x63, h\xF3\x61 \x63h\x1EA5t, m\xE1u, \x64\x1ECB\x63h truy\x1EC1n"));
				else if(nNewFeeIdx == 2)
					tmpStr.Format(_T("V\x1EADt t\x1B0 y t\x1EBF ti\xEAu h\x61o"));
				else
				{
					rsl.GetValue(_T("grpname"), tmpStr);
				}
				rptDetail->SetValue(_T("TypeName"), tmpStr);			
				
				nIdxl = 1;
				nOldFeeIdx = nNewFeeIdx;
			}
			rptDetail = rpt.AddDetail();

			tmpStrIdx.Format(_T("%d)   "), nIdxl++);
			rsl.GetValue(_T("hfe_desc"), tmpStr);
			rptDetail->SetValue(_T("1"), _T(""));
			rptDetail->SetValue(_T("2"), tmpStrIdx + tmpStr);

			rsl.GetValue(_T("hfe_unit"), tmpStr);
			rptDetail->SetValue(_T("3"), tmpStr);

			rsl.GetValue(_T("qty"), tmpStr);
			rptDetail->SetValue(_T("4"), tmpStr);

			rsl.GetValue(_T("hfe_unitprice"), unitprice);
			FormatCurrency(unitprice, tmpStr);
			rptDetail->SetValue(_T("5"), tmpStr);

			rsl.GetValue(_T("optcost"), optcost);
			grp2optcost += optcost;
			grpoptcost += optcost;
			ttloptcost += optcost;
			FormatCurrency(optcost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);

			rsl.GetValue(_T("inscost"), inscost);
			grp2inscost += inscost;
			grpinscost += inscost;
			ttlinscost += inscost;
			FormatCurrency(inscost, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);

			rsl.GetValue(_T("patpaid"), patpaid);
			grp2patpaid += patpaid;
			grppatpaid += patpaid;
			ttlpatpaid += patpaid;
			FormatCurrency(patpaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);


			rsl.GetValue(_T("cost"),cost);			
			grp2cost += cost;
			grpcost += cost;
			ttlcost += cost;
			FormatCurrency(cost, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);

			rsl.MoveNext();
		}


		if(grp2cost > 0)
		{
			rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
			tmpStr.Format(_T("\x43\x1ED9ng(%d):"), nIdx);
			rptDetail->SetValue(_T("TotalAmountLabel"), tmpStr);
			FormatCurrency(grp2optcost, tmpStr);
			rptDetail->SetValue(_T("6"), tmpStr);					
			FormatCurrency(grp2inscost, tmpStr);
			rptDetail->SetValue(_T("7"), tmpStr);					
			FormatCurrency(grp2patpaid, tmpStr);
			rptDetail->SetValue(_T("8"), tmpStr);
			FormatCurrency(grp2cost, tmpStr);
			rptDetail->SetValue(_T("9"), tmpStr);
			grp2cost = grp2inscost=grp2optcost=grp2patpaid = 0;
		}

		rptDetail = rpt.AddDetail(rpt.GetGroupHeader(3));
		for (int i =0; i < nIdx; i++){
			if(!szTotalComment.IsEmpty())
				szTotalComment.AppendFormat(_T("+"));
			szTotalComment.AppendFormat(_T("%d"), i+1);
		}
		tmpStr.Format(_T("T\x1ED5ng (%s)=(%s):"),lpszChapter[nChapter],szTotalComment);
		szTotalComment.Empty();
		rptDetail->SetValue(_T("TotalAmountLabel"), tmpStr);
		
		FormatCurrency(grpoptcost, tmpStr);
		rptDetail->SetValue(_T("6"), tmpStr);					
		FormatCurrency(grpinscost, tmpStr);
		rptDetail->SetValue(_T("7"), tmpStr);					
		FormatCurrency(grppatpaid, tmpStr);
		rptDetail->SetValue(_T("8"), tmpStr);
		FormatCurrency(grpcost, tmpStr);
		rptDetail->SetValue(_T("9"), tmpStr);
		grpoptcost = grpinscost = grppatpaid = grpcost = 0;
		nIdxl = 1;
		nChapter++;
		rs.MoveNext();
	}
	
	
	CString szSumInWord;
	szSumInWord.Format(_T("\x110\x1ED3ng"));
	FormatCurrency(ttlcost, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("TotalAmount"), tmpStr);
	FormatCurrency(ttlinscost, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("InsurancePaid"), tmpStr );
	FormatCurrency(ttlpatpaid, tmpStr);
	rpt.GetReportFooter()->SetValue(_T("PatientPaid"), tmpStr);

	//Page Footer
	//Report Footer
	CDate sysDate;
	sysDate.ParseDate(pMF->GetSysDate());
	rpt.GetReportFooter()->Format(_T("PrintDate"), sysDate.GetDay(), sysDate.GetMonth(), sysDate.GetYear());
	//rpt.GetReportFooter()->SetValue(_T("DoctorName"), tmpStr);
	rpt.PrintPreview();		
}
